const { useState, useEffect, useCallback, createContext, useContext } = React;

// ==================== AUTH CONTEXT ====================
const AuthContext = createContext(null);

const useAuth = () => {
    const context = useContext(AuthContext);
    if (!context) {
        throw new Error('useAuth must be used within an AuthProvider');
    }
    return context;
};

// ==================== LOGIN PAGE COMPONENT ====================
function LoginPage({ onLoginSuccess }) {
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState('');

    const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        
        if (!email.trim() || !password.trim()) {
            setError('Please enter email and password');
            return;
        }

        setLoading(true);
        
        try {
            const services = window.FirebaseServices;
            if (!services?.authService) {
                setError('System initializing... please wait and try again');
                setLoading(false);
                return;
            }

            const result = await services.authService.signIn(email, password);
            
            if (result.success) {
                const userResult = await services.userService.getUserProfile(result.user.uid);
                
                if (userResult.success && userResult.data) {
                    if (!userResult.data.isActive) {
                        setError('Account deactivated. Contact administrator.');
                        await services.auditService?.logLogin(result.user, false, 'Account deactivated');
                        await services.authService.signOut();
                        setLoading(false);
                        return;
                    }
                    // Log successful login
                    await services.auditService?.logLogin(result.user, true);
                    onLoginSuccess(result.user, userResult.data);
                } else {
                    const initResult = await services.userService.initializeAdminUser(result.user.uid, result.user.email);
                    if (initResult.isFirstUser) {
                        const newUserResult = await services.userService.getUserProfile(result.user.uid);
                        await services.auditService?.logLogin(result.user, true);
                        onLoginSuccess(result.user, newUserResult.data);
                    } else {
                        await services.userService.createUserProfile(result.user.uid, {
                            email: result.user.email,
                            displayName: result.user.email.split('@')[0],
                            role: 'receptionist'
                        });
                        const newUserResult = await services.userService.getUserProfile(result.user.uid);
                        await services.auditService?.logLogin(result.user, true);
                        onLoginSuccess(result.user, newUserResult.data);
                    }
                }
            } else {
                let msg = result.error || 'Login failed';
                // Log failed login attempt
                await services.auditService?.logLogin({ email }, false, msg);
                if (msg.includes('user-not-found')) msg = 'No account found';
                else if (msg.includes('wrong-password') || msg.includes('invalid-credential')) msg = 'Invalid credentials';
                else if (msg.includes('invalid-email')) msg = 'Invalid email format';
                else if (msg.includes('too-many-requests')) msg = 'Too many attempts. Try later.';
                setError(msg);
            }
        } catch (err) {
            setError(err.message || 'Login failed');
        } finally {
            setLoading(false);
        }
    };

    return (
        <div style={{ minHeight: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center', background: '#1e3a5f' }}>
            <div style={{ background: 'white', padding: '40px', width: '100%', maxWidth: '400px', margin: '20px' }}>
                <div style={{ textAlign: 'center', marginBottom: '30px' }}>
                    <div style={{ fontSize: '32px', marginBottom: '8px' }}>üöó</div>
                    <h1 style={{ fontSize: '24px', fontWeight: '700', color: '#1e293b', margin: 0 }}>EcoSpark</h1>
                    <p style={{ fontSize: '13px', color: '#64748b', margin: '4px 0 0' }}>Car Wash Management</p>
                </div>

                {error && (
                    <div style={{ background: '#fef2f2', border: '1px solid #fecaca', color: '#dc2626', padding: '12px', marginBottom: '20px', fontSize: '13px', textAlign: 'center' }}>
                        {error}
                    </div>
                )}

                <form onSubmit={handleSubmit}>
                    <div style={{ marginBottom: '16px' }}>
                        <label style={{ display: 'block', fontSize: '13px', fontWeight: '500', color: '#374151', marginBottom: '6px' }}>Email</label>
                        <input
                            type="email"
                            value={email}
                            onChange={(e) => setEmail(e.target.value)}
                            placeholder="you@example.com"
                            style={{ width: '100%', padding: '12px', border: '1px solid #e2e8f0', fontSize: '14px', outline: 'none', boxSizing: 'border-box' }}
                        />
                    </div>

                    <div style={{ marginBottom: '24px' }}>
                        <label style={{ display: 'block', fontSize: '13px', fontWeight: '500', color: '#374151', marginBottom: '6px' }}>Password</label>
                        <input
                            type="password"
                            value={password}
                            onChange={(e) => setPassword(e.target.value)}
                            placeholder="Enter password"
                            style={{ width: '100%', padding: '12px', border: '1px solid #e2e8f0', fontSize: '14px', outline: 'none', boxSizing: 'border-box' }}
                        />
                    </div>

                    <button
                        type="submit"
                        disabled={loading}
                        style={{ width: '100%', padding: '12px', background: loading ? '#93c5fd' : '#3b82f6', color: 'white', border: 'none', fontSize: '14px', fontWeight: '600', cursor: loading ? 'wait' : 'pointer' }}
                    >
                        {loading ? 'Signing in...' : 'Sign In'}
                    </button>
                </form>

                <p style={{ marginTop: '20px', fontSize: '12px', color: '#94a3b8', textAlign: 'center' }}>
                    Need help? Contact your administrator
                </p>
            </div>
        </div>
    );
}

// ==================== PERMISSION HELPER ====================
const PermissionContext = createContext(null);

const usePermissions = () => {
    const context = useContext(PermissionContext);
    if (!context) {
        return {
            hasModuleAccess: () => true,
            hasPermission: () => true,
            userRole: 'admin'
        };
    }
    return context;
};

// Icon Components
const Icons = {
    dashboard: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>,
    car: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 16H9m10 0h3l-3.5-7a2 2 0 0 0-1.9-1.3H7.4a2 2 0 0 0-1.9 1.3L2 16h3m0 0a2 2 0 1 0 4 0m4 0a2 2 0 1 0 4 0"/></svg>,
    package: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/></svg>,
    plus: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
    play: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>,
    pause: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>,
    x: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
    refresh: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"/><path d="M3 22v-6h6"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"/></svg>,
    star: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>,
    clock: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
    check: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>,
    arrowRight: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>,
    edit: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>,
    eye: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>,
    fileText: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>,
    scan: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/><line x1="7" y1="12" x2="17" y2="12"/></svg>,
    building: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="4" y="2" width="16" height="20" rx="2"/><path d="M9 22v-4h6v4"/><path d="M8 6h.01"/><path d="M16 6h.01"/><path d="M12 6h.01"/><path d="M12 10h.01"/><path d="M12 14h.01"/><path d="M16 10h.01"/><path d="M16 14h.01"/><path d="M8 10h.01"/><path d="M8 14h.01"/></svg>,
    droplet: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/></svg>,
    tool: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>,
    users: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
    truck: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 18V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v11a1 1 0 0 0 1 1h2"/><path d="M15 18H9"/><path d="M19 18h2a1 1 0 0 0 1-1v-3.65a1 1 0 0 0-.22-.624l-3.48-4.35A1 1 0 0 0 17.52 8H14"/><circle cx="17" cy="18" r="2"/><circle cx="7" cy="18" r="2"/></svg>,
    briefcase: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>,
    calendar: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>,
    creditCard: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>,
    clipboard: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1"/></svg>,
    trendingUp: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>,
    megaphone: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m3 11 18-5v12L3 13v-2z"/><path d="M11.6 16.8a3 3 0 1 1-5.8-1.6"/></svg>,
    settings: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6M4.2 4.2l4.2 4.2m5.6 5.6l4.2 4.2M1 12h6m6 0h6M4.2 19.8l4.2-4.2m5.6-5.6l4.2-4.2"/></svg>,
    printer: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
};

// Menu items configuration with categories
const menuGroups = [
    {
        label: 'Main',
        items: [
            { id: 'dashboard', label: 'Dashboard', icon: Icons.dashboard }
        ]
    },
    {
        label: 'Vehicle Management',
        items: [
            { id: 'vehicle-intake', label: 'Vehicle Intake', icon: Icons.car },
            { id: 'service-packages', label: 'Service Packages', icon: Icons.package }
        ]
    },
    {
        label: 'Operations',
        items: [
            { id: 'garage-management', label: 'Garage Management', icon: Icons.building },
            { id: 'wash-bays', label: 'Wash Bays', icon: Icons.droplet },
            { id: 'equipment', label: 'Equipment Management', icon: Icons.tool }
        ]
    },
    {
        label: 'Customer Relations',
        items: [
            { id: 'customers', label: 'Customer Management', icon: Icons.users },
            { id: 'fleet', label: 'Fleet Accounts', icon: Icons.truck }
        ]
    },
    {
        label: 'Staff',
        items: [
            { id: 'staff', label: 'Staff Management', icon: Icons.briefcase }
        ]
    },
    {
        label: 'Human Resources',
        items: [
            { id: 'hr', label: 'HR Statistics', icon: Icons.users }
        ]
    },
    {
        label: 'Financial',
        items: [
            { id: 'billing', label: 'Billing Payments', icon: Icons.creditCard },
            { id: 'expenses', label: 'Expenses', icon: Icons.trendingUp },
            { id: 'inventory', label: 'Inventory Management', icon: Icons.clipboard }
        ]
    },
    {
        label: 'Analytics & Marketing',
        items: [
            { id: 'reports', label: 'Reports Analytics', icon: Icons.trendingUp },
            { id: 'marketing', label: 'Marketing CRM', icon: Icons.megaphone }
        ]
    }
];

const settingsItem = { id: 'settings', label: 'System Settings', icon: Icons.settings };
const activitiesItem = { id: 'activities', label: 'Activities', icon: Icons.clipboard };

// Flatten menu items for easy lookup
const menuItems = [
    ...menuGroups.flatMap(group => group.items),
    settingsItem,
    activitiesItem
];

// Sidebar Component
function Sidebar({ isCollapsed, activeModule, onModuleClick, userProfile, hasModuleAccess }) {
    // Filter menu groups based on user permissions
    const filteredMenuGroups = menuGroups.map(group => ({
        ...group,
        items: group.items.filter(item => hasModuleAccess ? hasModuleAccess(item.id) : true)
    })).filter(group => group.items.length > 0);

    const canAccessSettings = hasModuleAccess ? hasModuleAccess('settings') : true;

    return (
        <div className={`sidebar ${isCollapsed ? 'collapsed' : ''}`}>
            <div className="sidebar-logo">
                <div className="sidebar-logo-icon">üöó</div>
                <div className="sidebar-logo-text">Ecospark</div>
            </div>
            <div className="sidebar-menu">
                {filteredMenuGroups.map((group, groupIndex) => (
                    <div key={groupIndex} className="sidebar-menu-group">
                        {!isCollapsed && <div className="sidebar-menu-header">{group.label}</div>}
                        {group.items.map((item) => (
                            <div
                                key={item.id}
                                className={`sidebar-menu-item ${activeModule === item.id ? 'active' : ''}`}
                                onClick={() => onModuleClick(item.id)}
                            >
                                <span className="sidebar-menu-item-icon">{item.icon}</span>
                                <span>{item.label}</span>
                            </div>
                        ))}
                    </div>
                ))}
                
                <div className="sidebar-spacer"></div>
                
                {canAccessSettings && (
                    <div className="sidebar-menu-group sidebar-menu-group-settings">
                        <div className="sidebar-separator"></div>
                        <div
                            className={`sidebar-menu-item ${activeModule === settingsItem.id ? 'active' : ''}`}
                            onClick={() => onModuleClick(settingsItem.id)}
                        >
                            <span className="sidebar-menu-item-icon">{settingsItem.icon}</span>
                            <span>{settingsItem.label}</span>
                        </div>
                    </div>
                )}
            </div>
            
            {/* User info at bottom of sidebar */}
            {userProfile && !isCollapsed && (
                <div style={{
                    padding: '12px 16px',
                    borderTop: '1px solid rgba(255,255,255,0.1)',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '10px'
                }}>
                    <div style={{
                        width: '32px',
                        height: '32px',
                        borderRadius: '50%',
                        backgroundColor: '#3b82f6',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        color: 'white',
                        fontSize: '13px',
                        fontWeight: '600'
                    }}>
                        {(userProfile.displayName || userProfile.email || 'U').charAt(0).toUpperCase()}
                    </div>
                    <div style={{ flex: 1, minWidth: 0 }}>
                        <div style={{ 
                            fontSize: '13px', 
                            fontWeight: '500', 
                            color: 'white',
                            overflow: 'hidden',
                            textOverflow: 'ellipsis',
                            whiteSpace: 'nowrap'
                        }}>
                            {userProfile.displayName || userProfile.email?.split('@')[0] || 'User'}
                        </div>
                        <div style={{ 
                            fontSize: '11px', 
                            color: 'rgba(255,255,255,0.6)',
                            textTransform: 'capitalize'
                        }}>
                            {userProfile.role || 'User'}
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}

// Notification Dropdown Component - Real-time Global Notifications
function NotificationDropdown({ isOpen, onClose, onModuleClick }) {
    const [notifications, setNotifications] = useState([]);
    const [loading, setLoading] = useState(true);
    const [readNotifications, setReadNotifications] = useState(() => {
        // Load read notifications from localStorage
        try {
            const saved = localStorage.getItem('ecospark_read_notifications');
            return saved ? JSON.parse(saved) : [];
        } catch { return []; }
    });

    // Save read notifications to localStorage
    const saveReadNotifications = (ids) => {
        try {
            localStorage.setItem('ecospark_read_notifications', JSON.stringify(ids));
        } catch (e) { console.log('Error saving read notifications:', e); }
    };

    useEffect(() => {
        if (!isOpen) return;
        
        let cancelled = false;
        const allNotifications = [];

        const loadNotifications = async () => {
            setLoading(true);
            const svc = window.FirebaseServices;
            if (!svc) {
                setLoading(false);
                return;
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayStr = today.toISOString().split('T')[0];

            // Get activities (recent ones)
            if (svc.activityService?.getRecentActivities) {
                try {
                    const activities = await svc.activityService.getRecentActivities(10);
                    activities.forEach(a => {
                        allNotifications.push({
                            id: `activity-${a.id}`,
                            type: 'activity',
                            icon: a.type === 'intake' ? 'üöó' : a.type === 'billing' ? 'üí≥' : a.type === 'wash' ? 'üöø' : a.type === 'garage' ? 'üîß' : 'üìã',
                            title: a.description,
                            subtitle: a.user || 'System',
                            timestamp: a.timestamp,
                            module: a.type === 'intake' ? 'vehicle-intake' : a.type === 'billing' ? 'billing' : a.type === 'wash' ? 'wash-bays' : a.type === 'garage' ? 'garage' : 'activities',
                            color: '#3b82f6'
                        });
                    });
                } catch (e) { console.log('Activities fetch error:', e); }
            }

            // Get low stock items
            if (svc.inventoryService?.getItems) {
                try {
                    const items = await svc.inventoryService.getItems();
                    items.filter(i => (i.quantity || 0) <= (i.minStock || i.reorderLevel || 5)).forEach(i => {
                        allNotifications.push({
                            id: `lowstock-${i.id}`,
                            type: 'alert',
                            icon: '‚ö†Ô∏è',
                            title: `Low Stock: ${i.name}`,
                            subtitle: `Only ${i.quantity || 0} ${i.unit || 'units'} remaining`,
                            timestamp: new Date().toISOString(),
                            module: 'inventory',
                            color: '#ef4444',
                            priority: 'high'
                        });
                    });
                } catch (e) { console.log('Inventory fetch error:', e); }
            }

            // Get pending invoices
            if (svc.billingService?.getInvoices) {
                try {
                    const invoices = await svc.billingService.getInvoices();
                    const pendingInvoices = invoices.filter(i => i.paymentStatus === 'pending' || i.paymentStatus === 'partial');
                    if (pendingInvoices.length > 0) {
                        const totalPending = pendingInvoices.reduce((sum, i) => sum + (i.totalAmount || i.total || 0), 0);
                        allNotifications.push({
                            id: 'pending-invoices',
                            type: 'payment',
                            icon: 'üí∞',
                            title: `${pendingInvoices.length} Pending Payments`,
                            subtitle: `Total: KSh ${totalPending.toLocaleString()}`,
                            timestamp: new Date().toISOString(),
                            module: 'billing',
                            color: '#f59e0b'
                        });
                    }
                } catch (e) { console.log('Billing fetch error:', e); }
            }

            // Get equipment in maintenance
            if (svc.equipmentService?.getEquipment) {
                try {
                    const equipment = await svc.equipmentService.getEquipment();
                    const maintenanceEquip = equipment.filter(e => e.status === 'maintenance' || e.status === 'repair');
                    maintenanceEquip.forEach(eq => {
                        allNotifications.push({
                            id: `equip-${eq.id}`,
                            type: 'maintenance',
                            icon: 'üîß',
                            title: `${eq.name} under maintenance`,
                            subtitle: eq.notes || 'Requires attention',
                            timestamp: eq.lastMaintenance || new Date().toISOString(),
                            module: 'equipment',
                            color: '#8b5cf6'
                        });
                    });
                } catch (e) { console.log('Equipment fetch error:', e); }
            }

            // Get vehicles in queue (waiting)
            if (svc.intakeQueueService?.getQueue) {
                try {
                    const queue = await svc.intakeQueueService.getQueue();
                    if (queue.length > 0) {
                        allNotifications.push({
                            id: 'queue-alert',
                            type: 'queue',
                            icon: 'üöó',
                            title: `${queue.length} vehicles in queue`,
                            subtitle: 'Waiting for service',
                            timestamp: new Date().toISOString(),
                            module: 'vehicle-intake',
                            color: '#10b981'
                        });
                    }
                } catch (e) { console.log('Queue fetch error:', e); }
            }

            // Sort by timestamp (newest first)
            allNotifications.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            if (!cancelled) {
                setNotifications(allNotifications);
                setLoading(false);
            }
        };

        loadNotifications();
        return () => { cancelled = true; };
    }, [isOpen]);

    const formatTime = (timestamp) => {
        if (!timestamp) return '';
        const date = new Date(timestamp);
        const now = new Date();
        const diff = now - date;
        const mins = Math.floor(diff / 60000);
        const hours = Math.floor(diff / 3600000);
        const days = Math.floor(diff / 86400000);
        
        if (mins < 1) return 'Just now';
        if (mins < 60) return `${mins}m ago`;
        if (hours < 24) return `${hours}h ago`;
        if (days === 1) return 'Yesterday';
        return date.toLocaleDateString();
    };

    const handleNotificationClick = (notification) => {
        // Mark as read
        if (!readNotifications.includes(notification.id)) {
            const newRead = [...readNotifications, notification.id];
            setReadNotifications(newRead);
            saveReadNotifications(newRead);
        }
        if (onModuleClick && notification.module) {
            onModuleClick(notification.module);
        }
        onClose();
    };

    const markAsRead = (notifId, e) => {
        e.stopPropagation();
        if (!readNotifications.includes(notifId)) {
            const newRead = [...readNotifications, notifId];
            setReadNotifications(newRead);
            saveReadNotifications(newRead);
        }
    };

    const markAllAsRead = () => {
        const allIds = notifications.map(n => n.id);
        setReadNotifications(allIds);
        saveReadNotifications(allIds);
    };

    const clearNotification = (notifId, e) => {
        e.stopPropagation();
        setNotifications(prev => prev.filter(n => n.id !== notifId));
        // Also mark as read
        if (!readNotifications.includes(notifId)) {
            const newRead = [...readNotifications, notifId];
            setReadNotifications(newRead);
            saveReadNotifications(newRead);
        }
    };

    const clearAllNotifications = () => {
        const allIds = notifications.map(n => n.id);
        setReadNotifications(allIds);
        saveReadNotifications(allIds);
        setNotifications([]);
    };

    const unreadCount = notifications.filter(n => !readNotifications.includes(n.id)).length;

    if (!isOpen) return null;

    return (
        <>
            <div className="dropdown-overlay" onClick={onClose}></div>
            <div className="dropdown notification-dropdown" style={{ 
                width: '380px', 
                maxHeight: '500px',
                borderRadius: '0'
            }}>
                <div className="dropdown-header" style={{ 
                    padding: '14px 20px', 
                    borderBottom: '1px solid var(--border-color)',
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center'
                }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                        <h3 style={{ margin: 0, fontSize: '16px', fontWeight: '600' }}>Notifications</h3>
                        {unreadCount > 0 && (
                            <span style={{ 
                                fontSize: '11px', 
                                padding: '2px 8px', 
                                background: '#ef4444',
                                color: 'white',
                                borderRadius: '10px',
                                fontWeight: '600'
                            }}>
                                {unreadCount} new
                            </span>
                        )}
                    </div>
                    <div style={{ display: 'flex', gap: '8px' }}>
                        {unreadCount > 0 && (
                            <button 
                                onClick={markAllAsRead}
                                style={{
                                    background: 'none',
                                    border: 'none',
                                    color: 'var(--accent-color)',
                                    fontSize: '12px',
                                    cursor: 'pointer',
                                    padding: '4px 8px',
                                    fontWeight: '500'
                                }}
                                title="Mark all as read"
                            >
                                ‚úì Mark all read
                            </button>
                        )}
                        {notifications.length > 0 && (
                            <button 
                                onClick={clearAllNotifications}
                                style={{
                                    background: 'none',
                                    border: 'none',
                                    color: '#ef4444',
                                    fontSize: '12px',
                                    cursor: 'pointer',
                                    padding: '4px 8px',
                                    fontWeight: '500'
                                }}
                                title="Clear all notifications"
                            >
                                ‚úï Clear all
                            </button>
                        )}
                    </div>
                </div>
                <div className="dropdown-content" style={{ 
                    maxHeight: '400px', 
                    overflowY: 'auto',
                    padding: 0
                }}>
                    {loading ? (
                        <div style={{ padding: '40px', textAlign: 'center', color: 'var(--text-secondary)' }}>
                            <div style={{ fontSize: '24px', marginBottom: '8px', animation: 'spin 1s linear infinite' }}>‚è≥</div>
                            <div>Loading notifications...</div>
                        </div>
                    ) : notifications.length === 0 ? (
                        <div className="empty-state" style={{ padding: '40px', textAlign: 'center' }}>
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" style={{ color: 'var(--text-secondary)', marginBottom: '12px' }}>
                                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                                <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                            </svg>
                            <p style={{ color: 'var(--text-secondary)', margin: 0 }}>No notifications</p>
                        </div>
                    ) : (
                        notifications.map((notif, idx) => {
                            const isRead = readNotifications.includes(notif.id);
                            return (
                            <div 
                                key={notif.id} 
                                onClick={() => handleNotificationClick(notif)}
                                style={{ 
                                    padding: '14px 20px',
                                    display: 'flex',
                                    gap: '14px',
                                    cursor: 'pointer',
                                    borderBottom: idx < notifications.length - 1 ? '1px solid var(--border-color)' : 'none',
                                    transition: 'background 0.15s',
                                    background: notif.priority === 'high' ? 'rgba(239, 68, 68, 0.05)' : isRead ? 'transparent' : 'rgba(59, 130, 246, 0.03)',
                                    opacity: isRead ? 0.7 : 1
                                }}
                                className="notification-item"
                            >
                                {/* Unread indicator */}
                                {!isRead && (
                                    <div style={{
                                        position: 'absolute',
                                        left: '8px',
                                        width: '6px',
                                        height: '6px',
                                        borderRadius: '50%',
                                        background: '#3b82f6',
                                        alignSelf: 'center'
                                    }}></div>
                                )}
                                <div style={{
                                    width: '40px',
                                    height: '40px',
                                    borderRadius: '0',
                                    background: `${notif.color}15`,
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    fontSize: '18px',
                                    flexShrink: 0
                                }}>
                                    {notif.icon}
                                </div>
                                <div style={{ flex: 1, minWidth: 0 }}>
                                    <div style={{ 
                                        fontSize: '14px', 
                                        fontWeight: isRead ? '400' : '600', 
                                        color: 'var(--text-primary)',
                                        marginBottom: '4px',
                                        overflow: 'hidden',
                                        textOverflow: 'ellipsis',
                                        whiteSpace: 'nowrap'
                                    }}>
                                        {notif.title}
                                    </div>
                                    <div style={{ 
                                        fontSize: '12px', 
                                        color: 'var(--text-secondary)',
                                        display: 'flex',
                                        justifyContent: 'space-between',
                                        alignItems: 'center'
                                    }}>
                                        <span style={{ overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>{notif.subtitle}</span>
                                        <span style={{ flexShrink: 0, marginLeft: '8px', fontSize: '11px' }}>{formatTime(notif.timestamp)}</span>
                                    </div>
                                </div>
                                <div style={{ display: 'flex', gap: '4px', alignItems: 'center', flexShrink: 0 }}>
                                    {!isRead && (
                                        <button
                                            onClick={(e) => markAsRead(notif.id, e)}
                                            style={{
                                                background: 'none',
                                                border: 'none',
                                                color: 'var(--text-secondary)',
                                                cursor: 'pointer',
                                                padding: '4px',
                                                fontSize: '14px',
                                                opacity: 0.6,
                                                transition: 'opacity 0.15s'
                                            }}
                                            title="Mark as read"
                                            onMouseEnter={(e) => e.target.style.opacity = 1}
                                            onMouseLeave={(e) => e.target.style.opacity = 0.6}
                                        >
                                            ‚úì
                                        </button>
                                    )}
                                    <button
                                        onClick={(e) => clearNotification(notif.id, e)}
                                        style={{
                                            background: 'none',
                                            border: 'none',
                                            color: 'var(--text-secondary)',
                                            cursor: 'pointer',
                                            padding: '4px',
                                            fontSize: '12px',
                                            opacity: 0.6,
                                            transition: 'opacity 0.15s'
                                        }}
                                        title="Clear notification"
                                        onMouseEnter={(e) => e.target.style.opacity = 1}
                                        onMouseLeave={(e) => e.target.style.opacity = 0.6}
                                    >
                                        ‚úï
                                    </button>
                                    {notif.priority === 'high' && (
                                        <div style={{
                                            width: '8px',
                                            height: '8px',
                                            borderRadius: '50%',
                                            background: '#ef4444'
                                        }}></div>
                                    )}
                                </div>
                            </div>
                        )})
                    )}
                </div>
                {notifications.length > 0 && (
                    <div style={{ 
                        padding: '12px 20px', 
                        borderTop: '1px solid var(--border-color)',
                        textAlign: 'center'
                    }}>
                        <button 
                            onClick={() => { onModuleClick && onModuleClick('activities'); onClose(); }}
                            style={{
                                background: 'none',
                                border: 'none',
                                color: 'var(--accent-color)',
                                fontSize: '13px',
                                fontWeight: '600',
                                cursor: 'pointer'
                            }}
                        >
                            View All Activities ‚Üí
                        </button>
                    </div>
                )}
            </div>
        </>
    );
}

// Profile Dropdown Component
function ProfileDropdown({ isOpen, onClose }) {
    if (!isOpen) return null;

    return (
        <>
            <div className="dropdown-overlay" onClick={onClose}></div>
            <div className="dropdown profile-dropdown">
                <div className="dropdown-content">
                    <a href="#" className="dropdown-menu-item">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                            <circle cx="12" cy="7" r="4"/>
                        </svg>
                        <span>My Profile</span>
                    </a>
                    <a href="#" className="dropdown-menu-item">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                            <circle cx="12" cy="12" r="3"/>
                            <path d="M12 1v6m0 6v6M4.2 4.2l4.2 4.2m5.6 5.6l4.2 4.2M1 12h6m6 0h6M4.2 19.8l4.2-4.2m5.6-5.6l4.2-4.2"/>
                        </svg>
                        <span>Settings</span>
                    </a>
                    <a href="#" className="dropdown-menu-item">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M12 16v-4"/>
                            <path d="M12 8h.01"/>
                        </svg>
                        <span>Help & Support</span>
                    </a>
                    <div className="dropdown-divider"></div>
                    <a href="#" className="dropdown-menu-item logout">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                            <polyline points="16 17 21 12 16 7"/>
                            <line x1="21" y1="12" x2="9" y2="12"/>
                        </svg>
                        <span>Logout</span>
                    </a>
                </div>
            </div>
        </>
    );
}

// Top Bar Component
function TopBar({ onToggleSidebar, onToggleTheme, isDarkMode, userProfile, onLogout, onModuleClick }) {
    const [notificationOpen, setNotificationOpen] = useState(false);
    const [profileOpen, setProfileOpen] = useState(false);
    const [notificationCount, setNotificationCount] = useState(0);

    // Get notification count on mount
    useEffect(() => {
        const loadNotificationCount = async () => {
            const svc = window.FirebaseServices;
            if (!svc) return;
            
            let count = 0;
            
            // Count low stock items
            if (svc.inventoryService?.getItems) {
                try {
                    const items = await svc.inventoryService.getItems();
                    count += items.filter(i => (i.quantity || 0) <= (i.minStock || i.reorderLevel || 5)).length;
                } catch (e) {}
            }
            
            // Count pending invoices
            if (svc.billingService?.getInvoices) {
                try {
                    const invoices = await svc.billingService.getInvoices();
                    const pending = invoices.filter(i => i.paymentStatus === 'pending' || i.paymentStatus === 'partial').length;
                    if (pending > 0) count += 1;
                } catch (e) {}
            }
            
            // Count equipment in maintenance
            if (svc.equipmentService?.getEquipment) {
                try {
                    const equipment = await svc.equipmentService.getEquipment();
                    count += equipment.filter(e => e.status === 'maintenance' || e.status === 'repair').length;
                } catch (e) {}
            }
            
            // Count vehicles in queue
            if (svc.intakeQueueService?.getQueue) {
                try {
                    const queue = await svc.intakeQueueService.getQueue();
                    if (queue.length > 0) count += 1;
                } catch (e) {}
            }

            setNotificationCount(count);
        };

        loadNotificationCount();
        // Refresh count every 30 seconds
        const interval = setInterval(loadNotificationCount, 30000);
        return () => clearInterval(interval);
    }, []);

    const handleNotificationClick = () => {
        setNotificationOpen(!notificationOpen);
        setProfileOpen(false);
    };

    const handleProfileClick = () => {
        setProfileOpen(!profileOpen);
        setNotificationOpen(false);
    };

    const handleLogoutClick = () => {
        setProfileOpen(false);
        if (onLogout) onLogout();
    };

    const handleSettingsClick = (tab) => {
        setProfileOpen(false);
        if (onModuleClick) {
            onModuleClick('settings', tab);
        }
    };

    return (
        <div className="topbar">
            <div className="topbar-left">
                <button className="topbar-button" onClick={onToggleSidebar} title="Toggle Sidebar">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                        <line x1="3" y1="6" x2="21" y2="6"/>
                        <line x1="3" y1="12" x2="21" y2="12"/>
                        <line x1="3" y1="18" x2="21" y2="18"/>
                    </svg>
                </button>
            </div>
            <div className="topbar-right">
                <div className="dropdown-container">
                    <button className="topbar-button" onClick={handleNotificationClick} title="Notifications" style={{ position: 'relative' }}>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                            <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                        </svg>
                        {notificationCount > 0 && (
                            <span style={{
                                position: 'absolute',
                                top: '2px',
                                right: '2px',
                                background: '#ef4444',
                                color: 'white',
                                fontSize: '10px',
                                fontWeight: '700',
                                minWidth: '16px',
                                height: '16px',
                                borderRadius: '8px',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                padding: '0 4px'
                            }}>
                                {notificationCount > 9 ? '9+' : notificationCount}
                            </span>
                        )}
                    </button>
                    <NotificationDropdown 
                        isOpen={notificationOpen} 
                        onClose={() => setNotificationOpen(false)} 
                        onModuleClick={onModuleClick}
                    />
                </div>
                <button className="topbar-button" onClick={onToggleTheme} title="Toggle Theme">
                    {isDarkMode ? (
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                            <circle cx="12" cy="12" r="5"/>
                            <line x1="12" y1="1" x2="12" y2="3"/>
                            <line x1="12" y1="21" x2="12" y2="23"/>
                            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                            <line x1="1" y1="12" x2="3" y2="12"/>
                            <line x1="21" y1="12" x2="23" y2="12"/>
                            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                        </svg>
                    ) : (
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    )}
                </button>
                {/* Divider */}
                <div style={{ width: '1px', height: '28px', backgroundColor: '#e2e8f0', margin: '0 8px' }}></div>
                
                {/* Profile Section */}
                <div className="dropdown-container">
                    <button 
                        onClick={handleProfileClick} 
                        title="Profile"
                        style={{
                            display: 'flex',
                            alignItems: 'center',
                            gap: '10px',
                            padding: '4px 8px 4px 4px',
                            background: profileOpen ? '#f1f5f9' : 'transparent',
                            border: 'none',
                            cursor: 'pointer',
                            transition: 'background 0.2s'
                        }}
                        onMouseEnter={(e) => e.currentTarget.style.background = '#f1f5f9'}
                        onMouseLeave={(e) => e.currentTarget.style.background = profileOpen ? '#f1f5f9' : 'transparent'}
                    >
                        <div style={{
                            width: '36px',
                            height: '36px',
                            background: 'linear-gradient(135deg, #3b82f6 0%, #1e40af 100%)',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            color: 'white',
                            fontSize: '14px',
                            fontWeight: '600',
                            boxShadow: '0 2px 4px rgba(59, 130, 246, 0.3)'
                        }}>
                            {(userProfile?.displayName || userProfile?.email || 'U').charAt(0).toUpperCase()}
                        </div>
                        <div style={{ textAlign: 'left', lineHeight: '1.3' }}>
                            <div style={{ fontSize: '13px', fontWeight: '600', color: '#1e293b' }}>
                                {userProfile?.displayName || userProfile?.email?.split('@')[0] || 'User'}
                            </div>
                            <div style={{ 
                                fontSize: '11px', 
                                color: '#64748b', 
                                textTransform: 'capitalize',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '4px'
                            }}>
                                <span style={{
                                    width: '6px',
                                    height: '6px',
                                    backgroundColor: '#22c55e',
                                    display: 'inline-block'
                                }}></span>
                                {userProfile?.role || 'User'}
                            </div>
                        </div>
                        <svg 
                            width="12" 
                            height="12" 
                            viewBox="0 0 24 24" 
                            fill="none" 
                            stroke="#94a3b8" 
                            strokeWidth="2.5" 
                            strokeLinecap="round" 
                            strokeLinejoin="round"
                            style={{
                                transform: profileOpen ? 'rotate(180deg)' : 'rotate(0deg)',
                                transition: 'transform 0.2s'
                            }}
                        >
                            <polyline points="6 9 12 15 18 9"/>
                        </svg>
                    </button>
                    
                    {profileOpen && (
                        <>
                            <div className="dropdown-overlay" onClick={() => setProfileOpen(false)}></div>
                            <div style={{
                                position: 'absolute',
                                top: 'calc(100% + 8px)',
                                right: '0',
                                width: '280px',
                                backgroundColor: 'white',
                                boxShadow: '0 10px 40px rgba(0,0,0,0.15)',
                                border: '1px solid #e2e8f0',
                                zIndex: 1000,
                                overflow: 'hidden'
                            }}>
                                {/* Profile Header */}
                                <div style={{ 
                                    padding: '20px',
                                    background: 'linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%)',
                                    color: 'white'
                                }}>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '14px' }}>
                                        <div style={{
                                            width: '50px',
                                            height: '50px',
                                            backgroundColor: 'rgba(255,255,255,0.2)',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            fontSize: '20px',
                                            fontWeight: '600',
                                            border: '2px solid rgba(255,255,255,0.3)'
                                        }}>
                                            {(userProfile?.displayName || userProfile?.email || 'U').charAt(0).toUpperCase()}
                                        </div>
                                        <div style={{ flex: 1, minWidth: 0 }}>
                                            <div style={{ 
                                                fontWeight: '600', 
                                                fontSize: '15px',
                                                whiteSpace: 'nowrap',
                                                overflow: 'hidden',
                                                textOverflow: 'ellipsis'
                                            }}>
                                                {userProfile?.displayName || userProfile?.email?.split('@')[0] || 'User'}
                                            </div>
                                            <div style={{ 
                                                fontSize: '12px', 
                                                color: 'rgba(255,255,255,0.7)',
                                                marginTop: '2px',
                                                whiteSpace: 'nowrap',
                                                overflow: 'hidden',
                                                textOverflow: 'ellipsis'
                                            }}>
                                                {userProfile?.email || ''}
                                            </div>
                                            <div style={{ 
                                                marginTop: '6px',
                                                display: 'inline-block',
                                                padding: '2px 8px',
                                                backgroundColor: 'rgba(255,255,255,0.2)',
                                                fontSize: '10px',
                                                fontWeight: '500',
                                                textTransform: 'uppercase',
                                                letterSpacing: '0.5px'
                                            }}>
                                                {userProfile?.role || 'User'}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                {/* Menu Items */}
                                <div style={{ padding: '8px 0' }}>
                                    <a 
                                        href="#" 
                                        onClick={(e) => { e.preventDefault(); handleSettingsClick('profile'); }}
                                        style={{
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '12px',
                                            padding: '10px 16px',
                                            color: '#475569',
                                            textDecoration: 'none',
                                            fontSize: '13px',
                                            transition: 'background 0.15s'
                                        }}
                                        onMouseEnter={(e) => e.currentTarget.style.backgroundColor = '#f8fafc'}
                                        onMouseLeave={(e) => e.currentTarget.style.backgroundColor = 'transparent'}
                                    >
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#64748b" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
                                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                            <circle cx="12" cy="7" r="4"/>
                                        </svg>
                                        <span>My Profile</span>
                                    </a>
                                    <a 
                                        href="#" 
                                        onClick={(e) => { e.preventDefault(); handleSettingsClick('account'); }}
                                        style={{
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '12px',
                                            padding: '10px 16px',
                                            color: '#475569',
                                            textDecoration: 'none',
                                            fontSize: '13px',
                                            transition: 'background 0.15s'
                                        }}
                                        onMouseEnter={(e) => e.currentTarget.style.backgroundColor = '#f8fafc'}
                                        onMouseLeave={(e) => e.currentTarget.style.backgroundColor = 'transparent'}
                                    >
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#64748b" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
                                            <circle cx="12" cy="12" r="3"/>
                                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                                        </svg>
                                        <span>Account Settings</span>
                                    </a>
                                    <a 
                                        href="#" 
                                        onClick={(e) => { e.preventDefault(); handleSettingsClick('support'); }}
                                        style={{
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '12px',
                                            padding: '10px 16px',
                                            color: '#475569',
                                            textDecoration: 'none',
                                            fontSize: '13px',
                                            transition: 'background 0.15s'
                                        }}
                                        onMouseEnter={(e) => e.currentTarget.style.backgroundColor = '#f8fafc'}
                                        onMouseLeave={(e) => e.currentTarget.style.backgroundColor = 'transparent'}
                                    >
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#64748b" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
                                            <circle cx="12" cy="12" r="10"/>
                                            <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                                            <line x1="12" y1="17" x2="12.01" y2="17"/>
                                        </svg>
                                        <span>Help & Support</span>
                                    </a>
                                </div>
                                
                                {/* Sign Out */}
                                <div style={{ borderTop: '1px solid #e2e8f0', padding: '8px 0' }}>
                                    <a 
                                        href="#" 
                                        onClick={(e) => { e.preventDefault(); handleLogoutClick(); }}
                                        style={{
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '12px',
                                            padding: '10px 16px',
                                            color: '#dc2626',
                                            textDecoration: 'none',
                                            fontSize: '13px',
                                            fontWeight: '500',
                                            transition: 'background 0.15s'
                                        }}
                                        onMouseEnter={(e) => e.currentTarget.style.backgroundColor = '#fef2f2'}
                                        onMouseLeave={(e) => e.currentTarget.style.backgroundColor = 'transparent'}
                                    >
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
                                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                                            <polyline points="16 17 21 12 16 7"/>
                                            <line x1="21" y1="12" x2="9" y2="12"/>
                                        </svg>
                                        <span>Sign Out</span>
                                    </a>
                                </div>
                            </div>
                        </>
                    )}
                </div>
            </div>
        </div>
    );
}

// Generate unique ID
const generateId = () => Math.random().toString(36).substr(2, 9);

// Format time elapsed
const formatTimeElapsed = (dateString) => {
    if (!dateString) return '-';
    const date = typeof dateString === 'string' ? new Date(dateString) : dateString;
    const now = new Date();
    const diff = Math.floor((now - date) / 1000 / 60);
    if (diff < 1) return 'Just now';
    if (diff < 60) return `${diff}m ago`;
    const hours = Math.floor(diff / 60);
    if (hours < 24) return `${hours}h ${diff % 60}m`;
    return `${Math.floor(hours / 24)}d ago`;
};

// Format time for display
const formatTime = (dateString) => {
    if (!dateString) return '-';
    const date = typeof dateString === 'string' ? new Date(dateString) : dateString;
    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
};

// Service types
const SERVICE_TYPES = [
    { id: 'basic', name: 'Basic Wash', price: 500 },
    { id: 'standard', name: 'Standard Wash', price: 800 },
    { id: 'premium', name: 'Premium Wash', price: 1200 },
    { id: 'full-detail', name: 'Full Detail', price: 2500 },
    { id: 'interior-only', name: 'Interior Only', price: 600 },
    { id: 'exterior-only', name: 'Exterior Only', price: 400 }
];

// Intake categories and item types
const INTAKE_CATEGORIES = [
    { id: 'vehicle', label: 'Vehicle', icon: 'üöó' },
    { id: 'motorbike', label: 'Motorbike', icon: 'üèçÔ∏è' },
    { id: 'bicycle', label: 'Bicycle', icon: 'üö≤' },
    { id: 'carpet', label: 'Carpet', icon: 'üßπ' },
    { id: 'other', label: 'Other', icon: 'üì¶' }
];

const ITEM_TYPES = {
    vehicle: ['Sedan', 'SUV', 'Truck', 'Van', 'Bus', 'Pickup'],
    motorbike: ['Sport Bike', 'Cruiser', 'Scooter', 'Off-road', 'Standard'],
    bicycle: ['Mountain Bike', 'Road Bike', 'BMX', 'Electric Bike', 'Standard'],
    carpet: ['Small (< 2m)', 'Medium (2-4m)', 'Large (4-6m)', 'Extra Large (> 6m)'],
    other: ['Boat Cover', 'Car Seat', 'Floor Mats', 'Custom Item']
};

// Legacy support
const VEHICLE_TYPES = ['Sedan', 'SUV', 'Truck', 'Van', 'Motorcycle', 'Bus'];

// Default bays (fallback if Firebase not initialized)
const DEFAULT_BAYS = [
    { id: 'bay-1', name: 'Bay 1', status: 'available', currentVehicle: null },
    { id: 'bay-2', name: 'Bay 2', status: 'available', currentVehicle: null },
    { id: 'bay-3', name: 'Bay 3', status: 'available', currentVehicle: null },
    { id: 'bay-4', name: 'Bay 4', status: 'available', currentVehicle: null }
];

// Vehicle Intake Module Component - Firebase Integrated
function VehicleIntake() {
    // State management
    const [queue, setQueue] = useState([]);
    const [vehicles, setVehicles] = useState([]);
    const [bays, setBays] = useState(DEFAULT_BAYS);
    const [servicePackages, setServicePackages] = useState([]);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState(null);
    const [actionLoading, setActionLoading] = useState(false);
    const [showAddModal, setShowAddModal] = useState(false);
    const [showAssignModal, setShowAssignModal] = useState(false);
    const [showViewModal, setShowViewModal] = useState(false);
    const [showEditModal, setShowEditModal] = useState(false);
    const [showInvoiceModal, setShowInvoiceModal] = useState(false);
    const [selectedVehicle, setSelectedVehicle] = useState(null);
    const [editFormData, setEditFormData] = useState({});
    const [formData, setFormData] = useState({
        plateNumber: '',
        category: 'vehicle',
        itemType: 'Sedan',
        service: '', // Will be set when packages load
        priority: 'normal',
        customerName: '',
        customerPhone: ''
    });
    const [searchQuery, setSearchQuery] = useState('');
    const [dateFilter, setDateFilter] = useState('all');

    // Generate next auto-ID for non-vehicle categories
    const generateNextId = (category) => {
        const prefix = {
            'motorbike': 'MB',
            'bicycle': 'BC',
            'carpet': 'CP',
            'other': 'OT'
        }[category] || 'ID';
        
        // Get all existing IDs with this prefix from queue and vehicles
        const allItems = [...queue, ...vehicles];
        const existingIds = allItems
            .filter(item => item.plateNumber?.startsWith(prefix + '-'))
            .map(item => {
                const num = parseInt(item.plateNumber.replace(prefix + '-', ''), 10);
                return isNaN(num) ? 0 : num;
            });
        
        const nextNum = existingIds.length > 0 ? Math.max(...existingIds) + 1 : 1;
        return `${prefix}-${String(nextNum).padStart(3, '0')}`;
    };

    // Set default service when packages load
    useEffect(() => {
        if (servicePackages.length > 0 && !formData.service) {
            setFormData(prev => ({ ...prev, service: servicePackages[0].id }));
        }
    }, [servicePackages]);

    // Filter vehicles based on search and date
    const getFilteredVehicles = () => {
        let filtered = vehicles;

        // Search filter
        if (searchQuery.trim()) {
            const query = searchQuery.toLowerCase();
            filtered = filtered.filter(v => 
                v.plateNumber?.toLowerCase().includes(query) ||
                v.customerName?.toLowerCase().includes(query) ||
                v.customerPhone?.includes(query) ||
                v.service?.name?.toLowerCase().includes(query) ||
                v.vehicleType?.toLowerCase().includes(query)
            );
        }

        // Date filter
        if (dateFilter !== 'all') {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            const weekStart = new Date(today);
            weekStart.setDate(weekStart.getDate() - 7);
            const monthStart = new Date(today);
            monthStart.setDate(monthStart.getDate() - 30);

            filtered = filtered.filter(v => {
                const vehicleDate = new Date(v.timeIn);
                switch (dateFilter) {
                    case 'today':
                        return vehicleDate >= today;
                    case 'yesterday':
                        return vehicleDate >= yesterday && vehicleDate < today;
                    case 'week':
                        return vehicleDate >= weekStart;
                    case 'month':
                        return vehicleDate >= monthStart;
                    default:
                        return true;
                }
            });
        }

        return filtered;
    };

    const filteredVehicles = getFilteredVehicles();

    // Initialize Firebase subscriptions - using refs for proper cleanup
    const subscriptionsRef = React.useRef({
        queue: null,
        records: null,
        bays: null,
        packages: null,
        mounted: true
    });

    useEffect(() => {
        console.log('üîÑ VehicleIntake: Initializing Firebase subscriptions...');
        subscriptionsRef.current.mounted = true;
        
        // Function to get services safely
        const getServices = () => window.FirebaseServices;

        const initializeData = async () => {
            // Check if still mounted
            if (!subscriptionsRef.current.mounted) return;
            
            let services = getServices();

            // Wait for services if not ready - use fast polling
            if (!services) {
                let attempts = 0;
                while (!services && attempts < 20 && subscriptionsRef.current.mounted) {
                    await new Promise(resolve => setTimeout(resolve, 50));
                    services = getServices();
                    attempts++;
                }
                
                if (!services) {
                    console.error('‚ùå FirebaseServices not available');
                    if (subscriptionsRef.current.mounted) {
                        setError('Connecting...');
                        setTimeout(initializeData, 100);
                    }
                    return;
                }
            }
            
            // Check if still mounted before proceeding
            if (!subscriptionsRef.current.mounted) return;
            
            // Clear loading error if we got services
            setError(null);

            const { intakeQueueService, intakeRecordsService, intakeBaysService, packagesService } = services;
            
            if (!intakeQueueService || !intakeRecordsService || !intakeBaysService) {
                console.error('‚ùå Required intake services not available');
                setError('Required services incomplete.');
                return;
            }

            try {
                // Initialize bays if needed
                await intakeBaysService.initializeBays();
                
                // Check if still mounted
                if (!subscriptionsRef.current.mounted) return;
                
                // Subscribe to queue (Realtime Database) - PERSISTED DATA
                console.log('üì° Subscribing to queue...');
                subscriptionsRef.current.queue = intakeQueueService.subscribeToQueue(
                    (queueData) => {
                        if (subscriptionsRef.current.mounted) {
                            console.log('üì• Queue updated:', queueData.length, 'items');
                            setQueue(queueData);
                        }
                    },
                    (err) => {
                        console.error('Queue subscription error:', err);
                        if (subscriptionsRef.current.mounted) {
                            setError('Failed to load queue data');
                        }
                    }
                );

                // Subscribe to vehicle records (Firestore)
                subscriptionsRef.current.records = intakeRecordsService.subscribeToRecords(
                    (recordsData) => {
                        if (subscriptionsRef.current.mounted) {
                            console.log('üì• Records updated:', recordsData.length, 'items');
                            setVehicles(recordsData);
                        }
                    },
                    (err) => {
                        console.error('Records subscription error:', err);
                        if (subscriptionsRef.current.mounted) {
                            setError('Failed to load vehicle records');
                        }
                    }
                );

                // Subscribe to bays (Realtime Database)
                subscriptionsRef.current.bays = intakeBaysService.subscribeToBays(
                    (baysData) => {
                        if (subscriptionsRef.current.mounted) {
                            console.log('üì• Bays updated:', baysData.length, 'bays');
                            setBays(baysData.length > 0 ? baysData : DEFAULT_BAYS);
                        }
                    },
                    (err) => {
                        console.error('Bays subscription error:', err);
                    }
                );

                // Subscribe to service packages (Firestore)
                if (packagesService) {
                    await packagesService.initializeDefaultPackages();
                    if (!subscriptionsRef.current.mounted) return;
                    
                    subscriptionsRef.current.packages = packagesService.subscribeToPackages(
                        (packagesData) => {
                            if (subscriptionsRef.current.mounted) {
                                console.log('üì• Packages updated:', packagesData.length, 'packages');
                                // Only include active packages
                                setServicePackages(packagesData.filter(p => p.isActive !== false));
                            }
                        },
                        (err) => {
                            console.error('Packages subscription error:', err);
                        }
                    );
                }

                if (subscriptionsRef.current.mounted) {
                    setLoading(false);
                    console.log('‚úÖ VehicleIntake: Subscriptions active');
                }
                
            } catch (err) {
                console.error('‚ùå Failed to initialize:', err);
                if (subscriptionsRef.current.mounted) {
                    setError('Failed to initialize data. Please refresh.');
                    setLoading(false);
                }
            }
        };

        initializeData();

        // Cleanup subscriptions on unmount
        return () => {
            console.log('üßπ VehicleIntake: Cleaning up subscriptions');
            subscriptionsRef.current.mounted = false;
            if (subscriptionsRef.current.queue) subscriptionsRef.current.queue();
            if (subscriptionsRef.current.records) subscriptionsRef.current.records();
            if (subscriptionsRef.current.bays) subscriptionsRef.current.bays();
            if (subscriptionsRef.current.packages) subscriptionsRef.current.packages();
        };
    }, []);

    // Calculate stats from live data
    const stats = {
        waiting: queue.filter(v => v.status === 'waiting').length,
        inProgress: vehicles.filter(v => v.status === 'in-progress').length,
        availableBays: bays.filter(b => b.status === 'available').length,
        avgWaitTime: queue.length > 0 
            ? Math.round(queue.reduce((acc, v) => {
                const timeIn = new Date(v.timeIn);
                return acc + (new Date() - timeIn) / 1000 / 60;
            }, 0) / queue.length) 
            : 0
    };

    // Add item to queue (saves to Realtime Database)
    const handleAddVehicle = async () => {
        // For vehicles, plate number is required. For others, auto-generate if empty
        let plateNumber = formData.plateNumber.trim();
        if (formData.category === 'vehicle' && !plateNumber) {
            setError('Plate number is required for vehicles.');
            return;
        }
        if (formData.category !== 'vehicle' && !plateNumber) {
            plateNumber = generateNextId(formData.category);
        }
        
        const services = window.FirebaseServices;
        if (!services || !services.intakeQueueService) {
            setError('Firebase not ready. Please wait and try again.');
            return;
        }
        
        setActionLoading(true);
        try {
            // Find package from dynamic packages list
            const serviceInfo = servicePackages.find(s => s.id === formData.service) || servicePackages[0];
            const vehicleData = {
                plateNumber: plateNumber.toUpperCase(),
                category: formData.category,
                itemType: formData.itemType,
                vehicleType: formData.itemType, // Legacy support
                service: serviceInfo ? { id: serviceInfo.id, name: serviceInfo.name, price: serviceInfo.price } : null,
                priority: formData.priority,
                customerName: formData.customerName || null,
                customerPhone: formData.customerPhone || null
            };

            const result = await services.intakeQueueService.addToQueue(vehicleData);
            
            if (result.success) {
                console.log('‚úÖ Item added to queue:', result.id);
                
                // Log activity with user info
                if (services.activityService) {
                    const currentUser = window.currentUserProfile;
                    services.activityService.logActivity({
                        type: 'intake',
                        action: 'Item Added to Queue',
                        details: `${INTAKE_CATEGORIES.find(c => c.id === formData.category)?.label || 'Item'}: ${plateNumber.toUpperCase()} - ${serviceInfo?.name || 'No service'}`,
                        status: 'success',
                        loggedBy: currentUser?.displayName || currentUser?.email?.split('@')[0] || 'System',
                        loggedByEmail: currentUser?.email || null,
                        loggedByRole: currentUser?.role || null
                    });
                }
                
                setFormData({
                    plateNumber: '',
                    category: 'vehicle',
                    itemType: 'Sedan',
                    service: servicePackages.length > 0 ? servicePackages[0].id : '',
                    priority: 'normal',
                    customerName: '',
                    customerPhone: ''
                });
                setShowAddModal(false);
            } else {
                setError('Failed to add vehicle: ' + result.error);
            }
        } catch (err) {
            console.error('Error adding vehicle:', err);
            setError('Failed to add vehicle. Please try again.');
        } finally {
            setActionLoading(false);
        }
    };

    // Assign bay to vehicle from queue
    const handleAssignBay = async (bayId) => {
        if (!selectedVehicle) return;
        
        const services = window.FirebaseServices;
        if (!services) {
            setError('Firebase not ready. Please wait and try again.');
            return;
        }
        
        setActionLoading(true);
        try {
            const bay = bays.find(b => b.id === bayId);
            // Remove the queue ID before saving to Firestore
            const { id: queueId, ...vehicleData } = selectedVehicle;
            const vehicleRecord = {
                ...vehicleData,
                queueId: queueId, // Store original queue ID for reference
                status: 'in-progress',
                assignedBay: bay.name,
                assignedBayId: bayId,
                assignedTime: new Date().toISOString(),
                timeIn: new Date().toISOString()
            };

            // 1. Add to Firestore records
            const recordResult = await services.intakeRecordsService.addRecord(vehicleRecord);
            
            if (!recordResult.success) {
                throw new Error('Failed to create vehicle record');
            }

            // 2. Update bay status in Realtime DB
            await services.intakeBaysService.updateBay(bayId, 'occupied', {
                plateNumber: selectedVehicle.plateNumber,
                recordId: recordResult.id
            });

            // 3. Remove from queue in Realtime DB
            await services.intakeQueueService.removeFromQueue(selectedVehicle.id);

            console.log('‚úÖ Vehicle assigned to bay:', bay.name);
            setShowAssignModal(false);
            setSelectedVehicle(null);
            
        } catch (err) {
            console.error('Error assigning bay:', err);
            setError('Failed to assign bay. Please try again.');
        } finally {
            setActionLoading(false);
        }
    };

    // Send to garage
    const handleSendToGarage = async (vehicle) => {
        const services = window.FirebaseServices;
        if (!services || !services.intakeRecordsService) {
            setError('Firebase not ready. Please wait and try again.');
            return;
        }
        
        setActionLoading(true);
        try {
            // Remove the queue ID before saving to Firestore
            const { id: queueId, ...vehicleData } = vehicle;
            const vehicleRecord = {
                ...vehicleData,
                queueId: queueId,
                status: 'garage',
                assignedBay: 'Garage',
                assignedTime: new Date().toISOString(),
                timeIn: new Date().toISOString()
            };

            // Add to Firestore records
            const result = await services.intakeRecordsService.addRecord(vehicleRecord);
            
            if (result.success) {
                // Remove from queue
                await services.intakeQueueService.removeFromQueue(vehicle.id);
                console.log('‚úÖ Vehicle sent to garage');
            } else {
                throw new Error('Failed to create garage record');
            }
        } catch (err) {
            console.error('Error sending to garage:', err);
            setError('Failed to send to garage. Please try again.');
        } finally {
            setActionLoading(false);
        }
    };

    // Mark vehicle as complete - REBUILT
    const handleComplete = async (vehicle) => {
        console.log('=== COMPLETE ACTION ===');
        console.log('Vehicle:', vehicle.plateNumber, 'ID:', vehicle.id);
        
        // Get fresh services reference
        const svc = window.FirebaseServices;
        console.log('Services available:', !!svc);
        console.log('intakeRecordsService:', !!svc?.intakeRecordsService);
        
        if (!svc?.intakeRecordsService) {
            alert('Firebase not ready. Please refresh the page.');
            return;
        }
        
        setActionLoading(true);
        setError(null);
        
        try {
            const updatePayload = {
                status: 'completed',
                timeOut: new Date().toISOString()
            };
            console.log('Update payload:', updatePayload);
            
            const result = await svc.intakeRecordsService.updateRecord(vehicle.id, updatePayload);
            console.log('Update result:', result);

            if (!result.success) {
                throw new Error(result.error || 'Update failed');
            }

            // Free up the bay if assigned
            if (vehicle.assignedBayId && svc.intakeBaysService) {
                console.log('Freeing bay:', vehicle.assignedBayId);
                await svc.intakeBaysService.updateBay(vehicle.assignedBayId, 'available', null);
            }

            console.log('SUCCESS: Vehicle completed');
        } catch (err) {
            console.error('FAILED:', err);
            setError('Complete failed: ' + err.message);
            alert('Failed to complete: ' + err.message);
        } finally {
            setActionLoading(false);
        }
    };

    // Update vehicle status - REBUILT  
    const handleStatusChange = async (vehicle, newStatus) => {
        console.log('=== STATUS CHANGE ===');
        console.log('Vehicle:', vehicle.plateNumber, 'New Status:', newStatus);
        
        const svc = window.FirebaseServices;
        if (!svc?.intakeRecordsService) {
            alert('Firebase not ready. Please refresh the page.');
            return;
        }
        
        setActionLoading(true);
        setError(null);
        
        try {
            const updatePayload = { status: newStatus };
            
            // If completing, add timeOut
            if (newStatus === 'completed') {
                updatePayload.timeOut = new Date().toISOString();
            }
            
            const result = await svc.intakeRecordsService.updateRecord(vehicle.id, updatePayload);
            
            if (!result.success) {
                throw new Error(result.error || 'Update failed');
            }

            // Free bay if completing
            if (newStatus === 'completed' && vehicle.assignedBayId && svc.intakeBaysService) {
                await svc.intakeBaysService.updateBay(vehicle.assignedBayId, 'available', null);
            }

            console.log('SUCCESS: Status changed to', newStatus);
        } catch (err) {
            console.error('FAILED:', err);
            setError('Status change failed: ' + err.message);
            alert('Failed: ' + err.message);
        } finally {
            setActionLoading(false);
        }
    };

    // Remove from queue
    const handleRemoveFromQueue = async (vehicleId) => {
        const services = window.FirebaseServices;
        if (!services) {
            setError('Firebase not ready. Please try again.');
            return;
        }
        
        setActionLoading(true);
        try {
            await services.intakeQueueService.removeFromQueue(vehicleId);
            console.log('‚úÖ Vehicle removed from queue');
        } catch (err) {
            console.error('Error removing from queue:', err);
            setError('Failed to remove vehicle. Please try again.');
        } finally {
            setActionLoading(false);
        }
    };

    // Open assign modal
    const openAssignModal = (vehicle) => {
        setSelectedVehicle(vehicle);
        setShowAssignModal(true);
    };

    // Open view modal
    const openViewModal = (vehicle) => {
        setSelectedVehicle(vehicle);
        setShowViewModal(true);
    };

    // Open edit modal
    const openEditModal = (vehicle) => {
        setSelectedVehicle(vehicle);
        setEditFormData({
            plateNumber: vehicle.plateNumber || '',
            category: vehicle.category || 'vehicle',
            itemType: vehicle.itemType || vehicle.vehicleType || 'Sedan',
            service: vehicle.service?.id || 'basic',
            priority: vehicle.priority || 'normal',
            customerName: vehicle.customerName || '',
            customerPhone: vehicle.customerPhone || '',
            status: vehicle.status || 'in-progress'
        });
        setShowEditModal(true);
    };

    // Handle edit vehicle
    const handleEditVehicle = async () => {
        if (!selectedVehicle) return;
        
        const services = window.FirebaseServices;
        if (!services || !services.intakeRecordsService) {
            console.error('‚ùå Firebase services not available');
            setError('Firebase not ready. Please wait and try again.');
            return;
        }
        
        setActionLoading(true);
        try {
            const serviceInfo = servicePackages.find(s => s.id === editFormData.service) || servicePackages[0];
            const updateData = {
                plateNumber: editFormData.plateNumber.toUpperCase(),
                category: editFormData.category,
                itemType: editFormData.itemType,
                vehicleType: editFormData.itemType, // Legacy support
                service: serviceInfo ? { id: serviceInfo.id, name: serviceInfo.name, price: serviceInfo.price } : null,
                priority: editFormData.priority,
                customerName: editFormData.customerName || null,
                customerPhone: editFormData.customerPhone || null,
                status: editFormData.status
            };
            
            // If status changed to completed, set timeOut
            if (editFormData.status === 'completed' && selectedVehicle.status !== 'completed') {
                updateData.timeOut = new Date().toISOString();
                // Free the bay if assigned
                if (selectedVehicle.assignedBayId) {
                    await services.intakeBaysService.updateBay(selectedVehicle.assignedBayId, 'available', null);
                }
            }

            console.log('üì§ Updating vehicle:', selectedVehicle.id, updateData);
            const result = await services.intakeRecordsService.updateRecord(selectedVehicle.id, updateData);
            console.log('üì§ Update result:', result);
            
            setShowEditModal(false);
            setSelectedVehicle(null);
        } catch (err) {
            console.error('‚ùå Error updating vehicle:', err);
            setError('Failed to update vehicle: ' + err.message);
        } finally {
            setActionLoading(false);
        }
    };

    // Open invoice modal
    const openInvoiceModal = (vehicle) => {
        setSelectedVehicle(vehicle);
        setShowInvoiceModal(true);
    };

    // Print Receipt - Clean thermal receipt style
    const printReceipt = (vehicle) => {
        const total = vehicle.service?.price || 0;
        const receiptNumber = `ECO-${Date.now().toString().slice(-8)}`;
        const printDate = new Date().toLocaleString();
        
        const receiptHTML = `
            <!DOCTYPE html>
            <html>
            <head>
                <title>Receipt - ${vehicle.plateNumber}</title>
                <style>
                    * { margin: 0; padding: 0; box-sizing: border-box; }
                    body { 
                        font-family: 'Courier New', monospace; 
                        width: 280px; 
                        margin: 0 auto; 
                        padding: 20px 10px;
                        background: #fff;
                    }
                    .receipt { text-align: center; }
                    .header { margin-bottom: 15px; border-bottom: 2px dashed #000; padding-bottom: 15px; }
                    .logo { font-size: 24px; font-weight: bold; margin-bottom: 5px; }
                    .tagline { font-size: 10px; color: #666; }
                    .receipt-no { font-size: 11px; margin-top: 10px; }
                    .section { margin: 15px 0; text-align: left; }
                    .section-title { font-weight: bold; font-size: 12px; margin-bottom: 8px; border-bottom: 1px solid #ccc; padding-bottom: 3px; }
                    .row { display: flex; justify-content: space-between; font-size: 12px; margin: 4px 0; }
                    .row-label { color: #666; }
                    .plate { font-size: 18px; font-weight: bold; letter-spacing: 2px; margin: 10px 0; }
                    .divider { border-top: 1px dashed #000; margin: 15px 0; }
                    .total-section { margin: 15px 0; padding: 10px 0; border-top: 2px solid #000; border-bottom: 2px solid #000; }
                    .total { display: flex; justify-content: space-between; font-size: 16px; font-weight: bold; }
                    .footer { margin-top: 20px; font-size: 10px; color: #666; text-align: center; }
                    .barcode { font-family: 'Libre Barcode 39', cursive; font-size: 36px; margin: 10px 0; }
                    @media print {
                        body { width: 80mm; padding: 5mm; }
                        @page { margin: 0; size: 80mm auto; }
                    }
                </style>
            </head>
            <body>
                <div class="receipt">
                    <div class="header">
                        <div class="logo">üöó ECOSPARK</div>
                        <div class="tagline">Premium Car Wash Services</div>
                        <div class="receipt-no">Receipt #${receiptNumber}</div>
                    </div>
                    
                    <div class="plate">${vehicle.plateNumber}</div>
                    
                    <div class="section">
                        <div class="section-title">VEHICLE INFO</div>
                        <div class="row">
                            <span class="row-label">Type:</span>
                            <span>${vehicle.vehicleType}</span>
                        </div>
                        <div class="row">
                            <span class="row-label">Bay:</span>
                            <span>${vehicle.assignedBay || 'N/A'}</span>
                        </div>
                        <div class="row">
                            <span class="row-label">Status:</span>
                            <span>${(vehicle.status || 'pending').toUpperCase()}</span>
                        </div>
                    </div>
                    
                    ${vehicle.customerName ? `
                    <div class="section">
                        <div class="section-title">CUSTOMER</div>
                        <div class="row">
                            <span class="row-label">Name:</span>
                            <span>${vehicle.customerName}</span>
                        </div>
                        ${vehicle.customerPhone ? `<div class="row">
                            <span class="row-label">Phone:</span>
                            <span>${vehicle.customerPhone}</span>
                        </div>` : ''}
                    </div>
                    ` : ''}
                    
                    <div class="section">
                        <div class="section-title">SERVICE</div>
                        <div class="row">
                            <span>${vehicle.service?.name || 'Car Wash'}</span>
                            <span>KSH ${total}</span>
                        </div>
                    </div>
                    
                    <div class="total-section">
                        <div class="total">
                            <span>TOTAL</span>
                            <span>KSH ${total}</span>
                        </div>
                    </div>
                    
                    <div class="section" style="text-align: center;">
                        <div class="row" style="justify-content: center;">
                            <span class="row-label">Time In: ${vehicle.timeIn ? new Date(vehicle.timeIn).toLocaleString() : '-'}</span>
                        </div>
                        ${vehicle.timeOut ? `
                        <div class="row" style="justify-content: center;">
                            <span class="row-label">Time Out: ${new Date(vehicle.timeOut).toLocaleString()}</span>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div class="divider"></div>
                    
                    <div class="footer">
                        <p>Thank you for choosing Ecospark!</p>
                        <p style="margin-top: 5px;">Quality service, every time.</p>
                        <p style="margin-top: 10px; font-size: 9px;">Printed: ${printDate}</p>
                    </div>
                </div>
                <script>
                    window.onload = function() { window.print(); window.onafterprint = function() { window.close(); } }
                </script>
            </body>
            </html>
        `;
        
        const printWindow = window.open('', '_blank', 'width=320,height=600');
        printWindow.document.write(receiptHTML);
        printWindow.document.close();
    };

    // Delete vehicle record
    const handleDeleteRecord = async (vehicle) => {
        if (!confirm('Are you sure you want to delete this record?')) return;
        
        const services = window.FirebaseServices;
        if (!services) {
            setError('Firebase not ready. Please try again.');
            return;
        }
        
        setActionLoading(true);
        try {
            await services.intakeRecordsService.deleteRecord(vehicle.id);
            console.log('‚úÖ Vehicle record deleted:', vehicle.id);
            setShowViewModal(false);
            setSelectedVehicle(null);
        } catch (err) {
            console.error('Error deleting record:', err);
            setError('Failed to delete record. Please try again.');
        } finally {
            setActionLoading(false);
        }
    };

    // Clear error message
    const clearError = () => setError(null);

    // Priority badge color
    const getPriorityColor = (priority) => {
        switch(priority) {
            case 'vip': return '#f59e0b';
            case 'fleet': return '#8b5cf6';
            default: return '#64748b';
        }
    };

    // Status badge color
    const getStatusColor = (status) => {
        switch(status) {
            case 'waiting': return '#f59e0b';
            case 'in-progress': return '#3b82f6';
            case 'completed': return '#10b981';
            case 'garage': return '#8b5cf6';
            default: return '#64748b';
        }
    };

    // Loading state
    if (loading) {
        return (
            <div className="vehicle-intake" style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', minHeight: '400px', flexDirection: 'column', gap: '16px' }}>
                <div style={{ width: '40px', height: '40px', border: '3px solid #e2e8f0', borderTopColor: '#3b82f6', borderRadius: '50%', animation: 'spin 0.8s linear infinite' }}></div>
                <p style={{ color: '#64748b' }}>Loading Vehicle Intake...</p>
                <style>{`@keyframes spin { to { transform: rotate(360deg); } }`}</style>
            </div>
        );
    }

    return (
        <div className="vehicle-intake">
            {/* Error Notification */}
            {error && (
                <div className="intake-error-banner" style={{ 
                    backgroundColor: '#fef2f2', 
                    border: '1px solid #fecaca', 
                    borderRadius: '8px', 
                    padding: '12px 16px', 
                    marginBottom: '16px',
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center'
                }}>
                    <span style={{ color: '#dc2626' }}>{error}</span>
                    <button 
                        onClick={clearError}
                        style={{ 
                            background: 'none', 
                            border: 'none', 
                            color: '#dc2626', 
                            cursor: 'pointer',
                            padding: '4px'
                        }}
                    >
                        {Icons.x}
                    </button>
                </div>
            )}

            {/* Action Loading Overlay */}
            {actionLoading && (
                <div style={{ 
                    position: 'fixed', 
                    top: 0, 
                    left: 0, 
                    right: 0, 
                    bottom: 0, 
                    backgroundColor: 'rgba(255,255,255,0.7)', 
                    display: 'flex', 
                    justifyContent: 'center', 
                    alignItems: 'center', 
                    zIndex: 9999 
                }}>
                    <div style={{ 
                        width: '40px', 
                        height: '40px', 
                        border: '3px solid #e2e8f0', 
                        borderTopColor: '#3b82f6', 
                        borderRadius: '50%', 
                        animation: 'spin 0.8s linear infinite' 
                    }}></div>
                </div>
            )}

            {/* Action Bar */}
            <div className="intake-action-bar">
                <div className="action-bar-primary">
                    <button className="action-btn action-btn-primary" onClick={() => setShowAddModal(true)}>
                        {Icons.plus}
                        <span>Add Item</span>
                    </button>
                    <button className="action-btn action-btn-secondary" disabled={queue.length === 0}>
                        {Icons.package}
                        <span>Assign Service</span>
                    </button>
                    <button className="action-btn action-btn-secondary" disabled={queue.length === 0}>
                        {Icons.arrowRight}
                        <span>Send to Queue</span>
                    </button>
                    <button className="action-btn action-btn-danger" disabled={queue.length === 0}>
                        {Icons.pause}
                        <span>Hold</span>
                    </button>
                </div>
                <div className="action-bar-secondary">
                    <button className="action-btn action-btn-ghost">
                        {Icons.scan}
                        <span>Scan Plate</span>
                    </button>
                    <button className="action-btn action-btn-ghost">
                        {Icons.star}
                        <span>Priority Tag</span>
                    </button>
                    <button className="action-btn action-btn-ghost" onClick={() => window.location.reload()}>
                        {Icons.refresh}
                        <span>Refresh</span>
                    </button>
                </div>
            </div>

            {/* Stat Cards - Compact One-Line */}
            <div className="intake-stats">
                <div className="intake-stat-card">
                    <span className="intake-stat-label">Waiting</span>
                    <span className="intake-stat-value">{stats.waiting}</span>
                </div>
                <div className="intake-stat-card">
                    <span className="intake-stat-label">In Progress</span>
                    <span className="intake-stat-value">{stats.inProgress}</span>
                </div>
                <div className="intake-stat-card">
                    <span className="intake-stat-label">Available Bays</span>
                    <span className="intake-stat-value">{stats.availableBays}</span>
                </div>
                <div className="intake-stat-card">
                    <span className="intake-stat-label">Avg Wait</span>
                    <span className="intake-stat-value">{stats.avgWaitTime}m</span>
                </div>
            </div>

            {/* Queue Section */}
            <div className="intake-section">
                <div className="intake-section-header">
                    <h3>Queue</h3>
                    <span className="intake-section-count">{queue.length} items</span>
                </div>
                <div className="intake-queue">
                    {queue.length === 0 ? (
                        <div className="intake-empty">
                            <p>No items in queue</p>
                            <button className="action-btn action-btn-primary" onClick={() => setShowAddModal(true)}>
                                {Icons.plus} Add Item
                            </button>
                        </div>
                    ) : (
                        queue.map((vehicle, index) => (
                            <div key={vehicle.id} className="queue-card">
                                <div className="queue-card-header">
                                    <span className="queue-card-plate">
                                        {INTAKE_CATEGORIES.find(c => c.id === vehicle.category)?.icon || 'üöó'} {vehicle.plateNumber}
                                    </span>
                                    <span 
                                        className="queue-card-priority" 
                                        style={{ backgroundColor: getPriorityColor(vehicle.priority) }}
                                    >
                                        {vehicle.priority.toUpperCase()}
                                    </span>
                                </div>
                                <div className="queue-card-body">
                                    <div className="queue-card-info">
                                        <span className="queue-card-service">{vehicle.service.name}</span>
                                        <span className="queue-card-time">{Icons.clock} {formatTimeElapsed(vehicle.timeIn)}</span>
                                    </div>
                                    <span className="queue-card-type">{vehicle.itemType || vehicle.vehicleType}</span>
                                </div>
                                <div className="queue-card-actions">
                                    <button 
                                        className="queue-action-btn queue-action-primary"
                                        onClick={() => openAssignModal(vehicle)}
                                    >
                                        Assign Bay
                                    </button>
                                    <button 
                                        className="queue-action-btn"
                                        onClick={() => handleSendToGarage(vehicle)}
                                    >
                                        Garage
                                    </button>
                                    <button 
                                        className="queue-action-btn queue-action-danger"
                                        onClick={() => handleRemoveFromQueue(vehicle.id)}
                                    >
                                        Remove
                                    </button>
                                </div>
                            </div>
                        ))
                    )}
                </div>
            </div>

            {/* Vehicle Management Table */}
            <div className="intake-section">
                <div className="intake-section-header" style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', flexWrap: 'wrap', gap: '12px' }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                        <h3 style={{ margin: 0 }}>Intake Records</h3>
                        <span className="intake-section-count">{filteredVehicles.length} of {vehicles.length}</span>
                    </div>
                    
                    {/* Search and Filter Bar */}
                    <div style={{ display: 'flex', gap: '12px', alignItems: 'center' }}>
                        {/* Search Input */}
                        <div style={{ position: 'relative', minWidth: '200px' }}>
                            <input
                                type="text"
                                placeholder="Search..."
                                value={searchQuery}
                                onChange={(e) => setSearchQuery(e.target.value)}
                                style={{
                                    width: '100%',
                                    padding: '8px 12px 8px 32px',
                                    border: '1px solid #e2e8f0',
                                    borderRadius: '6px',
                                    fontSize: '13px',
                                    outline: 'none'
                                }}
                            />
                            <svg 
                                style={{ position: 'absolute', left: '10px', top: '50%', transform: 'translateY(-50%)', color: '#94a3b8' }}
                                width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"
                            >
                                <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
                            </svg>
                            {searchQuery && (
                                <button 
                                    onClick={() => setSearchQuery('')}
                                    style={{ position: 'absolute', right: '6px', top: '50%', transform: 'translateY(-50%)', background: 'none', border: 'none', cursor: 'pointer', color: '#94a3b8', padding: '2px' }}
                                >
                                    {Icons.x}
                                </button>
                            )}
                        </div>
                        
                        {/* Date Filter Buttons */}
                        <div style={{ display: 'flex', gap: '2px', backgroundColor: '#f1f5f9', borderRadius: '6px', padding: '3px' }}>
                            {[
                                { id: 'all', label: 'All' },
                                { id: 'today', label: 'Today' },
                                { id: 'yesterday', label: 'Yesterday' },
                                { id: 'week', label: 'Week' },
                                { id: 'month', label: 'Month' }
                            ].map(filter => (
                                <button
                                    key={filter.id}
                                    onClick={() => setDateFilter(filter.id)}
                                    style={{
                                        padding: '5px 10px',
                                        border: 'none',
                                        borderRadius: '4px',
                                        fontSize: '12px',
                                        fontWeight: '500',
                                        cursor: 'pointer',
                                        backgroundColor: dateFilter === filter.id ? '#fff' : 'transparent',
                                        color: dateFilter === filter.id ? '#1e293b' : '#64748b',
                                        boxShadow: dateFilter === filter.id ? '0 1px 2px rgba(0,0,0,0.05)' : 'none'
                                    }}
                                >
                                    {filter.label}
                                </button>
                            ))}
                        </div>
                    </div>
                </div>
                
                <div className="intake-table-container">
                    <table className="intake-table">
                        <thead>
                            <tr>
                                <th>ID / Plate</th>
                                <th>Category</th>
                                <th>Type</th>
                                <th>Service</th>
                                <th>Price</th>
                                <th>Status</th>
                                <th>Time In</th>
                                <th>Time Out</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {filteredVehicles.length === 0 ? (
                                <tr>
                                    <td colSpan="9" className="intake-table-empty">
                                        {vehicles.length === 0 
                                            ? 'No intake records. Add items from the queue above.'
                                            : 'No records match your search or filter.'}
                                    </td>
                                </tr>
                            ) : (
                                filteredVehicles.map(vehicle => (
                                    <tr key={vehicle.id}>
                                        <td className="intake-table-plate">
                                            {INTAKE_CATEGORIES.find(c => c.id === vehicle.category)?.icon || 'üöó'} {vehicle.plateNumber}
                                        </td>
                                        <td>{INTAKE_CATEGORIES.find(c => c.id === vehicle.category)?.label || 'Vehicle'}</td>
                                        <td>{vehicle.itemType || vehicle.vehicleType}</td>
                                        <td>{vehicle.service?.name || '-'}</td>
                                        <td style={{ color: '#10b981', fontWeight: '600' }}>KSH {vehicle.service?.price || 0}</td>
                                        <td>
                                            {/* Status Dropdown - Direct Change */}
                                            <select
                                                value={vehicle.status || 'in-progress'}
                                                onChange={(e) => handleStatusChange(vehicle, e.target.value)}
                                                disabled={actionLoading}
                                                style={{
                                                    padding: '6px 10px',
                                                    borderRadius: '6px',
                                                    border: '1px solid #e2e8f0',
                                                    fontSize: '12px',
                                                    fontWeight: '500',
                                                    cursor: 'pointer',
                                                    backgroundColor: getStatusColor(vehicle.status),
                                                    color: '#fff',
                                                    outline: 'none'
                                                }}
                                            >
                                                <option value="in-progress" style={{ backgroundColor: '#3b82f6', color: '#fff' }}>In Progress</option>
                                                <option value="completed" style={{ backgroundColor: '#10b981', color: '#fff' }}>Completed</option>
                                                <option value="garage" style={{ backgroundColor: '#8b5cf6', color: '#fff' }}>Garage</option>
                                                <option value="waiting" style={{ backgroundColor: '#f59e0b', color: '#fff' }}>Waiting</option>
                                            </select>
                                        </td>
                                        <td>{formatTime(vehicle.timeIn)}</td>
                                        <td>{formatTime(vehicle.timeOut)}</td>
                                        <td>
                                            <div className="intake-table-actions">
                                                <button 
                                                    className="table-action-btn" 
                                                    title="View Details"
                                                    onClick={() => openViewModal(vehicle)}
                                                >
                                                    {Icons.eye}
                                                </button>
                                                <button 
                                                    className="table-action-btn" 
                                                    title="Edit Vehicle"
                                                    onClick={() => openEditModal(vehicle)}
                                                >
                                                    {Icons.edit}
                                                </button>
                                                <button 
                                                    className="table-action-btn" 
                                                    title="Print Receipt"
                                                    onClick={() => printReceipt(vehicle)}
                                                    style={{ color: '#6366f1' }}
                                                >
                                                    {Icons.printer}
                                                </button>
                                                {vehicle.status !== 'completed' && (
                                                    <button 
                                                        className="table-action-btn table-action-complete" 
                                                        title="Mark Complete"
                                                        onClick={() => handleComplete(vehicle)}
                                                        disabled={actionLoading}
                                                    >
                                                        {Icons.check}
                                                    </button>
                                                )}
                                                {vehicle.status === 'completed' && (
                                                    <button 
                                                        className="table-action-btn" 
                                                        title="View Invoice"
                                                        onClick={() => openInvoiceModal(vehicle)}
                                                    >
                                                        {Icons.fileText}
                                                    </button>
                                                )}
                                            </div>
                                        </td>
                                    </tr>
                                ))
                            )}
                        </tbody>
                    </table>
                </div>
            </div>

            {/* Add Item Modal */}
            {showAddModal && (
                <div className="modal-overlay" onClick={() => setShowAddModal(false)}>
                    <div className="modal" onClick={e => e.stopPropagation()}>
                        <div className="modal-header">
                            <h2>Add to Queue</h2>
                            <button className="modal-close" onClick={() => setShowAddModal(false)}>
                                {Icons.x}
                            </button>
                        </div>
                        <div className="modal-body">
                            <div className="form-group">
                                <label>Category</label>
                                <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                                    {INTAKE_CATEGORIES.map(cat => (
                                        <button
                                            key={cat.id}
                                            type="button"
                                            onClick={() => {
                                                const newCategory = cat.id;
                                                const autoId = newCategory !== 'vehicle' ? generateNextId(newCategory) : '';
                                                setFormData({
                                                    ...formData, 
                                                    category: newCategory, 
                                                    itemType: ITEM_TYPES[newCategory][0],
                                                    plateNumber: autoId
                                                });
                                            }}
                                            style={{
                                                padding: '8px 12px',
                                                border: formData.category === cat.id ? '2px solid #3b82f6' : '1px solid #e5e7eb',
                                                borderRadius: '8px',
                                                background: formData.category === cat.id ? '#eff6ff' : '#fff',
                                                cursor: 'pointer',
                                                display: 'flex',
                                                alignItems: 'center',
                                                gap: '6px',
                                                fontSize: '13px',
                                                fontWeight: formData.category === cat.id ? '600' : '400'
                                            }}
                                        >
                                            <span>{cat.icon}</span>
                                            <span>{cat.label}</span>
                                        </button>
                                    ))}
                                </div>
                            </div>
                            <div className="form-group">
                                <label>{formData.category === 'vehicle' ? 'Plate Number *' : 'ID (Auto-generated)'}</label>
                                {formData.category === 'vehicle' ? (
                                    <input 
                                        type="text" 
                                        value={formData.plateNumber}
                                        onChange={e => setFormData({...formData, plateNumber: e.target.value})}
                                        placeholder="e.g., KAA 123A"
                                        autoFocus
                                    />
                                ) : (
                                    <div style={{ 
                                        display: 'flex', 
                                        alignItems: 'center', 
                                        gap: '10px',
                                        padding: '10px 14px',
                                        background: '#f1f5f9',
                                        borderRadius: '8px',
                                        border: '1px solid #e2e8f0'
                                    }}>
                                        <span style={{ fontSize: '16px', fontWeight: '600', color: '#1e293b' }}>
                                            {formData.plateNumber || generateNextId(formData.category)}
                                        </span>
                                        <span style={{ fontSize: '12px', color: '#64748b' }}>
                                            (Auto-assigned)
                                        </span>
                                    </div>
                                )}
                            </div>
                            <div className="form-row">
                                <div className="form-group">
                                    <label>Type</label>
                                    <select 
                                        value={formData.itemType}
                                        onChange={e => setFormData({...formData, itemType: e.target.value})}
                                    >
                                        {(ITEM_TYPES[formData.category] || ITEM_TYPES.vehicle).map(type => (
                                            <option key={type} value={type}>{type}</option>
                                        ))}
                                    </select>
                                </div>
                                <div className="form-group">
                                    <label>Service</label>
                                    <select 
                                        value={formData.service}
                                        onChange={e => setFormData({...formData, service: e.target.value})}
                                    >
                                        {servicePackages.length > 0 ? servicePackages.map(service => (
                                            <option key={service.id} value={service.id}>
                                                {service.name} - KES {service.price?.toLocaleString()}
                                            </option>
                                        )) : (
                                            <option value="">Loading packages...</option>
                                        )}
                                    </select>
                                </div>
                            </div>
                            <div className="form-group">
                                <label>Priority</label>
                                <div className="priority-options">
                                    {['normal', 'vip', 'fleet'].map(p => (
                                        <button 
                                            key={p}
                                            className={`priority-option ${formData.priority === p ? 'active' : ''}`}
                                            onClick={() => setFormData({...formData, priority: p})}
                                            type="button"
                                        >
                                            {p.toUpperCase()}
                                        </button>
                                    ))}
                                </div>
                            </div>
                            <div className="form-row">
                                <div className="form-group">
                                    <label>Customer Name</label>
                                    <input 
                                        type="text" 
                                        value={formData.customerName}
                                        onChange={e => setFormData({...formData, customerName: e.target.value})}
                                        placeholder="Optional"
                                    />
                                </div>
                                <div className="form-group">
                                    <label>Phone</label>
                                    <input 
                                        type="text" 
                                        value={formData.customerPhone}
                                        onChange={e => setFormData({...formData, customerPhone: e.target.value})}
                                        placeholder="Optional"
                                    />
                                </div>
                            </div>
                        </div>
                        <div className="modal-footer">
                            <button className="modal-btn modal-btn-secondary" onClick={() => setShowAddModal(false)}>
                                Cancel
                            </button>
                            <button 
                                className="modal-btn modal-btn-primary" 
                                onClick={handleAddVehicle}
                                disabled={formData.category === 'vehicle' && !formData.plateNumber.trim()}
                            >
                                Add to Queue
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* Assign Bay Modal */}
            {showAssignModal && selectedVehicle && (
                <div className="modal-overlay" onClick={() => setShowAssignModal(false)}>
                    <div className="modal modal-small" onClick={e => e.stopPropagation()}>
                        <div className="modal-header">
                            <h2>Assign Bay</h2>
                            <button className="modal-close" onClick={() => setShowAssignModal(false)}>
                                {Icons.x}
                            </button>
                        </div>
                        <div className="modal-body">
                            <p className="assign-vehicle-info">
                                <strong>{selectedVehicle.plateNumber}</strong> - {selectedVehicle.service?.name || 'No Service'}
                            </p>
                            <div className="bay-grid">
                                {bays.map(bay => (
                                    <button 
                                        key={bay.id}
                                        className={`bay-option ${bay.status !== 'available' ? 'bay-occupied' : ''}`}
                                        onClick={() => bay.status === 'available' && handleAssignBay(bay.id)}
                                        disabled={bay.status !== 'available'}
                                    >
                                        <span className="bay-name">{bay.name}</span>
                                        <span className="bay-status">{bay.status}</span>
                                        {bay.currentVehicle && (
                                            <span className="bay-vehicle">{bay.currentVehicle.plateNumber}</span>
                                        )}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* View Details Modal */}
            {showViewModal && selectedVehicle && (
                <div className="modal-overlay" onClick={() => setShowViewModal(false)}>
                    <div className="modal" onClick={e => e.stopPropagation()}>
                        <div className="modal-header">
                            <h2>Item Details</h2>
                            <button className="modal-close" onClick={() => setShowViewModal(false)}>
                                {Icons.x}
                            </button>
                        </div>
                        <div className="modal-body">
                            <div className="vehicle-details">
                                <div className="detail-row">
                                    <span className="detail-label">ID / Plate Number</span>
                                    <span className="detail-value" style={{ fontWeight: 'bold', fontSize: '1.2em' }}>
                                        {INTAKE_CATEGORIES.find(c => c.id === selectedVehicle.category)?.icon || 'üöó'} {selectedVehicle.plateNumber}
                                    </span>
                                </div>
                                <div className="detail-row">
                                    <span className="detail-label">Category</span>
                                    <span className="detail-value">{INTAKE_CATEGORIES.find(c => c.id === selectedVehicle.category)?.label || 'Vehicle'}</span>
                                </div>
                                <div className="detail-row">
                                    <span className="detail-label">Type</span>
                                    <span className="detail-value">{selectedVehicle.itemType || selectedVehicle.vehicleType}</span>
                                </div>
                                <div className="detail-row">
                                    <span className="detail-label">Service</span>
                                    <span className="detail-value">{selectedVehicle.service?.name || '-'} (KSH {selectedVehicle.service?.price || 0})</span>
                                </div>
                                <div className="detail-row">
                                    <span className="detail-label">Priority</span>
                                    <span className="detail-value" style={{ textTransform: 'uppercase', color: getPriorityColor(selectedVehicle.priority) }}>{selectedVehicle.priority}</span>
                                </div>
                                <div className="detail-row">
                                    <span className="detail-label">Status</span>
                                    <span className="intake-status-badge" style={{ backgroundColor: getStatusColor(selectedVehicle.status) }}>
                                        {selectedVehicle.status?.replace('-', ' ')}
                                    </span>
                                </div>
                                <div className="detail-row">
                                    <span className="detail-label">Assigned Bay</span>
                                    <span className="detail-value">{selectedVehicle.assignedBay || 'Not assigned'}</span>
                                </div>
                                <div className="detail-row">
                                    <span className="detail-label">Customer Name</span>
                                    <span className="detail-value">{selectedVehicle.customerName || '-'}</span>
                                </div>
                                <div className="detail-row">
                                    <span className="detail-label">Customer Phone</span>
                                    <span className="detail-value">{selectedVehicle.customerPhone || '-'}</span>
                                </div>
                                <div className="detail-row">
                                    <span className="detail-label">Time In</span>
                                    <span className="detail-value">{selectedVehicle.timeIn ? new Date(selectedVehicle.timeIn).toLocaleString() : '-'}</span>
                                </div>
                                <div className="detail-row">
                                    <span className="detail-label">Time Out</span>
                                    <span className="detail-value">{selectedVehicle.timeOut ? new Date(selectedVehicle.timeOut).toLocaleString() : '-'}</span>
                                </div>
                            </div>
                        </div>
                        <div className="modal-footer">
                            <button 
                                className="modal-btn modal-btn-danger" 
                                onClick={() => handleDeleteRecord(selectedVehicle)}
                            >
                                Delete Record
                            </button>
                            <button 
                                className="modal-btn modal-btn-secondary" 
                                onClick={() => {
                                    setShowViewModal(false);
                                    openEditModal(selectedVehicle);
                                }}
                            >
                                Edit
                            </button>
                            <button className="modal-btn modal-btn-primary" onClick={() => setShowViewModal(false)}>
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* Edit Vehicle Modal */}
            {showEditModal && selectedVehicle && (
                <div className="modal-overlay" onClick={() => setShowEditModal(false)}>
                    <div className="modal" onClick={e => e.stopPropagation()}>
                        <div className="modal-header">
                            <h2>Edit Record</h2>
                            <button className="modal-close" onClick={() => setShowEditModal(false)}>
                                {Icons.x}
                            </button>
                        </div>
                        <div className="modal-body">
                            <div className="form-group">
                                <label>ID / Plate Number *</label>
                                <input 
                                    type="text" 
                                    value={editFormData.plateNumber}
                                    onChange={e => setEditFormData({...editFormData, plateNumber: e.target.value})}
                                    placeholder={editFormData.category === 'carpet' ? 'e.g., CARPET-001' : 'e.g., KAA 123A'}
                                />
                            </div>
                            <div className="form-group">
                                <label>Category</label>
                                <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                                    {INTAKE_CATEGORIES.map(cat => (
                                        <button
                                            key={cat.id}
                                            type="button"
                                            onClick={() => setEditFormData({
                                                ...editFormData, 
                                                category: cat.id, 
                                                itemType: ITEM_TYPES[cat.id][0]
                                            })}
                                            style={{
                                                padding: '8px 12px',
                                                border: editFormData.category === cat.id ? '2px solid #3b82f6' : '1px solid #e5e7eb',
                                                borderRadius: '8px',
                                                background: editFormData.category === cat.id ? '#eff6ff' : '#fff',
                                                cursor: 'pointer',
                                                display: 'flex',
                                                alignItems: 'center',
                                                gap: '6px',
                                                fontSize: '13px',
                                                fontWeight: editFormData.category === cat.id ? '600' : '400'
                                            }}
                                        >
                                            <span>{cat.icon}</span>
                                            <span>{cat.label}</span>
                                        </button>
                                    ))}
                                </div>
                            </div>
                            <div className="form-row">
                                <div className="form-group">
                                    <label>Type</label>
                                    <select 
                                        value={editFormData.itemType}
                                        onChange={e => setEditFormData({...editFormData, itemType: e.target.value})}
                                    >
                                        {(ITEM_TYPES[editFormData.category] || ITEM_TYPES.vehicle).map(type => (
                                            <option key={type} value={type}>{type}</option>
                                        ))}
                                    </select>
                                </div>
                                <div className="form-group">
                                    <label>Service</label>
                                    <select 
                                        value={editFormData.service}
                                        onChange={e => setEditFormData({...editFormData, service: e.target.value})}
                                    >
                                        {servicePackages.length > 0 ? servicePackages.map(service => (
                                            <option key={service.id} value={service.id}>
                                                {service.name} - KES {service.price?.toLocaleString()}
                                            </option>
                                        )) : (
                                            <option value="">Loading packages...</option>
                                        )}
                                    </select>
                                </div>
                            </div>
                            <div className="form-row">
                                <div className="form-group">
                                    <label>Priority</label>
                                    <div className="priority-options">
                                        {['normal', 'vip', 'fleet'].map(p => (
                                            <button 
                                                key={p}
                                                className={`priority-option ${editFormData.priority === p ? 'active' : ''}`}
                                                onClick={() => setEditFormData({...editFormData, priority: p})}
                                                type="button"
                                            >
                                                {p.toUpperCase()}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                                <div className="form-group">
                                    <label>Status</label>
                                    <select 
                                        value={editFormData.status}
                                        onChange={e => setEditFormData({...editFormData, status: e.target.value})}
                                    >
                                        <option value="in-progress">In Progress</option>
                                        <option value="completed">Completed</option>
                                        <option value="garage">Garage</option>
                                    </select>
                                </div>
                            </div>
                            <div className="form-row">
                                <div className="form-group">
                                    <label>Customer Name</label>
                                    <input 
                                        type="text" 
                                        value={editFormData.customerName}
                                        onChange={e => setEditFormData({...editFormData, customerName: e.target.value})}
                                        placeholder="Optional"
                                    />
                                </div>
                                <div className="form-group">
                                    <label>Phone</label>
                                    <input 
                                        type="text" 
                                        value={editFormData.customerPhone}
                                        onChange={e => setEditFormData({...editFormData, customerPhone: e.target.value})}
                                        placeholder="Optional"
                                    />
                                </div>
                            </div>
                        </div>
                        <div className="modal-footer">
                            <button className="modal-btn modal-btn-secondary" onClick={() => setShowEditModal(false)}>
                                Cancel
                            </button>
                            <button 
                                className="modal-btn modal-btn-primary" 
                                onClick={handleEditVehicle}
                                disabled={!editFormData.plateNumber?.trim()}
                            >
                                Save Changes
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* Invoice Modal */}
            {showInvoiceModal && selectedVehicle && (
                <div className="modal-overlay" onClick={() => setShowInvoiceModal(false)}>
                    <div className="modal" onClick={e => e.stopPropagation()}>
                        <div className="modal-header">
                            <h2>Invoice</h2>
                            <button className="modal-close" onClick={() => setShowInvoiceModal(false)}>
                                {Icons.x}
                            </button>
                        </div>
                        <div className="modal-body">
                            <div className="invoice-content" style={{ padding: '20px', backgroundColor: '#f8fafc', borderRadius: '8px' }}>
                                <div style={{ textAlign: 'center', marginBottom: '24px' }}>
                                    <h3 style={{ margin: 0, color: '#1e293b' }}>Ecospark Car Wash</h3>
                                    <p style={{ margin: '4px 0', color: '#64748b', fontSize: '14px' }}>Service Invoice</p>
                                </div>
                                
                                <div style={{ borderTop: '1px dashed #cbd5e1', borderBottom: '1px dashed #cbd5e1', padding: '16px 0', marginBottom: '16px' }}>
                                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '8px' }}>
                                        <span style={{ color: '#64748b' }}>Invoice #</span>
                                        <span style={{ fontWeight: '500' }}>INV-{selectedVehicle.id?.slice(0, 8).toUpperCase()}</span>
                                    </div>
                                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '8px' }}>
                                        <span style={{ color: '#64748b' }}>Date</span>
                                        <span>{new Date().toLocaleDateString()}</span>
                                    </div>
                                    <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                                        <span style={{ color: '#64748b' }}>Vehicle</span>
                                        <span style={{ fontWeight: '500' }}>{selectedVehicle.plateNumber}</span>
                                    </div>
                                </div>

                                <div style={{ marginBottom: '16px' }}>
                                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '8px' }}>
                                        <span style={{ color: '#64748b' }}>Customer</span>
                                        <span>{selectedVehicle.customerName || 'Walk-in'}</span>
                                    </div>
                                    {selectedVehicle.customerPhone && (
                                        <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                                            <span style={{ color: '#64748b' }}>Phone</span>
                                            <span>{selectedVehicle.customerPhone}</span>
                                        </div>
                                    )}
                                </div>

                                <div style={{ borderTop: '1px solid #e2e8f0', paddingTop: '16px' }}>
                                    <h4 style={{ margin: '0 0 12px 0', color: '#1e293b' }}>Service</h4>
                                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '8px' }}>
                                        <span>{selectedVehicle.service?.name || 'Service'}</span>
                                        <span>KSH {selectedVehicle.service?.price || 0}</span>
                                    </div>
                                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '8px' }}>
                                        <span style={{ color: '#64748b' }}>Vehicle Type</span>
                                        <span>{selectedVehicle.vehicleType}</span>
                                    </div>
                                </div>

                                <div style={{ borderTop: '2px solid #1e293b', marginTop: '16px', paddingTop: '16px' }}>
                                    <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: '1.2em', fontWeight: 'bold' }}>
                                        <span>Total</span>
                                        <span style={{ color: '#10b981' }}>KSH {selectedVehicle.service?.price || 0}</span>
                                    </div>
                                </div>

                                <div style={{ marginTop: '24px', textAlign: 'center', color: '#64748b', fontSize: '12px' }}>
                                    <p style={{ margin: 0 }}>Thank you for choosing Ecospark!</p>
                                    <p style={{ margin: '4px 0 0 0' }}>Time In: {selectedVehicle.timeIn ? new Date(selectedVehicle.timeIn).toLocaleString() : '-'}</p>
                                    <p style={{ margin: '4px 0 0 0' }}>Time Out: {selectedVehicle.timeOut ? new Date(selectedVehicle.timeOut).toLocaleString() : '-'}</p>
                                </div>
                            </div>
                        </div>
                        <div className="modal-footer">
                            <button className="modal-btn modal-btn-secondary" onClick={() => setShowInvoiceModal(false)}>
                                Close
                            </button>
                            <button 
                                className="modal-btn modal-btn-primary" 
                                onClick={() => window.print()}
                            >
                                Print Invoice
                            </button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}

// Service Packages Module Component - Firebase Integrated
function ServicePackages() {
    const [packages, setPackages] = useState([]);
    const [loading, setLoading] = useState(true);
    const [showModal, setShowModal] = useState(false);
    const [showConfirmModal, setShowConfirmModal] = useState(false);
    const [deleteTargetId, setDeleteTargetId] = useState(null);
    const [editingPackage, setEditingPackage] = useState(null);
    const [formData, setFormData] = useState({
        name: '',
        price: '',
        description: '',
        features: '',
        category: 'standard'
    });
    const [notification, setNotification] = useState(null);

    // Show notification helper
    const showNotification = (message, type = 'success') => {
        setNotification({ message, type });
        setTimeout(() => setNotification(null), 3000);
    };

    // Subscribe to packages on mount
    useEffect(() => {
        const services = window.FirebaseServices;
        if (!services?.packagesService) {
            console.error('PackagesService not available');
            setLoading(false);
            return;
        }

        // Initialize default packages if none exist
        services.packagesService.initializeDefaultPackages();

        // Subscribe to real-time updates
        const unsubscribe = services.packagesService.subscribeToPackages(
            (packagesData) => {
                setPackages(packagesData);
                setLoading(false);
            },
            (error) => {
                console.error('Error subscribing to packages:', error);
                showNotification('Error loading packages', 'error');
                setLoading(false);
            }
        );

        return () => unsubscribe && unsubscribe();
    }, []);

    // Handle form input changes
    const handleInputChange = (e) => {
        const { name, value } = e.target;
        setFormData(prev => ({ ...prev, [name]: value }));
    };

    // Open modal for new package
    const handleAddNew = () => {
        setEditingPackage(null);
        setFormData({
            name: '',
            price: '',
            description: '',
            features: '',
            category: 'standard'
        });
        setShowModal(true);
    };

    // Open modal for editing
    const handleEdit = (pkg) => {
        setEditingPackage(pkg);
        setFormData({
            name: pkg.name,
            price: pkg.price.toString(),
            description: pkg.description || '',
            features: Array.isArray(pkg.features) ? pkg.features.join(', ') : '',
            category: pkg.category || 'standard'
        });
        setShowModal(true);
    };

    // Save package (add or update)
    const handleSave = async () => {
        const services = window.FirebaseServices;
        if (!services?.packagesService) return;

        if (!formData.name.trim() || !formData.price) {
            showNotification('Name and price are required', 'error');
            return;
        }

        const packageData = {
            name: formData.name.trim(),
            price: parseFloat(formData.price),
            description: formData.description.trim(),
            features: formData.features.split(',').map(f => f.trim()).filter(f => f),
            category: formData.category
        };

        try {
            if (editingPackage) {
                await services.packagesService.updatePackage(editingPackage.id, packageData);
                showNotification('Package updated successfully');
            } else {
                await services.packagesService.addPackage(packageData);
                showNotification('Package added successfully');
            }
            setShowModal(false);
        } catch (error) {
            showNotification('Error saving package', 'error');
        }
    };

    // Delete package - show confirmation modal
    const handleDelete = (pkgId) => {
        setDeleteTargetId(pkgId);
        setShowConfirmModal(true);
    };

    // Confirm delete package
    const confirmDelete = async () => {
        if (!deleteTargetId) return;
        
        const services = window.FirebaseServices;
        if (!services?.packagesService) return;

        try {
            await services.packagesService.deletePackage(deleteTargetId);
            showNotification('Package deleted successfully');
        } catch (error) {
            showNotification('Error deleting package', 'error');
        } finally {
            setShowConfirmModal(false);
            setDeleteTargetId(null);
        }
    };

    // Toggle package active status
    const handleToggleActive = async (pkg) => {
        const services = window.FirebaseServices;
        if (!services?.packagesService) return;

        try {
            await services.packagesService.updatePackage(pkg.id, { isActive: !pkg.isActive });
            showNotification(`Package ${pkg.isActive ? 'deactivated' : 'activated'}`);
        } catch (error) {
            showNotification('Error updating package status', 'error');
        }
    };

    // Get category color
    const getCategoryColor = (category) => {
        switch (category) {
            case 'premium': return '#f59e0b';
            case 'special': return '#8b5cf6';
            default: return '#3b82f6';
        }
    };

    return (
        <div className="module-content">
            {/* Notification */}
            {notification && (
                <div className={`notification ${notification.type}`}>
                    {notification.type === 'success' ? (
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                            <polyline points="22 4 12 14.01 9 11.01"/>
                        </svg>
                    ) : (
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="12" y1="8" x2="12" y2="12"/>
                            <line x1="12" y1="16" x2="12.01" y2="16"/>
                        </svg>
                    )}
                    <span>{notification.message}</span>
                </div>
            )}

            {/* Header with Add Button */}
            <div className="section-header" style={{ marginBottom: '24px' }}>
                <h2 className="section-title">Service Packages</h2>
                <button className="add-package-btn" onClick={handleAddNew}>
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5">
                        <line x1="12" y1="5" x2="12" y2="19"/>
                        <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    Add Package
                </button>
            </div>

            {/* Packages Grid */}
            {loading ? (
                <div className="loading-container">
                    <div className="loading-spinner"></div>
                    <p>Loading packages...</p>
                </div>
            ) : packages.length === 0 ? (
                <div className="empty-state">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5">
                        <rect x="3" y="3" width="18" height="18" rx="2"/>
                        <path d="M3 9h18"/>
                        <path d="M9 21V9"/>
                    </svg>
                    <h3>No Packages Yet</h3>
                    <p>Create your first service package to get started</p>
                    <button className="primary-button" onClick={handleAddNew}>Create Package</button>
                </div>
            ) : (
                <div className="packages-grid">
                    {packages.map(pkg => (
                        <div key={pkg.id} className={`package-card ${!pkg.isActive ? 'inactive' : ''}`}>
                            <div className="package-header">
                                <span 
                                    className="package-category" 
                                    style={{ backgroundColor: getCategoryColor(pkg.category) }}
                                >
                                    {pkg.category || 'standard'}
                                </span>
                                <div className="package-actions">
                                    <button 
                                        className="icon-btn" 
                                        onClick={() => handleToggleActive(pkg)}
                                        title={pkg.isActive ? 'Deactivate' : 'Activate'}
                                    >
                                        {pkg.isActive ? (
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#10b981" strokeWidth="2">
                                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                                <polyline points="22 4 12 14.01 9 11.01"/>
                                            </svg>
                                        ) : (
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#9ca3af" strokeWidth="2">
                                                <circle cx="12" cy="12" r="10"/>
                                                <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/>
                                            </svg>
                                        )}
                                    </button>
                                    <button className="icon-btn" onClick={() => handleEdit(pkg)} title="Edit">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                        </svg>
                                    </button>
                                    <button className="icon-btn delete" onClick={() => handleDelete(pkg.id)} title="Delete">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                            <polyline points="3 6 5 6 21 6"/>
                                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div className="package-body">
                                <h3 className="package-name">{pkg.name}</h3>
                                <div className="package-price">KES {pkg.price?.toLocaleString()}</div>
                                {pkg.description && <p className="package-description">{pkg.description}</p>}
                            </div>
                            {pkg.features && pkg.features.length > 0 && (
                                <div className="package-features">
                                    <h4>Includes:</h4>
                                    <ul>
                                        {pkg.features.map((feature, idx) => (
                                            <li key={idx}>
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#10b981" strokeWidth="2">
                                                    <polyline points="20 6 9 17 4 12"/>
                                                </svg>
                                                {feature}
                                            </li>
                                        ))}
                                    </ul>
                                </div>
                            )}
                        </div>
                    ))}
                </div>
            )}

            {/* Add/Edit Modal */}
            {showModal && (
                <div className="modal-overlay" onClick={() => setShowModal(false)}>
                    <div className="modal" onClick={e => e.stopPropagation()}>
                        <div className="modal-header">
                            <h3>{editingPackage ? 'Edit Package' : 'Add New Package'}</h3>
                            <button className="modal-close" onClick={() => setShowModal(false)}>√ó</button>
                        </div>
                        <div className="modal-body">
                            <div className="form-group">
                                <label>Package Name *</label>
                                <input
                                    type="text"
                                    name="name"
                                    value={formData.name}
                                    onChange={handleInputChange}
                                    placeholder="e.g., Premium Wash"
                                    className="form-input"
                                />
                            </div>
                            <div className="form-row">
                                <div className="form-group">
                                    <label>Price (KES) *</label>
                                    <input
                                        type="number"
                                        name="price"
                                        value={formData.price}
                                        onChange={handleInputChange}
                                        placeholder="e.g., 1200"
                                        className="form-input"
                                    />
                                </div>
                                <div className="form-group">
                                    <label>Category</label>
                                    <select
                                        name="category"
                                        value={formData.category}
                                        onChange={handleInputChange}
                                        className="form-select"
                                    >
                                        <option value="standard">Standard</option>
                                        <option value="premium">Premium</option>
                                        <option value="special">Special</option>
                                    </select>
                                </div>
                            </div>
                            <div className="form-group">
                                <label>Description</label>
                                <textarea
                                    name="description"
                                    value={formData.description}
                                    onChange={handleInputChange}
                                    placeholder="Brief description of this package"
                                    className="form-textarea"
                                    rows="2"
                                ></textarea>
                            </div>
                            <div className="form-group">
                                <label>Features (comma separated)</label>
                                <textarea
                                    name="features"
                                    value={formData.features}
                                    onChange={handleInputChange}
                                    placeholder="e.g., Exterior Wash, Interior Vacuum, Hand Dry"
                                    className="form-textarea"
                                    rows="3"
                                ></textarea>
                            </div>
                        </div>
                        <div className="modal-footer">
                            <button className="modal-btn-cancel" onClick={() => setShowModal(false)}>Cancel</button>
                            <button className="modal-btn-save" onClick={handleSave}>
                                {editingPackage ? 'Update Package' : 'Add Package'}
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* Confirmation Modal */}
            {showConfirmModal && (
                <div className="modal-overlay" onClick={() => setShowConfirmModal(false)}>
                    <div className="confirm-modal" onClick={e => e.stopPropagation()}>
                        <div className="confirm-modal-icon">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#ef4444" strokeWidth="2">
                                <circle cx="12" cy="12" r="10"/>
                                <line x1="12" y1="8" x2="12" y2="12"/>
                                <line x1="12" y1="16" x2="12.01" y2="16"/>
                            </svg>
                        </div>
                        <h3 className="confirm-modal-title">Delete Package</h3>
                        <p className="confirm-modal-text">Are you sure you want to delete this package? This action cannot be undone.</p>
                        <div className="confirm-modal-actions">
                            <button className="modal-btn-cancel" onClick={() => setShowConfirmModal(false)}>Cancel</button>
                            <button className="modal-btn-delete" onClick={confirmDelete}>Delete</button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}

// Equipment Management Module Component
function EquipmentManagement() {
    const [equipment, setEquipment] = useState([]);
    const [loading, setLoading] = useState(true);
    const [showAddModal, setShowAddModal] = useState(false);
    const [showEditModal, setShowEditModal] = useState(false);
    const [showTransferModal, setShowTransferModal] = useState(false);
    const [showMaintenanceModal, setShowMaintenanceModal] = useState(false);
    const [showHistoryModal, setShowHistoryModal] = useState(false);
    const [selectedEquipment, setSelectedEquipment] = useState(null);
    const [actionLoading, setActionLoading] = useState(false);
    const [error, setError] = useState(null);
    const [activeTab, setActiveTab] = useState('all'); // all, due, overdue
    const [isDark, setIsDark] = useState(document.documentElement.getAttribute('data-theme') === 'dark');

    // Listen for theme changes
    useEffect(() => {
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.attributeName === 'data-theme') {
                    setIsDark(document.documentElement.getAttribute('data-theme') === 'dark');
                }
            });
        });
        observer.observe(document.documentElement, { attributes: true });
        return () => observer.disconnect();
    }, []);

    // Theme colors
    const theme = {
        bg: isDark ? '#1e293b' : 'white',
        bgSecondary: isDark ? '#0f172a' : '#f8fafc',
        bgTertiary: isDark ? '#334155' : '#f1f5f9',
        text: isDark ? '#f1f5f9' : '#1e293b',
        textSecondary: isDark ? '#94a3b8' : '#64748b',
        textMuted: isDark ? '#64748b' : '#94a3b8',
        border: isDark ? '#334155' : '#e2e8f0',
        borderLight: isDark ? '#475569' : '#d1d5db',
        cardShadow: isDark ? '0 1px 3px rgba(0,0,0,0.3)' : '0 1px 3px rgba(0,0,0,0.1)',
        modalOverlay: isDark ? 'rgba(0,0,0,0.7)' : 'rgba(0,0,0,0.5)',
        loadingOverlay: isDark ? 'rgba(15,23,42,0.8)' : 'rgba(255,255,255,0.7)',
        inputBg: isDark ? '#1e293b' : 'white',
        rowHoverBg: isDark ? '#334155' : '#f8fafc',
        rowOverdueBg: isDark ? '#450a0a' : '#fef2f2',
        rowDueBg: isDark ? '#451a03' : '#fffbeb',
        // Button colors for dark mode
        btnTransferBg: isDark ? '#4c1d95' : '#f3e8ff',
        btnTransferText: isDark ? '#c4b5fd' : '#7c3aed',
        btnTransferBorder: isDark ? '#6d28d9' : '#ddd6fe',
        btnMaintainBg: isDark ? '#064e3b' : '#d1fae5',
        btnMaintainText: isDark ? '#6ee7b7' : '#059669',
        btnMaintainBorder: isDark ? '#059669' : '#a7f3d0',
        btnHistoryBg: isDark ? '#334155' : '#f1f5f9',
        btnHistoryText: isDark ? '#cbd5e1' : '#475569',
        btnHistoryBorder: isDark ? '#475569' : '#e2e8f0',
        btnEditBg: isDark ? '#1e3a8a' : '#dbeafe',
        btnEditText: isDark ? '#93c5fd' : '#2563eb',
        btnEditBorder: isDark ? '#3b82f6' : '#bfdbfe',
        btnDeleteBg: isDark ? '#7f1d1d' : '#fee2e2',
        btnDeleteText: isDark ? '#fca5a5' : '#dc2626',
        btnDeleteBorder: isDark ? '#dc2626' : '#fecaca',
    };

    const [formData, setFormData] = useState({
        name: '',
        type: 'pressure_washer',
        location: '',
        serialNumber: '',
        purchaseDate: '',
        lastMaintenance: '',
        nextMaintenance: '',
        status: 'operational',
        notes: ''
    });
    const [transferData, setTransferData] = useState({ toLocation: '', notes: '' });
    const [maintenanceData, setMaintenanceData] = useState({ type: 'routine', description: '', cost: '', performedBy: '', nextMaintenanceDate: '' });

    const EQUIPMENT_TYPES = [
        { id: 'pressure_washer', name: 'Pressure Washer' },
        { id: 'vacuum', name: 'Vacuum Cleaner' },
        { id: 'foam_cannon', name: 'Foam Cannon' },
        { id: 'air_compressor', name: 'Air Compressor' },
        { id: 'water_pump', name: 'Water Pump' },
        { id: 'polisher', name: 'Polisher/Buffer' },
        { id: 'generator', name: 'Generator' },
        { id: 'lift', name: 'Vehicle Lift' },
        { id: 'other', name: 'Other' }
    ];

    const STATUS_OPTIONS = [
        { id: 'operational', name: 'Operational', color: '#10b981' },
        { id: 'maintenance', name: 'Under Maintenance', color: '#f59e0b' },
        { id: 'repair', name: 'Needs Repair', color: '#ef4444' },
        { id: 'retired', name: 'Retired', color: '#6b7280' }
    ];

    const LOCATIONS = ['Bay 1', 'Bay 2', 'Bay 3', 'Bay 4', 'Garage', 'Storage', 'Workshop', 'Office'];

    const MAINTENANCE_TYPES = [
        { id: 'routine', name: 'Routine Service' },
        { id: 'repair', name: 'Repair' },
        { id: 'inspection', name: 'Inspection' },
        { id: 'replacement', name: 'Part Replacement' },
        { id: 'calibration', name: 'Calibration' }
    ];

    // Get equipment due for maintenance
    const getMaintenanceDue = () => {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const weekFromNow = new Date(today);
        weekFromNow.setDate(weekFromNow.getDate() + 7);
        
        return equipment.filter(e => {
            if (!e.nextMaintenance) return false;
            const maintenanceDate = new Date(e.nextMaintenance);
            return maintenanceDate <= weekFromNow && maintenanceDate >= today;
        });
    };

    // Get overdue maintenance
    const getMaintenanceOverdue = () => {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        return equipment.filter(e => {
            if (!e.nextMaintenance) return false;
            const maintenanceDate = new Date(e.nextMaintenance);
            return maintenanceDate < today;
        });
    };

    // Get filtered equipment based on active tab
    const getFilteredEquipment = () => {
        switch(activeTab) {
            case 'due': return getMaintenanceDue();
            case 'overdue': return getMaintenanceOverdue();
            default: return equipment;
        }
    };

    // Subscribe to equipment data
    useEffect(() => {
        const services = window.FirebaseServices;
        if (!services) {
            setLoading(false);
            return;
        }

        const unsubscribe = services.equipmentService.subscribeToEquipment(
            (data) => {
                setEquipment(data);
                setLoading(false);
            },
            (err) => {
                console.error('Equipment subscription error:', err);
                setError('Failed to load equipment');
                setLoading(false);
            }
        );

        return () => unsubscribe && unsubscribe();
    }, []);

    const resetForm = () => {
        setFormData({
            name: '',
            type: 'pressure_washer',
            location: '',
            serialNumber: '',
            purchaseDate: '',
            lastMaintenance: '',
            nextMaintenance: '',
            status: 'operational',
            notes: ''
        });
    };

    const handleAddEquipment = async (e) => {
        e.preventDefault();
        const services = window.FirebaseServices;
        if (!services) {
            setError('Firebase not ready');
            return;
        }

        if (!formData.name.trim()) {
            setError('Equipment name is required');
            return;
        }

        setActionLoading(true);
        try {
            const result = await services.equipmentService.addEquipment(formData);
            if (result.success) {
                setShowAddModal(false);
                resetForm();
            } else {
                setError(result.error || 'Failed to add equipment');
            }
        } catch (err) {
            setError('Failed to add equipment');
        } finally {
            setActionLoading(false);
        }
    };

    const handleEditEquipment = async (e) => {
        e.preventDefault();
        const services = window.FirebaseServices;
        if (!services || !selectedEquipment) return;

        setActionLoading(true);
        try {
            const result = await services.equipmentService.updateEquipment(selectedEquipment.id, formData);
            if (result.success) {
                setShowEditModal(false);
                setSelectedEquipment(null);
                resetForm();
            } else {
                setError(result.error || 'Failed to update equipment');
            }
        } catch (err) {
            setError('Failed to update equipment');
        } finally {
            setActionLoading(false);
        }
    };

    const handleDeleteEquipment = async (equipmentItem) => {
        if (!confirm(`Are you sure you want to delete "${equipmentItem.name}"?`)) return;
        
        const services = window.FirebaseServices;
        if (!services) return;

        setActionLoading(true);
        try {
            await services.equipmentService.deleteEquipment(equipmentItem.id);
        } catch (err) {
            setError('Failed to delete equipment');
        } finally {
            setActionLoading(false);
        }
    };

    const handleTransfer = async (e) => {
        e.preventDefault();
        const services = window.FirebaseServices;
        if (!services || !selectedEquipment) return;

        if (!transferData.toLocation) {
            setError('Please select a destination location');
            return;
        }

        setActionLoading(true);
        try {
            const result = await services.equipmentService.transferEquipment(
                selectedEquipment.id,
                selectedEquipment.location || 'Unknown',
                transferData.toLocation,
                transferData.notes
            );
            if (result.success) {
                setShowTransferModal(false);
                setSelectedEquipment(null);
                setTransferData({ toLocation: '', notes: '' });
            } else {
                setError(result.error || 'Failed to transfer equipment');
            }
        } catch (err) {
            setError('Failed to transfer equipment');
        } finally {
            setActionLoading(false);
        }
    };

    const handleLogMaintenance = async (e) => {
        e.preventDefault();
        const services = window.FirebaseServices;
        if (!services || !selectedEquipment) return;

        setActionLoading(true);
        try {
            const result = await services.equipmentService.logMaintenance(selectedEquipment.id, maintenanceData);
            if (result.success) {
                // Update next maintenance date if provided
                if (maintenanceData.nextMaintenanceDate) {
                    await services.equipmentService.updateEquipment(selectedEquipment.id, {
                        nextMaintenance: maintenanceData.nextMaintenanceDate
                    });
                }
                setShowMaintenanceModal(false);
                setSelectedEquipment(null);
                setMaintenanceData({ type: 'routine', description: '', cost: '', performedBy: '', nextMaintenanceDate: '' });
            } else {
                setError(result.error || 'Failed to log maintenance');
            }
        } catch (err) {
            setError('Failed to log maintenance');
        } finally {
            setActionLoading(false);
        }
    };

    const openTransferModal = (equipmentItem) => {
        setSelectedEquipment(equipmentItem);
        setTransferData({ toLocation: '', notes: '' });
        setShowTransferModal(true);
    };

    const openMaintenanceModal = (equipmentItem) => {
        setSelectedEquipment(equipmentItem);
        setMaintenanceData({ type: 'routine', description: '', cost: '', performedBy: '', nextMaintenanceDate: '' });
        setShowMaintenanceModal(true);
    };

    const openHistoryModal = (equipmentItem) => {
        setSelectedEquipment(equipmentItem);
        setShowHistoryModal(true);
    };

    const openEditModal = (equipmentItem) => {
        setSelectedEquipment(equipmentItem);
        setFormData({
            name: equipmentItem.name || '',
            type: equipmentItem.type || 'pressure_washer',
            location: equipmentItem.location || '',
            serialNumber: equipmentItem.serialNumber || '',
            purchaseDate: equipmentItem.purchaseDate || '',
            lastMaintenance: equipmentItem.lastMaintenance || '',
            nextMaintenance: equipmentItem.nextMaintenance || '',
            status: equipmentItem.status || 'operational',
            notes: equipmentItem.notes || ''
        });
        setShowEditModal(true);
    };

    const getStatusColor = (status) => {
        const statusOption = STATUS_OPTIONS.find(s => s.id === status);
        return statusOption?.color || '#6b7280';
    };

    const getStatusLabel = (status) => {
        const statusOption = STATUS_OPTIONS.find(s => s.id === status);
        return statusOption?.name || status;
    };

    const getTypeLabel = (type) => {
        const typeOption = EQUIPMENT_TYPES.find(t => t.id === type);
        return typeOption?.name || type;
    };

    if (loading) {
        return (
            <div className="equipment-management" style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', minHeight: '400px', flexDirection: 'column', gap: '16px', backgroundColor: theme.bg }}>
                <div style={{ width: '40px', height: '40px', border: `3px solid ${theme.border}`, borderTopColor: '#3b82f6', borderRadius: '50%', animation: 'spin 0.8s linear infinite' }}></div>
                <p style={{ color: theme.textSecondary }}>Loading Equipment...</p>
            </div>
        );
    }

    const overdueCount = getMaintenanceOverdue().length;
    const dueCount = getMaintenanceDue().length;
    const filteredEquipment = getFilteredEquipment();

    return (
        <div className="equipment-management" style={{ backgroundColor: theme.bgSecondary, minHeight: '100%' }}>
            {/* Error Banner */}
            {error && (
                <div style={{ backgroundColor: isDark ? '#450a0a' : '#fef2f2', border: `1px solid ${isDark ? '#7f1d1d' : '#fecaca'}`, padding: '12px 16px', marginBottom: '16px', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <span style={{ color: isDark ? '#fca5a5' : '#dc2626' }}>{error}</span>
                    <button onClick={() => setError(null)} style={{ background: 'none', border: 'none', color: isDark ? '#fca5a5' : '#dc2626', cursor: 'pointer' }}>{Icons.x}</button>
                </div>
            )}

            {/* Action Loading Overlay */}
            {actionLoading && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: theme.loadingOverlay, display: 'flex', justifyContent: 'center', alignItems: 'center', zIndex: 9999 }}>
                    <div style={{ width: '40px', height: '40px', border: `3px solid ${theme.border}`, borderTopColor: '#3b82f6', borderRadius: '50%', animation: 'spin 0.8s linear infinite' }}></div>
                </div>
            )}

            {/* Maintenance Alert Banner */}
            {overdueCount > 0 && (
                <div style={{ backgroundColor: isDark ? '#450a0a' : '#fef2f2', border: `1px solid ${isDark ? '#7f1d1d' : '#fecaca'}`, borderLeft: '4px solid #ef4444', padding: '12px 16px', marginBottom: '16px', display: 'flex', alignItems: 'center', gap: '12px' }}>
                    <span style={{ fontSize: '20px' }}>‚ö†Ô∏è</span>
                    <div>
                        <strong style={{ color: isDark ? '#fca5a5' : '#dc2626' }}>{overdueCount} equipment overdue for maintenance!</strong>
                        <p style={{ margin: '4px 0 0 0', fontSize: '13px', color: theme.textSecondary }}>Click "Overdue" tab to view and schedule maintenance.</p>
                    </div>
                </div>
            )}

            {/* Header with Add Button */}
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px' }}>
                <div>
                    <p style={{ color: theme.textSecondary, margin: 0 }}>Manage your garage and wash bay equipment</p>
                </div>
                <button 
                    onClick={() => { resetForm(); setShowAddModal(true); }}
                    style={{ 
                        display: 'flex', 
                        alignItems: 'center', 
                        gap: '8px', 
                        padding: '10px 20px', 
                        backgroundColor: '#3b82f6', 
                        color: 'white', 
                        border: 'none', 
                        cursor: 'pointer',
                        fontSize: '14px',
                        fontWeight: '500'
                    }}
                >
                    {Icons.plus}
                    <span>Add Equipment</span>
                </button>
            </div>

            {/* Stats Cards */}
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))', gap: '16px', marginBottom: '24px' }}>
                <div style={{ backgroundColor: theme.bg, padding: '16px', boxShadow: theme.cardShadow, border: `1px solid ${theme.border}` }}>
                    <div style={{ fontSize: '24px', fontWeight: '700', color: theme.text }}>{equipment.length}</div>
                    <div style={{ fontSize: '13px', color: theme.textSecondary }}>Total Equipment</div>
                </div>
                <div style={{ backgroundColor: theme.bg, padding: '16px', boxShadow: theme.cardShadow, border: `1px solid ${theme.border}` }}>
                    <div style={{ fontSize: '24px', fontWeight: '700', color: '#10b981' }}>{equipment.filter(e => e.status === 'operational').length}</div>
                    <div style={{ fontSize: '13px', color: theme.textSecondary }}>Operational</div>
                </div>
                <div style={{ backgroundColor: theme.bg, padding: '16px', boxShadow: theme.cardShadow, border: `1px solid ${theme.border}` }}>
                    <div style={{ fontSize: '24px', fontWeight: '700', color: '#f59e0b' }}>{dueCount}</div>
                    <div style={{ fontSize: '13px', color: theme.textSecondary }}>Due Soon</div>
                </div>
                <div style={{ backgroundColor: theme.bg, padding: '16px', boxShadow: theme.cardShadow, border: `1px solid ${theme.border}` }}>
                    <div style={{ fontSize: '24px', fontWeight: '700', color: '#ef4444' }}>{overdueCount}</div>
                    <div style={{ fontSize: '13px', color: theme.textSecondary }}>Overdue</div>
                </div>
            </div>

            {/* Tabs */}
            <div style={{ display: 'flex', gap: '0', marginBottom: '16px', borderBottom: `2px solid ${theme.border}` }}>
                <button 
                    onClick={() => setActiveTab('all')}
                    style={{ 
                        padding: '12px 20px', 
                        backgroundColor: activeTab === 'all' ? '#3b82f6' : theme.bg, 
                        color: activeTab === 'all' ? 'white' : theme.textSecondary, 
                        border: 'none', 
                        cursor: 'pointer', 
                        fontWeight: '500', 
                        fontSize: '14px' 
                    }}
                >
                    All Equipment ({equipment.length})
                </button>
                <button 
                    onClick={() => setActiveTab('due')}
                    style={{ 
                        padding: '12px 20px', 
                        backgroundColor: activeTab === 'due' ? '#f59e0b' : theme.bg, 
                        color: activeTab === 'due' ? 'white' : theme.textSecondary, 
                        border: 'none', 
                        cursor: 'pointer', 
                        fontWeight: '500', 
                        fontSize: '14px' 
                    }}
                >
                    Due for Maintenance ({dueCount})
                </button>
                <button 
                    onClick={() => setActiveTab('overdue')}
                    style={{ 
                        padding: '12px 20px', 
                        backgroundColor: activeTab === 'overdue' ? '#ef4444' : theme.bg, 
                        color: activeTab === 'overdue' ? 'white' : theme.textSecondary, 
                        border: 'none', 
                        cursor: 'pointer', 
                        fontWeight: '500', 
                        fontSize: '14px' 
                    }}
                >
                    Overdue ({overdueCount})
                </button>
            </div>

            {/* Equipment List */}
            {filteredEquipment.length === 0 ? (
                <div style={{ textAlign: 'center', padding: '60px 20px', backgroundColor: theme.bg, boxShadow: theme.cardShadow, border: `1px solid ${theme.border}` }}>
                    <div style={{ fontSize: '48px', marginBottom: '16px' }}>{activeTab === 'all' ? 'üîß' : '‚úÖ'}</div>
                    <h3 style={{ margin: '0 0 8px 0', color: theme.text }}>{activeTab === 'all' ? 'No Equipment Yet' : 'No Equipment in This Category'}</h3>
                    <p style={{ color: theme.textSecondary, marginBottom: '20px' }}>{activeTab === 'all' ? 'Add your first equipment to get started' : activeTab === 'due' ? 'No equipment due for maintenance in the next 7 days' : 'All equipment maintenance is up to date!'}</p>
                    {activeTab === 'all' && (
                        <button 
                            onClick={() => { resetForm(); setShowAddModal(true); }}
                            style={{ padding: '10px 24px', backgroundColor: '#3b82f6', color: 'white', border: 'none', cursor: 'pointer', fontWeight: '500' }}
                        >
                            Add Equipment
                        </button>
                    )}
                </div>
            ) : (
                <div style={{ backgroundColor: theme.bg, boxShadow: theme.cardShadow, border: `1px solid ${theme.border}`, overflow: 'hidden' }}>
                    <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                        <thead>
                            <tr style={{ backgroundColor: theme.bgSecondary, borderBottom: `1px solid ${theme.border}` }}>
                                <th style={{ padding: '12px 16px', textAlign: 'left', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase' }}>Equipment</th>
                                <th style={{ padding: '12px 16px', textAlign: 'left', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase' }}>Type</th>
                                <th style={{ padding: '12px 16px', textAlign: 'left', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase' }}>Location</th>
                                <th style={{ padding: '12px 16px', textAlign: 'left', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase' }}>Status</th>
                                <th style={{ padding: '12px 16px', textAlign: 'left', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase' }}>Next Maintenance</th>
                                <th style={{ padding: '12px 16px', textAlign: 'right', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase' }}>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {filteredEquipment.map((item) => {
                                const isOverdue = item.nextMaintenance && new Date(item.nextMaintenance) < new Date();
                                const isDueSoon = item.nextMaintenance && !isOverdue && new Date(item.nextMaintenance) <= new Date(Date.now() + 7*24*60*60*1000);
                                return (
                                    <tr key={item.id} style={{ borderBottom: `1px solid ${theme.border}`, backgroundColor: isOverdue ? theme.rowOverdueBg : isDueSoon ? theme.rowDueBg : theme.bg }}>
                                        <td style={{ padding: '16px' }}>
                                            <div style={{ fontWeight: '500', color: theme.text }}>{item.name}</div>
                                            {item.serialNumber && <div style={{ fontSize: '12px', color: theme.textMuted }}>SN: {item.serialNumber}</div>}
                                        </td>
                                        <td style={{ padding: '16px', color: theme.textSecondary }}>{getTypeLabel(item.type)}</td>
                                        <td style={{ padding: '16px', color: theme.textSecondary }}>{item.location || '-'}</td>
                                        <td style={{ padding: '16px' }}>
                                            <span style={{ 
                                                display: 'inline-block',
                                                padding: '4px 10px', 
                                                fontSize: '12px', 
                                                fontWeight: '500',
                                                backgroundColor: `${getStatusColor(item.status)}20`,
                                                color: getStatusColor(item.status)
                                            }}>
                                                {getStatusLabel(item.status)}
                                            </span>
                                        </td>
                                        <td style={{ padding: '16px' }}>
                                            {item.nextMaintenance ? (
                                                <span style={{ color: isOverdue ? '#ef4444' : isDueSoon ? '#f59e0b' : theme.textSecondary, fontWeight: isOverdue || isDueSoon ? '500' : '400' }}>
                                                    {item.nextMaintenance}
                                                    {isOverdue && ' ‚ö†Ô∏è'}
                                                    {isDueSoon && !isOverdue && ' ‚è∞'}
                                                </span>
                                            ) : '-'}
                                        </td>
                                        <td style={{ padding: '16px', textAlign: 'right' }}>
                                            <div style={{ display: 'flex', justifyContent: 'flex-end', gap: '6px' }}>
                                                <button 
                                                    onClick={() => openTransferModal(item)}
                                                    style={{ 
                                                        display: 'inline-flex', 
                                                        alignItems: 'center', 
                                                        justifyContent: 'center',
                                                        gap: '4px',
                                                        padding: '6px 10px', 
                                                        backgroundColor: theme.btnTransferBg, 
                                                        color: theme.btnTransferText, 
                                                        border: `1px solid ${theme.btnTransferBorder}`,
                                                        cursor: 'pointer', 
                                                        fontSize: '11px',
                                                        fontWeight: '500'
                                                    }}
                                                    title="Transfer Location"
                                                >
                                                    <span style={{ fontSize: '12px' }}>‚Üî</span> Transfer
                                                </button>
                                                <button 
                                                    onClick={() => openMaintenanceModal(item)}
                                                    style={{ 
                                                        display: 'inline-flex', 
                                                        alignItems: 'center', 
                                                        justifyContent: 'center',
                                                        gap: '4px',
                                                        padding: '6px 10px', 
                                                        backgroundColor: theme.btnMaintainBg, 
                                                        color: theme.btnMaintainText, 
                                                        border: `1px solid ${theme.btnMaintainBorder}`,
                                                        cursor: 'pointer', 
                                                        fontSize: '11px',
                                                        fontWeight: '500'
                                                    }}
                                                    title="Log Maintenance"
                                                >
                                                    <span style={{ fontSize: '12px' }}>üîß</span> Maintain
                                                </button>
                                                <button 
                                                    onClick={() => openHistoryModal(item)}
                                                    style={{ 
                                                        display: 'inline-flex', 
                                                        alignItems: 'center', 
                                                        justifyContent: 'center',
                                                        gap: '4px',
                                                        padding: '6px 10px', 
                                                        backgroundColor: theme.btnHistoryBg, 
                                                        color: theme.btnHistoryText, 
                                                        border: `1px solid ${theme.btnHistoryBorder}`,
                                                        cursor: 'pointer', 
                                                        fontSize: '11px',
                                                        fontWeight: '500'
                                                    }}
                                                    title="View History"
                                                >
                                                    <span style={{ fontSize: '12px' }}>üìã</span> History
                                                </button>
                                                <button 
                                                    onClick={() => openEditModal(item)}
                                                    style={{ 
                                                        display: 'inline-flex', 
                                                        alignItems: 'center', 
                                                        justifyContent: 'center',
                                                        padding: '6px 10px', 
                                                        backgroundColor: theme.btnEditBg, 
                                                        color: theme.btnEditText, 
                                                        border: `1px solid ${theme.btnEditBorder}`,
                                                        cursor: 'pointer', 
                                                        fontSize: '11px',
                                                        fontWeight: '500'
                                                    }}
                                                    title="Edit"
                                                >
                                                    {Icons.edit}
                                                </button>
                                                <button 
                                                    onClick={() => handleDeleteEquipment(item)}
                                                    style={{ 
                                                        display: 'inline-flex', 
                                                        alignItems: 'center', 
                                                        justifyContent: 'center',
                                                        padding: '6px 10px', 
                                                        backgroundColor: theme.btnDeleteBg, 
                                                        color: theme.btnDeleteText, 
                                                        border: `1px solid ${theme.btnDeleteBorder}`,
                                                        cursor: 'pointer', 
                                                        fontSize: '11px',
                                                        fontWeight: '500'
                                                    }}
                                                    title="Delete"
                                                >
                                                    {Icons.x}
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                );
                            })}
                        </tbody>
                    </table>
                </div>
            )}

            {/* Add Equipment Modal */}
            {showAddModal && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: theme.modalOverlay, display: 'flex', justifyContent: 'center', alignItems: 'center', zIndex: 1000 }} onClick={() => setShowAddModal(false)}>
                    <div style={{ backgroundColor: theme.bg, width: '100%', maxWidth: '500px', maxHeight: '90vh', overflow: 'auto', boxShadow: '0 4px 20px rgba(0,0,0,0.15)' }} onClick={e => e.stopPropagation()}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '16px 20px', borderBottom: `1px solid ${theme.border}`, backgroundColor: theme.bgSecondary }}>
                            <h2 style={{ margin: 0, fontSize: '18px', fontWeight: '600', color: theme.text }}>Add Equipment</h2>
                            <button onClick={() => setShowAddModal(false)} style={{ background: 'none', border: 'none', cursor: 'pointer', color: theme.textSecondary, padding: '4px' }}>{Icons.x}</button>
                        </div>
                        <form onSubmit={handleAddEquipment}>
                            <div style={{ padding: '20px', display: 'flex', flexDirection: 'column', gap: '16px' }}>
                                <div>
                                    <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: theme.text }}>Equipment Name *</label>
                                    <input 
                                        type="text" 
                                        value={formData.name}
                                        onChange={(e) => setFormData({...formData, name: e.target.value})}
                                        placeholder="e.g., Karcher HD 6/15 C"
                                        required
                                        style={{ width: '100%', padding: '10px 12px', border: `1px solid ${theme.borderLight}`, fontSize: '14px', outline: 'none', boxSizing: 'border-box', backgroundColor: theme.inputBg, color: theme.text }}
                                    />
                                </div>
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px' }}>
                                    <div>
                                        <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: theme.text }}>Type</label>
                                        <select 
                                            value={formData.type}
                                            onChange={(e) => setFormData({...formData, type: e.target.value})}
                                            style={{ width: '100%', padding: '10px 12px', border: `1px solid ${theme.borderLight}`, fontSize: '14px', outline: 'none', boxSizing: 'border-box', backgroundColor: theme.inputBg, color: theme.text }}
                                        >
                                            {EQUIPMENT_TYPES.map(type => (
                                                <option key={type.id} value={type.id}>{type.name}</option>
                                            ))}
                                        </select>
                                    </div>
                                    <div>
                                        <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: theme.text }}>Status</label>
                                        <select 
                                            value={formData.status}
                                            onChange={(e) => setFormData({...formData, status: e.target.value})}
                                            style={{ width: '100%', padding: '10px 12px', border: `1px solid ${theme.borderLight}`, fontSize: '14px', outline: 'none', boxSizing: 'border-box', backgroundColor: theme.inputBg, color: theme.text }}
                                        >
                                            {STATUS_OPTIONS.map(status => (
                                                <option key={status.id} value={status.id}>{status.name}</option>
                                            ))}
                                        </select>
                                    </div>
                                </div>
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px' }}>
                                    <div>
                                        <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: theme.text }}>Location</label>
                                        <input 
                                            type="text" 
                                            value={formData.location}
                                            onChange={(e) => setFormData({...formData, location: e.target.value})}
                                            placeholder="e.g., Bay 1"
                                            style={{ width: '100%', padding: '10px 12px', border: `1px solid ${theme.borderLight}`, fontSize: '14px', outline: 'none', boxSizing: 'border-box', backgroundColor: theme.inputBg, color: theme.text }}
                                        />
                                    </div>
                                    <div>
                                        <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: theme.text }}>Serial Number</label>
                                        <input 
                                            type="text" 
                                            value={formData.serialNumber}
                                            onChange={(e) => setFormData({...formData, serialNumber: e.target.value})}
                                            placeholder="e.g., KHD-2024-001"
                                            style={{ width: '100%', padding: '10px 12px', border: `1px solid ${theme.borderLight}`, fontSize: '14px', outline: 'none', boxSizing: 'border-box', backgroundColor: theme.inputBg, color: theme.text }}
                                        />
                                    </div>
                                </div>
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px' }}>
                                    <div>
                                        <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: theme.text }}>Purchase Date</label>
                                        <input 
                                            type="date" 
                                            value={formData.purchaseDate}
                                            onChange={(e) => setFormData({...formData, purchaseDate: e.target.value})}
                                            style={{ width: '100%', padding: '10px 12px', border: `1px solid ${theme.borderLight}`, fontSize: '14px', outline: 'none', boxSizing: 'border-box', backgroundColor: theme.inputBg, color: theme.text }}
                                        />
                                    </div>
                                    <div>
                                        <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: theme.text }}>Next Maintenance</label>
                                        <input 
                                            type="date" 
                                            value={formData.nextMaintenance}
                                            onChange={(e) => setFormData({...formData, nextMaintenance: e.target.value})}
                                            style={{ width: '100%', padding: '10px 12px', border: `1px solid ${theme.borderLight}`, fontSize: '14px', outline: 'none', boxSizing: 'border-box', backgroundColor: theme.inputBg, color: theme.text }}
                                        />
                                    </div>
                                </div>
                                <div>
                                    <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: theme.text }}>Notes</label>
                                    <textarea 
                                        value={formData.notes}
                                        onChange={(e) => setFormData({...formData, notes: e.target.value})}
                                        placeholder="Additional notes..."
                                        rows="3"
                                        style={{ width: '100%', padding: '10px 12px', border: `1px solid ${theme.borderLight}`, fontSize: '14px', outline: 'none', boxSizing: 'border-box', resize: 'vertical', fontFamily: 'inherit', backgroundColor: theme.inputBg, color: theme.text }}
                                    />
                                </div>
                            </div>
                            <div style={{ display: 'flex', justifyContent: 'flex-end', gap: '12px', padding: '16px 20px', borderTop: `1px solid ${theme.border}`, backgroundColor: theme.bgSecondary }}>
                                <button type="button" onClick={() => setShowAddModal(false)} style={{ padding: '10px 20px', backgroundColor: theme.bg, color: theme.text, border: `1px solid ${theme.borderLight}`, cursor: 'pointer', fontSize: '14px', fontWeight: '500' }}>Cancel</button>
                                <button type="submit" style={{ padding: '10px 20px', backgroundColor: '#3b82f6', color: 'white', border: 'none', cursor: 'pointer', fontSize: '14px', fontWeight: '500' }}>Add Equipment</button>
                            </div>
                        </form>
                    </div>
                </div>
            )}

            {/* Edit Equipment Modal */}
            {showEditModal && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: theme.modalOverlay, display: 'flex', justifyContent: 'center', alignItems: 'center', zIndex: 1000 }} onClick={() => setShowEditModal(false)}>
                    <div style={{ backgroundColor: theme.bg, width: '100%', maxWidth: '500px', maxHeight: '90vh', overflow: 'auto', boxShadow: '0 4px 20px rgba(0,0,0,0.15)' }} onClick={e => e.stopPropagation()}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '16px 20px', borderBottom: `1px solid ${theme.border}`, backgroundColor: theme.bgSecondary }}>
                            <h2 style={{ margin: 0, fontSize: '18px', fontWeight: '600', color: theme.text }}>Edit Equipment</h2>
                            <button onClick={() => setShowEditModal(false)} style={{ background: 'none', border: 'none', cursor: 'pointer', color: theme.textSecondary, padding: '4px' }}>{Icons.x}</button>
                        </div>
                        <form onSubmit={handleEditEquipment}>
                            <div style={{ padding: '20px', display: 'flex', flexDirection: 'column', gap: '16px' }}>
                                <div>
                                    <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: theme.text }}>Equipment Name *</label>
                                    <input 
                                        type="text" 
                                        value={formData.name}
                                        onChange={(e) => setFormData({...formData, name: e.target.value})}
                                        required
                                        style={{ width: '100%', padding: '10px 12px', border: `1px solid ${theme.borderLight}`, fontSize: '14px', outline: 'none', boxSizing: 'border-box', backgroundColor: theme.inputBg, color: theme.text }}
                                    />
                                </div>
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px' }}>
                                    <div>
                                        <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: theme.text }}>Type</label>
                                        <select 
                                            value={formData.type}
                                            onChange={(e) => setFormData({...formData, type: e.target.value})}
                                            style={{ width: '100%', padding: '10px 12px', border: `1px solid ${theme.borderLight}`, fontSize: '14px', outline: 'none', boxSizing: 'border-box', backgroundColor: theme.inputBg, color: theme.text }}
                                        >
                                            {EQUIPMENT_TYPES.map(type => (
                                                <option key={type.id} value={type.id}>{type.name}</option>
                                            ))}
                                        </select>
                                    </div>
                                    <div>
                                        <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: theme.text }}>Status</label>
                                        <select 
                                            value={formData.status}
                                            onChange={(e) => setFormData({...formData, status: e.target.value})}
                                            style={{ width: '100%', padding: '10px 12px', border: `1px solid ${theme.borderLight}`, fontSize: '14px', outline: 'none', boxSizing: 'border-box', backgroundColor: theme.inputBg, color: theme.text }}
                                        >
                                            {STATUS_OPTIONS.map(status => (
                                                <option key={status.id} value={status.id}>{status.name}</option>
                                            ))}
                                        </select>
                                    </div>
                                </div>
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px' }}>
                                    <div>
                                        <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: theme.text }}>Location</label>
                                        <input 
                                            type="text" 
                                            value={formData.location}
                                            onChange={(e) => setFormData({...formData, location: e.target.value})}
                                            style={{ width: '100%', padding: '10px 12px', border: `1px solid ${theme.borderLight}`, fontSize: '14px', outline: 'none', boxSizing: 'border-box', backgroundColor: theme.inputBg, color: theme.text }}
                                        />
                                    </div>
                                    <div>
                                        <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: theme.text }}>Serial Number</label>
                                        <input 
                                            type="text" 
                                            value={formData.serialNumber}
                                            onChange={(e) => setFormData({...formData, serialNumber: e.target.value})}
                                            style={{ width: '100%', padding: '10px 12px', border: `1px solid ${theme.borderLight}`, fontSize: '14px', outline: 'none', boxSizing: 'border-box', backgroundColor: theme.inputBg, color: theme.text }}
                                        />
                                    </div>
                                </div>
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px' }}>
                                    <div>
                                        <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: theme.text }}>Purchase Date</label>
                                        <input 
                                            type="date" 
                                            value={formData.purchaseDate}
                                            onChange={(e) => setFormData({...formData, purchaseDate: e.target.value})}
                                            style={{ width: '100%', padding: '10px 12px', border: `1px solid ${theme.borderLight}`, fontSize: '14px', outline: 'none', boxSizing: 'border-box', backgroundColor: theme.inputBg, color: theme.text }}
                                        />
                                    </div>
                                    <div>
                                        <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: theme.text }}>Next Maintenance</label>
                                        <input 
                                            type="date" 
                                            value={formData.nextMaintenance}
                                            onChange={(e) => setFormData({...formData, nextMaintenance: e.target.value})}
                                            style={{ width: '100%', padding: '10px 12px', border: `1px solid ${theme.borderLight}`, fontSize: '14px', outline: 'none', boxSizing: 'border-box', backgroundColor: theme.inputBg, color: theme.text }}
                                        />
                                    </div>
                                </div>
                                <div>
                                    <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: theme.text }}>Notes</label>
                                    <textarea 
                                        value={formData.notes}
                                        onChange={(e) => setFormData({...formData, notes: e.target.value})}
                                        rows="3"
                                        style={{ width: '100%', padding: '10px 12px', border: `1px solid ${theme.borderLight}`, fontSize: '14px', outline: 'none', boxSizing: 'border-box', resize: 'vertical', fontFamily: 'inherit', backgroundColor: theme.inputBg, color: theme.text }}
                                    />
                                </div>
                            </div>
                            <div style={{ display: 'flex', justifyContent: 'flex-end', gap: '12px', padding: '16px 20px', borderTop: `1px solid ${theme.border}`, backgroundColor: theme.bgSecondary }}>
                                <button type="button" onClick={() => setShowEditModal(false)} style={{ padding: '10px 20px', backgroundColor: theme.bg, color: theme.text, border: `1px solid ${theme.borderLight}`, cursor: 'pointer', fontSize: '14px', fontWeight: '500' }}>Cancel</button>
                                <button type="submit" style={{ padding: '10px 20px', backgroundColor: '#3b82f6', color: 'white', border: 'none', cursor: 'pointer', fontSize: '14px', fontWeight: '500' }}>Save Changes</button>
                            </div>
                        </form>
                    </div>
                </div>
            )}

            {/* Transfer Equipment Modal */}
            {showTransferModal && selectedEquipment && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: theme.modalOverlay, display: 'flex', justifyContent: 'center', alignItems: 'center', zIndex: 1000 }} onClick={() => setShowTransferModal(false)}>
                    <div style={{ backgroundColor: theme.bg, width: '100%', maxWidth: '400px', boxShadow: '0 4px 20px rgba(0,0,0,0.15)' }} onClick={e => e.stopPropagation()}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '16px 20px', borderBottom: `1px solid ${theme.border}`, backgroundColor: theme.bgSecondary }}>
                            <h2 style={{ margin: 0, fontSize: '18px', fontWeight: '600', color: theme.text }}>Transfer Equipment</h2>
                            <button onClick={() => setShowTransferModal(false)} style={{ background: 'none', border: 'none', cursor: 'pointer', color: theme.textSecondary, padding: '4px' }}>{Icons.x}</button>
                        </div>
                        <form onSubmit={handleTransfer}>
                            <div style={{ padding: '20px', display: 'flex', flexDirection: 'column', gap: '16px' }}>
                                <div style={{ padding: '12px', backgroundColor: theme.bgTertiary, border: `1px solid ${theme.border}` }}>
                                    <div style={{ fontWeight: '500', color: theme.text }}>{selectedEquipment.name}</div>
                                    <div style={{ fontSize: '13px', color: theme.textSecondary }}>Current Location: <strong>{selectedEquipment.location || 'Not Set'}</strong></div>
                                </div>
                                <div>
                                    <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: theme.text }}>Transfer To *</label>
                                    <select 
                                        value={transferData.toLocation}
                                        onChange={(e) => setTransferData({...transferData, toLocation: e.target.value})}
                                        required
                                        style={{ width: '100%', padding: '10px 12px', border: `1px solid ${theme.borderLight}`, fontSize: '14px', outline: 'none', boxSizing: 'border-box', backgroundColor: theme.inputBg, color: theme.text }}
                                    >
                                        <option value="">Select Location</option>
                                        {LOCATIONS.filter(loc => loc !== selectedEquipment.location).map(loc => (
                                            <option key={loc} value={loc}>{loc}</option>
                                        ))}
                                    </select>
                                </div>
                                <div>
                                    <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: theme.text }}>Transfer Notes</label>
                                    <textarea 
                                        value={transferData.notes}
                                        onChange={(e) => setTransferData({...transferData, notes: e.target.value})}
                                        placeholder="Reason for transfer..."
                                        rows="2"
                                        style={{ width: '100%', padding: '10px 12px', border: `1px solid ${theme.borderLight}`, fontSize: '14px', outline: 'none', boxSizing: 'border-box', resize: 'vertical', fontFamily: 'inherit', backgroundColor: theme.inputBg, color: theme.text }}
                                    />
                                </div>
                            </div>
                            <div style={{ display: 'flex', justifyContent: 'flex-end', gap: '12px', padding: '16px 20px', borderTop: `1px solid ${theme.border}`, backgroundColor: theme.bgSecondary }}>
                                <button type="button" onClick={() => setShowTransferModal(false)} style={{ padding: '10px 20px', backgroundColor: theme.bg, color: theme.text, border: `1px solid ${theme.borderLight}`, cursor: 'pointer', fontSize: '14px', fontWeight: '500' }}>Cancel</button>
                                <button type="submit" style={{ padding: '10px 20px', backgroundColor: '#8b5cf6', color: 'white', border: 'none', cursor: 'pointer', fontSize: '14px', fontWeight: '500' }}>Transfer</button>
                            </div>
                        </form>
                    </div>
                </div>
            )}

            {/* Log Maintenance Modal */}
            {showMaintenanceModal && selectedEquipment && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: theme.modalOverlay, display: 'flex', justifyContent: 'center', alignItems: 'center', zIndex: 1000 }} onClick={() => setShowMaintenanceModal(false)}>
                    <div style={{ backgroundColor: theme.bg, width: '100%', maxWidth: '500px', maxHeight: '90vh', overflow: 'auto', boxShadow: '0 4px 20px rgba(0,0,0,0.15)' }} onClick={e => e.stopPropagation()}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '16px 20px', borderBottom: `1px solid ${theme.border}`, backgroundColor: theme.bgSecondary }}>
                            <h2 style={{ margin: 0, fontSize: '18px', fontWeight: '600', color: theme.text }}>Log Maintenance</h2>
                            <button onClick={() => setShowMaintenanceModal(false)} style={{ background: 'none', border: 'none', cursor: 'pointer', color: theme.textSecondary, padding: '4px' }}>{Icons.x}</button>
                        </div>
                        <form onSubmit={handleLogMaintenance}>
                            <div style={{ padding: '20px', display: 'flex', flexDirection: 'column', gap: '16px' }}>
                                <div style={{ padding: '12px', backgroundColor: theme.bgTertiary, border: `1px solid ${theme.border}` }}>
                                    <div style={{ fontWeight: '500', color: theme.text }}>{selectedEquipment.name}</div>
                                    <div style={{ fontSize: '13px', color: theme.textSecondary }}>Last Maintenance: <strong>{selectedEquipment.lastMaintenance || 'Never'}</strong></div>
                                </div>
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px' }}>
                                    <div>
                                        <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: theme.text }}>Maintenance Type *</label>
                                        <select 
                                            value={maintenanceData.type}
                                            onChange={(e) => setMaintenanceData({...maintenanceData, type: e.target.value})}
                                            required
                                            style={{ width: '100%', padding: '10px 12px', border: `1px solid ${theme.borderLight}`, fontSize: '14px', outline: 'none', boxSizing: 'border-box', backgroundColor: theme.inputBg, color: theme.text }}
                                        >
                                            {MAINTENANCE_TYPES.map(type => (
                                                <option key={type.id} value={type.id}>{type.name}</option>
                                            ))}
                                        </select>
                                    </div>
                                    <div>
                                        <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: theme.text }}>Cost (R)</label>
                                        <input 
                                            type="number" 
                                            value={maintenanceData.cost}
                                            onChange={(e) => setMaintenanceData({...maintenanceData, cost: e.target.value})}
                                            placeholder="0.00"
                                            step="0.01"
                                            style={{ width: '100%', padding: '10px 12px', border: `1px solid ${theme.borderLight}`, fontSize: '14px', outline: 'none', boxSizing: 'border-box', backgroundColor: theme.inputBg, color: theme.text }}
                                        />
                                    </div>
                                </div>
                                <div>
                                    <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: theme.text }}>Description *</label>
                                    <textarea 
                                        value={maintenanceData.description}
                                        onChange={(e) => setMaintenanceData({...maintenanceData, description: e.target.value})}
                                        placeholder="Describe the maintenance performed..."
                                        rows="3"
                                        required
                                        style={{ width: '100%', padding: '10px 12px', border: `1px solid ${theme.borderLight}`, fontSize: '14px', outline: 'none', boxSizing: 'border-box', resize: 'vertical', fontFamily: 'inherit', backgroundColor: theme.inputBg, color: theme.text }}
                                    />
                                </div>
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px' }}>
                                    <div>
                                        <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: theme.text }}>Performed By</label>
                                        <input 
                                            type="text" 
                                            value={maintenanceData.performedBy}
                                            onChange={(e) => setMaintenanceData({...maintenanceData, performedBy: e.target.value})}
                                            placeholder="Technician name"
                                            style={{ width: '100%', padding: '10px 12px', border: `1px solid ${theme.borderLight}`, fontSize: '14px', outline: 'none', boxSizing: 'border-box', backgroundColor: theme.inputBg, color: theme.text }}
                                        />
                                    </div>
                                    <div>
                                        <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: theme.text }}>Next Maintenance Date</label>
                                        <input 
                                            type="date" 
                                            value={maintenanceData.nextMaintenanceDate}
                                            onChange={(e) => setMaintenanceData({...maintenanceData, nextMaintenanceDate: e.target.value})}
                                            style={{ width: '100%', padding: '10px 12px', border: `1px solid ${theme.borderLight}`, fontSize: '14px', outline: 'none', boxSizing: 'border-box', backgroundColor: theme.inputBg, color: theme.text }}
                                        />
                                    </div>
                                </div>
                            </div>
                            <div style={{ display: 'flex', justifyContent: 'flex-end', gap: '12px', padding: '16px 20px', borderTop: `1px solid ${theme.border}`, backgroundColor: theme.bgSecondary }}>
                                <button type="button" onClick={() => setShowMaintenanceModal(false)} style={{ padding: '10px 20px', backgroundColor: theme.bg, color: theme.text, border: `1px solid ${theme.borderLight}`, cursor: 'pointer', fontSize: '14px', fontWeight: '500' }}>Cancel</button>
                                <button type="submit" style={{ padding: '10px 20px', backgroundColor: '#10b981', color: 'white', border: 'none', cursor: 'pointer', fontSize: '14px', fontWeight: '500' }}>Log Maintenance</button>
                            </div>
                        </form>
                    </div>
                </div>
            )}

            {/* Equipment History Modal */}
            {showHistoryModal && selectedEquipment && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: theme.modalOverlay, display: 'flex', justifyContent: 'center', alignItems: 'center', zIndex: 1000 }} onClick={() => setShowHistoryModal(false)}>
                    <div style={{ backgroundColor: theme.bg, width: '100%', maxWidth: '600px', maxHeight: '90vh', overflow: 'auto', boxShadow: '0 4px 20px rgba(0,0,0,0.15)' }} onClick={e => e.stopPropagation()}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '16px 20px', borderBottom: `1px solid ${theme.border}`, backgroundColor: theme.bgSecondary }}>
                            <h2 style={{ margin: 0, fontSize: '18px', fontWeight: '600', color: theme.text }}>Equipment History</h2>
                            <button onClick={() => setShowHistoryModal(false)} style={{ background: 'none', border: 'none', cursor: 'pointer', color: theme.textSecondary, padding: '4px' }}>{Icons.x}</button>
                        </div>
                        <div style={{ padding: '20px' }}>
                            <div style={{ padding: '12px', backgroundColor: theme.bgTertiary, border: `1px solid ${theme.border}`, marginBottom: '20px' }}>
                                <div style={{ fontWeight: '500', color: theme.text }}>{selectedEquipment.name}</div>
                                <div style={{ fontSize: '13px', color: theme.textSecondary }}>Current Location: {selectedEquipment.location || 'Not Set'} | Status: {getStatusLabel(selectedEquipment.status)}</div>
                            </div>

                            {/* Transfer History */}
                            <div style={{ marginBottom: '24px' }}>
                                <h3 style={{ fontSize: '14px', fontWeight: '600', color: theme.text, marginBottom: '12px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                                    <span>‚ÜîÔ∏è</span> Transfer History
                                </h3>
                                {(!selectedEquipment.transferHistory || selectedEquipment.transferHistory.length === 0) ? (
                                    <div style={{ padding: '16px', backgroundColor: theme.bgSecondary, border: `1px solid ${theme.border}`, color: theme.textSecondary, fontSize: '13px', textAlign: 'center' }}>
                                        No transfer history available
                                    </div>
                                ) : (
                                    <div style={{ border: `1px solid ${theme.border}` }}>
                                        {selectedEquipment.transferHistory.slice().reverse().map((transfer, idx) => (
                                            <div key={idx} style={{ padding: '12px 16px', borderBottom: idx < selectedEquipment.transferHistory.length - 1 ? `1px solid ${theme.border}` : 'none', backgroundColor: idx % 2 === 0 ? theme.bg : theme.bgSecondary }}>
                                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '4px' }}>
                                                    <span style={{ fontWeight: '500', color: theme.text }}>{transfer.fromLocation} ‚Üí {transfer.toLocation}</span>
                                                    <span style={{ fontSize: '12px', color: theme.textMuted }}>{transfer.date}</span>
                                                </div>
                                                {transfer.notes && <div style={{ fontSize: '13px', color: theme.textSecondary }}>{transfer.notes}</div>}
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>

                            {/* Maintenance History */}
                            <div>
                                <h3 style={{ fontSize: '14px', fontWeight: '600', color: theme.text, marginBottom: '12px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                                    <span>üîß</span> Maintenance History
                                </h3>
                                {(!selectedEquipment.maintenanceHistory || selectedEquipment.maintenanceHistory.length === 0) ? (
                                    <div style={{ padding: '16px', backgroundColor: theme.bgSecondary, border: `1px solid ${theme.border}`, color: theme.textSecondary, fontSize: '13px', textAlign: 'center' }}>
                                        No maintenance history available
                                    </div>
                                ) : (
                                    <div style={{ border: `1px solid ${theme.border}` }}>
                                        {selectedEquipment.maintenanceHistory.slice().reverse().map((maintenance, idx) => (
                                            <div key={idx} style={{ padding: '12px 16px', borderBottom: idx < selectedEquipment.maintenanceHistory.length - 1 ? `1px solid ${theme.border}` : 'none', backgroundColor: idx % 2 === 0 ? theme.bg : theme.bgSecondary }}>
                                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '4px' }}>
                                                    <span style={{ fontWeight: '500', color: theme.text, textTransform: 'capitalize' }}>{maintenance.type}</span>
                                                    <span style={{ fontSize: '12px', color: theme.textMuted }}>{maintenance.date}</span>
                                                </div>
                                                <div style={{ fontSize: '13px', color: theme.textSecondary, marginBottom: '4px' }}>{maintenance.description}</div>
                                                <div style={{ display: 'flex', gap: '16px', fontSize: '12px', color: theme.textMuted }}>
                                                    {maintenance.performedBy && <span>By: {maintenance.performedBy}</span>}
                                                    {maintenance.cost && <span>Cost: KSh {parseFloat(maintenance.cost).toFixed(2)}</span>}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                        <div style={{ display: 'flex', justifyContent: 'flex-end', padding: '16px 20px', borderTop: `1px solid ${theme.border}`, backgroundColor: theme.bgSecondary }}>
                            <button onClick={() => setShowHistoryModal(false)} style={{ padding: '10px 20px', backgroundColor: '#3b82f6', color: 'white', border: 'none', cursor: 'pointer', fontSize: '14px', fontWeight: '500' }}>Close</button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}

// Fleet Accounts Management Component
function FleetAccounts() {
    const [accounts, setAccounts] = useState([]);
    const [loading, setLoading] = useState(true);
    const [activeTab, setActiveTab] = useState('accounts');
    const [searchQuery, setSearchQuery] = useState('');
    const [statusFilter, setStatusFilter] = useState('all');
    const [showAddModal, setShowAddModal] = useState(false);
    const [showEditModal, setShowEditModal] = useState(false);
    const [showViewModal, setShowViewModal] = useState(false);
    const [showVehicleModal, setShowVehicleModal] = useState(false);
    const [showContactModal, setShowContactModal] = useState(false);
    const [showTopUpModal, setShowTopUpModal] = useState(false);
    const [showExpenditureModal, setShowExpenditureModal] = useState(false);
    const [showReceiptModal, setShowReceiptModal] = useState(false);
    const [editingExpenditure, setEditingExpenditure] = useState(null);
    const [selectedAccount, setSelectedAccount] = useState(null);
    const [actionLoading, setActionLoading] = useState(false);
    const [successMessage, setSuccessMessage] = useState(null);
    const [error, setError] = useState(null);
    const [stats, setStats] = useState({ total: 0, active: 0, suspended: 0, totalVehicles: 0, totalBalance: 0, totalSpent: 0, totalServices: 0, totalExpenditures: 0 });

    const [accountForm, setAccountForm] = useState({
        companyName: '', contactPerson: '', phone: '', email: '', address: '',
        paymentTerms: 'prepaid', creditLimit: 0, discount: 0, balance: 0, notes: ''
    });
    const [vehicleForm, setVehicleForm] = useState({
        plateNumber: '', make: '', model: '', color: '', vehicleType: 'Sedan', driverName: '', driverPhone: ''
    });
    const [contactForm, setContactForm] = useState({
        name: '', phone: '', email: '', role: 'Driver', canAuthorize: false
    });
    const [topUpAmount, setTopUpAmount] = useState('');
    const [topUpNote, setTopUpNote] = useState('');
    const [expenditureForm, setExpenditureForm] = useState({
        description: '', category: 'Fuel', amount: '', date: new Date().toISOString().split('T')[0], note: '', vehicle: ''
    });

    const [isDark, setIsDark] = useState(document.documentElement.getAttribute('data-theme') === 'dark');

    useEffect(() => {
        const observer = new MutationObserver(() => {
            setIsDark(document.documentElement.getAttribute('data-theme') === 'dark');
        });
        observer.observe(document.documentElement, { attributes: true });
        return () => observer.disconnect();
    }, []);

    const theme = {
        bg: isDark ? '#1e293b' : 'white',
        bgSecondary: isDark ? '#0f172a' : '#f8fafc',
        bgTertiary: isDark ? '#334155' : '#f1f5f9',
        text: isDark ? '#f1f5f9' : '#1e293b',
        textSecondary: isDark ? '#94a3b8' : '#64748b',
        border: isDark ? '#334155' : '#e2e8f0',
        inputBg: isDark ? '#1e293b' : 'white'
    };

    const formatCurrency = (amount) => `KSH ${(amount || 0).toLocaleString()}`;

    useEffect(() => {
        if (successMessage) {
            const timer = setTimeout(() => setSuccessMessage(null), 3000);
            return () => clearTimeout(timer);
        }
    }, [successMessage]);

    // Load fleet accounts
    useEffect(() => {
        let unsub;
        const init = async () => {
            let services = window.FirebaseServices;
            let attempts = 0;
            while (!services && attempts < 50) {
                await new Promise(r => setTimeout(r, 100));
                services = window.FirebaseServices;
                attempts++;
            }
            if (services?.fleetService) {
                unsub = services.fleetService.subscribeToAccounts((data) => {
                    setAccounts(data);
                    setStats(services.fleetService.getStats(data));
                    setLoading(false);
                });
            } else {
                setLoading(false);
            }
        };
        init();
        return () => unsub && unsub();
    }, []);

    const filteredAccounts = accounts.filter(acc => {
        const matchesSearch = acc.companyName?.toLowerCase().includes(searchQuery.toLowerCase()) ||
            acc.accountNumber?.toLowerCase().includes(searchQuery.toLowerCase()) ||
            acc.contactPerson?.toLowerCase().includes(searchQuery.toLowerCase());
        const matchesStatus = statusFilter === 'all' || acc.status === statusFilter;
        return matchesSearch && matchesStatus;
    });

    const resetAccountForm = () => setAccountForm({
        companyName: '', contactPerson: '', phone: '', email: '', address: '',
        paymentTerms: 'prepaid', creditLimit: 0, discount: 0, balance: 0, notes: ''
    });

    const handleAddAccount = async () => {
        if (!accountForm.companyName || !accountForm.phone) {
            setError('Company name and phone are required');
            return;
        }
        setActionLoading(true);
        const services = window.FirebaseServices;
        const result = await services.fleetService.addAccount(accountForm);
        if (result.success) {
            setSuccessMessage(`Fleet account ${result.accountNumber} created successfully`);
            setShowAddModal(false);
            resetAccountForm();
        } else {
            setError(result.error);
        }
        setActionLoading(false);
    };

    const handleEditAccount = async () => {
        if (!selectedAccount) return;
        setActionLoading(true);
        const services = window.FirebaseServices;
        const result = await services.fleetService.updateAccount(selectedAccount.id, accountForm);
        if (result.success) {
            setSuccessMessage('Account updated successfully');
            setShowEditModal(false);
            setSelectedAccount(null);
        } else {
            setError(result.error);
        }
        setActionLoading(false);
    };

    const handleDeleteAccount = async (account) => {
        if (!confirm(`Delete fleet account "${account.companyName}"? This cannot be undone.`)) return;
        const services = window.FirebaseServices;
        const result = await services.fleetService.deleteAccount(account.id);
        if (result.success) {
            setSuccessMessage('Account deleted');
        } else {
            setError(result.error);
        }
    };

    const handleAddVehicle = async () => {
        if (!vehicleForm.plateNumber) {
            setError('Plate number is required');
            return;
        }
        setActionLoading(true);
        const services = window.FirebaseServices;
        const result = await services.fleetService.addVehicle(selectedAccount.id, vehicleForm);
        if (result.success) {
            setSuccessMessage('Vehicle added successfully');
            setShowVehicleModal(false);
            setVehicleForm({ plateNumber: '', make: '', model: '', color: '', vehicleType: 'Sedan', driverName: '', driverPhone: '' });
            // Refresh selected account
            const accResult = await services.fleetService.getAccount(selectedAccount.id);
            if (accResult.success) setSelectedAccount(accResult.data);
        } else {
            setError(result.error);
        }
        setActionLoading(false);
    };

    const handleRemoveVehicle = async (vehicleId) => {
        if (!confirm('Remove this vehicle from the fleet?')) return;
        const services = window.FirebaseServices;
        const result = await services.fleetService.removeVehicle(selectedAccount.id, vehicleId);
        if (result.success) {
            setSuccessMessage('Vehicle removed');
            const accResult = await services.fleetService.getAccount(selectedAccount.id);
            if (accResult.success) setSelectedAccount(accResult.data);
        } else {
            setError(result.error);
        }
    };

    const handleAddContact = async () => {
        if (!contactForm.name || !contactForm.phone) {
            setError('Name and phone are required');
            return;
        }
        setActionLoading(true);
        const services = window.FirebaseServices;
        const result = await services.fleetService.addContact(selectedAccount.id, contactForm);
        if (result.success) {
            setSuccessMessage('Contact added');
            setShowContactModal(false);
            setContactForm({ name: '', phone: '', email: '', role: 'Driver', canAuthorize: false });
            const accResult = await services.fleetService.getAccount(selectedAccount.id);
            if (accResult.success) setSelectedAccount(accResult.data);
        } else {
            setError(result.error);
        }
        setActionLoading(false);
    };

    const handleRemoveContact = async (contactId) => {
        if (!confirm('Remove this contact?')) return;
        const services = window.FirebaseServices;
        const result = await services.fleetService.removeContact(selectedAccount.id, contactId);
        if (result.success) {
            setSuccessMessage('Contact removed');
            const accResult = await services.fleetService.getAccount(selectedAccount.id);
            if (accResult.success) setSelectedAccount(accResult.data);
        } else {
            setError(result.error);
        }
    };

    const handleTopUp = async () => {
        if (!topUpAmount || Number(topUpAmount) <= 0) {
            setError('Enter a valid amount');
            return;
        }
        setActionLoading(true);
        const services = window.FirebaseServices;
        const result = await services.fleetService.addBalance(selectedAccount.id, Number(topUpAmount), topUpNote);
        if (result.success) {
            setSuccessMessage(`Balance topped up. New balance: ${formatCurrency(result.newBalance)}`);
            setShowTopUpModal(false);
            setTopUpAmount('');
            setTopUpNote('');
            const accResult = await services.fleetService.getAccount(selectedAccount.id);
            if (accResult.success) setSelectedAccount(accResult.data);
        } else {
            setError(result.error);
        }
        setActionLoading(false);
    };

    // Expenditure handlers
    const resetExpenditureForm = () => setExpenditureForm({
        description: '', category: 'Fuel', amount: '', date: new Date().toISOString().split('T')[0], note: '', vehicle: ''
    });

    const handleAddExpenditure = async () => {
        if (!expenditureForm.description || !expenditureForm.amount) {
            setError('Description and amount are required');
            return;
        }
        setActionLoading(true);
        const services = window.FirebaseServices;
        const result = await services.fleetService.addExpenditure(selectedAccount.id, expenditureForm);
        if (result.success) {
            setSuccessMessage('Expenditure added successfully');
            setShowExpenditureModal(false);
            resetExpenditureForm();
            const accResult = await services.fleetService.getAccount(selectedAccount.id);
            if (accResult.success) setSelectedAccount(accResult.data);
        } else {
            setError(result.error);
        }
        setActionLoading(false);
    };

    const handleUpdateExpenditure = async () => {
        if (!expenditureForm.description || !expenditureForm.amount) {
            setError('Description and amount are required');
            return;
        }
        setActionLoading(true);
        const services = window.FirebaseServices;
        const result = await services.fleetService.updateExpenditure(selectedAccount.id, editingExpenditure.id, expenditureForm);
        if (result.success) {
            setSuccessMessage('Expenditure updated');
            setShowExpenditureModal(false);
            setEditingExpenditure(null);
            resetExpenditureForm();
            const accResult = await services.fleetService.getAccount(selectedAccount.id);
            if (accResult.success) setSelectedAccount(accResult.data);
        } else {
            setError(result.error);
        }
        setActionLoading(false);
    };

    const handleDeleteExpenditure = async (expId) => {
        if (!confirm('Delete this expenditure?')) return;
        const services = window.FirebaseServices;
        const result = await services.fleetService.deleteExpenditure(selectedAccount.id, expId);
        if (result.success) {
            setSuccessMessage('Expenditure deleted');
            const accResult = await services.fleetService.getAccount(selectedAccount.id);
            if (accResult.success) setSelectedAccount(accResult.data);
        } else {
            setError(result.error);
        }
    };

    const openEditExpenditure = (exp) => {
        setEditingExpenditure(exp);
        setExpenditureForm({
            description: exp.description || '',
            category: exp.category || 'Fuel',
            amount: exp.amount || '',
            date: exp.date || new Date().toISOString().split('T')[0],
            note: exp.note || '',
            vehicle: exp.vehicle || ''
        });
        setShowExpenditureModal(true);
    };

    // Print receipt/invoice function
    const printReceipt = (account, period = 'all') => {
        const now = new Date();
        let filteredTransactions = account.transactions || [];
        let filteredExpenditures = account.expenditures || [];
        let periodLabel = 'All Time';

        if (period === 'month') {
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            filteredTransactions = filteredTransactions.filter(t => new Date(t.date) >= monthStart);
            filteredExpenditures = filteredExpenditures.filter(e => new Date(e.date) >= monthStart);
            periodLabel = now.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        } else if (period === 'week') {
            const weekStart = new Date(now);
            weekStart.setDate(now.getDate() - 7);
            filteredTransactions = filteredTransactions.filter(t => new Date(t.date) >= weekStart);
            filteredExpenditures = filteredExpenditures.filter(e => new Date(e.date) >= weekStart);
            periodLabel = 'Last 7 Days';
        }

        const totalCredits = filteredTransactions.filter(t => t.type === 'credit').reduce((s, t) => s + (t.amount || 0), 0);
        const totalDebits = filteredTransactions.filter(t => t.type === 'debit').reduce((s, t) => s + (t.amount || 0), 0);
        const totalExp = filteredExpenditures.reduce((s, e) => s + (e.amount || 0), 0);

        const printContent = `
<!DOCTYPE html>
<html>
<head>
    <title>Fleet Account Statement - ${account.companyName}</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Arial, sans-serif; font-size: 12px; color: #1e293b; line-height: 1.5; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: flex-start; padding-bottom: 20px; border-bottom: 2px solid #1e293b; margin-bottom: 20px; }
        .logo { font-size: 24px; font-weight: 800; color: #10b981; }
        .logo span { color: #1e293b; }
        .doc-info { text-align: right; }
        .doc-title { font-size: 18px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
        .account-section { display: flex; justify-content: space-between; margin-bottom: 24px; }
        .account-box { background: #f8fafc; border: 1px solid #e2e8f0; padding: 16px; width: 48%; }
        .account-box h4 { font-size: 10px; text-transform: uppercase; color: #64748b; margin-bottom: 8px; font-weight: 700; letter-spacing: 0.5px; }
        .account-box p { margin-bottom: 4px; }
        .summary-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 24px; }
        .summary-card { background: #f8fafc; border: 1px solid #e2e8f0; padding: 14px; text-align: center; }
        .summary-card .value { font-size: 20px; font-weight: 800; }
        .summary-card .label { font-size: 9px; text-transform: uppercase; color: #64748b; margin-top: 4px; }
        .green { color: #10b981; }
        .red { color: #ef4444; }
        .blue { color: #3b82f6; }
        .purple { color: #8b5cf6; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th { background: #1e293b; color: white; padding: 10px 12px; text-align: left; font-size: 10px; text-transform: uppercase; font-weight: 700; }
        td { padding: 10px 12px; border-bottom: 1px solid #e2e8f0; }
        tr:nth-child(even) { background: #f8fafc; }
        .section-title { font-size: 14px; font-weight: 700; margin: 20px 0 12px; padding-bottom: 6px; border-bottom: 1px solid #e2e8f0; }
        .text-right { text-align: right; }
        .text-center { text-align: center; }
        .footer { margin-top: 30px; padding-top: 20px; border-top: 2px solid #1e293b; text-align: center; font-size: 11px; color: #64748b; }
        .totals-box { background: #1e293b; color: white; padding: 16px; margin-top: 20px; display: flex; justify-content: space-between; }
        .totals-box .item { text-align: center; }
        .totals-box .val { font-size: 18px; font-weight: 700; }
        .totals-box .lbl { font-size: 9px; text-transform: uppercase; opacity: 0.8; }
        @media print { body { padding: 0; } }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <div class="logo">Eco<span>Spark</span></div>
            <div style="font-size: 11px; color: #64748b; margin-top: 4px;">Professional Car Wash Services</div>
        </div>
        <div class="doc-info">
            <div class="doc-title">Fleet Account Statement</div>
            <div style="margin-top: 8px;">Date: ${now.toLocaleDateString()}</div>
            <div>Period: ${periodLabel}</div>
            <div style="font-family: monospace; margin-top: 4px;">${account.accountNumber}</div>
        </div>
    </div>

    <div class="account-section">
        <div class="account-box">
            <h4>Account Details</h4>
            <p><strong>${account.companyName}</strong></p>
            <p>${account.contactPerson || ''}</p>
            <p>${account.phone}</p>
            <p>${account.email || ''}</p>
            <p>${account.address || ''}</p>
        </div>
        <div class="account-box">
            <h4>Account Summary</h4>
            <p>Payment Terms: <strong>${(account.paymentTerms || 'prepaid').toUpperCase()}</strong></p>
            <p>Credit Limit: <strong>KSH ${(account.creditLimit || 0).toLocaleString()}</strong></p>
            <p>Discount Rate: <strong>${account.discount || 0}%</strong></p>
            <p>Status: <strong style="color: ${account.status === 'active' ? '#10b981' : '#ef4444'}">${(account.status || 'active').toUpperCase()}</strong></p>
            <p>Total Vehicles: <strong>${account.vehicles?.length || 0}</strong></p>
        </div>
    </div>

    <div class="summary-grid">
        <div class="summary-card">
            <div class="value green">KSH ${(account.balance || 0).toLocaleString()}</div>
            <div class="label">Current Balance</div>
        </div>
        <div class="summary-card">
            <div class="value blue">KSH ${totalCredits.toLocaleString()}</div>
            <div class="label">Total Top-ups</div>
        </div>
        <div class="summary-card">
            <div class="value purple">KSH ${totalDebits.toLocaleString()}</div>
            <div class="label">Services Used</div>
        </div>
        <div class="summary-card">
            <div class="value red">KSH ${totalExp.toLocaleString()}</div>
            <div class="label">Expenditures</div>
        </div>
    </div>

    ${account.vehicles?.length > 0 ? `
    <div class="section-title">Fleet Vehicles</div>
    <table>
        <thead>
            <tr>
                <th>Plate Number</th>
                <th>Vehicle</th>
                <th>Driver</th>
                <th class="text-center">Services</th>
                <th class="text-right">Total Spent</th>
            </tr>
        </thead>
        <tbody>
            ${account.vehicles.map(v => `
                <tr>
                    <td><strong>${v.plateNumber}</strong></td>
                    <td>${v.make || ''} ${v.model || ''} ${v.color ? '(' + v.color + ')' : ''}</td>
                    <td>${v.driverName || '-'}</td>
                    <td class="text-center">${v.totalServices || 0}</td>
                    <td class="text-right"><strong>KSH ${(v.totalSpent || 0).toLocaleString()}</strong></td>
                </tr>
            `).join('')}
        </tbody>
    </table>
    ` : ''}

    ${filteredExpenditures.length > 0 ? `
    <div class="section-title">Expenditures</div>
    <table>
        <thead>
            <tr>
                <th>Date</th>
                <th>Description</th>
                <th>Category</th>
                <th>Vehicle</th>
                <th class="text-right">Amount</th>
            </tr>
        </thead>
        <tbody>
            ${filteredExpenditures.map(e => `
                <tr>
                    <td>${new Date(e.date).toLocaleDateString()}</td>
                    <td>${e.description}</td>
                    <td>${e.category}</td>
                    <td>${e.vehicle || '-'}</td>
                    <td class="text-right red"><strong>KSH ${(e.amount || 0).toLocaleString()}</strong></td>
                </tr>
            `).join('')}
        </tbody>
    </table>
    ` : ''}

    ${filteredTransactions.length > 0 ? `
    <div class="section-title">Transactions (${periodLabel})</div>
    <table>
        <thead>
            <tr>
                <th>Date</th>
                <th>Description</th>
                <th>Type</th>
                <th class="text-right">Amount</th>
                <th class="text-right">Balance</th>
            </tr>
        </thead>
        <tbody>
            ${filteredTransactions.slice(0, 50).map(t => `
                <tr>
                    <td>${new Date(t.date).toLocaleDateString()}</td>
                    <td>${t.note || t.serviceDetails?.service || (t.type === 'credit' ? 'Top-up' : 'Service Charge')}</td>
                    <td>${t.type === 'credit' ? 'CREDIT' : 'DEBIT'}</td>
                    <td class="text-right ${t.type === 'credit' ? 'green' : 'red'}">
                        <strong>${t.type === 'credit' ? '+' : '-'}KSH ${(t.amount || 0).toLocaleString()}</strong>
                    </td>
                    <td class="text-right">KSH ${(t.balanceAfter || 0).toLocaleString()}</td>
                </tr>
            `).join('')}
        </tbody>
    </table>
    ` : '<p style="text-align: center; color: #64748b; padding: 20px;">No transactions in this period.</p>'}

    <div class="totals-box">
        <div class="item">
            <div class="val">KSH ${totalCredits.toLocaleString()}</div>
            <div class="lbl">Total Credits</div>
        </div>
        <div class="item">
            <div class="val">KSH ${totalDebits.toLocaleString()}</div>
            <div class="lbl">Total Debits</div>
        </div>
        <div class="item">
            <div class="val">KSH ${totalExp.toLocaleString()}</div>
            <div class="lbl">Total Expenditures</div>
        </div>
        <div class="item">
            <div class="val" style="color: ${account.balance >= 0 ? '#10b981' : '#ef4444'}">KSH ${(account.balance || 0).toLocaleString()}</div>
            <div class="lbl">Current Balance</div>
        </div>
    </div>

    <div class="footer">
        <p>Thank you for your business with EcoSpark Car Wash</p>
        <p style="margin-top: 8px;">This is a computer-generated document. No signature required.</p>
        <p style="margin-top: 4px;">Generated on ${now.toLocaleString()}</p>
    </div>
</body>
</html>`;

        const printWindow = window.open('', '_blank', 'width=800,height=600');
        printWindow.document.write(printContent);
        printWindow.document.close();
        printWindow.onload = () => {
            printWindow.print();
        };
    };

    const openViewModal = (account) => {
        setSelectedAccount(account);
        setShowViewModal(true);
    };

    const openEditModal = (account) => {
        setSelectedAccount(account);
        setAccountForm({
            companyName: account.companyName || '',
            contactPerson: account.contactPerson || '',
            phone: account.phone || '',
            email: account.email || '',
            address: account.address || '',
            paymentTerms: account.paymentTerms || 'prepaid',
            creditLimit: account.creditLimit || 0,
            discount: account.discount || 0,
            balance: account.balance || 0,
            notes: account.notes || ''
        });
        setShowEditModal(true);
    };

    const btnPrimary = { padding: '10px 20px', background: '#3b82f6', color: 'white', border: 'none', cursor: 'pointer', fontWeight: '600', fontSize: '13px' };
    const btnSecondary = { padding: '10px 20px', background: theme.bgTertiary, color: theme.text, border: `1px solid ${theme.border}`, cursor: 'pointer', fontWeight: '600', fontSize: '13px' };
    const btnSuccess = { padding: '10px 20px', background: '#10b981', color: 'white', border: 'none', cursor: 'pointer', fontWeight: '600', fontSize: '13px' };
    const btnDanger = { padding: '8px 12px', background: '#ef4444', color: 'white', border: 'none', cursor: 'pointer', fontSize: '12px' };
    const inputStyle = { width: '100%', padding: '10px 14px', border: `1px solid ${theme.border}`, background: theme.inputBg, color: theme.text, fontSize: '14px', outline: 'none' };
    const labelStyle = { display: 'block', marginBottom: '6px', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase' };
    const statCardStyle = { background: theme.bg, border: `1px solid ${theme.border}`, padding: '20px 24px', display: 'flex', alignItems: 'center', gap: '16px' };

    if (loading) {
        return (
            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', height: '400px', color: theme.textSecondary }}>
                <div style={{ textAlign: 'center' }}>
                    <div style={{ fontSize: '32px', marginBottom: '12px' }}>üöõ</div>
                    <div>Loading fleet accounts...</div>
                </div>
            </div>
        );
    }

    return (
        <div style={{ padding: '0', width: '100%' }}>
            {/* Toast Messages */}
            {successMessage && (
                <div style={{ position: 'fixed', top: '20px', right: '20px', zIndex: 1000, background: '#10b981', color: 'white', padding: '14px 24px', boxShadow: '0 4px 12px rgba(0,0,0,0.15)', fontWeight: '600' }}>
                    ‚úì {successMessage}
                </div>
            )}
            {error && (
                <div style={{ position: 'fixed', top: '20px', right: '20px', zIndex: 1000, background: '#ef4444', color: 'white', padding: '14px 24px', boxShadow: '0 4px 12px rgba(0,0,0,0.15)', cursor: 'pointer', fontWeight: '600' }} onClick={() => setError(null)}>
                    ‚úï {error}
                </div>
            )}

            {/* Stats Row */}
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(6, 1fr)', gap: '0', borderBottom: `1px solid ${theme.border}` }}>
                <div style={{ ...statCardStyle, borderRight: `1px solid ${theme.border}` }}>
                    <div style={{ fontSize: '24px' }}>üè¢</div>
                    <div>
                        <div style={{ fontSize: '24px', fontWeight: '800', color: theme.text }}>{stats.total}</div>
                        <div style={{ fontSize: '11px', color: theme.textSecondary, textTransform: 'uppercase', fontWeight: '600' }}>Total Accounts</div>
                    </div>
                </div>
                <div style={{ ...statCardStyle, borderRight: `1px solid ${theme.border}` }}>
                    <div style={{ fontSize: '24px' }}>‚úì</div>
                    <div>
                        <div style={{ fontSize: '24px', fontWeight: '800', color: '#10b981' }}>{stats.active}</div>
                        <div style={{ fontSize: '11px', color: theme.textSecondary, textTransform: 'uppercase', fontWeight: '600' }}>Active</div>
                    </div>
                </div>
                <div style={{ ...statCardStyle, borderRight: `1px solid ${theme.border}` }}>
                    <div style={{ fontSize: '24px' }}>üöó</div>
                    <div>
                        <div style={{ fontSize: '24px', fontWeight: '800', color: '#3b82f6' }}>{stats.totalVehicles}</div>
                        <div style={{ fontSize: '11px', color: theme.textSecondary, textTransform: 'uppercase', fontWeight: '600' }}>Vehicles</div>
                    </div>
                </div>
                <div style={{ ...statCardStyle, borderRight: `1px solid ${theme.border}` }}>
                    <div style={{ fontSize: '24px' }}>üí∞</div>
                    <div>
                        <div style={{ fontSize: '20px', fontWeight: '800', color: '#10b981' }}>{formatCurrency(stats.totalBalance)}</div>
                        <div style={{ fontSize: '11px', color: theme.textSecondary, textTransform: 'uppercase', fontWeight: '600' }}>Total Balance</div>
                    </div>
                </div>
                <div style={{ ...statCardStyle, borderRight: `1px solid ${theme.border}` }}>
                    <div style={{ fontSize: '24px' }}>üìä</div>
                    <div>
                        <div style={{ fontSize: '20px', fontWeight: '800', color: '#8b5cf6' }}>{formatCurrency(stats.totalSpent)}</div>
                        <div style={{ fontSize: '11px', color: theme.textSecondary, textTransform: 'uppercase', fontWeight: '600' }}>Total Spent</div>
                    </div>
                </div>
                <div style={{ ...statCardStyle }}>
                    <div style={{ fontSize: '24px' }}>üßæ</div>
                    <div>
                        <div style={{ fontSize: '24px', fontWeight: '800', color: theme.text }}>{stats.totalServices}</div>
                        <div style={{ fontSize: '11px', color: theme.textSecondary, textTransform: 'uppercase', fontWeight: '600' }}>Total Services</div>
                    </div>
                </div>
            </div>

            {/* Toolbar */}
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '16px 20px', background: theme.bgSecondary, borderBottom: `1px solid ${theme.border}` }}>
                <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
                    <input
                        type="text"
                        placeholder="Search accounts..."
                        value={searchQuery}
                        onChange={(e) => setSearchQuery(e.target.value)}
                        style={{ ...inputStyle, width: '280px' }}
                    />
                    <select value={statusFilter} onChange={(e) => setStatusFilter(e.target.value)} style={{ ...inputStyle, width: '140px' }}>
                        <option value="all">All Status</option>
                        <option value="active">Active</option>
                        <option value="suspended">Suspended</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
                <button onClick={() => { resetAccountForm(); setShowAddModal(true); }} style={btnSuccess}>
                    + New Fleet Account
                </button>
            </div>

            {/* Accounts Table */}
            <div style={{ overflowX: 'auto', background: theme.bg }}>
                <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                    <thead>
                        <tr style={{ background: theme.bgTertiary, borderBottom: `2px solid ${theme.border}` }}>
                            <th style={{ padding: '14px 20px', textAlign: 'left', fontSize: '11px', fontWeight: '700', color: theme.textSecondary, textTransform: 'uppercase' }}>Account #</th>
                            <th style={{ padding: '14px 20px', textAlign: 'left', fontSize: '11px', fontWeight: '700', color: theme.textSecondary, textTransform: 'uppercase' }}>Company</th>
                            <th style={{ padding: '14px 20px', textAlign: 'left', fontSize: '11px', fontWeight: '700', color: theme.textSecondary, textTransform: 'uppercase' }}>Contact</th>
                            <th style={{ padding: '14px 20px', textAlign: 'center', fontSize: '11px', fontWeight: '700', color: theme.textSecondary, textTransform: 'uppercase' }}>Vehicles</th>
                            <th style={{ padding: '14px 20px', textAlign: 'right', fontSize: '11px', fontWeight: '700', color: theme.textSecondary, textTransform: 'uppercase' }}>Balance</th>
                            <th style={{ padding: '14px 20px', textAlign: 'center', fontSize: '11px', fontWeight: '700', color: theme.textSecondary, textTransform: 'uppercase' }}>Discount</th>
                            <th style={{ padding: '14px 20px', textAlign: 'center', fontSize: '11px', fontWeight: '700', color: theme.textSecondary, textTransform: 'uppercase' }}>Status</th>
                            <th style={{ padding: '14px 20px', textAlign: 'center', fontSize: '11px', fontWeight: '700', color: theme.textSecondary, textTransform: 'uppercase' }}>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {filteredAccounts.length === 0 ? (
                            <tr>
                                <td colSpan="8" style={{ padding: '60px 20px', textAlign: 'center', color: theme.textSecondary }}>
                                    <div style={{ fontSize: '48px', marginBottom: '16px', opacity: 0.5 }}>üöõ</div>
                                    <div style={{ fontSize: '14px', fontWeight: '600' }}>No fleet accounts found</div>
                                    <div style={{ fontSize: '12px', marginTop: '4px' }}>Create your first fleet account to get started</div>
                                </td>
                            </tr>
                        ) : (
                            filteredAccounts.map((acc, idx) => (
                                <tr key={acc.id} style={{ borderBottom: `1px solid ${theme.border}`, background: idx % 2 === 0 ? theme.bg : theme.bgSecondary }}>
                                    <td style={{ padding: '16px 20px' }}>
                                        <span style={{ fontWeight: '700', color: '#3b82f6', cursor: 'pointer', fontFamily: 'monospace' }} onClick={() => openViewModal(acc)}>
                                            {acc.accountNumber}
                                        </span>
                                    </td>
                                    <td style={{ padding: '16px 20px' }}>
                                        <div style={{ fontWeight: '600', color: theme.text }}>{acc.companyName}</div>
                                        <div style={{ fontSize: '11px', color: theme.textSecondary }}>{acc.email}</div>
                                    </td>
                                    <td style={{ padding: '16px 20px' }}>
                                        <div style={{ color: theme.text }}>{acc.contactPerson || '-'}</div>
                                        <div style={{ fontSize: '11px', color: theme.textSecondary }}>{acc.phone}</div>
                                    </td>
                                    <td style={{ padding: '16px 20px', textAlign: 'center' }}>
                                        <span style={{ background: theme.bgTertiary, padding: '4px 12px', fontWeight: '700', fontSize: '13px', color: theme.text }}>
                                            {acc.vehicles?.length || 0}
                                        </span>
                                    </td>
                                    <td style={{ padding: '16px 20px', textAlign: 'right' }}>
                                        <div style={{ fontWeight: '700', color: acc.balance >= 0 ? '#10b981' : '#ef4444', fontSize: '15px' }}>
                                            {formatCurrency(acc.balance)}
                                        </div>
                                        {acc.creditLimit > 0 && (
                                            <div style={{ fontSize: '10px', color: theme.textSecondary }}>Credit: {formatCurrency(acc.creditLimit)}</div>
                                        )}
                                    </td>
                                    <td style={{ padding: '16px 20px', textAlign: 'center' }}>
                                        {acc.discount > 0 ? (
                                            <span style={{ background: '#dbeafe', color: '#1d4ed8', padding: '4px 10px', fontWeight: '700', fontSize: '12px' }}>
                                                {acc.discount}% OFF
                                            </span>
                                        ) : '-'}
                                    </td>
                                    <td style={{ padding: '16px 20px', textAlign: 'center' }}>
                                        <span style={{
                                            padding: '4px 12px',
                                            fontSize: '11px',
                                            fontWeight: '700',
                                            textTransform: 'uppercase',
                                            background: acc.status === 'active' ? '#dcfce7' : acc.status === 'suspended' ? '#fef3c7' : '#fee2e2',
                                            color: acc.status === 'active' ? '#166534' : acc.status === 'suspended' ? '#92400e' : '#dc2626'
                                        }}>
                                            {acc.status}
                                        </span>
                                    </td>
                                    <td style={{ padding: '16px 20px', textAlign: 'center' }}>
                                        <div style={{ display: 'flex', gap: '4px', justifyContent: 'center' }}>
                                            <button onClick={() => openViewModal(acc)} style={{ padding: '8px 12px', background: 'none', border: `1px solid ${theme.border}`, cursor: 'pointer', fontSize: '12px', color: theme.text }} title="View">View</button>
                                            <button onClick={() => openEditModal(acc)} style={{ padding: '8px 12px', background: 'none', border: `1px solid ${theme.border}`, cursor: 'pointer', fontSize: '12px', color: theme.text }} title="Edit">Edit</button>
                                            <button onClick={() => { setSelectedAccount(acc); setShowTopUpModal(true); }} style={{ padding: '8px 12px', background: '#10b981', border: 'none', cursor: 'pointer', fontSize: '12px', color: 'white', fontWeight: '600' }} title="Top Up">Top Up</button>
                                            <button onClick={() => handleDeleteAccount(acc)} style={{ padding: '8px 12px', background: 'none', border: `1px solid #ef4444`, cursor: 'pointer', fontSize: '12px', color: '#ef4444' }} title="Delete">Delete</button>
                                        </div>
                                    </td>
                                </tr>
                            ))
                        )}
                    </tbody>
                </table>
            </div>

            {/* Add/Edit Account Modal */}
            {(showAddModal || showEditModal) && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 }} onClick={() => { setShowAddModal(false); setShowEditModal(false); }}>
                    <div style={{ background: theme.bg, width: '600px', maxWidth: '95vw', maxHeight: '90vh', overflow: 'auto', border: `1px solid ${theme.border}` }} onClick={(e) => e.stopPropagation()}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '20px', borderBottom: `1px solid ${theme.border}` }}>
                            <h3 style={{ margin: 0, color: theme.text, fontWeight: '700' }}>{showAddModal ? 'New Fleet Account' : 'Edit Fleet Account'}</h3>
                            <button onClick={() => { setShowAddModal(false); setShowEditModal(false); }} style={{ background: 'none', border: 'none', fontSize: '20px', cursor: 'pointer', color: theme.textSecondary }}>‚úï</button>
                        </div>
                        <div style={{ padding: '20px' }}>
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px' }}>
                                <div style={{ gridColumn: '1 / -1' }}>
                                    <label style={labelStyle}>Company Name *</label>
                                    <input type="text" value={accountForm.companyName} onChange={(e) => setAccountForm({ ...accountForm, companyName: e.target.value })} style={inputStyle} placeholder="e.g. ABC Logistics Ltd" />
                                </div>
                                <div>
                                    <label style={labelStyle}>Contact Person</label>
                                    <input type="text" value={accountForm.contactPerson} onChange={(e) => setAccountForm({ ...accountForm, contactPerson: e.target.value })} style={inputStyle} placeholder="Primary contact name" />
                                </div>
                                <div>
                                    <label style={labelStyle}>Phone *</label>
                                    <input type="text" value={accountForm.phone} onChange={(e) => setAccountForm({ ...accountForm, phone: e.target.value })} style={inputStyle} placeholder="0712345678" />
                                </div>
                                <div>
                                    <label style={labelStyle}>Email</label>
                                    <input type="email" value={accountForm.email} onChange={(e) => setAccountForm({ ...accountForm, email: e.target.value })} style={inputStyle} placeholder="accounts@company.com" />
                                </div>
                                <div>
                                    <label style={labelStyle}>Payment Terms</label>
                                    <select value={accountForm.paymentTerms} onChange={(e) => setAccountForm({ ...accountForm, paymentTerms: e.target.value })} style={inputStyle}>
                                        <option value="prepaid">Prepaid (Balance)</option>
                                        <option value="postpaid">Postpaid (Invoice)</option>
                                        <option value="credit">Credit Line</option>
                                    </select>
                                </div>
                                <div style={{ gridColumn: '1 / -1' }}>
                                    <label style={labelStyle}>Address</label>
                                    <input type="text" value={accountForm.address} onChange={(e) => setAccountForm({ ...accountForm, address: e.target.value })} style={inputStyle} placeholder="Business address" />
                                </div>
                                <div>
                                    <label style={labelStyle}>Credit Limit (KSH)</label>
                                    <input type="number" value={accountForm.creditLimit} onChange={(e) => setAccountForm({ ...accountForm, creditLimit: Number(e.target.value) })} style={inputStyle} placeholder="0" />
                                </div>
                                <div>
                                    <label style={labelStyle}>Discount %</label>
                                    <input type="number" min="0" max="100" value={accountForm.discount} onChange={(e) => setAccountForm({ ...accountForm, discount: Number(e.target.value) })} style={inputStyle} placeholder="0" />
                                </div>
                                {showAddModal && (
                                    <div>
                                        <label style={labelStyle}>Initial Balance (KSH)</label>
                                        <input type="number" value={accountForm.balance} onChange={(e) => setAccountForm({ ...accountForm, balance: Number(e.target.value) })} style={inputStyle} placeholder="0" />
                                    </div>
                                )}
                                <div style={{ gridColumn: '1 / -1' }}>
                                    <label style={labelStyle}>Notes</label>
                                    <textarea value={accountForm.notes} onChange={(e) => setAccountForm({ ...accountForm, notes: e.target.value })} style={{ ...inputStyle, minHeight: '80px', resize: 'vertical' }} placeholder="Special instructions or notes..." />
                                </div>
                            </div>
                        </div>
                        <div style={{ display: 'flex', gap: '8px', justifyContent: 'flex-end', padding: '20px', borderTop: `1px solid ${theme.border}` }}>
                            <button onClick={() => { setShowAddModal(false); setShowEditModal(false); }} style={{ padding: '10px 20px', background: 'none', border: `1px solid ${theme.border}`, cursor: 'pointer', fontSize: '13px', color: theme.text, fontWeight: '600' }}>Cancel</button>
                            <button onClick={showAddModal ? handleAddAccount : handleEditAccount} disabled={actionLoading} style={{ padding: '10px 20px', background: '#10b981', border: 'none', cursor: 'pointer', fontSize: '13px', color: 'white', fontWeight: '600' }}>
                                {actionLoading ? 'Saving...' : (showAddModal ? 'Create Account' : 'Save Changes')}
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* View Account Modal (Detail View) */}
            {showViewModal && selectedAccount && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 }} onClick={() => setShowViewModal(false)}>
                    <div style={{ background: theme.bg, width: '900px', maxWidth: '95vw', maxHeight: '90vh', overflow: 'auto', border: `1px solid ${theme.border}` }} onClick={(e) => e.stopPropagation()}>
                        {/* Header */}
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '20px', borderBottom: `1px solid ${theme.border}`, background: theme.bgSecondary }}>
                            <div>
                                <h3 style={{ margin: 0, color: theme.text, fontWeight: '700' }}>{selectedAccount.companyName}</h3>
                                <div style={{ fontSize: '13px', color: theme.textSecondary, marginTop: '4px', fontFamily: 'monospace' }}>{selectedAccount.accountNumber}</div>
                            </div>
                            <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
                                <span style={{
                                    padding: '6px 14px',
                                    fontSize: '12px',
                                    fontWeight: '700',
                                    textTransform: 'uppercase',
                                    background: selectedAccount.status === 'active' ? '#dcfce7' : '#fef3c7',
                                    color: selectedAccount.status === 'active' ? '#166534' : '#92400e'
                                }}>
                                    {selectedAccount.status}
                                </span>
                                <button onClick={() => setShowViewModal(false)} style={{ background: 'none', border: 'none', fontSize: '20px', cursor: 'pointer', color: theme.textSecondary }}>‚úï</button>
                            </div>
                        </div>

                        {/* Account Summary Cards */}
                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '0', borderBottom: `1px solid ${theme.border}` }}>
                            <div style={{ padding: '16px 20px', borderRight: `1px solid ${theme.border}` }}>
                                <div style={{ fontSize: '11px', color: theme.textSecondary, textTransform: 'uppercase', fontWeight: '600' }}>Balance</div>
                                <div style={{ fontSize: '22px', fontWeight: '800', color: selectedAccount.balance >= 0 ? '#10b981' : '#ef4444' }}>{formatCurrency(selectedAccount.balance)}</div>
                            </div>
                            <div style={{ padding: '16px 20px', borderRight: `1px solid ${theme.border}` }}>
                                <div style={{ fontSize: '11px', color: theme.textSecondary, textTransform: 'uppercase', fontWeight: '600' }}>Credit Limit</div>
                                <div style={{ fontSize: '22px', fontWeight: '800', color: theme.text }}>{formatCurrency(selectedAccount.creditLimit)}</div>
                            </div>
                            <div style={{ padding: '16px 20px', borderRight: `1px solid ${theme.border}` }}>
                                <div style={{ fontSize: '11px', color: theme.textSecondary, textTransform: 'uppercase', fontWeight: '600' }}>Total Spent</div>
                                <div style={{ fontSize: '22px', fontWeight: '800', color: '#8b5cf6' }}>{formatCurrency(selectedAccount.totalSpent)}</div>
                            </div>
                            <div style={{ padding: '16px 20px' }}>
                                <div style={{ fontSize: '11px', color: theme.textSecondary, textTransform: 'uppercase', fontWeight: '600' }}>Discount</div>
                                <div style={{ fontSize: '22px', fontWeight: '800', color: '#3b82f6' }}>{selectedAccount.discount || 0}%</div>
                            </div>
                        </div>

                        {/* Contact Info */}
                        <div style={{ padding: '16px 20px', borderBottom: `1px solid ${theme.border}`, display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '20px' }}>
                            <div>
                                <div style={{ fontSize: '11px', color: theme.textSecondary, textTransform: 'uppercase', fontWeight: '600', marginBottom: '4px' }}>Contact Person</div>
                                <div style={{ color: theme.text, fontWeight: '500' }}>{selectedAccount.contactPerson || '-'}</div>
                            </div>
                            <div>
                                <div style={{ fontSize: '11px', color: theme.textSecondary, textTransform: 'uppercase', fontWeight: '600', marginBottom: '4px' }}>Phone</div>
                                <div style={{ color: theme.text, fontWeight: '500' }}>{selectedAccount.phone}</div>
                            </div>
                            <div>
                                <div style={{ fontSize: '11px', color: theme.textSecondary, textTransform: 'uppercase', fontWeight: '600', marginBottom: '4px' }}>Email</div>
                                <div style={{ color: theme.text, fontWeight: '500' }}>{selectedAccount.email || '-'}</div>
                            </div>
                        </div>

                        {/* Vehicles Section */}
                        <div style={{ padding: '20px' }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
                                <h4 style={{ margin: 0, color: theme.text, fontWeight: '700' }}>Fleet Vehicles ({selectedAccount.vehicles?.length || 0})</h4>
                                <button onClick={() => setShowVehicleModal(true)} style={{ padding: '8px 16px', background: '#3b82f6', border: 'none', cursor: 'pointer', fontSize: '12px', color: 'white', fontWeight: '600' }}>+ Add Vehicle</button>
                            </div>
                            {selectedAccount.vehicles?.length > 0 ? (
                                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(280px, 1fr))', gap: '12px' }}>
                                    {selectedAccount.vehicles.map(v => (
                                        <div key={v.id} style={{ background: theme.bgSecondary, border: `1px solid ${theme.border}`, padding: '14px' }}>
                                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                                                <div>
                                                    <div style={{ fontWeight: '700', color: theme.text, fontSize: '15px', fontFamily: 'monospace' }}>{v.plateNumber}</div>
                                                    <div style={{ fontSize: '12px', color: theme.textSecondary }}>{v.make} {v.model} ‚Ä¢ {v.color}</div>
                                                    {v.driverName && <div style={{ fontSize: '11px', color: theme.textSecondary, marginTop: '4px' }}>Driver: {v.driverName}</div>}
                                                </div>
                                                <button onClick={() => handleRemoveVehicle(v.id)} style={{ padding: '4px 8px', background: 'none', border: `1px solid ${theme.border}`, cursor: 'pointer', color: theme.textSecondary, fontSize: '11px' }}>Remove</button>
                                            </div>
                                            <div style={{ display: 'flex', gap: '16px', marginTop: '10px', fontSize: '11px' }}>
                                                <span style={{ color: theme.textSecondary }}>Services: <strong style={{ color: theme.text }}>{v.totalServices || 0}</strong></span>
                                                <span style={{ color: theme.textSecondary }}>Spent: <strong style={{ color: '#10b981' }}>{formatCurrency(v.totalSpent)}</strong></span>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <div style={{ padding: '30px', textAlign: 'center', color: theme.textSecondary, background: theme.bgSecondary }}>
                                    No vehicles registered. Add vehicles to this fleet account.
                                </div>
                            )}
                        </div>

                        {/* Authorized Contacts Section */}
                        <div style={{ padding: '20px', borderTop: `1px solid ${theme.border}` }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
                                <h4 style={{ margin: 0, color: theme.text, fontWeight: '700' }}>Authorized Contacts ({selectedAccount.authorizedContacts?.length || 0})</h4>
                                <button onClick={() => setShowContactModal(true)} style={{ padding: '8px 16px', background: '#3b82f6', border: 'none', cursor: 'pointer', fontSize: '12px', color: 'white', fontWeight: '600' }}>+ Add Contact</button>
                            </div>
                            {selectedAccount.authorizedContacts?.length > 0 ? (
                                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(220px, 1fr))', gap: '12px' }}>
                                    {selectedAccount.authorizedContacts.map(c => (
                                        <div key={c.id} style={{ background: theme.bgSecondary, border: `1px solid ${theme.border}`, padding: '12px', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                            <div>
                                                <div style={{ fontWeight: '600', color: theme.text }}>{c.name}</div>
                                                <div style={{ fontSize: '12px', color: theme.textSecondary }}>{c.phone} ‚Ä¢ {c.role}</div>
                                            </div>
                                            <button onClick={() => handleRemoveContact(c.id)} style={{ padding: '4px 8px', background: 'none', border: `1px solid ${theme.border}`, cursor: 'pointer', color: theme.textSecondary, fontSize: '11px' }}>Remove</button>
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <div style={{ padding: '20px', textAlign: 'center', color: theme.textSecondary, background: theme.bgSecondary }}>
                                    No authorized contacts. Add people who can bring vehicles for service.
                                </div>
                            )}
                        </div>

                        {/* Expenditures Section */}
                        <div style={{ padding: '20px', borderTop: `1px solid ${theme.border}` }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
                                <h4 style={{ margin: 0, color: theme.text, fontWeight: '700' }}>Fleet Expenditures ({selectedAccount.expenditures?.length || 0})</h4>
                                <button onClick={() => { resetExpenditureForm(); setEditingExpenditure(null); setShowExpenditureModal(true); }} style={{ padding: '8px 16px', background: '#8b5cf6', border: 'none', cursor: 'pointer', fontSize: '12px', color: 'white', fontWeight: '600' }}>+ Add Expenditure</button>
                            </div>
                            <div style={{ display: 'flex', gap: '16px', marginBottom: '12px' }}>
                                <div style={{ background: theme.bgSecondary, padding: '12px 16px', border: `1px solid ${theme.border}`, flex: 1 }}>
                                    <div style={{ fontSize: '10px', color: theme.textSecondary, textTransform: 'uppercase', fontWeight: '600' }}>Total Expenditures</div>
                                    <div style={{ fontSize: '20px', fontWeight: '800', color: '#ef4444' }}>{formatCurrency(selectedAccount.totalExpenditures)}</div>
                                </div>
                                <div style={{ background: theme.bgSecondary, padding: '12px 16px', border: `1px solid ${theme.border}`, flex: 1 }}>
                                    <div style={{ fontSize: '10px', color: theme.textSecondary, textTransform: 'uppercase', fontWeight: '600' }}>Net Position (Spent - Exp)</div>
                                    <div style={{ fontSize: '20px', fontWeight: '800', color: '#8b5cf6' }}>{formatCurrency((selectedAccount.totalSpent || 0) - (selectedAccount.totalExpenditures || 0))}</div>
                                </div>
                            </div>
                            {selectedAccount.expenditures?.length > 0 ? (
                                <div style={{ maxHeight: '200px', overflow: 'auto' }}>
                                    {selectedAccount.expenditures.slice(0, 15).map(exp => (
                                        <div key={exp.id} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '10px 12px', borderBottom: `1px solid ${theme.border}`, background: theme.bgSecondary, marginBottom: '4px' }}>
                                            <div style={{ flex: 1 }}>
                                                <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
                                                    <span style={{ fontSize: '13px', fontWeight: '600', color: theme.text }}>{exp.description}</span>
                                                    <span style={{ fontSize: '10px', padding: '2px 6px', background: theme.bgTertiary, color: theme.textSecondary }}>{exp.category}</span>
                                                </div>
                                                <div style={{ fontSize: '11px', color: theme.textSecondary, marginTop: '2px' }}>
                                                    {new Date(exp.date).toLocaleDateString()} {exp.vehicle && `‚Ä¢ ${exp.vehicle}`}
                                                </div>
                                            </div>
                                            <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                                                <span style={{ fontWeight: '700', color: '#ef4444' }}>{formatCurrency(exp.amount)}</span>
                                                <div style={{ display: 'flex', gap: '4px' }}>
                                                    <button onClick={() => openEditExpenditure(exp)} style={{ padding: '4px 8px', background: 'none', border: `1px solid ${theme.border}`, cursor: 'pointer', fontSize: '10px', color: theme.text }}>Edit</button>
                                                    <button onClick={() => handleDeleteExpenditure(exp.id)} style={{ padding: '4px 8px', background: 'none', border: `1px solid #ef4444`, cursor: 'pointer', fontSize: '10px', color: '#ef4444' }}>Delete</button>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <div style={{ padding: '20px', textAlign: 'center', color: theme.textSecondary, background: theme.bgSecondary }}>
                                    No expenditures recorded. Track fuel, maintenance, and other fleet costs here.
                                </div>
                            )}
                        </div>

                        {/* Recent Transactions */}
                        <div style={{ padding: '20px', borderTop: `1px solid ${theme.border}` }}>
                            <h4 style={{ margin: '0 0 12px 0', color: theme.text, fontWeight: '700' }}>üìú Recent Transactions</h4>
                            {selectedAccount.transactions?.length > 0 ? (
                                <div style={{ maxHeight: '200px', overflow: 'auto' }}>
                                    {selectedAccount.transactions.slice(0, 10).map(txn => (
                                        <div key={txn.id} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '10px 0', borderBottom: `1px solid ${theme.border}` }}>
                                            <div>
                                                <div style={{ fontSize: '12px', color: theme.textSecondary }}>{new Date(txn.date).toLocaleString()}</div>
                                                <div style={{ fontSize: '13px', color: theme.text }}>{txn.note || txn.serviceDetails?.service || (txn.type === 'credit' ? 'Top-up' : 'Service Charge')}</div>
                                            </div>
                                            <div style={{ fontWeight: '700', color: txn.type === 'credit' ? '#10b981' : '#ef4444' }}>
                                                {txn.type === 'credit' ? '+' : '-'}{formatCurrency(txn.amount)}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <div style={{ padding: '20px', textAlign: 'center', color: theme.textSecondary, background: theme.bgSecondary }}>
                                    No transactions yet.
                                </div>
                            )}
                        </div>

                        {/* Footer Actions */}
                        <div style={{ display: 'flex', gap: '8px', justifyContent: 'space-between', padding: '20px', borderTop: `1px solid ${theme.border}`, background: theme.bgSecondary }}>
                            <div style={{ display: 'flex', gap: '8px' }}>
                                <button onClick={() => setShowReceiptModal(true)} style={{ padding: '10px 20px', background: '#1e293b', border: 'none', cursor: 'pointer', fontSize: '13px', color: 'white', fontWeight: '600' }}>Print Statement</button>
                            </div>
                            <div style={{ display: 'flex', gap: '8px' }}>
                                <button onClick={() => setShowViewModal(false)} style={{ padding: '10px 20px', background: 'none', border: `1px solid ${theme.border}`, cursor: 'pointer', fontSize: '13px', color: theme.text, fontWeight: '600' }}>Close</button>
                                <button onClick={() => { setShowViewModal(false); openEditModal(selectedAccount); }} style={{ padding: '10px 20px', background: 'none', border: `1px solid #3b82f6`, cursor: 'pointer', fontSize: '13px', color: '#3b82f6', fontWeight: '600' }}>Edit Account</button>
                                <button onClick={() => { setShowTopUpModal(true); }} style={{ padding: '10px 20px', background: '#10b981', border: 'none', cursor: 'pointer', fontSize: '13px', color: 'white', fontWeight: '600' }}>Top Up Balance</button>
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* Print Receipt Modal */}
            {showReceiptModal && selectedAccount && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1002 }} onClick={() => setShowReceiptModal(false)}>
                    <div style={{ background: theme.bg, width: '400px', maxWidth: '95vw', border: `1px solid ${theme.border}` }} onClick={(e) => e.stopPropagation()}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '16px 20px', borderBottom: `1px solid ${theme.border}` }}>
                            <h4 style={{ margin: 0, color: theme.text }}>Print Account Statement</h4>
                            <button onClick={() => setShowReceiptModal(false)} style={{ background: 'none', border: 'none', fontSize: '18px', cursor: 'pointer', color: theme.textSecondary }}>‚úï</button>
                        </div>
                        <div style={{ padding: '20px' }}>
                            <div style={{ marginBottom: '16px', padding: '16px', background: theme.bgSecondary, border: `1px solid ${theme.border}` }}>
                                <div style={{ fontSize: '12px', color: theme.textSecondary, marginBottom: '4px' }}>Account</div>
                                <div style={{ fontWeight: '700', color: theme.text }}>{selectedAccount.companyName}</div>
                                <div style={{ fontSize: '12px', color: theme.textSecondary, fontFamily: 'monospace' }}>{selectedAccount.accountNumber}</div>
                            </div>
                            <div style={{ fontSize: '13px', color: theme.textSecondary, marginBottom: '12px' }}>Select the period for your statement:</div>
                            <div style={{ display: 'grid', gap: '10px' }}>
                                <button onClick={() => { printReceipt(selectedAccount, 'week'); setShowReceiptModal(false); }} style={{ padding: '14px 20px', background: theme.bgSecondary, border: `1px solid ${theme.border}`, cursor: 'pointer', fontSize: '14px', color: theme.text, fontWeight: '600', textAlign: 'left' }}>
                                    Last 7 Days
                                </button>
                                <button onClick={() => { printReceipt(selectedAccount, 'month'); setShowReceiptModal(false); }} style={{ padding: '14px 20px', background: theme.bgSecondary, border: `1px solid ${theme.border}`, cursor: 'pointer', fontSize: '14px', color: theme.text, fontWeight: '600', textAlign: 'left' }}>
                                    This Month
                                </button>
                                <button onClick={() => { printReceipt(selectedAccount, 'all'); setShowReceiptModal(false); }} style={{ padding: '14px 20px', background: '#1e293b', border: 'none', cursor: 'pointer', fontSize: '14px', color: 'white', fontWeight: '600', textAlign: 'left' }}>
                                    Full Statement (All Time)
                                </button>
                            </div>
                        </div>
                        <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end', padding: '16px 20px', borderTop: `1px solid ${theme.border}` }}>
                            <button onClick={() => setShowReceiptModal(false)} style={{ padding: '10px 20px', background: 'none', border: `1px solid ${theme.border}`, color: theme.text, fontWeight: '600', cursor: 'pointer' }}>Cancel</button>
                        </div>
                    </div>
                </div>
            )}

            {/* Expenditure Modal */}
            {showExpenditureModal && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1002 }} onClick={() => { setShowExpenditureModal(false); setEditingExpenditure(null); }}>
                    <div style={{ background: theme.bg, width: '450px', maxWidth: '95vw', border: `1px solid ${theme.border}` }} onClick={(e) => e.stopPropagation()}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '16px 20px', borderBottom: `1px solid ${theme.border}` }}>
                            <h4 style={{ margin: 0, color: theme.text }}>{editingExpenditure ? 'Edit Expenditure' : 'Add Expenditure'}</h4>
                            <button onClick={() => { setShowExpenditureModal(false); setEditingExpenditure(null); }} style={{ background: 'none', border: 'none', fontSize: '18px', cursor: 'pointer', color: theme.textSecondary }}>‚úï</button>
                        </div>
                        <div style={{ padding: '20px', display: 'grid', gap: '12px' }}>
                            <div>
                                <label style={labelStyle}>Description *</label>
                                <input type="text" value={expenditureForm.description} onChange={(e) => setExpenditureForm({ ...expenditureForm, description: e.target.value })} style={inputStyle} placeholder="e.g. Fuel refill, Tire change" />
                            </div>
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' }}>
                                <div>
                                    <label style={labelStyle}>Category</label>
                                    <select value={expenditureForm.category} onChange={(e) => setExpenditureForm({ ...expenditureForm, category: e.target.value })} style={inputStyle}>
                                        <option value="Fuel">Fuel</option>
                                        <option value="Maintenance">Maintenance</option>
                                        <option value="Repairs">Repairs</option>
                                        <option value="Tires">Tires</option>
                                        <option value="Insurance">Insurance</option>
                                        <option value="Parking">Parking</option>
                                        <option value="Toll">Toll</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div>
                                    <label style={labelStyle}>Amount (KSH) *</label>
                                    <input type="number" value={expenditureForm.amount} onChange={(e) => setExpenditureForm({ ...expenditureForm, amount: e.target.value })} style={inputStyle} placeholder="0" />
                                </div>
                            </div>
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' }}>
                                <div>
                                    <label style={labelStyle}>Date</label>
                                    <input type="date" value={expenditureForm.date} onChange={(e) => setExpenditureForm({ ...expenditureForm, date: e.target.value })} style={inputStyle} />
                                </div>
                                <div>
                                    <label style={labelStyle}>Vehicle (Optional)</label>
                                    <select value={expenditureForm.vehicle} onChange={(e) => setExpenditureForm({ ...expenditureForm, vehicle: e.target.value })} style={inputStyle}>
                                        <option value="">-- Select Vehicle --</option>
                                        {selectedAccount?.vehicles?.map(v => (
                                            <option key={v.id} value={v.plateNumber}>{v.plateNumber}</option>
                                        ))}
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label style={labelStyle}>Note</label>
                                <input type="text" value={expenditureForm.note} onChange={(e) => setExpenditureForm({ ...expenditureForm, note: e.target.value })} style={inputStyle} placeholder="Additional details..." />
                            </div>
                        </div>
                        <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end', padding: '16px 20px', borderTop: `1px solid ${theme.border}` }}>
                            <button onClick={() => { setShowExpenditureModal(false); setEditingExpenditure(null); }} style={{ padding: '10px 20px', background: 'none', border: `1px solid ${theme.border}`, color: theme.text, fontWeight: '600', cursor: 'pointer' }}>Cancel</button>
                            <button onClick={editingExpenditure ? handleUpdateExpenditure : handleAddExpenditure} disabled={actionLoading} style={{ padding: '10px 20px', background: '#8b5cf6', border: 'none', color: 'white', fontWeight: '600', cursor: 'pointer', opacity: actionLoading ? 0.7 : 1 }}>{actionLoading ? 'Saving...' : (editingExpenditure ? 'Update' : 'Add Expenditure')}</button>
                        </div>
                    </div>
                </div>
            )}

            {/* Add Vehicle Modal */}
            {showVehicleModal && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1001 }} onClick={() => setShowVehicleModal(false)}>
                    <div style={{ background: theme.bg, width: '450px', maxWidth: '95vw', border: `1px solid ${theme.border}` }} onClick={(e) => e.stopPropagation()}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '16px 20px', borderBottom: `1px solid ${theme.border}` }}>
                            <h4 style={{ margin: 0, color: theme.text }}>Add Vehicle</h4>
                            <button onClick={() => setShowVehicleModal(false)} style={{ background: 'none', border: 'none', fontSize: '18px', cursor: 'pointer', color: theme.textSecondary }}>‚úï</button>
                        </div>
                        <div style={{ padding: '20px', display: 'grid', gap: '12px' }}>
                            <div>
                                <label style={labelStyle}>Plate Number *</label>
                                <input type="text" value={vehicleForm.plateNumber} onChange={(e) => setVehicleForm({ ...vehicleForm, plateNumber: e.target.value.toUpperCase() })} style={inputStyle} placeholder="KAA 123X" />
                            </div>
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' }}>
                                <div>
                                    <label style={labelStyle}>Make</label>
                                    <input type="text" value={vehicleForm.make} onChange={(e) => setVehicleForm({ ...vehicleForm, make: e.target.value })} style={inputStyle} placeholder="Toyota" />
                                </div>
                                <div>
                                    <label style={labelStyle}>Model</label>
                                    <input type="text" value={vehicleForm.model} onChange={(e) => setVehicleForm({ ...vehicleForm, model: e.target.value })} style={inputStyle} placeholder="Hiace" />
                                </div>
                            </div>
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' }}>
                                <div>
                                    <label style={labelStyle}>Color</label>
                                    <input type="text" value={vehicleForm.color} onChange={(e) => setVehicleForm({ ...vehicleForm, color: e.target.value })} style={inputStyle} placeholder="White" />
                                </div>
                                <div>
                                    <label style={labelStyle}>Vehicle Type</label>
                                    <select value={vehicleForm.vehicleType} onChange={(e) => setVehicleForm({ ...vehicleForm, vehicleType: e.target.value })} style={inputStyle}>
                                        <option value="Sedan">Sedan</option>
                                        <option value="SUV">SUV</option>
                                        <option value="Van">Van</option>
                                        <option value="Truck">Truck</option>
                                        <option value="Bus">Bus</option>
                                        <option value="Motorcycle">Motorcycle</option>
                                    </select>
                                </div>
                            </div>
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' }}>
                                <div>
                                    <label style={labelStyle}>Driver Name</label>
                                    <input type="text" value={vehicleForm.driverName} onChange={(e) => setVehicleForm({ ...vehicleForm, driverName: e.target.value })} style={inputStyle} placeholder="Optional" />
                                </div>
                                <div>
                                    <label style={labelStyle}>Driver Phone</label>
                                    <input type="text" value={vehicleForm.driverPhone} onChange={(e) => setVehicleForm({ ...vehicleForm, driverPhone: e.target.value })} style={inputStyle} placeholder="Optional" />
                                </div>
                            </div>
                        </div>
                        <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end', padding: '16px 20px', borderTop: `1px solid ${theme.border}` }}>
                            <button onClick={() => setShowVehicleModal(false)} style={{ padding: '10px 20px', background: 'none', border: `1px solid ${theme.border}`, color: theme.text, fontWeight: '600', cursor: 'pointer' }}>Cancel</button>
                            <button onClick={handleAddVehicle} disabled={actionLoading} style={{ padding: '10px 20px', background: '#10b981', border: 'none', color: 'white', fontWeight: '600', cursor: 'pointer', opacity: actionLoading ? 0.7 : 1 }}>{actionLoading ? 'Adding...' : 'Add Vehicle'}</button>
                        </div>
                    </div>
                </div>
            )}

            {/* Add Contact Modal */}
            {showContactModal && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1001 }} onClick={() => setShowContactModal(false)}>
                    <div style={{ background: theme.bg, width: '400px', maxWidth: '95vw', border: `1px solid ${theme.border}` }} onClick={(e) => e.stopPropagation()}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '16px 20px', borderBottom: `1px solid ${theme.border}` }}>
                            <h4 style={{ margin: 0, color: theme.text }}>Add Authorized Contact</h4>
                            <button onClick={() => setShowContactModal(false)} style={{ background: 'none', border: 'none', fontSize: '18px', cursor: 'pointer', color: theme.textSecondary }}>‚úï</button>
                        </div>
                        <div style={{ padding: '20px', display: 'grid', gap: '12px' }}>
                            <div>
                                <label style={labelStyle}>Name *</label>
                                <input type="text" value={contactForm.name} onChange={(e) => setContactForm({ ...contactForm, name: e.target.value })} style={inputStyle} placeholder="Full name" />
                            </div>
                            <div>
                                <label style={labelStyle}>Phone *</label>
                                <input type="text" value={contactForm.phone} onChange={(e) => setContactForm({ ...contactForm, phone: e.target.value })} style={inputStyle} placeholder="0712345678" />
                            </div>
                            <div>
                                <label style={labelStyle}>Email</label>
                                <input type="email" value={contactForm.email} onChange={(e) => setContactForm({ ...contactForm, email: e.target.value })} style={inputStyle} placeholder="Optional" />
                            </div>
                            <div>
                                <label style={labelStyle}>Role</label>
                                <select value={contactForm.role} onChange={(e) => setContactForm({ ...contactForm, role: e.target.value })} style={inputStyle}>
                                    <option value="Driver">Driver</option>
                                    <option value="Fleet Manager">Fleet Manager</option>
                                    <option value="Accounts">Accounts</option>
                                    <option value="Supervisor">Supervisor</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                        </div>
                        <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end', padding: '16px 20px', borderTop: `1px solid ${theme.border}` }}>
                            <button onClick={() => setShowContactModal(false)} style={{ padding: '10px 20px', background: 'none', border: `1px solid ${theme.border}`, color: theme.text, fontWeight: '600', cursor: 'pointer' }}>Cancel</button>
                            <button onClick={handleAddContact} disabled={actionLoading} style={{ padding: '10px 20px', background: '#10b981', border: 'none', color: 'white', fontWeight: '600', cursor: 'pointer', opacity: actionLoading ? 0.7 : 1 }}>{actionLoading ? 'Adding...' : 'Add Contact'}</button>
                        </div>
                    </div>
                </div>
            )}

            {/* Top Up Modal */}
            {showTopUpModal && selectedAccount && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1001 }} onClick={() => setShowTopUpModal(false)}>
                    <div style={{ background: theme.bg, width: '400px', maxWidth: '95vw', border: `1px solid ${theme.border}` }} onClick={(e) => e.stopPropagation()}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '16px 20px', borderBottom: `1px solid ${theme.border}` }}>
                            <h4 style={{ margin: 0, color: theme.text }}>Top Up Balance</h4>
                            <button onClick={() => setShowTopUpModal(false)} style={{ background: 'none', border: 'none', fontSize: '18px', cursor: 'pointer', color: theme.textSecondary }}>‚úï</button>
                        </div>
                        <div style={{ padding: '20px' }}>
                            <div style={{ background: theme.bgSecondary, padding: '16px', marginBottom: '16px', borderLeft: '4px solid #10b981' }}>
                                <div style={{ fontSize: '12px', color: theme.textSecondary }}>Current Balance</div>
                                <div style={{ fontSize: '24px', fontWeight: '800', color: selectedAccount.balance >= 0 ? '#10b981' : '#ef4444' }}>{formatCurrency(selectedAccount.balance)}</div>
                            </div>
                            <div style={{ marginBottom: '12px' }}>
                                <label style={labelStyle}>Amount (KSH) *</label>
                                <input type="number" value={topUpAmount} onChange={(e) => setTopUpAmount(e.target.value)} style={inputStyle} placeholder="Enter amount" />
                            </div>
                            <div>
                                <label style={labelStyle}>Note / Reference</label>
                                <input type="text" value={topUpNote} onChange={(e) => setTopUpNote(e.target.value)} style={inputStyle} placeholder="e.g. Cash deposit, M-Pesa ref" />
                            </div>
                        </div>
                        <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end', padding: '16px 20px', borderTop: `1px solid ${theme.border}` }}>
                            <button onClick={() => setShowTopUpModal(false)} style={{ padding: '10px 20px', background: 'none', border: `1px solid ${theme.border}`, color: theme.text, fontWeight: '600', cursor: 'pointer' }}>Cancel</button>
                            <button onClick={handleTopUp} disabled={actionLoading} style={{ padding: '10px 20px', background: '#10b981', border: 'none', color: 'white', fontWeight: '600', cursor: 'pointer', opacity: actionLoading ? 0.7 : 1 }}>{actionLoading ? 'Processing...' : 'Add Balance'}</button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}

// Customer Management Component
function CustomerManagement() {
    const [customers, setCustomers] = useState([]);
    const [loading, setLoading] = useState(true);
    const [searchQuery, setSearchQuery] = useState('');
    const [showAddModal, setShowAddModal] = useState(false);
    const [showEditModal, setShowEditModal] = useState(false);
    const [showViewModal, setShowViewModal] = useState(false);
    const [showAddVehicleModal, setShowAddVehicleModal] = useState(false);
    const [showLoyaltySettingsModal, setShowLoyaltySettingsModal] = useState(false);
    const [showReceiptModal, setShowReceiptModal] = useState(false);
    const [receiptData, setReceiptData] = useState(null);
    const [selectedCustomer, setSelectedCustomer] = useState(null);
    const [actionLoading, setActionLoading] = useState(false);
    const [error, setError] = useState(null);
    const [activeTab, setActiveTab] = useState('customers'); // 'customers' or 'reminders'
    const [loyaltySettings, setLoyaltySettings] = useState({
        pointsPerVisit: 1,
        pointsPerRand: 0.1,
        redeemRate: 0.1,
        welcomeBonus: 10,
        birthdayBonus: 50,
        enabled: true
    });
    const [isDark, setIsDark] = useState(document.documentElement.getAttribute('data-theme') === 'dark');

    // Listen for theme changes
    useEffect(() => {
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.attributeName === 'data-theme') {
                    setIsDark(document.documentElement.getAttribute('data-theme') === 'dark');
                }
            });
        });
        observer.observe(document.documentElement, { attributes: true });
        return () => observer.disconnect();
    }, []);

    // Theme colors
    const theme = {
        bg: isDark ? '#1e293b' : 'white',
        bgSecondary: isDark ? '#0f172a' : '#f8fafc',
        bgTertiary: isDark ? '#334155' : '#f1f5f9',
        text: isDark ? '#f1f5f9' : '#1e293b',
        textSecondary: isDark ? '#94a3b8' : '#64748b',
        textMuted: isDark ? '#64748b' : '#94a3b8',
        border: isDark ? '#334155' : '#e2e8f0',
        borderLight: isDark ? '#475569' : '#d1d5db',
        cardShadow: isDark ? '0 1px 3px rgba(0,0,0,0.3)' : '0 1px 3px rgba(0,0,0,0.1)',
        modalOverlay: isDark ? 'rgba(0,0,0,0.7)' : 'rgba(0,0,0,0.5)',
        loadingOverlay: isDark ? 'rgba(15,23,42,0.8)' : 'rgba(255,255,255,0.7)',
        inputBg: isDark ? '#1e293b' : 'white',
        rowHoverBg: isDark ? '#334155' : '#f8fafc',
        btnViewBg: isDark ? '#1e3a8a' : '#dbeafe',
        btnViewText: isDark ? '#93c5fd' : '#2563eb',
        btnViewBorder: isDark ? '#3b82f6' : '#bfdbfe',
        btnEditBg: isDark ? '#064e3b' : '#d1fae5',
        btnEditText: isDark ? '#6ee7b7' : '#059669',
        btnEditBorder: isDark ? '#059669' : '#a7f3d0',
        btnDeleteBg: isDark ? '#7f1d1d' : '#fee2e2',
        btnDeleteText: isDark ? '#fca5a5' : '#dc2626',
        btnDeleteBorder: isDark ? '#dc2626' : '#fecaca',
        btnAddVehicleBg: isDark ? '#4c1d95' : '#f3e8ff',
        btnAddVehicleText: isDark ? '#c4b5fd' : '#7c3aed',
        btnAddVehicleBorder: isDark ? '#6d28d9' : '#ddd6fe',
        btnLoyaltyBg: isDark ? '#713f12' : '#fef3c7',
        btnLoyaltyText: isDark ? '#fcd34d' : '#d97706',
        btnLoyaltyBorder: isDark ? '#d97706' : '#fde68a',
    };

    const [formData, setFormData] = useState({
        name: '',
        phone: '',
        email: '',
        address: '',
        notes: ''
    });

    const [vehicleFormData, setVehicleFormData] = useState({
        plateNumber: '',
        make: '',
        model: '',
        color: '',
        year: '',
        nextServiceDate: ''
    });

    const [settingsFormData, setSettingsFormData] = useState({
        pointsPerVisit: 1,
        pointsPerRand: 0.1,
        redeemRate: 0.1,
        welcomeBonus: 10,
        birthdayBonus: 50,
        enabled: true
    });

    // Subscribe to customers data
    useEffect(() => {
        const services = window.FirebaseServices;
        if (!services?.customerService) return;
        const unsubscribe = services.customerService.subscribeToCustomers(
            (data) => {
                setCustomers(data);
                setLoading(false);
            },
            (err) => {
                setError('Failed to load customers');
                setLoading(false);
            }
        );
        return () => unsubscribe();
    }, []);

    // Subscribe to loyalty settings
    useEffect(() => {
        const services = window.FirebaseServices;
        if (!services?.loyaltySettingsService) return;
        const unsubscribe = services.loyaltySettingsService.subscribeToSettings(
            (settings) => {
                if (settings) {
                    setLoyaltySettings(settings);
                    setSettingsFormData(settings);
                }
            },
            (err) => {
                console.error('Failed to load loyalty settings', err);
            }
        );
        return () => unsubscribe();
    }, []);

    // Filter customers based on search
    const filteredCustomers = customers.filter(customer => {
        const query = searchQuery.toLowerCase();
        const nameMatch = customer.name?.toLowerCase().includes(query);
        const phoneMatch = customer.phone?.toLowerCase().includes(query);
        const emailMatch = customer.email?.toLowerCase().includes(query);
        const plateMatch = customer.vehicles?.some(v => v.plateNumber?.toLowerCase().includes(query));
        return nameMatch || phoneMatch || emailMatch || plateMatch;
    });

    // Reset form data
    const resetFormData = () => {
        setFormData({ name: '', phone: '', email: '', address: '', notes: '' });
    };

    const resetVehicleFormData = () => {
        setVehicleFormData({ plateNumber: '', make: '', model: '', color: '', year: '', nextServiceDate: '' });
    };

    // Get vehicles due for service (within 7 days or overdue)
    const getServiceReminders = () => {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const weekFromNow = new Date(today);
        weekFromNow.setDate(weekFromNow.getDate() + 7);
        
        const reminders = [];
        customers.forEach(customer => {
            customer.vehicles?.forEach(vehicle => {
                if (vehicle.nextServiceDate) {
                    const serviceDate = new Date(vehicle.nextServiceDate);
                    if (serviceDate <= weekFromNow) {
                        reminders.push({
                            customer,
                            vehicle,
                            dueDate: serviceDate,
                            isOverdue: serviceDate < today,
                            daysUntil: Math.ceil((serviceDate - today) / (1000 * 60 * 60 * 24))
                        });
                    }
                }
            });
        });
        return reminders.sort((a, b) => a.dueDate - b.dueDate);
    };

    // Generate receipt for a service
    const generateReceipt = (customer, vehicle, service) => {
        const receiptNumber = 'RCP-' + Date.now().toString(36).toUpperCase();
        const receipt = {
            receiptNumber,
            date: new Date().toISOString(),
            customer: {
                name: customer.name,
                phone: customer.phone,
                email: customer.email
            },
            vehicle: {
                plateNumber: vehicle?.plateNumber || 'N/A',
                make: vehicle?.make || '',
                model: vehicle?.model || '',
                color: vehicle?.color || ''
            },
            service: service || { name: 'Car Wash Service', price: 0 },
            pointsEarned: loyaltySettings.enabled ? loyaltySettings.pointsPerVisit : 0,
            totalPoints: (customer.loyaltyPoints || 0) + (loyaltySettings.enabled ? loyaltySettings.pointsPerVisit : 0)
        };
        setReceiptData(receipt);
        setShowReceiptModal(true);
    };

    // Print receipt
    const handlePrintReceipt = () => {
        const printContent = document.getElementById('receipt-content');
        const printWindow = window.open('', '', 'width=400,height=600');
        printWindow.document.write(`
            <html>
            <head>
                <title>Receipt - ${receiptData?.receiptNumber}</title>
                <style>
                    body { font-family: 'Courier New', monospace; padding: 20px; max-width: 300px; margin: 0 auto; }
                    .header { text-align: center; border-bottom: 2px dashed #000; padding-bottom: 10px; margin-bottom: 15px; }
                    .company { font-size: 20px; font-weight: bold; }
                    .tagline { font-size: 11px; color: #666; }
                    .section { margin: 15px 0; }
                    .row { display: flex; justify-content: space-between; margin: 5px 0; font-size: 12px; }
                    .label { color: #666; }
                    .value { font-weight: 500; text-align: right; }
                    .divider { border-top: 1px dashed #ccc; margin: 15px 0; }
                    .total-row { font-size: 16px; font-weight: bold; margin-top: 10px; }
                    .footer { text-align: center; margin-top: 20px; font-size: 11px; color: #666; border-top: 2px dashed #000; padding-top: 10px; }
                    .points { background: #f5f5f5; padding: 10px; text-align: center; margin-top: 15px; }
                    @media print { body { padding: 0; } }
                </style>
            </head>
            <body>
                ${printContent.innerHTML}
            </body>
            </html>
        `);
        printWindow.document.close();
        printWindow.focus();
        setTimeout(() => {
            printWindow.print();
            printWindow.close();
        }, 250);
    };

    // Handle add customer
    const handleAddCustomer = async () => {
        if (!formData.name || !formData.phone) {
            setError('Name and phone are required');
            return;
        }
        setActionLoading(true);
        try {
            const services = window.FirebaseServices;
            await services.customerService.addCustomer({
                ...formData,
                vehicles: [],
                loyaltyPoints: loyaltySettings.enabled ? loyaltySettings.welcomeBonus : 0,
                totalVisits: 0,
                totalSpent: 0
            });
            setShowAddModal(false);
            resetFormData();
        } catch (err) {
            setError('Failed to add customer');
        }
        setActionLoading(false);
    };

    // Handle edit customer
    const handleEditCustomer = async () => {
        if (!formData.name || !formData.phone) {
            setError('Name and phone are required');
            return;
        }
        setActionLoading(true);
        try {
            const services = window.FirebaseServices;
            await services.customerService.updateCustomer(selectedCustomer.id, formData);
            setShowEditModal(false);
            setSelectedCustomer(null);
            resetFormData();
        } catch (err) {
            setError('Failed to update customer');
        }
        setActionLoading(false);
    };

    // Handle delete customer
    const handleDeleteCustomer = async (customerId) => {
        if (!confirm('Are you sure you want to delete this customer?')) return;
        setActionLoading(true);
        try {
            const services = window.FirebaseServices;
            await services.customerService.deleteCustomer(customerId);
        } catch (err) {
            setError('Failed to delete customer');
        }
        setActionLoading(false);
    };

    // Handle add vehicle to customer
    const handleAddVehicle = async () => {
        if (!vehicleFormData.plateNumber) {
            setError('Plate number is required');
            return;
        }
        setActionLoading(true);
        try {
            const services = window.FirebaseServices;
            await services.customerService.addVehicleToCustomer(selectedCustomer.id, vehicleFormData);
            setShowAddVehicleModal(false);
            resetVehicleFormData();
            // Refresh selected customer
            const updated = customers.find(c => c.id === selectedCustomer.id);
            if (updated) setSelectedCustomer(updated);
        } catch (err) {
            setError('Failed to add vehicle');
        }
        setActionLoading(false);
    };

    // Handle remove vehicle from customer
    const handleRemoveVehicle = async (plateNumber) => {
        if (!confirm('Are you sure you want to remove this vehicle?')) return;
        setActionLoading(true);
        try {
            const services = window.FirebaseServices;
            await services.customerService.removeVehicleFromCustomer(selectedCustomer.id, plateNumber);
            // Refresh selected customer
            const updated = customers.find(c => c.id === selectedCustomer.id);
            if (updated) setSelectedCustomer(updated);
        } catch (err) {
            setError('Failed to remove vehicle');
        }
        setActionLoading(false);
    };

    // Handle save loyalty settings
    const handleSaveLoyaltySettings = async () => {
        setActionLoading(true);
        try {
            const services = window.FirebaseServices;
            await services.loyaltySettingsService.updateSettings(settingsFormData);
            setShowLoyaltySettingsModal(false);
        } catch (err) {
            setError('Failed to save settings');
        }
        setActionLoading(false);
    };

    // Open edit modal
    const openEditModal = (customer) => {
        setSelectedCustomer(customer);
        setFormData({
            name: customer.name || '',
            phone: customer.phone || '',
            email: customer.email || '',
            address: customer.address || '',
            notes: customer.notes || ''
        });
        setShowEditModal(true);
    };

    // Open view modal
    const openViewModal = (customer) => {
        setSelectedCustomer(customer);
        setShowViewModal(true);
    };

    // Open add vehicle modal
    const openAddVehicleModal = (customer) => {
        setSelectedCustomer(customer);
        resetVehicleFormData();
        setShowAddVehicleModal(true);
    };

    // Input style
    const inputStyle = {
        width: '100%',
        padding: '10px 12px',
        border: `1px solid ${theme.border}`,
        fontSize: '14px',
        backgroundColor: theme.inputBg,
        color: theme.text,
        outline: 'none'
    };

    // Label style
    const labelStyle = {
        display: 'block',
        marginBottom: '6px',
        fontSize: '13px',
        fontWeight: '500',
        color: theme.textSecondary
    };

    if (loading) {
        return (
            <div style={{ padding: '40px', textAlign: 'center', color: theme.textSecondary }}>
                <div style={{ fontSize: '18px' }}>Loading customers...</div>
            </div>
        );
    }

    return (
        <div style={{ padding: '20px', backgroundColor: theme.bgSecondary, minHeight: '100%' }}>
            {/* Error message */}
            {error && (
                <div style={{ padding: '12px 16px', backgroundColor: '#fee2e2', color: '#dc2626', marginBottom: '20px', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <span>{error}</span>
                    <button onClick={() => setError(null)} style={{ background: 'none', border: 'none', color: '#dc2626', cursor: 'pointer', fontSize: '18px' }}>√ó</button>
                </div>
            )}

            {/* Tabs */}
            <div style={{ display: 'flex', gap: '0', marginBottom: '20px', borderBottom: `2px solid ${theme.border}` }}>
                <button
                    onClick={() => setActiveTab('customers')}
                    style={{ padding: '12px 24px', backgroundColor: 'transparent', color: activeTab === 'customers' ? '#3b82f6' : theme.textSecondary, border: 'none', borderBottom: activeTab === 'customers' ? '2px solid #3b82f6' : '2px solid transparent', marginBottom: '-2px', cursor: 'pointer', fontSize: '14px', fontWeight: '500' }}
                >
                    üë• Customers
                </button>
                <button
                    onClick={() => setActiveTab('reminders')}
                    style={{ padding: '12px 24px', backgroundColor: 'transparent', color: activeTab === 'reminders' ? '#3b82f6' : theme.textSecondary, border: 'none', borderBottom: activeTab === 'reminders' ? '2px solid #3b82f6' : '2px solid transparent', marginBottom: '-2px', cursor: 'pointer', fontSize: '14px', fontWeight: '500', display: 'flex', alignItems: 'center', gap: '8px' }}
                >
                    üîî Service Reminders
                    {getServiceReminders().length > 0 && (
                        <span style={{ backgroundColor: '#ef4444', color: 'white', padding: '2px 8px', fontSize: '11px', fontWeight: '600' }}>{getServiceReminders().length}</span>
                    )}
                </button>
            </div>

            {/* Header with search and actions */}
            {activeTab === 'customers' && (
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px', flexWrap: 'wrap', gap: '15px' }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: '15px', flex: 1 }}>
                    <div style={{ position: 'relative', flex: 1, maxWidth: '400px' }}>
                        <input
                            type="text"
                            placeholder="Search by name, phone, or plate number..."
                            value={searchQuery}
                            onChange={(e) => setSearchQuery(e.target.value)}
                            style={{ ...inputStyle, paddingLeft: '40px' }}
                        />
                        <span style={{ position: 'absolute', left: '12px', top: '50%', transform: 'translateY(-50%)', color: theme.textMuted }}>üîç</span>
                    </div>
                </div>
                <div style={{ display: 'flex', gap: '10px' }}>
                    <button
                        onClick={() => setShowLoyaltySettingsModal(true)}
                        style={{ padding: '10px 16px', backgroundColor: theme.btnLoyaltyBg, color: theme.btnLoyaltyText, border: `1px solid ${theme.btnLoyaltyBorder}`, cursor: 'pointer', fontSize: '14px', fontWeight: '500', display: 'flex', alignItems: 'center', gap: '6px' }}
                    >
                        ‚öôÔ∏è Loyalty Settings
                    </button>
                    <button
                        onClick={() => { resetFormData(); setShowAddModal(true); }}
                        style={{ padding: '10px 20px', backgroundColor: '#3b82f6', color: 'white', border: 'none', cursor: 'pointer', fontSize: '14px', fontWeight: '500', display: 'flex', alignItems: 'center', gap: '6px' }}
                    >
                        + Add Customer
                    </button>
                </div>
            </div>
            )}

            {/* Stats Cards */}
            {activeTab === 'customers' && (
            <>
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '15px', marginBottom: '20px' }}>
                <div style={{ backgroundColor: theme.bg, padding: '20px', boxShadow: theme.cardShadow, border: `1px solid ${theme.border}` }}>
                    <div style={{ fontSize: '13px', color: theme.textSecondary, marginBottom: '8px' }}>Total Customers</div>
                    <div style={{ fontSize: '28px', fontWeight: '600', color: theme.text }}>{customers.length}</div>
                </div>
                <div style={{ backgroundColor: theme.bg, padding: '20px', boxShadow: theme.cardShadow, border: `1px solid ${theme.border}` }}>
                    <div style={{ fontSize: '13px', color: theme.textSecondary, marginBottom: '8px' }}>Total Vehicles</div>
                    <div style={{ fontSize: '28px', fontWeight: '600', color: theme.text }}>{customers.reduce((sum, c) => sum + (c.vehicles?.length || 0), 0)}</div>
                </div>
                <div style={{ backgroundColor: theme.bg, padding: '20px', boxShadow: theme.cardShadow, border: `1px solid ${theme.border}` }}>
                    <div style={{ fontSize: '13px', color: theme.textSecondary, marginBottom: '8px' }}>Total Visits</div>
                    <div style={{ fontSize: '28px', fontWeight: '600', color: theme.text }}>{customers.reduce((sum, c) => sum + (c.totalVisits || 0), 0)}</div>
                </div>
                <div style={{ backgroundColor: theme.bg, padding: '20px', boxShadow: theme.cardShadow, border: `1px solid ${theme.border}` }}>
                    <div style={{ fontSize: '13px', color: theme.textSecondary, marginBottom: '8px' }}>Total Points Issued</div>
                    <div style={{ fontSize: '28px', fontWeight: '600', color: '#f59e0b' }}>{customers.reduce((sum, c) => sum + (c.loyaltyPoints || 0), 0)}</div>
                </div>
            </div>

            {/* Customers Table */}
            <div style={{ backgroundColor: theme.bg, boxShadow: theme.cardShadow, border: `1px solid ${theme.border}`, overflow: 'hidden' }}>
                <div style={{ overflowX: 'auto' }}>
                    <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                        <thead>
                            <tr style={{ backgroundColor: theme.bgTertiary }}>
                                <th style={{ padding: '14px 16px', textAlign: 'left', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase', letterSpacing: '0.5px', borderBottom: `1px solid ${theme.border}` }}>Customer</th>
                                <th style={{ padding: '14px 16px', textAlign: 'left', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase', letterSpacing: '0.5px', borderBottom: `1px solid ${theme.border}` }}>Phone</th>
                                <th style={{ padding: '14px 16px', textAlign: 'left', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase', letterSpacing: '0.5px', borderBottom: `1px solid ${theme.border}` }}>Vehicles</th>
                                <th style={{ padding: '14px 16px', textAlign: 'center', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase', letterSpacing: '0.5px', borderBottom: `1px solid ${theme.border}` }}>Visits</th>
                                <th style={{ padding: '14px 16px', textAlign: 'center', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase', letterSpacing: '0.5px', borderBottom: `1px solid ${theme.border}` }}>Points</th>
                                <th style={{ padding: '14px 16px', textAlign: 'center', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase', letterSpacing: '0.5px', borderBottom: `1px solid ${theme.border}` }}>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {filteredCustomers.length === 0 ? (
                                <tr>
                                    <td colSpan="6" style={{ padding: '40px', textAlign: 'center', color: theme.textMuted }}>
                                        {searchQuery ? 'No customers found matching your search' : 'No customers yet. Add your first customer!'}
                                    </td>
                                </tr>
                            ) : (
                                filteredCustomers.map(customer => (
                                    <tr key={customer.id} style={{ borderBottom: `1px solid ${theme.border}` }}>
                                        <td style={{ padding: '14px 16px' }}>
                                            <div style={{ fontWeight: '500', color: theme.text }}>{customer.name}</div>
                                            {customer.email && <div style={{ fontSize: '12px', color: theme.textMuted }}>{customer.email}</div>}
                                        </td>
                                        <td style={{ padding: '14px 16px', color: theme.text }}>{customer.phone}</td>
                                        <td style={{ padding: '14px 16px' }}>
                                            <div style={{ display: 'flex', flexWrap: 'wrap', gap: '6px' }}>
                                                {customer.vehicles?.length > 0 ? (
                                                    customer.vehicles.map((v, idx) => (
                                                        <span key={idx} style={{ padding: '4px 8px', backgroundColor: theme.bgTertiary, fontSize: '12px', fontWeight: '500', color: theme.text, border: `1px solid ${theme.border}` }}>
                                                            {v.plateNumber}
                                                        </span>
                                                    ))
                                                ) : (
                                                    <span style={{ color: theme.textMuted, fontSize: '13px' }}>No vehicles</span>
                                                )}
                                            </div>
                                        </td>
                                        <td style={{ padding: '14px 16px', textAlign: 'center', fontWeight: '500', color: theme.text }}>{customer.totalVisits || 0}</td>
                                        <td style={{ padding: '14px 16px', textAlign: 'center' }}>
                                            <span style={{ padding: '4px 10px', backgroundColor: '#fef3c7', color: '#d97706', fontSize: '13px', fontWeight: '600' }}>
                                                {customer.loyaltyPoints || 0} pts
                                            </span>
                                        </td>
                                        <td style={{ padding: '14px 16px', textAlign: 'center' }}>
                                            <div style={{ display: 'flex', justifyContent: 'center', gap: '8px', flexWrap: 'wrap' }}>
                                                <button onClick={() => openViewModal(customer)} style={{ padding: '6px 12px', backgroundColor: theme.btnViewBg, color: theme.btnViewText, border: `1px solid ${theme.btnViewBorder}`, cursor: 'pointer', fontSize: '12px', fontWeight: '500' }}>View</button>
                                                <button onClick={() => openEditModal(customer)} style={{ padding: '6px 12px', backgroundColor: theme.btnEditBg, color: theme.btnEditText, border: `1px solid ${theme.btnEditBorder}`, cursor: 'pointer', fontSize: '12px', fontWeight: '500' }}>Edit</button>
                                                <button onClick={() => openAddVehicleModal(customer)} style={{ padding: '6px 12px', backgroundColor: theme.btnAddVehicleBg, color: theme.btnAddVehicleText, border: `1px solid ${theme.btnAddVehicleBorder}`, cursor: 'pointer', fontSize: '12px', fontWeight: '500' }}>+ Car</button>
                                                <button onClick={() => generateReceipt(customer, customer.vehicles?.[0], { name: 'Service', price: 0 })} style={{ padding: '6px 12px', backgroundColor: theme.btnLoyaltyBg, color: theme.btnLoyaltyText, border: `1px solid ${theme.btnLoyaltyBorder}`, cursor: 'pointer', fontSize: '12px', fontWeight: '500' }}>üßæ</button>
                                                <button onClick={() => handleDeleteCustomer(customer.id)} style={{ padding: '6px 12px', backgroundColor: theme.btnDeleteBg, color: theme.btnDeleteText, border: `1px solid ${theme.btnDeleteBorder}`, cursor: 'pointer', fontSize: '12px', fontWeight: '500' }}>Delete</button>
                                            </div>
                                        </td>
                                    </tr>
                                ))
                            )}
                        </tbody>
                    </table>
                </div>
            </div>
            </>
            )}

            {/* Service Reminders Tab */}
            {activeTab === 'reminders' && (
                <div>
                    <div style={{ marginBottom: '20px' }}>
                        <h3 style={{ margin: '0 0 8px 0', fontSize: '16px', fontWeight: '600', color: theme.text }}>Upcoming Service Reminders</h3>
                        <p style={{ margin: 0, fontSize: '13px', color: theme.textMuted }}>Vehicles due for service within the next 7 days</p>
                    </div>
                    
                    {getServiceReminders().length === 0 ? (
                        <div style={{ backgroundColor: theme.bg, padding: '60px 20px', textAlign: 'center', border: `1px solid ${theme.border}` }}>
                            <div style={{ fontSize: '48px', marginBottom: '16px' }}>‚úÖ</div>
                            <div style={{ fontSize: '16px', fontWeight: '500', color: theme.text, marginBottom: '8px' }}>No Upcoming Reminders</div>
                            <div style={{ fontSize: '13px', color: theme.textMuted }}>All vehicles are up to date with their service schedules</div>
                        </div>
                    ) : (
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                            {getServiceReminders().map((reminder, idx) => (
                                <div key={idx} style={{ backgroundColor: theme.bg, padding: '20px', border: `1px solid ${reminder.isOverdue ? '#fecaca' : theme.border}`, borderLeft: `4px solid ${reminder.isOverdue ? '#ef4444' : '#f59e0b'}` }}>
                                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', flexWrap: 'wrap', gap: '15px' }}>
                                        <div style={{ flex: 1 }}>
                                            <div style={{ display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '8px' }}>
                                                <span style={{ padding: '4px 10px', backgroundColor: reminder.isOverdue ? '#fee2e2' : '#fef3c7', color: reminder.isOverdue ? '#dc2626' : '#d97706', fontSize: '12px', fontWeight: '600' }}>
                                                    {reminder.isOverdue ? 'OVERDUE' : `Due in ${reminder.daysUntil} day${reminder.daysUntil !== 1 ? 's' : ''}`}
                                                </span>
                                                <span style={{ fontSize: '13px', color: theme.textMuted }}>{new Date(reminder.dueDate).toLocaleDateString()}</span>
                                            </div>
                                            <div style={{ fontWeight: '600', fontSize: '16px', color: theme.text, marginBottom: '4px' }}>{reminder.vehicle.plateNumber}</div>
                                            <div style={{ fontSize: '13px', color: theme.textSecondary, marginBottom: '8px' }}>
                                                {[reminder.vehicle.make, reminder.vehicle.model, reminder.vehicle.year].filter(Boolean).join(' ') || 'Vehicle'}
                                            </div>
                                            <div style={{ fontSize: '13px', color: theme.textMuted }}>
                                                Owner: <span style={{ color: theme.text, fontWeight: '500' }}>{reminder.customer.name}</span> ‚Ä¢ {reminder.customer.phone}
                                            </div>
                                        </div>
                                        <div style={{ display: 'flex', gap: '8px' }}>
                                            <button onClick={() => { window.location.href = `tel:${reminder.customer.phone}`; }} style={{ padding: '8px 16px', backgroundColor: '#3b82f6', color: 'white', border: 'none', cursor: 'pointer', fontSize: '13px', fontWeight: '500' }}>üìû Call</button>
                                            <button onClick={() => openViewModal(reminder.customer)} style={{ padding: '8px 16px', backgroundColor: theme.btnViewBg, color: theme.btnViewText, border: `1px solid ${theme.btnViewBorder}`, cursor: 'pointer', fontSize: '13px', fontWeight: '500' }}>View Customer</button>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            )}

            {/* Add Customer Modal */}
            {showAddModal && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: theme.modalOverlay, display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000, padding: '20px' }}>
                    <div style={{ backgroundColor: theme.bg, width: '100%', maxWidth: '500px', maxHeight: '90vh', overflow: 'auto', boxShadow: '0 25px 50px -12px rgba(0,0,0,0.25)' }}>
                        <div style={{ padding: '20px', borderBottom: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <h2 style={{ margin: 0, fontSize: '18px', fontWeight: '600', color: theme.text }}>Add New Customer</h2>
                            <button onClick={() => setShowAddModal(false)} style={{ background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer', color: theme.textMuted }}>√ó</button>
                        </div>
                        <div style={{ padding: '20px' }}>
                            <div style={{ marginBottom: '16px' }}>
                                <label style={labelStyle}>Name *</label>
                                <input type="text" value={formData.name} onChange={(e) => setFormData({...formData, name: e.target.value})} style={inputStyle} placeholder="Customer name" />
                            </div>
                            <div style={{ marginBottom: '16px' }}>
                                <label style={labelStyle}>Phone *</label>
                                <input type="tel" value={formData.phone} onChange={(e) => setFormData({...formData, phone: e.target.value})} style={inputStyle} placeholder="Phone number" />
                            </div>
                            <div style={{ marginBottom: '16px' }}>
                                <label style={labelStyle}>Email</label>
                                <input type="email" value={formData.email} onChange={(e) => setFormData({...formData, email: e.target.value})} style={inputStyle} placeholder="Email address" />
                            </div>
                            <div style={{ marginBottom: '16px' }}>
                                <label style={labelStyle}>Address</label>
                                <input type="text" value={formData.address} onChange={(e) => setFormData({...formData, address: e.target.value})} style={inputStyle} placeholder="Address" />
                            </div>
                            <div style={{ marginBottom: '16px' }}>
                                <label style={labelStyle}>Notes</label>
                                <textarea value={formData.notes} onChange={(e) => setFormData({...formData, notes: e.target.value})} style={{ ...inputStyle, minHeight: '80px', resize: 'vertical' }} placeholder="Additional notes..." />
                            </div>
                        </div>
                        <div style={{ padding: '20px', borderTop: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'flex-end', gap: '10px' }}>
                            <button onClick={() => setShowAddModal(false)} style={{ padding: '10px 20px', backgroundColor: theme.bgTertiary, color: theme.text, border: `1px solid ${theme.border}`, cursor: 'pointer', fontSize: '14px' }}>Cancel</button>
                            <button onClick={handleAddCustomer} disabled={actionLoading} style={{ padding: '10px 20px', backgroundColor: '#3b82f6', color: 'white', border: 'none', cursor: 'pointer', fontSize: '14px', fontWeight: '500', opacity: actionLoading ? 0.7 : 1 }}>
                                {actionLoading ? 'Adding...' : 'Add Customer'}
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* Edit Customer Modal */}
            {showEditModal && selectedCustomer && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: theme.modalOverlay, display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000, padding: '20px' }}>
                    <div style={{ backgroundColor: theme.bg, width: '100%', maxWidth: '500px', maxHeight: '90vh', overflow: 'auto', boxShadow: '0 25px 50px -12px rgba(0,0,0,0.25)' }}>
                        <div style={{ padding: '20px', borderBottom: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <h2 style={{ margin: 0, fontSize: '18px', fontWeight: '600', color: theme.text }}>Edit Customer</h2>
                            <button onClick={() => setShowEditModal(false)} style={{ background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer', color: theme.textMuted }}>√ó</button>
                        </div>
                        <div style={{ padding: '20px' }}>
                            <div style={{ marginBottom: '16px' }}>
                                <label style={labelStyle}>Name *</label>
                                <input type="text" value={formData.name} onChange={(e) => setFormData({...formData, name: e.target.value})} style={inputStyle} placeholder="Customer name" />
                            </div>
                            <div style={{ marginBottom: '16px' }}>
                                <label style={labelStyle}>Phone *</label>
                                <input type="tel" value={formData.phone} onChange={(e) => setFormData({...formData, phone: e.target.value})} style={inputStyle} placeholder="Phone number" />
                            </div>
                            <div style={{ marginBottom: '16px' }}>
                                <label style={labelStyle}>Email</label>
                                <input type="email" value={formData.email} onChange={(e) => setFormData({...formData, email: e.target.value})} style={inputStyle} placeholder="Email address" />
                            </div>
                            <div style={{ marginBottom: '16px' }}>
                                <label style={labelStyle}>Address</label>
                                <input type="text" value={formData.address} onChange={(e) => setFormData({...formData, address: e.target.value})} style={inputStyle} placeholder="Address" />
                            </div>
                            <div style={{ marginBottom: '16px' }}>
                                <label style={labelStyle}>Notes</label>
                                <textarea value={formData.notes} onChange={(e) => setFormData({...formData, notes: e.target.value})} style={{ ...inputStyle, minHeight: '80px', resize: 'vertical' }} placeholder="Additional notes..." />
                            </div>
                        </div>
                        <div style={{ padding: '20px', borderTop: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'flex-end', gap: '10px' }}>
                            <button onClick={() => setShowEditModal(false)} style={{ padding: '10px 20px', backgroundColor: theme.bgTertiary, color: theme.text, border: `1px solid ${theme.border}`, cursor: 'pointer', fontSize: '14px' }}>Cancel</button>
                            <button onClick={handleEditCustomer} disabled={actionLoading} style={{ padding: '10px 20px', backgroundColor: '#3b82f6', color: 'white', border: 'none', cursor: 'pointer', fontSize: '14px', fontWeight: '500', opacity: actionLoading ? 0.7 : 1 }}>
                                {actionLoading ? 'Saving...' : 'Save Changes'}
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* View Customer Modal */}
            {showViewModal && selectedCustomer && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: theme.modalOverlay, display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000, padding: '20px' }}>
                    <div style={{ backgroundColor: theme.bg, width: '100%', maxWidth: '600px', maxHeight: '90vh', overflow: 'auto', boxShadow: '0 25px 50px -12px rgba(0,0,0,0.25)' }}>
                        <div style={{ padding: '20px', borderBottom: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <h2 style={{ margin: 0, fontSize: '18px', fontWeight: '600', color: theme.text }}>Customer Details</h2>
                            <button onClick={() => setShowViewModal(false)} style={{ background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer', color: theme.textMuted }}>√ó</button>
                        </div>
                        <div style={{ padding: '20px' }}>
                            {/* Customer Info */}
                            <div style={{ marginBottom: '24px' }}>
                                <h3 style={{ fontSize: '14px', fontWeight: '600', color: theme.textSecondary, marginBottom: '12px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Customer Information</h3>
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px' }}>
                                    <div>
                                        <div style={{ fontSize: '12px', color: theme.textMuted, marginBottom: '4px' }}>Name</div>
                                        <div style={{ fontSize: '14px', color: theme.text, fontWeight: '500' }}>{selectedCustomer.name}</div>
                                    </div>
                                    <div>
                                        <div style={{ fontSize: '12px', color: theme.textMuted, marginBottom: '4px' }}>Phone</div>
                                        <div style={{ fontSize: '14px', color: theme.text }}>{selectedCustomer.phone}</div>
                                    </div>
                                    <div>
                                        <div style={{ fontSize: '12px', color: theme.textMuted, marginBottom: '4px' }}>Email</div>
                                        <div style={{ fontSize: '14px', color: theme.text }}>{selectedCustomer.email || '-'}</div>
                                    </div>
                                    <div>
                                        <div style={{ fontSize: '12px', color: theme.textMuted, marginBottom: '4px' }}>Address</div>
                                        <div style={{ fontSize: '14px', color: theme.text }}>{selectedCustomer.address || '-'}</div>
                                    </div>
                                </div>
                                {selectedCustomer.notes && (
                                    <div style={{ marginTop: '16px' }}>
                                        <div style={{ fontSize: '12px', color: theme.textMuted, marginBottom: '4px' }}>Notes</div>
                                        <div style={{ fontSize: '14px', color: theme.text }}>{selectedCustomer.notes}</div>
                                    </div>
                                )}
                            </div>

                            {/* Loyalty Stats */}
                            <div style={{ marginBottom: '24px' }}>
                                <h3 style={{ fontSize: '14px', fontWeight: '600', color: theme.textSecondary, marginBottom: '12px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Loyalty & Visits</h3>
                                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '12px' }}>
                                    <div style={{ backgroundColor: theme.bgTertiary, padding: '16px', textAlign: 'center' }}>
                                        <div style={{ fontSize: '24px', fontWeight: '600', color: '#f59e0b' }}>{selectedCustomer.loyaltyPoints || 0}</div>
                                        <div style={{ fontSize: '12px', color: theme.textMuted }}>Loyalty Points</div>
                                    </div>
                                    <div style={{ backgroundColor: theme.bgTertiary, padding: '16px', textAlign: 'center' }}>
                                        <div style={{ fontSize: '24px', fontWeight: '600', color: theme.text }}>{selectedCustomer.totalVisits || 0}</div>
                                        <div style={{ fontSize: '12px', color: theme.textMuted }}>Total Visits</div>
                                    </div>
                                    <div style={{ backgroundColor: theme.bgTertiary, padding: '16px', textAlign: 'center' }}>
                                        <div style={{ fontSize: '24px', fontWeight: '600', color: '#10b981' }}>KSh {(selectedCustomer.totalSpent || 0).toFixed(2)}</div>
                                        <div style={{ fontSize: '12px', color: theme.textMuted }}>Total Spent</div>
                                    </div>
                                </div>
                            </div>

                            {/* Vehicles */}
                            <div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
                                    <h3 style={{ fontSize: '14px', fontWeight: '600', color: theme.textSecondary, margin: 0, textTransform: 'uppercase', letterSpacing: '0.5px' }}>Vehicles ({selectedCustomer.vehicles?.length || 0})</h3>
                                    <button onClick={() => { setShowViewModal(false); openAddVehicleModal(selectedCustomer); }} style={{ padding: '6px 12px', backgroundColor: '#3b82f6', color: 'white', border: 'none', cursor: 'pointer', fontSize: '12px' }}>+ Add Vehicle</button>
                                </div>
                                {selectedCustomer.vehicles?.length > 0 ? (
                                    <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
                                        {selectedCustomer.vehicles.map((vehicle, idx) => {
                                            const isServiceDue = vehicle.nextServiceDate && new Date(vehicle.nextServiceDate) <= new Date();
                                            return (
                                            <div key={idx} style={{ backgroundColor: theme.bgTertiary, padding: '14px', border: `1px solid ${isServiceDue ? '#fecaca' : theme.border}`, borderLeft: isServiceDue ? '4px solid #ef4444' : `1px solid ${theme.border}` }}>
                                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                                                    <div style={{ flex: 1 }}>
                                                        <div style={{ fontWeight: '600', fontSize: '15px', color: theme.text, marginBottom: '4px' }}>{vehicle.plateNumber}</div>
                                                        <div style={{ fontSize: '13px', color: theme.textSecondary, marginBottom: '6px' }}>
                                                            {[vehicle.make, vehicle.model, vehicle.year, vehicle.color].filter(Boolean).join(' ‚Ä¢ ') || 'No details'}
                                                        </div>
                                                        {vehicle.nextServiceDate && (
                                                            <div style={{ fontSize: '12px', color: isServiceDue ? '#dc2626' : theme.textMuted }}>
                                                                üîß Next service: {new Date(vehicle.nextServiceDate).toLocaleDateString()}
                                                                {isServiceDue && <span style={{ marginLeft: '8px', padding: '2px 6px', backgroundColor: '#fee2e2', color: '#dc2626', fontSize: '10px', fontWeight: '600' }}>DUE</span>}
                                                            </div>
                                                        )}
                                                    </div>
                                                    <div style={{ display: 'flex', gap: '6px' }}>
                                                        <button onClick={() => generateReceipt(selectedCustomer, vehicle, { name: 'Car Wash', price: 0 })} style={{ padding: '6px 10px', backgroundColor: theme.btnLoyaltyBg, color: theme.btnLoyaltyText, border: `1px solid ${theme.btnLoyaltyBorder}`, cursor: 'pointer', fontSize: '12px' }}>üßæ</button>
                                                        <button onClick={() => handleRemoveVehicle(vehicle.plateNumber)} style={{ padding: '6px 10px', backgroundColor: theme.btnDeleteBg, color: theme.btnDeleteText, border: `1px solid ${theme.btnDeleteBorder}`, cursor: 'pointer', fontSize: '12px' }}>Remove</button>
                                                    </div>
                                                </div>
                                            </div>
                                        )})}
                                    </div>
                                ) : (
                                    <div style={{ padding: '30px', textAlign: 'center', color: theme.textMuted, backgroundColor: theme.bgTertiary }}>No vehicles registered</div>
                                )}
                            </div>
                        </div>
                        <div style={{ padding: '20px', borderTop: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'flex-end' }}>
                            <button onClick={() => setShowViewModal(false)} style={{ padding: '10px 20px', backgroundColor: '#3b82f6', color: 'white', border: 'none', cursor: 'pointer', fontSize: '14px', fontWeight: '500' }}>Close</button>
                        </div>
                    </div>
                </div>
            )}

            {/* Add Vehicle Modal */}
            {showAddVehicleModal && selectedCustomer && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: theme.modalOverlay, display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000, padding: '20px' }}>
                    <div style={{ backgroundColor: theme.bg, width: '100%', maxWidth: '450px', maxHeight: '90vh', overflow: 'auto', boxShadow: '0 25px 50px -12px rgba(0,0,0,0.25)' }}>
                        <div style={{ padding: '20px', borderBottom: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <div>
                                <h2 style={{ margin: 0, fontSize: '18px', fontWeight: '600', color: theme.text }}>Add Vehicle</h2>
                                <div style={{ fontSize: '13px', color: theme.textMuted, marginTop: '4px' }}>For: {selectedCustomer.name}</div>
                            </div>
                            <button onClick={() => setShowAddVehicleModal(false)} style={{ background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer', color: theme.textMuted }}>√ó</button>
                        </div>
                        <div style={{ padding: '20px' }}>
                            <div style={{ marginBottom: '16px' }}>
                                <label style={labelStyle}>Plate Number *</label>
                                <input type="text" value={vehicleFormData.plateNumber} onChange={(e) => setVehicleFormData({...vehicleFormData, plateNumber: e.target.value.toUpperCase()})} style={inputStyle} placeholder="e.g., CA 123-456" />
                            </div>
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px' }}>
                                <div style={{ marginBottom: '16px' }}>
                                    <label style={labelStyle}>Make</label>
                                    <input type="text" value={vehicleFormData.make} onChange={(e) => setVehicleFormData({...vehicleFormData, make: e.target.value})} style={inputStyle} placeholder="e.g., Toyota" />
                                </div>
                                <div style={{ marginBottom: '16px' }}>
                                    <label style={labelStyle}>Model</label>
                                    <input type="text" value={vehicleFormData.model} onChange={(e) => setVehicleFormData({...vehicleFormData, model: e.target.value})} style={inputStyle} placeholder="e.g., Corolla" />
                                </div>
                            </div>
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px' }}>
                                <div style={{ marginBottom: '16px' }}>
                                    <label style={labelStyle}>Year</label>
                                    <input type="text" value={vehicleFormData.year} onChange={(e) => setVehicleFormData({...vehicleFormData, year: e.target.value})} style={inputStyle} placeholder="e.g., 2022" />
                                </div>
                                <div style={{ marginBottom: '16px' }}>
                                    <label style={labelStyle}>Color</label>
                                    <input type="text" value={vehicleFormData.color} onChange={(e) => setVehicleFormData({...vehicleFormData, color: e.target.value})} style={inputStyle} placeholder="e.g., White" />
                                </div>
                            </div>
                            <div style={{ marginBottom: '16px' }}>
                                <label style={labelStyle}>Next Service Date</label>
                                <input type="date" value={vehicleFormData.nextServiceDate} onChange={(e) => setVehicleFormData({...vehicleFormData, nextServiceDate: e.target.value})} style={inputStyle} />
                                <div style={{ fontSize: '11px', color: theme.textMuted, marginTop: '4px' }}>Set a reminder for the next service</div>
                            </div>
                        </div>
                        <div style={{ padding: '20px', borderTop: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'flex-end', gap: '10px' }}>
                            <button onClick={() => setShowAddVehicleModal(false)} style={{ padding: '10px 20px', backgroundColor: theme.bgTertiary, color: theme.text, border: `1px solid ${theme.border}`, cursor: 'pointer', fontSize: '14px' }}>Cancel</button>
                            <button onClick={handleAddVehicle} disabled={actionLoading} style={{ padding: '10px 20px', backgroundColor: '#3b82f6', color: 'white', border: 'none', cursor: 'pointer', fontSize: '14px', fontWeight: '500', opacity: actionLoading ? 0.7 : 1 }}>
                                {actionLoading ? 'Adding...' : 'Add Vehicle'}
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* Loyalty Settings Modal */}
            {showLoyaltySettingsModal && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: theme.modalOverlay, display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000, padding: '20px' }}>
                    <div style={{ backgroundColor: theme.bg, width: '100%', maxWidth: '450px', maxHeight: '90vh', overflow: 'auto', boxShadow: '0 25px 50px -12px rgba(0,0,0,0.25)' }}>
                        <div style={{ padding: '20px', borderBottom: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <h2 style={{ margin: 0, fontSize: '18px', fontWeight: '600', color: theme.text }}>‚öôÔ∏è Loyalty Settings</h2>
                            <button onClick={() => setShowLoyaltySettingsModal(false)} style={{ background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer', color: theme.textMuted }}>√ó</button>
                        </div>
                        <div style={{ padding: '20px' }}>
                            <div style={{ marginBottom: '20px', padding: '14px', backgroundColor: theme.bgTertiary, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                <div>
                                    <div style={{ fontWeight: '500', color: theme.text }}>Enable Loyalty Program</div>
                                    <div style={{ fontSize: '12px', color: theme.textMuted }}>Turn the loyalty system on or off</div>
                                </div>
                                <button
                                    onClick={() => setSettingsFormData({...settingsFormData, enabled: !settingsFormData.enabled})}
                                    style={{ width: '50px', height: '26px', backgroundColor: settingsFormData.enabled ? '#10b981' : theme.border, border: 'none', cursor: 'pointer', position: 'relative' }}
                                >
                                    <span style={{ position: 'absolute', width: '20px', height: '20px', backgroundColor: 'white', top: '3px', left: settingsFormData.enabled ? '27px' : '3px', transition: 'left 0.2s' }}></span>
                                </button>
                            </div>
                            <div style={{ marginBottom: '16px' }}>
                                <label style={labelStyle}>Points Per Visit</label>
                                <input type="number" min="0" step="1" value={settingsFormData.pointsPerVisit} onChange={(e) => setSettingsFormData({...settingsFormData, pointsPerVisit: Number(e.target.value)})} style={inputStyle} />
                                <div style={{ fontSize: '11px', color: theme.textMuted, marginTop: '4px' }}>Points awarded for each visit</div>
                            </div>
                            <div style={{ marginBottom: '16px' }}>
                                <label style={labelStyle}>Points Per KSh Spent</label>
                                <input type="number" min="0" step="0.01" value={settingsFormData.pointsPerRand} onChange={(e) => setSettingsFormData({...settingsFormData, pointsPerRand: Number(e.target.value)})} style={inputStyle} />
                                <div style={{ fontSize: '11px', color: theme.textMuted, marginTop: '4px' }}>Additional points earned per KSh 1 spent</div>
                            </div>
                            <div style={{ marginBottom: '16px' }}>
                                <label style={labelStyle}>Redeem Rate (KSh per Point)</label>
                                <input type="number" min="0" step="0.01" value={settingsFormData.redeemRate} onChange={(e) => setSettingsFormData({...settingsFormData, redeemRate: Number(e.target.value)})} style={inputStyle} />
                                <div style={{ fontSize: '11px', color: theme.textMuted, marginTop: '4px' }}>Value of each point when redeemed (e.g., 0.1 = KSh 0.10 per point)</div>
                            </div>
                            <div style={{ marginBottom: '16px' }}>
                                <label style={labelStyle}>Welcome Bonus Points</label>
                                <input type="number" min="0" step="1" value={settingsFormData.welcomeBonus} onChange={(e) => setSettingsFormData({...settingsFormData, welcomeBonus: Number(e.target.value)})} style={inputStyle} />
                                <div style={{ fontSize: '11px', color: theme.textMuted, marginTop: '4px' }}>Points given to new customers</div>
                            </div>
                            <div style={{ marginBottom: '16px' }}>
                                <label style={labelStyle}>Birthday Bonus Points</label>
                                <input type="number" min="0" step="1" value={settingsFormData.birthdayBonus} onChange={(e) => setSettingsFormData({...settingsFormData, birthdayBonus: Number(e.target.value)})} style={inputStyle} />
                                <div style={{ fontSize: '11px', color: theme.textMuted, marginTop: '4px' }}>Bonus points on customer's birthday</div>
                            </div>
                        </div>
                        <div style={{ padding: '20px', borderTop: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'flex-end', gap: '10px' }}>
                            <button onClick={() => setShowLoyaltySettingsModal(false)} style={{ padding: '10px 20px', backgroundColor: theme.bgTertiary, color: theme.text, border: `1px solid ${theme.border}`, cursor: 'pointer', fontSize: '14px' }}>Cancel</button>
                            <button onClick={handleSaveLoyaltySettings} disabled={actionLoading} style={{ padding: '10px 20px', backgroundColor: '#3b82f6', color: 'white', border: 'none', cursor: 'pointer', fontSize: '14px', fontWeight: '500', opacity: actionLoading ? 0.7 : 1 }}>
                                {actionLoading ? 'Saving...' : 'Save Settings'}
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* Receipt Modal */}
            {showReceiptModal && receiptData && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: theme.modalOverlay, display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000, padding: '20px' }}>
                    <div style={{ backgroundColor: theme.bg, width: '100%', maxWidth: '400px', maxHeight: '90vh', overflow: 'auto', boxShadow: '0 25px 50px -12px rgba(0,0,0,0.25)' }}>
                        <div style={{ padding: '20px', borderBottom: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <h2 style={{ margin: 0, fontSize: '18px', fontWeight: '600', color: theme.text }}>üßæ Receipt</h2>
                            <button onClick={() => setShowReceiptModal(false)} style={{ background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer', color: theme.textMuted }}>√ó</button>
                        </div>
                        
                        {/* Receipt Content */}
                        <div id="receipt-content" style={{ padding: '20px' }}>
                            <div className="header" style={{ textAlign: 'center', borderBottom: '2px dashed #ccc', paddingBottom: '15px', marginBottom: '15px' }}>
                                <div className="company" style={{ fontSize: '22px', fontWeight: 'bold', color: theme.text }}>ECOSPARK</div>
                                <div className="tagline" style={{ fontSize: '12px', color: theme.textMuted }}>Car Wash & Auto Services</div>
                                <div style={{ fontSize: '11px', color: theme.textMuted, marginTop: '8px' }}>Receipt #{receiptData.receiptNumber}</div>
                                <div style={{ fontSize: '11px', color: theme.textMuted }}>{new Date(receiptData.date).toLocaleString()}</div>
                            </div>
                            
                            <div className="section" style={{ marginBottom: '15px' }}>
                                <div style={{ fontSize: '11px', color: theme.textMuted, marginBottom: '8px', textTransform: 'uppercase', letterSpacing: '1px' }}>Customer Details</div>
                                <div style={{ fontSize: '14px', fontWeight: '500', color: theme.text }}>{receiptData.customer.name}</div>
                                <div style={{ fontSize: '13px', color: theme.textSecondary }}>{receiptData.customer.phone}</div>
                                {receiptData.customer.email && <div style={{ fontSize: '13px', color: theme.textSecondary }}>{receiptData.customer.email}</div>}
                            </div>
                            
                            <div className="section" style={{ marginBottom: '15px', paddingTop: '15px', borderTop: '1px dashed #ccc' }}>
                                <div style={{ fontSize: '11px', color: theme.textMuted, marginBottom: '8px', textTransform: 'uppercase', letterSpacing: '1px' }}>Vehicle</div>
                                <div style={{ fontSize: '16px', fontWeight: '600', color: theme.text }}>{receiptData.vehicle.plateNumber}</div>
                                <div style={{ fontSize: '13px', color: theme.textSecondary }}>
                                    {[receiptData.vehicle.make, receiptData.vehicle.model, receiptData.vehicle.color].filter(Boolean).join(' ‚Ä¢ ') || 'N/A'}
                                </div>
                            </div>
                            
                            <div className="section" style={{ marginBottom: '15px', paddingTop: '15px', borderTop: '1px dashed #ccc' }}>
                                <div style={{ fontSize: '11px', color: theme.textMuted, marginBottom: '8px', textTransform: 'uppercase', letterSpacing: '1px' }}>Service</div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                    <span style={{ fontSize: '14px', color: theme.text }}>{receiptData.service.name}</span>
                                    <span style={{ fontSize: '16px', fontWeight: '600', color: theme.text }}>KSh {(receiptData.service.price || 0).toFixed(2)}</span>
                                </div>
                            </div>
                            
                            <div className="divider" style={{ borderTop: '2px solid #333', margin: '15px 0' }}></div>
                            
                            <div className="total-row" style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', fontSize: '18px', fontWeight: 'bold' }}>
                                <span style={{ color: theme.text }}>TOTAL</span>
                                <span style={{ color: theme.text }}>KSh {(receiptData.service.price || 0).toFixed(2)}</span>
                            </div>
                            
                            {receiptData.pointsEarned > 0 && (
                                <div className="points" style={{ backgroundColor: theme.bgTertiary, padding: '12px', textAlign: 'center', marginTop: '15px' }}>
                                    <div style={{ fontSize: '13px', color: theme.textSecondary }}>Points Earned This Visit</div>
                                    <div style={{ fontSize: '24px', fontWeight: '600', color: '#f59e0b' }}>+{receiptData.pointsEarned}</div>
                                    <div style={{ fontSize: '12px', color: theme.textMuted, marginTop: '4px' }}>Total Points: {receiptData.totalPoints}</div>
                                </div>
                            )}
                            
                            <div className="footer" style={{ textAlign: 'center', marginTop: '20px', paddingTop: '15px', borderTop: '2px dashed #ccc', fontSize: '11px', color: theme.textMuted }}>
                                <div>Thank you for choosing Ecospark!</div>
                                <div style={{ marginTop: '4px' }}>We appreciate your business</div>
                            </div>
                        </div>
                        
                        <div style={{ padding: '20px', borderTop: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'flex-end', gap: '10px' }}>
                            <button onClick={() => setShowReceiptModal(false)} style={{ padding: '10px 20px', backgroundColor: theme.bgTertiary, color: theme.text, border: `1px solid ${theme.border}`, cursor: 'pointer', fontSize: '14px' }}>Close</button>
                            <button onClick={handlePrintReceipt} style={{ padding: '10px 20px', backgroundColor: '#3b82f6', color: 'white', border: 'none', cursor: 'pointer', fontSize: '14px', fontWeight: '500', display: 'flex', alignItems: 'center', gap: '6px' }}>
                                üñ®Ô∏è Print Receipt
                            </button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}

// ==================== GARAGE MANAGEMENT MODULE ====================
function GarageManagement() {
    // State management
    const [queue, setQueue] = useState([]);
    const [jobs, setJobs] = useState([]);
    const [garageServices, setGarageServices] = useState([]);
    const [intakeVehicles, setIntakeVehicles] = useState([]);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState(null);
    const [actionLoading, setActionLoading] = useState(false);
    const [searchQuery, setSearchQuery] = useState('');
    const [statusFilter, setStatusFilter] = useState('all');
    const [activeTab, setActiveTab] = useState('queue'); // queue, jobs, completed
    const [showAddModal, setShowAddModal] = useState(false);
    const [showJobModal, setShowJobModal] = useState(false);
    const [showViewModal, setShowViewModal] = useState(false);
    const [showReceiptModal, setShowReceiptModal] = useState(false);
    const [showHistoryModal, setShowHistoryModal] = useState(false);
    const [showNotesModal, setShowNotesModal] = useState(false);
    const [showServicesModal, setShowServicesModal] = useState(false);
    const [showServiceFormModal, setShowServiceFormModal] = useState(false);
    const [editingService, setEditingService] = useState(null);
    const [serviceFormData, setServiceFormData] = useState({
        name: '',
        category: 'maintenance',
        price: '',
        duration: '',
        description: ''
    });
    const [selectedItem, setSelectedItem] = useState(null);
    const [selectedIntakeVehicle, setSelectedIntakeVehicle] = useState('');
    const [intakeRecords, setIntakeRecords] = useState([]); // Vehicles assigned to bays
    const [showTransferModal, setShowTransferModal] = useState(false);
    const [transferVehicle, setTransferVehicle] = useState(null);
    const [transferServices, setTransferServices] = useState([]);
    const [transferNotes, setTransferNotes] = useState('');
    const [transferPriority, setTransferPriority] = useState('normal');
    const [technicianNotes, setTechnicianNotes] = useState('');
    const [currentPage, setCurrentPage] = useState(1);
    const [itemsPerPage, setItemsPerPage] = useState(10);
    const [isDark, setIsDark] = useState(document.documentElement.getAttribute('data-theme') === 'dark');
    const [staffList, setStaffList] = useState([]); // Staff for technician assignment
    const [showAssignTechModal, setShowAssignTechModal] = useState(false);
    const [selectedQueueItem, setSelectedQueueItem] = useState(null);
    const [selectedTechnician, setSelectedTechnician] = useState('');

    // Form data for adding to queue
    const [formData, setFormData] = useState({
        plateNumber: '',
        vehicleType: 'Sedan',
        customerName: '',
        customerPhone: '',
        services: [],
        notes: '',
        priority: 'normal',
        assignedTo: ''
    });

    // Listen for theme changes
    useEffect(() => {
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.attributeName === 'data-theme') {
                    setIsDark(document.documentElement.getAttribute('data-theme') === 'dark');
                }
            });
        });
        observer.observe(document.documentElement, { attributes: true });
        return () => observer.disconnect();
    }, []);

    // Theme colors
    const theme = {
        bg: isDark ? '#1e293b' : 'white',
        bgSecondary: isDark ? '#0f172a' : '#f8fafc',
        bgTertiary: isDark ? '#334155' : '#f1f5f9',
        text: isDark ? '#f1f5f9' : '#1e293b',
        textSecondary: isDark ? '#94a3b8' : '#64748b',
        textMuted: isDark ? '#64748b' : '#94a3b8',
        border: isDark ? '#334155' : '#e2e8f0',
        borderLight: isDark ? '#475569' : '#cbd5e1',
        cardShadow: isDark ? '0 1px 3px rgba(0,0,0,0.3)' : '0 1px 3px rgba(0,0,0,0.1)',
        modalOverlay: isDark ? 'rgba(0,0,0,0.7)' : 'rgba(0,0,0,0.5)',
        inputBg: isDark ? '#1e293b' : 'white',
        rowHoverBg: isDark ? '#334155' : '#f8fafc',
    };

    const VEHICLE_TYPES = ['Sedan', 'SUV', 'Truck', 'Van', 'Motorcycle', 'Bus', 'Other'];
    const PRIORITY_OPTIONS = [
        { id: 'low', name: 'Low', color: '#6b7280' },
        { id: 'normal', name: 'Normal', color: '#3b82f6' },
        { id: 'high', name: 'High', color: '#f59e0b' },
        { id: 'urgent', name: 'Urgent', color: '#ef4444' }
    ];

    // Initialize Firebase subscriptions
    useEffect(() => {
        let unsubQueue, unsubJobs, unsubGarageServices, unsubIntakeQueue, unsubIntakeRecords, unsubStaff;
        let retryCount = 0;
        const maxRetries = 10;

        const initializeData = async () => {
            // Wait for Firebase services to be available
            let services = window.FirebaseServices;
            while (!services && retryCount < maxRetries) {
                await new Promise(resolve => setTimeout(resolve, 100));
                services = window.FirebaseServices;
                retryCount++;
            }

            if (!services) {
                console.error('‚ùå Firebase services not available after retries');
                setLoading(false);
                setError('Firebase services not available. Please refresh.');
                return;
            }

            console.log('üîß Garage: Firebase services available, initializing...');

            try {
                // Initialize default garage services
                if (services.garageServicesService) {
                    await services.garageServicesService.initializeDefaultServices();
                }

                // Subscribe to garage queue
                if (services.garageQueueService) {
                    unsubQueue = services.garageQueueService.subscribeToQueue(
                        (data) => {
                            console.log('üîß Garage queue updated:', data.length, 'items');
                            setQueue(data);
                        },
                        (err) => console.error('Garage queue error:', err)
                    );
                }

                // Subscribe to garage jobs
                if (services.garageJobsService) {
                    unsubJobs = services.garageJobsService.subscribeToJobs(
                        (data) => setJobs(data),
                        (err) => console.error('Garage jobs error:', err)
                    );
                }

                // Subscribe to garage services catalog
                if (services.garageServicesService) {
                    unsubGarageServices = services.garageServicesService.subscribeToServices(
                        (data) => setGarageServices(data.filter(s => s.isActive !== false)),
                        (err) => console.error('Garage services error:', err)
                    );
                }

                // Subscribe to intake queue (to pull waiting vehicles)
                if (services.intakeQueueService) {
                    console.log('üîß Subscribing to intake queue for garage...');
                    unsubIntakeQueue = services.intakeQueueService.subscribeToQueue(
                        (data) => {
                            console.log('üöó Intake queue for garage:', data.length, 'waiting');
                            setIntakeVehicles(data);
                        },
                        (err) => console.error('Intake queue error:', err)
                    );
                } else {
                    console.error('‚ùå intakeQueueService not available');
                }

                // Subscribe to intake records (vehicles assigned to bays/in-progress)
                if (services.intakeRecordsService) {
                    console.log('üîß Subscribing to intake records for garage...');
                    unsubIntakeRecords = services.intakeRecordsService.subscribeToRecords(
                        (data) => {
                            // Filter to only in-progress vehicles (not completed)
                            const activeRecords = data.filter(r => r.status === 'in-progress');
                            console.log('üöó Intake records for garage:', activeRecords.length, 'in-progress');
                            setIntakeRecords(activeRecords);
                        },
                        (err) => console.error('Intake records error:', err)
                    );
                }

                // Subscribe to staff list for technician assignment
                if (services.staffService?.subscribeToStaff) {
                    unsubStaff = services.staffService.subscribeToStaff((data) => {
                        // Include all active staff for assignment
                        const activeStaff = data.filter(s => s.status === 'active');
                        setStaffList(activeStaff);
                    });
                }

                setLoading(false);
            } catch (err) {
                console.error('Failed to initialize garage:', err);
                setError('Failed to initialize. Please refresh.');
                setLoading(false);
            }
        };

        initializeData();

        return () => {
            if (unsubQueue) unsubQueue();
            if (unsubJobs) unsubJobs();
            if (unsubGarageServices) unsubGarageServices();
            if (unsubIntakeQueue) unsubIntakeQueue();
            if (unsubIntakeRecords) unsubIntakeRecords();
            if (unsubStaff) unsubStaff();
        };
    }, []);

    // Calculate stats
    const stats = {
        waiting: queue.length,
        inProgress: jobs.filter(j => j.status === 'in-progress').length,
        completedToday: jobs.filter(j => {
            if (j.status !== 'completed' || !j.completedAt) return false;
            const today = new Date();
            const completed = new Date(j.completedAt);
            return completed.toDateString() === today.toDateString();
        }).length,
        totalRevenue: jobs.filter(j => {
            if (j.status !== 'completed' || !j.completedAt) return false;
            const today = new Date();
            const completed = new Date(j.completedAt);
            return completed.toDateString() === today.toDateString();
        }).reduce((sum, j) => sum + (j.totalCost || 0), 0)
    };

    // Filter queue/jobs based on search and status
    const getFilteredData = () => {
        let data = [];
        if (activeTab === 'queue') {
            data = queue;
        } else if (activeTab === 'jobs') {
            data = jobs.filter(j => j.status === 'in-progress');
        } else {
            data = jobs.filter(j => j.status === 'completed');
        }

        // Search filter
        if (searchQuery.trim()) {
            const query = searchQuery.toLowerCase();
            data = data.filter(item =>
                item.plateNumber?.toLowerCase().includes(query) ||
                item.customerName?.toLowerCase().includes(query) ||
                item.customerPhone?.includes(query) ||
                item.vehicleType?.toLowerCase().includes(query)
            );
        }

        // Status filter for queue
        if (activeTab === 'queue' && statusFilter !== 'all') {
            data = data.filter(item => item.priority === statusFilter);
        }

        return data;
    };

    const filteredData = getFilteredData();

    // Pagination logic
    const totalItems = filteredData.length;
    const totalPages = Math.ceil(totalItems / itemsPerPage);
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const paginatedData = filteredData.slice(startIndex, endIndex);

    // Reset page when tab or filter changes
    useEffect(() => {
        setCurrentPage(1);
    }, [activeTab, searchQuery, statusFilter]);

    // Handle adding vehicle from intake to garage queue
    const handleAddFromIntake = async () => {
        if (!selectedIntakeVehicle) return;

        const services = window.FirebaseServices;
        if (!services?.garageQueueService) {
            setError('Services not available');
            return;
        }

        // Parse the selected value to determine source type
        const [sourceType, sourceId] = selectedIntakeVehicle.split(':');
        let vehicle = null;
        let isFromQueue = sourceType === 'queue';

        if (isFromQueue) {
            vehicle = intakeVehicles.find(v => v.id === sourceId);
            if (!vehicle) {
                setError('Vehicle not found in intake queue');
                return;
            }
        } else {
            vehicle = intakeRecords.find(v => v.id === sourceId);
            if (!vehicle) {
                setError('Vehicle not found in intake records');
                return;
            }
        }

        // Open the transfer modal to select services
        setTransferVehicle({
            ...vehicle,
            isFromQueue,
            sourceType
        });
        setTransferServices([]);
        setTransferNotes('');
        setTransferPriority('normal');
        setShowTransferModal(true);
    };

    // Complete the transfer after selecting services
    const handleConfirmTransfer = async () => {
        if (!transferVehicle) return;

        const services = window.FirebaseServices;
        if (!services?.garageQueueService) {
            setError('Services not available');
            return;
        }

        // Calculate total cost from selected services
        const totalCost = transferServices.reduce((sum, sId) => {
            const service = garageServices.find(s => s.id === sId);
            return sum + (service?.price || 0);
        }, 0);

        setActionLoading(true);
        try {
            // Add to garage queue with selected services
            const result = await services.garageQueueService.addToQueue({
                plateNumber: transferVehicle.plateNumber,
                vehicleType: transferVehicle.vehicleType,
                customerName: transferVehicle.customerName || '',
                customerPhone: transferVehicle.customerPhone || '',
                services: transferServices,
                notes: transferNotes || `From Vehicle Intake - ${transferVehicle.service?.name || transferVehicle.assignedBay || 'N/A'}`,
                priority: transferPriority,
                sourceId: transferVehicle.id,
                source: transferVehicle.isFromQueue ? 'intake-queue' : 'intake-bay',
                totalCost: totalCost,
                intakeTimeIn: transferVehicle.timeIn || new Date().toISOString()
            });

            if (result.success) {
                if (transferVehicle.isFromQueue && services.intakeQueueService) {
                    // Remove from intake queue
                    await services.intakeQueueService.removeFromQueue(transferVehicle.id);
                    console.log('‚úÖ Vehicle transferred from queue to garage:', transferVehicle.plateNumber);
                } else if (!transferVehicle.isFromQueue && services.intakeRecordsService) {
                    // Update record status to 'garage'
                    await services.intakeRecordsService.updateRecord(transferVehicle.id, { status: 'garage' });
                    console.log('‚úÖ Vehicle sent from bay to garage:', transferVehicle.plateNumber);
                }
            }
            
            setSelectedIntakeVehicle('');
            setShowTransferModal(false);
            setTransferVehicle(null);
            setTransferServices([]);
            setTransferNotes('');
            setTransferPriority('normal');
        } catch (err) {
            console.error('Transfer error:', err);
            setError('Failed to add vehicle to garage queue: ' + err.message);
        } finally {
            setActionLoading(false);
        }
    };

    // Toggle service selection for transfer
    const toggleTransferService = (serviceId) => {
        setTransferServices(prev => 
            prev.includes(serviceId)
                ? prev.filter(id => id !== serviceId)
                : [...prev, serviceId]
        );
    };

    // Handle adding new vehicle directly to queue
    const handleAddToQueue = async () => {
        if (!formData.plateNumber.trim()) {
            setError('Plate number is required');
            return;
        }

        const services = window.FirebaseServices;
        if (!services?.garageQueueService) return;

        setActionLoading(true);
        try {
            await services.garageQueueService.addToQueue({
                ...formData,
                totalCost: formData.services.reduce((sum, sId) => {
                    const service = garageServices.find(s => s.id === sId);
                    return sum + (service?.price || 0);
                }, 0)
            });
            setFormData({
                plateNumber: '',
                vehicleType: 'Sedan',
                customerName: '',
                customerPhone: '',
                services: [],
                notes: '',
                priority: 'normal',
                assignedTo: ''
            });
            setShowAddModal(false);
        } catch (err) {
            setError('Failed to add vehicle to queue');
        } finally {
            setActionLoading(false);
        }
    };

    // Start job from queue - show technician selection first
    const handleStartJob = async (queueItem) => {
        setSelectedQueueItem(queueItem);
        setSelectedTechnician('');
        setShowAssignTechModal(true);
    };

    // Actually start the job with assigned technician
    const executeStartJob = async () => {
        if (!selectedQueueItem) return;
        
        const services = window.FirebaseServices;
        if (!services?.garageJobsService || !services?.garageQueueService) {
            setError('Services not available');
            return;
        }

        setActionLoading(true);
        try {
            // Create job in Firestore with assigned technician
            const result = await services.garageJobsService.createJob({
                plateNumber: selectedQueueItem.plateNumber,
                vehicleType: selectedQueueItem.vehicleType,
                customerName: selectedQueueItem.customerName || '',
                customerPhone: selectedQueueItem.customerPhone || '',
                services: selectedQueueItem.services || [],
                notes: selectedQueueItem.notes || '',
                priority: selectedQueueItem.priority || 'normal',
                totalCost: selectedQueueItem.totalCost || 0,
                source: selectedQueueItem.source || 'direct',
                assignedTo: selectedTechnician // Technician name for HR tracking
            });
            
            if (result.success) {
                console.log('‚úÖ Job created:', result.id, 'assigned to:', selectedTechnician);
                // Remove from queue after job is created
                await services.garageQueueService.removeFromQueue(selectedQueueItem.id);
                // Switch to jobs tab
                setActiveTab('jobs');
                setShowAssignTechModal(false);
                setSelectedQueueItem(null);
                setSelectedTechnician('');
            } else {
                setError('Failed to create job: ' + (result.error || 'Unknown error'));
            }
        } catch (err) {
            console.error('Start job error:', err);
            setError('Failed to start job: ' + err.message);
        } finally {
            setActionLoading(false);
        }
    };

    // Complete job
    const handleCompleteJob = async (job) => {
        const services = window.FirebaseServices;
        if (!services?.garageJobsService) {
            setError('Services not available');
            return;
        }

        if (!job.id) {
            setError('Invalid job - no ID found');
            return;
        }

        setActionLoading(true);
        try {
            // Calculate total cost from services
            let totalCost = 0;
            let serviceDetails = [];
            if (job.services && job.services.length > 0) {
                serviceDetails = job.services.map(sId => {
                    const service = garageServices.find(s => s.id === sId);
                    return { id: sId, name: service?.name || 'Service', price: service?.price || 0 };
                });
                totalCost = serviceDetails.reduce((sum, s) => sum + s.price, 0);
            } else {
                totalCost = job.totalCost || 0;
            }

            console.log('Completing job:', job.id, 'with total:', totalCost);

            const result = await services.garageJobsService.completeJob(job.id, {
                totalCost: totalCost
            });
            
            console.log('Complete result:', result);

            if (result.success) {
                // Create invoice for the completed job
                if (services.billingService && totalCost > 0) {
                    await services.billingService.createInvoice({
                        source: 'garage',
                        jobId: job.id,
                        plateNumber: job.plateNumber,
                        vehicleType: job.vehicleType,
                        customerName: job.customerName || 'Walk-in',
                        customerPhone: job.customerPhone || '',
                        services: serviceDetails,
                        totalAmount: totalCost,
                        notes: job.notes || ''
                    });
                    console.log('Invoice created for garage job:', job.id);
                }
                
                // Wait for Firebase to sync, then switch tab
                setTimeout(() => {
                    setActiveTab('completed');
                    setActionLoading(false);
                }, 500);
            } else {
                setError('Failed to complete job: ' + (result.error || 'Unknown error'));
                setActionLoading(false);
            }
        } catch (err) {
            console.error('Complete job error:', err);
            setError('Failed to complete job: ' + err.message);
            setActionLoading(false);
        }
    };

    // View item details
    const handleViewItem = (item) => {
        setSelectedItem(item);
        setShowViewModal(true);
    };

    // Show receipt for item
    const handleShowReceipt = (item) => {
        setSelectedItem(item);
        setShowReceiptModal(true);
    };

    // Show job history
    const handleShowHistory = (item) => {
        setSelectedItem(item);
        setShowHistoryModal(true);
    };

    // Show notes modal for technician
    const handleShowNotes = (item) => {
        setSelectedItem(item);
        setTechnicianNotes(item.technicianNotes || '');
        setShowNotesModal(true);
    };

    // Save technician notes
    const handleSaveNotes = async () => {
        const services = window.FirebaseServices;
        if (!services?.garageJobsService || !selectedItem) return;

        setActionLoading(true);
        try {
            await services.garageJobsService.updateJob(selectedItem.id, {
                technicianNotes: technicianNotes,
                lastUpdated: new Date().toISOString()
            });
            setShowNotesModal(false);
            setSelectedItem(null);
            setTechnicianNotes('');
        } catch (err) {
            setError('Failed to save notes: ' + err.message);
        } finally {
            setActionLoading(false);
        }
    };

    // Service Categories
    const SERVICE_CATEGORIES = [
        { id: 'maintenance', name: 'Maintenance', color: '#3b82f6' },
        { id: 'repair', name: 'Repair', color: '#ef4444' },
        { id: 'inspection', name: 'Inspection', color: '#10b981' },
        { id: 'electrical', name: 'Electrical', color: '#f59e0b' },
        { id: 'bodywork', name: 'Body Work', color: '#8b5cf6' },
        { id: 'other', name: 'Other', color: '#6b7280' }
    ];

    // Open add service form
    const handleAddService = () => {
        setEditingService(null);
        setServiceFormData({
            name: '',
            category: 'maintenance',
            price: '',
            duration: '',
            description: ''
        });
        setShowServiceFormModal(true);
    };

    // Open edit service form
    const handleEditService = (service) => {
        setEditingService(service);
        setServiceFormData({
            name: service.name || '',
            category: service.category || 'maintenance',
            price: service.price?.toString() || '',
            duration: service.duration?.toString() || '',
            description: service.description || ''
        });
        setShowServiceFormModal(true);
    };

    // Save service (add or update)
    const handleSaveService = async () => {
        const services = window.FirebaseServices;
        if (!services?.garageServicesService) return;

        if (!serviceFormData.name.trim()) {
            setError('Service name is required');
            return;
        }
        if (!serviceFormData.price || isNaN(Number(serviceFormData.price))) {
            setError('Valid price is required');
            return;
        }

        setActionLoading(true);
        try {
            const serviceData = {
                name: serviceFormData.name.trim(),
                category: serviceFormData.category,
                price: Number(serviceFormData.price),
                duration: Number(serviceFormData.duration) || 30,
                description: serviceFormData.description.trim(),
                isActive: true
            };

            if (editingService) {
                await services.garageServicesService.updateService(editingService.id, serviceData);
            } else {
                await services.garageServicesService.addService(serviceData);
            }

            setShowServiceFormModal(false);
            setEditingService(null);
            setServiceFormData({ name: '', category: 'maintenance', price: '', duration: '', description: '' });
        } catch (err) {
            setError('Failed to save service: ' + err.message);
        } finally {
            setActionLoading(false);
        }
    };

    // Delete service
    const handleDeleteService = async (serviceId) => {
        const services = window.FirebaseServices;
        if (!services?.garageServicesService) return;

        if (!confirm('Delete this service? This cannot be undone.')) return;

        setActionLoading(true);
        try {
            await services.garageServicesService.deleteService(serviceId);
        } catch (err) {
            setError('Failed to delete service: ' + err.message);
        } finally {
            setActionLoading(false);
        }
    };

    // Print receipt
    const handlePrintReceipt = () => {
        if (!selectedItem) return;
        
        const servicesList = selectedItem.services?.map(sId => {
            const service = garageServices.find(s => s.id === sId);
            return service ? `<tr><td style="padding:8px;border-bottom:1px solid #eee;">${service.name}</td><td style="padding:8px;border-bottom:1px solid #eee;text-align:right;">KSh ${(service.price || 0).toLocaleString()}</td></tr>` : '';
        }).join('') || '<tr><td colspan="2" style="padding:8px;">No services</td></tr>';

        const totalCost = selectedItem.services?.reduce((sum, sId) => {
            const service = garageServices.find(s => s.id === sId);
            return sum + (service?.price || 0);
        }, 0) || selectedItem.totalCost || 0;

        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>Garage Receipt - ${selectedItem.plateNumber}</title>
                <style>
                    body { font-family: Arial, sans-serif; padding: 20px; max-width: 400px; margin: 0 auto; }
                    .header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #333; padding-bottom: 15px; }
                    .logo { font-size: 24px; font-weight: bold; color: #333; }
                    .subtitle { color: #666; font-size: 12px; }
                    .section { margin: 15px 0; }
                    .label { color: #666; font-size: 12px; }
                    .value { font-weight: 500; font-size: 14px; }
                    table { width: 100%; border-collapse: collapse; margin: 15px 0; }
                    th { text-align: left; padding: 8px; background: #f5f5f5; border-bottom: 2px solid #333; }
                    .total { font-size: 18px; font-weight: bold; text-align: right; margin-top: 15px; padding-top: 15px; border-top: 2px solid #333; }
                    .footer { text-align: center; margin-top: 30px; padding-top: 15px; border-top: 1px dashed #ccc; color: #666; font-size: 11px; }
                    .status { display: inline-block; padding: 4px 12px; background: #d1fae5; color: #059669; font-weight: 500; }
                </style>
            </head>
            <body>
                <div class="header">
                    <div class="logo">üîß ECOSPARK GARAGE</div>
                    <div class="subtitle">Auto Service Receipt</div>
                </div>
                
                <div class="section">
                    <div class="label">Receipt No.</div>
                    <div class="value">#GRG-${Date.now().toString().slice(-8)}</div>
                </div>
                
                <div class="section">
                    <div class="label">Date</div>
                    <div class="value">${new Date().toLocaleDateString('en-KE', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</div>
                </div>
                
                <div class="section">
                    <div class="label">Vehicle</div>
                    <div class="value">${selectedItem.plateNumber} - ${selectedItem.vehicleType || 'N/A'}</div>
                </div>
                
                <div class="section">
                    <div class="label">Customer</div>
                    <div class="value">${selectedItem.customerName || 'Walk-in Customer'}</div>
                    ${selectedItem.customerPhone ? `<div class="value">${selectedItem.customerPhone}</div>` : ''}
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th>Service</th>
                            <th style="text-align:right;">Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${servicesList}
                    </tbody>
                </table>
                
                <div class="total">
                    Total: KSh ${totalCost.toLocaleString()}
                </div>
                
                <div class="section" style="text-align:center;margin-top:20px;">
                    <span class="status">‚úÖ ${selectedItem.status === 'completed' ? 'COMPLETED' : 'IN PROGRESS'}</span>
                </div>
                
                ${selectedItem.notes ? `<div class="section"><div class="label">Notes</div><div class="value">${selectedItem.notes}</div></div>` : ''}
                
                <div class="footer">
                    <p>Thank you for choosing Ecospark!</p>
                    <p>Your vehicle is in safe hands</p>
                </div>
            </body>
            </html>
        `);
        printWindow.document.close();
        printWindow.focus();
        setTimeout(() => {
            printWindow.print();
            printWindow.close();
        }, 250);
    };

    // Remove from queue
    const handleRemoveFromQueue = async (itemId) => {
        const services = window.FirebaseServices;
        if (!services?.garageQueueService) return;

        if (!confirm('Remove this vehicle from the queue?')) return;

        setActionLoading(true);
        try {
            await services.garageQueueService.removeFromQueue(itemId);
        } catch (err) {
            setError('Failed to remove from queue');
        } finally {
            setActionLoading(false);
        }
    };

    // Delete job
    const handleDeleteJob = async (jobId) => {
        const services = window.FirebaseServices;
        if (!services?.garageJobsService) return;

        if (!confirm('Delete this job record?')) return;

        setActionLoading(true);
        try {
            await services.garageJobsService.deleteJob(jobId);
        } catch (err) {
            setError('Failed to delete job');
        } finally {
            setActionLoading(false);
        }
    };

    // Toggle service selection
    const toggleService = (serviceId) => {
        setFormData(prev => ({
            ...prev,
            services: prev.services.includes(serviceId)
                ? prev.services.filter(id => id !== serviceId)
                : [...prev.services, serviceId]
        }));
    };

    // Get priority color
    const getPriorityColor = (priority) => {
        const option = PRIORITY_OPTIONS.find(p => p.id === priority);
        return option?.color || '#6b7280';
    };

    // Format currency
    const formatCurrency = (amount) => `KSh ${(amount || 0).toLocaleString()}`;

    // Format time ago
    const formatTimeAgo = (dateString) => {
        const date = new Date(dateString);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        if (diffMins < 60) return `${diffMins}m ago`;
        const diffHours = Math.floor(diffMins / 60);
        if (diffHours < 24) return `${diffHours}h ago`;
        return date.toLocaleDateString();
    };

    // Loading state
    if (loading) {
        return (
            <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', height: '400px', color: theme.textSecondary }}>
                <div style={{ textAlign: 'center' }}>
                    <div style={{ width: '40px', height: '40px', border: '3px solid #e2e8f0', borderTopColor: '#3b82f6', borderRadius: '50%', animation: 'spin 0.8s linear infinite', margin: '0 auto 16px' }}></div>
                    <p>Loading Garage...</p>
                </div>
            </div>
        );
    }

    return (
        <div style={{ padding: '24px', backgroundColor: theme.bgSecondary, minHeight: '100%' }}>
            {/* Error Banner */}
            {error && (
                <div style={{ marginBottom: '16px', padding: '12px 16px', backgroundColor: '#fef2f2', border: '1px solid #fecaca', borderRadius: '0', color: '#dc2626', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <span>{error}</span>
                    <button onClick={() => setError(null)} style={{ background: 'none', border: 'none', color: '#dc2626', cursor: 'pointer', fontSize: '18px' }}>√ó</button>
                </div>
            )}

            {/* Stats Cards */}
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '16px', marginBottom: '24px' }}>
                <div style={{ background: theme.bg, borderRadius: '0', padding: '20px', boxShadow: theme.cardShadow, border: `1px solid ${theme.border}` }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                        <div style={{ width: '48px', height: '48px', borderRadius: '0', backgroundColor: '#dbeafe', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                            <span style={{ fontSize: '24px' }}>üöó</span>
                        </div>
                        <div>
                            <p style={{ color: theme.textSecondary, fontSize: '14px', margin: 0 }}>Waiting in Queue</p>
                            <p style={{ color: theme.text, fontSize: '28px', fontWeight: '700', margin: 0 }}>{stats.waiting}</p>
                        </div>
                    </div>
                </div>

                <div style={{ background: theme.bg, borderRadius: '0', padding: '20px', boxShadow: theme.cardShadow, border: `1px solid ${theme.border}` }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                        <div style={{ width: '48px', height: '48px', borderRadius: '0', backgroundColor: '#fef3c7', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                            <span style={{ fontSize: '24px' }}>üîß</span>
                        </div>
                        <div>
                            <p style={{ color: theme.textSecondary, fontSize: '14px', margin: 0 }}>In Progress</p>
                            <p style={{ color: theme.text, fontSize: '28px', fontWeight: '700', margin: 0 }}>{stats.inProgress}</p>
                        </div>
                    </div>
                </div>

                <div style={{ background: theme.bg, borderRadius: '0', padding: '20px', boxShadow: theme.cardShadow, border: `1px solid ${theme.border}` }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                        <div style={{ width: '48px', height: '48px', borderRadius: '0', backgroundColor: '#d1fae5', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                            <span style={{ fontSize: '24px' }}>‚úÖ</span>
                        </div>
                        <div>
                            <p style={{ color: theme.textSecondary, fontSize: '14px', margin: 0 }}>Completed Today</p>
                            <p style={{ color: theme.text, fontSize: '28px', fontWeight: '700', margin: 0 }}>{stats.completedToday}</p>
                        </div>
                    </div>
                </div>

                <div style={{ background: theme.bg, borderRadius: '0', padding: '20px', boxShadow: theme.cardShadow, border: `1px solid ${theme.border}` }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                        <div style={{ width: '48px', height: '48px', borderRadius: '0', backgroundColor: '#ede9fe', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                            <span style={{ fontSize: '24px' }}>üí∞</span>
                        </div>
                        <div>
                            <p style={{ color: theme.textSecondary, fontSize: '14px', margin: 0 }}>Today's Revenue</p>
                            <p style={{ color: theme.text, fontSize: '24px', fontWeight: '700', margin: 0 }}>{formatCurrency(stats.totalRevenue)}</p>
                        </div>
                    </div>
                </div>
            </div>

            {/* Add from Intake Section */}
            <div style={{ background: theme.bg, borderRadius: '0', padding: '20px', marginBottom: '24px', boxShadow: theme.cardShadow, border: `1px solid ${theme.border}` }}>
                <h3 style={{ margin: '0 0 16px 0', color: theme.text, fontSize: '16px', fontWeight: '600' }}>Add Vehicle to Garage</h3>
                <div style={{ display: 'flex', gap: '12px', flexWrap: 'wrap', alignItems: 'flex-end' }}>
                    <div style={{ flex: '1', minWidth: '300px' }}>
                        <label style={{ display: 'block', fontSize: '13px', color: theme.textSecondary, marginBottom: '6px' }}>
                            Select from Vehicle Intake 
                            <span style={{ marginLeft: '8px', padding: '2px 8px', backgroundColor: intakeVehicles.length > 0 ? '#fef3c7' : theme.bgTertiary, color: intakeVehicles.length > 0 ? '#d97706' : theme.textMuted, fontSize: '12px', fontWeight: '600' }}>
                                {intakeVehicles.length} waiting
                            </span>
                            <span style={{ marginLeft: '4px', padding: '2px 8px', backgroundColor: intakeRecords.length > 0 ? '#dbeafe' : theme.bgTertiary, color: intakeRecords.length > 0 ? '#2563eb' : theme.textMuted, fontSize: '12px', fontWeight: '600' }}>
                                {intakeRecords.length} in-progress
                            </span>
                        </label>
                        <select
                            value={selectedIntakeVehicle}
                            onChange={(e) => setSelectedIntakeVehicle(e.target.value)}
                            style={{ width: '100%', padding: '10px 12px', border: `1px solid ${theme.border}`, borderRadius: '0', fontSize: '14px', backgroundColor: theme.inputBg, color: theme.text }}
                        >
                            <option value="">{(intakeVehicles.length + intakeRecords.length) === 0 ? '-- No vehicles in intake --' : '-- Select Vehicle --'}</option>
                            {intakeVehicles.length > 0 && (
                                <optgroup label="‚è≥ Waiting in Queue">
                                    {intakeVehicles.map(v => (
                                        <option key={`queue-${v.id}`} value={`queue:${v.id}`}>
                                            {v.plateNumber} - {v.vehicleType} ‚Ä¢ {v.customerName || 'Walk-in'} {v.service?.name ? `(${v.service.name})` : ''}
                                        </option>
                                    ))}
                                </optgroup>
                            )}
                            {intakeRecords.length > 0 && (
                                <optgroup label="üîß In Progress (Assigned to Bay)">
                                    {intakeRecords.map(v => (
                                        <option key={`record-${v.id}`} value={`record:${v.id}`}>
                                            {v.plateNumber} - {v.vehicleType} ‚Ä¢ {v.assignedBay || 'Bay'} ‚Ä¢ {v.customerName || 'Walk-in'}
                                        </option>
                                    ))}
                                </optgroup>
                            )}
                        </select>
                    </div>
                    <button
                        onClick={handleAddFromIntake}
                        disabled={!selectedIntakeVehicle || actionLoading}
                        style={{ padding: '10px 20px', backgroundColor: selectedIntakeVehicle ? '#3b82f6' : '#94a3b8', color: 'white', border: 'none', borderRadius: '0', cursor: selectedIntakeVehicle ? 'pointer' : 'not-allowed', fontSize: '14px', fontWeight: '500', display: 'flex', alignItems: 'center', gap: '6px' }}
                    >
                        {Icons.arrowRight} Send to Garage
                    </button>
                    <div style={{ borderLeft: `1px solid ${theme.border}`, height: '40px', margin: '0 8px' }}></div>
                    <button
                        onClick={() => setShowAddModal(true)}
                        style={{ padding: '10px 20px', backgroundColor: '#10b981', color: 'white', border: 'none', borderRadius: '0', cursor: 'pointer', fontSize: '14px', fontWeight: '500', display: 'flex', alignItems: 'center', gap: '6px' }}
                    >
                        {Icons.plus} Add New Vehicle
                    </button>
                    <div style={{ borderLeft: `1px solid ${theme.border}`, height: '40px', margin: '0 8px' }}></div>
                    <button
                        onClick={() => setShowServicesModal(true)}
                        style={{ padding: '10px 20px', backgroundColor: '#8b5cf6', color: 'white', border: 'none', borderRadius: '0', cursor: 'pointer', fontSize: '14px', fontWeight: '500', display: 'flex', alignItems: 'center', gap: '6px' }}
                    >
                        ‚öôÔ∏è Manage Services
                    </button>
                </div>
            </div>

            {/* Tabs */}
            <div style={{ display: 'flex', gap: '8px', marginBottom: '16px' }}>
                {[
                    { id: 'queue', label: 'Queue', count: stats.waiting },
                    { id: 'jobs', label: 'In Progress', count: stats.inProgress },
                    { id: 'completed', label: 'Completed', count: stats.completedToday }
                ].map(tab => (
                    <button
                        key={tab.id}
                        onClick={() => setActiveTab(tab.id)}
                        style={{
                            padding: '10px 20px',
                            backgroundColor: activeTab === tab.id ? '#3b82f6' : theme.bg,
                            color: activeTab === tab.id ? 'white' : theme.text,
                            border: `1px solid ${activeTab === tab.id ? '#3b82f6' : theme.border}`,
                            borderRadius: '0',
                            cursor: 'pointer',
                            fontSize: '14px',
                            fontWeight: '500',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '8px'
                        }}
                    >
                        {tab.label}
                        <span style={{
                            backgroundColor: activeTab === tab.id ? 'rgba(255,255,255,0.2)' : theme.bgTertiary,
                            padding: '2px 8px',
                            borderRadius: '0',
                            fontSize: '12px'
                        }}>{tab.count}</span>
                    </button>
                ))}
            </div>

            {/* Search and Filter Bar */}
            <div style={{ background: theme.bg, borderRadius: '0', padding: '16px', marginBottom: '16px', boxShadow: theme.cardShadow, border: `1px solid ${theme.border}`, display: 'flex', gap: '12px', flexWrap: 'wrap' }}>
                <div style={{ flex: '1', minWidth: '250px', position: 'relative' }}>
                    <span style={{ position: 'absolute', left: '12px', top: '50%', transform: 'translateY(-50%)', color: theme.textSecondary }}>üîç</span>
                    <input
                        type="text"
                        placeholder="Search by plate, name, phone..."
                        value={searchQuery}
                        onChange={(e) => setSearchQuery(e.target.value)}
                        style={{ width: '100%', padding: '10px 12px 10px 40px', border: `1px solid ${theme.border}`, borderRadius: '0', fontSize: '14px', backgroundColor: theme.inputBg, color: theme.text }}
                    />
                </div>
                {activeTab === 'queue' && (
                    <select
                        value={statusFilter}
                        onChange={(e) => setStatusFilter(e.target.value)}
                        style={{ padding: '10px 12px', border: `1px solid ${theme.border}`, borderRadius: '0', fontSize: '14px', backgroundColor: theme.inputBg, color: theme.text, minWidth: '150px' }}
                    >
                        <option value="all">All Priorities</option>
                        {PRIORITY_OPTIONS.map(p => (
                            <option key={p.id} value={p.id}>{p.name}</option>
                        ))}
                    </select>
                )}
            </div>

            {/* Data Table - Responsive */}
            <div style={{ background: theme.bg, borderRadius: '0', boxShadow: theme.cardShadow, border: `1px solid ${theme.border}`, overflow: 'hidden' }}>
                <div style={{ overflowX: 'auto', WebkitOverflowScrolling: 'touch' }}>
                    <table style={{ width: '100%', borderCollapse: 'collapse', minWidth: '1000px' }}>
                        <thead>
                            <tr style={{ backgroundColor: theme.bgTertiary }}>
                                <th style={{ padding: '14px 16px', textAlign: 'left', fontSize: '13px', fontWeight: '600', color: theme.textSecondary, borderBottom: `1px solid ${theme.border}`, whiteSpace: 'nowrap' }}>Vehicle</th>
                                <th style={{ padding: '14px 16px', textAlign: 'left', fontSize: '13px', fontWeight: '600', color: theme.textSecondary, borderBottom: `1px solid ${theme.border}`, whiteSpace: 'nowrap' }}>Customer</th>
                                <th style={{ padding: '14px 16px', textAlign: 'left', fontSize: '13px', fontWeight: '600', color: theme.textSecondary, borderBottom: `1px solid ${theme.border}`, whiteSpace: 'nowrap' }}>Services</th>
                                <th style={{ padding: '14px 16px', textAlign: 'left', fontSize: '13px', fontWeight: '600', color: theme.textSecondary, borderBottom: `1px solid ${theme.border}`, whiteSpace: 'nowrap' }}>Assigned To</th>
                                <th style={{ padding: '14px 16px', textAlign: 'left', fontSize: '13px', fontWeight: '600', color: theme.textSecondary, borderBottom: `1px solid ${theme.border}`, whiteSpace: 'nowrap' }}>
                                    {activeTab === 'queue' ? 'Priority' : 'Status'}
                                </th>
                                <th style={{ padding: '14px 16px', textAlign: 'right', fontSize: '13px', fontWeight: '600', color: theme.textSecondary, borderBottom: `1px solid ${theme.border}`, whiteSpace: 'nowrap' }}>Cost</th>
                                <th style={{ padding: '14px 16px', textAlign: 'left', fontSize: '13px', fontWeight: '600', color: theme.textSecondary, borderBottom: `1px solid ${theme.border}`, whiteSpace: 'nowrap' }}>Time</th>
                                <th style={{ padding: '14px 16px', textAlign: 'right', fontSize: '13px', fontWeight: '600', color: theme.textSecondary, borderBottom: `1px solid ${theme.border}`, whiteSpace: 'nowrap' }}>Actions</th>
                            </tr>
                    </thead>
                    <tbody>
                        {filteredData.length === 0 ? (
                            <tr>
                                <td colSpan="8" style={{ padding: '48px', textAlign: 'center', color: theme.textSecondary }}>
                                    <div>
                                        <span style={{ fontSize: '48px', display: 'block', marginBottom: '12px' }}>
                                            {activeTab === 'queue' ? 'üìã' : activeTab === 'jobs' ? 'üîß' : '‚úÖ'}
                                        </span>
                                        <p style={{ margin: 0 }}>
                                            {activeTab === 'queue' ? 'No vehicles in queue' : activeTab === 'jobs' ? 'No jobs in progress' : 'No completed jobs today'}
                                        </p>
                                    </div>
                                </td>
                            </tr>
                        ) : (
                            paginatedData.map(item => (
                                <tr key={item.id} style={{ borderBottom: `1px solid ${theme.border}` }}>
                                    <td style={{ padding: '14px 16px' }}>
                                        <div style={{ fontWeight: '600', color: theme.text }}>{item.plateNumber}</div>
                                        <div style={{ fontSize: '13px', color: theme.textSecondary }}>{item.vehicleType}</div>
                                    </td>
                                    <td style={{ padding: '14px 16px' }}>
                                        <div style={{ color: theme.text }}>{item.customerName || '-'}</div>
                                        <div style={{ fontSize: '13px', color: theme.textSecondary }}>{item.customerPhone || '-'}</div>
                                    </td>
                                    <td style={{ padding: '14px 16px' }}>
                                        {item.services?.length > 0 ? (
                                            <div style={{ display: 'flex', gap: '4px', flexWrap: 'wrap' }}>
                                                {item.services.slice(0, 2).map((sId, idx) => {
                                                    const service = garageServices.find(s => s.id === sId);
                                                    return service ? (
                                                        <span key={idx} style={{ fontSize: '12px', padding: '2px 8px', backgroundColor: theme.bgTertiary, borderRadius: '0', color: theme.text }}>
                                                            {service.name}
                                                        </span>
                                                    ) : null;
                                                })}
                                                {item.services.length > 2 && (
                                                    <span style={{ fontSize: '12px', padding: '2px 8px', backgroundColor: theme.bgTertiary, borderRadius: '0', color: theme.textSecondary }}>
                                                        +{item.services.length - 2} more
                                                    </span>
                                                )}
                                            </div>
                                        ) : (
                                            <span style={{ color: theme.textMuted, fontSize: '13px' }}>No services</span>
                                        )}
                                        {item.notes && (
                                            <div style={{ fontSize: '12px', color: theme.textSecondary, marginTop: '4px' }}>{item.notes}</div>
                                        )}
                                    </td>
                                    <td style={{ padding: '14px 16px' }}>
                                        {item.assignedTo ? (
                                            <span style={{
                                                display: 'inline-flex',
                                                alignItems: 'center',
                                                gap: '6px',
                                                padding: '4px 10px',
                                                borderRadius: '0',
                                                fontSize: '12px',
                                                fontWeight: '500',
                                                backgroundColor: '#dbeafe',
                                                color: '#2563eb'
                                            }}>
                                                üë§ {item.assignedTo}
                                            </span>
                                        ) : (
                                            <span style={{ color: theme.textMuted, fontSize: '13px' }}>Unassigned</span>
                                        )}
                                    </td>
                                    <td style={{ padding: '14px 16px' }}>
                                        {activeTab === 'queue' ? (
                                            <span style={{
                                                display: 'inline-flex',
                                                alignItems: 'center',
                                                gap: '6px',
                                                padding: '4px 10px',
                                                borderRadius: '0',
                                                fontSize: '12px',
                                                fontWeight: '500',
                                                backgroundColor: `${getPriorityColor(item.priority)}20`,
                                                color: getPriorityColor(item.priority)
                                            }}>
                                                <span style={{ width: '6px', height: '6px', borderRadius: '0', backgroundColor: getPriorityColor(item.priority) }}></span>
                                                {PRIORITY_OPTIONS.find(p => p.id === item.priority)?.name || 'Normal'}
                                            </span>
                                        ) : (
                                            <span style={{
                                                display: 'inline-flex',
                                                alignItems: 'center',
                                                gap: '6px',
                                                padding: '4px 10px',
                                                borderRadius: '0',
                                                fontSize: '12px',
                                                fontWeight: '500',
                                                backgroundColor: item.status === 'completed' ? '#d1fae520' : '#fef3c720',
                                                color: item.status === 'completed' ? '#10b981' : '#f59e0b'
                                            }}>
                                                {item.status === 'completed' ? '‚úÖ Completed' : 'üîß In Progress'}
                                            </span>
                                        )}
                                    </td>
                                    <td style={{ padding: '14px 16px', textAlign: 'right' }}>
                                        <span style={{ fontWeight: '600', color: '#10b981', fontSize: '14px' }}>
                                            {formatCurrency(item.services?.reduce((sum, sId) => {
                                                const service = garageServices.find(s => s.id === sId);
                                                return sum + (service?.price || 0);
                                            }, 0) || item.totalCost || 0)}
                                        </span>
                                    </td>
                                    <td style={{ padding: '14px 16px', color: theme.textSecondary, fontSize: '13px' }}>
                                        {formatTimeAgo(item.addedAt || item.startedAt || item.createdAt)}
                                    </td>
                                    <td style={{ padding: '14px 16px', textAlign: 'right' }}>
                                        <div style={{ display: 'flex', gap: '8px', justifyContent: 'flex-end' }}>
                                            {/* View button for all tabs */}
                                            <button
                                                onClick={() => handleViewItem(item)}
                                                style={{ padding: '6px 12px', backgroundColor: '#dbeafe', color: '#2563eb', border: 'none', borderRadius: '0', cursor: 'pointer', fontSize: '13px', fontWeight: '500' }}
                                            >
                                                View
                                            </button>
                                            
                                            {activeTab === 'queue' && (
                                                <>
                                                    <button
                                                        onClick={() => handleStartJob(item)}
                                                        disabled={actionLoading}
                                                        style={{ padding: '6px 12px', backgroundColor: '#10b981', color: 'white', border: 'none', borderRadius: '0', cursor: 'pointer', fontSize: '13px', fontWeight: '500' }}
                                                    >
                                                        Start Job
                                                    </button>
                                                    <button
                                                        onClick={() => handleRemoveFromQueue(item.id)}
                                                        disabled={actionLoading}
                                                        style={{ padding: '6px 12px', backgroundColor: '#fee2e2', color: '#dc2626', border: 'none', borderRadius: '0', cursor: 'pointer', fontSize: '13px', fontWeight: '500' }}
                                                    >
                                                        Remove
                                                    </button>
                                                </>
                                            )}
                                            {activeTab === 'jobs' && (
                                                <>
                                                    <button
                                                        onClick={() => handleShowNotes(item)}
                                                        style={{ padding: '6px 12px', backgroundColor: '#fef3c7', color: '#d97706', border: 'none', borderRadius: '0', cursor: 'pointer', fontSize: '13px', fontWeight: '500' }}
                                                    >
                                                        üìù Notes
                                                    </button>
                                                    <button
                                                        onClick={() => handleCompleteJob(item)}
                                                        disabled={actionLoading}
                                                        style={{ padding: '6px 12px', backgroundColor: '#10b981', color: 'white', border: 'none', borderRadius: '0', cursor: 'pointer', fontSize: '13px', fontWeight: '500' }}
                                                    >
                                                        {actionLoading ? 'Completing...' : 'Complete'}
                                                    </button>
                                                </>
                                            )}
                                            {activeTab === 'completed' && (
                                                <>
                                                    <button
                                                        onClick={() => handleShowHistory(item)}
                                                        style={{ padding: '6px 12px', backgroundColor: '#e0e7ff', color: '#4338ca', border: 'none', borderRadius: '0', cursor: 'pointer', fontSize: '13px', fontWeight: '500' }}
                                                    >
                                                        üìú History
                                                    </button>
                                                    <button
                                                        onClick={() => handleShowReceipt(item)}
                                                        style={{ padding: '6px 12px', backgroundColor: '#f0fdf4', color: '#16a34a', border: 'none', borderRadius: '0', cursor: 'pointer', fontSize: '13px', fontWeight: '500' }}
                                                    >
                                                        Receipt
                                                    </button>
                                                    <button
                                                        onClick={() => handleDeleteJob(item.id)}
                                                        disabled={actionLoading}
                                                        style={{ padding: '6px 12px', backgroundColor: '#fee2e2', color: '#dc2626', border: 'none', borderRadius: '0', cursor: 'pointer', fontSize: '13px', fontWeight: '500' }}
                                                    >
                                                        Delete
                                                    </button>
                                                </>
                                            )}
                                        </div>
                                    </td>
                                </tr>
                            ))
                        )}
                    </tbody>
                </table>
                </div>
            </div>

            {/* Pagination Controls */}
            {totalItems > 0 && (
                <div style={{ 
                    display: 'flex', 
                    justifyContent: 'space-between', 
                    alignItems: 'center', 
                    padding: '16px 20px', 
                    backgroundColor: theme.bg, 
                    border: `1px solid ${theme.border}`, 
                    borderTop: 'none',
                    flexWrap: 'wrap',
                    gap: '12px'
                }}>
                    {/* Items per page selector */}
                    <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                        <span style={{ fontSize: '13px', color: theme.textSecondary }}>Show</span>
                        <select 
                            value={itemsPerPage} 
                            onChange={(e) => { setItemsPerPage(Number(e.target.value)); setCurrentPage(1); }}
                            style={{ padding: '6px 10px', border: `1px solid ${theme.border}`, borderRadius: '0', fontSize: '13px', backgroundColor: theme.inputBg, color: theme.text }}
                        >
                            <option value={10}>10</option>
                            <option value={25}>25</option>
                            <option value={50}>50</option>
                            <option value={100}>100</option>
                        </select>
                        <span style={{ fontSize: '13px', color: theme.textSecondary }}>entries</span>
                    </div>

                    {/* Info text */}
                    <div style={{ fontSize: '13px', color: theme.textSecondary }}>
                        Showing {startIndex + 1} to {Math.min(endIndex, totalItems)} of {totalItems} entries
                    </div>

                    {/* Page navigation */}
                    <div style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                        <button
                            onClick={() => setCurrentPage(1)}
                            disabled={currentPage === 1}
                            style={{ 
                                padding: '6px 10px', 
                                border: `1px solid ${theme.border}`, 
                                borderRadius: '0', 
                                backgroundColor: currentPage === 1 ? theme.bgTertiary : theme.bg, 
                                color: currentPage === 1 ? theme.textMuted : theme.text, 
                                cursor: currentPage === 1 ? 'not-allowed' : 'pointer',
                                fontSize: '13px'
                            }}
                        >
                            ‚ü™
                        </button>
                        <button
                            onClick={() => setCurrentPage(p => Math.max(1, p - 1))}
                            disabled={currentPage === 1}
                            style={{ 
                                padding: '6px 12px', 
                                border: `1px solid ${theme.border}`, 
                                borderRadius: '0', 
                                backgroundColor: currentPage === 1 ? theme.bgTertiary : theme.bg, 
                                color: currentPage === 1 ? theme.textMuted : theme.text, 
                                cursor: currentPage === 1 ? 'not-allowed' : 'pointer',
                                fontSize: '13px'
                            }}
                        >
                            ‚Äπ Prev
                        </button>
                        
                        {/* Page numbers */}
                        {(() => {
                            const pages = [];
                            const maxVisible = 5;
                            let start = Math.max(1, currentPage - Math.floor(maxVisible / 2));
                            let end = Math.min(totalPages, start + maxVisible - 1);
                            if (end - start + 1 < maxVisible) {
                                start = Math.max(1, end - maxVisible + 1);
                            }
                            
                            if (start > 1) {
                                pages.push(
                                    <button key={1} onClick={() => setCurrentPage(1)} style={{ padding: '6px 12px', border: `1px solid ${theme.border}`, borderRadius: '0', backgroundColor: theme.bg, color: theme.text, cursor: 'pointer', fontSize: '13px' }}>1</button>
                                );
                                if (start > 2) pages.push(<span key="dots1" style={{ padding: '0 4px', color: theme.textSecondary }}>...</span>);
                            }
                            
                            for (let i = start; i <= end; i++) {
                                pages.push(
                                    <button 
                                        key={i} 
                                        onClick={() => setCurrentPage(i)}
                                        style={{ 
                                            padding: '6px 12px', 
                                            border: `1px solid ${currentPage === i ? '#3b82f6' : theme.border}`, 
                                            borderRadius: '0', 
                                            backgroundColor: currentPage === i ? '#3b82f6' : theme.bg, 
                                            color: currentPage === i ? 'white' : theme.text, 
                                            cursor: 'pointer',
                                            fontSize: '13px',
                                            fontWeight: currentPage === i ? '600' : '400'
                                        }}
                                    >
                                        {i}
                                    </button>
                                );
                            }
                            
                            if (end < totalPages) {
                                if (end < totalPages - 1) pages.push(<span key="dots2" style={{ padding: '0 4px', color: theme.textSecondary }}>...</span>);
                                pages.push(
                                    <button key={totalPages} onClick={() => setCurrentPage(totalPages)} style={{ padding: '6px 12px', border: `1px solid ${theme.border}`, borderRadius: '0', backgroundColor: theme.bg, color: theme.text, cursor: 'pointer', fontSize: '13px' }}>{totalPages}</button>
                                );
                            }
                            
                            return pages;
                        })()}
                        
                        <button
                            onClick={() => setCurrentPage(p => Math.min(totalPages, p + 1))}
                            disabled={currentPage === totalPages}
                            style={{ 
                                padding: '6px 12px', 
                                border: `1px solid ${theme.border}`, 
                                borderRadius: '0', 
                                backgroundColor: currentPage === totalPages ? theme.bgTertiary : theme.bg, 
                                color: currentPage === totalPages ? theme.textMuted : theme.text, 
                                cursor: currentPage === totalPages ? 'not-allowed' : 'pointer',
                                fontSize: '13px'
                            }}
                        >
                            Next ‚Ä∫
                        </button>
                        <button
                            onClick={() => setCurrentPage(totalPages)}
                            disabled={currentPage === totalPages}
                            style={{ 
                                padding: '6px 10px', 
                                border: `1px solid ${theme.border}`, 
                                borderRadius: '0', 
                                backgroundColor: currentPage === totalPages ? theme.bgTertiary : theme.bg, 
                                color: currentPage === totalPages ? theme.textMuted : theme.text, 
                                cursor: currentPage === totalPages ? 'not-allowed' : 'pointer',
                                fontSize: '13px'
                            }}
                        >
                            ‚ü´
                        </button>
                    </div>
                </div>
            )}

            {/* Add Vehicle Modal */}
            {showAddModal && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: theme.modalOverlay, display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000, padding: '20px' }}>
                    <div style={{ backgroundColor: theme.bg, borderRadius: '0', width: '100%', maxWidth: '600px', maxHeight: '90vh', overflow: 'auto', boxShadow: '0 25px 50px -12px rgba(0,0,0,0.25)' }}>
                        <div style={{ padding: '20px 24px', borderBottom: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <h2 style={{ margin: 0, fontSize: '18px', fontWeight: '600', color: theme.text }}>Add Vehicle to Garage Queue</h2>
                            <button onClick={() => setShowAddModal(false)} style={{ background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer', color: theme.textSecondary }}>√ó</button>
                        </div>
                        <div style={{ padding: '24px' }}>
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px', marginBottom: '16px' }}>
                                <div>
                                    <label style={{ display: 'block', fontSize: '13px', color: theme.textSecondary, marginBottom: '6px' }}>Plate Number *</label>
                                    <input
                                        type="text"
                                        value={formData.plateNumber}
                                        onChange={(e) => setFormData(prev => ({ ...prev, plateNumber: e.target.value.toUpperCase() }))}
                                        placeholder="e.g., KAB 123A"
                                        style={{ width: '100%', padding: '10px 12px', border: `1px solid ${theme.border}`, borderRadius: '0', fontSize: '14px', backgroundColor: theme.inputBg, color: theme.text }}
                                    />
                                </div>
                                <div>
                                    <label style={{ display: 'block', fontSize: '13px', color: theme.textSecondary, marginBottom: '6px' }}>Vehicle Type</label>
                                    <select
                                        value={formData.vehicleType}
                                        onChange={(e) => setFormData(prev => ({ ...prev, vehicleType: e.target.value }))}
                                        style={{ width: '100%', padding: '10px 12px', border: `1px solid ${theme.border}`, borderRadius: '0', fontSize: '14px', backgroundColor: theme.inputBg, color: theme.text }}
                                    >
                                        {VEHICLE_TYPES.map(type => (
                                            <option key={type} value={type}>{type}</option>
                                        ))}
                                    </select>
                                </div>
                            </div>
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px', marginBottom: '16px' }}>
                                <div>
                                    <label style={{ display: 'block', fontSize: '13px', color: theme.textSecondary, marginBottom: '6px' }}>Customer Name</label>
                                    <input
                                        type="text"
                                        value={formData.customerName}
                                        onChange={(e) => setFormData(prev => ({ ...prev, customerName: e.target.value }))}
                                        placeholder="Customer name"
                                        style={{ width: '100%', padding: '10px 12px', border: `1px solid ${theme.border}`, borderRadius: '0', fontSize: '14px', backgroundColor: theme.inputBg, color: theme.text }}
                                    />
                                </div>
                                <div>
                                    <label style={{ display: 'block', fontSize: '13px', color: theme.textSecondary, marginBottom: '6px' }}>Phone Number</label>
                                    <input
                                        type="tel"
                                        value={formData.customerPhone}
                                        onChange={(e) => setFormData(prev => ({ ...prev, customerPhone: e.target.value }))}
                                        placeholder="0700 000 000"
                                        style={{ width: '100%', padding: '10px 12px', border: `1px solid ${theme.border}`, borderRadius: '0', fontSize: '14px', backgroundColor: theme.inputBg, color: theme.text }}
                                    />
                                </div>
                            </div>
                            <div style={{ marginBottom: '16px' }}>
                                <label style={{ display: 'block', fontSize: '13px', color: theme.textSecondary, marginBottom: '6px' }}>Priority</label>
                                <div style={{ display: 'flex', gap: '8px' }}>
                                    {PRIORITY_OPTIONS.map(p => (
                                        <button
                                            key={p.id}
                                            onClick={() => setFormData(prev => ({ ...prev, priority: p.id }))}
                                            style={{
                                                padding: '8px 16px',
                                                borderRadius: '0',
                                                border: formData.priority === p.id ? `2px solid ${p.color}` : `1px solid ${theme.border}`,
                                                backgroundColor: formData.priority === p.id ? `${p.color}15` : theme.bg,
                                                color: formData.priority === p.id ? p.color : theme.text,
                                                cursor: 'pointer',
                                                fontSize: '13px',
                                                fontWeight: '500'
                                            }}
                                        >
                                            {p.name}
                                        </button>
                                    ))}
                                </div>
                            </div>
                            <div style={{ marginBottom: '16px' }}>
                                <label style={{ display: 'block', fontSize: '13px', color: theme.textSecondary, marginBottom: '6px' }}>Assigned Technician</label>
                                {staffList.length === 0 ? (
                                    <div style={{
                                        padding: '12px',
                                        backgroundColor: theme.bgSecondary, 
                                        borderRadius: '0',
                                        border: `1px dashed ${theme.border}`,
                                        textAlign: 'center',
                                        color: theme.textSecondary,
                                        fontSize: '13px'
                                    }}>
                                        No technicians available. Add staff in Staff Management.
                                    </div>
                                ) : (
                                    <select
                                        value={formData.assignedTo}
                                        onChange={e => setFormData(prev => ({ ...prev, assignedTo: e.target.value }))}
                                        style={{
                                            width: '100%',
                                            padding: '10px 12px',
                                            borderRadius: '0',
                                            border: `1px solid ${theme.border}`,
                                            backgroundColor: theme.inputBg,
                                            color: theme.text,
                                            fontSize: '14px'
                                        }}
                                    >
                                        <option value="">-- Select Technician (Optional) --</option>
                                        {staffList.map(staff => (
                                            <option key={staff.id} value={staff.name}>
                                                {staff.name} ({staff.role})
                                            </option>
                                        ))}
                                    </select>
                                )}
                            </div>
                            <div style={{ marginBottom: '16px' }}>
                                <label style={{ display: 'block', fontSize: '13px', color: theme.textSecondary, marginBottom: '6px' }}>Services Required</label>
                                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '8px', maxHeight: '200px', overflowY: 'auto', padding: '4px' }}>
                                    {garageServices.map(service => (
                                        <div
                                            key={service.id}
                                            onClick={() => toggleService(service.id)}
                                            style={{
                                                padding: '12px',
                                                borderRadius: '0',
                                                border: formData.services.includes(service.id) ? '2px solid #3b82f6' : `1px solid ${theme.border}`,
                                                backgroundColor: formData.services.includes(service.id) ? '#dbeafe' : theme.bg,
                                                cursor: 'pointer',
                                                transition: 'all 0.2s'
                                            }}
                                        >
                                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                                                <div>
                                                    <div style={{ fontWeight: '500', color: theme.text, fontSize: '14px' }}>{service.name}</div>
                                                    <div style={{ fontSize: '12px', color: theme.textSecondary, marginTop: '2px' }}>{service.duration} mins</div>
                                                </div>
                                                <div style={{ fontWeight: '600', color: '#3b82f6', fontSize: '14px' }}>{formatCurrency(service.price)}</div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                {formData.services.length > 0 && (
                                    <div style={{ marginTop: '12px', padding: '12px', backgroundColor: theme.bgTertiary, borderRadius: '0', display: 'flex', justifyContent: 'space-between' }}>
                                        <span style={{ color: theme.textSecondary }}>{formData.services.length} service(s) selected</span>
                                        <span style={{ fontWeight: '600', color: theme.text }}>
                                            Total: {formatCurrency(formData.services.reduce((sum, sId) => {
                                                const service = garageServices.find(s => s.id === sId);
                                                return sum + (service?.price || 0);
                                            }, 0))}
                                        </span>
                                    </div>
                                )}
                            </div>
                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'block', fontSize: '13px', color: theme.textSecondary, marginBottom: '6px' }}>Notes</label>
                                <textarea
                                    value={formData.notes}
                                    onChange={(e) => setFormData(prev => ({ ...prev, notes: e.target.value }))}
                                    placeholder="Additional notes..."
                                    rows={3}
                                    style={{ width: '100%', padding: '10px 12px', border: `1px solid ${theme.border}`, borderRadius: '0', fontSize: '14px', backgroundColor: theme.inputBg, color: theme.text, resize: 'vertical' }}
                                />
                            </div>
                            <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end' }}>
                                <button
                                    onClick={() => setShowAddModal(false)}
                                    style={{ padding: '10px 20px', backgroundColor: theme.bgTertiary, color: theme.text, border: 'none', borderRadius: '0', cursor: 'pointer', fontSize: '14px' }}
                                >
                                    Cancel
                                </button>
                                <button
                                    onClick={handleAddToQueue}
                                    disabled={actionLoading || !formData.plateNumber.trim()}
                                    style={{ padding: '10px 20px', backgroundColor: '#3b82f6', color: 'white', border: 'none', borderRadius: '0', cursor: 'pointer', fontSize: '14px', fontWeight: '500' }}
                                >
                                    {actionLoading ? 'Adding...' : 'Add to Queue'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* View Modal */}
            {showViewModal && selectedItem && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: theme.modalOverlay, display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000, padding: '20px' }}>
                    <div style={{ backgroundColor: theme.bg, borderRadius: '0', width: '100%', maxWidth: '500px', maxHeight: '90vh', overflow: 'auto', boxShadow: '0 25px 50px -12px rgba(0,0,0,0.25)' }}>
                        <div style={{ padding: '20px 24px', borderBottom: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <h2 style={{ margin: 0, fontSize: '18px', fontWeight: '600', color: theme.text }}>Vehicle Details</h2>
                            <button onClick={() => setShowViewModal(false)} style={{ background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer', color: theme.textSecondary }}>√ó</button>
                        </div>
                        <div style={{ padding: '24px' }}>
                            {/* Vehicle Info */}
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px', marginBottom: '20px' }}>
                                <div>
                                    <div style={{ fontSize: '12px', color: theme.textSecondary, marginBottom: '4px' }}>Plate Number</div>
                                    <div style={{ fontSize: '18px', fontWeight: '600', color: theme.text }}>{selectedItem.plateNumber}</div>
                                </div>
                                <div>
                                    <div style={{ fontSize: '12px', color: theme.textSecondary, marginBottom: '4px' }}>Vehicle Type</div>
                                    <div style={{ fontSize: '16px', color: theme.text }}>{selectedItem.vehicleType || 'N/A'}</div>
                                </div>
                            </div>

                            {/* Customer Info */}
                            <div style={{ backgroundColor: theme.bgTertiary, padding: '16px', marginBottom: '20px' }}>
                                <div style={{ fontSize: '13px', fontWeight: '600', color: theme.text, marginBottom: '12px' }}>Customer Information</div>
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' }}>
                                    <div>
                                        <div style={{ fontSize: '12px', color: theme.textSecondary }}>Name</div>
                                        <div style={{ fontSize: '14px', color: theme.text }}>{selectedItem.customerName || 'Walk-in Customer'}</div>
                                    </div>
                                    <div>
                                        <div style={{ fontSize: '12px', color: theme.textSecondary }}>Phone</div>
                                        <div style={{ fontSize: '14px', color: theme.text }}>{selectedItem.customerPhone || 'N/A'}</div>
                                    </div>
                                </div>
                            </div>

                            {/* Status */}
                            <div style={{ marginBottom: '20px', display: 'flex', gap: '24px' }}>
                                <div>
                                    <div style={{ fontSize: '12px', color: theme.textSecondary, marginBottom: '8px' }}>Status</div>
                                    <span style={{
                                        display: 'inline-block',
                                        padding: '6px 14px',
                                        backgroundColor: selectedItem.status === 'completed' ? '#d1fae5' : selectedItem.status === 'in-progress' ? '#fef3c7' : '#dbeafe',
                                        color: selectedItem.status === 'completed' ? '#059669' : selectedItem.status === 'in-progress' ? '#d97706' : '#2563eb',
                                        fontWeight: '500',
                                        fontSize: '13px'
                                    }}>
                                        {selectedItem.status === 'completed' ? '‚úÖ Completed' : selectedItem.status === 'in-progress' ? 'üîß In Progress' : '‚è≥ Waiting'}
                                    </span>
                                </div>
                                <div>
                                    <div style={{ fontSize: '12px', color: theme.textSecondary, marginBottom: '8px' }}>Assigned Technician</div>
                                    <span style={{
                                        display: 'inline-block',
                                        padding: '6px 14px',
                                        backgroundColor: selectedItem.assignedTo ? '#dbeafe' : theme.bgTertiary,
                                        color: selectedItem.assignedTo ? '#2563eb' : theme.textSecondary,
                                        fontWeight: '500',
                                        fontSize: '13px'
                                    }}>
                                        {selectedItem.assignedTo ? `üë§ ${selectedItem.assignedTo}` : 'Unassigned'}
                                    </span>
                                </div>
                            </div>

                            {/* Services */}
                            <div style={{ marginBottom: '20px' }}>
                                <div style={{ fontSize: '13px', fontWeight: '600', color: theme.text, marginBottom: '12px' }}>Services</div>
                                {selectedItem.services?.length > 0 ? (
                                    <div style={{ border: `1px solid ${theme.border}` }}>
                                        {selectedItem.services.map((sId, idx) => {
                                            const service = garageServices.find(s => s.id === sId);
                                            return service ? (
                                                <div key={idx} style={{ display: 'flex', justifyContent: 'space-between', padding: '12px', borderBottom: idx < selectedItem.services.length - 1 ? `1px solid ${theme.border}` : 'none' }}>
                                                    <div>
                                                        <div style={{ color: theme.text, fontWeight: '500' }}>{service.name}</div>
                                                        <div style={{ fontSize: '12px', color: theme.textSecondary }}>{service.duration} mins</div>
                                                    </div>
                                                    <div style={{ fontWeight: '600', color: '#3b82f6' }}>{formatCurrency(service.price)}</div>
                                                </div>
                                            ) : null;
                                        })}
                                        <div style={{ display: 'flex', justifyContent: 'space-between', padding: '12px', backgroundColor: theme.bgTertiary, fontWeight: '600' }}>
                                            <span style={{ color: theme.text }}>Total</span>
                                            <span style={{ color: '#10b981', fontSize: '16px' }}>
                                                {formatCurrency(selectedItem.services.reduce((sum, sId) => {
                                                    const service = garageServices.find(s => s.id === sId);
                                                    return sum + (service?.price || 0);
                                                }, 0))}
                                            </span>
                                        </div>
                                    </div>
                                ) : (
                                    <div style={{ padding: '16px', backgroundColor: theme.bgTertiary, color: theme.textSecondary, textAlign: 'center' }}>No services selected</div>
                                )}
                            </div>

                            {/* Notes */}
                            {selectedItem.notes && (
                                <div style={{ marginBottom: '20px' }}>
                                    <div style={{ fontSize: '12px', color: theme.textSecondary, marginBottom: '8px' }}>Notes</div>
                                    <div style={{ padding: '12px', backgroundColor: theme.bgTertiary, color: theme.text, fontSize: '14px' }}>{selectedItem.notes}</div>
                                </div>
                            )}

                            {/* Timestamps */}
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px', fontSize: '12px', color: theme.textSecondary }}>
                                <div>
                                    <span>Added: </span>
                                    <span style={{ color: theme.text }}>{new Date(selectedItem.addedAt || selectedItem.createdAt).toLocaleString()}</span>
                                </div>
                                {selectedItem.startedAt && (
                                    <div>
                                        <span>Started: </span>
                                        <span style={{ color: theme.text }}>{new Date(selectedItem.startedAt).toLocaleString()}</span>
                                    </div>
                                )}
                                {selectedItem.completedAt && (
                                    <div>
                                        <span>Completed: </span>
                                        <span style={{ color: theme.text }}>{new Date(selectedItem.completedAt).toLocaleString()}</span>
                                    </div>
                                )}
                            </div>
                        </div>
                        <div style={{ padding: '16px 24px', borderTop: `1px solid ${theme.border}`, display: 'flex', gap: '12px', justifyContent: 'flex-end' }}>
                            <button
                                onClick={() => { setShowViewModal(false); handleShowReceipt(selectedItem); }}
                                style={{ padding: '10px 20px', backgroundColor: '#f0fdf4', color: '#16a34a', border: 'none', borderRadius: '0', cursor: 'pointer', fontSize: '14px', fontWeight: '500' }}
                            >
                                üßæ View Receipt
                            </button>
                            <button
                                onClick={() => setShowViewModal(false)}
                                style={{ padding: '10px 20px', backgroundColor: theme.bgTertiary, color: theme.text, border: 'none', borderRadius: '0', cursor: 'pointer', fontSize: '14px' }}
                            >
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* Receipt Modal */}
            {showReceiptModal && selectedItem && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: theme.modalOverlay, display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000, padding: '20px' }}>
                    <div style={{ backgroundColor: 'white', borderRadius: '0', width: '100%', maxWidth: '420px', maxHeight: '90vh', overflow: 'auto', boxShadow: '0 25px 50px -12px rgba(0,0,0,0.25)' }}>
                        {/* Receipt Header */}
                        <div style={{ padding: '24px', textAlign: 'center', borderBottom: '2px solid #333' }}>
                            <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#333' }}>üîß ECOSPARK GARAGE</div>
                            <div style={{ color: '#666', fontSize: '12px', marginTop: '4px' }}>Auto Service Receipt</div>
                        </div>

                        <div style={{ padding: '20px 24px' }}>
                            {/* Receipt Number & Date */}
                            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '16px', paddingBottom: '16px', borderBottom: '1px dashed #ddd' }}>
                                <div>
                                    <div style={{ fontSize: '11px', color: '#666' }}>Receipt No.</div>
                                    <div style={{ fontWeight: '600', color: '#333' }}>#GRG-{selectedItem.id?.slice(-8) || Date.now().toString().slice(-8)}</div>
                                </div>
                                <div style={{ textAlign: 'right' }}>
                                    <div style={{ fontSize: '11px', color: '#666' }}>Date</div>
                                    <div style={{ fontWeight: '500', color: '#333' }}>{new Date().toLocaleDateString()}</div>
                                </div>
                            </div>

                            {/* Vehicle & Customer */}
                            <div style={{ marginBottom: '16px', paddingBottom: '16px', borderBottom: '1px dashed #ddd' }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '8px' }}>
                                    <span style={{ color: '#666', fontSize: '13px' }}>Vehicle:</span>
                                    <span style={{ fontWeight: '600', color: '#333' }}>{selectedItem.plateNumber}</span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '8px' }}>
                                    <span style={{ color: '#666', fontSize: '13px' }}>Type:</span>
                                    <span style={{ color: '#333' }}>{selectedItem.vehicleType || 'N/A'}</span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '8px' }}>
                                    <span style={{ color: '#666', fontSize: '13px' }}>Customer:</span>
                                    <span style={{ color: '#333' }}>{selectedItem.customerName || 'Walk-in'}</span>
                                </div>
                                {selectedItem.customerPhone && (
                                    <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                                        <span style={{ color: '#666', fontSize: '13px' }}>Phone:</span>
                                        <span style={{ color: '#333' }}>{selectedItem.customerPhone}</span>
                                    </div>
                                )}
                            </div>

                            {/* Services List */}
                            <div style={{ marginBottom: '16px' }}>
                                <div style={{ fontWeight: '600', color: '#333', marginBottom: '12px', fontSize: '14px' }}>Services</div>
                                {selectedItem.services?.length > 0 ? (
                                    selectedItem.services.map((sId, idx) => {
                                        const service = garageServices.find(s => s.id === sId);
                                        return service ? (
                                            <div key={idx} style={{ display: 'flex', justifyContent: 'space-between', padding: '8px 0', borderBottom: '1px solid #eee' }}>
                                                <span style={{ color: '#333' }}>{service.name}</span>
                                                <span style={{ fontWeight: '500', color: '#333' }}>KSh {(service.price || 0).toLocaleString()}</span>
                                            </div>
                                        ) : null;
                                    })
                                ) : (
                                    <div style={{ padding: '12px', backgroundColor: '#f5f5f5', color: '#666', textAlign: 'center' }}>No services</div>
                                )}
                            </div>

                            {/* Total */}
                            <div style={{ display: 'flex', justifyContent: 'space-between', padding: '16px 0', borderTop: '2px solid #333', marginTop: '8px' }}>
                                <span style={{ fontSize: '18px', fontWeight: 'bold', color: '#333' }}>TOTAL</span>
                                <span style={{ fontSize: '20px', fontWeight: 'bold', color: '#059669' }}>
                                    KSh {(selectedItem.services?.reduce((sum, sId) => {
                                        const service = garageServices.find(s => s.id === sId);
                                        return sum + (service?.price || 0);
                                    }, 0) || selectedItem.totalCost || 0).toLocaleString()}
                                </span>
                            </div>

                            {/* Status Badge */}
                            <div style={{ textAlign: 'center', marginTop: '16px' }}>
                                <span style={{
                                    display: 'inline-block',
                                    padding: '8px 20px',
                                    backgroundColor: selectedItem.status === 'completed' ? '#d1fae5' : '#fef3c7',
                                    color: selectedItem.status === 'completed' ? '#059669' : '#d97706',
                                    fontWeight: '600',
                                    fontSize: '14px'
                                }}>
                                    {selectedItem.status === 'completed' ? '‚úÖ PAID & COMPLETED' : 'üîß IN PROGRESS'}
                                </span>
                            </div>

                            {/* Notes */}
                            {selectedItem.notes && (
                                <div style={{ marginTop: '16px', padding: '12px', backgroundColor: '#f5f5f5', fontSize: '13px', color: '#666' }}>
                                    <strong>Notes:</strong> {selectedItem.notes}
                                </div>
                            )}
                        </div>

                        {/* Footer */}
                        <div style={{ padding: '16px 24px', borderTop: '1px dashed #ddd', textAlign: 'center' }}>
                            <p style={{ margin: '0 0 8px 0', color: '#666', fontSize: '12px' }}>Thank you for choosing Ecospark!</p>
                            <p style={{ margin: 0, color: '#999', fontSize: '11px' }}>Your vehicle is in safe hands üöó</p>
                        </div>

                        {/* Action Buttons */}
                        <div style={{ padding: '16px 24px', borderTop: `1px solid #eee`, display: 'flex', gap: '12px', justifyContent: 'center', backgroundColor: '#f9fafb' }}>
                            <button
                                onClick={handlePrintReceipt}
                                style={{ padding: '10px 24px', backgroundColor: '#3b82f6', color: 'white', border: 'none', borderRadius: '0', cursor: 'pointer', fontSize: '14px', fontWeight: '500', display: 'flex', alignItems: 'center', gap: '6px' }}
                            >
                                üñ®Ô∏è Print Receipt
                            </button>
                            <button
                                onClick={() => setShowReceiptModal(false)}
                                style={{ padding: '10px 24px', backgroundColor: '#e5e7eb', color: '#374151', border: 'none', borderRadius: '0', cursor: 'pointer', fontSize: '14px' }}
                            >
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* History Modal */}
            {showHistoryModal && selectedItem && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: theme.modalOverlay, display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000, padding: '20px' }}>
                    <div style={{ backgroundColor: theme.bg, borderRadius: '0', width: '100%', maxWidth: '500px', maxHeight: '90vh', overflow: 'auto', boxShadow: '0 25px 50px -12px rgba(0,0,0,0.25)' }}>
                        <div style={{ padding: '20px 24px', borderBottom: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <h2 style={{ margin: 0, fontSize: '18px', fontWeight: '600', color: theme.text }}>üìú Job History</h2>
                            <button onClick={() => setShowHistoryModal(false)} style={{ background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer', color: theme.textSecondary }}>√ó</button>
                        </div>
                        <div style={{ padding: '24px' }}>
                            {/* Vehicle Info Header */}
                            <div style={{ backgroundColor: theme.bgTertiary, padding: '16px', marginBottom: '24px' }}>
                                <div style={{ fontWeight: '600', color: theme.text, fontSize: '16px' }}>{selectedItem.plateNumber}</div>
                                <div style={{ color: theme.textSecondary, fontSize: '13px' }}>{selectedItem.vehicleType} ‚Ä¢ {selectedItem.customerName || 'Walk-in Customer'}</div>
                            </div>

                            {/* Timeline */}
                            <div style={{ position: 'relative', paddingLeft: '24px' }}>
                                {/* Timeline line */}
                                <div style={{ position: 'absolute', left: '8px', top: '8px', bottom: '8px', width: '2px', backgroundColor: theme.border }}></div>

                                {/* Added to Queue */}
                                <div style={{ position: 'relative', marginBottom: '24px' }}>
                                    <div style={{ position: 'absolute', left: '-20px', width: '16px', height: '16px', backgroundColor: '#3b82f6', borderRadius: '50%', border: `2px solid ${theme.bg}` }}></div>
                                    <div style={{ paddingLeft: '8px' }}>
                                        <div style={{ fontWeight: '600', color: theme.text, fontSize: '14px' }}>Added to Queue</div>
                                        <div style={{ color: theme.textSecondary, fontSize: '12px', marginTop: '4px' }}>
                                            {selectedItem.addedAt ? new Date(selectedItem.addedAt).toLocaleString() : 'N/A'}
                                        </div>
                                        <div style={{ color: theme.textSecondary, fontSize: '12px', marginTop: '2px' }}>
                                            Source: {selectedItem.source === 'intake' ? 'Vehicle Intake' : 'Direct Entry'}
                                        </div>
                                    </div>
                                </div>

                                {/* Job Started */}
                                <div style={{ position: 'relative', marginBottom: '24px' }}>
                                    <div style={{ position: 'absolute', left: '-20px', width: '16px', height: '16px', backgroundColor: '#f59e0b', borderRadius: '50%', border: `2px solid ${theme.bg}` }}></div>
                                    <div style={{ paddingLeft: '8px' }}>
                                        <div style={{ fontWeight: '600', color: theme.text, fontSize: '14px' }}>Job Started</div>
                                        <div style={{ color: theme.textSecondary, fontSize: '12px', marginTop: '4px' }}>
                                            {selectedItem.startedAt ? new Date(selectedItem.startedAt).toLocaleString() : 'N/A'}
                                        </div>
                                        <div style={{ color: theme.textSecondary, fontSize: '12px', marginTop: '2px' }}>
                                            Services: {selectedItem.services?.length || 0} selected
                                        </div>
                                    </div>
                                </div>

                                {/* Last Updated (if notes were added) */}
                                {selectedItem.lastUpdated && (
                                    <div style={{ position: 'relative', marginBottom: '24px' }}>
                                        <div style={{ position: 'absolute', left: '-20px', width: '16px', height: '16px', backgroundColor: '#8b5cf6', borderRadius: '50%', border: `2px solid ${theme.bg}` }}></div>
                                        <div style={{ paddingLeft: '8px' }}>
                                            <div style={{ fontWeight: '600', color: theme.text, fontSize: '14px' }}>Notes Updated</div>
                                            <div style={{ color: theme.textSecondary, fontSize: '12px', marginTop: '4px' }}>
                                                {new Date(selectedItem.lastUpdated).toLocaleString()}
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* Completed */}
                                {selectedItem.completedAt && (
                                    <div style={{ position: 'relative' }}>
                                        <div style={{ position: 'absolute', left: '-20px', width: '16px', height: '16px', backgroundColor: '#10b981', borderRadius: '50%', border: `2px solid ${theme.bg}` }}></div>
                                        <div style={{ paddingLeft: '8px' }}>
                                            <div style={{ fontWeight: '600', color: theme.text, fontSize: '14px' }}>‚úÖ Job Completed</div>
                                            <div style={{ color: theme.textSecondary, fontSize: '12px', marginTop: '4px' }}>
                                                {new Date(selectedItem.completedAt).toLocaleString()}
                                            </div>
                                            <div style={{ color: '#10b981', fontWeight: '600', fontSize: '14px', marginTop: '4px' }}>
                                                Total: {formatCurrency(selectedItem.totalCost || 0)}
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>

                            {/* Technician Notes Section */}
                            {selectedItem.technicianNotes && (
                                <div style={{ marginTop: '24px', padding: '16px', backgroundColor: '#fef3c7', border: '1px solid #fcd34d' }}>
                                    <div style={{ fontWeight: '600', color: '#92400e', fontSize: '13px', marginBottom: '8px' }}>üìù Technician Notes</div>
                                    <div style={{ color: '#78350f', fontSize: '14px', whiteSpace: 'pre-wrap' }}>{selectedItem.technicianNotes}</div>
                                </div>
                            )}

                            {/* Initial Notes */}
                            {selectedItem.notes && (
                                <div style={{ marginTop: '16px', padding: '16px', backgroundColor: theme.bgTertiary }}>
                                    <div style={{ fontWeight: '600', color: theme.textSecondary, fontSize: '13px', marginBottom: '8px' }}>Initial Notes</div>
                                    <div style={{ color: theme.text, fontSize: '14px' }}>{selectedItem.notes}</div>
                                </div>
                            )}
                        </div>
                        <div style={{ padding: '16px 24px', borderTop: `1px solid ${theme.border}`, display: 'flex', gap: '12px', justifyContent: 'flex-end' }}>
                            <button
                                onClick={() => setShowHistoryModal(false)}
                                style={{ padding: '10px 20px', backgroundColor: theme.bgTertiary, color: theme.text, border: 'none', borderRadius: '0', cursor: 'pointer', fontSize: '14px' }}
                            >
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* Technician Notes Modal */}
            {showNotesModal && selectedItem && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: theme.modalOverlay, display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000, padding: '20px' }}>
                    <div style={{ backgroundColor: theme.bg, borderRadius: '0', width: '100%', maxWidth: '500px', maxHeight: '90vh', overflow: 'auto', boxShadow: '0 25px 50px -12px rgba(0,0,0,0.25)' }}>
                        <div style={{ padding: '20px 24px', borderBottom: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <h2 style={{ margin: 0, fontSize: '18px', fontWeight: '600', color: theme.text }}>üìù Technician Notes</h2>
                            <button onClick={() => setShowNotesModal(false)} style={{ background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer', color: theme.textSecondary }}>√ó</button>
                        </div>
                        <div style={{ padding: '24px' }}>
                            {/* Vehicle Info */}
                            <div style={{ backgroundColor: theme.bgTertiary, padding: '16px', marginBottom: '20px' }}>
                                <div style={{ fontWeight: '600', color: theme.text, fontSize: '16px' }}>{selectedItem.plateNumber}</div>
                                <div style={{ color: theme.textSecondary, fontSize: '13px' }}>{selectedItem.vehicleType} ‚Ä¢ {selectedItem.customerName || 'Walk-in Customer'}</div>
                            </div>

                            {/* Services Being Worked On */}
                            <div style={{ marginBottom: '20px' }}>
                                <div style={{ fontSize: '13px', fontWeight: '600', color: theme.text, marginBottom: '8px' }}>Services In Progress</div>
                                <div style={{ display: 'flex', gap: '6px', flexWrap: 'wrap' }}>
                                    {selectedItem.services?.map((sId, idx) => {
                                        const service = garageServices.find(s => s.id === sId);
                                        return service ? (
                                            <span key={idx} style={{ fontSize: '12px', padding: '4px 10px', backgroundColor: '#dbeafe', color: '#2563eb' }}>
                                                {service.name}
                                            </span>
                                        ) : null;
                                    })}
                                    {(!selectedItem.services || selectedItem.services.length === 0) && (
                                        <span style={{ color: theme.textMuted, fontSize: '13px' }}>No services selected</span>
                                    )}
                                </div>
                            </div>

                            {/* Notes Input */}
                            <div>
                                <label style={{ display: 'block', fontSize: '13px', fontWeight: '600', color: theme.text, marginBottom: '8px' }}>
                                    Add your notes below:
                                </label>
                                <textarea
                                    value={technicianNotes}
                                    onChange={(e) => setTechnicianNotes(e.target.value)}
                                    placeholder="Describe what was done, parts replaced, issues found, recommendations for customer, etc."
                                    rows={6}
                                    style={{ 
                                        width: '100%', 
                                        padding: '12px', 
                                        border: `1px solid ${theme.border}`, 
                                        borderRadius: '0', 
                                        fontSize: '14px', 
                                        backgroundColor: theme.inputBg, 
                                        color: theme.text, 
                                        resize: 'vertical',
                                        fontFamily: 'inherit'
                                    }}
                                />
                                <div style={{ marginTop: '8px', fontSize: '12px', color: theme.textSecondary }}>
                                    üí° Tip: Include details like parts replaced, labor performed, and any recommendations for future service.
                                </div>
                            </div>
                        </div>
                        <div style={{ padding: '16px 24px', borderTop: `1px solid ${theme.border}`, display: 'flex', gap: '12px', justifyContent: 'flex-end' }}>
                            <button
                                onClick={() => setShowNotesModal(false)}
                                style={{ padding: '10px 20px', backgroundColor: theme.bgTertiary, color: theme.text, border: 'none', borderRadius: '0', cursor: 'pointer', fontSize: '14px' }}
                            >
                                Cancel
                            </button>
                            <button
                                onClick={handleSaveNotes}
                                disabled={actionLoading}
                                style={{ padding: '10px 20px', backgroundColor: '#3b82f6', color: 'white', border: 'none', borderRadius: '0', cursor: 'pointer', fontSize: '14px', fontWeight: '500' }}
                            >
                                {actionLoading ? 'Saving...' : 'üíæ Save Notes'}
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* Services Management Modal */}
            {showServicesModal && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: theme.modalOverlay, display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000, padding: '20px' }}>
                    <div style={{ backgroundColor: theme.bg, borderRadius: '0', width: '100%', maxWidth: '800px', maxHeight: '90vh', overflow: 'auto', boxShadow: '0 25px 50px -12px rgba(0,0,0,0.25)' }}>
                        <div style={{ padding: '20px 24px', borderBottom: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'space-between', alignItems: 'center', position: 'sticky', top: 0, backgroundColor: theme.bg, zIndex: 1 }}>
                            <h2 style={{ margin: 0, fontSize: '18px', fontWeight: '600', color: theme.text }}>‚öôÔ∏è Manage Garage Services</h2>
                            <div style={{ display: 'flex', gap: '12px', alignItems: 'center' }}>
                                <button
                                    onClick={handleAddService}
                                    style={{ padding: '8px 16px', backgroundColor: '#10b981', color: 'white', border: 'none', borderRadius: '0', cursor: 'pointer', fontSize: '13px', fontWeight: '500', display: 'flex', alignItems: 'center', gap: '6px' }}
                                >
                                    {Icons.plus} Add Service
                                </button>
                                <button onClick={() => setShowServicesModal(false)} style={{ background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer', color: theme.textSecondary }}>√ó</button>
                            </div>
                        </div>
                        <div style={{ padding: '24px' }}>
                            {garageServices.length === 0 ? (
                                <div style={{ textAlign: 'center', padding: '48px', color: theme.textSecondary }}>
                                    <span style={{ fontSize: '48px', display: 'block', marginBottom: '12px' }}>üîß</span>
                                    <p>No services yet. Click "Add Service" to create one.</p>
                                </div>
                            ) : (
                                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(350px, 1fr))', gap: '16px' }}>
                                    {garageServices.map(service => (
                                        <div key={service.id} style={{ 
                                            border: `1px solid ${theme.border}`, 
                                            padding: '16px',
                                            backgroundColor: theme.bgSecondary
                                        }}>
                                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '12px' }}>
                                                <div>
                                                    <div style={{ fontWeight: '600', color: theme.text, fontSize: '15px' }}>{service.name}</div>
                                                    <span style={{ 
                                                        display: 'inline-block',
                                                        fontSize: '11px', 
                                                        padding: '2px 8px', 
                                                        backgroundColor: (SERVICE_CATEGORIES.find(c => c.id === service.category)?.color || '#6b7280') + '20',
                                                        color: SERVICE_CATEGORIES.find(c => c.id === service.category)?.color || '#6b7280',
                                                        marginTop: '4px'
                                                    }}>
                                                        {SERVICE_CATEGORIES.find(c => c.id === service.category)?.name || 'Other'}
                                                    </span>
                                                </div>
                                                <div style={{ fontWeight: '700', color: '#10b981', fontSize: '16px' }}>
                                                    KSh {(service.price || 0).toLocaleString()}
                                                </div>
                                            </div>
                                            <div style={{ fontSize: '13px', color: theme.textSecondary, marginBottom: '12px' }}>
                                                <span>‚è±Ô∏è {service.duration || 30} mins</span>
                                                {service.description && (
                                                    <div style={{ marginTop: '6px' }}>{service.description}</div>
                                                )}
                                            </div>
                                            <div style={{ display: 'flex', gap: '8px', justifyContent: 'flex-end' }}>
                                                <button
                                                    onClick={() => handleEditService(service)}
                                                    style={{ padding: '6px 12px', backgroundColor: '#dbeafe', color: '#2563eb', border: 'none', borderRadius: '0', cursor: 'pointer', fontSize: '12px', fontWeight: '500' }}
                                                >
                                                    ‚úèÔ∏è Edit
                                                </button>
                                                <button
                                                    onClick={() => handleDeleteService(service.id)}
                                                    disabled={actionLoading}
                                                    style={{ padding: '6px 12px', backgroundColor: '#fee2e2', color: '#dc2626', border: 'none', borderRadius: '0', cursor: 'pointer', fontSize: '12px', fontWeight: '500' }}
                                                >
                                                    üóëÔ∏è Delete
                                                </button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                        <div style={{ padding: '16px 24px', borderTop: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <span style={{ fontSize: '13px', color: theme.textSecondary }}>{garageServices.length} service(s) available</span>
                            <button
                                onClick={() => setShowServicesModal(false)}
                                style={{ padding: '10px 20px', backgroundColor: theme.bgTertiary, color: theme.text, border: 'none', borderRadius: '0', cursor: 'pointer', fontSize: '14px' }}
                            >
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* Service Add/Edit Form Modal */}
            {showServiceFormModal && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: theme.modalOverlay, display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1001, padding: '20px' }}>
                    <div style={{ backgroundColor: theme.bg, borderRadius: '0', width: '100%', maxWidth: '500px', maxHeight: '90vh', overflow: 'auto', boxShadow: '0 25px 50px -12px rgba(0,0,0,0.25)' }}>
                        <div style={{ padding: '20px 24px', borderBottom: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <h2 style={{ margin: 0, fontSize: '18px', fontWeight: '600', color: theme.text }}>
                                {editingService ? '‚úèÔ∏è Edit Service' : '‚ûï Add New Service'}
                            </h2>
                            <button onClick={() => setShowServiceFormModal(false)} style={{ background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer', color: theme.textSecondary }}>√ó</button>
                        </div>
                        <div style={{ padding: '24px' }}>
                            <div style={{ marginBottom: '16px' }}>
                                <label style={{ display: 'block', fontSize: '13px', fontWeight: '500', color: theme.text, marginBottom: '6px' }}>Service Name *</label>
                                <input
                                    type="text"
                                    value={serviceFormData.name}
                                    onChange={(e) => setServiceFormData(prev => ({ ...prev, name: e.target.value }))}
                                    placeholder="e.g., Oil Change, Brake Inspection"
                                    style={{ width: '100%', padding: '10px 12px', border: `1px solid ${theme.border}`, borderRadius: '0', fontSize: '14px', backgroundColor: theme.inputBg, color: theme.text }}
                                />
                            </div>
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px', marginBottom: '16px' }}>
                                <div>
                                    <label style={{ display: 'block', fontSize: '13px', fontWeight: '500', color: theme.text, marginBottom: '6px' }}>Price (KSh) *</label>
                                    <input
                                        type="number"
                                        value={serviceFormData.price}
                                        onChange={(e) => setServiceFormData(prev => ({ ...prev, price: e.target.value }))}
                                        placeholder="0"
                                        min="0"
                                        style={{ width: '100%', padding: '10px 12px', border: `1px solid ${theme.border}`, borderRadius: '0', fontSize: '14px', backgroundColor: theme.inputBg, color: theme.text }}
                                    />
                                </div>
                                <div>
                                    <label style={{ display: 'block', fontSize: '13px', fontWeight: '500', color: theme.text, marginBottom: '6px' }}>Duration (mins)</label>
                                    <input
                                        type="number"
                                        value={serviceFormData.duration}
                                        onChange={(e) => setServiceFormData(prev => ({ ...prev, duration: e.target.value }))}
                                        placeholder="30"
                                        min="1"
                                        style={{ width: '100%', padding: '10px 12px', border: `1px solid ${theme.border}`, borderRadius: '0', fontSize: '14px', backgroundColor: theme.inputBg, color: theme.text }}
                                    />
                                </div>
                            </div>
                            <div style={{ marginBottom: '16px' }}>
                                <label style={{ display: 'block', fontSize: '13px', fontWeight: '500', color: theme.text, marginBottom: '6px' }}>Category</label>
                                <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                                    {SERVICE_CATEGORIES.map(cat => (
                                        <button
                                            key={cat.id}
                                            onClick={() => setServiceFormData(prev => ({ ...prev, category: cat.id }))}
                                            style={{
                                                padding: '8px 14px',
                                                border: serviceFormData.category === cat.id ? `2px solid ${cat.color}` : `1px solid ${theme.border}`,
                                                borderRadius: '0',
                                                backgroundColor: serviceFormData.category === cat.id ? `${cat.color}15` : theme.bg,
                                                color: serviceFormData.category === cat.id ? cat.color : theme.text,
                                                cursor: 'pointer',
                                                fontSize: '13px',
                                                fontWeight: '500'
                                            }}
                                        >
                                            {cat.name}
                                        </button>
                                    ))}
                                </div>
                            </div>
                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'block', fontSize: '13px', fontWeight: '500', color: theme.text, marginBottom: '6px' }}>Description</label>
                                <textarea
                                    value={serviceFormData.description}
                                    onChange={(e) => setServiceFormData(prev => ({ ...prev, description: e.target.value }))}
                                    placeholder="Brief description of what this service includes..."
                                    rows={3}
                                    style={{ width: '100%', padding: '10px 12px', border: `1px solid ${theme.border}`, borderRadius: '0', fontSize: '14px', backgroundColor: theme.inputBg, color: theme.text, resize: 'vertical' }}
                                />
                            </div>
                        </div>
                        <div style={{ padding: '16px 24px', borderTop: `1px solid ${theme.border}`, display: 'flex', gap: '12px', justifyContent: 'flex-end' }}>
                            <button
                                onClick={() => setShowServiceFormModal(false)}
                                style={{ padding: '10px 20px', backgroundColor: theme.bgTertiary, color: theme.text, border: 'none', borderRadius: '0', cursor: 'pointer', fontSize: '14px' }}
                            >
                                Cancel
                            </button>
                            <button
                                onClick={handleSaveService}
                                disabled={actionLoading || !serviceFormData.name.trim() || !serviceFormData.price}
                                style={{ 
                                    padding: '10px 20px', 
                                    backgroundColor: (!serviceFormData.name.trim() || !serviceFormData.price) ? '#94a3b8' : '#3b82f6', 
                                    color: 'white', 
                                    border: 'none', 
                                    borderRadius: '0', 
                                    cursor: (!serviceFormData.name.trim() || !serviceFormData.price) ? 'not-allowed' : 'pointer', 
                                    fontSize: '14px', 
                                    fontWeight: '500' 
                                }}
                            >
                                {actionLoading ? 'Saving...' : (editingService ? 'Update Service' : 'Add Service')}
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* Transfer to Garage Modal - Select Services */}
            {showTransferModal && transferVehicle && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: theme.modalOverlay, display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000, padding: '20px' }}>
                    <div style={{ backgroundColor: theme.bg, borderRadius: '0', width: '100%', maxWidth: '650px', maxHeight: '90vh', overflow: 'auto', boxShadow: '0 25px 50px -12px rgba(0,0,0,0.25)' }}>
                        <div style={{ padding: '20px 24px', borderBottom: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'space-between', alignItems: 'center', position: 'sticky', top: 0, backgroundColor: theme.bg, zIndex: 1 }}>
                            <h2 style={{ margin: 0, fontSize: '18px', fontWeight: '600', color: theme.text }}>üîß Send to Garage - Select Services</h2>
                            <button onClick={() => { setShowTransferModal(false); setTransferVehicle(null); }} style={{ background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer', color: theme.textSecondary }}>√ó</button>
                        </div>
                        <div style={{ padding: '24px' }}>
                            {/* Vehicle Info */}
                            <div style={{ backgroundColor: theme.bgTertiary, padding: '16px', marginBottom: '20px' }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                                    <div>
                                        <div style={{ fontWeight: '700', color: theme.text, fontSize: '18px' }}>{transferVehicle.plateNumber}</div>
                                        <div style={{ color: theme.textSecondary, fontSize: '14px', marginTop: '4px' }}>{transferVehicle.vehicleType}</div>
                                    </div>
                                    <div style={{ textAlign: 'right' }}>
                                        <div style={{ color: theme.text, fontSize: '14px' }}>{transferVehicle.customerName || 'Walk-in Customer'}</div>
                                        {transferVehicle.customerPhone && (
                                            <div style={{ color: theme.textSecondary, fontSize: '13px' }}>{transferVehicle.customerPhone}</div>
                                        )}
                                    </div>
                                </div>
                                <div style={{ marginTop: '12px', paddingTop: '12px', borderTop: `1px solid ${theme.border}` }}>
                                    <span style={{ 
                                        fontSize: '12px', 
                                        padding: '4px 10px', 
                                        backgroundColor: transferVehicle.isFromQueue ? '#fef3c7' : '#dbeafe',
                                        color: transferVehicle.isFromQueue ? '#d97706' : '#2563eb'
                                    }}>
                                        {transferVehicle.isFromQueue ? '‚è≥ From Queue' : `üîß From ${transferVehicle.assignedBay || 'Bay'}`}
                                    </span>
                                </div>
                            </div>

                            {/* Priority Selection */}
                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'block', fontSize: '13px', fontWeight: '600', color: theme.text, marginBottom: '8px' }}>Priority</label>
                                <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                                    {PRIORITY_OPTIONS.map(p => (
                                        <button
                                            key={p.id}
                                            onClick={() => setTransferPriority(p.id)}
                                            style={{
                                                padding: '8px 16px',
                                                borderRadius: '0',
                                                border: transferPriority === p.id ? `2px solid ${p.color}` : `1px solid ${theme.border}`,
                                                backgroundColor: transferPriority === p.id ? `${p.color}15` : theme.bg,
                                                color: transferPriority === p.id ? p.color : theme.text,
                                                cursor: 'pointer',
                                                fontSize: '13px',
                                                fontWeight: '500'
                                            }}
                                        >
                                            {p.name}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            {/* Services Selection */}
                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'block', fontSize: '13px', fontWeight: '600', color: theme.text, marginBottom: '8px' }}>
                                    Select Garage Services *
                                </label>
                                {garageServices.length === 0 ? (
                                    <div style={{ padding: '20px', backgroundColor: theme.bgTertiary, textAlign: 'center', color: theme.textSecondary }}>
                                        <p style={{ margin: '0 0 12px 0' }}>No services available.</p>
                                        <button
                                            onClick={() => { setShowTransferModal(false); setShowServicesModal(true); }}
                                            style={{ padding: '8px 16px', backgroundColor: '#8b5cf6', color: 'white', border: 'none', borderRadius: '0', cursor: 'pointer', fontSize: '13px' }}
                                        >
                                            ‚öôÔ∏è Add Services
                                        </button>
                                    </div>
                                ) : (
                                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(280px, 1fr))', gap: '10px', maxHeight: '300px', overflowY: 'auto', padding: '4px' }}>
                                        {garageServices.map(service => (
                                            <div
                                                key={service.id}
                                                onClick={() => toggleTransferService(service.id)}
                                                style={{
                                                    padding: '14px',
                                                    border: transferServices.includes(service.id) ? '2px solid #3b82f6' : `1px solid ${theme.border}`,
                                                    backgroundColor: transferServices.includes(service.id) ? '#dbeafe' : theme.bg,
                                                    cursor: 'pointer',
                                                    transition: 'all 0.15s'
                                                }}
                                            >
                                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                                                    <div style={{ flex: 1 }}>
                                                        <div style={{ fontWeight: '500', color: theme.text, fontSize: '14px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                                                            {transferServices.includes(service.id) && <span style={{ color: '#3b82f6' }}>‚úì</span>}
                                                            {service.name}
                                                        </div>
                                                        <div style={{ fontSize: '12px', color: theme.textSecondary, marginTop: '4px' }}>
                                                            ‚è±Ô∏è {service.duration || 30} mins
                                                        </div>
                                                    </div>
                                                    <div style={{ fontWeight: '700', color: '#10b981', fontSize: '15px' }}>
                                                        KSh {(service.price || 0).toLocaleString()}
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                                
                                {/* Selected Summary */}
                                {transferServices.length > 0 && (
                                    <div style={{ marginTop: '12px', padding: '12px', backgroundColor: '#f0fdf4', border: '1px solid #bbf7d0', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                        <span style={{ color: '#166534', fontSize: '14px' }}>
                                            {transferServices.length} service(s) selected
                                        </span>
                                        <span style={{ fontWeight: '700', color: '#166534', fontSize: '16px' }}>
                                            Total: KSh {transferServices.reduce((sum, sId) => {
                                                const service = garageServices.find(s => s.id === sId);
                                                return sum + (service?.price || 0);
                                            }, 0).toLocaleString()}
                                        </span>
                                    </div>
                                )}
                            </div>

                            {/* Notes */}
                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'block', fontSize: '13px', fontWeight: '600', color: theme.text, marginBottom: '8px' }}>Notes (Optional)</label>
                                <textarea
                                    value={transferNotes}
                                    onChange={(e) => setTransferNotes(e.target.value)}
                                    placeholder="Any special instructions or notes for the garage..."
                                    rows={3}
                                    style={{ width: '100%', padding: '10px 12px', border: `1px solid ${theme.border}`, borderRadius: '0', fontSize: '14px', backgroundColor: theme.inputBg, color: theme.text, resize: 'vertical' }}
                                />
                            </div>
                        </div>
                        <div style={{ padding: '16px 24px', borderTop: `1px solid ${theme.border}`, display: 'flex', gap: '12px', justifyContent: 'space-between', alignItems: 'center' }}>
                            <span style={{ fontSize: '13px', color: theme.textSecondary }}>
                                {transferServices.length === 0 ? '‚ö†Ô∏è Please select at least one service' : ''}
                            </span>
                            <div style={{ display: 'flex', gap: '12px' }}>
                                <button
                                    onClick={() => { setShowTransferModal(false); setTransferVehicle(null); }}
                                    style={{ padding: '10px 20px', backgroundColor: theme.bgTertiary, color: theme.text, border: 'none', borderRadius: '0', cursor: 'pointer', fontSize: '14px' }}
                                >
                                    Cancel
                                </button>
                                <button
                                    onClick={handleConfirmTransfer}
                                    disabled={actionLoading || transferServices.length === 0}
                                    style={{ 
                                        padding: '10px 24px', 
                                        backgroundColor: transferServices.length === 0 ? '#94a3b8' : '#10b981', 
                                        color: 'white', 
                                        border: 'none', 
                                        borderRadius: '0', 
                                        cursor: transferServices.length === 0 ? 'not-allowed' : 'pointer', 
                                        fontSize: '14px', 
                                        fontWeight: '600',
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '8px'
                                    }}
                                >
                                    {actionLoading ? 'Sending...' : 'üîß Send to Garage Queue'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* Assign Technician Modal */}
            {showAssignTechModal && selectedQueueItem && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: theme.modalOverlay, display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000, padding: '20px' }}>
                    <div style={{ backgroundColor: theme.bg, borderRadius: '0', width: '100%', maxWidth: '450px', maxHeight: '90vh', overflow: 'auto', boxShadow: '0 25px 50px -12px rgba(0,0,0,0.25)' }}>
                        <div style={{ padding: '20px 24px', borderBottom: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <h2 style={{ margin: 0, fontSize: '18px', fontWeight: '600', color: theme.text }}>üë∑ Assign Technician</h2>
                            <button onClick={() => { setShowAssignTechModal(false); setSelectedQueueItem(null); }} style={{ background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer', color: theme.textSecondary }}>√ó</button>
                        </div>
                        <div style={{ padding: '24px' }}>
                            {/* Vehicle Info */}
                            <div style={{ backgroundColor: theme.bgTertiary, padding: '16px', marginBottom: '20px' }}>
                                <div style={{ fontWeight: '600', color: theme.text, fontSize: '16px' }}>{selectedQueueItem.plateNumber}</div>
                                <div style={{ color: theme.textSecondary, fontSize: '13px' }}>{selectedQueueItem.vehicleType} ‚Ä¢ {selectedQueueItem.customerName || 'Walk-in'}</div>
                            </div>

                            {/* Services */}
                            <div style={{ marginBottom: '20px' }}>
                                <div style={{ fontSize: '13px', fontWeight: '600', color: theme.text, marginBottom: '8px' }}>Services Requested</div>
                                <div style={{ display: 'flex', gap: '6px', flexWrap: 'wrap' }}>
                                    {selectedQueueItem.services?.map((sId, idx) => {
                                        const service = garageServices.find(s => s.id === sId);
                                        return service ? (
                                            <span key={idx} style={{ fontSize: '12px', padding: '4px 10px', backgroundColor: '#fef3c7', color: '#92400e' }}>
                                                {service.name}
                                            </span>
                                        ) : null;
                                    })}
                                </div>
                            </div>

                            {/* Technician Selection */}
                            <div>
                                <label style={{ display: 'block', fontSize: '13px', fontWeight: '600', color: theme.text, marginBottom: '8px' }}>
                                    Select Technician *
                                </label>
                                <select
                                    value={selectedTechnician}
                                    onChange={(e) => setSelectedTechnician(e.target.value)}
                                    style={{ 
                                        width: '100%', 
                                        padding: '12px', 
                                        border: `1px solid ${theme.border}`, 
                                        borderRadius: '0', 
                                        fontSize: '14px', 
                                        backgroundColor: theme.inputBg, 
                                        color: theme.text,
                                        cursor: 'pointer'
                                    }}
                                >
                                    <option value="">-- Select Technician --</option>
                                    {staffList.map(staff => (
                                        <option key={staff.id} value={staff.name}>{staff.name} ({staff.role})</option>
                                    ))}
                                </select>
                                <div style={{ marginTop: '8px', fontSize: '12px', color: theme.textSecondary }}>
                                    üí° The assigned technician will be tracked in HR for commission/payment calculations
                                </div>
                            </div>
                        </div>
                        <div style={{ padding: '16px 24px', borderTop: `1px solid ${theme.border}`, display: 'flex', gap: '12px', justifyContent: 'flex-end' }}>
                            <button
                                onClick={() => { setShowAssignTechModal(false); setSelectedQueueItem(null); }}
                                style={{ padding: '10px 20px', backgroundColor: theme.bgTertiary, color: theme.text, border: 'none', borderRadius: '0', cursor: 'pointer', fontSize: '14px' }}
                            >
                                Cancel
                            </button>
                            <button
                                onClick={executeStartJob}
                                disabled={actionLoading || !selectedTechnician}
                                style={{ 
                                    padding: '10px 20px', 
                                    backgroundColor: selectedTechnician ? '#10b981' : '#94a3b8', 
                                    color: 'white', 
                                    border: 'none', 
                                    borderRadius: '0', 
                                    cursor: selectedTechnician ? 'pointer' : 'not-allowed', 
                                    fontSize: '14px', 
                                    fontWeight: '500' 
                                }}
                            >
                                {actionLoading ? 'Starting...' : 'üöÄ Start Job'}
                            </button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}

// ==================== WASH BAYS MODULE ====================

// Error Boundary for WashBays
class WashBaysErrorBoundary extends React.Component {
    constructor(props) {
        super(props);
        this.state = { hasError: false, error: null };
    }
    
    static getDerivedStateFromError(error) {
        return { hasError: true, error: error.message };
    }
    
    componentDidCatch(error, errorInfo) {
        console.error('WashBays Error:', error, errorInfo);
    }
    
    render() {
        if (this.state.hasError) {
            return (
                <div style={{ padding: '40px', textAlign: 'center' }}>
                    <div style={{ fontSize: '48px', marginBottom: '16px' }}>‚ö†Ô∏è</div>
                    <h3 style={{ color: '#dc2626', marginBottom: '8px' }}>Something went wrong in Wash Bays</h3>
                    <p style={{ color: '#64748b', marginBottom: '16px' }}>{this.state.error}</p>
                    <button 
                        onClick={() => window.location.reload()}
                        style={{ padding: '10px 20px', backgroundColor: '#3b82f6', color: 'white', border: 'none', borderRadius: '4px', cursor: 'pointer' }}
                    >
                        Reload Page
                    </button>
                </div>
            );
        }
        return this.props.children;
    }
}

function WashBaysContent() {
    const [bays, setBays] = useState([]);
    const [history, setHistory] = useState([]);
    const [intakeQueue, setIntakeQueue] = useState([]);
    const [staffList, setStaffList] = useState([]);
    const [servicePackages, setServicePackages] = useState([]);
    const [loading, setLoading] = useState(true);
    const [showAddModal, setShowAddModal] = useState(false);
    const [showAssignModal, setShowAssignModal] = useState(false);
    const [showMaintenanceModal, setShowMaintenanceModal] = useState(false);
    const [showConfirmModal, setShowConfirmModal] = useState(false);
    const [confirmAction, setConfirmAction] = useState(null);
    const [maintenanceNote, setMaintenanceNote] = useState('');
    const [selectedBay, setSelectedBay] = useState(null);
    const [actionLoading, setActionLoading] = useState(false);
    const [error, setError] = useState(null);
    const [successMessage, setSuccessMessage] = useState(null);
    const [activeTab, setActiveTab] = useState('bays');
    const [todayStats, setTodayStats] = useState({ completed: 0, avgTime: 0 });
    const [isDark, setIsDark] = useState(document.documentElement.getAttribute('data-theme') === 'dark');
    const [assignMode, setAssignMode] = useState('select'); // 'select' or 'new'
    const [selectedVehicleId, setSelectedVehicleId] = useState('');
    const [renderError, setRenderError] = useState(null);
    const [componentMounted, setComponentMounted] = useState(false);
    
    // Debug logging on mount
    useEffect(() => {
        console.log('WashBaysContent: Component mounting...');
        setComponentMounted(true);
        return () => console.log('WashBaysContent: Component unmounted');
    }, []);

    // Form states
    const [bayForm, setBayForm] = useState({ name: '', type: 'standard' });
    const [assignForm, setAssignForm] = useState({ 
        plateNumber: '', 
        customerName: '', 
        vehicleType: 'sedan', 
        service: '',
        assignedTo: ''
    });

    // Auto-hide success message
    useEffect(() => {
        if (successMessage) {
            const timer = setTimeout(() => setSuccessMessage(null), 3000);
            return () => clearTimeout(timer);
        }
    }, [successMessage]);

    // Theme detection
    useEffect(() => {
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.attributeName === 'data-theme') {
                    setIsDark(document.documentElement.getAttribute('data-theme') === 'dark');
                }
            });
        });
        observer.observe(document.documentElement, { attributes: true });
        return () => observer.disconnect();
    }, []);

    const theme = {
        bg: isDark ? '#1e293b' : 'white',
        bgSecondary: isDark ? '#0f172a' : '#f8fafc',
        text: isDark ? '#f1f5f9' : '#1e293b',
        textSecondary: isDark ? '#94a3b8' : '#64748b',
        border: isDark ? '#334155' : '#e2e8f0',
        cardShadow: isDark ? '0 2px 8px rgba(0,0,0,0.3)' : '0 2px 8px rgba(0,0,0,0.08)',
        inputBg: isDark ? '#1e293b' : 'white',
    };

    const BAY_TYPES = [
        { id: 'standard', name: 'Standard', color: '#3b82f6' },
        { id: 'premium', name: 'Premium', color: '#8b5cf6' },
        { id: 'express', name: 'Express', color: '#10b981' }
    ];

    const VEHICLE_TYPES = ['Sedan', 'SUV', 'Truck', 'Van', 'Motorcycle', 'Bus'];

    const STATUS_CONFIG = {
        available: { label: 'Available', color: '#10b981', bg: '#d1fae5' },
        occupied: { label: 'In Progress', color: '#3b82f6', bg: '#dbeafe' },
        maintenance: { label: 'Maintenance', color: '#f59e0b', bg: '#fef3c7' }
    };

    // Subscribe to real-time data
    useEffect(() => {
        const services = window.FirebaseServices;
        if (!services?.washBayService) {
            console.error('WashBayService not available');
            setLoading(false);
            setError('Wash bay service not available. Please refresh the page.');
            return;
        }

        let unsubBays, unsubHistory, unsubQueue, unsubStaff, unsubPackages;

        const initializeData = async () => {
            try {
                // Initialize bays if needed
                await services.washBayService.initializeBays();

                // Subscribe to bays
                unsubBays = services.washBayService.subscribeToBays((data) => {
                    try {
                        const baysData = Array.isArray(data)
                            ? data
                            : data && typeof data === 'object'
                                ? Object.values(data)
                                : [];
                        console.log('WashBays: Received bays data', baysData.length);
                        setBays(baysData);
                        setLoading(false);
                    } catch (cbErr) {
                        console.error('WashBays: Error handling bays data', cbErr);
                        setError('Failed to load wash bays data.');
                        setLoading(false);
                    }
                });

                // Subscribe to history
                unsubHistory = services.washBayService.subscribeToHistory((data) => {
                    setHistory(data);
                });

                // Subscribe to intake queue (vehicles waiting)
                if (services.intakeQueueService) {
                    unsubQueue = services.intakeQueueService.subscribeToQueue((data) => {
                        // Filter only waiting vehicles
                        setIntakeQueue(data.filter(v => v.status === 'waiting'));
                    });
                }

                // Subscribe to staff list
                if (services.staffService) {
                    unsubStaff = services.staffService.subscribeToStaff((data) => {
                        setStaffList(data);
                    });
                }

                // Subscribe to service packages
                if (services.packagesService) {
                    unsubPackages = services.packagesService.subscribeToPackages((data) => {
                        const activePackages = data.filter(p => p.isActive !== false);
                        setServicePackages(activePackages);
                    });
                }

                // Get today's stats
                const result = await services.washBayService.getTodayStats();
                if (result.success) setTodayStats(result.data);
            } catch (err) {
                console.error('WashBays initialization error:', err);
                setError('Failed to load wash bays. Please refresh.');
                setLoading(false);
            } finally {
                // In case none of the subscriptions fired yet
                setLoading((prev) => {
                    if (prev) {
                        console.warn('WashBays: Forcing loading false after init');
                        return false;
                    }
                    return prev;
                });
            }
        };

        initializeData();

        return () => {
            if (unsubBays) unsubBays();
            if (unsubHistory) unsubHistory();
            if (unsubQueue) unsubQueue();
            if (unsubStaff) unsubStaff();
            if (unsubPackages) unsubPackages();
        };
    }, []);

    // Timeout to prevent infinite loading
    useEffect(() => {
        if (loading) {
            const timeout = setTimeout(() => {
                if (loading) {
                    console.warn('WashBays: Loading timeout - forcing render');
                    setLoading(false);
                }
            }, 5000); // 5 second timeout
            return () => clearTimeout(timeout);
        }
    }, [loading]);

    // Calculate elapsed time for occupied bays
    const getElapsedTime = (startTime) => {
        if (!startTime) return '0:00';
        const elapsed = Math.floor((Date.now() - new Date(startTime).getTime()) / 1000);
        const mins = Math.floor(elapsed / 60);
        const secs = elapsed % 60;
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    };

    // Auto-update elapsed times
    const [, forceUpdate] = useState(0);
    useEffect(() => {
        const interval = setInterval(() => forceUpdate(n => n + 1), 1000);
        return () => clearInterval(interval);
    }, []);

    const handleAddBay = async (e) => {
        e.preventDefault();
        if (!bayForm.name.trim()) {
            setError('Bay name is required');
            return;
        }

        setActionLoading(true);
        setError(null);

        try {
            const services = window.FirebaseServices;
            const result = await services.washBayService.addBay(bayForm);
            if (result.success) {
                setShowAddModal(false);
                setBayForm({ name: '', type: 'standard' });
            } else {
                setError(result.error);
            }
        } catch (err) {
            setError('Failed to add bay');
        } finally {
            setActionLoading(false);
        }
    };

    const handleAssignVehicle = async (e) => {
        e.preventDefault();
        
        // Validate staff selection
        if (!assignForm.assignedTo) {
            setError('Please select a staff member');
            return;
        }
        
        // Validate service selection
        if (!assignForm.service) {
            setError('Please select a service');
            return;
        }
        
        // Get selected service package info
        const selectedPackage = servicePackages.find(p => p.id === assignForm.service);
        const serviceInfo = selectedPackage 
            ? { id: selectedPackage.id, name: selectedPackage.name, price: selectedPackage.price }
            : { name: assignForm.service, price: 0 };
        
        setActionLoading(true);
        setError(null);

        try {
            const services = window.FirebaseServices;
            let vehicleData;
            let queueVehicle = null;

            if (assignMode === 'select' && selectedVehicleId) {
                // Use selected vehicle from queue
                queueVehicle = intakeQueue.find(v => v.id === selectedVehicleId);
                if (!queueVehicle) {
                    setError('Selected vehicle not found');
                    setActionLoading(false);
                    return;
                }
                vehicleData = {
                    plateNumber: queueVehicle.plateNumber,
                    customerName: queueVehicle.customerName || queueVehicle.ownerName || '',
                    vehicleType: queueVehicle.vehicleType || 'sedan',
                    service: serviceInfo,
                    assignedBy: assignForm.assignedTo,
                    queueId: queueVehicle.id
                };
            } else {
                // Create new vehicle entry
                if (!assignForm.plateNumber.trim()) {
                    setError('Plate number is required');
                    setActionLoading(false);
                    return;
                }
                vehicleData = {
                    plateNumber: assignForm.plateNumber.toUpperCase(),
                    customerName: assignForm.customerName,
                    vehicleType: assignForm.vehicleType,
                    service: serviceInfo,
                    assignedBy: assignForm.assignedTo
                };
            }

            // 1. Create record in Vehicle Intake Records (Firestore) for tracking
            let recordId = null;
            if (services.intakeRecordsService) {
                const recordData = {
                    plateNumber: vehicleData.plateNumber,
                    customerName: vehicleData.customerName,
                    vehicleType: vehicleData.vehicleType,
                    service: vehicleData.service,
                    status: 'in-progress',
                    assignedBay: selectedBay.name,
                    assignedBayId: selectedBay.id,
                    assignedTime: new Date().toISOString(),
                    timeIn: new Date().toISOString(),
                    source: assignMode === 'select' ? 'queue' : 'wash-bay-direct',
                    queueId: vehicleData.queueId || null
                };
                const recordResult = await services.intakeRecordsService.addRecord(recordData);
                if (recordResult.success) {
                    recordId = recordResult.id;
                    vehicleData.recordId = recordId;
                }
            }

            // 2. If from queue, update queue status to in-progress (or remove it)
            if (assignMode === 'select' && queueVehicle && services.intakeQueueService) {
                // Remove from queue since it's now in records
                await services.intakeQueueService.removeFromQueue(queueVehicle.id);
            } else if (assignMode === 'new' && services.intakeQueueService) {
                // For new vehicles, add to queue with in-progress status for tracking
                const queueResult = await services.intakeQueueService.addToQueue({
                    plateNumber: vehicleData.plateNumber,
                    customerName: vehicleData.customerName,
                    vehicleType: vehicleData.vehicleType,
                    service: vehicleData.service,
                    status: 'in-progress',
                    assignedBay: selectedBay.name,
                    assignedBayId: selectedBay.id,
                    washStartTime: new Date().toISOString(),
                    recordId: recordId,
                    source: 'wash-bay-direct'
                });
                if (queueResult.success) {
                    vehicleData.queueId = queueResult.id;
                }
            }

            // 3. Assign to wash bay (Realtime DB)
            const result = await services.washBayService.assignVehicle(selectedBay.id, vehicleData);
            if (result.success) {
                setShowAssignModal(false);
                setSelectedBay(null);
                setSelectedVehicleId('');
                setAssignMode('select');
                setAssignForm({ plateNumber: '', customerName: '', vehicleType: 'sedan', service: '', assignedTo: '' });
            } else {
                setError(result.error);
            }
        } catch (err) {
            console.error('Error assigning vehicle:', err);
            setError('Failed to assign vehicle');
        } finally {
            setActionLoading(false);
        }
    };

    const openAssignModal = (bay) => {
        setSelectedBay(bay);
        setShowAssignModal(true);
        setError(null);
        setAssignMode(intakeQueue.length > 0 ? 'select' : 'new');
        setSelectedVehicleId('');
        setAssignForm({ plateNumber: '', customerName: '', vehicleType: 'sedan', service: 'Basic Wash', assignedTo: '' });
    };

    const handleCompleteWash = async (bay) => {
        setSelectedBay(bay);
        setConfirmAction({
            type: 'complete',
            title: 'Complete Wash',
            message: `Complete wash for ${bay.currentVehicle?.plateNumber}?`,
            confirmText: '‚úì Complete',
            confirmColor: '#10b981'
        });
        setShowConfirmModal(true);
    };

    const executeCompleteWash = async () => {
        const bay = selectedBay;
        setShowConfirmModal(false);
        setActionLoading(true);
        try {
            const services = window.FirebaseServices;
            const currentVehicle = bay.currentVehicle;
            
            // 1. Update the intake record in Firestore (main tracking)
            if (currentVehicle?.recordId && services.intakeRecordsService) {
                await services.intakeRecordsService.updateRecord(currentVehicle.recordId, {
                    status: 'completed',
                    timeOut: new Date().toISOString()
                });
            }
            
            // 2. If vehicle has queue entry, remove or update it
            if (currentVehicle?.queueId && services.intakeQueueService) {
                await services.intakeQueueService.removeFromQueue(currentVehicle.queueId);
            }
            
            // 3. Complete the wash bay
            await services.washBayService.completeWash(bay.id);

            // 4. Create invoice for the completed wash
            const washPrice = currentVehicle?.servicePrice || 500; // Default price if not set
            const serviceName = typeof currentVehicle?.service === 'object' 
                ? currentVehicle?.service?.name 
                : currentVehicle?.service || 'Car Wash';
            if (services.billingService) {
                await services.billingService.createInvoice({
                    source: 'wash',
                    bayId: bay.id,
                    bayName: bay.name,
                    plateNumber: currentVehicle?.plateNumber || 'Unknown',
                    vehicleType: currentVehicle?.vehicleType || 'Vehicle',
                    customerName: currentVehicle?.customerName || 'Walk-in',
                    customerPhone: currentVehicle?.customerPhone || '',
                    services: [{ name: serviceName, price: washPrice }],
                    totalAmount: washPrice,
                    assignedTo: currentVehicle?.assignedTo || '',
                    startTime: currentVehicle?.startTime || bay.startTime
                });
                console.log('Invoice created for wash:', currentVehicle?.plateNumber);
            }
            
            // Refresh stats
            const result = await services.washBayService.getTodayStats();
            if (result.success) setTodayStats(result.data);
            
            // Log activity
            if (services.activityService) {
                const currentUser = window.currentUserProfile;
                services.activityService.logActivity({
                    type: 'wash',
                    action: 'Wash Completed',
                    details: `${currentVehicle?.plateNumber} - ${bay.name} - KSH ${washPrice}`,
                    status: 'success',
                    loggedBy: currentUser?.displayName || currentUser?.email?.split('@')[0] || 'System',
                    loggedByEmail: currentUser?.email || null,
                    loggedByRole: currentUser?.role || null
                });
            }
            
            setSuccessMessage(`${currentVehicle?.plateNumber} wash completed!`);
        } catch (err) {
            console.error('Complete wash error:', err);
            setError('Failed to complete wash');
        } finally {
            setActionLoading(false);
            setSelectedBay(null);
        }
    };

    const handleSetMaintenance = (bay) => {
        setSelectedBay(bay);
        setMaintenanceNote('');
        setShowMaintenanceModal(true);
    };

    const executeSetMaintenance = async () => {
        setShowMaintenanceModal(false);
        setActionLoading(true);
        try {
            const services = window.FirebaseServices;
            await services.washBayService.setMaintenance(selectedBay.id, { note: maintenanceNote });
            setSuccessMessage(`${selectedBay.name} set to maintenance`);
        } catch (err) {
            setError('Failed to set maintenance');
        } finally {
            setActionLoading(false);
            setSelectedBay(null);
            setMaintenanceNote('');
        }
    };

    const handleClearMaintenance = (bay) => {
        setSelectedBay(bay);
        setConfirmAction({
            type: 'clearMaintenance',
            title: 'Clear Maintenance',
            message: `Mark ${bay.name} as available again?`,
            confirmText: '‚úì Clear Maintenance',
            confirmColor: '#10b981'
        });
        setShowConfirmModal(true);
    };

    const executeClearMaintenance = async () => {
        setShowConfirmModal(false);
        setActionLoading(true);
        try {
            const services = window.FirebaseServices;
            await services.washBayService.updateBayStatus(selectedBay.id, 'available');
            setSuccessMessage(`${selectedBay.name} is now available`);
        } catch (err) {
            setError('Failed to clear maintenance');
        } finally {
            setActionLoading(false);
            setSelectedBay(null);
        }
    };

    const handleDeleteBay = (bay) => {
        setSelectedBay(bay);
        setConfirmAction({
            type: 'delete',
            title: 'Delete Bay',
            message: `Delete ${bay.name}? This cannot be undone.`,
            confirmText: 'üóëÔ∏è Delete',
            confirmColor: '#ef4444'
        });
        setShowConfirmModal(true);
    };

    const executeDeleteBay = async () => {
        setShowConfirmModal(false);
        setActionLoading(true);
        try {
            const services = window.FirebaseServices;
            await services.washBayService.deleteBay(selectedBay.id);
            setSuccessMessage(`${selectedBay.name} deleted`);
        } catch (err) {
            setError('Failed to delete bay');
        } finally {
            setActionLoading(false);
            setSelectedBay(null);
        }
    };

    // Handle confirm action
    const handleConfirmAction = async () => {
        if (!confirmAction) return;
        
        switch (confirmAction.type) {
            case 'complete':
                await executeCompleteWash();
                break;
            case 'clearMaintenance':
                await executeClearMaintenance();
                break;
            case 'delete':
                await executeDeleteBay();
                break;
            default:
                setShowConfirmModal(false);
        }
        setConfirmAction(null);
    };

    // Safe access helpers
    const safeBays = Array.isArray(bays) ? bays.filter(b => b && typeof b === 'object') : [];
    const safeQueue = Array.isArray(intakeQueue) ? intakeQueue : [];
    const safeStats = todayStats || { completed: 0, avgTime: 0 };

    // Stats cards
    const statsCards = [
        { 
            label: 'In Queue', 
            value: safeQueue.length, 
            icon: '‚è≥',
            color: '#6366f1'
        },
        { 
            label: 'Available Bays', 
            value: safeBays.filter(b => b.status === 'available').length, 
            icon: '‚úÖ',
            color: '#10b981'
        },
        { 
            label: 'In Progress', 
            value: safeBays.filter(b => b.status === 'occupied').length, 
            icon: 'üöó',
            color: '#f59e0b'
        },
        { 
            label: 'Completed Today', 
            value: safeStats.completed || 0, 
            icon: 'üèÅ',
            color: '#8b5cf6'
        }
    ];

    // Debug: Log render state
    console.log('WashBays render - loading:', loading, 'bays:', safeBays.length, 'error:', error);

    // Show render error if caught
    if (renderError) {
        return (
            <div style={{ padding: '24px', textAlign: 'center' }}>
                <div style={{ fontSize: '48px', marginBottom: '16px' }}>‚ö†Ô∏è</div>
                <h3 style={{ color: '#dc2626', marginBottom: '8px' }}>Render Error</h3>
                <p style={{ color: '#64748b', marginBottom: '16px' }}>{renderError}</p>
                <button 
                    onClick={() => { setRenderError(null); window.location.reload(); }}
                    style={{ padding: '10px 20px', backgroundColor: '#3b82f6', color: 'white', border: 'none', borderRadius: '4px', cursor: 'pointer' }}
                >
                    Reload Page
                </button>
            </div>
        );
    }

    if (loading) {
        return (
            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', height: '400px', backgroundColor: '#f8fafc' }}>
                <style>{`@keyframes spin { to { transform: rotate(360deg); } }`}</style>
                <div style={{ textAlign: 'center' }}>
                    <div style={{ width: '40px', height: '40px', border: '3px solid #e2e8f0', borderTopColor: '#3b82f6', borderRadius: '50%', animation: 'spin 0.8s linear infinite', margin: '0 auto 16px' }}></div>
                    <p style={{ color: '#64748b' }}>Loading wash bays...</p>
                    <p style={{ color: '#94a3b8', fontSize: '12px', marginTop: '8px' }}>Please wait while we fetch data...</p>
                </div>
            </div>
        );
    }

    return (
        <div style={{ padding: '24px' }}>
            {/* Error Banner */}
            {error && (
                <div style={{ 
                    padding: '12px 16px', 
                    backgroundColor: '#fee2e2', 
                    color: '#dc2626', 
                    borderRadius: '2px', 
                    marginBottom: '20px',
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center'
                }}>
                    <span>{error}</span>
                    <button onClick={() => setError(null)} style={{ background: 'none', border: 'none', cursor: 'pointer', fontSize: '18px' }}>√ó</button>
                </div>
            )}

            {/* Stats Cards */}
            <div style={{ 
                display: 'grid', 
                gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', 
                gap: '16px', 
                marginBottom: '24px' 
            }}>
                {statsCards.map((stat, i) => (
                    <div key={i} style={{
                        backgroundColor: theme.bg,
                        borderRadius: '2px',
                        padding: '20px',
                        boxShadow: theme.cardShadow,
                        border: `1px solid ${theme.border}`
                    }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                            <div style={{ 
                                width: '48px', 
                                height: '48px', 
                                borderRadius: '2px', 
                                backgroundColor: `${stat.color}15`,
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                fontSize: '24px'
                            }}>
                                {stat.icon}
                            </div>
                            <div>
                                <div style={{ fontSize: '28px', fontWeight: '700', color: theme.text }}>{stat.value}</div>
                                <div style={{ fontSize: '13px', color: theme.textSecondary }}>{stat.label}</div>
                            </div>
                        </div>
                    </div>
                ))}
            </div>

            {/* Tabs & Add Button */}
            <div style={{ 
                display: 'flex', 
                justifyContent: 'space-between', 
                alignItems: 'center', 
                marginBottom: '20px' 
            }}>
                <div style={{ display: 'flex', gap: '8px' }}>
                    {['bays', 'history'].map(tab => (
                        <button
                            key={tab}
                            onClick={() => setActiveTab(tab)}
                            style={{
                                padding: '10px 20px',
                                borderRadius: '2px',
                                border: 'none',
                                backgroundColor: activeTab === tab ? '#3b82f6' : theme.bgSecondary,
                                color: activeTab === tab ? 'white' : theme.text,
                                fontWeight: '600',
                                cursor: 'pointer',
                                textTransform: 'capitalize'
                            }}
                        >
                            {tab === 'bays' ? 'üöø Wash Bays' : 'üìã History'}
                        </button>
                    ))}
                </div>
                {activeTab === 'bays' && (
                    <button
                        onClick={() => setShowAddModal(true)}
                        style={{
                            padding: '10px 20px',
                            borderRadius: '2px',
                            border: 'none',
                            backgroundColor: '#10b981',
                            color: 'white',
                            fontWeight: '600',
                            cursor: 'pointer',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '8px'
                        }}
                    >
                        <span style={{ fontSize: '18px' }}>+</span> Add Bay
                    </button>
                )}
            </div>

            {/* Bays Grid */}
            {activeTab === 'bays' && (
                <div style={{ 
                    display: 'grid', 
                    gridTemplateColumns: 'repeat(auto-fill, minmax(320px, 1fr))', 
                    gap: '20px' 
                }}>
                    {safeBays.length === 0 ? (
                        <div style={{ 
                            gridColumn: '1/-1', 
                            textAlign: 'center', 
                            padding: '60px 20px',
                            backgroundColor: theme.bg,
                            borderRadius: '2px',
                            border: `1px solid ${theme.border}`
                        }}>
                            <div style={{ fontSize: '48px', marginBottom: '16px' }}>üöø</div>
                            <h3 style={{ color: theme.text, marginBottom: '8px' }}>No Wash Bays</h3>
                            <p style={{ color: theme.textSecondary }}>Click "Add Bay" to create your first wash bay</p>
                        </div>
                    ) : (
                        safeBays.map(bay => {
                            if (!bay) return null;
                            const statusConfig = STATUS_CONFIG[bay.status] || STATUS_CONFIG.available;
                            const bayType = BAY_TYPES.find(t => t.id === bay.type) || BAY_TYPES[0];

                            return (
                                <div key={bay.id} style={{
                                    backgroundColor: theme.bg,
                                    borderRadius: '2px',
                                    overflow: 'hidden',
                                    boxShadow: theme.cardShadow,
                                    border: `1px solid ${theme.border}`,
                                    transition: 'transform 0.2s, box-shadow 0.2s'
                                }}>
                                    {/* Bay Header */}
                                    <div style={{
                                        padding: '16px 20px',
                                        backgroundColor: `${bayType.color}10`,
                                        borderBottom: `1px solid ${theme.border}`,
                                        display: 'flex',
                                        justifyContent: 'space-between',
                                        alignItems: 'center'
                                    }}>
                                        <div>
                                            <h3 style={{ 
                                                margin: 0, 
                                                fontSize: '18px', 
                                                fontWeight: '700',
                                                color: theme.text 
                                            }}>
                                                {bay.name}
                                            </h3>
                                            <span style={{
                                                display: 'inline-block',
                                                marginTop: '4px',
                                                padding: '2px 8px',
                                                borderRadius: '2px',
                                                fontSize: '11px',
                                                fontWeight: '600',
                                                backgroundColor: bayType.color,
                                                color: 'white'
                                            }}>
                                                {bayType.name}
                                            </span>
                                        </div>
                                        <div style={{
                                            padding: '6px 12px',
                                            borderRadius: '2px',
                                            backgroundColor: statusConfig.bg,
                                            color: statusConfig.color,
                                            fontSize: '12px',
                                            fontWeight: '600'
                                        }}>
                                            {statusConfig.label}
                                        </div>
                                    </div>

                                    {/* Bay Content */}
                                    <div style={{ padding: '20px' }}>
                                        {bay.status === 'occupied' && bay.currentVehicle ? (
                                            <div>
                                                <div style={{ 
                                                    display: 'flex', 
                                                    alignItems: 'center', 
                                                    gap: '12px',
                                                    marginBottom: '16px'
                                                }}>
                                                    <div style={{
                                                        width: '50px',
                                                        height: '50px',
                                                        borderRadius: '2px',
                                                        backgroundColor: '#3b82f6',
                                                        display: 'flex',
                                                        alignItems: 'center',
                                                        justifyContent: 'center',
                                                        color: 'white',
                                                        fontSize: '24px'
                                                    }}>
                                                        üöó
                                                    </div>
                                                    <div>
                                                        <div style={{ 
                                                            fontWeight: '700', 
                                                            fontSize: '16px',
                                                            color: theme.text 
                                                        }}>
                                                            {bay.currentVehicle.plateNumber}
                                                        </div>
                                                        <div style={{ 
                                                            fontSize: '13px', 
                                                            color: theme.textSecondary 
                                                        }}>
                                                            {bay.currentVehicle.customerName || 'Walk-in Customer'}
                                                        </div>
                                                    </div>
                                                </div>

                                                <div style={{ 
                                                    display: 'grid', 
                                                    gridTemplateColumns: '1fr 1fr', 
                                                    gap: '12px',
                                                    marginBottom: '16px'
                                                }}>
                                                    <div style={{
                                                        padding: '10px',
                                                        backgroundColor: theme.bgSecondary,
                                                        borderRadius: '2px'
                                                    }}>
                                                        <div style={{ fontSize: '11px', color: theme.textSecondary, marginBottom: '2px' }}>Service</div>
                                                        <div style={{ fontSize: '13px', fontWeight: '600', color: theme.text }}>{typeof bay.currentVehicle.service === 'object' ? bay.currentVehicle.service?.name : bay.currentVehicle.service || '-'}</div>
                                                    </div>
                                                    <div style={{
                                                        padding: '10px',
                                                        backgroundColor: '#dbeafe',
                                                        borderRadius: '2px'
                                                    }}>
                                                        <div style={{ fontSize: '11px', color: '#3b82f6', marginBottom: '2px' }}>Time Elapsed</div>
                                                        <div style={{ fontSize: '16px', fontWeight: '700', color: '#3b82f6' }}>{getElapsedTime(bay.startTime)}</div>
                                                    </div>
                                                </div>

                                                <button
                                                    onClick={() => handleCompleteWash(bay)}
                                                    disabled={actionLoading}
                                                    style={{
                                                        width: '100%',
                                                        padding: '12px',
                                                        borderRadius: '2px',
                                                        border: 'none',
                                                        backgroundColor: '#10b981',
                                                        color: 'white',
                                                        fontWeight: '600',
                                                        cursor: actionLoading ? 'not-allowed' : 'pointer',
                                                        fontSize: '14px'
                                                    }}
                                                >
                                                    ‚úì Complete Wash
                                                </button>
                                            </div>
                                        ) : bay.status === 'maintenance' ? (
                                            <div style={{ textAlign: 'center', padding: '20px 0' }}>
                                                <div style={{ fontSize: '40px', marginBottom: '12px' }}>üîß</div>
                                                <p style={{ color: theme.textSecondary, marginBottom: '16px' }}>
                                                    {bay.maintenanceNote || 'Under maintenance'}
                                                </p>
                                                <button
                                                    onClick={() => handleClearMaintenance(bay)}
                                                    disabled={actionLoading}
                                                    style={{
                                                        padding: '10px 24px',
                                                        borderRadius: '2px',
                                                        border: 'none',
                                                        backgroundColor: '#10b981',
                                                        color: 'white',
                                                        fontWeight: '600',
                                                        cursor: actionLoading ? 'not-allowed' : 'pointer'
                                                    }}
                                                >
                                                    Mark Available
                                                </button>
                                            </div>
                                        ) : (
                                            <div style={{ textAlign: 'center', padding: '20px 0' }}>
                                                <div style={{ fontSize: '40px', marginBottom: '12px' }}>‚ú®</div>
                                                <p style={{ color: theme.textSecondary, marginBottom: '16px' }}>Ready for next vehicle</p>
                                                <div style={{ display: 'flex', gap: '8px' }}>
                                                    <button
                                                        onClick={() => openAssignModal(bay)}
                                                        style={{
                                                            flex: 1,
                                                            padding: '10px',
                                                            borderRadius: '2px',
                                                            border: 'none',
                                                            backgroundColor: '#3b82f6',
                                                            color: 'white',
                                                            fontWeight: '600',
                                                            cursor: 'pointer'
                                                        }}
                                                    >
                                                        Assign Vehicle
                                                    </button>
                                                    <button
                                                        onClick={() => handleSetMaintenance(bay)}
                                                        style={{
                                                            padding: '10px 16px',
                                                            borderRadius: '2px',
                                                            border: `1px solid ${theme.border}`,
                                                            backgroundColor: 'transparent',
                                                            color: theme.textSecondary,
                                                            cursor: 'pointer'
                                                        }}
                                                        title="Set Maintenance"
                                                    >
                                                        üîß
                                                    </button>
                                                </div>
                                            </div>
                                        )}
                                    </div>

                                    {/* Bay Footer - Delete */}
                                    {bay.status === 'available' && (
                                        <div style={{
                                            padding: '12px 20px',
                                            borderTop: `1px solid ${theme.border}`,
                                            display: 'flex',
                                            justifyContent: 'flex-end'
                                        }}>
                                            <button
                                                onClick={() => handleDeleteBay(bay)}
                                                style={{
                                                    padding: '6px 12px',
                                                    borderRadius: '2px',
                                                    border: 'none',
                                                    backgroundColor: '#fee2e2',
                                                    color: '#dc2626',
                                                    fontSize: '12px',
                                                    cursor: 'pointer'
                                                }}
                                            >
                                                Delete Bay
                                            </button>
                                        </div>
                                    )}
                                </div>
                            );
                        })
                    )}
                </div>
            )}

            {/* History Tab */}
            {activeTab === 'history' && (
                <div style={{
                    backgroundColor: theme.bg,
                    borderRadius: '2px',
                    border: `1px solid ${theme.border}`,
                    overflow: 'hidden'
                }}>
                    <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                        <thead>
                            <tr style={{ backgroundColor: theme.bgSecondary }}>
                                <th style={{ padding: '14px 16px', textAlign: 'left', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase' }}>Bay</th>
                                <th style={{ padding: '14px 16px', textAlign: 'left', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase' }}>Vehicle</th>
                                <th style={{ padding: '14px 16px', textAlign: 'left', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase' }}>Service</th>
                                <th style={{ padding: '14px 16px', textAlign: 'left', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase' }}>Washed By</th>
                                <th style={{ padding: '14px 16px', textAlign: 'center', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase' }}>Started</th>
                                <th style={{ padding: '14px 16px', textAlign: 'center', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase' }}>Completed</th>
                                <th style={{ padding: '14px 16px', textAlign: 'center', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase' }}>Duration</th>
                                <th style={{ padding: '14px 16px', textAlign: 'center', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase' }}>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {(() => {
                                // Group history by combining started and completed records
                                const completedRecords = history.filter(r => r.action === 'completed');
                                
                                if (completedRecords.length === 0) {
                                    // Show in-progress items (started but not completed)
                                    const startedRecords = history.filter(r => r.action === 'started');
                                    if (startedRecords.length === 0) {
                                        return (
                                            <tr>
                                                <td colSpan="8" style={{ padding: '40px', textAlign: 'center', color: theme.textSecondary }}>
                                                    No wash history yet
                                                </td>
                                            </tr>
                                        );
                                    }
                                    return startedRecords.map(record => (
                                        <tr key={record.id} style={{ borderTop: `1px solid ${theme.border}` }}>
                                            <td style={{ padding: '14px 16px', fontSize: '13px', color: theme.text, fontWeight: '500' }}>
                                                {record.bayName || record.bayId}
                                            </td>
                                            <td style={{ padding: '14px 16px' }}>
                                                <div style={{ fontWeight: '600', color: theme.text }}>{record.vehicle?.plateNumber}</div>
                                                <div style={{ fontSize: '12px', color: theme.textSecondary }}>{record.vehicle?.customerName || 'Walk-in'}</div>
                                            </td>
                                            <td style={{ padding: '14px 16px', fontSize: '13px', color: theme.text }}>
                                                {typeof record.vehicle?.service === 'object' ? record.vehicle?.service?.name : record.vehicle?.service || '-'}
                                            </td>
                                            <td style={{ padding: '14px 16px', fontSize: '13px', color: theme.text }}>
                                                {record.vehicle?.assignedBy || '-'}
                                            </td>
                                            <td style={{ padding: '14px 16px', textAlign: 'center', fontSize: '12px', color: theme.text }}>
                                                {new Date(record.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                                            </td>
                                            <td style={{ padding: '14px 16px', textAlign: 'center', fontSize: '12px', color: theme.textSecondary }}>
                                                -
                                            </td>
                                            <td style={{ padding: '14px 16px', textAlign: 'center', fontSize: '13px', color: theme.textSecondary }}>
                                                -
                                            </td>
                                            <td style={{ padding: '14px 16px', textAlign: 'center' }}>
                                                <span style={{
                                                    padding: '4px 10px',
                                                    borderRadius: '12px',
                                                    fontSize: '12px',
                                                    fontWeight: '500',
                                                    backgroundColor: '#fef3c7',
                                                    color: '#d97706'
                                                }}>
                                                    In Progress
                                                </span>
                                            </td>
                                        </tr>
                                    ));
                                }
                                
                                // Show completed records (they have all the info including start time)
                                return completedRecords.map(record => (
                                    <tr key={record.id} style={{ borderTop: `1px solid ${theme.border}` }}>
                                        <td style={{ padding: '14px 16px', fontSize: '13px', color: theme.text, fontWeight: '500' }}>
                                            {record.bayName || record.bayId}
                                        </td>
                                        <td style={{ padding: '14px 16px' }}>
                                            <div style={{ fontWeight: '600', color: theme.text }}>{record.vehicle?.plateNumber}</div>
                                            <div style={{ fontSize: '12px', color: theme.textSecondary }}>{record.vehicle?.customerName || 'Walk-in'}</div>
                                        </td>
                                        <td style={{ padding: '14px 16px', fontSize: '13px', color: theme.text }}>
                                            {typeof record.vehicle?.service === 'object' ? record.vehicle?.service?.name : record.vehicle?.service || '-'}
                                        </td>
                                        <td style={{ padding: '14px 16px', fontSize: '13px', color: theme.text }}>
                                            {record.vehicle?.assignedBy || record.completedBy || '-'}
                                        </td>
                                        <td style={{ padding: '14px 16px', textAlign: 'center', fontSize: '12px', color: theme.text }}>
                                            {record.startTime ? new Date(record.startTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '-'}
                                        </td>
                                        <td style={{ padding: '14px 16px', textAlign: 'center', fontSize: '12px', color: theme.text }}>
                                            {record.endTime ? new Date(record.endTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '-'}
                                        </td>
                                        <td style={{ padding: '14px 16px', textAlign: 'center', fontSize: '13px', fontWeight: '600', color: '#3b82f6' }}>
                                            {record.duration ? `${record.duration} min` : '-'}
                                        </td>
                                        <td style={{ padding: '14px 16px', textAlign: 'center' }}>
                                            <span style={{
                                                padding: '4px 10px',
                                                borderRadius: '12px',
                                                fontSize: '12px',
                                                fontWeight: '500',
                                                backgroundColor: '#d1fae5',
                                                color: '#059669'
                                            }}>
                                                ‚úì Done
                                            </span>
                                        </td>
                                    </tr>
                                ));
                            })()}
                        </tbody>
                    </table>
                </div>
            )}

            {/* Add Bay Modal */}
            {showAddModal && (
                <div style={{
                    position: 'fixed',
                    top: 0,
                    left: 0,
                    right: 0,
                    bottom: 0,
                    backgroundColor: 'rgba(0,0,0,0.5)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    zIndex: 1000
                }} onClick={() => setShowAddModal(false)}>
                    <div style={{
                        backgroundColor: theme.bg,
                        borderRadius: '2px',
                        width: '100%',
                        maxWidth: '400px',
                        margin: '20px'
                    }} onClick={e => e.stopPropagation()}>
                        <div style={{ padding: '20px', borderBottom: `1px solid ${theme.border}` }}>
                            <h2 style={{ margin: 0, color: theme.text }}>Add New Bay</h2>
                        </div>
                        <form onSubmit={handleAddBay} style={{ padding: '20px' }}>
                            <div style={{ marginBottom: '16px' }}>
                                <label style={{ display: 'block', marginBottom: '6px', fontWeight: '500', color: theme.text }}>Bay Name *</label>
                                <input
                                    type="text"
                                    value={bayForm.name}
                                    onChange={e => setBayForm({ ...bayForm, name: e.target.value })}
                                    placeholder="e.g., Bay 5"
                                    style={{
                                        width: '100%',
                                        padding: '12px',
                                        borderRadius: '2px',
                                        border: `1px solid ${theme.border}`,
                                        backgroundColor: theme.inputBg,
                                        color: theme.text,
                                        fontSize: '14px'
                                    }}
                                />
                            </div>
                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'block', marginBottom: '6px', fontWeight: '500', color: theme.text }}>Bay Type</label>
                                <select
                                    value={bayForm.type}
                                    onChange={e => setBayForm({ ...bayForm, type: e.target.value })}
                                    style={{
                                        width: '100%',
                                        padding: '12px',
                                        borderRadius: '2px',
                                        border: `1px solid ${theme.border}`,
                                        backgroundColor: theme.inputBg,
                                        color: theme.text,
                                        fontSize: '14px'
                                    }}
                                >
                                    {BAY_TYPES.map(t => (
                                        <option key={t.id} value={t.id}>{t.name}</option>
                                    ))}
                                </select>
                            </div>
                            <div style={{ display: 'flex', gap: '12px' }}>
                                <button
                                    type="button"
                                    onClick={() => setShowAddModal(false)}
                                    style={{
                                        flex: 1,
                                        padding: '12px',
                                        borderRadius: '2px',
                                        border: `1px solid ${theme.border}`,
                                        backgroundColor: 'transparent',
                                        color: theme.text,
                                        fontWeight: '600',
                                        cursor: 'pointer'
                                    }}
                                >
                                    Cancel
                                </button>
                                <button
                                    type="submit"
                                    disabled={actionLoading}
                                    style={{
                                        flex: 1,
                                        padding: '12px',
                                        borderRadius: '2px',
                                        border: 'none',
                                        backgroundColor: '#10b981',
                                        color: 'white',
                                        fontWeight: '600',
                                        cursor: actionLoading ? 'not-allowed' : 'pointer'
                                    }}
                                >
                                    {actionLoading ? 'Adding...' : 'Add Bay'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            )}

            {/* Assign Vehicle Modal */}
            {showAssignModal && selectedBay && (
                <div style={{
                    position: 'fixed',
                    top: 0,
                    left: 0,
                    right: 0,
                    bottom: 0,
                    backgroundColor: 'rgba(0,0,0,0.5)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    zIndex: 1000
                }} onClick={() => setShowAssignModal(false)}>
                    <div style={{
                        backgroundColor: theme.bg,
                        borderRadius: '2px',
                        width: '100%',
                        maxWidth: '500px',
                        margin: '20px',
                        maxHeight: '90vh',
                        overflow: 'auto'
                    }} onClick={e => e.stopPropagation()}>
                        <div style={{ padding: '20px', borderBottom: `1px solid ${theme.border}` }}>
                            <h2 style={{ margin: 0, color: theme.text }}>Assign Vehicle to {selectedBay.name}</h2>
                        </div>
                        
                        <form onSubmit={handleAssignVehicle} style={{ padding: '20px' }}>
                            {/* Mode Toggle */}
                            <div style={{ 
                                display: 'flex', 
                                gap: '8px', 
                                marginBottom: '20px',
                                padding: '4px',
                                backgroundColor: theme.bgSecondary,
                                borderRadius: '2px'
                            }}>
                                <button
                                    type="button"
                                    onClick={() => { setAssignMode('select'); setSelectedVehicleId(''); }}
                                    style={{
                                        flex: 1,
                                        padding: '10px 16px',
                                        borderRadius: '2px',
                                        border: 'none',
                                        backgroundColor: assignMode === 'select' ? '#3b82f6' : 'transparent',
                                        color: assignMode === 'select' ? 'white' : theme.textSecondary,
                                        fontWeight: '600',
                                        cursor: 'pointer',
                                        fontSize: '13px'
                                    }}
                                >
                                    üìã From Queue ({intakeQueue.length})
                                </button>
                                <button
                                    type="button"
                                    onClick={() => setAssignMode('new')}
                                    style={{
                                        flex: 1,
                                        padding: '10px 16px',
                                        borderRadius: '2px',
                                        border: 'none',
                                        backgroundColor: assignMode === 'new' ? '#3b82f6' : 'transparent',
                                        color: assignMode === 'new' ? 'white' : theme.textSecondary,
                                        fontWeight: '600',
                                        cursor: 'pointer',
                                        fontSize: '13px'
                                    }}
                                >
                                    ‚ûï New Vehicle
                                </button>
                            </div>

                            {/* Select from Queue */}
                            {assignMode === 'select' && (
                                <div style={{ marginBottom: '16px' }}>
                                    {intakeQueue.length === 0 ? (
                                        <div style={{ 
                                            textAlign: 'center', 
                                            padding: '30px 20px',
                                            backgroundColor: theme.bgSecondary,
                                            borderRadius: '2px',
                                            border: `1px dashed ${theme.border}`
                                        }}>
                                            <div style={{ fontSize: '36px', marginBottom: '12px' }}>üöó</div>
                                            <p style={{ color: theme.textSecondary, marginBottom: '12px' }}>No vehicles waiting in queue</p>
                                            <button
                                                type="button"
                                                onClick={() => setAssignMode('new')}
                                                style={{
                                                    padding: '8px 16px',
                                                    borderRadius: '2px',
                                                    border: 'none',
                                                    backgroundColor: '#3b82f6',
                                                    color: 'white',
                                                    fontWeight: '500',
                                                    cursor: 'pointer',
                                                    fontSize: '13px'
                                                }}
                                            >
                                                Add New Vehicle
                                            </button>
                                        </div>
                                    ) : (
                                        <div>
                                            <label style={{ display: 'block', marginBottom: '8px', fontWeight: '500', color: theme.text }}>
                                                Select Vehicle from Queue
                                            </label>
                                            <div style={{ maxHeight: '200px', overflowY: 'auto', border: `1px solid ${theme.border}`, borderRadius: '2px' }}>
                                                {intakeQueue.map(vehicle => (
                                                    <div
                                                        key={vehicle.id}
                                                        onClick={() => setSelectedVehicleId(vehicle.id)}
                                                        style={{
                                                            padding: '12px 16px',
                                                            borderBottom: `1px solid ${theme.border}`,
                                                            cursor: 'pointer',
                                                            backgroundColor: selectedVehicleId === vehicle.id ? '#dbeafe' : 'transparent',
                                                            display: 'flex',
                                                            alignItems: 'center',
                                                            gap: '12px',
                                                            transition: 'background-color 0.15s'
                                                        }}
                                                    >
                                                        <div style={{
                                                            width: '20px',
                                                            height: '20px',
                                                            borderRadius: '50%',
                                                            border: `2px solid ${selectedVehicleId === vehicle.id ? '#3b82f6' : theme.border}`,
                                                            backgroundColor: selectedVehicleId === vehicle.id ? '#3b82f6' : 'transparent',
                                                            display: 'flex',
                                                            alignItems: 'center',
                                                            justifyContent: 'center'
                                                        }}>
                                                            {selectedVehicleId === vehicle.id && (
                                                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="3">
                                                                    <polyline points="20 6 9 17 4 12"/>
                                                                </svg>
                                                            )}
                                                        </div>
                                                        <div style={{ flex: 1 }}>
                                                            <div style={{ fontWeight: '600', color: theme.text, fontSize: '15px' }}>
                                                                {vehicle.plateNumber}
                                                            </div>
                                                            <div style={{ fontSize: '12px', color: theme.textSecondary }}>
                                                                {vehicle.customerName || vehicle.ownerName || 'Walk-in'} ‚Ä¢ {vehicle.vehicleType || 'Vehicle'}
                                                            </div>
                                                        </div>
                                                        <div style={{ 
                                                            fontSize: '11px', 
                                                            color: theme.textSecondary,
                                                            textAlign: 'right'
                                                        }}>
                                                            {new Date(vehicle.timeIn).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}

                            {/* New Vehicle Form */}
                            {assignMode === 'new' && (
                                <>
                                    <div style={{ marginBottom: '16px' }}>
                                        <label style={{ display: 'block', marginBottom: '6px', fontWeight: '500', color: theme.text }}>Plate Number *</label>
                                        <input
                                            type="text"
                                            value={assignForm.plateNumber}
                                            onChange={e => setAssignForm({ ...assignForm, plateNumber: e.target.value.toUpperCase() })}
                                            placeholder="e.g., KBZ 123A"
                                            style={{
                                                width: '100%',
                                                padding: '12px',
                                                borderRadius: '2px',
                                                border: `1px solid ${theme.border}`,
                                                backgroundColor: theme.inputBg,
                                                color: theme.text,
                                                fontSize: '14px',
                                                textTransform: 'uppercase'
                                            }}
                                        />
                                    </div>
                                    <div style={{ marginBottom: '16px' }}>
                                        <label style={{ display: 'block', marginBottom: '6px', fontWeight: '500', color: theme.text }}>Customer Name</label>
                                        <input
                                            type="text"
                                            value={assignForm.customerName}
                                            onChange={e => setAssignForm({ ...assignForm, customerName: e.target.value })}
                                            placeholder="Optional"
                                            style={{
                                                width: '100%',
                                                padding: '12px',
                                                borderRadius: '2px',
                                                border: `1px solid ${theme.border}`,
                                                backgroundColor: theme.inputBg,
                                                color: theme.text,
                                                fontSize: '14px'
                                            }}
                                        />
                                    </div>
                                    <div style={{ marginBottom: '16px' }}>
                                        <label style={{ display: 'block', marginBottom: '6px', fontWeight: '500', color: theme.text }}>Vehicle Type</label>
                                        <select
                                            value={assignForm.vehicleType}
                                            onChange={e => setAssignForm({ ...assignForm, vehicleType: e.target.value })}
                                            style={{
                                                width: '100%',
                                                padding: '12px',
                                                borderRadius: '2px',
                                                border: `1px solid ${theme.border}`,
                                                backgroundColor: theme.inputBg,
                                                color: theme.text,
                                                fontSize: '14px'
                                            }}
                                        >
                                            {VEHICLE_TYPES.map(t => (
                                                <option key={t} value={t.toLowerCase()}>{t}</option>
                                            ))}
                                        </select>
                                    </div>
                                </>
                            )}

                            {/* Service Selection (always shown) */}
                            <div style={{ marginBottom: '16px' }}>
                                <label style={{ display: 'block', marginBottom: '6px', fontWeight: '500', color: theme.text }}>Service</label>
                                <select
                                    value={assignForm.service}
                                    onChange={e => setAssignForm({ ...assignForm, service: e.target.value })}
                                    style={{
                                        width: '100%',
                                        padding: '12px',
                                        borderRadius: '2px',
                                        border: `1px solid ${theme.border}`,
                                        backgroundColor: theme.inputBg,
                                        color: theme.text,
                                        fontSize: '14px'
                                    }}
                                >
                                    <option value="">Select a service...</option>
                                    {servicePackages.map(pkg => (
                                        <option key={pkg.id} value={pkg.id}>{pkg.name} - KES {pkg.price?.toLocaleString()}</option>
                                    ))}
                                </select>
                            </div>

                            {/* Staff Assignment (always shown) */}
                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'block', marginBottom: '6px', fontWeight: '500', color: theme.text }}>
                                    Assign to Staff <span style={{ color: '#ef4444' }}>*</span>
                                </label>
                                {staffList.length === 0 ? (
                                    <div style={{ 
                                        padding: '12px', 
                                        backgroundColor: theme.bgSecondary, 
                                        borderRadius: '2px',
                                        border: `1px dashed ${theme.border}`,
                                        textAlign: 'center',
                                        color: theme.textSecondary,
                                        fontSize: '13px'
                                    }}>
                                        No staff members available. Add staff in Staff Management.
                                    </div>
                                ) : (
                                    <select
                                        value={assignForm.assignedTo}
                                        onChange={e => setAssignForm({ ...assignForm, assignedTo: e.target.value })}
                                        required
                                        style={{
                                            width: '100%',
                                            padding: '12px',
                                            borderRadius: '2px',
                                            border: `1px solid ${assignForm.assignedTo ? theme.border : '#f59e0b'}`,
                                            backgroundColor: theme.inputBg,
                                            color: theme.text,
                                            fontSize: '14px'
                                        }}
                                    >
                                        <option value="">-- Select Staff Member --</option>
                                        {staffList.map(staff => (
                                            <option key={staff.id} value={staff.name}>
                                                {staff.name} ({staff.role})
                                            </option>
                                        ))}
                                    </select>
                                )}
                            </div>

                            {/* Action Buttons */}
                            <div style={{ display: 'flex', gap: '12px' }}>
                                <button
                                    type="button"
                                    onClick={() => setShowAssignModal(false)}
                                    style={{
                                        flex: 1,
                                        padding: '12px',
                                        borderRadius: '2px',
                                        border: `1px solid ${theme.border}`,
                                        backgroundColor: 'transparent',
                                        color: theme.text,
                                        fontWeight: '600',
                                        cursor: 'pointer'
                                    }}
                                >
                                    Cancel
                                </button>
                                <button
                                    type="submit"
                                    disabled={actionLoading || (assignMode === 'select' && !selectedVehicleId)}
                                    style={{
                                        flex: 1,
                                        padding: '12px',
                                        borderRadius: '2px',
                                        border: 'none',
                                        backgroundColor: (assignMode === 'select' && !selectedVehicleId) ? '#94a3b8' : '#3b82f6',
                                        color: 'white',
                                        fontWeight: '600',
                                        cursor: (actionLoading || (assignMode === 'select' && !selectedVehicleId)) ? 'not-allowed' : 'pointer'
                                    }}
                                >
                                    {actionLoading ? 'Assigning...' : 'üöø Start Wash'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            )}

            {/* Confirmation Modal */}
            {showConfirmModal && confirmAction && (
                <div style={{
                    position: 'fixed',
                    top: 0,
                    left: 0,
                    right: 0,
                    bottom: 0,
                    backgroundColor: 'rgba(0,0,0,0.5)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    zIndex: 1100
                }} onClick={() => { setShowConfirmModal(false); setConfirmAction(null); }}>
                    <div style={{
                        backgroundColor: theme.bg,
                        borderRadius: '2px',
                        width: '100%',
                        maxWidth: '400px',
                        margin: '20px',
                        boxShadow: '0 20px 40px rgba(0,0,0,0.3)'
                    }} onClick={e => e.stopPropagation()}>
                        <div style={{ padding: '24px', textAlign: 'center' }}>
                            <div style={{ 
                                fontSize: '48px', 
                                marginBottom: '16px'
                            }}>
                                {confirmAction.type === 'delete' ? 'üóëÔ∏è' : confirmAction.type === 'complete' ? '‚úÖ' : 'üîß'}
                            </div>
                            <h3 style={{ 
                                margin: '0 0 8px 0', 
                                color: theme.text,
                                fontSize: '18px',
                                fontWeight: '600'
                            }}>
                                {confirmAction.title}
                            </h3>
                            <p style={{ 
                                margin: '0 0 24px 0', 
                                color: theme.textSecondary,
                                fontSize: '14px',
                                lineHeight: '1.5'
                            }}>
                                {confirmAction.message}
                            </p>
                            <div style={{ display: 'flex', gap: '12px' }}>
                                <button
                                    onClick={() => { setShowConfirmModal(false); setConfirmAction(null); }}
                                    style={{
                                        flex: 1,
                                        padding: '12px 20px',
                                        borderRadius: '2px',
                                        border: `1px solid ${theme.border}`,
                                        backgroundColor: 'transparent',
                                        color: theme.text,
                                        fontWeight: '600',
                                        cursor: 'pointer',
                                        fontSize: '14px'
                                    }}
                                >
                                    Cancel
                                </button>
                                <button
                                    onClick={handleConfirmAction}
                                    disabled={actionLoading}
                                    style={{
                                        flex: 1,
                                        padding: '12px 20px',
                                        borderRadius: '2px',
                                        border: 'none',
                                        backgroundColor: confirmAction.confirmColor || '#3b82f6',
                                        color: 'white',
                                        fontWeight: '600',
                                        cursor: actionLoading ? 'not-allowed' : 'pointer',
                                        fontSize: '14px'
                                    }}
                                >
                                    {actionLoading ? 'Please wait...' : confirmAction.confirmText}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* Maintenance Modal */}
            {showMaintenanceModal && selectedBay && (
                <div style={{
                    position: 'fixed',
                    top: 0,
                    left: 0,
                    right: 0,
                    bottom: 0,
                    backgroundColor: 'rgba(0,0,0,0.5)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    zIndex: 1100
                }} onClick={() => setShowMaintenanceModal(false)}>
                    <div style={{
                        backgroundColor: theme.bg,
                        borderRadius: '2px',
                        width: '100%',
                        maxWidth: '450px',
                        margin: '20px',
                        boxShadow: '0 20px 40px rgba(0,0,0,0.3)'
                    }} onClick={e => e.stopPropagation()}>
                        <div style={{ 
                            padding: '20px', 
                            borderBottom: `1px solid ${theme.border}`,
                            display: 'flex',
                            alignItems: 'center',
                            gap: '12px'
                        }}>
                            <div style={{ 
                                width: '40px', 
                                height: '40px', 
                                borderRadius: '2px',
                                backgroundColor: '#fef3c7',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                fontSize: '20px'
                            }}>
                                üîß
                            </div>
                            <div>
                                <h3 style={{ margin: 0, color: theme.text, fontSize: '16px' }}>
                                    Set Maintenance Mode
                                </h3>
                                <p style={{ margin: 0, color: theme.textSecondary, fontSize: '13px' }}>
                                    {selectedBay.name}
                                </p>
                            </div>
                        </div>
                        <div style={{ padding: '20px' }}>
                            <label style={{ 
                                display: 'block', 
                                marginBottom: '8px', 
                                fontWeight: '500', 
                                color: theme.text,
                                fontSize: '14px'
                            }}>
                                Maintenance Note (optional)
                            </label>
                            <textarea
                                value={maintenanceNote}
                                onChange={e => setMaintenanceNote(e.target.value)}
                                placeholder="e.g., Water pump repair, Floor cleaning..."
                                rows={3}
                                style={{
                                    width: '100%',
                                    padding: '12px',
                                    borderRadius: '2px',
                                    border: `1px solid ${theme.border}`,
                                    backgroundColor: theme.inputBg,
                                    color: theme.text,
                                    fontSize: '14px',
                                    resize: 'vertical',
                                    fontFamily: 'inherit'
                                }}
                            />
                            <div style={{ display: 'flex', gap: '12px', marginTop: '20px' }}>
                                <button
                                    onClick={() => setShowMaintenanceModal(false)}
                                    style={{
                                        flex: 1,
                                        padding: '12px 20px',
                                        borderRadius: '2px',
                                        border: `1px solid ${theme.border}`,
                                        backgroundColor: 'transparent',
                                        color: theme.text,
                                        fontWeight: '600',
                                        cursor: 'pointer',
                                        fontSize: '14px'
                                    }}
                                >
                                    Cancel
                                </button>
                                <button
                                    onClick={executeSetMaintenance}
                                    disabled={actionLoading}
                                    style={{
                                        flex: 1,
                                        padding: '12px 20px',
                                        borderRadius: '2px',
                                        border: 'none',
                                        backgroundColor: '#f59e0b',
                                        color: 'white',
                                        fontWeight: '600',
                                        cursor: actionLoading ? 'not-allowed' : 'pointer',
                                        fontSize: '14px'
                                    }}
                                >
                                    {actionLoading ? 'Saving...' : 'üîß Set Maintenance'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* Success Toast */}
            {successMessage && (
                <div style={{
                    position: 'fixed',
                    bottom: '24px',
                    right: '24px',
                    backgroundColor: '#10b981',
                    color: 'white',
                    padding: '16px 24px',
                    borderRadius: '2px',
                    boxShadow: '0 4px 20px rgba(16, 185, 129, 0.3)',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '12px',
                    zIndex: 1200,
                    animation: 'slideInRight 0.3s ease'
                }}>
                    <span style={{ fontSize: '20px' }}>‚úì</span>
                    <span style={{ fontWeight: '500' }}>{successMessage}</span>
                </div>
            )}

            {/* Error Toast */}
            {error && (
                <div style={{
                    position: 'fixed',
                    bottom: '24px',
                    right: '24px',
                    backgroundColor: '#ef4444',
                    color: 'white',
                    padding: '16px 24px',
                    borderRadius: '2px',
                    boxShadow: '0 4px 20px rgba(239, 68, 68, 0.3)',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '12px',
                    zIndex: 1200,
                    cursor: 'pointer'
                }} onClick={() => setError(null)}>
                    <span style={{ fontSize: '20px' }}>‚ö†Ô∏è</span>
                    <span style={{ fontWeight: '500' }}>{error}</span>
                    <span style={{ marginLeft: '8px', opacity: 0.7 }}>‚úï</span>
                </div>
            )}
        </div>
    );
}

// Wrapper component with Error Boundary
function WashBays() {
    try {
        return (
            <WashBaysErrorBoundary>
                <WashBaysContent />
            </WashBaysErrorBoundary>
        );
    } catch (err) {
        console.error('WashBays wrapper error:', err);
        return (
            <div style={{ padding: '40px', textAlign: 'center', backgroundColor: '#fee2e2' }}>
                <h3 style={{ color: '#dc2626' }}>Failed to load Wash Bays</h3>
                <p style={{ color: '#64748b' }}>{err.message}</p>
                <button onClick={() => window.location.reload()} style={{ marginTop: '16px', padding: '10px 20px', background: '#3b82f6', color: 'white', border: 'none', borderRadius: '4px', cursor: 'pointer' }}>Reload</button>
            </div>
        );
    }
}

// Dashboard Component - Real-time Firebase Integration
function Dashboard({ onModuleClick }) {
    const [searchQuery, setSearchQuery] = useState('');
    const [showSearchResults, setShowSearchResults] = useState(false);
    const [refreshKey, setRefreshKey] = useState(0);
    const [vehicles, setVehicles] = useState([]);
    const [queue, setQueue] = useState([]);
    const [bays, setBays] = useState([]);
    const [garageJobs, setGarageJobs] = useState([]);
    const [invoices, setInvoices] = useState([]);
    const [customers, setCustomers] = useState([]);
    const [inventory, setInventory] = useState([]);
    const [fleet, setFleet] = useState([]);
    const [expenses, setExpenses] = useState([]);
    const [equipment, setEquipment] = useState([]);
    const [staff, setStaff] = useState([]);
    const [washHistory, setWashHistory] = useState([]);
    const [activities, setActivities] = useState([]);
    const [loading, setLoading] = useState(true);

    // Subscribe to Firebase data for real-time stats
    useEffect(() => {
        let cancelled = false;
        
        const waitForServices = async () => {
            let services = window.FirebaseServices;
            let attempts = 0;
            while (!services && attempts < 20 && !cancelled) {
                await new Promise(resolve => setTimeout(resolve, 50));
                services = window.FirebaseServices;
                attempts++;
            }
            if (services && !cancelled) initializeSubscriptions();
        };
        
        if (window.FirebaseServices) {
            initializeSubscriptions();
        } else {
            waitForServices();
        }
        
        function initializeSubscriptions() {
            const svc = window.FirebaseServices;
            let unsubRecords, unsubQueue, unsubBays, unsubGarage, unsubInvoices, unsubCustomers, unsubInventory, unsubFleet, unsubExpenses, unsubEquipment, unsubStaff;
            
            // Subscribe to vehicle records (Firestore)
            if (svc.intakeRecordsService) {
                unsubRecords = svc.intakeRecordsService.subscribeToRecords(
                    (records) => {
                        console.log('Dashboard: Records updated', records.length);
                        setVehicles(records);
                        setLoading(false);
                    },
                    (err) => console.error('Dashboard records error:', err)
                );
            }
            
            // Subscribe to queue (Realtime DB)
            if (svc.intakeQueueService) {
                unsubQueue = svc.intakeQueueService.subscribeToQueue(
                    (queueData) => {
                        console.log('Dashboard: Queue updated', queueData.length);
                        setQueue(queueData);
                    },
                    (err) => console.error('Dashboard queue error:', err)
                );
            }
            
            // Subscribe to bays (Realtime DB - from Wash Bay module)
            if (svc.washBayService?.subscribeToBays) {
                unsubBays = svc.washBayService.subscribeToBays(
                    (baysData) => {
                        console.log('Dashboard: Wash Bays updated', baysData.length);
                        setBays(baysData);
                    }
                );
            }

            // Subscribe to wash history
            let unsubWashHistory = null;
            if (svc.washBayService?.subscribeToHistory) {
                unsubWashHistory = svc.washBayService.subscribeToHistory(
                    (historyData) => {
                        console.log('Dashboard: Wash History updated', historyData.length);
                        setWashHistory(historyData);
                    }
                );
            }
            
            // Subscribe to garage jobs (Firestore)
            if (svc.garageJobsService) {
                unsubGarage = svc.garageJobsService.subscribeToJobs(
                    (jobs) => {
                        console.log('Dashboard: Garage jobs updated', jobs.length);
                        setGarageJobs(jobs);
                    },
                    (err) => console.error('Dashboard garage error:', err)
                );
            }

            // Subscribe to billing/invoices for revenue
            if (svc.billingService?.subscribeToInvoices) {
                unsubInvoices = svc.billingService.subscribeToInvoices((invoiceData) => {
                    console.log('Dashboard: Invoices updated', invoiceData.length);
                    setInvoices(invoiceData);
                });
            }

            // Subscribe to customers
            if (svc.customerService?.subscribeToCustomers) {
                unsubCustomers = svc.customerService.subscribeToCustomers((customerData) => {
                    console.log('Dashboard: Customers updated', customerData.length);
                    setCustomers(customerData);
                });
            }

            // Subscribe to inventory
            if (svc.inventoryService?.subscribeToItems) {
                unsubInventory = svc.inventoryService.subscribeToItems((items) => {
                    console.log('Dashboard: Inventory updated', items.length);
                    setInventory(items);
                });
            }

            // Subscribe to fleet
            if (svc.fleetService?.subscribeToAccounts) {
                unsubFleet = svc.fleetService.subscribeToAccounts((accounts) => {
                    console.log('Dashboard: Fleet updated', accounts.length);
                    setFleet(accounts);
                });
            }

            // Subscribe to expenses
            if (svc.expensesService?.subscribeToExpenses) {
                unsubExpenses = svc.expensesService.subscribeToExpenses((expenseData) => {
                    console.log('Dashboard: Expenses updated', expenseData.length);
                    setExpenses(expenseData);
                });
            }

            // Subscribe to equipment
            if (svc.equipmentService?.subscribeToEquipment) {
                unsubEquipment = svc.equipmentService.subscribeToEquipment((equipmentData) => {
                    console.log('Dashboard: Equipment updated', equipmentData.length);
                    setEquipment(equipmentData);
                });
            }

            // Subscribe to staff
            if (svc.staffService?.subscribeToStaff) {
                unsubStaff = svc.staffService.subscribeToStaff((staffData) => {
                    console.log('Dashboard: Staff updated', staffData.length);
                    setStaff(staffData);
                });
            }

            // Subscribe to activities for recent activity feed
            let unsubActivities = null;
            if (svc.activityService?.subscribeToActivities) {
                unsubActivities = svc.activityService.subscribeToActivities(
                    (activityData) => {
                        console.log('Dashboard: Activities updated', activityData.length);
                        setActivities(activityData);
                    },
                    50 // Get more activities to filter for today
                );
            }
            
            return () => {
                if (unsubRecords) unsubRecords();
                if (unsubQueue) unsubQueue();
                if (unsubBays) unsubBays();
                if (unsubGarage) unsubGarage();
                if (unsubInvoices) unsubInvoices();
                if (unsubCustomers) unsubCustomers();
                if (unsubInventory) unsubInventory();
                if (unsubFleet) unsubFleet();
                if (unsubExpenses) unsubExpenses();
                if (unsubEquipment) unsubEquipment();
                if (unsubStaff) unsubStaff();
                if (unsubWashHistory) unsubWashHistory();
                if (unsubActivities) unsubActivities();
            };
        }
    }, [refreshKey]);

    // Calculate real-time stats
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    const todayVehicles = vehicles.filter(v => {
        const vDate = new Date(v.timeIn || v.createdAt);
        vDate.setHours(0, 0, 0, 0);
        return vDate.getTime() === today.getTime();
    });
    
    const completedToday = todayVehicles.filter(v => v.status === 'completed');
    
    // Calculate revenue from BILLING MODULE only
    const todayInvoices = invoices.filter(inv => {
        const invDate = new Date(inv.createdAt || inv.date);
        invDate.setHours(0, 0, 0, 0);
        return invDate.getTime() === today.getTime();
    });
    
    const totalRevenueToday = todayInvoices.reduce((sum, inv) => sum + (inv.totalAmount || inv.total || inv.amount || 0), 0);
    const paidRevenueToday = todayInvoices.filter(inv => inv.paymentStatus === 'paid').reduce((sum, inv) => sum + (inv.totalAmount || inv.total || inv.amount || 0), 0);
    const pendingRevenueToday = totalRevenueToday - paidRevenueToday;
    
    // Separate wash and garage revenue
    const washRevenueToday = todayInvoices.filter(inv => inv.source === 'wash').reduce((sum, inv) => sum + (inv.totalAmount || inv.total || inv.amount || 0), 0);
    const garageRevenueToday = todayInvoices.filter(inv => inv.source === 'garage').reduce((sum, inv) => sum + (inv.totalAmount || inv.total || inv.amount || 0), 0);
    
    const inProgressCount = vehicles.filter(v => v.status === 'in-progress').length;
    
    // Real-time wash bays stats
    const totalBays = bays.length;
    const occupiedBays = bays.filter(b => b.status === 'occupied').length;
    const availableBays = bays.filter(b => b.status === 'available').length;
    const maintenanceBays = bays.filter(b => b.status === 'maintenance').length;
    
    // Wash history stats - count completed washes today
    const todayStr = today.toISOString().split('T')[0];
    const completedWashesToday = washHistory.filter(h => {
        if (h.action !== 'completed') return false;
        const hDate = h.timestamp ? new Date(h.timestamp).toISOString().split('T')[0] : null;
        return hDate === todayStr;
    }).length;
    const totalWashHistory = washHistory.filter(h => h.action === 'completed').length;
    
    // Real-time inventory stats
    const lowStockItems = inventory.filter(i => (i.quantity || 0) <= (i.minStock || i.reorderLevel || 5)).length;
    const inventoryValue = inventory.reduce((s, i) => s + ((i.quantity || 0) * (i.unitCost || i.cost || 0)), 0);
    
    // Real-time fleet stats
    const totalFleetBalance = fleet.reduce((s, f) => s + (f.balance || 0), 0);
    const fleetVehicles = fleet.reduce((s, f) => s + (f.vehicles?.length || 0), 0);
    
    // Garage jobs stats - detailed breakdown
    const garageJobsQueue = garageJobs.filter(j => j.status === 'pending' || j.status === 'queued').length;
    const garageJobsInProgress = garageJobs.filter(j => j.status === 'in-progress').length;
    const garageJobsCompleted = garageJobs.filter(j => j.status === 'completed').length;
    const activeGarageJobs = garageJobsQueue + garageJobsInProgress;

    // Real-time expenses stats
    const expensesToday = expenses.filter(e => e.date === todayStr).reduce((sum, e) => sum + (e.amount || 0), 0);
    const totalExpenses = expenses.reduce((sum, e) => sum + (e.amount || 0), 0);

    // Real-time equipment stats
    const totalEquipment = equipment.length;
    const operationalEquipment = equipment.filter(e => e.status === 'operational').length;
    const maintenanceEquipment = equipment.filter(e => e.status === 'maintenance' || e.status === 'repair').length;

    // Real-time staff stats
    const totalStaff = staff.length;
    const activeStaff = staff.filter(s => s.status === 'active' || s.isActive === true || !s.status).length;
    
    const handleRefresh = () => {
        console.log('Refreshing dashboard data...');
        setLoading(true);
        setRefreshKey(prev => prev + 1); // Trigger re-subscription
    };
    
    const handleSearch = (e) => {
        const query = e.target.value;
        setSearchQuery(query);
        setShowSearchResults(query.trim().length > 0);
    };

    // Global search function
    const getSearchResults = () => {
        if (!searchQuery.trim()) return { vehicles: [], customers: [], invoices: [], staff: [], activities: [] };
        const q = searchQuery.toLowerCase();
        
        const matchedVehicles = vehicles.filter(v => 
            (v.plateNumber || v.registrationNumber || '').toLowerCase().includes(q) ||
            (v.ownerName || v.customerName || '').toLowerCase().includes(q) ||
            (v.vehicleType || v.type || '').toLowerCase().includes(q) ||
            (v.itemType || '').toLowerCase().includes(q) ||
            (v.category || '').toLowerCase().includes(q)
        ).slice(0, 5);
        
        const matchedCustomers = customers.filter(c => 
            (c.name || '').toLowerCase().includes(q) ||
            (c.phone || '').toLowerCase().includes(q) ||
            (c.email || '').toLowerCase().includes(q) ||
            (c.company || '').toLowerCase().includes(q)
        ).slice(0, 5);
        
        const matchedInvoices = invoices.filter(i => 
            (i.invoiceNumber || i.id || '').toLowerCase().includes(q) ||
            (i.customerName || '').toLowerCase().includes(q) ||
            (i.plateNumber || '').toLowerCase().includes(q)
        ).slice(0, 5);

        const matchedStaff = staff.filter(s => 
            (s.name || '').toLowerCase().includes(q) ||
            (s.role || '').toLowerCase().includes(q) ||
            (s.phone || '').toLowerCase().includes(q)
        ).slice(0, 5);

        const matchedActivities = activities.filter(a => 
            (a.description || '').toLowerCase().includes(q) ||
            (a.type || '').toLowerCase().includes(q) ||
            (a.user || '').toLowerCase().includes(q)
        ).slice(0, 5);
        
        return { 
            vehicles: matchedVehicles, 
            customers: matchedCustomers, 
            invoices: matchedInvoices,
            staff: matchedStaff,
            activities: matchedActivities
        };
    };

    const searchResults = getSearchResults();
    const hasResults = Object.values(searchResults).some(arr => arr.length > 0);
    const totalResults = Object.values(searchResults).reduce((sum, arr) => sum + arr.length, 0);
    
    const stats = [
        {
            title: 'Vehicles Today',
            value: todayVehicles.length.toString(),
            icon: <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 16H9m10 0h3l-3.5-7a2 2 0 0 0-1.9-1.3H7.4a2 2 0 0 0-1.9 1.3L2 16h3m0 0a2 2 0 1 0 4 0m4 0a2 2 0 1 0 4 0"/></svg>,
            color: '#3b82f6'
        },
        {
            title: 'Total Vehicles',
            value: vehicles.length.toString(),
            icon: <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#6366f1" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>,
            color: '#6366f1'
        },
        {
            title: 'Wash Bays',
            value: totalBays.toString(),
            subValues: [
                { label: 'In Use', value: occupiedBays, color: '#3b82f6' },
                { label: 'Active', value: availableBays, color: '#10b981' },
                { label: 'Maintenance', value: maintenanceBays, color: '#f59e0b' },
                { label: 'Completed Today', value: completedWashesToday, color: '#6366f1' }
            ],
            icon: <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#10b981" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/></svg>,
            color: '#10b981'
        },
        {
            title: 'In Queue',
            value: queue.length.toString(),
            icon: <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
            color: '#f59e0b'
        },
        {
            title: 'Revenue Today',
            value: `KSh ${totalRevenueToday.toLocaleString()}`,
            subValues: [
                { label: 'Paid', value: paidRevenueToday, color: '#10b981' },
                { label: 'Pending', value: pendingRevenueToday, color: '#f59e0b' },
                { label: 'Wash', value: washRevenueToday, color: '#3b82f6' },
                { label: 'Garage', value: garageRevenueToday, color: '#8b5cf6' }
            ],
            icon: <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#10b981" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>,
            color: '#10b981'
        },
        {
            title: 'Expenses Today',
            value: `KSh ${expensesToday.toLocaleString()}`,
            icon: <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#ef4444" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>,
            color: '#ef4444'
        },
        {
            title: 'Customers',
            value: customers.length.toString(),
            icon: <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#8b5cf6" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
            color: '#8b5cf6'
        },
        {
            title: 'Garage Jobs',
            value: garageJobs.length.toString(),
            subValues: [
                { label: 'Queue', value: garageJobsQueue, color: '#f59e0b' },
                { label: 'In Progress', value: garageJobsInProgress, color: '#3b82f6' },
                { label: 'Completed', value: garageJobsCompleted, color: '#10b981' }
            ],
            icon: <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#f97316" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>,
            color: '#f97316'
        },
        {
            title: 'Equipment',
            value: `${operationalEquipment}/${totalEquipment}`,
            icon: <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#0ea5e9" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>,
            color: '#0ea5e9'
        },
        {
            title: 'Active Staff',
            value: `${activeStaff}/${totalStaff}`,
            icon: <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#14b8a6" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
            color: '#14b8a6'
        },
        {
            title: 'Low Stock',
            value: lowStockItems.toString(),
            icon: <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke={lowStockItems > 0 ? "#ef4444" : "#10b981"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/></svg>,
            color: lowStockItems > 0 ? '#ef4444' : '#10b981'
        },
        {
            title: 'Fleet Balance',
            value: `KSh ${totalFleetBalance.toLocaleString()}`,
            icon: <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#06b6d4" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="1" y="3" width="15" height="13"/><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg>,
            color: '#06b6d4'
        }
    ];

    const quickAccess = [
        { 
            id: 'vehicle-intake', 
            label: 'Vehicle Intake', 
            icon: Icons.car,
            color: '#3b82f6'
        },
        { 
            id: 'wash-bays', 
            label: 'Wash Bays', 
            icon: Icons.droplet,
            color: '#10b981'
        },
        { 
            id: 'billing', 
            label: 'Billing', 
            icon: Icons.creditCard,
            color: '#8b5cf6'
        },
        { 
            id: 'customers', 
            label: 'Customers', 
            icon: Icons.users,
            color: '#f59e0b'
        },
        { 
            id: 'reports', 
            label: 'Reports', 
            icon: Icons.trendingUp,
            color: '#ec4899'
        },
        { 
            id: 'settings', 
            label: 'Settings', 
            icon: Icons.settings,
            color: '#6366f1'
        }
    ];

    return (
        <div className="dashboard">
            <div className="dashboard-toolbar">
                <div className="search-bar-container" style={{ position: 'relative' }}>
                    <svg className="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="m21 21-4.35-4.35"/>
                    </svg>
                    <input 
                        type="text" 
                        className="search-bar" 
                        placeholder="Search vehicles, customers, invoices, staff..."
                        value={searchQuery}
                        onChange={handleSearch}
                        onFocus={() => searchQuery && setShowSearchResults(true)}
                    />
                    {searchQuery && (
                        <button className="search-clear" onClick={() => { setSearchQuery(''); setShowSearchResults(false); }}>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                <line x1="18" y1="6" x2="6" y2="18"/>
                                <line x1="6" y1="6" x2="18" y2="18"/>
                            </svg>
                        </button>
                    )}
                    
                    {/* Global Search Results Dropdown */}
                    {showSearchResults && searchQuery && (
                        <div style={{
                            position: 'absolute',
                            top: '100%',
                            left: 0,
                            right: 0,
                            marginTop: '8px',
                            background: 'var(--bg-primary, #fff)',
                            border: '1px solid var(--border-color, #e2e8f0)',
                            borderRadius: '0',
                            boxShadow: '0 10px 40px rgba(0,0,0,0.15)',
                            zIndex: 1000,
                            maxHeight: '450px',
                            overflowY: 'auto'
                        }}>
                            {/* Header */}
                            <div style={{ 
                                padding: '12px 16px', 
                                borderBottom: '1px solid var(--border-color, #e2e8f0)',
                                display: 'flex',
                                justifyContent: 'space-between',
                                alignItems: 'center',
                                background: 'var(--bg-secondary, #f8fafc)'
                            }}>
                                <span style={{ fontSize: '13px', fontWeight: '600', color: 'var(--text-primary)' }}>
                                    {hasResults ? `${totalResults} results found` : 'No results'}
                                </span>
                                <button 
                                    onClick={() => setShowSearchResults(false)}
                                    style={{ background: 'none', border: 'none', cursor: 'pointer', padding: '4px', color: 'var(--text-secondary)' }}
                                >
                                    ‚úï
                                </button>
                            </div>
                            
                            {!hasResults ? (
                                <div style={{ padding: '24px', textAlign: 'center', color: 'var(--text-secondary)' }}>
                                    <div style={{ fontSize: '32px', marginBottom: '8px' }}>üîç</div>
                                    <div>No matches found for "{searchQuery}"</div>
                                </div>
                            ) : (
                                <>
                                    {/* Vehicles */}
                                    {searchResults.vehicles.length > 0 && (
                                        <div style={{ borderBottom: '1px solid var(--border-color, #e2e8f0)' }}>
                                            <div style={{ padding: '10px 16px', fontSize: '11px', fontWeight: '600', color: 'var(--text-secondary)', textTransform: 'uppercase', background: 'var(--bg-secondary, #f8fafc)' }}>
                                                üöó Vehicles ({searchResults.vehicles.length})
                                            </div>
                                            {searchResults.vehicles.map((v, i) => (
                                                <div key={i} onClick={() => { onModuleClick('vehicle-intake'); setShowSearchResults(false); }} style={{ 
                                                    padding: '12px 16px', 
                                                    cursor: 'pointer',
                                                    borderBottom: i < searchResults.vehicles.length - 1 ? '1px solid var(--border-color, #e2e8f0)' : 'none',
                                                    display: 'flex',
                                                    justifyContent: 'space-between',
                                                    alignItems: 'center'
                                                }} className="search-result-item">
                                                    <div>
                                                        <div style={{ fontWeight: '600', fontSize: '14px' }}>{v.plateNumber || v.registrationNumber || v.itemType || 'N/A'}</div>
                                                        <div style={{ fontSize: '12px', color: 'var(--text-secondary)' }}>{v.ownerName || v.customerName || 'Unknown'} ‚Ä¢ {v.category || v.vehicleType || 'Vehicle'}</div>
                                                    </div>
                                                    <span style={{ 
                                                        padding: '4px 8px', 
                                                        fontSize: '11px', 
                                                        borderRadius: '0', 
                                                        background: v.status === 'completed' ? '#d1fae5' : v.status === 'in-progress' ? '#dbeafe' : '#fef3c7',
                                                        color: v.status === 'completed' ? '#065f46' : v.status === 'in-progress' ? '#1e40af' : '#92400e'
                                                    }}>
                                                        {v.status || 'queued'}
                                                    </span>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                    
                                    {/* Customers */}
                                    {searchResults.customers.length > 0 && (
                                        <div style={{ borderBottom: '1px solid var(--border-color, #e2e8f0)' }}>
                                            <div style={{ padding: '10px 16px', fontSize: '11px', fontWeight: '600', color: 'var(--text-secondary)', textTransform: 'uppercase', background: 'var(--bg-secondary, #f8fafc)' }}>
                                                üë§ Customers ({searchResults.customers.length})
                                            </div>
                                            {searchResults.customers.map((c, i) => (
                                                <div key={i} onClick={() => { onModuleClick('customers'); setShowSearchResults(false); }} style={{ 
                                                    padding: '12px 16px', 
                                                    cursor: 'pointer',
                                                    borderBottom: i < searchResults.customers.length - 1 ? '1px solid var(--border-color, #e2e8f0)' : 'none',
                                                    display: 'flex',
                                                    justifyContent: 'space-between',
                                                    alignItems: 'center'
                                                }} className="search-result-item">
                                                    <div>
                                                        <div style={{ fontWeight: '600', fontSize: '14px' }}>{c.name}</div>
                                                        <div style={{ fontSize: '12px', color: 'var(--text-secondary)' }}>{c.phone || c.email || 'No contact'}</div>
                                                    </div>
                                                    {c.company && <span style={{ fontSize: '12px', color: 'var(--text-secondary)' }}>{c.company}</span>}
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                    
                                    {/* Invoices */}
                                    {searchResults.invoices.length > 0 && (
                                        <div style={{ borderBottom: '1px solid var(--border-color, #e2e8f0)' }}>
                                            <div style={{ padding: '10px 16px', fontSize: '11px', fontWeight: '600', color: 'var(--text-secondary)', textTransform: 'uppercase', background: 'var(--bg-secondary, #f8fafc)' }}>
                                                üí≥ Invoices ({searchResults.invoices.length})
                                            </div>
                                            {searchResults.invoices.map((inv, i) => (
                                                <div key={i} onClick={() => { onModuleClick('billing'); setShowSearchResults(false); }} style={{ 
                                                    padding: '12px 16px', 
                                                    cursor: 'pointer',
                                                    borderBottom: i < searchResults.invoices.length - 1 ? '1px solid var(--border-color, #e2e8f0)' : 'none',
                                                    display: 'flex',
                                                    justifyContent: 'space-between',
                                                    alignItems: 'center'
                                                }} className="search-result-item">
                                                    <div>
                                                        <div style={{ fontWeight: '600', fontSize: '14px' }}>{inv.invoiceNumber || inv.id}</div>
                                                        <div style={{ fontSize: '12px', color: 'var(--text-secondary)' }}>{inv.customerName || inv.plateNumber || 'N/A'}</div>
                                                    </div>
                                                    <div style={{ textAlign: 'right' }}>
                                                        <div style={{ fontWeight: '600', color: '#10b981' }}>KSh {(inv.totalAmount || inv.total || 0).toLocaleString()}</div>
                                                        <span style={{ 
                                                            padding: '2px 6px', 
                                                            fontSize: '10px', 
                                                            borderRadius: '0', 
                                                            background: inv.paymentStatus === 'paid' ? '#d1fae5' : '#fef3c7',
                                                            color: inv.paymentStatus === 'paid' ? '#065f46' : '#92400e'
                                                        }}>
                                                            {inv.paymentStatus || 'pending'}
                                                        </span>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                    
                                    {/* Staff */}
                                    {searchResults.staff.length > 0 && (
                                        <div style={{ borderBottom: '1px solid var(--border-color, #e2e8f0)' }}>
                                            <div style={{ padding: '10px 16px', fontSize: '11px', fontWeight: '600', color: 'var(--text-secondary)', textTransform: 'uppercase', background: 'var(--bg-secondary, #f8fafc)' }}>
                                                üë• Staff ({searchResults.staff.length})
                                            </div>
                                            {searchResults.staff.map((s, i) => (
                                                <div key={i} onClick={() => { onModuleClick('staff'); setShowSearchResults(false); }} style={{ 
                                                    padding: '12px 16px', 
                                                    cursor: 'pointer',
                                                    borderBottom: i < searchResults.staff.length - 1 ? '1px solid var(--border-color, #e2e8f0)' : 'none',
                                                    display: 'flex',
                                                    justifyContent: 'space-between',
                                                    alignItems: 'center'
                                                }} className="search-result-item">
                                                    <div>
                                                        <div style={{ fontWeight: '600', fontSize: '14px' }}>{s.name}</div>
                                                        <div style={{ fontSize: '12px', color: 'var(--text-secondary)' }}>{s.role || 'Staff'} ‚Ä¢ {s.phone || 'No phone'}</div>
                                                    </div>
                                                    <span style={{ 
                                                        padding: '4px 8px', 
                                                        fontSize: '11px', 
                                                        borderRadius: '0', 
                                                        background: s.status === 'active' || !s.status ? '#d1fae5' : '#fee2e2',
                                                        color: s.status === 'active' || !s.status ? '#065f46' : '#991b1b'
                                                    }}>
                                                        {s.status || 'active'}
                                                    </span>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                    
                                    {/* Activities */}
                                    {searchResults.activities.length > 0 && (
                                        <div>
                                            <div style={{ padding: '10px 16px', fontSize: '11px', fontWeight: '600', color: 'var(--text-secondary)', textTransform: 'uppercase', background: 'var(--bg-secondary, #f8fafc)' }}>
                                                üìã Activities ({searchResults.activities.length})
                                            </div>
                                            {searchResults.activities.map((a, i) => (
                                                <div key={i} onClick={() => { onModuleClick('activities'); setShowSearchResults(false); }} style={{ 
                                                    padding: '12px 16px', 
                                                    cursor: 'pointer',
                                                    borderBottom: i < searchResults.activities.length - 1 ? '1px solid var(--border-color, #e2e8f0)' : 'none',
                                                    display: 'flex',
                                                    justifyContent: 'space-between',
                                                    alignItems: 'center'
                                                }} className="search-result-item">
                                                    <div>
                                                        <div style={{ fontWeight: '600', fontSize: '14px' }}>{a.description}</div>
                                                        <div style={{ fontSize: '12px', color: 'var(--text-secondary)' }}>{a.type} ‚Ä¢ {a.user || 'System'}</div>
                                                    </div>
                                                    <span style={{ fontSize: '11px', color: 'var(--text-secondary)' }}>
                                                        {new Date(a.timestamp).toLocaleDateString()}
                                                    </span>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </>
                            )}
                        </div>
                    )}
                </div>
                <button className="refresh-button" onClick={handleRefresh} title="Refresh Dashboard" style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" style={{ animation: loading ? 'spin 1s linear infinite' : 'none' }}>
                        <path d="M21 2v6h-6"/>
                        <path d="M3 12a9 9 0 0 1 15-6.7L21 8"/>
                        <path d="M3 22v-6h6"/>
                        <path d="M21 12a9 9 0 0 1-15 6.7L3 16"/>
                    </svg>
                    <span>Refresh</span>
                </button>
            </div>
            
            <div className="stats-grid">
                {stats.map((stat, index) => (
                    <div key={index} className="stat-card">
                        <div className="stat-card-header">
                            <div className="stat-card-icon">
                                {stat.icon}
                            </div>
                        </div>
                        <div className="stat-card-body">
                            <div className="stat-card-value">{stat.value}</div>
                            <div className="stat-card-title">{stat.title}</div>
                            {/* Revenue breakdown */}
                            {stat.subValues && (
                                <div style={{ 
                                    display: 'grid', 
                                    gridTemplateColumns: 'repeat(2, 1fr)',
                                    gap: '6px', 
                                    marginTop: '10px'
                                }}>
                                    {stat.subValues.map((sub, idx) => (
                                        <div key={idx} style={{ 
                                            display: 'flex', 
                                            alignItems: 'center',
                                            gap: '4px',
                                            fontSize: '11px'
                                        }}>
                                            <span style={{ 
                                                width: '6px', 
                                                height: '6px', 
                                                borderRadius: '50%',
                                                background: sub.color,
                                                flexShrink: 0
                                            }}></span>
                                            <span style={{ color: 'var(--text-secondary, #64748b)' }}>{sub.label}:</span>
                                            <span style={{ fontWeight: '600', color: 'var(--text-primary, #1e293b)' }}>
                                                {sub.value.toLocaleString()}
                                            </span>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                ))}
            </div>
            
            <div className="quick-access-section">
                <h2 className="section-title">Quick Access</h2>
                <div className="quick-access-grid">
                    {quickAccess.map((item) => (
                        <button 
                            key={item.id} 
                            className="quick-access-btn"
                            style={{ backgroundColor: item.color }}
                            onClick={() => onModuleClick(item.id)}
                        >
                            <span className="quick-access-icon">{item.icon}</span>
                            <span className="quick-access-label">{item.label}</span>
                        </button>
                    ))}
                </div>
            </div>
            
            <div className="recent-activities-section">
                <div className="section-header">
                    <h2 className="section-title">Today's Activities</h2>
                    <div className="section-actions">
                        <span style={{ fontSize: '12px', color: 'var(--text-secondary)', marginRight: '8px' }}>
                            {activities.filter(a => {
                                const aDate = new Date(a.timestamp);
                                aDate.setHours(0, 0, 0, 0);
                                return aDate.getTime() === today.getTime();
                            }).length} today
                        </span>
                        <button className="view-all-btn" onClick={() => onModuleClick('activities')}>View All</button>
                    </div>
                </div>
                <div className="table-container">
                    <table className="activities-table">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Activity</th>
                                <th>Details</th>
                                <th>Logged By</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {(() => {
                                const todayActivities = activities.filter(a => {
                                    const aDate = new Date(a.timestamp);
                                    aDate.setHours(0, 0, 0, 0);
                                    return aDate.getTime() === today.getTime();
                                }).slice(0, 10);
                                
                                if (todayActivities.length === 0) {
                                    return (
                                        <tr>
                                            <td colSpan="5" className="empty-table">No activities today</td>
                                        </tr>
                                    );
                                }
                                
                                return todayActivities.map((activity, idx) => (
                                    <tr key={activity.id || idx}>
                                        <td style={{ whiteSpace: 'nowrap', fontSize: '13px' }}>
                                            {new Date(activity.timestamp).toLocaleTimeString('en-US', { 
                                                hour: '2-digit', 
                                                minute: '2-digit'
                                            })}
                                        </td>
                                        <td>
                                            <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                                <span style={{ 
                                                    fontSize: '16px',
                                                    width: '28px',
                                                    height: '28px',
                                                    borderRadius: '6px',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    justifyContent: 'center',
                                                    background: activity.type === 'intake' ? '#dbeafe' :
                                                               activity.type === 'billing' ? '#d1fae5' :
                                                               activity.type === 'wash' ? '#e0e7ff' :
                                                               activity.type === 'garage' ? '#fef3c7' :
                                                               '#f1f5f9'
                                                }}>
                                                    {activity.type === 'intake' ? 'üöó' :
                                                     activity.type === 'billing' ? 'üí≥' :
                                                     activity.type === 'wash' ? 'üöø' :
                                                     activity.type === 'garage' ? 'üîß' :
                                                     activity.type === 'inventory' ? 'üì¶' :
                                                     activity.type === 'staff' ? 'üë§' :
                                                     'üìã'}
                                                </span>
                                                <span style={{ fontWeight: '500', color: 'var(--text-primary)' }}>
                                                    {activity.action || activity.description || 'Activity'}
                                                </span>
                                            </div>
                                        </td>
                                        <td style={{ color: 'var(--text-secondary)', fontSize: '13px' }}>
                                            {activity.details || activity.user || '-'}
                                        </td>
                                        <td>
                                            <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                                                <span style={{
                                                    width: '22px',
                                                    height: '22px',
                                                    borderRadius: '0',
                                                    background: '#3b82f6',
                                                    color: 'white',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    justifyContent: 'center',
                                                    fontSize: '10px',
                                                    fontWeight: '600'
                                                }}>
                                                    {(activity.loggedBy || 'S').charAt(0).toUpperCase()}
                                                </span>
                                                <div style={{ fontSize: '12px' }}>
                                                    <div style={{ fontWeight: '500', color: 'var(--text-primary)' }}>{activity.loggedBy || 'System'}</div>
                                                    {activity.loggedByRole && (
                                                        <div style={{ fontSize: '10px', color: 'var(--text-secondary)', textTransform: 'capitalize' }}>
                                                            {activity.loggedByRole}
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <span style={{
                                                padding: '4px 10px',
                                                borderRadius: '12px',
                                                fontSize: '11px',
                                                fontWeight: '600',
                                                textTransform: 'uppercase',
                                                background: activity.status === 'success' ? '#d1fae5' :
                                                           activity.status === 'pending' ? '#fef3c7' :
                                                           activity.status === 'error' ? '#fee2e2' :
                                                           '#f1f5f9',
                                                color: activity.status === 'success' ? '#059669' :
                                                       activity.status === 'pending' ? '#d97706' :
                                                       activity.status === 'error' ? '#dc2626' :
                                                       '#64748b'
                                            }}>
                                                {activity.status || 'done'}
                                            </span>
                                        </td>
                                    </tr>
                                ));
                            })()}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    );
}

// ==================== HR MODULE COMPONENT ====================
function HRModule() {
    const [isDark, setIsDark] = useState(document.documentElement.getAttribute('data-theme') === 'dark');
    const [activeTab, setActiveTab] = useState('overview');
    const [staffList, setStaffList] = useState([]);
    const [usersList, setUsersList] = useState([]);
    const [assignments, setAssignments] = useState([]);
    const [washHistory, setWashHistory] = useState([]);
    const [garageJobs, setGarageJobs] = useState([]);
    const [payments, setPayments] = useState([]);
    const [loading, setLoading] = useState(true);
    const [selectedStaff, setSelectedStaff] = useState(null);
    const [showPaymentModal, setShowPaymentModal] = useState(false);
    const [showViewPaymentModal, setShowViewPaymentModal] = useState(false);
    const [viewingPayment, setViewingPayment] = useState(null);
    const [showHistoryModal, setShowHistoryModal] = useState(false);
    const [showCommissionModal, setShowCommissionModal] = useState(false);
    const [showAddWorkModal, setShowAddWorkModal] = useState(false);
    const [showConfirmModal, setShowConfirmModal] = useState(false);
    const [confirmAction, setConfirmAction] = useState({ title: '', message: '', onConfirm: null });
    const [actionLoading, setActionLoading] = useState(false);
    const [successMessage, setSuccessMessage] = useState(null);
    const [error, setError] = useState(null);
    const [searchTerm, setSearchTerm] = useState('');
    const [filterPaymentType, setFilterPaymentType] = useState('all');
    const [dateRange, setDateRange] = useState({ start: '', end: '' });

    // Payment form
    const [paymentForm, setPaymentForm] = useState({
        amount: '',
        periodStart: '',
        periodEnd: '',
        deductions: '',
        paye: '',
        nhif: '',
        nssf: '',
        otherDeductions: '',
        notes: ''
    });

    // Commission settings form
    const [commissionForm, setCommissionForm] = useState({
        paymentType: 'monthly',
        salary: '',
        commissionRate: ''
    });

    // Work entry form
    const [workForm, setWorkForm] = useState({
        staffId: '',
        jobType: 'wash',
        vehiclePlate: '',
        customerName: '',
        serviceName: '',
        servicePrice: ''
    });

    const PAYMENT_TYPES = [
        { id: 'monthly', label: 'Monthly Salary', icon: 'üìÖ' },
        { id: 'weekly', label: 'Weekly Salary', icon: 'üìÜ' },
        { id: 'daily', label: 'Daily Rate', icon: 'üåÖ' },
        { id: 'commission', label: 'Commission Based', icon: 'üí∞' }
    ];

    const JOB_TYPES = [
        { id: 'wash', label: 'Car Wash', icon: 'üöó' },
        { id: 'detail', label: 'Detailing', icon: '‚ú®' },
        { id: 'garage', label: 'Garage Work', icon: 'üîß' },
        { id: 'other', label: 'Other', icon: 'üìã' }
    ];

    // Theme observer
    useEffect(() => {
        const observer = new MutationObserver(() => {
            setIsDark(document.documentElement.getAttribute('data-theme') === 'dark');
        });
        observer.observe(document.documentElement, { attributes: true, attributeFilter: ['data-theme'] });
        return () => observer.disconnect();
    }, []);

    // Load data
    useEffect(() => {
        const services = window.FirebaseServices;
        if (!services) return;

        let unsubStaff, unsubUsers, unsubAssignments, unsubPayments, unsubWashHistory, unsubGarageJobs;

        // Subscribe to staff
        if (services.staffService?.subscribeToAllStaff) {
            unsubStaff = services.staffService.subscribeToAllStaff((data) => {
                setStaffList(data.filter(s => s.status === 'active'));
            });
        }

        // Subscribe to users
        if (services.userService?.subscribeToUsers) {
            unsubUsers = services.userService.subscribeToUsers((data) => {
                setUsersList(data.filter(u => u.isActive));
            });
        }

        // Subscribe to manual HR assignments
        if (services.hrService?.subscribeToAssignments) {
            unsubAssignments = services.hrService.subscribeToAssignments((data) => {
                setAssignments(data);
            });
        }

        // Subscribe to wash history (completed washes from wash bays)
        if (services.washBayService?.subscribeToHistory) {
            unsubWashHistory = services.washBayService.subscribeToHistory((data) => {
                // Filter only completed washes with assigned staff
                const completedWashes = data.filter(w => w.action === 'completed' && w.vehicle?.assignedBy);
                setWashHistory(completedWashes);
            });
        }

        // Subscribe to garage jobs (completed ones)
        if (services.garageJobsService?.subscribeToJobs) {
            unsubGarageJobs = services.garageJobsService.subscribeToJobs((data) => {
                // Filter only completed jobs with assigned technician
                const completedJobs = data.filter(j => j.status === 'completed' && j.assignedTo);
                setGarageJobs(completedJobs);
            });
        }

        // Subscribe to payments
        if (services.hrService?.subscribeToPayments) {
            unsubPayments = services.hrService.subscribeToPayments((data) => {
                setPayments(data);
                setLoading(false);
            });
        } else {
            setLoading(false);
        }

        return () => {
            if (unsubStaff) unsubStaff();
            if (unsubUsers) unsubUsers();
            if (unsubAssignments) unsubAssignments();
            if (unsubPayments) unsubPayments();
            if (unsubWashHistory) unsubWashHistory();
            if (unsubGarageJobs) unsubGarageJobs();
        };
    }, []);

    // Combine all work history: manual assignments + wash history + garage jobs
    const getAllWorkHistory = useCallback(() => {
        const allWork = [];

        // Add manual HR assignments
        assignments.forEach(a => {
            allWork.push({
                id: a.id,
                type: 'manual',
                jobType: a.jobType || 'other',
                staffId: a.staffId,
                staffName: a.staffName,
                vehiclePlate: a.vehiclePlate || '',
                customerName: a.customerName || '',
                serviceName: a.serviceName || '',
                servicePrice: parseFloat(a.servicePrice) || 0,
                commissionRate: parseFloat(a.commissionRate) || 0,
                commissionAmount: parseFloat(a.commissionAmount) || 0,
                completedAt: a.completedAt || a.createdAt,
                source: 'manual'
            });
        });

        // Add wash history - match by staff name
        washHistory.forEach(w => {
            const staffName = w.vehicle?.assignedBy || '';
            const staff = staffList.find(s => s.name?.toLowerCase() === staffName.toLowerCase());
            const servicePrice = parseFloat(w.vehicle?.servicePrice) || parseFloat(w.vehicle?.service?.price) || 0;
            const commissionRate = staff?.commissionRate || 0;
            const commissionAmount = (servicePrice * commissionRate) / 100;

            allWork.push({
                id: w.id || `wash-${w.timestamp}`,
                type: 'wash',
                jobType: 'wash',
                staffId: staff?.id || '',
                staffName: staffName,
                vehiclePlate: w.vehicle?.plateNumber || '',
                customerName: w.vehicle?.customerName || '',
                serviceName: w.vehicle?.service?.name || w.vehicle?.service || 'Car Wash',
                servicePrice: servicePrice,
                commissionRate: commissionRate,
                commissionAmount: commissionAmount,
                completedAt: w.endTime || w.timestamp,
                bayName: w.bayName || '',
                duration: w.duration || 0,
                source: 'washbay'
            });
        });

        // Add garage jobs - match by assigned technician name
        garageJobs.forEach(j => {
            const staffName = j.assignedTo || '';
            const staff = staffList.find(s => s.name?.toLowerCase() === staffName.toLowerCase());
            const servicePrice = parseFloat(j.totalCost) || 0;
            const commissionRate = staff?.commissionRate || 0;
            const commissionAmount = (servicePrice * commissionRate) / 100;

            allWork.push({
                id: j.id,
                type: 'garage',
                jobType: 'garage',
                staffId: staff?.id || '',
                staffName: staffName,
                vehiclePlate: j.plateNumber || '',
                customerName: j.customerName || '',
                serviceName: j.services?.map(sId => typeof sId === 'object' ? sId.name : sId).join(', ') || 'Garage Work',
                servicePrice: servicePrice,
                commissionRate: commissionRate,
                commissionAmount: commissionAmount,
                completedAt: j.completedAt,
                source: 'garage'
            });
        });

        // Sort by completion date descending
        allWork.sort((a, b) => new Date(b.completedAt) - new Date(a.completedAt));

        return allWork;
    }, [assignments, washHistory, garageJobs, staffList]);

    // Get all work history
    const allWorkHistory = getAllWorkHistory();

    // Calculate staff stats from all sources
    const getStaffStats = (staffId, staffName) => {
        // Get work by staff ID or name match
        const staffWork = allWorkHistory.filter(w => 
            w.staffId === staffId || 
            w.staffName?.toLowerCase() === staffName?.toLowerCase()
        );
        const staffPayments = payments.filter(p => p.staffId === staffId);
        
        const totalJobs = staffWork.length;
        const totalCommission = staffWork.reduce((sum, w) => sum + (parseFloat(w.commissionAmount) || 0), 0);
        const totalPaid = staffPayments.reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
        
        return { 
            totalJobs, 
            totalCommission, 
            totalPaid, 
            pendingCommission: Math.max(0, totalCommission - totalPaid),
            workHistory: staffWork
        };
    };

    // Filter staff
    const filteredStaff = staffList.filter(staff => {
        const matchesSearch = !searchTerm || 
            staff.name?.toLowerCase().includes(searchTerm.toLowerCase()) ||
            staff.role?.toLowerCase().includes(searchTerm.toLowerCase());
        const matchesPaymentType = filterPaymentType === 'all' || staff.paymentType === filterPaymentType;
        return matchesSearch && matchesPaymentType;
    });

    // Handle commission settings update
    const handleUpdateCommission = async () => {
        if (!selectedStaff) return;
        setActionLoading(true);
        try {
            const services = window.FirebaseServices;
            await services.staffService.updateStaff(selectedStaff.id, {
                paymentType: commissionForm.paymentType,
                salary: parseFloat(commissionForm.salary) || 0,
                commissionRate: parseFloat(commissionForm.commissionRate) || 0
            });
            setSuccessMessage('Payment settings updated successfully');
            setShowCommissionModal(false);
            setTimeout(() => setSuccessMessage(null), 3000);
        } catch (err) {
            setError(err.message);
        } finally {
            setActionLoading(false);
        }
    };

    // Handle record payment
    const handleRecordPayment = async () => {
        if (!selectedStaff || !paymentForm.amount) return;
        setActionLoading(true);
        try {
            const services = window.FirebaseServices;
            const stats = getStaffStats(selectedStaff.id, selectedStaff.name);
            
            const grossAmount = parseFloat(paymentForm.amount) || 0;
            const paye = parseFloat(paymentForm.paye) || 0;
            const nhif = parseFloat(paymentForm.nhif) || 0;
            const nssf = parseFloat(paymentForm.nssf) || 0;
            const otherDeductions = parseFloat(paymentForm.otherDeductions) || 0;
            const totalDeductions = paye + nhif + nssf + otherDeductions;
            const netPay = grossAmount - totalDeductions;

            await services.hrService.recordPayment({
                staffId: selectedStaff.id,
                staffName: selectedStaff.name,
                paymentType: selectedStaff.paymentType || 'monthly',
                grossAmount: grossAmount,
                amount: netPay,
                periodStart: paymentForm.periodStart,
                periodEnd: paymentForm.periodEnd,
                jobsCount: stats.totalJobs,
                totalCommission: stats.totalCommission,
                baseSalary: selectedStaff.salary || 0,
                paye: paye,
                nhif: nhif,
                nssf: nssf,
                otherDeductions: otherDeductions,
                totalDeductions: totalDeductions,
                deductions: totalDeductions,
                notes: paymentForm.notes
            });
            
            setSuccessMessage('Payment recorded successfully');
            setShowPaymentModal(false);
            setPaymentForm({ amount: '', periodStart: '', periodEnd: '', deductions: '', paye: '', nhif: '', nssf: '', otherDeductions: '', notes: '' });
            setTimeout(() => setSuccessMessage(null), 3000);
        } catch (err) {
            setError(err.message);
        } finally {
            setActionLoading(false);
        }
    };

    // Show confirm modal
    const showConfirm = (title, message, onConfirm) => {
        setConfirmAction({ title, message, onConfirm });
        setShowConfirmModal(true);
    };

    // Execute confirmed action
    const executeConfirmedAction = async () => {
        if (confirmAction.onConfirm) {
            await confirmAction.onConfirm();
        }
        setShowConfirmModal(false);
        setConfirmAction({ title: '', message: '', onConfirm: null });
    };

    // Handle cancel/reverse payment
    const handleCancelPayment = (payment) => {
        showConfirm(
            'Cancel Payment',
            `Are you sure you want to cancel this payment of KES ${(payment.amount || 0).toLocaleString()} to ${payment.staffName}? This action cannot be undone.`,
            async () => {
                setActionLoading(true);
                try {
                    const services = window.FirebaseServices;
                    await services.hrService.updatePayment(payment.id, {
                        status: 'cancelled',
                        cancelledAt: new Date().toISOString(),
                        cancelledBy: 'Admin'
                    });
                    setSuccessMessage('Payment cancelled successfully');
                    setTimeout(() => setSuccessMessage(null), 3000);
                } catch (err) {
                    setError(err.message || 'Failed to cancel payment');
                } finally {
                    setActionLoading(false);
                }
            }
        );
    };

    // Handle mark payment as paid (for pending payments)
    const handleMarkAsPaid = async (payment) => {
        setActionLoading(true);
        try {
            const services = window.FirebaseServices;
            await services.hrService.updatePayment(payment.id, {
                status: 'paid',
                paidAt: new Date().toISOString()
            });
            setSuccessMessage('Payment marked as paid');
            setTimeout(() => setSuccessMessage(null), 3000);
        } catch (err) {
            setError(err.message || 'Failed to update payment');
        } finally {
            setActionLoading(false);
        }
    };

    // Handle add work entry
    const handleAddWork = async () => {
        if (!workForm.staffId || !workForm.serviceName) return;
        setActionLoading(true);
        try {
            const services = window.FirebaseServices;
            const staff = staffList.find(s => s.id === workForm.staffId);
            const servicePrice = parseFloat(workForm.servicePrice) || 0;
            const commissionRate = staff?.commissionRate || 0;
            const commissionAmount = (servicePrice * commissionRate) / 100;

            await services.hrService.assignStaffToJob({
                staffId: workForm.staffId,
                staffName: staff?.name || '',
                jobType: workForm.jobType,
                vehiclePlate: workForm.vehiclePlate,
                customerName: workForm.customerName,
                serviceName: workForm.serviceName,
                servicePrice: servicePrice,
                commissionRate: commissionRate,
                commissionAmount: commissionAmount
            });
            
            setSuccessMessage('Work entry added successfully');
            setShowAddWorkModal(false);
            setWorkForm({ staffId: '', jobType: 'wash', vehiclePlate: '', customerName: '', serviceName: '', servicePrice: '' });
            setTimeout(() => setSuccessMessage(null), 3000);
        } catch (err) {
            setError(err.message);
        } finally {
            setActionLoading(false);
        }
    };

    // Print payment receipt (Payslip)
    const handlePrintReceipt = (payment) => {
        const grossAmount = payment.grossAmount || payment.amount || 0;
        const paye = payment.paye || 0;
        const nhif = payment.nhif || 0;
        const nssf = payment.nssf || 0;
        const otherDeductions = payment.otherDeductions || 0;
        const totalDeductions = payment.totalDeductions || (paye + nhif + nssf + otherDeductions);
        const netPay = payment.amount || (grossAmount - totalDeductions);

        const receiptContent = `
            <html>
            <head>
                <title>Payslip - ${payment.staffName}</title>
                <style>
                    * { margin: 0; padding: 0; box-sizing: border-box; }
                    body { font-family: 'Segoe UI', Arial, sans-serif; padding: 30px; max-width: 500px; margin: 0 auto; color: #333; }
                    .payslip { border: 2px solid #1e3a5f; }
                    .header { background: #1e3a5f; color: white; padding: 20px; text-align: center; }
                    .logo { font-size: 22px; font-weight: bold; margin-bottom: 4px; }
                    .subtitle { font-size: 14px; opacity: 0.9; }
                    .payslip-title { background: #f8f9fa; padding: 12px; text-align: center; font-size: 16px; font-weight: 600; border-bottom: 1px solid #ddd; text-transform: uppercase; letter-spacing: 1px; }
                    .section { padding: 16px 20px; border-bottom: 1px solid #eee; }
                    .section-title { font-size: 11px; text-transform: uppercase; color: #666; font-weight: 600; margin-bottom: 10px; letter-spacing: 0.5px; }
                    .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
                    .info-item { display: flex; justify-content: space-between; padding: 4px 0; }
                    .info-item .label { color: #666; font-size: 13px; }
                    .info-item .value { font-weight: 600; font-size: 13px; }
                    .earnings-row, .deduction-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #eee; font-size: 13px; }
                    .earnings-row:last-child, .deduction-row:last-child { border-bottom: none; }
                    .earnings-row .amount { color: #16a34a; font-weight: 600; }
                    .deduction-row .amount { color: #dc2626; font-weight: 600; }
                    .subtotal { display: flex; justify-content: space-between; padding: 10px 0; font-weight: 600; border-top: 2px solid #ddd; margin-top: 8px; }
                    .subtotal.gross .amount { color: #16a34a; }
                    .subtotal.deduct .amount { color: #dc2626; }
                    .net-pay { background: #1e3a5f; color: white; padding: 16px 20px; display: flex; justify-content: space-between; align-items: center; }
                    .net-pay .label { font-size: 14px; text-transform: uppercase; letter-spacing: 1px; }
                    .net-pay .amount { font-size: 24px; font-weight: bold; }
                    .footer { padding: 16px 20px; text-align: center; font-size: 11px; color: #666; background: #f8f9fa; }
                    .footer p { margin: 4px 0; }
                    .signature-area { padding: 20px; display: flex; justify-content: space-between; }
                    .signature-box { width: 45%; }
                    .signature-line { border-top: 1px solid #333; margin-top: 40px; padding-top: 8px; font-size: 12px; color: #666; }
                    @media print { 
                        body { padding: 10px; } 
                        .payslip { border: 1px solid #333; }
                    }
                </style>
            </head>
            <body>
                <div class="payslip">
                    <div class="header">
                        <div class="logo">üöó ECOSPARK</div>
                        <div class="subtitle">Car Wash & Auto Services</div>
                    </div>
                    
                    <div class="payslip-title">Employee Payslip</div>
                    
                    <div class="section">
                        <div class="section-title">Employee Information</div>
                        <div class="info-grid">
                            <div class="info-item"><span class="label">Employee Name:</span></div>
                            <div class="info-item"><span class="value">${payment.staffName || 'N/A'}</span></div>
                            <div class="info-item"><span class="label">Payment Type:</span></div>
                            <div class="info-item"><span class="value" style="text-transform: capitalize;">${payment.paymentType || 'Salary'}</span></div>
                            <div class="info-item"><span class="label">Pay Period:</span></div>
                            <div class="info-item"><span class="value">${payment.periodStart ? new Date(payment.periodStart).toLocaleDateString('en-GB') : '-'} to ${payment.periodEnd ? new Date(payment.periodEnd).toLocaleDateString('en-GB') : '-'}</span></div>
                            <div class="info-item"><span class="label">Payment Date:</span></div>
                            <div class="info-item"><span class="value">${new Date(payment.paidAt || payment.createdAt).toLocaleDateString('en-GB')}</span></div>
                            <div class="info-item"><span class="label">Payslip No:</span></div>
                            <div class="info-item"><span class="value">#PS-${payment.id?.slice(-6).toUpperCase() || 'N/A'}</span></div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <div class="section-title">Earnings</div>
                        ${payment.baseSalary > 0 ? `<div class="earnings-row"><span>Base Salary</span><span class="amount">KES ${(payment.baseSalary || 0).toLocaleString()}</span></div>` : ''}
                        ${payment.totalCommission > 0 ? `<div class="earnings-row"><span>Commission (${payment.jobsCount || 0} jobs)</span><span class="amount">KES ${(payment.totalCommission || 0).toLocaleString()}</span></div>` : ''}
                        ${payment.baseSalary <= 0 && payment.totalCommission <= 0 ? `<div class="earnings-row"><span>Gross Pay</span><span class="amount">KES ${grossAmount.toLocaleString()}</span></div>` : ''}
                        <div class="subtotal gross">
                            <span>GROSS EARNINGS</span>
                            <span class="amount">KES ${grossAmount.toLocaleString()}</span>
                        </div>
                    </div>
                    
                    <div class="section">
                        <div class="section-title">Statutory Deductions</div>
                        ${paye > 0 ? `<div class="deduction-row"><span>P.A.Y.E (Tax)</span><span class="amount">- KES ${paye.toLocaleString()}</span></div>` : ''}
                        ${nhif > 0 ? `<div class="deduction-row"><span>NHIF</span><span class="amount">- KES ${nhif.toLocaleString()}</span></div>` : ''}
                        ${nssf > 0 ? `<div class="deduction-row"><span>NSSF</span><span class="amount">- KES ${nssf.toLocaleString()}</span></div>` : ''}
                        ${otherDeductions > 0 ? `<div class="deduction-row"><span>Other Deductions</span><span class="amount">- KES ${otherDeductions.toLocaleString()}</span></div>` : ''}
                        ${totalDeductions === 0 ? `<div class="deduction-row"><span>No deductions</span><span class="amount">KES 0</span></div>` : ''}
                        <div class="subtotal deduct">
                            <span>TOTAL DEDUCTIONS</span>
                            <span class="amount">- KES ${totalDeductions.toLocaleString()}</span>
                        </div>
                    </div>
                    
                    <div class="net-pay">
                        <span class="label">Net Pay</span>
                        <span class="amount">KES ${netPay.toLocaleString()}</span>
                    </div>
                    
                    <div class="signature-area">
                        <div class="signature-box">
                            <div class="signature-line">Employee Signature</div>
                        </div>
                        <div class="signature-box">
                            <div class="signature-line">Authorized Signature</div>
                        </div>
                    </div>
                    
                    <div class="footer">
                        <p><strong>EcoSpark Car Wash & Auto Services</strong></p>
                        <p>This is a computer-generated payslip. No signature required.</p>
                        <p>For queries, contact HR department.</p>
                    </div>
                </div>
            </body>
            </html>
        `;
        const printWindow = window.open('', '_blank');
        printWindow.document.write(receiptContent);
        printWindow.document.close();
        printWindow.print();
    };

    // Styles - Sharp edges for clean look
    const cardStyle = { background: isDark ? '#1e293b' : 'white', border: `1px solid ${isDark ? '#334155' : '#e2e8f0'}`, borderRadius: '0', padding: '20px' };
    const headerStyle = { fontSize: '14px', fontWeight: '600', color: isDark ? '#94a3b8' : '#64748b', marginBottom: '16px', textTransform: 'uppercase', letterSpacing: '0.5px' };
    const statCardStyle = { ...cardStyle, textAlign: 'center', padding: '24px' };
    const statValueStyle = { fontSize: '28px', fontWeight: '700', color: isDark ? '#f1f5f9' : '#1e293b' };
    const statLabelStyle = { fontSize: '13px', color: isDark ? '#94a3b8' : '#64748b', marginTop: '4px' };
    const btnPrimary = { background: '#3b82f6', color: 'white', border: 'none', padding: '10px 20px', borderRadius: '0', cursor: 'pointer', fontSize: '14px', fontWeight: '500' };
    const btnSecondary = { background: isDark ? '#334155' : '#e2e8f0', color: isDark ? '#f1f5f9' : '#1e293b', border: 'none', padding: '8px 16px', borderRadius: '0', cursor: 'pointer', fontSize: '13px' };
    const inputStyle = { width: '100%', padding: '10px 12px', border: `1px solid ${isDark ? '#334155' : '#e2e8f0'}`, borderRadius: '0', background: isDark ? '#0f172a' : 'white', color: isDark ? '#f1f5f9' : '#1e293b', fontSize: '14px', boxSizing: 'border-box' };
    const selectStyle = { ...inputStyle, cursor: 'pointer' };
    const labelStyle = { display: 'block', fontSize: '13px', fontWeight: '500', color: isDark ? '#94a3b8' : '#64748b', marginBottom: '6px' };
    const tableStyle = { width: '100%', borderCollapse: 'collapse' };
    const thStyle = { textAlign: 'left', padding: '12px', borderBottom: `2px solid ${isDark ? '#334155' : '#e2e8f0'}`, fontSize: '13px', fontWeight: '600', color: isDark ? '#94a3b8' : '#64748b' };
    const tdStyle = { padding: '12px', borderBottom: `1px solid ${isDark ? '#334155' : '#e2e8f0'}`, fontSize: '14px', color: isDark ? '#f1f5f9' : '#1e293b' };
    const modalOverlay = { position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.6)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 };
    const modalContent = { background: isDark ? '#1e293b' : 'white', borderRadius: '0', padding: '24px', width: '90%', maxWidth: '500px', maxHeight: '90vh', overflow: 'auto', boxShadow: '0 25px 50px -12px rgba(0,0,0,0.25)' };
    const tabStyle = (isActive) => ({ padding: '10px 20px', border: 'none', background: isActive ? (isDark ? '#3b82f6' : '#3b82f6') : 'transparent', color: isActive ? 'white' : (isDark ? '#94a3b8' : '#64748b'), cursor: 'pointer', borderRadius: '0', fontSize: '14px', fontWeight: '500' });

    // Stats calculations
    const totalStaff = staffList.length;
    const commissionStaff = staffList.filter(s => s.paymentType === 'commission').length;
    const totalJobsThisMonth = allWorkHistory.filter(w => new Date(w.completedAt).getMonth() === new Date().getMonth()).length;
    const totalPaymentsThisMonth = payments.filter(p => new Date(p.createdAt).getMonth() === new Date().getMonth()).reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
    const totalEarningsThisMonth = allWorkHistory.filter(w => new Date(w.completedAt).getMonth() === new Date().getMonth()).reduce((sum, w) => sum + (parseFloat(w.commissionAmount) || 0), 0);

    if (loading) {
        return (
            <div style={{ padding: '24px', textAlign: 'center' }}>
                <div style={{ fontSize: '24px', marginBottom: '16px' }}>‚è≥</div>
                <p style={{ color: isDark ? '#94a3b8' : '#64748b' }}>Loading HR data...</p>
            </div>
        );
    }

    return (
        <div style={{ padding: '24px' }}>
            {/* Success/Error Messages */}
            {successMessage && (
                <div style={{ background: '#10b981', color: 'white', padding: '12px 20px', borderRadius: '0', marginBottom: '20px', display: 'flex', alignItems: 'center', gap: '10px' }}>
                    <span>‚úì</span> {successMessage}
                </div>
            )}
            {error && (
                <div style={{ background: '#ef4444', color: 'white', padding: '12px 20px', borderRadius: '0', marginBottom: '20px', display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
                    <span>‚ö† {error}</span>
                    <button onClick={() => setError(null)} style={{ background: 'transparent', border: 'none', color: 'white', cursor: 'pointer' }}>‚úï</button>
                </div>
            )}

            {/* Tabs */}
            <div style={{ display: 'flex', gap: '8px', marginBottom: '24px', flexWrap: 'wrap' }}>
                <button style={tabStyle(activeTab === 'overview')} onClick={() => setActiveTab('overview')}>üìä Overview</button>
                <button style={tabStyle(activeTab === 'staff')} onClick={() => setActiveTab('staff')}>üë• Staff List</button>
                <button style={tabStyle(activeTab === 'work')} onClick={() => setActiveTab('work')}>üìã Work History</button>
                <button style={tabStyle(activeTab === 'payments')} onClick={() => setActiveTab('payments')}>üí∞ Payments</button>
            </div>

            {/* Overview Tab */}
            {activeTab === 'overview' && (
                <div>
                    {/* Stats Cards */}
                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '20px', marginBottom: '24px' }}>
                        <div style={statCardStyle}>
                            <div style={{ fontSize: '32px', marginBottom: '8px' }}>üë•</div>
                            <div style={statValueStyle}>{totalStaff}</div>
                            <div style={statLabelStyle}>Total Staff</div>
                        </div>
                        <div style={statCardStyle}>
                            <div style={{ fontSize: '32px', marginBottom: '8px' }}>üí∞</div>
                            <div style={statValueStyle}>{commissionStaff}</div>
                            <div style={statLabelStyle}>Commission Based</div>
                        </div>
                        <div style={statCardStyle}>
                            <div style={{ fontSize: '32px', marginBottom: '8px' }}>üöó</div>
                            <div style={statValueStyle}>{totalJobsThisMonth}</div>
                            <div style={statLabelStyle}>Jobs This Month</div>
                        </div>
                        <div style={statCardStyle}>
                            <div style={{ fontSize: '32px', marginBottom: '8px' }}>üíµ</div>
                            <div style={statValueStyle}>KES {totalPaymentsThisMonth.toLocaleString()}</div>
                            <div style={statLabelStyle}>Paid This Month</div>
                        </div>
                    </div>

                    {/* Quick Actions */}
                    <div style={cardStyle}>
                        <h3 style={headerStyle}>Quick Actions</h3>
                        <div style={{ display: 'flex', gap: '12px', flexWrap: 'wrap' }}>
                            <button style={btnPrimary} onClick={() => setShowAddWorkModal(true)}>‚ûï Add Work Entry</button>
                            <button style={btnSecondary} onClick={() => setActiveTab('staff')}>üë• View Staff</button>
                            <button style={btnSecondary} onClick={() => setActiveTab('payments')}>üí∞ View Payments</button>
                        </div>
                    </div>
                </div>
            )}

            {/* Staff List Tab */}
            {activeTab === 'staff' && (
                <div>
                    {/* Filters */}
                    <div style={{ ...cardStyle, marginBottom: '20px' }}>
                        <div style={{ display: 'flex', gap: '16px', flexWrap: 'wrap', alignItems: 'flex-end' }}>
                            <div style={{ flex: '1', minWidth: '200px' }}>
                                <label style={labelStyle}>Search Staff</label>
                                <input
                                    type="text"
                                    placeholder="Search by name or role..."
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                    style={inputStyle}
                                />
                            </div>
                            <div style={{ minWidth: '180px' }}>
                                <label style={labelStyle}>Payment Type</label>
                                <select value={filterPaymentType} onChange={(e) => setFilterPaymentType(e.target.value)} style={selectStyle}>
                                    <option value="all">All Types</option>
                                    {PAYMENT_TYPES.map(pt => (
                                        <option key={pt.id} value={pt.id}>{pt.label}</option>
                                    ))}
                                </select>
                            </div>
                        </div>
                    </div>

                    {/* Staff Table */}
                    <div style={cardStyle}>
                        <div style={{ overflowX: 'auto' }}>
                            <table style={tableStyle}>
                                <thead>
                                    <tr>
                                        <th style={thStyle}>Staff Name</th>
                                        <th style={thStyle}>Role</th>
                                        <th style={thStyle}>Payment Type</th>
                                        <th style={thStyle}>Rate/Salary</th>
                                        <th style={thStyle}>Jobs Done</th>
                                        <th style={thStyle}>Earnings</th>
                                        <th style={thStyle}>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {filteredStaff.length === 0 ? (
                                        <tr>
                                            <td colSpan="7" style={{ ...tdStyle, textAlign: 'center', padding: '40px' }}>
                                                <div style={{ fontSize: '24px', marginBottom: '8px' }}>üë•</div>
                                                <p style={{ color: isDark ? '#64748b' : '#94a3b8' }}>No staff found</p>
                                            </td>
                                        </tr>
                                    ) : filteredStaff.map(staff => {
                                        const stats = getStaffStats(staff.id, staff.name);
                                        const paymentType = PAYMENT_TYPES.find(pt => pt.id === staff.paymentType);
                                        return (
                                            <tr key={staff.id}>
                                                <td style={tdStyle}>
                                                    <div style={{ fontWeight: '600' }}>{staff.name}</div>
                                                    <div style={{ fontSize: '12px', color: isDark ? '#64748b' : '#94a3b8' }}>{staff.phone}</div>
                                                </td>
                                                <td style={tdStyle}>{staff.role}</td>
                                                <td style={tdStyle}>
                                                    <span style={{ display: 'inline-flex', alignItems: 'center', gap: '6px', background: isDark ? '#334155' : '#f1f5f9', padding: '4px 10px', borderRadius: '0', fontSize: '12px' }}>
                                                        {paymentType?.icon} {paymentType?.label || 'Not Set'}
                                                    </span>
                                                </td>
                                                <td style={tdStyle}>
                                                    {staff.paymentType === 'commission' 
                                                        ? `${staff.commissionRate || 0}%`
                                                        : `KES ${(staff.salary || 0).toLocaleString()}`
                                                    }
                                                </td>
                                                <td style={tdStyle}>{stats.totalJobs}</td>
                                                <td style={tdStyle}>
                                                    <div>KES {stats.totalCommission.toLocaleString()}</div>
                                                    {stats.pendingCommission > 0 && (
                                                        <div style={{ fontSize: '11px', color: '#f59e0b' }}>Pending: KES {stats.pendingCommission.toLocaleString()}</div>
                                                    )}
                                                </td>
                                                <td style={tdStyle}>
                                                    <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                                                        <button
                                                            style={{ ...btnSecondary, padding: '6px 12px', fontSize: '12px' }}
                                                            onClick={() => { setSelectedStaff(staff); setCommissionForm({ paymentType: staff.paymentType || 'monthly', salary: staff.salary || '', commissionRate: staff.commissionRate || '' }); setShowCommissionModal(true); }}
                                                        >‚öôÔ∏è Settings</button>
                                                        <button
                                                            style={{ ...btnSecondary, padding: '6px 12px', fontSize: '12px' }}
                                                            onClick={() => { setSelectedStaff(staff); setShowHistoryModal(true); }}
                                                        >üìã History</button>
                                                        <button
                                                            style={{ ...btnPrimary, padding: '6px 12px', fontSize: '12px' }}
                                                            onClick={() => { setSelectedStaff(staff); setPaymentForm({ amount: '', periodStart: '', periodEnd: '', deductions: '', paye: '', nhif: '', nssf: '', otherDeductions: '', notes: '' }); setShowPaymentModal(true); }}
                                                        >üíµ Pay</button>
                                                    </div>
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            )}

            {/* Work History Tab */}
            {activeTab === 'work' && (
                <div>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px', flexWrap: 'wrap', gap: '12px' }}>
                        <h3 style={{ ...headerStyle, margin: 0 }}>Work History <span style={{ fontSize: '12px', fontWeight: '400', color: isDark ? '#64748b' : '#94a3b8' }}>({allWorkHistory.length} jobs)</span></h3>
                        <button style={btnPrimary} onClick={() => setShowAddWorkModal(true)}>‚ûï Add Manual Entry</button>
                    </div>
                    <div style={cardStyle}>
                        <div style={{ overflowX: 'auto' }}>
                            <table style={tableStyle}>
                                <thead>
                                    <tr>
                                        <th style={thStyle}>Date</th>
                                        <th style={thStyle}>Staff</th>
                                        <th style={thStyle}>Source</th>
                                        <th style={thStyle}>Vehicle/Service</th>
                                        <th style={thStyle}>Customer</th>
                                        <th style={thStyle}>Price</th>
                                        <th style={thStyle}>Commission</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {allWorkHistory.length === 0 ? (
                                        <tr>
                                            <td colSpan="7" style={{ ...tdStyle, textAlign: 'center', padding: '40px' }}>
                                                <div style={{ fontSize: '24px', marginBottom: '8px' }}>üìã</div>
                                                <p style={{ color: isDark ? '#64748b' : '#94a3b8' }}>No work entries yet</p>
                                                <p style={{ fontSize: '12px', color: isDark ? '#64748b' : '#94a3b8', marginTop: '8px' }}>Complete jobs in Wash Bays or Garage to see them here</p>
                                            </td>
                                        </tr>
                                    ) : allWorkHistory.slice(0, 100).map(work => {
                                        const jobType = JOB_TYPES.find(jt => jt.id === work.jobType);
                                        const sourceLabel = work.source === 'washbay' ? 'üöø Wash Bay' : work.source === 'garage' ? 'üîß Garage' : 'üìù Manual';
                                        const sourceColor = work.source === 'washbay' ? '#3b82f6' : work.source === 'garage' ? '#f59e0b' : '#8b5cf6';
                                        return (
                                            <tr key={work.id}>
                                                <td style={tdStyle}>{new Date(work.completedAt).toLocaleDateString()}</td>
                                                <td style={tdStyle}>
                                                    <div style={{ fontWeight: '500' }}>{work.staffName || 'Unassigned'}</div>
                                                </td>
                                                <td style={tdStyle}>
                                                    <span style={{ display: 'inline-flex', alignItems: 'center', gap: '4px', background: isDark ? '#1e293b' : '#f8fafc', padding: '4px 8px', borderRadius: '0', fontSize: '11px', color: sourceColor, border: `1px solid ${sourceColor}30` }}>
                                                        {sourceLabel}
                                                    </span>
                                                </td>
                                                <td style={tdStyle}>
                                                    <div style={{ fontWeight: '500' }}>{work.vehiclePlate || '-'}</div>
                                                    <div style={{ fontSize: '12px', color: isDark ? '#64748b' : '#94a3b8' }}>{work.serviceName}</div>
                                                    {work.bayName && <div style={{ fontSize: '11px', color: isDark ? '#64748b' : '#94a3b8' }}>Bay: {work.bayName}</div>}
                                                </td>
                                                <td style={tdStyle}>{work.customerName || '-'}</td>
                                                <td style={tdStyle}>KES {(work.servicePrice || 0).toLocaleString()}</td>
                                                <td style={tdStyle}>
                                                    <span style={{ color: '#10b981', fontWeight: '600' }}>
                                                        KES {(work.commissionAmount || 0).toLocaleString()}
                                                    </span>
                                                    {work.commissionRate > 0 && (
                                                        <span style={{ fontSize: '11px', color: isDark ? '#64748b' : '#94a3b8', marginLeft: '4px' }}>
                                                            ({work.commissionRate}%)
                                                        </span>
                                                    )}
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            )}

            {/* Payments Tab */}
            {activeTab === 'payments' && (
                <div>
                    <h3 style={{ ...headerStyle, marginBottom: '20px' }}>Payment History</h3>
                    <div style={cardStyle}>
                        <div style={{ overflowX: 'auto' }}>
                            <table style={tableStyle}>
                                <thead>
                                    <tr>
                                        <th style={thStyle}>Date</th>
                                        <th style={thStyle}>Staff</th>
                                        <th style={thStyle}>Type</th>
                                        <th style={thStyle}>Period</th>
                                        <th style={thStyle}>Jobs</th>
                                        <th style={thStyle}>Amount</th>
                                        <th style={thStyle}>Status</th>
                                        <th style={thStyle}>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {payments.length === 0 ? (
                                        <tr>
                                            <td colSpan="8" style={{ ...tdStyle, textAlign: 'center', padding: '40px' }}>
                                                <div style={{ fontSize: '24px', marginBottom: '8px' }}>üí∞</div>
                                                <p style={{ color: isDark ? '#64748b' : '#94a3b8' }}>No payments recorded yet</p>
                                            </td>
                                        </tr>
                                    ) : payments.map(payment => (
                                        <tr key={payment.id}>
                                            <td style={tdStyle}>{new Date(payment.paidAt).toLocaleDateString()}</td>
                                            <td style={tdStyle}>{payment.staffName}</td>
                                            <td style={tdStyle}>
                                                <span style={{ textTransform: 'capitalize' }}>{payment.paymentType}</span>
                                            </td>
                                            <td style={tdStyle}>
                                                {payment.periodStart && payment.periodEnd 
                                                    ? `${new Date(payment.periodStart).toLocaleDateString()} - ${new Date(payment.periodEnd).toLocaleDateString()}`
                                                    : '-'
                                                }
                                            </td>
                                            <td style={tdStyle}>{payment.jobsCount || 0}</td>
                                            <td style={tdStyle}>
                                                <span style={{ fontWeight: '700', color: payment.status === 'cancelled' ? '#94a3b8' : '#10b981', textDecoration: payment.status === 'cancelled' ? 'line-through' : 'none' }}>KES {(payment.amount || 0).toLocaleString()}</span>
                                            </td>
                                            <td style={tdStyle}>
                                                <span style={{
                                                    display: 'inline-block',
                                                    padding: '4px 10px',
                                                    borderRadius: '0',
                                                    fontSize: '11px',
                                                    fontWeight: '600',
                                                    backgroundColor: payment.status === 'cancelled' ? '#fee2e2' : payment.status === 'pending' ? '#fef3c7' : '#dcfce7',
                                                    color: payment.status === 'cancelled' ? '#dc2626' : payment.status === 'pending' ? '#d97706' : '#16a34a'
                                                }}>
                                                    {payment.status === 'cancelled' ? '‚ùå Cancelled' : payment.status === 'pending' ? '‚è≥ Pending' : '‚úÖ Paid'}
                                                </span>
                                            </td>
                                            <td style={tdStyle}>
                                                <div style={{ display: 'flex', gap: '6px', flexWrap: 'wrap' }}>
                                                    <button
                                                        style={{ ...btnSecondary, padding: '5px 10px', fontSize: '11px' }}
                                                        onClick={() => { setViewingPayment(payment); setShowViewPaymentModal(true); }}
                                                    >üëÅÔ∏è View</button>
                                                    {payment.status !== 'cancelled' && (
                                                        <button
                                                            style={{ ...btnSecondary, padding: '5px 10px', fontSize: '11px' }}
                                                            onClick={() => handlePrintReceipt(payment)}
                                                        >üñ®Ô∏è Print</button>
                                                    )}
                                                    {payment.status === 'pending' && (
                                                        <button
                                                            style={{ ...btnSecondary, padding: '5px 10px', fontSize: '11px', background: '#dcfce7', color: '#16a34a' }}
                                                            onClick={() => handleMarkAsPaid(payment)}
                                                            disabled={actionLoading}
                                                        >‚úì Mark Paid</button>
                                                    )}
                                                    {payment.status !== 'cancelled' && (
                                                        <button
                                                            style={{ ...btnSecondary, padding: '5px 10px', fontSize: '11px', background: '#fee2e2', color: '#dc2626' }}
                                                            onClick={() => handleCancelPayment(payment)}
                                                            disabled={actionLoading}
                                                        >‚úï Cancel</button>
                                                    )}
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            )}

            {/* Commission Settings Modal */}
            {showCommissionModal && selectedStaff && (
                <div style={modalOverlay} onClick={() => setShowCommissionModal(false)}>
                    <div style={modalContent} onClick={e => e.stopPropagation()}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px' }}>
                            <h2 style={{ margin: 0, fontSize: '18px', color: isDark ? '#f1f5f9' : '#1e293b' }}>‚öôÔ∏è Payment Settings - {selectedStaff.name}</h2>
                            <button onClick={() => setShowCommissionModal(false)} style={{ background: 'transparent', border: 'none', fontSize: '20px', cursor: 'pointer', color: isDark ? '#94a3b8' : '#64748b' }}>‚úï</button>
                        </div>
                        
                        <div style={{ marginBottom: '20px' }}>
                            <label style={labelStyle}>Payment Type</label>
                            <select value={commissionForm.paymentType} onChange={(e) => setCommissionForm({...commissionForm, paymentType: e.target.value})} style={selectStyle}>
                                {PAYMENT_TYPES.map(pt => (
                                    <option key={pt.id} value={pt.id}>{pt.icon} {pt.label}</option>
                                ))}
                            </select>
                        </div>

                        {commissionForm.paymentType !== 'commission' && (
                            <div style={{ marginBottom: '20px' }}>
                                <label style={labelStyle}>Salary Amount (KES)</label>
                                <input
                                    type="number"
                                    value={commissionForm.salary}
                                    onChange={(e) => setCommissionForm({...commissionForm, salary: e.target.value})}
                                    placeholder="Enter salary amount"
                                    style={inputStyle}
                                />
                            </div>
                        )}

                        {commissionForm.paymentType === 'commission' && (
                            <div style={{ marginBottom: '20px' }}>
                                <label style={labelStyle}>Commission Rate (%)</label>
                                <input
                                    type="number"
                                    value={commissionForm.commissionRate}
                                    onChange={(e) => setCommissionForm({...commissionForm, commissionRate: e.target.value})}
                                    placeholder="e.g. 10 for 10%"
                                    style={inputStyle}
                                    min="0"
                                    max="100"
                                />
                                <p style={{ fontSize: '12px', color: isDark ? '#64748b' : '#94a3b8', marginTop: '6px' }}>
                                    This percentage will be calculated from each job's service price.
                                </p>
                            </div>
                        )}

                        <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end' }}>
                            <button style={btnSecondary} onClick={() => setShowCommissionModal(false)}>Cancel</button>
                            <button style={btnPrimary} onClick={handleUpdateCommission} disabled={actionLoading}>
                                {actionLoading ? 'Saving...' : 'Save Settings'}
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* Record Payment Modal */}
            {showPaymentModal && selectedStaff && (
                <div style={modalOverlay} onClick={() => setShowPaymentModal(false)}>
                    <div style={modalContent} onClick={e => e.stopPropagation()}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px' }}>
                            <h2 style={{ margin: 0, fontSize: '18px', color: isDark ? '#f1f5f9' : '#1e293b' }}>üíµ Record Payment - {selectedStaff.name}</h2>
                            <button onClick={() => setShowPaymentModal(false)} style={{ background: 'transparent', border: 'none', fontSize: '20px', cursor: 'pointer', color: isDark ? '#94a3b8' : '#64748b' }}>‚úï</button>
                        </div>

                        {/* Staff Summary */}
                        <div style={{ background: isDark ? '#0f172a' : '#f8fafc', padding: '16px', borderRadius: '0', marginBottom: '20px' }}>
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px', fontSize: '13px' }}>
                                <div><span style={{ color: isDark ? '#64748b' : '#94a3b8' }}>Payment Type:</span> <strong>{selectedStaff.paymentType || 'Not Set'}</strong></div>
                                <div><span style={{ color: isDark ? '#64748b' : '#94a3b8' }}>Jobs Done:</span> <strong>{getStaffStats(selectedStaff.id, selectedStaff.name).totalJobs}</strong></div>
                                <div><span style={{ color: isDark ? '#64748b' : '#94a3b8' }}>Total Earnings:</span> <strong>KES {getStaffStats(selectedStaff.id, selectedStaff.name).totalCommission.toLocaleString()}</strong></div>
                                <div><span style={{ color: isDark ? '#64748b' : '#94a3b8' }}>Pending:</span> <strong style={{ color: '#f59e0b' }}>KES {getStaffStats(selectedStaff.id, selectedStaff.name).pendingCommission.toLocaleString()}</strong></div>
                            </div>
                        </div>

                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px', marginBottom: '20px' }}>
                            <div>
                                <label style={labelStyle}>Period Start</label>
                                <input type="date" value={paymentForm.periodStart} onChange={(e) => setPaymentForm({...paymentForm, periodStart: e.target.value})} style={inputStyle} />
                            </div>
                            <div>
                                <label style={labelStyle}>Period End</label>
                                <input type="date" value={paymentForm.periodEnd} onChange={(e) => setPaymentForm({...paymentForm, periodEnd: e.target.value})} style={inputStyle} />
                            </div>
                        </div>

                        <div style={{ marginBottom: '20px' }}>
                            <label style={labelStyle}>Gross Payment Amount (KES) *</label>
                            <input
                                type="number"
                                value={paymentForm.amount}
                                onChange={(e) => setPaymentForm({...paymentForm, amount: e.target.value})}
                                placeholder="Enter gross amount"
                                style={inputStyle}
                                required
                            />
                        </div>

                        {/* Statutory Deductions Section */}
                        <div style={{ background: isDark ? '#0f172a' : '#fef2f2', padding: '16px', borderRadius: '0', marginBottom: '20px' }}>
                            <div style={{ fontSize: '13px', fontWeight: '600', color: '#dc2626', marginBottom: '12px' }}>üìâ Statutory Deductions</div>
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' }}>
                                <div>
                                    <label style={{ ...labelStyle, fontSize: '12px' }}>P.A.Y.E (Tax)</label>
                                    <input
                                        type="number"
                                        value={paymentForm.paye}
                                        onChange={(e) => setPaymentForm({...paymentForm, paye: e.target.value})}
                                        placeholder="0"
                                        style={{ ...inputStyle, padding: '8px 10px' }}
                                    />
                                </div>
                                <div>
                                    <label style={{ ...labelStyle, fontSize: '12px' }}>NHIF</label>
                                    <input
                                        type="number"
                                        value={paymentForm.nhif}
                                        onChange={(e) => setPaymentForm({...paymentForm, nhif: e.target.value})}
                                        placeholder="0"
                                        style={{ ...inputStyle, padding: '8px 10px' }}
                                    />
                                </div>
                                <div>
                                    <label style={{ ...labelStyle, fontSize: '12px' }}>NSSF</label>
                                    <input
                                        type="number"
                                        value={paymentForm.nssf}
                                        onChange={(e) => setPaymentForm({...paymentForm, nssf: e.target.value})}
                                        placeholder="0"
                                        style={{ ...inputStyle, padding: '8px 10px' }}
                                    />
                                </div>
                                <div>
                                    <label style={{ ...labelStyle, fontSize: '12px' }}>Other Deductions</label>
                                    <input
                                        type="number"
                                        value={paymentForm.otherDeductions}
                                        onChange={(e) => setPaymentForm({...paymentForm, otherDeductions: e.target.value})}
                                        placeholder="0"
                                        style={{ ...inputStyle, padding: '8px 10px' }}
                                    />
                                </div>
                            </div>
                        </div>

                        {/* Net Pay Calculation Display */}
                        {paymentForm.amount && (
                            <div style={{ background: isDark ? '#0f172a' : '#f0fdf4', padding: '16px', borderRadius: '0', marginBottom: '20px' }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '8px', fontSize: '13px' }}>
                                    <span style={{ color: isDark ? '#94a3b8' : '#64748b' }}>Gross Amount:</span>
                                    <span style={{ fontWeight: '600', color: '#16a34a' }}>KES {parseFloat(paymentForm.amount || 0).toLocaleString()}</span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '8px', fontSize: '13px' }}>
                                    <span style={{ color: isDark ? '#94a3b8' : '#64748b' }}>Total Deductions:</span>
                                    <span style={{ fontWeight: '600', color: '#dc2626' }}>- KES {(
                                        (parseFloat(paymentForm.paye) || 0) + 
                                        (parseFloat(paymentForm.nhif) || 0) + 
                                        (parseFloat(paymentForm.nssf) || 0) + 
                                        (parseFloat(paymentForm.otherDeductions) || 0)
                                    ).toLocaleString()}</span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', paddingTop: '8px', borderTop: `2px solid ${isDark ? '#334155' : '#d1fae5'}`, fontSize: '15px' }}>
                                    <span style={{ fontWeight: '700', color: isDark ? '#f1f5f9' : '#1e293b' }}>NET PAY:</span>
                                    <span style={{ fontWeight: '700', color: '#059669', fontSize: '18px' }}>KES {(
                                        (parseFloat(paymentForm.amount) || 0) - 
                                        (parseFloat(paymentForm.paye) || 0) - 
                                        (parseFloat(paymentForm.nhif) || 0) - 
                                        (parseFloat(paymentForm.nssf) || 0) - 
                                        (parseFloat(paymentForm.otherDeductions) || 0)
                                    ).toLocaleString()}</span>
                                </div>
                            </div>
                        )}

                        <div style={{ marginBottom: '20px' }}>
                            <label style={labelStyle}>Notes</label>
                            <textarea
                                value={paymentForm.notes}
                                onChange={(e) => setPaymentForm({...paymentForm, notes: e.target.value})}
                                placeholder="Payment notes..."
                                style={{ ...inputStyle, minHeight: '80px', resize: 'vertical' }}
                            />
                        </div>

                        <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end' }}>
                            <button style={btnSecondary} onClick={() => setShowPaymentModal(false)}>Cancel</button>
                            <button style={btnPrimary} onClick={handleRecordPayment} disabled={actionLoading || !paymentForm.amount}>
                                {actionLoading ? 'Processing...' : 'Record Payment'}
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* View Payment Details Modal */}
            {showViewPaymentModal && viewingPayment && (
                <div style={modalOverlay} onClick={() => setShowViewPaymentModal(false)}>
                    <div style={{ ...modalContent, maxWidth: '550px' }} onClick={e => e.stopPropagation()}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px' }}>
                            <h2 style={{ margin: 0, fontSize: '18px', color: isDark ? '#f1f5f9' : '#1e293b' }}>üíµ Payment Details</h2>
                            <button onClick={() => setShowViewPaymentModal(false)} style={{ background: 'transparent', border: 'none', fontSize: '20px', cursor: 'pointer', color: isDark ? '#94a3b8' : '#64748b' }}>‚úï</button>
                        </div>

                        {/* Payment Header */}
                        <div style={{ background: isDark ? '#0f172a' : '#f0fdf4', padding: '16px', borderRadius: '0', marginBottom: '20px', textAlign: 'center' }}>
                            <div style={{ fontSize: '12px', color: isDark ? '#64748b' : '#94a3b8', marginBottom: '4px' }}>Payslip No.</div>
                            <div style={{ fontSize: '16px', fontWeight: '700', color: isDark ? '#f1f5f9' : '#1e293b' }}>#PS-{viewingPayment.id?.slice(-6).toUpperCase() || 'N/A'}</div>
                        </div>

                        {/* Employee & Period Info */}
                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px', marginBottom: '20px' }}>
                            <div style={{ background: isDark ? '#0f172a' : '#f8fafc', padding: '12px', borderRadius: '0' }}>
                                <div style={{ fontSize: '11px', color: isDark ? '#64748b' : '#94a3b8', marginBottom: '4px', textTransform: 'uppercase' }}>Employee</div>
                                <div style={{ fontSize: '14px', fontWeight: '600', color: isDark ? '#f1f5f9' : '#1e293b' }}>{viewingPayment.staffName}</div>
                            </div>
                            <div style={{ background: isDark ? '#0f172a' : '#f8fafc', padding: '12px', borderRadius: '0' }}>
                                <div style={{ fontSize: '11px', color: isDark ? '#64748b' : '#94a3b8', marginBottom: '4px', textTransform: 'uppercase' }}>Payment Type</div>
                                <div style={{ fontSize: '14px', fontWeight: '600', color: isDark ? '#f1f5f9' : '#1e293b', textTransform: 'capitalize' }}>{viewingPayment.paymentType || 'Salary'}</div>
                            </div>
                            <div style={{ background: isDark ? '#0f172a' : '#f8fafc', padding: '12px', borderRadius: '0' }}>
                                <div style={{ fontSize: '11px', color: isDark ? '#64748b' : '#94a3b8', marginBottom: '4px', textTransform: 'uppercase' }}>Pay Period</div>
                                <div style={{ fontSize: '13px', fontWeight: '500', color: isDark ? '#f1f5f9' : '#1e293b' }}>
                                    {viewingPayment.periodStart ? new Date(viewingPayment.periodStart).toLocaleDateString('en-GB') : '-'} to {viewingPayment.periodEnd ? new Date(viewingPayment.periodEnd).toLocaleDateString('en-GB') : '-'}
                                </div>
                            </div>
                            <div style={{ background: isDark ? '#0f172a' : '#f8fafc', padding: '12px', borderRadius: '0' }}>
                                <div style={{ fontSize: '11px', color: isDark ? '#64748b' : '#94a3b8', marginBottom: '4px', textTransform: 'uppercase' }}>Payment Date</div>
                                <div style={{ fontSize: '13px', fontWeight: '500', color: isDark ? '#f1f5f9' : '#1e293b' }}>
                                    {new Date(viewingPayment.paidAt || viewingPayment.createdAt).toLocaleDateString('en-GB')}
                                </div>
                            </div>
                        </div>

                        {/* Earnings Section */}
                        <div style={{ marginBottom: '16px' }}>
                            <div style={{ fontSize: '12px', fontWeight: '600', color: '#16a34a', marginBottom: '8px', textTransform: 'uppercase' }}>üìà Earnings</div>
                            <div style={{ background: isDark ? '#0f172a' : '#f8fafc', borderRadius: '0', overflow: 'hidden' }}>
                                {viewingPayment.baseSalary > 0 && (
                                    <div style={{ display: 'flex', justifyContent: 'space-between', padding: '10px 12px', borderBottom: `1px solid ${isDark ? '#334155' : '#e2e8f0'}` }}>
                                        <span style={{ fontSize: '13px', color: isDark ? '#94a3b8' : '#64748b' }}>Base Salary</span>
                                        <span style={{ fontSize: '13px', fontWeight: '600', color: '#16a34a' }}>KES {(viewingPayment.baseSalary || 0).toLocaleString()}</span>
                                    </div>
                                )}
                                {viewingPayment.totalCommission > 0 && (
                                    <div style={{ display: 'flex', justifyContent: 'space-between', padding: '10px 12px', borderBottom: `1px solid ${isDark ? '#334155' : '#e2e8f0'}` }}>
                                        <span style={{ fontSize: '13px', color: isDark ? '#94a3b8' : '#64748b' }}>Commission ({viewingPayment.jobsCount || 0} jobs)</span>
                                        <span style={{ fontSize: '13px', fontWeight: '600', color: '#16a34a' }}>KES {(viewingPayment.totalCommission || 0).toLocaleString()}</span>
                                    </div>
                                )}
                                <div style={{ display: 'flex', justifyContent: 'space-between', padding: '12px', background: isDark ? '#1e3a5f20' : '#dcfce7' }}>
                                    <span style={{ fontSize: '13px', fontWeight: '700', color: isDark ? '#f1f5f9' : '#1e293b' }}>GROSS EARNINGS</span>
                                    <span style={{ fontSize: '14px', fontWeight: '700', color: '#16a34a' }}>KES {(viewingPayment.grossAmount || viewingPayment.amount || 0).toLocaleString()}</span>
                                </div>
                            </div>
                        </div>

                        {/* Deductions Section */}
                        <div style={{ marginBottom: '16px' }}>
                            <div style={{ fontSize: '12px', fontWeight: '600', color: '#dc2626', marginBottom: '8px', textTransform: 'uppercase' }}>üìâ Deductions</div>
                            <div style={{ background: isDark ? '#0f172a' : '#f8fafc', borderRadius: '0', overflow: 'hidden' }}>
                                {(viewingPayment.paye > 0) && (
                                    <div style={{ display: 'flex', justifyContent: 'space-between', padding: '10px 12px', borderBottom: `1px solid ${isDark ? '#334155' : '#e2e8f0'}` }}>
                                        <span style={{ fontSize: '13px', color: isDark ? '#94a3b8' : '#64748b' }}>P.A.Y.E (Tax)</span>
                                        <span style={{ fontSize: '13px', fontWeight: '600', color: '#dc2626' }}>- KES {(viewingPayment.paye || 0).toLocaleString()}</span>
                                    </div>
                                )}
                                {(viewingPayment.nhif > 0) && (
                                    <div style={{ display: 'flex', justifyContent: 'space-between', padding: '10px 12px', borderBottom: `1px solid ${isDark ? '#334155' : '#e2e8f0'}` }}>
                                        <span style={{ fontSize: '13px', color: isDark ? '#94a3b8' : '#64748b' }}>NHIF</span>
                                        <span style={{ fontSize: '13px', fontWeight: '600', color: '#dc2626' }}>- KES {(viewingPayment.nhif || 0).toLocaleString()}</span>
                                    </div>
                                )}
                                {(viewingPayment.nssf > 0) && (
                                    <div style={{ display: 'flex', justifyContent: 'space-between', padding: '10px 12px', borderBottom: `1px solid ${isDark ? '#334155' : '#e2e8f0'}` }}>
                                        <span style={{ fontSize: '13px', color: isDark ? '#94a3b8' : '#64748b' }}>NSSF</span>
                                        <span style={{ fontSize: '13px', fontWeight: '600', color: '#dc2626' }}>- KES {(viewingPayment.nssf || 0).toLocaleString()}</span>
                                    </div>
                                )}
                                {(viewingPayment.otherDeductions > 0) && (
                                    <div style={{ display: 'flex', justifyContent: 'space-between', padding: '10px 12px', borderBottom: `1px solid ${isDark ? '#334155' : '#e2e8f0'}` }}>
                                        <span style={{ fontSize: '13px', color: isDark ? '#94a3b8' : '#64748b' }}>Other Deductions</span>
                                        <span style={{ fontSize: '13px', fontWeight: '600', color: '#dc2626' }}>- KES {(viewingPayment.otherDeductions || 0).toLocaleString()}</span>
                                    </div>
                                )}
                                {(!viewingPayment.paye && !viewingPayment.nhif && !viewingPayment.nssf && !viewingPayment.otherDeductions && (viewingPayment.totalDeductions || 0) === 0) && (
                                    <div style={{ display: 'flex', justifyContent: 'space-between', padding: '10px 12px', borderBottom: `1px solid ${isDark ? '#334155' : '#e2e8f0'}` }}>
                                        <span style={{ fontSize: '13px', color: isDark ? '#94a3b8' : '#64748b' }}>No deductions</span>
                                        <span style={{ fontSize: '13px', fontWeight: '600', color: isDark ? '#94a3b8' : '#64748b' }}>KES 0</span>
                                    </div>
                                )}
                                <div style={{ display: 'flex', justifyContent: 'space-between', padding: '12px', background: isDark ? '#7f1d1d20' : '#fee2e2' }}>
                                    <span style={{ fontSize: '13px', fontWeight: '700', color: isDark ? '#f1f5f9' : '#1e293b' }}>TOTAL DEDUCTIONS</span>
                                    <span style={{ fontSize: '14px', fontWeight: '700', color: '#dc2626' }}>- KES {(viewingPayment.totalDeductions || 0).toLocaleString()}</span>
                                </div>
                            </div>
                        </div>

                        {/* Net Pay */}
                        <div style={{ background: '#1e3a5f', padding: '16px', borderRadius: '0', marginBottom: '20px', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <span style={{ fontSize: '14px', fontWeight: '700', color: 'white', textTransform: 'uppercase', letterSpacing: '1px' }}>NET PAY</span>
                            <span style={{ fontSize: '24px', fontWeight: '700', color: 'white' }}>KES {(viewingPayment.amount || 0).toLocaleString()}</span>
                        </div>

                        {/* Notes */}
                        {viewingPayment.notes && (
                            <div style={{ marginBottom: '20px' }}>
                                <div style={{ fontSize: '12px', fontWeight: '600', color: isDark ? '#94a3b8' : '#64748b', marginBottom: '6px' }}>Notes</div>
                                <div style={{ background: isDark ? '#0f172a' : '#f8fafc', padding: '12px', borderRadius: '0', fontSize: '13px', color: isDark ? '#f1f5f9' : '#1e293b' }}>
                                    {viewingPayment.notes}
                                </div>
                            </div>
                        )}

                        {/* Actions */}
                        <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end' }}>
                            <button style={btnSecondary} onClick={() => setShowViewPaymentModal(false)}>Close</button>
                            <button style={btnPrimary} onClick={() => { handlePrintReceipt(viewingPayment); }}>
                                üñ®Ô∏è Print Payslip
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* Staff History Modal */}
            {showHistoryModal && selectedStaff && (
                <div style={modalOverlay} onClick={() => setShowHistoryModal(false)}>
                    <div style={{ ...modalContent, maxWidth: '700px' }} onClick={e => e.stopPropagation()}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px' }}>
                            <h2 style={{ margin: 0, fontSize: '18px', color: isDark ? '#f1f5f9' : '#1e293b' }}>üìã Work History - {selectedStaff.name}</h2>
                            <button onClick={() => setShowHistoryModal(false)} style={{ background: 'transparent', border: 'none', fontSize: '20px', cursor: 'pointer', color: isDark ? '#94a3b8' : '#64748b' }}>‚úï</button>
                        </div>

                        {/* Stats Summary */}
                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '12px', marginBottom: '20px' }}>
                            <div style={{ background: isDark ? '#0f172a' : '#f0f9ff', padding: '16px', borderRadius: '0', textAlign: 'center' }}>
                                <div style={{ fontSize: '24px', fontWeight: '700', color: '#3b82f6' }}>{getStaffStats(selectedStaff.id, selectedStaff.name).totalJobs}</div>
                                <div style={{ fontSize: '12px', color: isDark ? '#64748b' : '#94a3b8' }}>Total Jobs</div>
                            </div>
                            <div style={{ background: isDark ? '#0f172a' : '#f0fdf4', padding: '16px', borderRadius: '0', textAlign: 'center' }}>
                                <div style={{ fontSize: '24px', fontWeight: '700', color: '#10b981' }}>KES {getStaffStats(selectedStaff.id, selectedStaff.name).totalCommission.toLocaleString()}</div>
                                <div style={{ fontSize: '12px', color: isDark ? '#64748b' : '#94a3b8' }}>Total Earnings</div>
                            </div>
                            <div style={{ background: isDark ? '#0f172a' : '#fffbeb', padding: '16px', borderRadius: '0', textAlign: 'center' }}>
                                <div style={{ fontSize: '24px', fontWeight: '700', color: '#f59e0b' }}>KES {getStaffStats(selectedStaff.id, selectedStaff.name).pendingCommission.toLocaleString()}</div>
                                <div style={{ fontSize: '12px', color: isDark ? '#64748b' : '#94a3b8' }}>Pending</div>
                            </div>
                        </div>

                        {/* Work List */}
                        <div style={{ maxHeight: '400px', overflowY: 'auto' }}>
                            <table style={tableStyle}>
                                <thead>
                                    <tr>
                                        <th style={thStyle}>Date</th>
                                        <th style={thStyle}>Source</th>
                                        <th style={thStyle}>Service</th>
                                        <th style={thStyle}>Vehicle</th>
                                        <th style={thStyle}>Price</th>
                                        <th style={thStyle}>Commission</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {getStaffStats(selectedStaff.id, selectedStaff.name).workHistory.length === 0 ? (
                                        <tr>
                                            <td colSpan="6" style={{ ...tdStyle, textAlign: 'center', padding: '30px' }}>
                                                <p>No work history found</p>
                                                <p style={{ fontSize: '12px', color: isDark ? '#64748b' : '#94a3b8' }}>Jobs will appear here when {selectedStaff.name} completes work in Wash Bays or Garage</p>
                                            </td>
                                        </tr>
                                    ) : getStaffStats(selectedStaff.id, selectedStaff.name).workHistory.map(w => {
                                        const sourceLabel = w.source === 'washbay' ? 'üöø Wash' : w.source === 'garage' ? 'üîß Garage' : 'üìù Manual';
                                        return (
                                            <tr key={w.id}>
                                                <td style={tdStyle}>{new Date(w.completedAt).toLocaleDateString()}</td>
                                                <td style={tdStyle}><span style={{ fontSize: '12px' }}>{sourceLabel}</span></td>
                                                <td style={tdStyle}>{w.serviceName}</td>
                                                <td style={tdStyle}>
                                                    <span style={{ fontWeight: '600', color: isDark ? '#f1f5f9' : '#1e293b', background: isDark ? '#334155' : '#f1f5f9', padding: '2px 8px', fontSize: '12px' }}>
                                                        {w.vehiclePlate || '-'}
                                                    </span>
                                                </td>
                                                <td style={tdStyle}>KES {(w.servicePrice || 0).toLocaleString()}</td>
                                                <td style={tdStyle}>
                                                    <span style={{ color: '#10b981', fontWeight: '600' }}>KES {(w.commissionAmount || 0).toLocaleString()}</span>
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>

                        <div style={{ display: 'flex', justifyContent: 'flex-end', marginTop: '20px' }}>
                            <button style={btnSecondary} onClick={() => setShowHistoryModal(false)}>Close</button>
                        </div>
                    </div>
                </div>
            )}

            {/* Add Work Entry Modal */}
            {showAddWorkModal && (
                <div style={modalOverlay} onClick={() => setShowAddWorkModal(false)}>
                    <div style={modalContent} onClick={e => e.stopPropagation()}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px' }}>
                            <h2 style={{ margin: 0, fontSize: '18px', color: isDark ? '#f1f5f9' : '#1e293b' }}>‚ûï Add Work Entry</h2>
                            <button onClick={() => setShowAddWorkModal(false)} style={{ background: 'transparent', border: 'none', fontSize: '20px', cursor: 'pointer', color: isDark ? '#94a3b8' : '#64748b' }}>‚úï</button>
                        </div>

                        <div style={{ marginBottom: '20px' }}>
                            <label style={labelStyle}>Staff Member *</label>
                            <select value={workForm.staffId} onChange={(e) => setWorkForm({...workForm, staffId: e.target.value})} style={selectStyle} required>
                                <option value="">Select staff...</option>
                                {staffList.map(staff => (
                                    <option key={staff.id} value={staff.id}>{staff.name} ({staff.role})</option>
                                ))}
                            </select>
                        </div>

                        <div style={{ marginBottom: '20px' }}>
                            <label style={labelStyle}>Job Type</label>
                            <select value={workForm.jobType} onChange={(e) => setWorkForm({...workForm, jobType: e.target.value})} style={selectStyle}>
                                {JOB_TYPES.map(jt => (
                                    <option key={jt.id} value={jt.id}>{jt.icon} {jt.label}</option>
                                ))}
                            </select>
                        </div>

                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px', marginBottom: '20px' }}>
                            <div>
                                <label style={labelStyle}>Vehicle Plate</label>
                                <input
                                    type="text"
                                    value={workForm.vehiclePlate}
                                    onChange={(e) => setWorkForm({...workForm, vehiclePlate: e.target.value.toUpperCase()})}
                                    placeholder="e.g. KAA 123X"
                                    style={inputStyle}
                                />
                            </div>
                            <div>
                                <label style={labelStyle}>Customer Name</label>
                                <input
                                    type="text"
                                    value={workForm.customerName}
                                    onChange={(e) => setWorkForm({...workForm, customerName: e.target.value})}
                                    placeholder="Customer name"
                                    style={inputStyle}
                                />
                            </div>
                        </div>

                        <div style={{ marginBottom: '20px' }}>
                            <label style={labelStyle}>Service/Work Description *</label>
                            <input
                                type="text"
                                value={workForm.serviceName}
                                onChange={(e) => setWorkForm({...workForm, serviceName: e.target.value})}
                                placeholder="e.g. Full Wash, Interior Cleaning"
                                style={inputStyle}
                                required
                            />
                        </div>

                        <div style={{ marginBottom: '20px' }}>
                            <label style={labelStyle}>Service Price (KES) *</label>
                            <input
                                type="number"
                                value={workForm.servicePrice}
                                onChange={(e) => setWorkForm({...workForm, servicePrice: e.target.value})}
                                placeholder="Service price"
                                style={inputStyle}
                                required
                            />
                            {workForm.staffId && (
                                <p style={{ fontSize: '12px', color: '#10b981', marginTop: '6px' }}>
                                    Commission: KES {(((parseFloat(workForm.servicePrice) || 0) * (staffList.find(s => s.id === workForm.staffId)?.commissionRate || 0)) / 100).toLocaleString()} 
                                    ({staffList.find(s => s.id === workForm.staffId)?.commissionRate || 0}%)
                                </p>
                            )}
                        </div>

                        <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end' }}>
                            <button style={btnSecondary} onClick={() => setShowAddWorkModal(false)}>Cancel</button>
                            <button style={btnPrimary} onClick={handleAddWork} disabled={actionLoading || !workForm.staffId || !workForm.serviceName || !workForm.servicePrice}>
                                {actionLoading ? 'Adding...' : 'Add Work Entry'}
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* Confirm Action Modal */}
            {showConfirmModal && (
                <div style={modalOverlay} onClick={() => setShowConfirmModal(false)}>
                    <div style={{ ...modalContent, maxWidth: '400px', textAlign: 'center' }} onClick={e => e.stopPropagation()}>
                        <div style={{ fontSize: '48px', marginBottom: '16px' }}>‚ö†Ô∏è</div>
                        <h2 style={{ margin: '0 0 12px 0', fontSize: '18px', fontWeight: '600', color: isDark ? '#f1f5f9' : '#1e293b' }}>
                            {confirmAction.title}
                        </h2>
                        <p style={{ margin: '0 0 24px 0', fontSize: '14px', color: isDark ? '#94a3b8' : '#64748b', lineHeight: '1.5' }}>
                            {confirmAction.message}
                        </p>
                        <div style={{ display: 'flex', gap: '12px', justifyContent: 'center' }}>
                            <button 
                                style={{ ...btnSecondary, padding: '12px 24px' }} 
                                onClick={() => setShowConfirmModal(false)}
                            >
                                Cancel
                            </button>
                            <button 
                                style={{ ...btnPrimary, padding: '12px 24px', background: '#dc2626' }} 
                                onClick={executeConfirmedAction}
                                disabled={actionLoading}
                            >
                                {actionLoading ? 'Processing...' : 'Confirm'}
                            </button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}

// ==================== BILLING MODULE COMPONENT ====================
function BillingModule() {
    const [activeTab, setActiveTab] = useState('paid');
    const [invoices, setInvoices] = useState([]);
    const [pendingInvoices, setPendingInvoices] = useState([]);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState(null);
    const [successMessage, setSuccessMessage] = useState(null);
    const [actionLoading, setActionLoading] = useState(false);
    const [searchQuery, setSearchQuery] = useState('');
    const [dateFilter, setDateFilter] = useState('all');
    const [customDateFrom, setCustomDateFrom] = useState('');
    const [customDateTo, setCustomDateTo] = useState('');
    const [sourceFilter, setSourceFilter] = useState('all');
    const [billingStats, setBillingStats] = useState({
        totalInvoices: 0,
        pendingPayments: 0,
        paidToday: 0,
        totalPending: 0,
        totalCollected: 0,
        todayInvoiceCount: 0,
        mpesaPayments: 0,
        cashPayments: 0
    });
    
    // Payment modal states
    const [showPaymentModal, setShowPaymentModal] = useState(false);
    const [showMpesaModal, setShowMpesaModal] = useState(false);
    const [showInvoiceDetailModal, setShowInvoiceDetailModal] = useState(false);
    const [selectedInvoice, setSelectedInvoice] = useState(null);
    const [mpesaPhone, setMpesaPhone] = useState('');
    const [mpesaLoading, setMpesaLoading] = useState(false);
    const [mpesaPaymentId, setMpesaPaymentId] = useState(null);
    const [mpesaStatus, setMpesaStatus] = useState(null);
    
    // Manual billing modal states
    const [showManualBillingModal, setShowManualBillingModal] = useState(false);
    const [manualBillingData, setManualBillingData] = useState({
        customerName: '',
        customerPhone: '',
        plateNumber: '',
        vehicleType: 'Sedan',
        source: 'wash',
        selectedServices: [], // Array of service IDs
        notes: '',
        paymentStatus: 'unpaid',
        paymentMethod: 'cash',
        mpesaCode: ''
    });
    
    // Service packages for billing
    const [servicePackages, setServicePackages] = useState([]);
    
    // Revenue tracking
    const [revenueToday, setRevenueToday] = useState({ total: 0, wash: 0, garage: 0, other: 0 });
    
    // Expenses integration
    const [expenses, setExpenses] = useState([]);
    const [expensesSummary, setExpensesSummary] = useState({ total: 0, today: 0, thisWeek: 0, thisMonth: 0, count: 0 });
    
    // Export state
    const [showExportMenu, setShowExportMenu] = useState(false);

    // Theme detection
    const [isDark, setIsDark] = useState(document.documentElement.getAttribute('data-theme') === 'dark');

    useEffect(() => {
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.attributeName === 'data-theme') {
                    setIsDark(document.documentElement.getAttribute('data-theme') === 'dark');
                }
            });
        });
        observer.observe(document.documentElement, { attributes: true });
        return () => observer.disconnect();
    }, []);

    const theme = {
        bg: isDark ? '#1e293b' : 'white',
        bgSecondary: isDark ? '#0f172a' : '#f8fafc',
        bgTertiary: isDark ? '#334155' : '#f1f5f9',
        text: isDark ? '#f1f5f9' : '#1e293b',
        textSecondary: isDark ? '#94a3b8' : '#64748b',
        textMuted: isDark ? '#64748b' : '#94a3b8',
        border: isDark ? '#334155' : '#e2e8f0',
        borderLight: isDark ? '#475569' : '#cbd5e1',
        cardShadow: isDark ? '0 2px 8px rgba(0,0,0,0.3)' : '0 2px 8px rgba(0,0,0,0.08)',
        modalOverlay: isDark ? 'rgba(0,0,0,0.7)' : 'rgba(0,0,0,0.5)',
        inputBg: isDark ? '#1e293b' : 'white',
        rowHoverBg: isDark ? '#334155' : '#f8fafc',
    };

    // Auto-hide success message
    useEffect(() => {
        if (successMessage) {
            const timer = setTimeout(() => setSuccessMessage(null), 3000);
            return () => clearTimeout(timer);
        }
    }, [successMessage]);

    // Initialize Firebase subscriptions
    useEffect(() => {
        let unsubInvoices, unsubPending, unsubExpenses;
        
        const initializeData = async () => {
            let services = window.FirebaseServices;
            let attempts = 0;
            while (!services && attempts < 50) {
                await new Promise(resolve => setTimeout(resolve, 100));
                services = window.FirebaseServices;
                attempts++;
            }

            if (!services || !services.billingService) {
                console.error('Billing service not available');
                setLoading(false);
                setError('Billing service not available. Please refresh.');
                return;
            }

            try {
                // Subscribe to all invoices with error handling
                unsubInvoices = services.billingService.subscribeToInvoices(
                    (data) => {
                        console.log('Invoices loaded:', data.length);
                        setInvoices(data);
                        // Also update pending invoices from the same data (fallback)
                        const pending = data.filter(inv => inv.paymentStatus === 'unpaid' || !inv.paymentStatus);
                        setPendingInvoices(pending);
                        setLoading(false);
                        setError(null);
                    },
                    (err) => {
                        console.error('Invoice subscription error:', err);
                        setError('Failed to load invoices: ' + err.message);
                        setLoading(false);
                    }
                );

                // Try to subscribe to pending invoices (requires Firestore index)
                try {
                    unsubPending = services.billingService.subscribeToPendingInvoices(
                        (data) => {
                            console.log('Pending invoices loaded:', data.length);
                            setPendingInvoices(data);
                        },
                        (err) => {
                            // Silently fallback to client-side filtering (already handled above)
                            console.warn('Pending invoice subscription failed, using fallback:', err.message);
                        }
                    );
                } catch (pendingErr) {
                    console.warn('Could not subscribe to pending invoices:', pendingErr);
                }
                
                // Subscribe to expenses for integration
                if (services.expensesService) {
                    unsubExpenses = services.expensesService.subscribeToExpenses((data) => {
                        setExpenses(data);
                        const summary = services.expensesService.getSummary(data);
                        setExpensesSummary(summary);
                    });
                }

                // Get billing stats
                const statsResult = await services.billingService.getBillingStats();
                if (statsResult.success) {
                    setBillingStats(statsResult.data);
                }
                
                // Load service packages
                if (services.packagesService) {
                    const packagesResult = await services.packagesService.getPackages();
                    if (packagesResult.success) {
                        setServicePackages(packagesResult.data.filter(p => p.isActive !== false));
                    }
                }
            } catch (err) {
                console.error('Error initializing billing:', err);
                setError('Failed to load billing data: ' + err.message);
                setLoading(false);
            }
        };

        initializeData();

        return () => {
            if (unsubInvoices) unsubInvoices();
            if (unsubPending) unsubPending();
            if (unsubExpenses) unsubExpenses();
        };
    }, []);

    // Refresh stats when invoices change
    useEffect(() => {
        const refreshStats = async () => {
            const services = window.FirebaseServices;
            if (services?.billingService) {
                const result = await services.billingService.getBillingStats();
                if (result.success) setBillingStats(result.data);
            }
        };
        refreshStats();
        
        // Calculate revenue breakdown from invoices
        const today = new Date().toISOString().split('T')[0];
        const todayPaidInvoices = invoices.filter(inv => 
            inv.paymentStatus === 'paid' && inv.createdAt?.startsWith(today)
        );
        
        const washRevenue = todayPaidInvoices
            .filter(inv => inv.source === 'wash')
            .reduce((sum, inv) => sum + (inv.totalAmount || inv.paidAmount || 0), 0);
        
        const garageRevenue = todayPaidInvoices
            .filter(inv => inv.source === 'garage')
            .reduce((sum, inv) => sum + (inv.totalAmount || inv.paidAmount || 0), 0);
        
        const otherRevenue = todayPaidInvoices
            .filter(inv => inv.source !== 'wash' && inv.source !== 'garage')
            .reduce((sum, inv) => sum + (inv.totalAmount || inv.paidAmount || 0), 0);
        
        setRevenueToday({
            total: washRevenue + garageRevenue + otherRevenue,
            wash: washRevenue,
            garage: garageRevenue,
            other: otherRevenue
        });
    }, [invoices]);

    // Filter invoices
    const getFilteredInvoices = () => {
        let filtered = activeTab === 'pending' ? pendingInvoices : 
                       activeTab === 'paid' ? invoices.filter(inv => inv.paymentStatus === 'paid') :
                       invoices;

        if (searchQuery) {
            const query = searchQuery.toLowerCase();
            filtered = filtered.filter(inv => 
                inv.invoiceNumber?.toLowerCase().includes(query) ||
                inv.customerName?.toLowerCase().includes(query) ||
                inv.plateNumber?.toLowerCase().includes(query) ||
                inv.mpesaCode?.toLowerCase().includes(query)
            );
        }

        if (sourceFilter !== 'all') {
            filtered = filtered.filter(inv => inv.source === sourceFilter);
        }

        if (dateFilter !== 'all') {
            const today = new Date().toISOString().split('T')[0];
            const yesterday = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            const monthAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            
            if (dateFilter === 'today') {
                filtered = filtered.filter(inv => inv.createdAt?.startsWith(today));
            } else if (dateFilter === 'yesterday') {
                filtered = filtered.filter(inv => inv.createdAt?.startsWith(yesterday));
            } else if (dateFilter === 'week') {
                filtered = filtered.filter(inv => inv.createdAt >= weekAgo);
            } else if (dateFilter === 'month') {
                filtered = filtered.filter(inv => inv.createdAt >= monthAgo);
            } else if (dateFilter === 'custom' && customDateFrom && customDateTo) {
                filtered = filtered.filter(inv => {
                    const invDate = inv.createdAt?.split('T')[0];
                    return invDate >= customDateFrom && invDate <= customDateTo;
                });
            }
        }

        return filtered;
    };
    
    // Export functions
    const exportCSV = () => {
        const dataToExport = activeTab === 'expenses' ? expenses : getFilteredInvoices();
        if (activeTab === 'expenses') {
            let csv = 'Date,Category,Description,Vendor,Amount,Payment Method\n';
            dataToExport.forEach(exp => {
                csv += `"${exp.date || ''}","${exp.category || ''}","${(exp.description || '').replace(/"/g, '""')}","${exp.vendor || ''}",${exp.amount || 0},"${exp.paymentMethod || 'Cash'}"\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `expenses_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        } else {
            let csv = 'Invoice #,Customer,Phone,Vehicle,Source,Amount,Status,Payment Method,M-Pesa Code,Date\n';
            dataToExport.forEach(inv => {
                csv += `"${inv.invoiceNumber || inv.id?.slice(0,8) || ''}","${inv.customerName || 'Walk-in'}","${inv.customerPhone || ''}","${inv.plateNumber || ''}","${inv.source || ''}",${inv.totalAmount || 0},"${inv.paymentStatus || 'unpaid'}","${inv.paymentMethod || ''}","${inv.mpesaCode || ''}","${inv.createdAt?.split('T')[0] || ''}"\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `billing_${activeTab}_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }
        setShowExportMenu(false);
    };
    
    const exportPDF = () => {
        const printWindow = window.open('', '_blank');
        const dataToExport = activeTab === 'expenses' ? expenses : getFilteredInvoices();
        
        let html = `<!DOCTYPE html><html><head><title>Billing Report</title><style>
            body { font-family: Arial, sans-serif; padding: 20px; }
            h1 { color: #1f2937; margin-bottom: 10px; }
            h2 { color: #374151; font-size: 16px; margin-bottom: 20px; }
            table { width: 100%; border-collapse: collapse; font-size: 11px; }
            th, td { border: 1px solid #e5e7eb; padding: 8px; text-align: left; }
            th { background: #f3f4f6; font-weight: 600; }
            .amount { text-align: right; font-weight: 600; }
            .paid { color: #166534; background: #dcfce7; }
            .unpaid { color: #dc2626; background: #fee2e2; }
            .expense { color: #dc2626; }
            .stats { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
            .stat-box { padding: 12px 20px; border: 1px solid #e5e7eb; background: #f9fafb; }
            .total-row { font-weight: bold; background: #f3f4f6; }
        </style></head><body>`;
        
        if (activeTab === 'expenses') {
            const total = dataToExport.reduce((sum, e) => sum + (e.amount || 0), 0);
            html += `<h1>üìã Expenses Report</h1><p>Generated: ${new Date().toLocaleString()}</p>`;
            html += `<div class="stats"><div class="stat-box"><strong>Total Expenses:</strong> ${dataToExport.length}</div><div class="stat-box"><strong>Total Amount:</strong> KSH ${total.toLocaleString()}</div></div>`;
            html += '<table><tr><th>Date</th><th>Category</th><th>Description</th><th>Vendor</th><th class="amount">Amount</th><th>Payment</th></tr>';
            dataToExport.forEach(exp => {
                html += `<tr><td>${exp.date || ''}</td><td>${exp.category || ''}</td><td>${exp.description || ''}</td><td>${exp.vendor || '-'}</td><td class="amount expense">-KSH ${(exp.amount || 0).toLocaleString()}</td><td>${exp.paymentMethod || 'Cash'}</td></tr>`;
            });
            html += `<tr class="total-row"><td colspan="4" style="text-align:right;">Grand Total:</td><td class="amount">KSH ${total.toLocaleString()}</td><td></td></tr>`;
        } else {
            const tabLabel = activeTab === 'paid' ? 'Paid Invoices' : activeTab === 'pending' ? 'Pending Invoices' : 'All Invoices';
            const totalAmount = dataToExport.reduce((sum, inv) => sum + (inv.totalAmount || 0), 0);
            const paidCount = dataToExport.filter(inv => inv.paymentStatus === 'paid').length;
            html += `<h1>üí≥ Billing Report - ${tabLabel}</h1><p>Generated: ${new Date().toLocaleString()}</p>`;
            html += `<div class="stats"><div class="stat-box"><strong>Total Invoices:</strong> ${dataToExport.length}</div><div class="stat-box"><strong>Paid:</strong> ${paidCount}</div><div class="stat-box"><strong>Pending:</strong> ${dataToExport.length - paidCount}</div><div class="stat-box"><strong>Total Amount:</strong> KSH ${totalAmount.toLocaleString()}</div></div>`;
            html += '<table><tr><th>Invoice #</th><th>Customer</th><th>Phone</th><th>Vehicle</th><th>Source</th><th class="amount">Amount</th><th>Status</th><th>Payment</th><th>M-Pesa</th><th>Date</th></tr>';
            dataToExport.forEach(inv => {
                const statusClass = inv.paymentStatus === 'paid' ? 'paid' : 'unpaid';
                html += `<tr><td>${inv.invoiceNumber || inv.id?.slice(0,8)?.toUpperCase() || ''}</td><td>${inv.customerName || 'Walk-in'}</td><td>${inv.customerPhone || '-'}</td><td>${inv.plateNumber || '-'}</td><td>${inv.source || '-'}</td><td class="amount">KSH ${(inv.totalAmount || 0).toLocaleString()}</td><td class="${statusClass}">${inv.paymentStatus || 'Unpaid'}</td><td>${inv.paymentMethod || '-'}</td><td>${inv.mpesaCode || '-'}</td><td>${inv.createdAt?.split('T')[0] || ''}</td></tr>`;
            });
            html += `<tr class="total-row"><td colspan="5" style="text-align:right;">Grand Total:</td><td class="amount">KSH ${totalAmount.toLocaleString()}</td><td colspan="4"></td></tr>`;
        }
        
        html += '</table></body></html>';
        printWindow.document.write(html);
        printWindow.document.close();
        printWindow.onload = () => { printWindow.print(); };
        setShowExportMenu(false);
    };

    // Handle cash payment
    const handleCashPayment = async () => {
        if (!selectedInvoice) return;
        
        setActionLoading(true);
        try {
            const services = window.FirebaseServices;
            const result = await services.billingService.markAsPaid(selectedInvoice.id, {
                method: 'cash',
                amount: selectedInvoice.totalAmount
            });
            
            if (result.success) {
                // Log activity
                if (services.activityService) {
                    const currentUser = window.currentUserProfile;
                    services.activityService.logActivity({
                        type: 'billing',
                        action: 'Payment Received',
                        details: `Invoice ${selectedInvoice.invoiceNumber}: KSH ${selectedInvoice.totalAmount?.toLocaleString()} (Cash)`,
                        status: 'success',
                        loggedBy: currentUser?.displayName || currentUser?.email?.split('@')[0] || 'System',
                        loggedByEmail: currentUser?.email || null,
                        loggedByRole: currentUser?.role || null
                    });
                }
                
                // Award loyalty points if customer has phone number
                if (selectedInvoice.customerPhone) {
                    try {
                        const customerResult = await services.customerService.findCustomerByPhone(selectedInvoice.customerPhone);
                        if (customerResult.success && customerResult.data) {
                            // Award 1 point per 100 KES spent
                            const pointsToAward = Math.floor((selectedInvoice.totalAmount || 0) / 100);
                            if (pointsToAward > 0) {
                                await services.customerService.addLoyaltyPoints(
                                    customerResult.data.id, 
                                    pointsToAward, 
                                    `Invoice ${selectedInvoice.invoiceNumber} payment`
                                );
                                // Update invoice with points earned
                                await services.billingService.updateInvoice(selectedInvoice.id, {
                                    customerId: customerResult.data.id,
                                    pointsEarned: pointsToAward
                                });
                            }
                        }
                    } catch (loyaltyErr) {
                        console.log('Loyalty points error (non-critical):', loyaltyErr);
                    }
                }
                setSuccessMessage('Payment recorded successfully!');
                setShowPaymentModal(false);
                setSelectedInvoice(null);
            } else {
                setError(result.error || 'Failed to record payment');
            }
        } catch (err) {
            setError('Failed to record payment');
        } finally {
            setActionLoading(false);
        }
    };

    // Handle M-Pesa payment initiation
    const handleMpesaPayment = async () => {
        if (!selectedInvoice || !mpesaPhone) return;
        
        // Validate phone number (Kenyan format)
        const phoneRegex = /^(?:254|\+254|0)?([17]\d{8})$/;
        if (!phoneRegex.test(mpesaPhone.replace(/\s/g, ''))) {
            setError('Please enter a valid Kenyan phone number');
            return;
        }

        setMpesaLoading(true);
        setMpesaStatus({ status: 'initiating', message: 'Initiating M-Pesa payment...' });
        
        try {
            const services = window.FirebaseServices;
            const formattedPhone = mpesaPhone.replace(/\s/g, '').replace(/^0/, '254').replace(/^\+/, '');
            
            const result = await services.billingService.initiateMpesaPayment(
                selectedInvoice.id,
                formattedPhone,
                selectedInvoice.totalAmount
            );
            
            if (result.success) {
                setMpesaPaymentId(result.paymentId);
                setMpesaStatus({ 
                    status: 'pending', 
                    message: 'STK Push sent! Please check your phone and enter your M-Pesa PIN.'
                });
                
                // Subscribe to payment status
                const unsubPayment = services.billingService.subscribeToMpesaPayment(result.paymentId, (payment) => {
                    if (payment.status === 'completed') {
                        setMpesaStatus({ 
                            status: 'success', 
                            message: `Payment successful! Receipt: ${payment.mpesaReceiptNumber}` 
                        });
                        setSuccessMessage('M-Pesa payment received!');
                        setTimeout(() => {
                            setShowMpesaModal(false);
                            setSelectedInvoice(null);
                            setMpesaPhone('');
                            setMpesaStatus(null);
                            setMpesaPaymentId(null);
                        }, 2000);
                        unsubPayment();
                    } else if (payment.status === 'failed') {
                        setMpesaStatus({ status: 'failed', message: payment.resultDesc || 'Payment failed' });
                    }
                });
            } else {
                setMpesaStatus({ status: 'failed', message: result.error || 'Failed to initiate payment' });
            }
        } catch (err) {
            setMpesaStatus({ status: 'failed', message: 'Failed to initiate M-Pesa payment' });
        } finally {
            setMpesaLoading(false);
        }
    };

    // Simulate M-Pesa callback (for testing)
    const handleSimulateMpesaSuccess = async () => {
        if (!mpesaPaymentId) return;
        
        setMpesaStatus({ status: 'processing', message: 'Processing payment...' });
        const services = window.FirebaseServices;
        await services.billingService.simulateMpesaCallback(mpesaPaymentId, true);
    };

    // Open payment modal
    const openPaymentModal = (invoice) => {
        setSelectedInvoice(invoice);
        setShowPaymentModal(true);
    };

    // Open M-Pesa modal
    const openMpesaModal = () => {
        setShowPaymentModal(false);
        setMpesaPhone(selectedInvoice?.customerPhone || '');
        setMpesaStatus(null);
        setMpesaPaymentId(null);
        setShowMpesaModal(true);
    };

    // View invoice details
    const viewInvoiceDetails = (invoice) => {
        setSelectedInvoice(invoice);
        setShowInvoiceDetailModal(true);
    };

    // Delete invoice
    const handleDeleteInvoice = async (invoice) => {
        if (!confirm(`Delete invoice ${invoice.invoiceNumber}? This action cannot be undone.`)) return;
        
        setActionLoading(true);
        try {
            const services = window.FirebaseServices;
            const result = await services.billingService.deleteInvoice(invoice.id);
            if (result.success) {
                setSuccessMessage('Invoice deleted successfully');
            } else {
                setError(result.error || 'Failed to delete invoice');
            }
        } catch (err) {
            setError('Failed to delete invoice');
        } finally {
            setActionLoading(false);
        }
    };

    // Cancel/Revert payment to unpaid
    const handleCancelPayment = async (invoice) => {
        if (!confirm(`Revert payment for ${invoice.invoiceNumber}? This will set the invoice back to unpaid.`)) return;
        
        setActionLoading(true);
        try {
            const services = window.FirebaseServices;
            const result = await services.billingService.revertToUnpaid(invoice.id);
            if (result.success) {
                setSuccessMessage('Payment cancelled - invoice set to unpaid');
            } else {
                setError(result.error || 'Failed to cancel payment');
            }
        } catch (err) {
            setError('Failed to cancel payment');
        } finally {
            setActionLoading(false);
        }
    };

    // Print invoice receipt
    const handlePrintReceipt = async (invoice) => {
        const receiptWindow = window.open('', '_blank', 'width=400,height=600');
        const servicesList = invoice.services?.map(s => 
            `<tr><td style="padding:8px 0;border-bottom:1px dashed #ddd;">${s.name}</td><td style="padding:8px 0;border-bottom:1px dashed #ddd;text-align:right;">KES ${parseFloat(s.price).toLocaleString()}</td></tr>`
        ).join('') || '<tr><td colspan="2">-</td></tr>';
        
        // Fetch customer loyalty points
        let loyaltyPoints = 0;
        let pointsEarned = 0;
        if (invoice.customerPhone) {
            try {
                const services = window.FirebaseServices;
                const customerResult = await services.customerService.findCustomerByPhone(invoice.customerPhone);
                if (customerResult.success && customerResult.data) {
                    loyaltyPoints = customerResult.data.loyaltyPoints || 0;
                    // Points earned from this transaction (1 point per 100 KES spent)
                    pointsEarned = invoice.pointsEarned || Math.floor((invoice.totalAmount || 0) / 100);
                }
            } catch (e) {
                console.log('Could not fetch loyalty points:', e);
            }
        }
        
        receiptWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>Receipt - ${invoice.invoiceNumber}</title>
                <style>
                    body { font-family: 'Courier New', monospace; padding: 20px; max-width: 350px; margin: 0 auto; }
                    .header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 15px; margin-bottom: 15px; }
                    .logo { font-size: 24px; font-weight: bold; }
                    .tagline { font-size: 12px; color: #666; }
                    .info-row { display: flex; justify-content: space-between; margin: 8px 0; font-size: 13px; }
                    .services { width: 100%; border-collapse: collapse; margin: 15px 0; }
                    .total-row { font-size: 18px; font-weight: bold; border-top: 2px solid #000; padding-top: 10px; margin-top: 10px; }
                    .footer { text-align: center; margin-top: 20px; font-size: 11px; color: #666; }
                    .paid-stamp { text-align: center; padding: 10px; background: #d1fae5; color: #059669; font-weight: bold; margin: 15px 0; }
                    @media print { body { padding: 0; } }
                </style>
            </head>
            <body>
                <div class="header">
                    <div class="logo">üåø ECOSPARK</div>
                    <div class="tagline">Car Wash & Auto Services</div>
                </div>
                
                <div class="info-row"><span>Receipt #:</span><span>${invoice.invoiceNumber}</span></div>
                <div class="info-row"><span>Date:</span><span>${new Date(invoice.createdAt).toLocaleDateString()}</span></div>
                <div class="info-row"><span>Customer:</span><span>${invoice.customerName || 'Walk-in'}</span></div>
                <div class="info-row"><span>Phone:</span><span>${invoice.customerPhone || '-'}</span></div>
                <div class="info-row"><span>Vehicle:</span><span>${invoice.plateNumber || '-'}</span></div>
                <div class="info-row"><span>Source:</span><span>${(invoice.source || 'wash').toUpperCase()}</span></div>
                
                <table class="services">
                    <thead><tr><th style="text-align:left;padding:8px 0;border-bottom:2px solid #000;">Service</th><th style="text-align:right;padding:8px 0;border-bottom:2px solid #000;">Amount</th></tr></thead>
                    <tbody>${servicesList}</tbody>
                </table>
                
                <div class="total-row info-row"><span>TOTAL:</span><span>KES ${parseFloat(invoice.totalAmount).toLocaleString()}</span></div>
                
                <div class="paid-stamp">‚úì PAID - ${(invoice.paymentMethod || 'CASH').toUpperCase()}</div>
                ${invoice.mpesaCode ? `<div class="info-row"><span>M-Pesa Code:</span><span>${invoice.mpesaCode}</span></div>` : ''}
                <div class="info-row"><span>Paid At:</span><span>${invoice.paidAt ? new Date(invoice.paidAt).toLocaleString() : '-'}</span></div>
                
                ${invoice.customerPhone && invoice.customerPhone !== '-' ? `
                <div style="border:2px dashed #f59e0b; padding:12px; margin:15px 0; text-align:center; background:#fffbeb;">
                    <div style="font-size:11px; color:#92400e; text-transform:uppercase; letter-spacing:1px; margin-bottom:6px;">‚≠ê Loyalty Program</div>
                    <div style="font-size:14px; font-weight:bold; color:#d97706;">Points Earned: +${pointsEarned}</div>
                    <div style="font-size:16px; font-weight:bold; color:#b45309; margin-top:4px;">Total Points: ${loyaltyPoints}</div>
                </div>
                ` : ''}
                
                <div class="footer">
                    <p>Thank you for your business!</p>
                    <p>Visit us again at EcoSpark</p>
                </div>
                
                <script>setTimeout(() => window.print(), 500);</script>
            </body>
            </html>
        `);
        receiptWindow.document.close();
    };

    // Handle manual billing form change
    const handleManualBillingChange = (field, value) => {
        setManualBillingData(prev => ({ ...prev, [field]: value }));
    };

    // Add service line to manual billing
    // Toggle service selection
    const toggleServiceSelection = (serviceId) => {
        setManualBillingData(prev => {
            const isSelected = prev.selectedServices.includes(serviceId);
            return {
                ...prev,
                selectedServices: isSelected 
                    ? prev.selectedServices.filter(id => id !== serviceId)
                    : [...prev.selectedServices, serviceId]
            };
        });
    };

    // Get selected services with details
    const getSelectedServicesDetails = () => {
        return manualBillingData.selectedServices
            .map(id => servicePackages.find(s => s.id === id))
            .filter(Boolean);
    };

    // Calculate total for manual billing
    const getManualBillingTotal = () => {
        return getSelectedServicesDetails().reduce((sum, s) => sum + (parseFloat(s.price) || 0), 0);
    };

    // Submit manual billing
    const handleSubmitManualBilling = async () => {
        if (!manualBillingData.plateNumber?.trim()) {
            setError('Please enter a plate number');
            return;
        }
        
        const selectedServices = getSelectedServicesDetails();
        if (selectedServices.length === 0) {
            setError('Please select at least one service');
            return;
        }

        setActionLoading(true);
        try {
            const services = window.FirebaseServices;
            const totalAmount = selectedServices.reduce((sum, s) => sum + parseFloat(s.price), 0);
            const servicesList = selectedServices.map(s => ({ name: s.name, price: s.price }));

            const result = await services.billingService.createInvoice({
                source: manualBillingData.source || 'wash',
                customerName: manualBillingData.customerName || 'Walk-in',
                customerPhone: manualBillingData.customerPhone || '',
                plateNumber: manualBillingData.plateNumber.toUpperCase(),
                vehicleType: manualBillingData.vehicleType || 'Vehicle',
                services: servicesList,
                totalAmount: totalAmount,
                notes: manualBillingData.notes || '',
                createdBy: 'manual',
                // Payment info
                paymentStatus: manualBillingData.paymentStatus,
                paymentMethod: manualBillingData.paymentStatus === 'paid' ? manualBillingData.paymentMethod : null,
                paidAmount: manualBillingData.paymentStatus === 'paid' ? totalAmount : 0,
                paidAt: manualBillingData.paymentStatus === 'paid' ? new Date().toISOString() : null,
                mpesaCode: manualBillingData.paymentMethod === 'mpesa' && manualBillingData.paymentStatus === 'paid' ? manualBillingData.mpesaCode : null
            });

            if (result.success) {
                // Log activity
                if (services.activityService) {
                    const currentUser = window.currentUserProfile;
                    services.activityService.logActivity({
                        type: 'billing',
                        action: 'Invoice Created',
                        details: `${manualBillingData.plateNumber.toUpperCase()} - KSH ${totalAmount.toLocaleString()} - ${manualBillingData.paymentStatus === 'paid' ? 'Paid' : 'Pending'}`,
                        status: 'success',
                        loggedBy: currentUser?.displayName || currentUser?.email?.split('@')[0] || 'System',
                        loggedByEmail: currentUser?.email || null,
                        loggedByRole: currentUser?.role || null
                    });
                }
                
                // Award loyalty points if invoice is paid and has customer phone
                if (manualBillingData.paymentStatus === 'paid' && manualBillingData.customerPhone) {
                    try {
                        const customerResult = await services.customerService.findCustomerByPhone(manualBillingData.customerPhone);
                        if (customerResult.success && customerResult.data) {
                            // Award 1 point per 100 KES spent
                            const pointsToAward = Math.floor(totalAmount / 100);
                            if (pointsToAward > 0) {
                                await services.customerService.addLoyaltyPoints(
                                    customerResult.data.id, 
                                    pointsToAward, 
                                    `Invoice ${result.invoiceNumber} payment`
                                );
                                // Update invoice with points earned and customer ID
                                await services.billingService.updateInvoice(result.id, {
                                    customerId: customerResult.data.id,
                                    pointsEarned: pointsToAward
                                });
                            }
                        }
                    } catch (loyaltyErr) {
                        console.log('Loyalty points error (non-critical):', loyaltyErr);
                    }
                }
                setSuccessMessage(`Invoice ${result.invoiceNumber} created successfully!`);
                setShowManualBillingModal(false);
                // Reset form
                setManualBillingData({
                    customerName: '',
                    customerPhone: '',
                    plateNumber: '',
                    vehicleType: 'Sedan',
                    source: 'wash',
                    selectedServices: [],
                    notes: '',
                    paymentStatus: 'unpaid',
                    paymentMethod: 'cash',
                    mpesaCode: ''
                });
            } else {
                setError(result.error || 'Failed to create invoice');
            }
        } catch (err) {
            console.error('Manual billing error:', err);
            setError('Failed to create invoice: ' + err.message);
        } finally {
            setActionLoading(false);
        }
    };

    // Format currency
    const formatCurrency = (amount) => {
        return new Intl.NumberFormat('en-KE', { style: 'currency', currency: 'KES' }).format(amount || 0);
    };

    // Format date
    const formatDate = (dateStr) => {
        if (!dateStr) return '-';
        return new Date(dateStr).toLocaleDateString('en-KE', { 
            day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' 
        });
    };

    // Get source badge
    const getSourceBadge = (source) => {
        const config = {
            garage: { label: 'GARAGE', color: '#f59e0b', bg: '#fef3c7' },
            wash: { label: 'WASH', color: '#3b82f6', bg: '#dbeafe' },
            other: { label: 'OTHER', color: '#6b7280', bg: '#f3f4f6' }
        };
        const c = config[source] || config.other;
        return (
            <span style={{ 
                padding: '3px 10px', 
                borderRadius: '0', 
                fontSize: '10px', 
                fontWeight: '700',
                letterSpacing: '0.5px',
                background: isDark ? c.color + '20' : c.bg,
                color: c.color
            }}>{c.label}</span>
        );
    };

    // Get payment status badge
    const getPaymentBadge = (status, method) => {
        if (status === 'paid') {
            const methodLabel = method === 'mpesa' ? 'M-PESA' : method === 'cash' ? 'CASH' : 'PAID';
            return (
                <span style={{ 
                    padding: '4px 12px', 
                    borderRadius: '0', 
                    fontSize: '10px', 
                    fontWeight: '700',
                    letterSpacing: '0.5px',
                    background: isDark ? '#10b98130' : '#d1fae5',
                    color: '#10b981',
                    borderLeft: '3px solid #10b981'
                }}>‚úì {methodLabel}</span>
            );
        }
        return (
            <span style={{ 
                padding: '4px 12px', 
                borderRadius: '0', 
                fontSize: '10px', 
                fontWeight: '700',
                letterSpacing: '0.5px',
                background: isDark ? '#ef444430' : '#fee2e2',
                color: '#ef4444',
                borderLeft: '3px solid #ef4444'
            }}>UNPAID</span>
        );
    };

    // Styles - Sharp edges throughout
    const cardStyle = {
        background: theme.bg,
        borderRadius: '0',
        border: `1px solid ${theme.border}`,
        padding: '24px',
        boxShadow: theme.cardShadow
    };

    const statCardStyle = {
        background: theme.bg,
        borderRadius: '0',
        border: `1px solid ${theme.border}`,
        padding: '20px 24px',
        display: 'flex',
        alignItems: 'center',
        gap: '20px'
    };

    const buttonStyle = {
        padding: '10px 20px',
        borderRadius: '0',
        border: 'none',
        cursor: 'pointer',
        fontWeight: '700',
        fontSize: '12px',
        letterSpacing: '0.5px',
        textTransform: 'uppercase',
        transition: 'all 0.2s'
    };

    const inputStyle = {
        width: '100%',
        padding: '12px 16px',
        borderRadius: '0',
        border: `1px solid ${theme.border}`,
        background: theme.inputBg,
        color: theme.text,
        fontSize: '14px',
        outline: 'none'
    };

    const tabStyle = (isActive) => ({
        padding: '12px 28px',
        border: 'none',
        background: isActive ? '#3b82f6' : 'transparent',
        color: isActive ? 'white' : theme.textSecondary,
        fontWeight: '700',
        fontSize: '12px',
        letterSpacing: '0.5px',
        textTransform: 'uppercase',
        cursor: 'pointer',
        borderRadius: '0',
        borderBottom: isActive ? '3px solid #1d4ed8' : '3px solid transparent',
        transition: 'all 0.2s'
    });

    const filteredInvoices = getFilteredInvoices();

    if (loading) {
        return (
            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', height: '400px', color: theme.textSecondary }}>
                <div style={{ textAlign: 'center' }}>
                    <div style={{ fontSize: '32px', marginBottom: '12px' }}>üí≥</div>
                    <div>Loading billing data...</div>
                </div>
            </div>
        );
    }

    return (
        <div style={{ padding: '0', width: '100%' }}>
            {/* Success/Error Messages */}
            {successMessage && (
                <div style={{ 
                    position: 'fixed', top: '20px', right: '20px', zIndex: 1000,
                    background: '#10b981', color: 'white', padding: '14px 24px',
                    borderRadius: '0', boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
                    display: 'flex', alignItems: 'center', gap: '10px',
                    fontWeight: '600', letterSpacing: '0.3px'
                }}>
                    ‚úì {successMessage}
                </div>
            )}
            {error && (
                <div style={{ 
                    position: 'fixed', top: '20px', right: '20px', zIndex: 1000,
                    background: '#ef4444', color: 'white', padding: '14px 24px',
                    borderRadius: '0', boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
                    display: 'flex', alignItems: 'center', gap: '10px', cursor: 'pointer',
                    fontWeight: '600', letterSpacing: '0.3px'
                }} onClick={() => setError(null)}>
                    ‚úï {error}
                </div>
            )}

            {/* Stats Cards - Full Width Grid */}
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '0', marginBottom: '0', borderBottom: `1px solid ${theme.border}` }}>
                <div style={{ ...statCardStyle, borderRight: `1px solid ${theme.border}` }}>
                    <div style={{ fontSize: '28px' }}>üìã</div>
                    <div style={{ flex: 1 }}>
                        <div style={{ fontSize: '28px', fontWeight: '800', color: theme.text, letterSpacing: '-1px' }}>{billingStats.todayInvoiceCount}</div>
                        <div style={{ fontSize: '11px', color: theme.textSecondary, textTransform: 'uppercase', letterSpacing: '0.5px', fontWeight: '600' }}>Today's Invoices</div>
                    </div>
                </div>
                <div style={{ ...statCardStyle, borderRight: `1px solid ${theme.border}` }}>
                    <div style={{ fontSize: '28px' }}>‚è≥</div>
                    <div style={{ flex: 1 }}>
                        <div style={{ fontSize: '28px', fontWeight: '800', color: '#ef4444', letterSpacing: '-1px' }}>{billingStats.pendingPayments}</div>
                        <div style={{ fontSize: '11px', color: theme.textSecondary, textTransform: 'uppercase', letterSpacing: '0.5px', fontWeight: '600' }}>Pending</div>
                    </div>
                </div>
                <div style={{ ...statCardStyle, borderRight: `1px solid ${theme.border}` }}>
                    <div style={{ fontSize: '28px' }}>üí∞</div>
                    <div style={{ flex: 1 }}>
                        <div style={{ fontSize: '24px', fontWeight: '800', color: '#10b981', letterSpacing: '-0.5px' }}>{formatCurrency(billingStats.paidToday)}</div>
                        <div style={{ fontSize: '11px', color: theme.textSecondary, textTransform: 'uppercase', letterSpacing: '0.5px', fontWeight: '600' }}>Collected Today</div>
                    </div>
                </div>
                <div style={{ ...statCardStyle }}>
                    <div style={{ fontSize: '28px' }}>üìä</div>
                    <div style={{ flex: 1 }}>
                        <div style={{ fontSize: '24px', fontWeight: '800', color: '#f59e0b', letterSpacing: '-0.5px' }}>{formatCurrency(billingStats.totalPending)}</div>
                        <div style={{ fontSize: '11px', color: theme.textSecondary, textTransform: 'uppercase', letterSpacing: '0.5px', fontWeight: '600' }}>Outstanding</div>
                    </div>
                </div>
            </div>

            {/* Revenue Today & Payment Methods Stats Row */}
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '0', borderBottom: `1px solid ${theme.border}` }}>
                <div style={{ ...statCardStyle, borderRight: `1px solid ${theme.border}` }}>
                    <div style={{ fontSize: '28px' }}>üí≥</div>
                    <div style={{ flex: 1 }}>
                        <div style={{ fontSize: '28px', fontWeight: '800', color: '#10b981', letterSpacing: '-0.5px' }}>{formatCurrency(revenueToday.total)}</div>
                        <div style={{ fontSize: '11px', color: theme.textSecondary, textTransform: 'uppercase', letterSpacing: '0.5px', fontWeight: '600', marginBottom: '8px' }}>Revenue Today</div>
                        <div style={{ display: 'flex', gap: '12px', flexWrap: 'wrap' }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                                <span style={{ width: '6px', height: '6px', borderRadius: '50%', background: '#3b82f6' }}></span>
                                <span style={{ fontSize: '11px', color: theme.textSecondary }}>Wash:</span>
                                <span style={{ fontSize: '12px', fontWeight: '700', color: '#3b82f6' }}>{formatCurrency(revenueToday.wash)}</span>
                            </div>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                                <span style={{ width: '6px', height: '6px', borderRadius: '50%', background: '#8b5cf6' }}></span>
                                <span style={{ fontSize: '11px', color: theme.textSecondary }}>Garage:</span>
                                <span style={{ fontSize: '12px', fontWeight: '700', color: '#8b5cf6' }}>{formatCurrency(revenueToday.garage)}</span>
                            </div>
                            {revenueToday.other > 0 && (
                                <div style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                                    <span style={{ width: '6px', height: '6px', borderRadius: '50%', background: '#6b7280' }}></span>
                                    <span style={{ fontSize: '11px', color: theme.textSecondary }}>Other:</span>
                                    <span style={{ fontSize: '12px', fontWeight: '700', color: '#6b7280' }}>{formatCurrency(revenueToday.other)}</span>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
                <div style={{ ...statCardStyle, borderRight: `1px solid ${theme.border}` }}>
                    <div style={{ fontSize: '28px' }}>üì±</div>
                    <div style={{ flex: 1 }}>
                        <div style={{ fontSize: '24px', fontWeight: '800', color: '#3b82f6' }}>{billingStats.mpesaPayments}</div>
                        <div style={{ fontSize: '11px', color: theme.textSecondary, textTransform: 'uppercase', letterSpacing: '0.5px', fontWeight: '600' }}>M-Pesa Payments</div>
                    </div>
                </div>
                <div style={{ ...statCardStyle, borderRight: `1px solid ${theme.border}` }}>
                    <div style={{ fontSize: '28px' }}>üíµ</div>
                    <div style={{ flex: 1 }}>
                        <div style={{ fontSize: '24px', fontWeight: '800', color: '#10b981' }}>{billingStats.cashPayments}</div>
                        <div style={{ fontSize: '11px', color: theme.textSecondary, textTransform: 'uppercase', letterSpacing: '0.5px', fontWeight: '600' }}>Cash Payments</div>
                    </div>
                </div>
                <div style={{ ...statCardStyle }}>
                    <div style={{ fontSize: '28px' }}>üè¶</div>
                    <div style={{ flex: 1 }}>
                        <div style={{ fontSize: '24px', fontWeight: '800', color: theme.text }}>{formatCurrency(billingStats.totalCollected)}</div>
                        <div style={{ fontSize: '11px', color: theme.textSecondary, textTransform: 'uppercase', letterSpacing: '0.5px', fontWeight: '600' }}>Total Collected</div>
                    </div>
                </div>
            </div>
            
            {/* Expenses & Profit Row */}
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '0', borderBottom: `1px solid ${theme.border}` }}>
                <div style={{ ...statCardStyle, borderRight: `1px solid ${theme.border}` }}>
                    <div style={{ fontSize: '28px' }}>üìâ</div>
                    <div style={{ flex: 1 }}>
                        <div style={{ fontSize: '24px', fontWeight: '800', color: '#ef4444', letterSpacing: '-0.5px' }}>{formatCurrency(expensesSummary.today)}</div>
                        <div style={{ fontSize: '11px', color: theme.textSecondary, textTransform: 'uppercase', letterSpacing: '0.5px', fontWeight: '600' }}>Expenses Today</div>
                    </div>
                </div>
                <div style={{ ...statCardStyle, borderRight: `1px solid ${theme.border}` }}>
                    <div style={{ fontSize: '28px' }}>üìã</div>
                    <div style={{ flex: 1 }}>
                        <div style={{ fontSize: '24px', fontWeight: '800', color: '#f59e0b' }}>{formatCurrency(expensesSummary.thisMonth)}</div>
                        <div style={{ fontSize: '11px', color: theme.textSecondary, textTransform: 'uppercase', letterSpacing: '0.5px', fontWeight: '600' }}>Expenses This Month</div>
                    </div>
                </div>
                <div style={{ ...statCardStyle, borderRight: `1px solid ${theme.border}` }}>
                    <div style={{ fontSize: '28px' }}>{(revenueToday.total - expensesSummary.today) >= 0 ? 'üìà' : 'üìâ'}</div>
                    <div style={{ flex: 1 }}>
                        <div style={{ fontSize: '28px', fontWeight: '800', color: (revenueToday.total - expensesSummary.today) >= 0 ? '#10b981' : '#ef4444', letterSpacing: '-0.5px' }}>{formatCurrency(revenueToday.total - expensesSummary.today)}</div>
                        <div style={{ fontSize: '11px', color: theme.textSecondary, textTransform: 'uppercase', letterSpacing: '0.5px', fontWeight: '600' }}>Net Profit Today</div>
                        <div style={{ display: 'flex', gap: '8px', marginTop: '4px' }}>
                            <span style={{ fontSize: '10px', color: '#10b981' }}>+{formatCurrency(revenueToday.total)}</span>
                            <span style={{ fontSize: '10px', color: '#ef4444' }}>-{formatCurrency(expensesSummary.today)}</span>
                        </div>
                    </div>
                </div>
                <div style={{ ...statCardStyle }}>
                    <div style={{ fontSize: '28px' }}>üßæ</div>
                    <div style={{ flex: 1 }}>
                        <div style={{ fontSize: '24px', fontWeight: '800', color: theme.text }}>{expensesSummary.count}</div>
                        <div style={{ fontSize: '11px', color: theme.textSecondary, textTransform: 'uppercase', letterSpacing: '0.5px', fontWeight: '600' }}>Total Expenses</div>
                    </div>
                </div>
            </div>

            {/* Tabs & Filters Bar */}
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: '16px', padding: '0', background: theme.bgSecondary, borderBottom: `2px solid ${theme.border}` }}>
                <div style={{ display: 'flex', gap: '0', alignItems: 'center' }}>
                    <button style={tabStyle(activeTab === 'paid')} onClick={() => setActiveTab('paid')}>
                        Paid
                    </button>
                    <button style={tabStyle(activeTab === 'pending')} onClick={() => setActiveTab('pending')}>
                        Pending ({pendingInvoices.length})
                    </button>
                    <button style={tabStyle(activeTab === 'all')} onClick={() => setActiveTab('all')}>
                        All Invoices
                    </button>
                    <button style={tabStyle(activeTab === 'expenses')} onClick={() => setActiveTab('expenses')}>
                        Expenses ({expenses.length})
                    </button>
                    <button
                        onClick={() => setShowManualBillingModal(true)}
                        style={{
                            ...buttonStyle,
                            background: '#10b981',
                            color: 'white',
                            marginLeft: '16px',
                            padding: '10px 20px',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '8px'
                        }}
                    >
                        <span style={{ fontSize: '16px' }}>+</span> NEW INVOICE
                    </button>
                </div>

                <div style={{ display: 'flex', gap: '0', padding: '0' }}>
                    <input
                        type="text"
                        placeholder="Search invoices..."
                        value={searchQuery}
                        onChange={(e) => setSearchQuery(e.target.value)}
                        style={{ ...inputStyle, width: '220px', borderRight: 'none' }}
                    />
                    <select
                        value={sourceFilter}
                        onChange={(e) => setSourceFilter(e.target.value)}
                        style={{ ...inputStyle, width: '140px', borderRight: 'none' }}
                    >
                        <option value="all">All Sources</option>
                        <option value="garage">Garage</option>
                        <option value="wash">Car Wash</option>
                        <option value="other">Other</option>
                    </select>
                    <select
                        value={dateFilter}
                        onChange={(e) => setDateFilter(e.target.value)}
                        style={{ ...inputStyle, width: '140px' }}
                    >
                        <option value="all">All Time</option>
                        <option value="today">Today</option>
                        <option value="yesterday">Yesterday</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                        <option value="custom">Custom Range</option>
                    </select>
                    {dateFilter === 'custom' && (
                        <>
                            <input
                                type="date"
                                value={customDateFrom}
                                onChange={(e) => setCustomDateFrom(e.target.value)}
                                style={{ ...inputStyle, width: '140px', marginLeft: '8px' }}
                                placeholder="From"
                            />
                            <input
                                type="date"
                                value={customDateTo}
                                onChange={(e) => setCustomDateTo(e.target.value)}
                                style={{ ...inputStyle, width: '140px' }}
                                placeholder="To"
                            />
                        </>
                    )}
                    {/* Export Button */}
                    <div style={{ position: 'relative', marginLeft: '8px' }}>
                        <button
                            onClick={() => setShowExportMenu(!showExportMenu)}
                            style={{
                                ...buttonStyle,
                                background: theme.bgTertiary,
                                color: theme.text,
                                padding: '10px 16px',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '6px'
                            }}
                        >
                            üì• Export ‚ñæ
                        </button>
                        {showExportMenu && (
                            <div style={{
                                position: 'absolute',
                                top: '100%',
                                right: 0,
                                background: 'white',
                                border: '1px solid #e5e7eb',
                                boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
                                zIndex: 100,
                                minWidth: '160px'
                            }}>
                                <button
                                    onClick={exportCSV}
                                    style={{ display: 'block', width: '100%', padding: '12px 16px', border: 'none', background: 'none', textAlign: 'left', cursor: 'pointer', fontSize: '14px', color: '#374151' }}
                                    onMouseOver={(e) => e.target.style.background='#f3f4f6'}
                                    onMouseOut={(e) => e.target.style.background='none'}
                                >
                                    üìä Export CSV
                                </button>
                                <button
                                    onClick={exportPDF}
                                    style={{ display: 'block', width: '100%', padding: '12px 16px', border: 'none', background: 'none', textAlign: 'left', cursor: 'pointer', fontSize: '14px', color: '#374151' }}
                                    onMouseOver={(e) => e.target.style.background='#f3f4f6'}
                                    onMouseOut={(e) => e.target.style.background='none'}
                                >
                                    üìÑ Export PDF
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            </div>

            {/* Invoices Table - Only show when not on expenses tab */}
            {activeTab !== 'expenses' ? (
            <div style={{ overflowX: 'auto', background: theme.bg }}>
                <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                    <thead>
                        <tr style={{ background: theme.bgTertiary, borderBottom: `2px solid ${theme.border}` }}>
                            <th style={{ padding: '16px 20px', textAlign: 'left', fontSize: '11px', fontWeight: '700', color: theme.textSecondary, textTransform: 'uppercase', letterSpacing: '0.5px' }}>Invoice #</th>
                            <th style={{ padding: '16px 20px', textAlign: 'left', fontSize: '11px', fontWeight: '700', color: theme.textSecondary, textTransform: 'uppercase', letterSpacing: '0.5px' }}>Customer</th>
                            <th style={{ padding: '16px 20px', textAlign: 'left', fontSize: '11px', fontWeight: '700', color: theme.textSecondary, textTransform: 'uppercase', letterSpacing: '0.5px' }}>Vehicle</th>
                            <th style={{ padding: '16px 20px', textAlign: 'center', fontSize: '11px', fontWeight: '700', color: theme.textSecondary, textTransform: 'uppercase', letterSpacing: '0.5px' }}>Source</th>
                            <th style={{ padding: '16px 20px', textAlign: 'right', fontSize: '11px', fontWeight: '700', color: theme.textSecondary, textTransform: 'uppercase', letterSpacing: '0.5px' }}>Amount</th>
                            <th style={{ padding: '16px 20px', textAlign: 'center', fontSize: '11px', fontWeight: '700', color: theme.textSecondary, textTransform: 'uppercase', letterSpacing: '0.5px' }}>Status</th>
                            <th style={{ padding: '16px 20px', textAlign: 'center', fontSize: '11px', fontWeight: '700', color: theme.textSecondary, textTransform: 'uppercase', letterSpacing: '0.5px' }}>M-Pesa Code</th>
                            <th style={{ padding: '16px 20px', textAlign: 'left', fontSize: '11px', fontWeight: '700', color: theme.textSecondary, textTransform: 'uppercase', letterSpacing: '0.5px' }}>Date</th>
                            <th style={{ padding: '16px 20px', textAlign: 'center', fontSize: '11px', fontWeight: '700', color: theme.textSecondary, textTransform: 'uppercase', letterSpacing: '0.5px' }}>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {filteredInvoices.length === 0 ? (
                            <tr>
                                <td colSpan="9" style={{ padding: '60px 20px', textAlign: 'center', color: theme.textSecondary }}>
                                    <div style={{ fontSize: '48px', marginBottom: '16px', opacity: 0.5 }}>üì≠</div>
                                    <div style={{ fontSize: '14px', fontWeight: '600' }}>No invoices found</div>
                                    <div style={{ fontSize: '12px', marginTop: '4px' }}>Invoices will appear here when jobs are completed</div>
                                </td>
                            </tr>
                        ) : (
                            filteredInvoices.map((invoice, idx) => (
                                <tr key={invoice.id} style={{ borderBottom: `1px solid ${theme.border}`, background: idx % 2 === 0 ? theme.bg : theme.bgSecondary }}>
                                    <td style={{ padding: '18px 20px' }}>
                                        <span style={{ fontWeight: '700', color: '#3b82f6', cursor: 'pointer', letterSpacing: '0.3px' }} onClick={() => viewInvoiceDetails(invoice)}>
                                            {invoice.invoiceNumber || invoice.id.slice(0, 8).toUpperCase()}
                                        </span>
                                    </td>
                                    <td style={{ padding: '18px 20px' }}>
                                        <div style={{ fontWeight: '600', color: theme.text }}>{invoice.customerName || 'Walk-in'}</div>
                                        <div style={{ fontSize: '11px', color: theme.textSecondary, marginTop: '2px' }}>{invoice.customerPhone || '-'}</div>
                                    </td>
                                    <td style={{ padding: '18px 20px' }}>
                                        <span style={{ fontWeight: '700', color: theme.text, background: theme.bgTertiary, padding: '4px 10px', fontSize: '12px' }}>{invoice.plateNumber || '-'}</span>
                                    </td>
                                    <td style={{ padding: '18px 20px', textAlign: 'center' }}>{getSourceBadge(invoice.source)}</td>
                                    <td style={{ padding: '18px 20px', textAlign: 'right', fontWeight: '800', color: theme.text, fontSize: '15px' }}>
                                        {formatCurrency(invoice.totalAmount)}
                                    </td>
                                    <td style={{ padding: '18px 20px', textAlign: 'center' }}>
                                        {getPaymentBadge(invoice.paymentStatus, invoice.paymentMethod)}
                                    </td>
                                    <td style={{ padding: '18px 20px', textAlign: 'center' }}>
                                        {invoice.paymentMethod === 'mpesa' && invoice.mpesaCode ? (
                                            <span style={{ 
                                                fontWeight: '700', 
                                                color: '#00a651', 
                                                background: '#d1fae5', 
                                                padding: '4px 10px', 
                                                fontSize: '11px',
                                                fontFamily: 'monospace',
                                                letterSpacing: '0.5px'
                                            }}>
                                                {invoice.mpesaCode}
                                            </span>
                                        ) : (
                                            <span style={{ color: theme.textSecondary, fontSize: '12px' }}>-</span>
                                        )}
                                    </td>
                                    <td style={{ padding: '18px 20px', color: theme.textSecondary, fontSize: '12px' }}>
                                        {formatDate(invoice.createdAt)}
                                    </td>
                                    <td style={{ padding: '18px 20px', textAlign: 'center' }}>
                                        <div style={{ display: 'flex', gap: '4px', justifyContent: 'center', flexWrap: 'wrap' }}>
                                            {invoice.paymentStatus === 'paid' ? (
                                                <>
                                                    <span style={{ 
                                                        padding: '8px 12px', 
                                                        background: '#10b981', 
                                                        color: 'white', 
                                                        fontSize: '10px', 
                                                        fontWeight: '700',
                                                        letterSpacing: '0.5px',
                                                        display: 'flex',
                                                        alignItems: 'center',
                                                        gap: '4px'
                                                    }}>
                                                        ‚úì COMPLETED
                                                    </span>
                                                    <button
                                                        onClick={() => handlePrintReceipt(invoice)}
                                                        style={{ ...buttonStyle, padding: '8px 10px', background: '#3b82f6', color: 'white', fontSize: '12px' }}
                                                        title="Print Receipt"
                                                    >
                                                        üßæ
                                                    </button>
                                                    <button
                                                        onClick={() => handleCancelPayment(invoice)}
                                                        style={{ ...buttonStyle, padding: '8px 10px', background: '#f59e0b', color: 'white', fontSize: '12px' }}
                                                        title="Cancel Payment"
                                                    >
                                                        ‚Ü©
                                                    </button>
                                                    <button
                                                        onClick={() => handleDeleteInvoice(invoice)}
                                                        style={{ ...buttonStyle, padding: '8px 10px', background: '#ef4444', color: 'white', fontSize: '12px' }}
                                                        title="Delete Invoice"
                                                    >
                                                        üóë
                                                    </button>
                                                </>
                                            ) : (
                                                <>
                                                    <button
                                                        onClick={() => viewInvoiceDetails(invoice)}
                                                        style={{ ...buttonStyle, padding: '8px 14px', background: theme.bgTertiary, color: theme.text }}
                                                        title="View Details"
                                                    >
                                                        VIEW
                                                    </button>
                                                    <button
                                                        onClick={() => openPaymentModal(invoice)}
                                                        style={{ ...buttonStyle, padding: '8px 14px', background: '#10b981', color: 'white' }}
                                                        title="Record Payment"
                                                    >
                                                        PAY
                                                    </button>
                                                    <button
                                                        onClick={() => handleDeleteInvoice(invoice)}
                                                        style={{ ...buttonStyle, padding: '8px 10px', background: '#ef4444', color: 'white', fontSize: '12px' }}
                                                        title="Delete Invoice"
                                                    >
                                                        üóë
                                                    </button>
                                                </>
                                            )}
                                        </div>
                                    </td>
                                </tr>
                            ))
                        )}
                    </tbody>
                </table>
            </div>
            ) : (
            /* Expenses Table - Show when on expenses tab */
            <div style={{ overflowX: 'auto', background: theme.bg }}>
                <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                    <thead>
                        <tr style={{ background: theme.bgTertiary, borderBottom: `2px solid ${theme.border}` }}>
                            <th style={{ padding: '16px 20px', textAlign: 'left', fontSize: '11px', fontWeight: '700', color: theme.textSecondary, textTransform: 'uppercase', letterSpacing: '0.5px' }}>Date</th>
                            <th style={{ padding: '16px 20px', textAlign: 'left', fontSize: '11px', fontWeight: '700', color: theme.textSecondary, textTransform: 'uppercase', letterSpacing: '0.5px' }}>Category</th>
                            <th style={{ padding: '16px 20px', textAlign: 'left', fontSize: '11px', fontWeight: '700', color: theme.textSecondary, textTransform: 'uppercase', letterSpacing: '0.5px' }}>Description</th>
                            <th style={{ padding: '16px 20px', textAlign: 'left', fontSize: '11px', fontWeight: '700', color: theme.textSecondary, textTransform: 'uppercase', letterSpacing: '0.5px' }}>Vendor</th>
                            <th style={{ padding: '16px 20px', textAlign: 'right', fontSize: '11px', fontWeight: '700', color: theme.textSecondary, textTransform: 'uppercase', letterSpacing: '0.5px' }}>Amount</th>
                            <th style={{ padding: '16px 20px', textAlign: 'center', fontSize: '11px', fontWeight: '700', color: theme.textSecondary, textTransform: 'uppercase', letterSpacing: '0.5px' }}>Payment Method</th>
                        </tr>
                    </thead>
                    <tbody>
                        {expenses.length === 0 ? (
                            <tr>
                                <td colSpan="6" style={{ padding: '60px 20px', textAlign: 'center', color: theme.textSecondary }}>
                                    <div style={{ fontSize: '48px', marginBottom: '16px', opacity: 0.5 }}>üìã</div>
                                    <div style={{ fontSize: '14px', fontWeight: '600' }}>No expenses recorded</div>
                                    <div style={{ fontSize: '12px', marginTop: '4px' }}>Add expenses from the Expenses module</div>
                                </td>
                            </tr>
                        ) : (
                            expenses.slice(0, 20).map((expense, idx) => {
                                const categoryColors = {
                                    'Utilities': '#3b82f6',
                                    'Supplies': '#10b981',
                                    'Salaries': '#8b5cf6',
                                    'Maintenance': '#f59e0b',
                                    'Rent': '#ef4444',
                                    'Marketing': '#ec4899',
                                    'Insurance': '#6366f1',
                                    'Taxes': '#f97316',
                                    'Other': '#6b7280'
                                };
                                return (
                                    <tr key={expense.id} style={{ borderBottom: `1px solid ${theme.border}`, background: idx % 2 === 0 ? theme.bg : theme.bgSecondary }}>
                                        <td style={{ padding: '16px 20px', color: theme.text, fontSize: '13px' }}>
                                            {expense.date}
                                        </td>
                                        <td style={{ padding: '16px 20px' }}>
                                            <span style={{ 
                                                background: `${categoryColors[expense.category] || '#6b7280'}20`,
                                                color: categoryColors[expense.category] || '#6b7280',
                                                padding: '4px 12px',
                                                fontSize: '11px',
                                                fontWeight: '700',
                                                textTransform: 'uppercase',
                                                letterSpacing: '0.3px'
                                            }}>
                                                {expense.category}
                                            </span>
                                        </td>
                                        <td style={{ padding: '16px 20px', color: theme.text, fontWeight: '500' }}>
                                            {expense.description}
                                        </td>
                                        <td style={{ padding: '16px 20px', color: theme.textSecondary, fontSize: '13px' }}>
                                            {expense.vendor || '-'}
                                        </td>
                                        <td style={{ padding: '16px 20px', textAlign: 'right', fontWeight: '800', color: '#ef4444', fontSize: '15px' }}>
                                            -{formatCurrency(expense.amount)}
                                        </td>
                                        <td style={{ padding: '16px 20px', textAlign: 'center' }}>
                                            <span style={{ 
                                                background: expense.paymentMethod === 'mpesa' ? '#d1fae5' : (expense.paymentMethod === 'bank' ? '#dbeafe' : theme.bgTertiary),
                                                color: expense.paymentMethod === 'mpesa' ? '#047857' : (expense.paymentMethod === 'bank' ? '#1d4ed8' : theme.text),
                                                padding: '4px 10px',
                                                fontSize: '11px',
                                                fontWeight: '600',
                                                textTransform: 'uppercase'
                                            }}>
                                                {expense.paymentMethod || 'Cash'}
                                            </span>
                                        </td>
                                    </tr>
                                );
                            })
                        )}
                    </tbody>
                </table>
                {expenses.length > 20 && (
                    <div style={{ padding: '16px', textAlign: 'center', background: theme.bgSecondary, borderTop: `1px solid ${theme.border}` }}>
                        <span style={{ color: theme.textSecondary, fontSize: '13px' }}>
                            Showing 20 of {expenses.length} expenses. Go to Expenses module to see all.
                        </span>
                    </div>
                )}
            </div>
            )}

            {/* Payment Method Modal */}
            {showPaymentModal && selectedInvoice && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: theme.modalOverlay, display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 }} onClick={() => setShowPaymentModal(false)}>
                    <div style={{ ...cardStyle, width: '420px', maxWidth: '90vw' }} onClick={(e) => e.stopPropagation()}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px', paddingBottom: '16px', borderBottom: `2px solid ${theme.border}` }}>
                            <h3 style={{ margin: 0, color: theme.text, fontSize: '18px', fontWeight: '700', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Record Payment</h3>
                            <button onClick={() => setShowPaymentModal(false)} style={{ background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer', color: theme.textSecondary }}>‚úï</button>
                        </div>

                        <div style={{ background: theme.bgSecondary, padding: '20px', borderRadius: '0', marginBottom: '24px', borderLeft: '4px solid #3b82f6' }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '10px' }}>
                                <span style={{ color: theme.textSecondary, fontSize: '12px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Invoice:</span>
                                <span style={{ fontWeight: '700', color: theme.text }}>{selectedInvoice.invoiceNumber}</span>
                            </div>
                            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '10px' }}>
                                <span style={{ color: theme.textSecondary, fontSize: '12px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Customer:</span>
                                <span style={{ color: theme.text, fontWeight: '500' }}>{selectedInvoice.customerName || 'Walk-in'}</span>
                            </div>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', paddingTop: '12px', borderTop: `1px solid ${theme.border}` }}>
                                <span style={{ color: theme.textSecondary, fontSize: '12px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Amount Due:</span>
                                <span style={{ fontWeight: '800', fontSize: '24px', color: '#10b981' }}>{formatCurrency(selectedInvoice.totalAmount)}</span>
                            </div>
                        </div>

                        <div style={{ marginBottom: '16px', fontWeight: '700', color: theme.text, fontSize: '12px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Select Payment Method:</div>

                        <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                            <button
                                onClick={handleCashPayment}
                                disabled={actionLoading}
                                style={{ 
                                    ...buttonStyle, 
                                    padding: '18px', 
                                    background: '#10b981', 
                                    color: 'white',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    gap: '12px',
                                    fontSize: '14px'
                                }}
                            >
                                <span style={{ fontSize: '24px' }}>üíµ</span>
                                {actionLoading ? 'PROCESSING...' : 'CASH PAYMENT'}
                            </button>

                            <button
                                onClick={openMpesaModal}
                                style={{ 
                                    ...buttonStyle, 
                                    padding: '18px', 
                                    background: 'linear-gradient(135deg, #00a651 0%, #007a3d 100%)', 
                                    color: 'white',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    gap: '12px',
                                    fontSize: '14px'
                                }}
                            >
                                <span style={{ fontSize: '24px' }}>üì±</span>
                                M-PESA PAYMENT
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* M-Pesa Payment Modal */}
            {showMpesaModal && selectedInvoice && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: theme.modalOverlay, display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 }} onClick={() => !mpesaLoading && setShowMpesaModal(false)}>
                    <div style={{ ...cardStyle, width: '440px', maxWidth: '90vw' }} onClick={(e) => e.stopPropagation()}>
                        <div style={{ textAlign: 'center', marginBottom: '28px', paddingBottom: '20px', borderBottom: `2px solid ${theme.border}` }}>
                            <div style={{ 
                                width: '80px', 
                                height: '80px', 
                                margin: '0 auto 16px', 
                                background: 'linear-gradient(135deg, #00a651 0%, #007a3d 100%)', 
                                borderRadius: '0',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                fontSize: '36px',
                                color: 'white'
                            }}>üì±</div>
                            <h3 style={{ margin: '0 0 8px', color: theme.text, fontSize: '18px', fontWeight: '700', textTransform: 'uppercase', letterSpacing: '0.5px' }}>M-Pesa Payment</h3>
                            <p style={{ margin: 0, color: theme.textSecondary, fontSize: '14px', fontWeight: '500' }}>
                                {selectedInvoice.invoiceNumber} ‚Ä¢ {formatCurrency(selectedInvoice.totalAmount)}
                            </p>
                        </div>

                        {/* Status Display */}
                        {mpesaStatus && (
                            <div style={{ 
                                padding: '20px', 
                                borderRadius: '0', 
                                marginBottom: '24px',
                                textAlign: 'center',
                                background: mpesaStatus.status === 'success' ? '#d1fae520' : 
                                            mpesaStatus.status === 'failed' ? '#fee2e220' : 
                                            '#dbeafe20',
                                borderLeft: `4px solid ${
                                    mpesaStatus.status === 'success' ? '#10b981' : 
                                    mpesaStatus.status === 'failed' ? '#ef4444' : 
                                    '#3b82f6'
                                }`
                            }}>
                                <div style={{ 
                                    fontSize: '36px', 
                                    marginBottom: '12px' 
                                }}>
                                    {mpesaStatus.status === 'success' ? '‚úÖ' : 
                                     mpesaStatus.status === 'failed' ? '‚ùå' : 
                                     mpesaStatus.status === 'pending' ? 'üì≤' : '‚è≥'}
                                </div>
                                <div style={{ 
                                    color: mpesaStatus.status === 'success' ? '#10b981' : 
                                           mpesaStatus.status === 'failed' ? '#ef4444' : 
                                           '#3b82f6',
                                    fontWeight: '600',
                                    fontSize: '14px'
                                }}>
                                    {mpesaStatus.message}
                                </div>

                                {/* Simulate button for testing */}
                                {mpesaStatus.status === 'pending' && mpesaPaymentId && (
                                    <button
                                        onClick={handleSimulateMpesaSuccess}
                                        style={{ 
                                            ...buttonStyle, 
                                            marginTop: '16px',
                                            background: '#f59e0b', 
                                            color: 'white',
                                            fontSize: '11px',
                                            padding: '10px 16px'
                                        }}
                                    >
                                        üß™ SIMULATE SUCCESS (TESTING)
                                    </button>
                                )}
                            </div>
                        )}

                        {/* Phone input */}
                        {(!mpesaStatus || mpesaStatus.status === 'failed') && (
                            <>
                                <div style={{ marginBottom: '24px' }}>
                                    <label style={{ display: 'block', marginBottom: '10px', fontWeight: '700', color: theme.text, fontSize: '12px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>
                                        Phone Number
                                    </label>
                                    <input
                                        type="tel"
                                        value={mpesaPhone}
                                        onChange={(e) => setMpesaPhone(e.target.value)}
                                        placeholder="e.g., 0712345678 or 254712345678"
                                        style={{ ...inputStyle, padding: '14px 16px', fontSize: '16px' }}
                                    />
                                    <p style={{ margin: '10px 0 0', fontSize: '11px', color: theme.textSecondary, textTransform: 'uppercase', letterSpacing: '0.3px' }}>
                                        Enter the M-Pesa registered phone number
                                    </p>
                                </div>

                                <div style={{ display: 'flex', gap: '0' }}>
                                    <button
                                        onClick={() => setShowMpesaModal(false)}
                                        style={{ ...buttonStyle, flex: 1, background: theme.bgSecondary, color: theme.text, padding: '16px' }}
                                    >
                                        CANCEL
                                    </button>
                                    <button
                                        onClick={handleMpesaPayment}
                                        disabled={mpesaLoading || !mpesaPhone}
                                        style={{ 
                                            ...buttonStyle, 
                                            flex: 2, 
                                            background: 'linear-gradient(135deg, #00a651 0%, #007a3d 100%)', 
                                            color: 'white',
                                            opacity: mpesaLoading || !mpesaPhone ? 0.6 : 1,
                                            padding: '16px'
                                        }}
                                    >
                                        {mpesaLoading ? 'SENDING...' : 'SEND STK PUSH'}
                                    </button>
                                </div>
                            </>
                        )}

                        {mpesaStatus?.status === 'success' && (
                            <button
                                onClick={() => {
                                    setShowMpesaModal(false);
                                    setSelectedInvoice(null);
                                    setMpesaStatus(null);
                                }}
                                style={{ ...buttonStyle, width: '100%', background: '#10b981', color: 'white', padding: '16px' }}
                            >
                                Done
                            </button>
                        )}
                    </div>
                </div>
            )}

            {/* Invoice Detail Modal */}
            {showInvoiceDetailModal && selectedInvoice && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: theme.modalOverlay, display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 }} onClick={() => setShowInvoiceDetailModal(false)}>
                    <div style={{ ...cardStyle, width: '520px', maxWidth: '90vw', maxHeight: '85vh', overflowY: 'auto' }} onClick={(e) => e.stopPropagation()}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px', borderBottom: `2px solid ${theme.border}`, paddingBottom: '20px' }}>
                            <div>
                                <h3 style={{ margin: '0 0 6px', color: theme.text, fontSize: '18px', fontWeight: '700', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Invoice Details</h3>
                                <span style={{ color: '#3b82f6', fontWeight: '700', fontSize: '14px', letterSpacing: '0.3px' }}>{selectedInvoice.invoiceNumber}</span>
                            </div>
                            <button onClick={() => setShowInvoiceDetailModal(false)} style={{ background: 'none', border: 'none', fontSize: '28px', cursor: 'pointer', color: theme.textSecondary }}>‚úï</button>
                        </div>

                        {/* Invoice Info */}
                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px', marginBottom: '24px' }}>
                            <div style={{ background: theme.bgSecondary, padding: '16px', borderLeft: `3px solid ${theme.border}` }}>
                                <div style={{ fontSize: '10px', color: theme.textSecondary, marginBottom: '6px', textTransform: 'uppercase', letterSpacing: '0.5px', fontWeight: '600' }}>Customer</div>
                                <div style={{ fontWeight: '600', color: theme.text }}>{selectedInvoice.customerName || 'Walk-in'}</div>
                            </div>
                            <div style={{ background: theme.bgSecondary, padding: '16px', borderLeft: `3px solid ${theme.border}` }}>
                                <div style={{ fontSize: '10px', color: theme.textSecondary, marginBottom: '6px', textTransform: 'uppercase', letterSpacing: '0.5px', fontWeight: '600' }}>Phone</div>
                                <div style={{ fontWeight: '600', color: theme.text }}>{selectedInvoice.customerPhone || '-'}</div>
                            </div>
                            <div style={{ background: theme.bgSecondary, padding: '16px', borderLeft: `3px solid #3b82f6` }}>
                                <div style={{ fontSize: '10px', color: theme.textSecondary, marginBottom: '6px', textTransform: 'uppercase', letterSpacing: '0.5px', fontWeight: '600' }}>Vehicle</div>
                                <div style={{ fontWeight: '700', color: theme.text, fontSize: '16px' }}>{selectedInvoice.plateNumber || '-'}</div>
                            </div>
                            <div style={{ background: theme.bgSecondary, padding: '16px', borderLeft: `3px solid ${theme.border}` }}>
                                <div style={{ fontSize: '10px', color: theme.textSecondary, marginBottom: '6px', textTransform: 'uppercase', letterSpacing: '0.5px', fontWeight: '600' }}>Source</div>
                                <div style={{ marginTop: '4px' }}>{getSourceBadge(selectedInvoice.source)}</div>
                            </div>
                            <div style={{ background: theme.bgSecondary, padding: '16px', borderLeft: `3px solid ${theme.border}` }}>
                                <div style={{ fontSize: '10px', color: theme.textSecondary, marginBottom: '6px', textTransform: 'uppercase', letterSpacing: '0.5px', fontWeight: '600' }}>Created</div>
                                <div style={{ color: theme.text, fontSize: '13px' }}>{formatDate(selectedInvoice.createdAt)}</div>
                            </div>
                            <div style={{ background: theme.bgSecondary, padding: '16px', borderLeft: `3px solid ${theme.border}` }}>
                                <div style={{ fontSize: '10px', color: theme.textSecondary, marginBottom: '6px', textTransform: 'uppercase', letterSpacing: '0.5px', fontWeight: '600' }}>Status</div>
                                <div style={{ marginTop: '4px' }}>{getPaymentBadge(selectedInvoice.paymentStatus, selectedInvoice.paymentMethod)}</div>
                            </div>
                        </div>

                        {/* Services */}
                        {selectedInvoice.services && selectedInvoice.services.length > 0 && (
                            <div style={{ marginBottom: '24px' }}>
                                <div style={{ fontSize: '12px', fontWeight: '700', color: theme.text, marginBottom: '12px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Services</div>
                                <div style={{ background: theme.bgSecondary, borderRadius: '0', overflow: 'hidden', border: `1px solid ${theme.border}` }}>
                                    {selectedInvoice.services.map((service, idx) => (
                                        <div key={idx} style={{ padding: '14px 18px', borderBottom: idx < selectedInvoice.services.length - 1 ? `1px solid ${theme.border}` : 'none', display: 'flex', justifyContent: 'space-between' }}>
                                            <span style={{ color: theme.text, fontWeight: '500' }}>{service.name || service}</span>
                                            <span style={{ fontWeight: '700', color: theme.text }}>{formatCurrency(service.price || 0)}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* Total */}
                        <div style={{ background: theme.bgTertiary, padding: '20px', borderRadius: '0', marginBottom: '24px', borderLeft: '4px solid #10b981' }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                <span style={{ fontSize: '14px', fontWeight: '700', color: theme.text, textTransform: 'uppercase', letterSpacing: '0.5px' }}>Total Amount</span>
                                <span style={{ fontSize: '28px', fontWeight: '800', color: '#10b981' }}>{formatCurrency(selectedInvoice.totalAmount)}</span>
                            </div>
                        </div>

                        {/* Payment Info */}
                        {selectedInvoice.paymentStatus === 'paid' && (
                            <div style={{ background: '#d1fae515', borderLeft: '4px solid #10b981', padding: '20px', borderRadius: '0', marginBottom: '24px' }}>
                                <div style={{ fontWeight: '700', color: '#10b981', marginBottom: '16px', fontSize: '14px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>‚úì Payment Received</div>
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px', fontSize: '13px' }}>
                                    <div><span style={{ color: theme.textSecondary, fontSize: '10px', textTransform: 'uppercase', letterSpacing: '0.3px' }}>Method:</span> <span style={{ color: theme.text, fontWeight: '600', display: 'block', marginTop: '4px' }}>{selectedInvoice.paymentMethod === 'mpesa' ? 'M-PESA' : 'CASH'}</span></div>
                                    <div><span style={{ color: theme.textSecondary, fontSize: '10px', textTransform: 'uppercase', letterSpacing: '0.3px' }}>Paid:</span> <span style={{ color: theme.text, fontWeight: '600', display: 'block', marginTop: '4px' }}>{formatCurrency(selectedInvoice.paidAmount)}</span></div>
                                    {selectedInvoice.mpesaCode && (
                                        <div style={{ gridColumn: '1 / -1' }}><span style={{ color: theme.textSecondary, fontSize: '10px', textTransform: 'uppercase', letterSpacing: '0.3px' }}>M-Pesa Code:</span> <span style={{ color: '#10b981', fontWeight: '700', display: 'block', marginTop: '4px', fontSize: '16px' }}>{selectedInvoice.mpesaCode}</span></div>
                                    )}
                                    <div style={{ gridColumn: '1 / -1' }}><span style={{ color: theme.textSecondary, fontSize: '10px', textTransform: 'uppercase', letterSpacing: '0.3px' }}>Paid At:</span> <span style={{ color: theme.text, display: 'block', marginTop: '4px' }}>{formatDate(selectedInvoice.paidAt)}</span></div>
                                </div>
                            </div>
                        )}

                        {/* Actions */}
                        <div style={{ display: 'flex', gap: '0' }}>
                            <button
                                onClick={() => setShowInvoiceDetailModal(false)}
                                style={{ ...buttonStyle, flex: 1, background: theme.bgSecondary, color: theme.text, padding: '16px' }}
                            >
                                CLOSE
                            </button>
                            {selectedInvoice.paymentStatus !== 'paid' && (
                                <button
                                    onClick={() => {
                                        setShowInvoiceDetailModal(false);
                                        openPaymentModal(selectedInvoice);
                                    }}
                                    style={{ ...buttonStyle, flex: 1, background: '#10b981', color: 'white', padding: '16px' }}
                                >
                                    üí≥ RECORD PAYMENT
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            )}

            {/* Manual Billing Modal - Simple & Clean */}
            {showManualBillingModal && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: theme.modalOverlay, display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 }} onClick={() => setShowManualBillingModal(false)}>
                    <div style={{ ...cardStyle, width: '500px', maxWidth: '95vw', maxHeight: '90vh', overflowY: 'auto' }} onClick={(e) => e.stopPropagation()}>
                        {/* Header */}
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
                            <h3 style={{ margin: 0, color: theme.text, fontSize: '16px', fontWeight: '700' }}>‚ûï New Invoice</h3>
                            <button onClick={() => setShowManualBillingModal(false)} style={{ background: 'none', border: 'none', fontSize: '20px', cursor: 'pointer', color: theme.textSecondary }}>‚úï</button>
                        </div>

                        {/* Customer & Vehicle Info */}
                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px', marginBottom: '16px' }}>
                            <input type="text" value={manualBillingData.plateNumber} onChange={(e) => handleManualBillingChange('plateNumber', e.target.value.toUpperCase())} placeholder="Plate Number *" style={{ ...inputStyle, gridColumn: '1 / -1', fontWeight: '700', textTransform: 'uppercase', fontSize: '15px', padding: '12px' }} />
                            <input type="text" value={manualBillingData.customerName} onChange={(e) => handleManualBillingChange('customerName', e.target.value)} placeholder="Customer Name" style={inputStyle} />
                            <input type="tel" value={manualBillingData.customerPhone} onChange={(e) => handleManualBillingChange('customerPhone', e.target.value)} placeholder="Phone" style={inputStyle} />
                        </div>

                        {/* Source Selection - Garage or Wash */}
                        <div style={{ marginBottom: '16px' }}>
                            <div style={{ fontSize: '11px', color: theme.textSecondary, marginBottom: '8px', textTransform: 'uppercase', letterSpacing: '0.5px', fontWeight: '600' }}>Service Type</div>
                            <div style={{ display: 'flex', gap: '0' }}>
                                <button
                                    type="button"
                                    onClick={() => handleManualBillingChange('source', 'wash')}
                                    style={{
                                        flex: 1,
                                        padding: '14px',
                                        border: `2px solid ${manualBillingData.source === 'wash' ? '#3b82f6' : theme.border}`,
                                        background: manualBillingData.source === 'wash' ? '#3b82f6' : theme.bg,
                                        color: manualBillingData.source === 'wash' ? 'white' : theme.text,
                                        fontWeight: '700',
                                        fontSize: '13px',
                                        cursor: 'pointer',
                                        borderRadius: '0',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        gap: '8px'
                                    }}
                                >
                                    <span style={{ fontSize: '18px' }}>üöø</span> CAR WASH
                                </button>
                                <button
                                    type="button"
                                    onClick={() => handleManualBillingChange('source', 'garage')}
                                    style={{
                                        flex: 1,
                                        padding: '14px',
                                        border: `2px solid ${manualBillingData.source === 'garage' ? '#f59e0b' : theme.border}`,
                                        borderLeft: 'none',
                                        background: manualBillingData.source === 'garage' ? '#f59e0b' : theme.bg,
                                        color: manualBillingData.source === 'garage' ? 'white' : theme.text,
                                        fontWeight: '700',
                                        fontSize: '13px',
                                        cursor: 'pointer',
                                        borderRadius: '0',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        gap: '8px'
                                    }}
                                >
                                    <span style={{ fontSize: '18px' }}>üîß</span> GARAGE
                                </button>
                            </div>
                        </div>

                        {/* Services Selection */}
                        <div style={{ marginBottom: '16px' }}>
                            <div style={{ fontSize: '11px', color: theme.textSecondary, marginBottom: '8px', textTransform: 'uppercase', letterSpacing: '0.5px', fontWeight: '600' }}>Select Services</div>
                            {servicePackages.length === 0 ? (
                                <div style={{ padding: '20px', background: theme.bgSecondary, textAlign: 'center', color: theme.textSecondary, fontSize: '13px' }}>
                                    No services available. Add services in Service Packages.
                                </div>
                            ) : (
                                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '8px', maxHeight: '200px', overflowY: 'auto', padding: '4px' }}>
                                    {servicePackages.map(service => {
                                        const isSelected = manualBillingData.selectedServices.includes(service.id);
                                        return (
                                            <button
                                                key={service.id}
                                                type="button"
                                                onClick={() => toggleServiceSelection(service.id)}
                                                style={{
                                                    padding: '12px',
                                                    border: `2px solid ${isSelected ? '#10b981' : theme.border}`,
                                                    background: isSelected ? (isDark ? '#10b98120' : '#d1fae5') : theme.bg,
                                                    cursor: 'pointer',
                                                    textAlign: 'left',
                                                    borderRadius: '0',
                                                    transition: 'all 0.15s'
                                                }}
                                            >
                                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                                                    <div style={{ flex: 1 }}>
                                                        <div style={{ fontWeight: '600', color: theme.text, fontSize: '13px', marginBottom: '2px' }}>
                                                            {isSelected && <span style={{ color: '#10b981', marginRight: '4px' }}>‚úì</span>}
                                                            {service.name}
                                                        </div>
                                                        {service.description && (
                                                            <div style={{ fontSize: '10px', color: theme.textSecondary }}>{service.description}</div>
                                                        )}
                                                    </div>
                                                    <div style={{ fontWeight: '800', color: isSelected ? '#10b981' : '#3b82f6', fontSize: '14px', whiteSpace: 'nowrap' }}>
                                                        {formatCurrency(service.price)}
                                                    </div>
                                                </div>
                                            </button>
                                        );
                                    })}
                                </div>
                            )}
                            {/* Selected services summary */}
                            {manualBillingData.selectedServices.length > 0 && (
                                <div style={{ marginTop: '8px', padding: '8px 12px', background: isDark ? '#10b98115' : '#ecfdf5', borderLeft: '3px solid #10b981' }}>
                                    <div style={{ fontSize: '11px', color: theme.textSecondary }}>
                                        {manualBillingData.selectedServices.length} service(s): {getSelectedServicesDetails().map(s => s.name).join(', ')}
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* Payment Method */}
                        <div style={{ marginBottom: '16px' }}>
                            <div style={{ fontSize: '11px', color: theme.textSecondary, marginBottom: '8px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Payment</div>
                            <div style={{ display: 'flex', gap: '8px' }}>
                                {[
                                    { id: 'unpaid', label: '‚è≥ Unpaid', color: '#ef4444' },
                                    { id: 'cash', label: 'üíµ Cash', color: '#10b981' },
                                    { id: 'card', label: 'üí≥ Card', color: '#3b82f6' },
                                    { id: 'mpesa', label: 'üì± M-Pesa', color: '#00a651' }
                                ].map(opt => {
                                    const isSelected = opt.id === 'unpaid' 
                                        ? manualBillingData.paymentStatus === 'unpaid' 
                                        : manualBillingData.paymentStatus === 'paid' && manualBillingData.paymentMethod === opt.id;
                                    return (
                                        <button
                                            key={opt.id}
                                            type="button"
                                            onClick={() => {
                                                if (opt.id === 'unpaid') {
                                                    handleManualBillingChange('paymentStatus', 'unpaid');
                                                } else {
                                                    handleManualBillingChange('paymentStatus', 'paid');
                                                    handleManualBillingChange('paymentMethod', opt.id);
                                                }
                                            }}
                                            style={{
                                                flex: 1,
                                                padding: '10px 8px',
                                                border: `2px solid ${isSelected ? opt.color : theme.border}`,
                                                background: isSelected ? opt.color : theme.bg,
                                                color: isSelected ? 'white' : theme.text,
                                                fontSize: '11px',
                                                fontWeight: '700',
                                                cursor: 'pointer',
                                                borderRadius: '0'
                                            }}
                                        >
                                            {opt.label}
                                        </button>
                                    );
                                })}
                            </div>
                        </div>

                        {/* M-Pesa Code */}
                        {manualBillingData.paymentStatus === 'paid' && manualBillingData.paymentMethod === 'mpesa' && (
                            <input type="text" value={manualBillingData.mpesaCode} onChange={(e) => handleManualBillingChange('mpesaCode', e.target.value.toUpperCase())} placeholder="M-Pesa Code (e.g., SBK7XXX)" style={{ ...inputStyle, marginBottom: '16px', textTransform: 'uppercase', fontWeight: '700' }} />
                        )}

                        {/* Total & Submit */}
                        <div style={{ display: 'flex', alignItems: 'center', gap: '16px', padding: '16px', background: theme.bgSecondary, marginBottom: '16px' }}>
                            <div style={{ flex: 1 }}>
                                <div style={{ fontSize: '11px', color: theme.textSecondary, textTransform: 'uppercase' }}>Total</div>
                                <div style={{ fontSize: '24px', fontWeight: '800', color: '#10b981' }}>{formatCurrency(getManualBillingTotal())}</div>
                            </div>
                            <button
                                onClick={handleSubmitManualBilling}
                                disabled={actionLoading}
                                style={{ padding: '14px 28px', background: '#10b981', color: 'white', border: 'none', fontWeight: '700', fontSize: '13px', cursor: actionLoading ? 'wait' : 'pointer', opacity: actionLoading ? 0.7 : 1 }}
                            >
                                {actionLoading ? 'SAVING...' : 'CREATE'}
                            </button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}

// ==================== STAFF MANAGEMENT COMPONENT ====================
function StaffManagement() {
    const [activeTab, setActiveTab] = useState('staff');
    const [staffList, setStaffList] = useState([]);
    const [usersList, setUsersList] = useState([]);
    const [auditLogs, setAuditLogs] = useState([]);
    const [loading, setLoading] = useState(true);
    const [showAddStaffModal, setShowAddStaffModal] = useState(false);
    const [showAddUserModal, setShowAddUserModal] = useState(false);
    const [showEditModal, setShowEditModal] = useState(false);
    const [showEditUserModal, setShowEditUserModal] = useState(false);
    const [showConfirmModal, setShowConfirmModal] = useState(false);
    const [confirmAction, setConfirmAction] = useState(null);
    const [selectedItem, setSelectedItem] = useState(null);
    const [selectedUser, setSelectedUser] = useState(null);
    const [actionLoading, setActionLoading] = useState(false);
    const [error, setError] = useState(null);
    const [successMessage, setSuccessMessage] = useState(null);
    const [searchTerm, setSearchTerm] = useState('');
    const [filterStatus, setFilterStatus] = useState('active');
    const [auditFilter, setAuditFilter] = useState({ action: '', module: '' });
    const [isDark, setIsDark] = useState(document.documentElement.getAttribute('data-theme') === 'dark');

    const [staffForm, setStaffForm] = useState({ name: '', role: 'Washer', phone: '', email: '', department: 'Operations', hireDate: new Date().toISOString().split('T')[0], hourlyRate: '', emergencyContact: '', notes: '' });
    const [userForm, setUserForm] = useState({ email: '', password: '', displayName: '', role: 'staff', phone: '', permissions: {} });
    const [editUserForm, setEditUserForm] = useState({ displayName: '', role: 'staff', phone: '', permissions: {} });
    const [userStep, setUserStep] = useState(1);

    const STAFF_ROLES = ['Washer', 'Detailer', 'Supervisor', 'Technician', 'Cleaner', 'Attendant'];
    const DEPARTMENTS = ['Operations', 'Garage', 'Administration', 'Customer Service'];
    
    // All system modules with their permissions
    const ALL_MODULES = [
        { id: 'dashboard', label: 'Dashboard', icon: 'üìä', category: 'Core' },
        { id: 'vehicle-intake', label: 'Vehicle Intake', icon: 'üöó', category: 'Core' },
        { id: 'service-packages', label: 'Service Packages', icon: 'üì¶', category: 'Services' },
        { id: 'garage-management', label: 'Garage Management', icon: 'üè¢', category: 'Operations' },
        { id: 'wash-bays', label: 'Wash Bays', icon: 'üíß', category: 'Operations' },
        { id: 'equipment', label: 'Equipment Management', icon: 'üîß', category: 'Operations' },
        { id: 'customers', label: 'Customer Management', icon: 'üë•', category: 'Customer Relations' },
        { id: 'fleet', label: 'Fleet Accounts', icon: 'üöõ', category: 'Customer Relations' },
        { id: 'staff', label: 'Staff Management', icon: 'üë∑', category: 'Staff' },
        { id: 'hr', label: 'HR Statistics', icon: 'üë•', category: 'Human Resources' },
        { id: 'billing', label: 'Billing & Payments', icon: 'üí≥', category: 'Financial' },
        { id: 'expenses', label: 'Expenses', icon: 'üìâ', category: 'Financial' },
        { id: 'inventory', label: 'Inventory Management', icon: 'üìã', category: 'Financial' },
        { id: 'reports', label: 'Reports & Analytics', icon: 'üìà', category: 'Analytics & Marketing' },
        { id: 'marketing', label: 'Marketing & CRM', icon: 'üì£', category: 'Analytics & Marketing' },
        { id: 'settings', label: 'System Settings', icon: '‚öôÔ∏è', category: 'System' },
        { id: 'audit-logs', label: 'Audit Logs', icon: 'üìú', category: 'System' }
    ];

    const PERMISSION_ACTIONS = [
        { id: 'view', label: 'View', icon: 'üëÅÔ∏è' },
        { id: 'create', label: 'Create', icon: '‚ûï' },
        { id: 'edit', label: 'Edit', icon: '‚úèÔ∏è' },
        { id: 'delete', label: 'Delete', icon: 'üóëÔ∏è' }
    ];

    const USER_ROLES = [
        { id: 'admin', label: 'Admin', desc: 'Full system access' },
        { id: 'manager', label: 'Manager', desc: 'Manage operations & staff' },
        { id: 'supervisor', label: 'Supervisor', desc: 'Oversee daily operations' },
        { id: 'receptionist', label: 'Receptionist', desc: 'Customer intake & billing' },
        { id: 'technician', label: 'Technician', desc: 'Garage operations only' },
        { id: 'staff', label: 'Staff', desc: 'Basic access only' }
    ];

    // Generate default permissions based on role
    const getDefaultPermissions = (role) => {
        const permissions = {};
        ALL_MODULES.forEach(mod => {
            if (role === 'admin') {
                permissions[mod.id] = { view: true, create: true, edit: true, delete: true };
            } else if (role === 'manager') {
                permissions[mod.id] = { view: true, create: true, edit: true, delete: mod.category !== 'System' };
            } else if (role === 'supervisor') {
                const canManage = ['Core', 'Operations', 'Services'].includes(mod.category);
                permissions[mod.id] = { view: true, create: canManage, edit: canManage, delete: false };
            } else if (role === 'receptionist') {
                const canAccess = ['Core', 'Customer Relations', 'Financial'].includes(mod.category);
                permissions[mod.id] = { view: canAccess, create: canAccess && mod.id !== 'billing', edit: canAccess && mod.id !== 'billing', delete: false };
            } else if (role === 'technician') {
                const canAccess = mod.category === 'Operations' || mod.id === 'dashboard';
                permissions[mod.id] = { view: canAccess, create: false, edit: canAccess, delete: false };
            } else {
                permissions[mod.id] = { view: mod.id === 'dashboard', create: false, edit: false, delete: false };
            }
        });
        return permissions;
    };

    const toggleModulePermission = (moduleId, action) => {
        setUserForm(prev => ({
            ...prev,
            permissions: {
                ...prev.permissions,
                [moduleId]: {
                    ...prev.permissions[moduleId],
                    [action]: !prev.permissions[moduleId]?.[action]
                }
            }
        }));
    };

    const toggleAllModulePermissions = (moduleId, enabled) => {
        setUserForm(prev => ({
            ...prev,
            permissions: {
                ...prev.permissions,
                [moduleId]: { view: enabled, create: enabled, edit: enabled, delete: enabled }
            }
        }));
    };

    const applyRolePreset = (role) => {
        setUserForm(prev => ({ ...prev, role, permissions: getDefaultPermissions(role) }));
    };

    useEffect(() => {
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.attributeName === 'data-theme') setIsDark(document.documentElement.getAttribute('data-theme') === 'dark');
            });
        });
        observer.observe(document.documentElement, { attributes: true });
        return () => observer.disconnect();
    }, []);

    const theme = { bg: isDark ? '#1e293b' : 'white', bgSecondary: isDark ? '#0f172a' : '#f8fafc', text: isDark ? '#f1f5f9' : '#1e293b', textSecondary: isDark ? '#94a3b8' : '#64748b', border: isDark ? '#334155' : '#e2e8f0', inputBg: isDark ? '#1e293b' : 'white' };

    useEffect(() => {
        if (successMessage) { const timer = setTimeout(() => setSuccessMessage(null), 3000); return () => clearTimeout(timer); }
    }, [successMessage]);

    useEffect(() => {
        const services = window.FirebaseServices;
        if (!services) { setLoading(false); return; }
        let unsubStaff = services.staffService?.subscribeToAllStaff((data) => { setStaffList(data); setLoading(false); });
        let unsubUsers = services.userService?.subscribeToUsers((data) => { setUsersList(data); });
        let unsubAudit = services.auditService?.subscribeToAuditLogs((data) => { setAuditLogs(data); });
        return () => { if (unsubStaff) unsubStaff(); if (unsubUsers) unsubUsers(); if (unsubAudit) unsubAudit(); };
    }, []);

    const filteredAuditLogs = auditLogs.filter(log => {
        const matchesSearch = log.userName?.toLowerCase().includes(searchTerm.toLowerCase()) || log.userEmail?.toLowerCase().includes(searchTerm.toLowerCase()) || log.details?.toLowerCase().includes(searchTerm.toLowerCase());
        const matchesAction = !auditFilter.action || log.action === auditFilter.action;
        const matchesModule = !auditFilter.module || log.module === auditFilter.module;
        return matchesSearch && matchesAction && matchesModule;
    });

    const getActionColor = (action) => {
        const colors = { login: '#10b981', logout: '#6b7280', create: '#3b82f6', update: '#f59e0b', delete: '#ef4444', view: '#8b5cf6' };
        return colors[action] || '#6b7280';
    };

    const getActionIcon = (action) => {
        const icons = { login: 'üîì', logout: 'üîí', create: '‚ûï', update: '‚úèÔ∏è', delete: 'üóëÔ∏è', view: 'üëÅÔ∏è' };
        return icons[action] || 'üìã';
    };

    const formatTimeAgo = (timestamp) => {
        const now = new Date();
        const date = new Date(timestamp);
        const seconds = Math.floor((now - date) / 1000);
        if (seconds < 60) return 'Just now';
        if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
        if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
        if (seconds < 604800) return `${Math.floor(seconds / 86400)}d ago`;
        return date.toLocaleDateString();
    };

    const filteredStaff = staffList.filter(s => {
        const matchesSearch = s.name?.toLowerCase().includes(searchTerm.toLowerCase()) || s.role?.toLowerCase().includes(searchTerm.toLowerCase());
        const matchesStatus = filterStatus === 'all' || s.status === filterStatus;
        return matchesSearch && matchesStatus;
    });

    const filteredUsers = usersList.filter(u => {
        const matchesSearch = u.displayName?.toLowerCase().includes(searchTerm.toLowerCase()) || u.email?.toLowerCase().includes(searchTerm.toLowerCase());
        const matchesStatus = filterStatus === 'all' || (filterStatus === 'active' ? u.isActive : !u.isActive);
        return matchesSearch && matchesStatus;
    });

    const handleAddStaff = async (e) => {
        e.preventDefault();
        if (!staffForm.name.trim()) { setError('Staff name is required'); return; }
        setActionLoading(true); setError(null);
        try {
            const result = await window.FirebaseServices.staffService.addStaff(staffForm);
            if (result.success) {
                setSuccessMessage('Staff added successfully');
                setShowAddStaffModal(false);
                setStaffForm({ name: '', role: 'Washer', phone: '', email: '', department: 'Operations', hireDate: new Date().toISOString().split('T')[0], hourlyRate: '', emergencyContact: '', notes: '' });
            } else { setError(result.error); }
        } catch (err) { setError(err.message); }
        finally { setActionLoading(false); }
    };

    const handleAddUser = async (e) => {
        e.preventDefault();
        if (!userForm.email.trim() || !userForm.password.trim()) { setError('Email and password required'); return; }
        if (userForm.password.length < 6) { setError('Password must be at least 6 characters'); return; }
        setActionLoading(true); setError(null);
        try {
            const services = window.FirebaseServices;
            const authResult = await services.authService.signUp(userForm.email, userForm.password);
            if (authResult.success) {
                await services.userService.createUserProfile(authResult.user.uid, { 
                    email: userForm.email, 
                    displayName: userForm.displayName || userForm.email.split('@')[0], 
                    role: userForm.role, 
                    phone: userForm.phone, 
                    permissions: userForm.permissions,
                    isActive: true 
                });
                // Log user creation in audit trail
                await services.auditService?.logCRUD(
                    window.currentUser || { email: 'admin' },
                    'create',
                    'users',
                    'user',
                    authResult.user.uid,
                    userForm.displayName || userForm.email,
                    `Created user with role: ${userForm.role}`
                );
                setSuccessMessage('User created successfully');
                setShowAddUserModal(false);
                setUserStep(1);
                setUserForm({ email: '', password: '', displayName: '', role: 'staff', phone: '', permissions: {} });
            } else { setError(authResult.error); }
        } catch (err) { setError(err.message); }
        finally { setActionLoading(false); }
    };

    const handleUpdateStaff = async (e) => {
        e.preventDefault();
        if (!selectedItem) return;
        setActionLoading(true); setError(null);
        try {
            const result = await window.FirebaseServices.staffService.updateStaff(selectedItem.id, staffForm);
            if (result.success) { setSuccessMessage('Staff updated'); setShowEditModal(false); setSelectedItem(null); }
            else { setError(result.error); }
        } catch (err) { setError(err.message); }
        finally { setActionLoading(false); }
    };

    const handleUpdateUser = async (userId, updates) => {
        try {
            const result = await window.FirebaseServices.userService.updateUserProfile(userId, updates);
            if (result.success) setSuccessMessage('User updated');
            else setError(result.error);
        } catch (err) { setError(err.message); }
    };

    // Delete user state
    const [showDeleteUserModal, setShowDeleteUserModal] = useState(false);
    const [userToDelete, setUserToDelete] = useState(null);

    // Open delete confirmation modal
    const handleDeleteUserClick = (user) => {
        setUserToDelete(user);
        setShowDeleteUserModal(true);
    };

    // Confirm delete user
    const handleConfirmDeleteUser = async () => {
        if (!userToDelete) return;
        setActionLoading(true);
        setError(null);
        try {
            const result = await window.FirebaseServices.userService.deleteUserProfile(userToDelete.id);
            if (result.success) {
                setSuccessMessage(`User ${userToDelete.displayName || userToDelete.email} deleted successfully`);
                setShowDeleteUserModal(false);
                setUserToDelete(null);
            } else {
                setError(result.error);
            }
        } catch (err) {
            setError(err.message);
        } finally {
            setActionLoading(false);
        }
    };

    // Open edit user modal
    const handleEditUser = (user) => {
        setSelectedUser(user);
        setEditUserForm({
            displayName: user.displayName || '',
            role: user.role || 'staff',
            phone: user.phone || '',
            permissions: user.permissions || getDefaultPermissions(user.role || 'staff')
        });
        setShowEditUserModal(true);
    };

    // Save edited user
    const handleSaveEditUser = async () => {
        if (!selectedUser) return;
        setActionLoading(true);
        setError(null);
        try {
            const result = await window.FirebaseServices.userService.updateUserProfile(selectedUser.id, {
                displayName: editUserForm.displayName,
                role: editUserForm.role,
                phone: editUserForm.phone,
                permissions: editUserForm.permissions
            });
            if (result.success) {
                setSuccessMessage('User permissions updated successfully');
                setShowEditUserModal(false);
                setSelectedUser(null);
            } else {
                setError(result.error);
            }
        } catch (err) {
            setError(err.message);
        } finally {
            setActionLoading(false);
        }
    };

    // Toggle permission for edit user form
    const toggleEditUserPermission = (moduleId, action) => {
        setEditUserForm(prev => ({
            ...prev,
            permissions: {
                ...prev.permissions,
                [moduleId]: {
                    ...prev.permissions[moduleId],
                    [action]: !prev.permissions[moduleId]?.[action]
                }
            }
        }));
    };

    // Toggle all permissions for a module
    const toggleEditUserAllModulePermissions = (moduleId, enabled) => {
        setEditUserForm(prev => ({
            ...prev,
            permissions: {
                ...prev.permissions,
                [moduleId]: { view: enabled, create: enabled, edit: enabled, delete: enabled }
            }
        }));
    };

    // Apply role preset to edit form
    const applyEditRolePreset = (role) => {
        setEditUserForm(prev => ({ ...prev, role, permissions: getDefaultPermissions(role) }));
    };

    const handleToggleStaffStatus = (staff) => {
        setSelectedItem(staff);
        setConfirmAction({
            type: 'toggle',
            title: staff.status === 'active' ? 'Deactivate Staff' : 'Activate Staff',
            message: staff.status === 'active' ? `Are you sure you want to deactivate ${staff.name}? They will no longer appear in staff assignments.` : `Are you sure you want to reactivate ${staff.name}?`,
            confirmText: staff.status === 'active' ? 'Deactivate' : 'Activate',
            confirmColor: staff.status === 'active' ? '#ef4444' : '#10b981'
        });
        setShowConfirmModal(true);
    };

    const handleDeleteStaff = (staff) => {
        setSelectedItem(staff);
        setConfirmAction({
            type: 'delete',
            title: 'Delete Staff Permanently',
            message: `Are you sure you want to permanently delete ${staff.name}? This action cannot be undone.`,
            confirmText: 'Delete Permanently',
            confirmColor: '#dc2626'
        });
        setShowConfirmModal(true);
    };

    const executeConfirmAction = async () => {
        if (!confirmAction || !selectedItem) return;
        setActionLoading(true);
        try {
            const services = window.FirebaseServices;
            if (confirmAction.type === 'toggle') {
                if (selectedItem.status === 'active') await services.staffService.deleteStaff(selectedItem.id);
                else await services.staffService.reactivateStaff(selectedItem.id);
                setSuccessMessage(selectedItem.status === 'active' ? 'Staff deactivated' : 'Staff activated');
            } else if (confirmAction.type === 'delete') {
                await services.staffService.permanentDeleteStaff(selectedItem.id);
                setSuccessMessage('Staff permanently deleted');
            }
        } catch (err) { setError(err.message); }
        finally { setActionLoading(false); setShowConfirmModal(false); setConfirmAction(null); setSelectedItem(null); }
    };

    const openEditStaff = (staff) => {
        setSelectedItem(staff);
        setStaffForm({ name: staff.name || '', role: staff.role || 'Washer', phone: staff.phone || '', email: staff.email || '', department: staff.department || 'Operations', hireDate: staff.hireDate || '', hourlyRate: staff.hourlyRate || '', emergencyContact: staff.emergencyContact || '', notes: staff.notes || '' });
        setShowEditModal(true);
    };

    const inputStyle = { width: '100%', padding: '10px 12px', border: `1px solid ${theme.border}`, fontSize: '14px', backgroundColor: theme.inputBg, color: theme.text, boxSizing: 'border-box' };
    const labelStyle = { display: 'block', fontSize: '13px', fontWeight: '500', color: theme.text, marginBottom: '6px' };

    return (
        <div style={{ padding: '20px' }}>
            {error && <div style={{ background: '#fef2f2', border: '1px solid #fecaca', color: '#dc2626', padding: '12px 16px', marginBottom: '16px', display: 'flex', justifyContent: 'space-between' }}><span>{error}</span><button onClick={() => setError(null)} style={{ background: 'none', border: 'none', cursor: 'pointer', fontSize: '18px' }}>√ó</button></div>}
            {successMessage && <div style={{ background: '#f0fdf4', border: '1px solid #bbf7d0', color: '#16a34a', padding: '12px 16px', marginBottom: '16px' }}>{successMessage}</div>}

            <div style={{ display: 'flex', gap: '0', marginBottom: '20px', borderBottom: `2px solid ${theme.border}` }}>
                <button onClick={() => setActiveTab('staff')} style={{ padding: '12px 24px', border: 'none', background: activeTab === 'staff' ? '#3b82f6' : 'transparent', color: activeTab === 'staff' ? 'white' : theme.textSecondary, fontWeight: '600', cursor: 'pointer', borderRadius: '8px 8px 0 0' }}>üë∑ Staff ({staffList.filter(s => s.status === 'active').length})</button>
                <button onClick={() => setActiveTab('users')} style={{ padding: '12px 24px', border: 'none', background: activeTab === 'users' ? '#3b82f6' : 'transparent', color: activeTab === 'users' ? 'white' : theme.textSecondary, fontWeight: '600', cursor: 'pointer', borderRadius: '8px 8px 0 0' }}>üîê Users ({usersList.filter(u => u.isActive).length})</button>
                <button onClick={() => setActiveTab('audit')} style={{ padding: '12px 24px', border: 'none', background: activeTab === 'audit' ? '#3b82f6' : 'transparent', color: activeTab === 'audit' ? 'white' : theme.textSecondary, fontWeight: '600', cursor: 'pointer', borderRadius: '8px 8px 0 0' }}>üìú Audit Logs</button>
            </div>

            <div style={{ display: 'flex', gap: '12px', marginBottom: '20px', flexWrap: 'wrap', alignItems: 'center' }}>
                <input type="text" placeholder={`Search ${activeTab}...`} value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} style={{ ...inputStyle, maxWidth: '300px' }} />
                <select value={filterStatus} onChange={(e) => setFilterStatus(e.target.value)} style={{ ...inputStyle, maxWidth: '150px' }}>
                    <option value="active">Active</option><option value="inactive">Inactive</option><option value="all">All</option>
                </select>
                <div style={{ flex: 1 }}></div>
                {activeTab === 'staff' && <button onClick={() => setShowAddStaffModal(true)} style={{ padding: '10px 20px', background: '#3b82f6', color: 'white', border: 'none', fontWeight: '600', cursor: 'pointer' }}>+ Add Staff</button>}
                {activeTab === 'users' && <button onClick={() => setShowAddUserModal(true)} style={{ padding: '10px 20px', background: '#8b5cf6', color: 'white', border: 'none', fontWeight: '600', cursor: 'pointer' }}>+ Add User</button>}
            </div>

            {activeTab === 'staff' && (
                <div style={{ background: theme.bg, border: `1px solid ${theme.border}` }}>
                    {loading ? <div style={{ padding: '40px', textAlign: 'center', color: theme.textSecondary }}>Loading...</div> : filteredStaff.length === 0 ? (
                        <div style={{ padding: '60px', textAlign: 'center' }}><div style={{ fontSize: '48px', marginBottom: '16px' }}>üë∑</div><p style={{ color: theme.textSecondary }}>No staff found</p><button onClick={() => setShowAddStaffModal(true)} style={{ padding: '10px 20px', background: '#3b82f6', color: 'white', border: 'none', fontWeight: '600', cursor: 'pointer', marginTop: '12px' }}>Add Staff</button></div>
                    ) : (
                        <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                            <thead><tr style={{ background: theme.bgSecondary }}><th style={{ padding: '12px 16px', textAlign: 'left', fontWeight: '600', color: theme.text, borderBottom: `1px solid ${theme.border}` }}>Name</th><th style={{ padding: '12px 16px', textAlign: 'left', fontWeight: '600', color: theme.text, borderBottom: `1px solid ${theme.border}` }}>Role</th><th style={{ padding: '12px 16px', textAlign: 'left', fontWeight: '600', color: theme.text, borderBottom: `1px solid ${theme.border}` }}>Department</th><th style={{ padding: '12px 16px', textAlign: 'left', fontWeight: '600', color: theme.text, borderBottom: `1px solid ${theme.border}` }}>Phone</th><th style={{ padding: '12px 16px', textAlign: 'left', fontWeight: '600', color: theme.text, borderBottom: `1px solid ${theme.border}` }}>Status</th><th style={{ padding: '12px 16px', textAlign: 'center', fontWeight: '600', color: theme.text, borderBottom: `1px solid ${theme.border}` }}>Actions</th></tr></thead>
                            <tbody>
                                {filteredStaff.map(staff => (
                                    <tr key={staff.id} style={{ borderBottom: `1px solid ${theme.border}` }}>
                                        <td style={{ padding: '12px 16px', color: theme.text }}><div style={{ fontWeight: '600' }}>{staff.name}</div>{staff.email && <div style={{ fontSize: '12px', color: theme.textSecondary }}>{staff.email}</div>}</td>
                                        <td style={{ padding: '12px 16px', color: theme.text }}>{staff.role}</td>
                                        <td style={{ padding: '12px 16px', color: theme.textSecondary }}>{staff.department || '-'}</td>
                                        <td style={{ padding: '12px 16px', color: theme.textSecondary }}>{staff.phone || '-'}</td>
                                        <td style={{ padding: '12px 16px' }}><span style={{ padding: '4px 12px', fontSize: '12px', fontWeight: '600', background: staff.status === 'active' ? '#d1fae5' : '#fee2e2', color: staff.status === 'active' ? '#059669' : '#dc2626' }}>{staff.status === 'active' ? 'Active' : 'Inactive'}</span></td>
                                        <td style={{ padding: '12px 16px', textAlign: 'center' }}>
                                            <button onClick={() => openEditStaff(staff)} style={{ padding: '6px 12px', background: '#3b82f6', color: 'white', border: 'none', cursor: 'pointer', marginRight: '8px', fontSize: '12px' }}>Edit</button>
                                            <button onClick={() => handleToggleStaffStatus(staff)} style={{ padding: '6px 12px', background: staff.status === 'active' ? '#f59e0b' : '#10b981', color: 'white', border: 'none', cursor: 'pointer', marginRight: '8px', fontSize: '12px' }}>{staff.status === 'active' ? 'Deactivate' : 'Activate'}</button>
                                            <button onClick={() => handleDeleteStaff(staff)} style={{ padding: '6px 12px', background: '#dc2626', color: 'white', border: 'none', cursor: 'pointer', fontSize: '12px' }}>Delete</button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    )}
                </div>
            )}

            {activeTab === 'users' && (
                <div style={{ background: theme.bg, border: `1px solid ${theme.border}` }}>
                    {filteredUsers.length === 0 ? (
                        <div style={{ padding: '60px', textAlign: 'center' }}><div style={{ fontSize: '48px', marginBottom: '16px' }}>üîê</div><p style={{ color: theme.textSecondary }}>No users found</p><button onClick={() => setShowAddUserModal(true)} style={{ padding: '10px 20px', background: '#8b5cf6', color: 'white', border: 'none', fontWeight: '600', cursor: 'pointer', marginTop: '12px' }}>Add User</button></div>
                    ) : (
                        <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                            <thead><tr style={{ background: theme.bgSecondary }}><th style={{ padding: '12px 16px', textAlign: 'left', fontWeight: '600', color: theme.text, borderBottom: `1px solid ${theme.border}` }}>User</th><th style={{ padding: '12px 16px', textAlign: 'left', fontWeight: '600', color: theme.text, borderBottom: `1px solid ${theme.border}` }}>Role</th><th style={{ padding: '12px 16px', textAlign: 'left', fontWeight: '600', color: theme.text, borderBottom: `1px solid ${theme.border}` }}>Description</th><th style={{ padding: '12px 16px', textAlign: 'left', fontWeight: '600', color: theme.text, borderBottom: `1px solid ${theme.border}` }}>Status</th><th style={{ padding: '12px 16px', textAlign: 'center', fontWeight: '600', color: theme.text, borderBottom: `1px solid ${theme.border}` }}>Actions</th></tr></thead>
                            <tbody>
                                {filteredUsers.map(user => {
                                    const roleInfo = USER_ROLES.find(r => r.id === user.role) || { label: user.role, desc: '' };
                                    return (
                                        <tr key={user.id} style={{ borderBottom: `1px solid ${theme.border}` }}>
                                            <td style={{ padding: '12px 16px', color: theme.text }}><div style={{ fontWeight: '600' }}>{user.displayName || user.email?.split('@')[0]}</div><div style={{ fontSize: '12px', color: theme.textSecondary }}>{user.email}</div></td>
                                            <td style={{ padding: '12px 16px' }}><span style={{ padding: '4px 10px', background: user.role === 'admin' ? '#8b5cf620' : '#3b82f620', color: user.role === 'admin' ? '#8b5cf6' : '#3b82f6', fontWeight: '600', fontSize: '12px' }}>{roleInfo.label}</span></td>
                                            <td style={{ padding: '12px 16px', color: theme.textSecondary, fontSize: '13px' }}>{roleInfo.desc}</td>
                                            <td style={{ padding: '12px 16px' }}><span style={{ padding: '4px 12px', fontSize: '12px', fontWeight: '600', background: user.isActive ? '#d1fae5' : '#fee2e2', color: user.isActive ? '#059669' : '#dc2626' }}>{user.isActive ? 'Active' : 'Inactive'}</span></td>
                                            <td style={{ padding: '12px 16px', textAlign: 'center', display: 'flex', gap: '8px', justifyContent: 'center' }}>
                                                <button onClick={() => handleEditUser(user)} style={{ padding: '6px 12px', background: '#3b82f6', color: 'white', border: 'none', cursor: 'pointer', fontSize: '12px', borderRadius: '4px' }}>‚úèÔ∏è Edit</button>
                                                <button onClick={() => handleUpdateUser(user.id, { isActive: !user.isActive })} style={{ padding: '6px 12px', background: user.isActive ? '#f59e0b' : '#10b981', color: 'white', border: 'none', cursor: 'pointer', fontSize: '12px', borderRadius: '4px' }}>{user.isActive ? '‚è∏Ô∏è Deactivate' : '‚úÖ Activate'}</button>
                                                <button onClick={() => handleDeleteUserClick(user)} style={{ padding: '6px 12px', background: '#ef4444', color: 'white', border: 'none', cursor: 'pointer', fontSize: '12px', borderRadius: '4px' }}>üóëÔ∏è Delete</button>
                                            </td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    )}
                </div>
            )}

            {activeTab === 'audit' && (
                <div>
                    <div style={{ display: 'flex', gap: '12px', marginBottom: '16px', flexWrap: 'wrap', alignItems: 'center' }}>
                        <input type="text" placeholder={'Search logs...'} value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} style={{ ...inputStyle, maxWidth: '250px', borderRadius: '8px' }} />
                        <select value={auditFilter.action} onChange={(e) => setAuditFilter(prev => ({ ...prev, action: e.target.value }))} style={{ ...inputStyle, maxWidth: '150px', borderRadius: '8px' }}>
                            <option value="">All Actions</option>
                            <option value="login">Login</option>
                            <option value="logout">Logout</option>
                            <option value="create">Create</option>
                            <option value="update">Update</option>
                            <option value="delete">Delete</option>
                            <option value="view">View</option>
                        </select>
                        <select value={auditFilter.module} onChange={(e) => setAuditFilter(prev => ({ ...prev, module: e.target.value }))} style={{ ...inputStyle, maxWidth: '180px', borderRadius: '8px' }}>
                            <option value="">All Modules</option>
                            <option value="auth">Authentication</option>
                            <option value="staff">Staff</option>
                            <option value="users">Users</option>
                            <option value="customers">Customers</option>
                            <option value="vehicles">Vehicles</option>
                            <option value="billing">Billing</option>
                            <option value="settings">Settings</option>
                        </select>
                        <div style={{ flex: 1 }}></div>
                        <div style={{ color: theme.textSecondary, fontSize: '13px' }}>Showing {filteredAuditLogs.length} of {auditLogs.length} logs</div>
                    </div>

                    <div style={{ background: theme.bg, border: `1px solid ${theme.border}`, borderRadius: '10px', overflow: 'hidden' }}>
                        {filteredAuditLogs.length === 0 ? (
                            <div style={{ padding: '60px', textAlign: 'center' }}>
                                <div style={{ fontSize: '48px', marginBottom: '16px' }}>üìã</div>
                                <p style={{ color: theme.textSecondary }}>No audit logs found</p>
                                <p style={{ color: theme.textSecondary, fontSize: '13px' }}>System activity will appear here once users start interacting</p>
                            </div>
                        ) : (
                            <div style={{ maxHeight: '600px', overflow: 'auto' }}>
                                {filteredAuditLogs.map((log, idx) => (
                                    <div key={log.id || idx} style={{ padding: '16px 20px', borderBottom: `1px solid ${theme.border}`, display: 'flex', gap: '16px', alignItems: 'flex-start', background: idx % 2 === 0 ? 'transparent' : theme.bgSecondary }}>
                                        <div style={{ width: '40px', height: '40px', borderRadius: '50%', background: `${getActionColor(log.action)}20`, display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '18px', flexShrink: 0 }}>
                                            {getActionIcon(log.action)}
                                        </div>
                                        <div style={{ flex: 1, minWidth: 0 }}>
                                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', gap: '12px', flexWrap: 'wrap' }}>
                                                <div>
                                                    <span style={{ fontWeight: '600', color: theme.text }}>{log.userName || 'Unknown'}</span>
                                                    <span style={{ color: theme.textSecondary }}> performed </span>
                                                    <span style={{ padding: '2px 8px', borderRadius: '4px', fontSize: '12px', fontWeight: '600', background: `${getActionColor(log.action)}20`, color: getActionColor(log.action) }}>{log.action?.toUpperCase()}</span>
                                                    <span style={{ color: theme.textSecondary }}> on </span>
                                                    <span style={{ fontWeight: '500', color: theme.text }}>{log.module}</span>
                                                    {log.targetName && <span style={{ color: theme.textSecondary }}> ({log.targetName})</span>}
                                                </div>
                                                <div style={{ fontSize: '12px', color: theme.textSecondary, whiteSpace: 'nowrap' }}>{formatTimeAgo(log.timestamp)}</div>
                                            </div>
                                            {log.details && <div style={{ marginTop: '6px', fontSize: '13px', color: theme.textSecondary }}>{log.details}</div>}
                                            <div style={{ marginTop: '6px', fontSize: '11px', color: theme.textSecondary }}>
                                                <span>{log.userEmail}</span>
                                                <span style={{ margin: '0 8px' }}>‚Ä¢</span>
                                                <span>{new Date(log.timestamp).toLocaleString()}</span>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            )}

            {showAddStaffModal && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 }} onClick={() => setShowAddStaffModal(false)}>
                    <div style={{ background: theme.bg, width: '100%', maxWidth: '500px', maxHeight: '90vh', overflow: 'auto', margin: '20px', borderRadius: '12px', boxShadow: '0 25px 50px -12px rgba(0,0,0,0.25)' }} onClick={e => e.stopPropagation()}>
                        <div style={{ padding: '20px', borderBottom: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'space-between', borderRadius: '12px 12px 0 0' }}><h2 style={{ margin: 0, color: theme.text }}>Add Staff Member</h2><button onClick={() => setShowAddStaffModal(false)} style={{ background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer', color: theme.textSecondary }}>√ó</button></div>
                        <form onSubmit={handleAddStaff} style={{ padding: '20px' }}>
                            <div style={{ display: 'grid', gap: '16px' }}>
                                <div><label style={labelStyle}>Name *</label><input type="text" value={staffForm.name} onChange={e => setStaffForm({...staffForm, name: e.target.value})} style={{...inputStyle, borderRadius: '8px'}} required /></div>
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' }}><div><label style={labelStyle}>Role</label><select value={staffForm.role} onChange={e => setStaffForm({...staffForm, role: e.target.value})} style={{...inputStyle, borderRadius: '8px'}}>{STAFF_ROLES.map(r => <option key={r} value={r}>{r}</option>)}</select></div><div><label style={labelStyle}>Department</label><select value={staffForm.department} onChange={e => setStaffForm({...staffForm, department: e.target.value})} style={{...inputStyle, borderRadius: '8px'}}>{DEPARTMENTS.map(d => <option key={d} value={d}>{d}</option>)}</select></div></div>
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' }}><div><label style={labelStyle}>Phone</label><input type="tel" value={staffForm.phone} onChange={e => setStaffForm({...staffForm, phone: e.target.value})} style={{...inputStyle, borderRadius: '8px'}} /></div><div><label style={labelStyle}>Email</label><input type="email" value={staffForm.email} onChange={e => setStaffForm({...staffForm, email: e.target.value})} style={{...inputStyle, borderRadius: '8px'}} /></div></div>
                            </div>
                            <div style={{ display: 'flex', gap: '12px', marginTop: '24px' }}><button type="button" onClick={() => setShowAddStaffModal(false)} style={{ flex: 1, padding: '12px', border: `1px solid ${theme.border}`, background: 'transparent', color: theme.text, cursor: 'pointer', borderRadius: '8px' }}>Cancel</button><button type="submit" disabled={actionLoading} style={{ flex: 1, padding: '12px', border: 'none', background: '#3b82f6', color: 'white', fontWeight: '600', cursor: actionLoading ? 'wait' : 'pointer', borderRadius: '8px' }}>{actionLoading ? 'Adding...' : 'Add Staff'}</button></div>
                        </form>
                    </div>
                </div>
            )}

            {showAddUserModal && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.6)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 }} onClick={() => { setShowAddUserModal(false); setUserStep(1); }}>
                    <div style={{ background: theme.bg, width: '100%', maxWidth: '800px', maxHeight: '90vh', overflow: 'auto', margin: '20px', borderRadius: '16px', boxShadow: '0 25px 50px -12px rgba(0,0,0,0.25)' }} onClick={e => e.stopPropagation()}>
                        <div style={{ padding: '20px 24px', borderBottom: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <div>
                                <h2 style={{ margin: 0, color: theme.text, fontSize: '20px' }}>Add System User</h2>
                                <p style={{ margin: '4px 0 0', color: theme.textSecondary, fontSize: '13px' }}>Step {userStep} of 2: {userStep === 1 ? 'User Details' : 'Module Permissions'}</p>
                            </div>
                            <button onClick={() => { setShowAddUserModal(false); setUserStep(1); }} style={{ background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer', color: theme.textSecondary }}>√ó</button>
                        </div>

                        <div style={{ display: 'flex', padding: '0 24px', borderBottom: `1px solid ${theme.border}` }}>
                            <button onClick={() => setUserStep(1)} style={{ padding: '16px 24px', border: 'none', background: 'transparent', color: userStep === 1 ? '#8b5cf6' : theme.textSecondary, fontWeight: '600', cursor: 'pointer', borderBottom: userStep === 1 ? '2px solid #8b5cf6' : '2px solid transparent', marginBottom: '-1px' }}>1. User Details</button>
                            <button onClick={() => userStep === 1 && userForm.email && userForm.password ? setUserStep(2) : null} style={{ padding: '16px 24px', border: 'none', background: 'transparent', color: userStep === 2 ? '#8b5cf6' : theme.textSecondary, fontWeight: '600', cursor: userForm.email && userForm.password ? 'pointer' : 'not-allowed', borderBottom: userStep === 2 ? '2px solid #8b5cf6' : '2px solid transparent', marginBottom: '-1px', opacity: userForm.email && userForm.password ? 1 : 0.5 }}>2. Permissions</button>
                        </div>

                        {userStep === 1 && (
                            <div style={{ padding: '24px' }}>
                                <div style={{ background: '#fef3c7', border: '1px solid #fbbf24', padding: '12px 16px', marginBottom: '24px', fontSize: '13px', color: '#92400e', borderRadius: '8px', display: 'flex', alignItems: 'center', gap: '10px' }}>
                                    <span style={{ fontSize: '18px' }}>üí°</span>
                                    <span><strong>Note:</strong> System users can log into the application with assigned role-based permissions.</span>
                                </div>
                                <div style={{ display: 'grid', gap: '20px' }}>
                                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px' }}>
                                        <div><label style={labelStyle}>Email Address *</label><input type="email" value={userForm.email} onChange={e => setUserForm({...userForm, email: e.target.value})} style={{...inputStyle, borderRadius: '8px'}} placeholder="user@example.com" required /></div>
                                        <div><label style={labelStyle}>Password *</label><input type="password" value={userForm.password} onChange={e => setUserForm({...userForm, password: e.target.value})} style={{...inputStyle, borderRadius: '8px'}} placeholder="Min 6 characters" required /></div>
                                    </div>
                                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px' }}>
                                        <div><label style={labelStyle}>Display Name</label><input type="text" value={userForm.displayName} onChange={e => setUserForm({...userForm, displayName: e.target.value})} style={{...inputStyle, borderRadius: '8px'}} placeholder="Full name" /></div>
                                        <div><label style={labelStyle}>Phone Number</label><input type="tel" value={userForm.phone} onChange={e => setUserForm({...userForm, phone: e.target.value})} style={{...inputStyle, borderRadius: '8px'}} placeholder="+1234567890" /></div>
                                    </div>
                                    <div>
                                        <label style={labelStyle}>Role Preset</label>
                                        <p style={{ margin: '0 0 12px', color: theme.textSecondary, fontSize: '12px' }}>Select a role to apply default permissions (can be customized in next step)</p>
                                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '10px' }}>
                                            {USER_ROLES.map(r => (
                                                <button key={r.id} type="button" onClick={() => applyRolePreset(r.id)} style={{ padding: '12px', border: `2px solid ${userForm.role === r.id ? '#8b5cf6' : theme.border}`, background: userForm.role === r.id ? '#f3e8ff' : 'transparent', borderRadius: '10px', cursor: 'pointer', textAlign: 'left' }}>
                                                    <div style={{ fontWeight: '600', color: userForm.role === r.id ? '#8b5cf6' : theme.text, fontSize: '14px' }}>{r.label}</div>
                                                    <div style={{ fontSize: '11px', color: theme.textSecondary, marginTop: '2px' }}>{r.desc}</div>
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                                <div style={{ display: 'flex', gap: '12px', marginTop: '24px' }}>
                                    <button type="button" onClick={() => { setShowAddUserModal(false); setUserStep(1); }} style={{ flex: 1, padding: '14px', border: `1px solid ${theme.border}`, background: 'transparent', color: theme.text, cursor: 'pointer', borderRadius: '8px', fontWeight: '500' }}>Cancel</button>
                                    <button type="button" onClick={() => { if (userForm.email && userForm.password && userForm.password.length >= 6) { if (Object.keys(userForm.permissions).length === 0) applyRolePreset(userForm.role); setUserStep(2); } else { setError('Email and password (min 6 chars) required'); } }} style={{ flex: 1, padding: '14px', border: 'none', background: '#8b5cf6', color: 'white', fontWeight: '600', cursor: 'pointer', borderRadius: '8px' }}>Next: Set Permissions ‚Üí</button>
                                </div>
                            </div>
                        )}

                        {userStep === 2 && (
                            <div style={{ padding: '24px' }}>
                                <div style={{ marginBottom: '20px', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                    <div>
                                        <h3 style={{ margin: 0, color: theme.text, fontSize: '16px' }}>Module Permissions for {userForm.displayName || userForm.email}</h3>
                                        <p style={{ margin: '4px 0 0', color: theme.textSecondary, fontSize: '13px' }}>Configure which modules this user can access and what actions they can perform</p>
                                    </div>
                                    <div style={{ display: 'flex', gap: '8px' }}>
                                        <button type="button" onClick={() => { const perms = {}; ALL_MODULES.forEach(m => perms[m.id] = { view: true, create: true, edit: true, delete: true }); setUserForm(prev => ({ ...prev, permissions: perms })); }} style={{ padding: '8px 12px', fontSize: '12px', border: `1px solid ${theme.border}`, background: 'transparent', color: theme.text, cursor: 'pointer', borderRadius: '6px' }}>Select All</button>
                                        <button type="button" onClick={() => { const perms = {}; ALL_MODULES.forEach(m => perms[m.id] = { view: false, create: false, edit: false, delete: false }); setUserForm(prev => ({ ...prev, permissions: perms })); }} style={{ padding: '8px 12px', fontSize: '12px', border: `1px solid ${theme.border}`, background: 'transparent', color: theme.text, cursor: 'pointer', borderRadius: '6px' }}>Clear All</button>
                                    </div>
                                </div>

                                <div style={{ maxHeight: '400px', overflow: 'auto', border: `1px solid ${theme.border}`, borderRadius: '10px' }}>
                                    <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                                        <thead style={{ position: 'sticky', top: 0, background: theme.bgSecondary, zIndex: 1 }}>
                                            <tr>
                                                <th style={{ padding: '12px 16px', textAlign: 'left', fontWeight: '600', color: theme.text, borderBottom: `1px solid ${theme.border}`, width: '40%' }}>Module</th>
                                                {PERMISSION_ACTIONS.map(a => <th key={a.id} style={{ padding: '12px 8px', textAlign: 'center', fontWeight: '600', color: theme.text, borderBottom: `1px solid ${theme.border}`, width: '15%' }}><span title={a.label}>{a.icon} {a.label}</span></th>)}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {ALL_MODULES.map((mod, idx) => {
                                                const perms = userForm.permissions[mod.id] || {};
                                                const allChecked = perms.view && perms.create && perms.edit && perms.delete;
                                                return (
                                                    <tr key={mod.id} style={{ background: idx % 2 === 0 ? 'transparent' : theme.bgSecondary }}>
                                                        <td style={{ padding: '10px 16px', borderBottom: `1px solid ${theme.border}` }}>
                                                            <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                                                                <span style={{ fontSize: '18px' }}>{mod.icon}</span>
                                                                <div>
                                                                    <div style={{ fontWeight: '500', color: theme.text, fontSize: '13px' }}>{mod.label}</div>
                                                                    <div style={{ fontSize: '11px', color: theme.textSecondary }}>{mod.category}</div>
                                                                </div>
                                                            </div>
                                                        </td>
                                                        {PERMISSION_ACTIONS.map(a => (
                                                            <td key={a.id} style={{ padding: '10px 8px', textAlign: 'center', borderBottom: `1px solid ${theme.border}` }}>
                                                                <input type="checkbox" checked={perms[a.id] || false} onChange={() => toggleModulePermission(mod.id, a.id)} style={{ width: '18px', height: '18px', cursor: 'pointer', accentColor: '#8b5cf6' }} />
                                                            </td>
                                                        ))}
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>

                                <div style={{ display: 'flex', gap: '12px', marginTop: '24px' }}>
                                    <button type="button" onClick={() => setUserStep(1)} style={{ padding: '14px 24px', border: `1px solid ${theme.border}`, background: 'transparent', color: theme.text, cursor: 'pointer', borderRadius: '8px', fontWeight: '500' }}>‚Üê Back</button>
                                    <div style={{ flex: 1 }}></div>
                                    <button type="button" onClick={() => { setShowAddUserModal(false); setUserStep(1); }} style={{ padding: '14px 24px', border: `1px solid ${theme.border}`, background: 'transparent', color: theme.text, cursor: 'pointer', borderRadius: '8px', fontWeight: '500' }}>Cancel</button>
                                    <button type="button" onClick={handleAddUser} disabled={actionLoading} style={{ padding: '14px 32px', border: 'none', background: '#8b5cf6', color: 'white', fontWeight: '600', cursor: actionLoading ? 'wait' : 'pointer', borderRadius: '8px' }}>{actionLoading ? 'Creating User...' : '‚úì Create User'}</button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            )}

            {/* Edit User Modal */}
            {showEditUserModal && selectedUser && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.6)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 }} onClick={() => setShowEditUserModal(false)}>
                    <div style={{ background: theme.bg, width: '100%', maxWidth: '900px', maxHeight: '90vh', overflow: 'auto', margin: '20px', borderRadius: '16px', boxShadow: '0 25px 50px -12px rgba(0,0,0,0.25)' }} onClick={e => e.stopPropagation()}>
                        <div style={{ padding: '20px 24px', borderBottom: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <div>
                                <h2 style={{ margin: 0, color: theme.text, fontSize: '20px' }}>Edit User: {selectedUser.displayName || selectedUser.email}</h2>
                                <p style={{ margin: '4px 0 0', color: theme.textSecondary, fontSize: '13px' }}>Manage user details and module permissions</p>
                            </div>
                            <button onClick={() => setShowEditUserModal(false)} style={{ background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer', color: theme.textSecondary }}>√ó</button>
                        </div>

                        <div style={{ padding: '24px' }}>
                            {/* User Details Section */}
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '16px', marginBottom: '24px' }}>
                                <div>
                                    <label style={labelStyle}>Display Name</label>
                                    <input type="text" value={editUserForm.displayName} onChange={e => setEditUserForm({...editUserForm, displayName: e.target.value})} style={{...inputStyle, borderRadius: '8px'}} placeholder="Full name" />
                                </div>
                                <div>
                                    <label style={labelStyle}>Phone Number</label>
                                    <input type="tel" value={editUserForm.phone} onChange={e => setEditUserForm({...editUserForm, phone: e.target.value})} style={{...inputStyle, borderRadius: '8px'}} placeholder="+1234567890" />
                                </div>
                                <div>
                                    <label style={labelStyle}>Role Preset</label>
                                    <select value={editUserForm.role} onChange={e => applyEditRolePreset(e.target.value)} style={{...inputStyle, borderRadius: '8px'}}>
                                        {USER_ROLES.map(r => <option key={r.id} value={r.id}>{r.label} - {r.desc}</option>)}
                                    </select>
                                </div>
                            </div>

                            {/* Permissions Section */}
                            <div style={{ marginBottom: '20px', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                <div>
                                    <h3 style={{ margin: 0, color: theme.text, fontSize: '16px' }}>Module Permissions</h3>
                                    <p style={{ margin: '4px 0 0', color: theme.textSecondary, fontSize: '13px' }}>Configure which modules this user can access</p>
                                </div>
                                <div style={{ display: 'flex', gap: '8px' }}>
                                    <button type="button" onClick={() => { const perms = {}; ALL_MODULES.forEach(m => perms[m.id] = { view: true, create: true, edit: true, delete: true }); setEditUserForm(prev => ({ ...prev, permissions: perms })); }} style={{ padding: '8px 12px', fontSize: '12px', border: `1px solid ${theme.border}`, background: 'transparent', color: theme.text, cursor: 'pointer', borderRadius: '6px' }}>Select All</button>
                                    <button type="button" onClick={() => { const perms = {}; ALL_MODULES.forEach(m => perms[m.id] = { view: false, create: false, edit: false, delete: false }); setEditUserForm(prev => ({ ...prev, permissions: perms })); }} style={{ padding: '8px 12px', fontSize: '12px', border: `1px solid ${theme.border}`, background: 'transparent', color: theme.text, cursor: 'pointer', borderRadius: '6px' }}>Clear All</button>
                                </div>
                            </div>

                            <div style={{ maxHeight: '350px', overflow: 'auto', border: `1px solid ${theme.border}`, borderRadius: '10px' }}>
                                <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                                    <thead style={{ position: 'sticky', top: 0, background: theme.bgSecondary, zIndex: 1 }}>
                                        <tr>
                                            <th style={{ padding: '12px 16px', textAlign: 'left', fontWeight: '600', color: theme.text, borderBottom: `1px solid ${theme.border}`, width: '35%' }}>Module</th>
                                            <th style={{ padding: '12px 8px', textAlign: 'center', fontWeight: '600', color: theme.text, borderBottom: `1px solid ${theme.border}`, width: '10%' }}>All</th>
                                            {PERMISSION_ACTIONS.map(a => <th key={a.id} style={{ padding: '12px 8px', textAlign: 'center', fontWeight: '600', color: theme.text, borderBottom: `1px solid ${theme.border}`, width: '12%' }}><span title={a.label}>{a.icon} {a.label}</span></th>)}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {ALL_MODULES.map((mod, idx) => {
                                            const perms = editUserForm.permissions[mod.id] || {};
                                            const allChecked = perms.view && perms.create && perms.edit && perms.delete;
                                            const noneChecked = !perms.view && !perms.create && !perms.edit && !perms.delete;
                                            return (
                                                <tr key={mod.id} style={{ background: idx % 2 === 0 ? 'transparent' : theme.bgSecondary }}>
                                                    <td style={{ padding: '10px 16px', borderBottom: `1px solid ${theme.border}` }}>
                                                        <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                                                            <span style={{ fontSize: '18px' }}>{mod.icon}</span>
                                                            <div>
                                                                <div style={{ fontWeight: '500', color: theme.text, fontSize: '13px' }}>{mod.label}</div>
                                                                <div style={{ fontSize: '11px', color: theme.textSecondary }}>{mod.category}</div>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td style={{ padding: '10px 8px', textAlign: 'center', borderBottom: `1px solid ${theme.border}` }}>
                                                        <input type="checkbox" checked={allChecked} onChange={() => toggleEditUserAllModulePermissions(mod.id, !allChecked)} style={{ width: '18px', height: '18px', cursor: 'pointer', accentColor: '#10b981' }} />
                                                    </td>
                                                    {PERMISSION_ACTIONS.map(a => (
                                                        <td key={a.id} style={{ padding: '10px 8px', textAlign: 'center', borderBottom: `1px solid ${theme.border}` }}>
                                                            <input type="checkbox" checked={perms[a.id] || false} onChange={() => toggleEditUserPermission(mod.id, a.id)} style={{ width: '18px', height: '18px', cursor: 'pointer', accentColor: '#8b5cf6' }} />
                                                        </td>
                                                    ))}
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>

                            <div style={{ display: 'flex', gap: '12px', marginTop: '24px' }}>
                                <button type="button" onClick={() => setShowEditUserModal(false)} style={{ flex: 1, padding: '14px', border: `1px solid ${theme.border}`, background: 'transparent', color: theme.text, cursor: 'pointer', borderRadius: '8px', fontWeight: '500' }}>Cancel</button>
                                <button type="button" onClick={handleSaveEditUser} disabled={actionLoading} style={{ flex: 1, padding: '14px', border: 'none', background: '#8b5cf6', color: 'white', fontWeight: '600', cursor: actionLoading ? 'wait' : 'pointer', borderRadius: '8px' }}>{actionLoading ? 'Saving...' : '‚úì Save Changes'}</button>
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* Delete User Confirmation Modal */}
            {showDeleteUserModal && userToDelete && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.6)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1100, backdropFilter: 'blur(4px)' }} onClick={() => { setShowDeleteUserModal(false); setUserToDelete(null); }}>
                    <div style={{ background: theme.bg, width: '100%', maxWidth: '420px', margin: '20px', borderRadius: '16px', boxShadow: '0 25px 50px -12px rgba(0,0,0,0.4)', overflow: 'hidden' }} onClick={e => e.stopPropagation()}>
                        <div style={{ padding: '24px', textAlign: 'center' }}>
                            <div style={{ width: '64px', height: '64px', borderRadius: '50%', background: '#fef2f2', display: 'flex', alignItems: 'center', justifyContent: 'center', margin: '0 auto 20px', fontSize: '32px' }}>üóëÔ∏è</div>
                            <h3 style={{ margin: '0 0 12px', fontSize: '20px', fontWeight: '700', color: theme.text }}>Delete User</h3>
                            <p style={{ margin: '0 0 8px', fontSize: '15px', color: theme.textSecondary, lineHeight: '1.6' }}>Are you sure you want to permanently delete</p>
                            <p style={{ margin: '0 0 8px', fontSize: '16px', fontWeight: '600', color: theme.text }}>"{userToDelete.displayName || userToDelete.email}"?</p>
                            <p style={{ margin: '0 0 24px', fontSize: '13px', color: '#ef4444', fontWeight: '500' }}>‚ö†Ô∏è This action cannot be undone.</p>
                            <div style={{ display: 'flex', gap: '12px' }}>
                                <button onClick={() => { setShowDeleteUserModal(false); setUserToDelete(null); }} style={{ flex: 1, padding: '12px 20px', background: 'transparent', color: theme.text, border: `1px solid ${theme.border}`, borderRadius: '8px', fontSize: '14px', fontWeight: '600', cursor: 'pointer' }}>Cancel</button>
                                <button onClick={handleConfirmDeleteUser} disabled={actionLoading} style={{ flex: 1, padding: '12px 20px', background: '#ef4444', color: 'white', border: 'none', borderRadius: '8px', fontSize: '14px', fontWeight: '600', cursor: actionLoading ? 'wait' : 'pointer' }}>{actionLoading ? 'Deleting...' : 'Delete User'}</button>
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {showEditModal && selectedItem && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 }} onClick={() => setShowEditModal(false)}>
                    <div style={{ background: theme.bg, width: '100%', maxWidth: '500px', maxHeight: '90vh', overflow: 'auto', margin: '20px', borderRadius: '12px', boxShadow: '0 25px 50px -12px rgba(0,0,0,0.25)' }} onClick={e => e.stopPropagation()}>
                        <div style={{ padding: '20px', borderBottom: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'space-between' }}><h2 style={{ margin: 0, color: theme.text }}>Edit Staff</h2><button onClick={() => setShowEditModal(false)} style={{ background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer', color: theme.textSecondary }}>√ó</button></div>
                        <form onSubmit={handleUpdateStaff} style={{ padding: '20px' }}>
                            <div style={{ display: 'grid', gap: '16px' }}>
                                <div><label style={labelStyle}>Name *</label><input type="text" value={staffForm.name} onChange={e => setStaffForm({...staffForm, name: e.target.value})} style={inputStyle} required /></div>
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' }}><div><label style={labelStyle}>Role</label><select value={staffForm.role} onChange={e => setStaffForm({...staffForm, role: e.target.value})} style={inputStyle}>{STAFF_ROLES.map(r => <option key={r} value={r}>{r}</option>)}</select></div><div><label style={labelStyle}>Department</label><select value={staffForm.department} onChange={e => setStaffForm({...staffForm, department: e.target.value})} style={inputStyle}>{DEPARTMENTS.map(d => <option key={d} value={d}>{d}</option>)}</select></div></div>
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' }}><div><label style={labelStyle}>Phone</label><input type="tel" value={staffForm.phone} onChange={e => setStaffForm({...staffForm, phone: e.target.value})} style={inputStyle} /></div><div><label style={labelStyle}>Email</label><input type="email" value={staffForm.email} onChange={e => setStaffForm({...staffForm, email: e.target.value})} style={inputStyle} /></div></div>
                            </div>
                            <div style={{ display: 'flex', gap: '12px', marginTop: '24px' }}><button type="button" onClick={() => setShowEditModal(false)} style={{ flex: 1, padding: '12px', border: `1px solid ${theme.border}`, background: 'transparent', color: theme.text, cursor: 'pointer', borderRadius: '8px' }}>Cancel</button><button type="submit" disabled={actionLoading} style={{ flex: 1, padding: '12px', border: 'none', background: '#3b82f6', color: 'white', fontWeight: '600', cursor: actionLoading ? 'wait' : 'pointer', borderRadius: '8px' }}>{actionLoading ? 'Saving...' : 'Save'}</button></div>
                        </form>
                    </div>
                </div>
            )}

            {showConfirmModal && confirmAction && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.6)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1100 }} onClick={() => { setShowConfirmModal(false); setConfirmAction(null); }}>
                    <div style={{ background: theme.bg, width: '100%', maxWidth: '400px', margin: '20px', borderRadius: '16px', boxShadow: '0 25px 50px -12px rgba(0,0,0,0.25)', overflow: 'hidden' }} onClick={e => e.stopPropagation()}>
                        <div style={{ padding: '24px 24px 0' }}>
                            <div style={{ width: '56px', height: '56px', borderRadius: '50%', background: confirmAction.type === 'delete' ? '#fef2f2' : '#fef3c7', display: 'flex', alignItems: 'center', justifyContent: 'center', margin: '0 auto 16px', fontSize: '24px' }}>{confirmAction.type === 'delete' ? 'üóëÔ∏è' : '‚ö†Ô∏è'}</div>
                            <h3 style={{ margin: '0 0 8px', textAlign: 'center', color: theme.text, fontSize: '18px', fontWeight: '600' }}>{confirmAction.title}</h3>
                            <p style={{ margin: 0, textAlign: 'center', color: theme.textSecondary, fontSize: '14px', lineHeight: '1.5' }}>{confirmAction.message}</p>
                        </div>
                        <div style={{ display: 'flex', gap: '12px', padding: '24px' }}>
                            <button onClick={() => { setShowConfirmModal(false); setConfirmAction(null); }} style={{ flex: 1, padding: '12px 16px', border: `1px solid ${theme.border}`, background: 'transparent', color: theme.text, cursor: 'pointer', borderRadius: '8px', fontWeight: '500', fontSize: '14px' }}>Cancel</button>
                            <button onClick={executeConfirmAction} disabled={actionLoading} style={{ flex: 1, padding: '12px 16px', border: 'none', background: confirmAction.confirmColor, color: 'white', fontWeight: '600', cursor: actionLoading ? 'wait' : 'pointer', borderRadius: '8px', fontSize: '14px' }}>{actionLoading ? 'Processing...' : confirmAction.confirmText}</button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}

// ==================== INVENTORY MODULE ====================
function InventoryModule() {
    const [items, setItems] = useState([]);
    const [loading, setLoading] = useState(true);
    const [search, setSearch] = useState('');
    const [filter, setFilter] = useState('all');
    const [showModal, setShowModal] = useState(false);
    const [editItem, setEditItem] = useState(null);
    const [viewItem, setViewItem] = useState(null);
    const [deleteConfirm, setDeleteConfirm] = useState(null);
    const [usageModal, setUsageModal] = useState(null);
    const [usageAmount, setUsageAmount] = useState('');
    const [usageNotes, setUsageNotes] = useState('');
    const [message, setMessage] = useState({ type: '', text: '' });
    const [formData, setFormData] = useState({ name: '', category: '', quantity: '', minStock: '', unit: '', cost: '', usageAlertDays: '7' });
    const [showExportMenu, setShowExportMenu] = useState(false);
    const exportMenuRef = React.useRef(null);

    const { inventoryService } = window.FirebaseServices;

    // Load items
    useEffect(() => {
        loadItems();
    }, []);

    // Close export menu when clicking outside
    useEffect(() => {
        const handleClickOutside = (event) => {
            if (exportMenuRef.current && !exportMenuRef.current.contains(event.target)) {
                setShowExportMenu(false);
            }
        };
        document.addEventListener('mousedown', handleClickOutside);
        return () => document.removeEventListener('mousedown', handleClickOutside);
    }, []);

    const loadItems = async () => {
        setLoading(true);
        const result = await inventoryService.getAll();
        if (result.success) setItems(result.data);
        setLoading(false);
    };

    // Filter & search
    const filteredItems = items.filter(item => {
        const status = inventoryService.getStockStatus(item.quantity, item.minStock);
        const matchFilter = filter === 'all' || status === filter;
        const matchSearch = item.name?.toLowerCase().includes(search.toLowerCase()) || 
                           item.category?.toLowerCase().includes(search.toLowerCase());
        return matchFilter && matchSearch;
    });

    // Stats
    const stats = {
        total: items.length,
        inStock: items.filter(i => inventoryService.getStockStatus(i.quantity, i.minStock) === 'in-stock').length,
        lowStock: items.filter(i => inventoryService.getStockStatus(i.quantity, i.minStock) === 'low-stock').length,
        outOfStock: items.filter(i => inventoryService.getStockStatus(i.quantity, i.minStock) === 'out-of-stock').length
    };

    const showMessage = (type, text) => {
        setMessage({ type, text });
        setTimeout(() => setMessage({ type: '', text: '' }), 3000);
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        const data = { 
            ...formData, 
            quantity: Number(formData.quantity), 
            minStock: Number(formData.minStock), 
            cost: Number(formData.cost) || 0,
            usageAlertDays: Number(formData.usageAlertDays) || 7
        };
        
        let result;
        if (editItem) {
            result = await inventoryService.update(editItem.id, data);
        } else {
            result = await inventoryService.add(data);
        }

        if (result.success) {
            showMessage('success', editItem ? 'Item updated!' : 'Item added!');
            loadItems();
            closeModal();
        } else {
            showMessage('error', result.error);
        }
    };

    const handleDelete = async (id) => {
        const result = await inventoryService.delete(id);
        if (result.success) {
            showMessage('success', 'Item deleted');
            loadItems();
        }
        setDeleteConfirm(null);
    };

    const handleEdit = (item) => {
        setEditItem(item);
        setFormData({ 
            name: item.name, 
            category: item.category, 
            quantity: item.quantity, 
            minStock: item.minStock, 
            unit: item.unit || '', 
            cost: item.cost || '', 
            usageAlertDays: item.usageAlertDays || '7' 
        });
        setShowModal(true);
    };

    const closeModal = () => {
        setShowModal(false);
        setEditItem(null);
        setFormData({ name: '', category: '', quantity: '', minStock: '', unit: '', cost: '', usageAlertDays: '7' });
    };

    const handleRecordUsage = async () => {
        if (!usageAmount || Number(usageAmount) <= 0) {
            showMessage('error', 'Please enter a valid usage amount');
            return;
        }
        const result = await inventoryService.recordUsage(usageModal.id, Number(usageAmount), usageNotes);
        if (result.success) {
            showMessage('success', `Recorded usage of ${usageAmount} ${usageModal.unit || 'units'}`);
            loadItems();
            setUsageModal(null);
            setUsageAmount('');
            setUsageNotes('');
        } else {
            showMessage('error', result.error);
        }
    };

    const getUsageAlertStyle = (alert) => {
        if (!alert) return null;
        const styles = {
            'critical': { bg: '#fee2e2', color: '#dc2626', icon: 'üî¥' },
            'warning': { bg: '#fef3c7', color: '#92400e', icon: 'üü°' },
            'ok': { bg: '#dcfce7', color: '#166534', icon: 'üü¢' }
        };
        return styles[alert.level];
    };

    const exportExcel = () => {
        let html = '<html><head><meta charset="UTF-8"></head><body>';
        html += '<table border="1"><tr><th>Item Name</th><th>Category</th><th>Quantity</th><th>Min Stock</th><th>Unit</th><th>Cost (KSH)</th><th>Total Value</th><th>Usage/Day</th><th>Days Left</th><th>Status</th></tr>';
        filteredItems.forEach(item => {
            const status = inventoryService.getStockStatus(item.quantity, item.minStock);
            const cost = item.cost || 0;
            const totalValue = cost * item.quantity;
            const usageRate = item.dailyUsageRate || 0;
            const daysLeft = usageRate > 0 ? Math.floor(item.quantity / usageRate) : '-';
            html += `<tr><td>${item.name}</td><td>${item.category}</td><td>${item.quantity}</td><td>${item.minStock}</td><td>${item.unit || ''}</td><td>${cost.toLocaleString()}</td><td>${totalValue.toLocaleString()}</td><td>${usageRate || '-'}</td><td>${daysLeft}</td><td>${status}</td></tr>`;
        });
        html += '</table></body></html>';
        const blob = new Blob([html], { type: 'application/vnd.ms-excel' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'inventory.xls';
        a.click();
        setShowExportMenu(false);
    };

    const exportPDF = () => {
        const printWindow = window.open('', '_blank');
        const totalInventoryValue = filteredItems.reduce((sum, item) => sum + ((item.cost || 0) * item.quantity), 0);
        let html = `<!DOCTYPE html><html><head><title>Inventory Report</title><style>
            body { font-family: Arial, sans-serif; padding: 20px; }
            h1 { color: #1f2937; margin-bottom: 20px; }
            table { width: 100%; border-collapse: collapse; font-size: 12px; }
            th, td { border: 1px solid #e5e7eb; padding: 8px; text-align: left; }
            th { background: #f3f4f6; font-weight: 600; }
            .in-stock { color: #166534; background: #dcfce7; }
            .low-stock { color: #92400e; background: #fef3c7; }
            .out-of-stock { color: #dc2626; background: #fee2e2; }
            .critical { color: #dc2626; font-weight: bold; }
            .warning { color: #f59e0b; }
            .stats { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
            .stat-box { padding: 15px; border: 1px solid #e5e7eb; }
            .cost-col { text-align: right; }
            .center { text-align: center; }
            .total-row { font-weight: bold; background: #f9fafb; }
        </style></head><body>`;
        html += `<h1>Inventory Report</h1><p>Generated: ${new Date().toLocaleDateString()}</p>`;
        html += `<div class="stats"><div class="stat-box"><strong>Total Items:</strong> ${stats.total}</div><div class="stat-box"><strong>In Stock:</strong> ${stats.inStock}</div><div class="stat-box"><strong>Low Stock:</strong> ${stats.lowStock}</div><div class="stat-box"><strong>Out of Stock:</strong> ${stats.outOfStock}</div><div class="stat-box"><strong>Total Value:</strong> KSH ${totalInventoryValue.toLocaleString()}</div></div>`;
        html += '<table><tr><th>Item Name</th><th>Category</th><th class="center">Qty</th><th class="center">Min</th><th>Unit</th><th class="cost-col">Cost</th><th class="cost-col">Value</th><th class="center">Usage/Day</th><th class="center">Days Left</th><th>Status</th></tr>';
        filteredItems.forEach(item => {
            const status = inventoryService.getStockStatus(item.quantity, item.minStock);
            const cost = item.cost || 0;
            const totalValue = cost * item.quantity;
            const usageRate = item.dailyUsageRate || 0;
            const daysLeft = usageRate > 0 ? Math.floor(item.quantity / usageRate) : '-';
            const daysClass = daysLeft !== '-' && daysLeft <= 3 ? 'critical' : (daysLeft !== '-' && daysLeft <= 7 ? 'warning' : '');
            html += `<tr><td>${item.name}</td><td>${item.category}</td><td class="center">${item.quantity}</td><td class="center">${item.minStock}</td><td>${item.unit || ''}</td><td class="cost-col">${cost.toLocaleString()}</td><td class="cost-col">${totalValue.toLocaleString()}</td><td class="center">${usageRate || '-'}</td><td class="center ${daysClass}">${daysLeft}</td><td class="${status}">${status.replace('-', ' ')}</td></tr>`;
        });
        html += `<tr class="total-row"><td colspan="6" style="text-align: right;">Grand Total:</td><td class="cost-col">KSH ${totalInventoryValue.toLocaleString()}</td><td colspan="3"></td></tr>`;
        html += '</table></body></html>';
        printWindow.document.write(html);
        printWindow.document.close();
        printWindow.onload = () => { printWindow.print(); };
        setShowExportMenu(false);
    };

    const getStatusStyle = (status) => {
        const styles = {
            'in-stock': { bg: '#dcfce7', color: '#166534', label: 'In Stock' },
            'low-stock': { bg: '#fef3c7', color: '#92400e', label: 'Low Stock' },
            'out-of-stock': { bg: '#fee2e2', color: '#dc2626', label: 'Out of Stock' }
        };
        return styles[status] || styles['in-stock'];
    };

    const inputStyle = { width: '100%', padding: '10px 12px', border: '1px solid #e5e7eb', borderRadius: '0', fontSize: '14px', outline: 'none' };
    const btnPrimary = { padding: '10px 20px', background: '#3b82f6', color: '#fff', border: 'none', borderRadius: '0', cursor: 'pointer', fontWeight: '600', fontSize: '14px' };
    const btnSecondary = { padding: '10px 20px', background: '#f3f4f6', color: '#374151', border: '1px solid #e5e7eb', borderRadius: '0', cursor: 'pointer', fontWeight: '500', fontSize: '14px' };

    return (
        <div style={{ padding: '0' }}>
            {/* Success/Error Toast Popup */}
            {message.text && (
                <div style={{ 
                    position: 'fixed', 
                    top: '24px', 
                    right: '24px', 
                    zIndex: 9999,
                    padding: '16px 24px', 
                    background: '#fff',
                    borderLeft: `4px solid ${message.type === 'success' ? '#22c55e' : '#ef4444'}`,
                    boxShadow: '0 4px 20px rgba(0,0,0,0.15)',
                    display: 'flex', 
                    alignItems: 'center', 
                    gap: '12px',
                    minWidth: '280px',
                    animation: 'slideIn 0.3s ease'
                }}>
                    <div style={{ 
                        width: '32px', 
                        height: '32px', 
                        borderRadius: '50%', 
                        background: message.type === 'success' ? '#dcfce7' : '#fee2e2',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        fontSize: '16px'
                    }}>
                        {message.type === 'success' ? '‚úì' : '‚úï'}
                    </div>
                    <div>
                        <div style={{ fontWeight: '600', fontSize: '14px', color: '#1f2937' }}>
                            {message.type === 'success' ? 'Success' : 'Error'}
                        </div>
                        <div style={{ fontSize: '13px', color: '#6b7280', marginTop: '2px' }}>{message.text}</div>
                    </div>
                    <button 
                        onClick={() => setMessage({ type: '', text: '' })} 
                        style={{ marginLeft: 'auto', background: 'none', border: 'none', cursor: 'pointer', color: '#9ca3af', fontSize: '18px', padding: '0' }}
                    >√ó</button>
                </div>
            )}

            {/* Stats Cards */}
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '16px', marginBottom: '24px' }}>
                {[
                    { label: 'Total Items', value: stats.total, icon: 'üì¶', color: '#3b82f6' },
                    { label: 'In Stock', value: stats.inStock, icon: '‚úì', color: '#22c55e' },
                    { label: 'Low Stock', value: stats.lowStock, icon: '‚ö†', color: '#f59e0b' },
                    { label: 'Out of Stock', value: stats.outOfStock, icon: '‚úï', color: '#ef4444' }
                ].map((stat, i) => (
                    <div key={i} style={{ background: '#fff', padding: '20px', border: '1px solid #e5e7eb', borderRadius: '0' }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <div>
                                <p style={{ margin: '0 0 4px', color: '#6b7280', fontSize: '13px' }}>{stat.label}</p>
                                <p style={{ margin: '0', fontSize: '28px', fontWeight: '700', color: stat.color }}>{stat.value}</p>
                            </div>
                            <span style={{ fontSize: '24px', opacity: 0.8 }}>{stat.icon}</span>
                        </div>
                    </div>
                ))}
            </div>

            {/* Toolbar */}
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px', gap: '16px' }}>
                <div style={{ display: 'flex', gap: '12px', flex: 1 }}>
                    <input
                        type="text"
                        placeholder="Search items..."
                        value={search}
                        onChange={(e) => setSearch(e.target.value)}
                        style={{ ...inputStyle, maxWidth: '280px' }}
                    />
                    <select value={filter} onChange={(e) => setFilter(e.target.value)} style={{ ...inputStyle, maxWidth: '160px' }}>
                        <option value="all">All Status</option>
                        <option value="in-stock">In Stock</option>
                        <option value="low-stock">Low Stock</option>
                        <option value="out-of-stock">Out of Stock</option>
                    </select>
                </div>
                <div style={{ display: 'flex', gap: '10px' }}>
                    <div style={{ position: 'relative' }} ref={exportMenuRef}>
                        <button onClick={() => setShowExportMenu(!showExportMenu)} style={btnSecondary}>üì• Export ‚ñæ</button>
                        {showExportMenu && (
                            <div style={{ position: 'absolute', top: '100%', right: 0, marginTop: '4px', background: '#fff', border: '1px solid #e5e7eb', borderRadius: '0', boxShadow: '0 4px 12px rgba(0,0,0,0.1)', zIndex: 100, minWidth: '140px' }}>
                                <button onClick={exportExcel} style={{ display: 'block', width: '100%', padding: '10px 16px', border: 'none', background: 'none', textAlign: 'left', cursor: 'pointer', fontSize: '14px', color: '#374151' }} onMouseOver={(e) => e.target.style.background='#f3f4f6'} onMouseOut={(e) => e.target.style.background='none'}>üìä Export Excel</button>
                                <button onClick={exportPDF} style={{ display: 'block', width: '100%', padding: '10px 16px', border: 'none', background: 'none', textAlign: 'left', cursor: 'pointer', fontSize: '14px', color: '#374151' }} onMouseOver={(e) => e.target.style.background='#f3f4f6'} onMouseOut={(e) => e.target.style.background='none'}>üìÑ Export PDF</button>
                            </div>
                        )}
                    </div>
                    <button onClick={() => setShowModal(true)} style={btnPrimary}>+ Add Item</button>
                </div>
            </div>

            {/* Table */}
            <div style={{ background: '#fff', border: '1px solid #e5e7eb', borderRadius: '0', overflow: 'hidden' }}>
                <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                    <thead>
                        <tr style={{ background: '#f9fafb' }}>
                            <th style={{ padding: '14px 16px', textAlign: 'left', fontWeight: '600', fontSize: '13px', color: '#374151', borderBottom: '1px solid #e5e7eb' }}>Item Name</th>
                            <th style={{ padding: '14px 16px', textAlign: 'left', fontWeight: '600', fontSize: '13px', color: '#374151', borderBottom: '1px solid #e5e7eb' }}>Category</th>
                            <th style={{ padding: '14px 16px', textAlign: 'center', fontWeight: '600', fontSize: '13px', color: '#374151', borderBottom: '1px solid #e5e7eb' }}>Quantity</th>
                            <th style={{ padding: '14px 16px', textAlign: 'center', fontWeight: '600', fontSize: '13px', color: '#374151', borderBottom: '1px solid #e5e7eb' }}>Usage/Day</th>
                            <th style={{ padding: '14px 16px', textAlign: 'right', fontWeight: '600', fontSize: '13px', color: '#374151', borderBottom: '1px solid #e5e7eb' }}>Cost</th>
                            <th style={{ padding: '14px 16px', textAlign: 'center', fontWeight: '600', fontSize: '13px', color: '#374151', borderBottom: '1px solid #e5e7eb' }}>Status</th>
                            <th style={{ padding: '14px 16px', textAlign: 'center', fontWeight: '600', fontSize: '13px', color: '#374151', borderBottom: '1px solid #e5e7eb' }}>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {loading ? (
                            <tr><td colSpan="7" style={{ padding: '40px', textAlign: 'center', color: '#6b7280' }}>Loading...</td></tr>
                        ) : filteredItems.length === 0 ? (
                            <tr><td colSpan="7" style={{ padding: '40px', textAlign: 'center', color: '#6b7280' }}>No items found</td></tr>
                        ) : (
                            filteredItems.map(item => {
                                const status = inventoryService.getStockStatus(item.quantity, item.minStock);
                                const statusStyle = getStatusStyle(status);
                                const usageAlert = inventoryService.getUsageAlert(item);
                                const alertStyle = getUsageAlertStyle(usageAlert);
                                return (
                                    <tr key={item.id} style={{ borderBottom: '1px solid #f3f4f6' }}>
                                        <td style={{ padding: '14px 16px', fontSize: '14px', fontWeight: '500' }}>
                                            {item.name}
                                            {usageAlert && usageAlert.level !== 'ok' && (
                                                <span style={{ marginLeft: '8px', padding: '2px 6px', background: alertStyle.bg, color: alertStyle.color, fontSize: '10px', fontWeight: '600' }}>
                                                    {usageAlert.days}d left
                                                </span>
                                            )}
                                        </td>
                                        <td style={{ padding: '14px 16px', fontSize: '14px', color: '#6b7280' }}>{item.category}</td>
                                        <td style={{ padding: '14px 16px', fontSize: '14px', textAlign: 'center', fontWeight: '600' }}>{item.quantity} {item.unit}</td>
                                        <td style={{ padding: '14px 16px', fontSize: '14px', textAlign: 'center' }}>
                                            {item.dailyUsageRate ? (
                                                <span style={{ padding: '4px 8px', background: alertStyle?.bg || '#f3f4f6', color: alertStyle?.color || '#6b7280', fontSize: '12px', fontWeight: '500' }}>
                                                    {item.dailyUsageRate} {item.unit || 'units'}
                                                </span>
                                            ) : (
                                                <span style={{ color: '#9ca3af', fontSize: '12px' }}>No data</span>
                                            )}
                                        </td>
                                        <td style={{ padding: '14px 16px', fontSize: '14px', textAlign: 'right', fontWeight: '600', color: '#059669' }}>KSH {(item.cost || 0).toLocaleString()}</td>
                                        <td style={{ padding: '14px 16px', textAlign: 'center' }}>
                                            <span style={{ padding: '4px 12px', background: statusStyle.bg, color: statusStyle.color, fontSize: '12px', fontWeight: '600', borderRadius: '0' }}>
                                                {statusStyle.label}
                                            </span>
                                        </td>
                                        <td style={{ padding: '14px 16px', textAlign: 'center' }}>
                                            <div style={{ display: 'flex', gap: '4px', justifyContent: 'center', flexWrap: 'wrap' }}>
                                                <button onClick={() => setUsageModal(item)} style={{ padding: '6px 10px', background: '#fef3c7', border: '1px solid #fcd34d', borderRadius: '0', cursor: 'pointer', fontSize: '11px', color: '#92400e', fontWeight: '600' }}>Use</button>
                                                <button onClick={() => setViewItem(item)} style={{ padding: '6px 10px', background: '#eff6ff', border: '1px solid #bfdbfe', borderRadius: '0', cursor: 'pointer', fontSize: '11px', color: '#2563eb' }}>View</button>
                                                <button onClick={() => handleEdit(item)} style={{ padding: '6px 10px', background: '#f3f4f6', border: '1px solid #e5e7eb', borderRadius: '0', cursor: 'pointer', fontSize: '11px' }}>Edit</button>
                                                <button onClick={() => setDeleteConfirm(item)} style={{ padding: '6px 10px', background: '#fee2e2', border: '1px solid #fecaca', borderRadius: '0', cursor: 'pointer', color: '#dc2626', fontSize: '11px' }}>Del</button>
                                            </div>
                                        </td>
                                    </tr>
                                );
                            })
                        )}
                    </tbody>
                </table>
            </div>

            {/* Modal */}
            {showModal && (
                <div style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 }}>
                    <div style={{ background: '#fff', width: '100%', maxWidth: '440px', borderRadius: '0', overflow: 'hidden' }}>
                        <div style={{ padding: '20px 24px', borderBottom: '1px solid #e5e7eb', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <h3 style={{ margin: 0, fontSize: '18px', fontWeight: '600' }}>{editItem ? 'Edit Item' : 'Add New Item'}</h3>
                            <button onClick={closeModal} style={{ background: 'none', border: 'none', fontSize: '20px', cursor: 'pointer', color: '#6b7280' }}>√ó</button>
                        </div>
                        <form onSubmit={handleSubmit} style={{ padding: '24px' }}>
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                                <div>
                                    <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: '#374151' }}>Item Name *</label>
                                    <input type="text" value={formData.name} onChange={(e) => setFormData({ ...formData, name: e.target.value })} style={inputStyle} required />
                                </div>
                                <div>
                                    <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: '#374151' }}>Category *</label>
                                    <select value={formData.category} onChange={(e) => setFormData({ ...formData, category: e.target.value })} style={inputStyle} required>
                                        <option value="">Select category</option>
                                        <option value="Cleaning Supplies">Cleaning Supplies</option>
                                        <option value="Chemicals">Chemicals</option>
                                        <option value="Tools">Tools</option>
                                        <option value="Equipment">Equipment</option>
                                        <option value="Consumables">Consumables</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' }}>
                                    <div>
                                        <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: '#374151' }}>Quantity *</label>
                                        <input type="number" min="0" value={formData.quantity} onChange={(e) => setFormData({ ...formData, quantity: e.target.value })} style={inputStyle} required />
                                    </div>
                                    <div>
                                        <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: '#374151' }}>Min Stock *</label>
                                        <input type="number" min="0" value={formData.minStock} onChange={(e) => setFormData({ ...formData, minStock: e.target.value })} style={inputStyle} required />
                                    </div>
                                </div>
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' }}>
                                    <div>
                                        <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: '#374151' }}>Unit (optional)</label>
                                        <input type="text" placeholder="e.g., pcs, liters, kg" value={formData.unit} onChange={(e) => setFormData({ ...formData, unit: e.target.value })} style={inputStyle} />
                                    </div>
                                    <div>
                                        <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: '#374151' }}>Cost per Unit (KSH)</label>
                                        <input type="number" min="0" step="0.01" placeholder="0.00" value={formData.cost} onChange={(e) => setFormData({ ...formData, cost: e.target.value })} style={inputStyle} />
                                    </div>
                                </div>
                                <div>
                                    <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: '#374151' }}>Usage Alert (days)</label>
                                    <input type="number" min="1" placeholder="Alert when supply drops below X days" value={formData.usageAlertDays} onChange={(e) => setFormData({ ...formData, usageAlertDays: e.target.value })} style={inputStyle} />
                                    <p style={{ margin: '4px 0 0', fontSize: '11px', color: '#9ca3af' }}>Alert when remaining supply falls below this many days</p>
                                </div>
                            </div>
                            <div style={{ display: 'flex', gap: '12px', marginTop: '24px' }}>
                                <button type="button" onClick={closeModal} style={{ ...btnSecondary, flex: 1 }}>Cancel</button>
                                <button type="submit" style={{ ...btnPrimary, flex: 1 }}>{editItem ? 'Update' : 'Add Item'}</button>
                            </div>
                        </form>
                    </div>
                </div>
            )}

            {/* View Item Modal */}
            {viewItem && (
                <div style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 }}>
                    <div style={{ background: '#fff', width: '100%', maxWidth: '400px', borderRadius: '0', overflow: 'hidden' }}>
                        <div style={{ padding: '20px 24px', borderBottom: '1px solid #e5e7eb', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <h3 style={{ margin: 0, fontSize: '18px', fontWeight: '600' }}>Item Details</h3>
                            <button onClick={() => setViewItem(null)} style={{ background: 'none', border: 'none', fontSize: '20px', cursor: 'pointer', color: '#6b7280' }}>√ó</button>
                        </div>
                        <div style={{ padding: '24px' }}>
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', padding: '12px', background: '#f9fafb' }}>
                                    <span style={{ color: '#6b7280', fontSize: '14px' }}>Item Name</span>
                                    <span style={{ fontWeight: '600', fontSize: '14px' }}>{viewItem.name}</span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', padding: '12px' }}>
                                    <span style={{ color: '#6b7280', fontSize: '14px' }}>Category</span>
                                    <span style={{ fontWeight: '500', fontSize: '14px' }}>{viewItem.category}</span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', padding: '12px', background: '#f9fafb' }}>
                                    <span style={{ color: '#6b7280', fontSize: '14px' }}>Quantity</span>
                                    <span style={{ fontWeight: '600', fontSize: '14px' }}>{viewItem.quantity} {viewItem.unit}</span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', padding: '12px' }}>
                                    <span style={{ color: '#6b7280', fontSize: '14px' }}>Min Stock Level</span>
                                    <span style={{ fontWeight: '500', fontSize: '14px' }}>{viewItem.minStock}</span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', padding: '12px', background: '#f9fafb' }}>
                                    <span style={{ color: '#6b7280', fontSize: '14px' }}>Cost per Unit</span>
                                    <span style={{ fontWeight: '600', fontSize: '14px', color: '#059669' }}>KSH {(viewItem.cost || 0).toLocaleString()}</span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', padding: '12px' }}>
                                    <span style={{ color: '#6b7280', fontSize: '14px' }}>Total Value</span>
                                    <span style={{ fontWeight: '700', fontSize: '14px', color: '#059669' }}>KSH {((viewItem.cost || 0) * viewItem.quantity).toLocaleString()}</span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', padding: '12px', background: '#f9fafb' }}>
                                    <span style={{ color: '#6b7280', fontSize: '14px' }}>Status</span>
                                    <span style={{ padding: '4px 12px', background: getStatusStyle(inventoryService.getStockStatus(viewItem.quantity, viewItem.minStock)).bg, color: getStatusStyle(inventoryService.getStockStatus(viewItem.quantity, viewItem.minStock)).color, fontSize: '12px', fontWeight: '600', borderRadius: '0' }}>
                                        {getStatusStyle(inventoryService.getStockStatus(viewItem.quantity, viewItem.minStock)).label}
                                    </span>
                                </div>
                                {viewItem.dailyUsageRate > 0 && (
                                    <>
                                        <div style={{ display: 'flex', justifyContent: 'space-between', padding: '12px' }}>
                                            <span style={{ color: '#6b7280', fontSize: '14px' }}>Daily Usage Rate</span>
                                            <span style={{ fontWeight: '600', fontSize: '14px' }}>{viewItem.dailyUsageRate} {viewItem.unit}/day</span>
                                        </div>
                                        <div style={{ display: 'flex', justifyContent: 'space-between', padding: '12px', background: '#f9fafb' }}>
                                            <span style={{ color: '#6b7280', fontSize: '14px' }}>Days of Supply Left</span>
                                            <span style={{ fontWeight: '600', fontSize: '14px', color: inventoryService.getUsageAlert(viewItem)?.level === 'critical' ? '#dc2626' : inventoryService.getUsageAlert(viewItem)?.level === 'warning' ? '#f59e0b' : '#22c55e' }}>
                                                {Math.floor(viewItem.quantity / viewItem.dailyUsageRate)} days
                                            </span>
                                        </div>
                                    </>
                                )}
                                {viewItem.lastUsage && (
                                    <div style={{ display: 'flex', justifyContent: 'space-between', padding: '12px' }}>
                                        <span style={{ color: '#6b7280', fontSize: '14px' }}>Last Usage</span>
                                        <span style={{ fontWeight: '500', fontSize: '14px' }}>{viewItem.lastUsage.amount} {viewItem.unit} - {new Date(viewItem.lastUsage.date).toLocaleDateString()}</span>
                                    </div>
                                )}
                            </div>
                            <div style={{ marginTop: '24px', display: 'flex', gap: '12px' }}>
                                <button onClick={() => setViewItem(null)} style={{ ...btnSecondary, flex: 1 }}>Close</button>
                                <button onClick={() => {
                                    const status = inventoryService.getStockStatus(viewItem.quantity, viewItem.minStock);
                                    const usageAlert = inventoryService.getUsageAlert(viewItem);
                                    const daysLeft = viewItem.dailyUsageRate > 0 ? Math.floor(viewItem.quantity / viewItem.dailyUsageRate) : null;
                                    const printWindow = window.open('', '_blank');
                                    let html = `<!DOCTYPE html><html><head><title>Item Receipt - ${viewItem.name}</title><style>
                                        body { font-family: Arial, sans-serif; padding: 30px; max-width: 400px; margin: 0 auto; }
                                        .header { text-align: center; border-bottom: 2px solid #1f2937; padding-bottom: 15px; margin-bottom: 20px; }
                                        .header h2 { margin: 0 0 5px; color: #1f2937; }
                                        .header p { margin: 0; color: #6b7280; font-size: 12px; }
                                        .row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px dashed #e5e7eb; }
                                        .label { color: #6b7280; }
                                        .value { font-weight: 600; text-align: right; }
                                        .status { padding: 4px 12px; font-size: 12px; font-weight: 600; }
                                        .in-stock { background: #dcfce7; color: #166534; }
                                        .low-stock { background: #fef3c7; color: #92400e; }
                                        .out-of-stock { background: #fee2e2; color: #dc2626; }
                                        .footer { text-align: center; margin-top: 25px; padding-top: 15px; border-top: 2px solid #1f2937; font-size: 11px; color: #9ca3af; }
                                        .total { font-size: 18px; color: #059669; }
                                    </style></head><body>
                                    <div class="header">
                                        <h2>üöó Ecospark</h2>
                                        <p>Inventory Item Receipt</p>
                                    </div>
                                    <div class="row"><span class="label">Item Name</span><span class="value">${viewItem.name}</span></div>
                                    <div class="row"><span class="label">Category</span><span class="value">${viewItem.category}</span></div>
                                    <div class="row"><span class="label">Quantity</span><span class="value">${viewItem.quantity} ${viewItem.unit || ''}</span></div>
                                    <div class="row"><span class="label">Min Stock Level</span><span class="value">${viewItem.minStock}</span></div>
                                    <div class="row"><span class="label">Cost per Unit</span><span class="value">KSH ${(viewItem.cost || 0).toLocaleString()}</span></div>
                                    <div class="row"><span class="label">Total Value</span><span class="value total">KSH ${((viewItem.cost || 0) * viewItem.quantity).toLocaleString()}</span></div>
                                    <div class="row"><span class="label">Status</span><span class="value"><span class="status ${status}">${status.replace('-', ' ')}</span></span></div>
                                    ${viewItem.dailyUsageRate ? `<div class="row"><span class="label">Daily Usage Rate</span><span class="value">${viewItem.dailyUsageRate} ${viewItem.unit || 'units'}/day</span></div>` : ''}
                                    ${daysLeft !== null ? `<div class="row"><span class="label">Days of Supply</span><span class="value" style="color: ${daysLeft <= 3 ? '#dc2626' : daysLeft <= 7 ? '#f59e0b' : '#22c55e'}">${daysLeft} days</span></div>` : ''}
                                    ${viewItem.lastUsage ? `<div class="row"><span class="label">Last Usage</span><span class="value">${viewItem.lastUsage.amount} ${viewItem.unit || ''} on ${new Date(viewItem.lastUsage.date).toLocaleDateString()}</span></div>` : ''}
                                    <div class="footer">
                                        <p>Generated: ${new Date().toLocaleString()}</p>
                                        <p>Ecospark Car Wash Management System</p>
                                    </div>
                                    </body></html>`;
                                    printWindow.document.write(html);
                                    printWindow.document.close();
                                    printWindow.onload = () => { printWindow.print(); };
                                }} style={{ ...btnPrimary, flex: 1, display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '6px' }}>
                                    üñ®Ô∏è Print
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* Record Usage Modal */}
            {usageModal && (
                <div style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 }}>
                    <div style={{ background: '#fff', width: '100%', maxWidth: '380px', borderRadius: '0', overflow: 'hidden' }}>
                        <div style={{ padding: '20px 24px', borderBottom: '1px solid #e5e7eb', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <h3 style={{ margin: 0, fontSize: '18px', fontWeight: '600' }}>Record Usage</h3>
                            <button onClick={() => { setUsageModal(null); setUsageAmount(''); setUsageNotes(''); }} style={{ background: 'none', border: 'none', fontSize: '20px', cursor: 'pointer', color: '#6b7280' }}>√ó</button>
                        </div>
                        <div style={{ padding: '24px' }}>
                            <div style={{ background: '#f9fafb', padding: '16px', marginBottom: '20px' }}>
                                <p style={{ margin: '0 0 4px', fontWeight: '600', fontSize: '15px' }}>{usageModal.name}</p>
                                <p style={{ margin: 0, color: '#6b7280', fontSize: '13px' }}>Available: <strong>{usageModal.quantity} {usageModal.unit}</strong></p>
                            </div>
                            <div style={{ marginBottom: '16px' }}>
                                <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: '#374151' }}>Amount Used *</label>
                                <input 
                                    type="number" 
                                    min="1" 
                                    max={usageModal.quantity}
                                    value={usageAmount} 
                                    onChange={(e) => setUsageAmount(e.target.value)} 
                                    placeholder={`Max: ${usageModal.quantity}`}
                                    style={inputStyle} 
                                />
                            </div>
                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: '#374151' }}>Notes (optional)</label>
                                <input 
                                    type="text" 
                                    value={usageNotes} 
                                    onChange={(e) => setUsageNotes(e.target.value)} 
                                    placeholder="e.g., Used for vehicle wash"
                                    style={inputStyle} 
                                />
                            </div>
                            <div style={{ display: 'flex', gap: '12px' }}>
                                <button onClick={() => { setUsageModal(null); setUsageAmount(''); setUsageNotes(''); }} style={{ ...btnSecondary, flex: 1 }}>Cancel</button>
                                <button onClick={handleRecordUsage} style={{ flex: 1, padding: '10px 20px', background: '#f59e0b', color: '#fff', border: 'none', borderRadius: '0', cursor: 'pointer', fontWeight: '600', fontSize: '14px' }}>Record Usage</button>
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* Delete Confirmation Modal */}
            {deleteConfirm && (
                <div style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 }}>
                    <div style={{ background: '#fff', width: '100%', maxWidth: '380px', borderRadius: '0', overflow: 'hidden' }}>
                        <div style={{ padding: '24px', textAlign: 'center' }}>
                            <div style={{ width: '56px', height: '56px', background: '#fee2e2', borderRadius: '50%', display: 'flex', alignItems: 'center', justifyContent: 'center', margin: '0 auto 16px', fontSize: '24px' }}>üóëÔ∏è</div>
                            <h3 style={{ margin: '0 0 8px', fontSize: '18px', fontWeight: '600', color: '#1f2937' }}>Delete Item</h3>
                            <p style={{ margin: '0 0 24px', color: '#6b7280', fontSize: '14px' }}>Are you sure you want to delete <strong>"{deleteConfirm.name}"</strong>? This action cannot be undone.</p>
                            <div style={{ display: 'flex', gap: '12px' }}>
                                <button onClick={() => setDeleteConfirm(null)} style={{ ...btnSecondary, flex: 1 }}>Cancel</button>
                                <button onClick={() => handleDelete(deleteConfirm.id)} style={{ flex: 1, padding: '10px 20px', background: '#dc2626', color: '#fff', border: 'none', borderRadius: '0', cursor: 'pointer', fontWeight: '600', fontSize: '14px' }}>Delete</button>
                            </div>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}

// ==================== EXPENSES MODULE ====================
function ExpensesModule() {
    const [expenses, setExpenses] = useState([]);
    const [loading, setLoading] = useState(true);
    const [search, setSearch] = useState('');
    const [categoryFilter, setCategoryFilter] = useState('all');
    const [dateFilter, setDateFilter] = useState('all');
    const [showModal, setShowModal] = useState(false);
    const [editItem, setEditItem] = useState(null);
    const [deleteConfirm, setDeleteConfirm] = useState(null);
    const [message, setMessage] = useState({ type: '', text: '' });
    const [formData, setFormData] = useState({ 
        title: '', 
        category: '', 
        amount: '', 
        date: new Date().toISOString().split('T')[0], 
        description: '',
        paymentMethod: 'cash'
    });

    const { expensesService } = window.FirebaseServices;

    const categories = ['Utilities', 'Supplies', 'Maintenance', 'Salaries', 'Transport', 'Marketing', 'Equipment', 'Other'];

    // Realtime subscription
    useEffect(() => {
        const unsubscribe = expensesService.subscribeToExpenses((data) => {
            setExpenses(data);
            setLoading(false);
        });
        return () => unsubscribe();
    }, []);

    // Filter expenses
    const filteredExpenses = expenses.filter(expense => {
        const matchSearch = expense.title?.toLowerCase().includes(search.toLowerCase()) || 
                           expense.description?.toLowerCase().includes(search.toLowerCase());
        const matchCategory = categoryFilter === 'all' || expense.category === categoryFilter;
        
        let matchDate = true;
        if (dateFilter === 'today') {
            matchDate = expense.date === new Date().toISOString().split('T')[0];
        } else if (dateFilter === 'week') {
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            matchDate = new Date(expense.date) >= weekAgo;
        } else if (dateFilter === 'month') {
            const thisMonth = new Date().toISOString().slice(0, 7);
            matchDate = expense.date?.startsWith(thisMonth);
        }
        
        return matchSearch && matchCategory && matchDate;
    });

    const stats = expensesService.getSummary(expenses);

    const showMessage = (type, text) => {
        setMessage({ type, text });
        setTimeout(() => setMessage({ type: '', text: '' }), 3000);
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        let result;
        if (editItem) {
            result = await expensesService.update(editItem.id, formData);
        } else {
            result = await expensesService.add(formData);
        }
        if (result.success) {
            showMessage('success', editItem ? 'Expense updated!' : 'Expense added!');
            closeModal();
        } else {
            showMessage('error', result.error);
        }
    };

    const handleDelete = async (id) => {
        const result = await expensesService.delete(id);
        if (result.success) {
            showMessage('success', 'Expense deleted');
        }
        setDeleteConfirm(null);
    };

    const handleEdit = (expense) => {
        setEditItem(expense);
        setFormData({
            title: expense.title,
            category: expense.category,
            amount: expense.amount,
            date: expense.date,
            description: expense.description || '',
            paymentMethod: expense.paymentMethod || 'cash'
        });
        setShowModal(true);
    };

    const closeModal = () => {
        setShowModal(false);
        setEditItem(null);
        setFormData({ title: '', category: '', amount: '', date: new Date().toISOString().split('T')[0], description: '', paymentMethod: 'cash' });
    };

    const exportExpenses = () => {
        const printWindow = window.open('', '_blank');
        let html = `<!DOCTYPE html><html><head><title>Expenses Report</title><style>
            body { font-family: Arial, sans-serif; padding: 20px; }
            h1 { color: #1f2937; }
            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
            th, td { border: 1px solid #e5e7eb; padding: 10px; text-align: left; font-size: 13px; }
            th { background: #f3f4f6; }
            .stats { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
            .stat-box { padding: 15px 20px; border: 1px solid #e5e7eb; }
            .amount { text-align: right; font-weight: 600; }
            .total { font-weight: bold; background: #f9fafb; }
        </style></head><body>`;
        html += `<h1>Expenses Report</h1><p>Generated: ${new Date().toLocaleDateString()}</p>`;
        html += `<div class="stats"><div class="stat-box"><strong>Total:</strong> KSH ${stats.total.toLocaleString()}</div><div class="stat-box"><strong>This Month:</strong> KSH ${stats.thisMonth.toLocaleString()}</div><div class="stat-box"><strong>This Week:</strong> KSH ${stats.thisWeek.toLocaleString()}</div><div class="stat-box"><strong>Today:</strong> KSH ${stats.today.toLocaleString()}</div></div>`;
        html += '<table><tr><th>Date</th><th>Title</th><th>Category</th><th>Payment</th><th class="amount">Amount (KSH)</th></tr>';
        const total = filteredExpenses.reduce((sum, e) => sum + (e.amount || 0), 0);
        filteredExpenses.forEach(e => {
            html += `<tr><td>${e.date}</td><td>${e.title}</td><td>${e.category}</td><td>${e.paymentMethod || '-'}</td><td class="amount">${(e.amount || 0).toLocaleString()}</td></tr>`;
        });
        html += `<tr class="total"><td colspan="4" style="text-align:right;">Total:</td><td class="amount">KSH ${total.toLocaleString()}</td></tr>`;
        html += '</table></body></html>';
        printWindow.document.write(html);
        printWindow.document.close();
        printWindow.onload = () => printWindow.print();
    };

    const inputStyle = { width: '100%', padding: '10px 12px', border: '1px solid #e5e7eb', borderRadius: '0', fontSize: '14px', outline: 'none' };
    const btnPrimary = { padding: '10px 20px', background: '#3b82f6', color: '#fff', border: 'none', borderRadius: '0', cursor: 'pointer', fontWeight: '600', fontSize: '14px' };
    const btnSecondary = { padding: '10px 20px', background: '#f3f4f6', color: '#374151', border: '1px solid #e5e7eb', borderRadius: '0', cursor: 'pointer', fontWeight: '500', fontSize: '14px' };

    return (
        <div style={{ padding: '0' }}>
            {/* Toast */}
            {message.text && (
                <div style={{ position: 'fixed', top: '24px', right: '24px', zIndex: 9999, padding: '16px 24px', background: '#fff', borderLeft: `4px solid ${message.type === 'success' ? '#22c55e' : '#ef4444'}`, boxShadow: '0 4px 20px rgba(0,0,0,0.15)', display: 'flex', alignItems: 'center', gap: '12px', minWidth: '280px' }}>
                    <div style={{ width: '32px', height: '32px', borderRadius: '50%', background: message.type === 'success' ? '#dcfce7' : '#fee2e2', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '16px' }}>
                        {message.type === 'success' ? '‚úì' : '‚úï'}
                    </div>
                    <div>
                        <div style={{ fontWeight: '600', fontSize: '14px', color: '#1f2937' }}>{message.type === 'success' ? 'Success' : 'Error'}</div>
                        <div style={{ fontSize: '13px', color: '#6b7280', marginTop: '2px' }}>{message.text}</div>
                    </div>
                    <button onClick={() => setMessage({ type: '', text: '' })} style={{ marginLeft: 'auto', background: 'none', border: 'none', cursor: 'pointer', color: '#9ca3af', fontSize: '18px' }}>√ó</button>
                </div>
            )}

            {/* Stats Cards */}
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '16px', marginBottom: '24px' }}>
                {[
                    { label: 'Total Expenses', value: `KSH ${stats.total.toLocaleString()}`, icon: 'üí∞', color: '#3b82f6' },
                    { label: 'This Month', value: `KSH ${stats.thisMonth.toLocaleString()}`, icon: 'üìÖ', color: '#8b5cf6' },
                    { label: 'This Week', value: `KSH ${stats.thisWeek.toLocaleString()}`, icon: 'üìä', color: '#f59e0b' },
                    { label: 'Today', value: `KSH ${stats.today.toLocaleString()}`, icon: 'üìå', color: '#22c55e' }
                ].map((stat, i) => (
                    <div key={i} style={{ background: '#fff', padding: '20px', border: '1px solid #e5e7eb', borderRadius: '0' }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <div>
                                <p style={{ margin: '0 0 4px', color: '#6b7280', fontSize: '13px' }}>{stat.label}</p>
                                <p style={{ margin: '0', fontSize: '22px', fontWeight: '700', color: stat.color }}>{stat.value}</p>
                            </div>
                            <span style={{ fontSize: '24px', opacity: 0.8 }}>{stat.icon}</span>
                        </div>
                    </div>
                ))}
            </div>

            {/* Toolbar */}
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px', gap: '12px', flexWrap: 'wrap' }}>
                <div style={{ display: 'flex', gap: '12px', flex: 1, flexWrap: 'wrap' }}>
                    <input type="text" placeholder="Search expenses..." value={search} onChange={(e) => setSearch(e.target.value)} style={{ ...inputStyle, maxWidth: '220px' }} />
                    <select value={categoryFilter} onChange={(e) => setCategoryFilter(e.target.value)} style={{ ...inputStyle, maxWidth: '150px' }}>
                        <option value="all">All Categories</option>
                        {categories.map(c => <option key={c} value={c}>{c}</option>)}
                    </select>
                    <select value={dateFilter} onChange={(e) => setDateFilter(e.target.value)} style={{ ...inputStyle, maxWidth: '130px' }}>
                        <option value="all">All Time</option>
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                    </select>
                </div>
                <div style={{ display: 'flex', gap: '10px' }}>
                    <button onClick={exportExpenses} style={btnSecondary}>üìÑ Export</button>
                    <button onClick={() => setShowModal(true)} style={btnPrimary}>+ Add Expense</button>
                </div>
            </div>

            {/* Table */}
            <div style={{ background: '#fff', border: '1px solid #e5e7eb', borderRadius: '0', overflow: 'hidden' }}>
                <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                    <thead>
                        <tr style={{ background: '#f9fafb' }}>
                            <th style={{ padding: '14px 16px', textAlign: 'left', fontWeight: '600', fontSize: '13px', color: '#374151', borderBottom: '1px solid #e5e7eb' }}>Date</th>
                            <th style={{ padding: '14px 16px', textAlign: 'left', fontWeight: '600', fontSize: '13px', color: '#374151', borderBottom: '1px solid #e5e7eb' }}>Title</th>
                            <th style={{ padding: '14px 16px', textAlign: 'left', fontWeight: '600', fontSize: '13px', color: '#374151', borderBottom: '1px solid #e5e7eb' }}>Category</th>
                            <th style={{ padding: '14px 16px', textAlign: 'center', fontWeight: '600', fontSize: '13px', color: '#374151', borderBottom: '1px solid #e5e7eb' }}>Payment</th>
                            <th style={{ padding: '14px 16px', textAlign: 'right', fontWeight: '600', fontSize: '13px', color: '#374151', borderBottom: '1px solid #e5e7eb' }}>Amount</th>
                            <th style={{ padding: '14px 16px', textAlign: 'center', fontWeight: '600', fontSize: '13px', color: '#374151', borderBottom: '1px solid #e5e7eb' }}>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {loading ? (
                            <tr><td colSpan="6" style={{ padding: '40px', textAlign: 'center', color: '#6b7280' }}>Loading...</td></tr>
                        ) : filteredExpenses.length === 0 ? (
                            <tr><td colSpan="6" style={{ padding: '40px', textAlign: 'center', color: '#6b7280' }}>No expenses found</td></tr>
                        ) : (
                            filteredExpenses.map(expense => (
                                <tr key={expense.id} style={{ borderBottom: '1px solid #f3f4f6' }}>
                                    <td style={{ padding: '14px 16px', fontSize: '14px', color: '#6b7280' }}>{expense.date}</td>
                                    <td style={{ padding: '14px 16px' }}>
                                        <div style={{ fontWeight: '500', fontSize: '14px' }}>{expense.title}</div>
                                        {expense.description && <div style={{ fontSize: '12px', color: '#9ca3af', marginTop: '2px' }}>{expense.description}</div>}
                                    </td>
                                    <td style={{ padding: '14px 16px' }}>
                                        <span style={{ padding: '4px 10px', background: '#f3f4f6', fontSize: '12px', fontWeight: '500' }}>{expense.category}</span>
                                    </td>
                                    <td style={{ padding: '14px 16px', textAlign: 'center', fontSize: '13px', color: '#6b7280', textTransform: 'capitalize' }}>{expense.paymentMethod || '-'}</td>
                                    <td style={{ padding: '14px 16px', textAlign: 'right', fontWeight: '600', fontSize: '14px', color: '#dc2626' }}>KSH {(expense.amount || 0).toLocaleString()}</td>
                                    <td style={{ padding: '14px 16px', textAlign: 'center' }}>
                                        <div style={{ display: 'flex', gap: '6px', justifyContent: 'center' }}>
                                            <button onClick={() => handleEdit(expense)} style={{ padding: '6px 12px', background: '#f3f4f6', border: '1px solid #e5e7eb', borderRadius: '0', cursor: 'pointer', fontSize: '12px' }}>Edit</button>
                                            <button onClick={() => setDeleteConfirm(expense)} style={{ padding: '6px 12px', background: '#fee2e2', border: '1px solid #fecaca', borderRadius: '0', cursor: 'pointer', color: '#dc2626', fontSize: '12px' }}>Delete</button>
                                        </div>
                                    </td>
                                </tr>
                            ))
                        )}
                    </tbody>
                </table>
            </div>

            {/* Add/Edit Modal */}
            {showModal && (
                <div style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 }}>
                    <div style={{ background: '#fff', width: '100%', maxWidth: '440px', borderRadius: '0', overflow: 'hidden' }}>
                        <div style={{ padding: '20px 24px', borderBottom: '1px solid #e5e7eb', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <h3 style={{ margin: 0, fontSize: '18px', fontWeight: '600' }}>{editItem ? 'Edit Expense' : 'Add Expense'}</h3>
                            <button onClick={closeModal} style={{ background: 'none', border: 'none', fontSize: '20px', cursor: 'pointer', color: '#6b7280' }}>√ó</button>
                        </div>
                        <form onSubmit={handleSubmit} style={{ padding: '24px' }}>
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                                <div>
                                    <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: '#374151' }}>Title *</label>
                                    <input type="text" value={formData.title} onChange={(e) => setFormData({ ...formData, title: e.target.value })} placeholder="e.g., Electricity Bill" style={inputStyle} required />
                                </div>
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' }}>
                                    <div>
                                        <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: '#374151' }}>Category *</label>
                                        <select value={formData.category} onChange={(e) => setFormData({ ...formData, category: e.target.value })} style={inputStyle} required>
                                            <option value="">Select</option>
                                            {categories.map(c => <option key={c} value={c}>{c}</option>)}
                                        </select>
                                    </div>
                                    <div>
                                        <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: '#374151' }}>Amount (KSH) *</label>
                                        <input type="number" min="0" step="0.01" value={formData.amount} onChange={(e) => setFormData({ ...formData, amount: e.target.value })} placeholder="0.00" style={inputStyle} required />
                                    </div>
                                </div>
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' }}>
                                    <div>
                                        <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: '#374151' }}>Date *</label>
                                        <input type="date" value={formData.date} onChange={(e) => setFormData({ ...formData, date: e.target.value })} style={inputStyle} required />
                                    </div>
                                    <div>
                                        <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: '#374151' }}>Payment Method</label>
                                        <select value={formData.paymentMethod} onChange={(e) => setFormData({ ...formData, paymentMethod: e.target.value })} style={inputStyle}>
                                            <option value="cash">Cash</option>
                                            <option value="mpesa">M-Pesa</option>
                                            <option value="bank">Bank Transfer</option>
                                            <option value="card">Card</option>
                                            <option value="cheque">Cheque</option>
                                        </select>
                                    </div>
                                </div>
                                <div>
                                    <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: '#374151' }}>Description (optional)</label>
                                    <input type="text" value={formData.description} onChange={(e) => setFormData({ ...formData, description: e.target.value })} placeholder="Additional notes..." style={inputStyle} />
                                </div>
                            </div>
                            <div style={{ display: 'flex', gap: '12px', marginTop: '24px' }}>
                                <button type="button" onClick={closeModal} style={{ ...btnSecondary, flex: 1 }}>Cancel</button>
                                <button type="submit" style={{ ...btnPrimary, flex: 1 }}>{editItem ? 'Update' : 'Add Expense'}</button>
                            </div>
                        </form>
                    </div>
                </div>
            )}

            {/* Delete Confirmation */}
            {deleteConfirm && (
                <div style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 }}>
                    <div style={{ background: '#fff', width: '100%', maxWidth: '380px', borderRadius: '0', overflow: 'hidden' }}>
                        <div style={{ padding: '24px', textAlign: 'center' }}>
                            <div style={{ width: '56px', height: '56px', background: '#fee2e2', borderRadius: '50%', display: 'flex', alignItems: 'center', justifyContent: 'center', margin: '0 auto 16px', fontSize: '24px' }}>üóëÔ∏è</div>
                            <h3 style={{ margin: '0 0 8px', fontSize: '18px', fontWeight: '600', color: '#1f2937' }}>Delete Expense</h3>
                            <p style={{ margin: '0 0 24px', color: '#6b7280', fontSize: '14px' }}>Delete <strong>"{deleteConfirm.title}"</strong> (KSH {(deleteConfirm.amount || 0).toLocaleString()})?</p>
                            <div style={{ display: 'flex', gap: '12px' }}>
                                <button onClick={() => setDeleteConfirm(null)} style={{ ...btnSecondary, flex: 1 }}>Cancel</button>
                                <button onClick={() => handleDelete(deleteConfirm.id)} style={{ flex: 1, padding: '10px 20px', background: '#dc2626', color: '#fff', border: 'none', borderRadius: '0', cursor: 'pointer', fontWeight: '600', fontSize: '14px' }}>Delete</button>
                            </div>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}

// ==================== SYSTEM SETTINGS MODULE ====================
function SystemSettings({ initialTab = 'profile' }) {
    const [activeTab, setActiveTab] = useState(initialTab);
    const [loading, setLoading] = useState(false);
    const [successMessage, setSuccessMessage] = useState('');
    const [error, setError] = useState('');
    const { currentUser, userProfile } = useContext(AuthContext);
    
    // Profile form state
    const [profileData, setProfileData] = useState({
        displayName: userProfile?.displayName || '',
        phone: userProfile?.phone || '',
        address: userProfile?.address || ''
    });
    
    // Password change state
    const [passwordData, setPasswordData] = useState({
        currentPassword: '',
        newPassword: '',
        confirmPassword: ''
    });
    
    // Profile image state
    const [profileImage, setProfileImage] = useState(userProfile?.photoURL || null);
    const [uploadingImage, setUploadingImage] = useState(false);
    const fileInputRef = React.useRef(null);
    
    // Theme detection
    const [isDark, setIsDark] = useState(document.documentElement.getAttribute('data-theme') === 'dark');
    
    // Toggle theme function
    const toggleTheme = () => {
        const newTheme = isDark ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', newTheme);
        setIsDark(!isDark);
    };
    
    // Handle image upload
    const handleImageUpload = async (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        
        // Validate file type
        if (!file.type.startsWith('image/')) {
            setError('Please select an image file');
            return;
        }
        
        // Validate file size (max 2MB)
        if (file.size > 2 * 1024 * 1024) {
            setError('Image size should be less than 2MB');
            return;
        }
        
        setUploadingImage(true);
        try {
            const services = window.FirebaseServices;
            if (services?.storageService && currentUser) {
                const result = await services.storageService.uploadProfileImage(currentUser.uid, file);
                if (result.success) {
                    setProfileImage(result.url);
                    await services.userService.updateUserProfile(currentUser.uid, { photoURL: result.url });
                    setSuccessMessage('Profile image updated!');
                } else {
                    setError(result.error || 'Failed to upload image');
                }
            } else {
                // Fallback: create local preview
                const reader = new FileReader();
                reader.onloadend = () => {
                    setProfileImage(reader.result);
                    setSuccessMessage('Image preview set (save to upload)');
                };
                reader.readAsDataURL(file);
            }
        } catch (err) {
            setError(err.message || 'Failed to upload image');
        } finally {
            setUploadingImage(false);
        }
    };

    useEffect(() => {
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.attributeName === 'data-theme') {
                    setIsDark(document.documentElement.getAttribute('data-theme') === 'dark');
                }
            });
        });
        observer.observe(document.documentElement, { attributes: true });
        return () => observer.disconnect();
    }, []);

    const theme = {
        bg: isDark ? '#1e293b' : 'white',
        bgSecondary: isDark ? '#0f172a' : '#f8fafc',
        bgTertiary: isDark ? '#334155' : '#f1f5f9',
        text: isDark ? '#f1f5f9' : '#1e293b',
        textSecondary: isDark ? '#94a3b8' : '#64748b',
        border: isDark ? '#334155' : '#e2e8f0',
        inputBg: isDark ? '#1e293b' : 'white',
        cardShadow: isDark ? '0 2px 8px rgba(0,0,0,0.3)' : '0 2px 8px rgba(0,0,0,0.08)',
    };

    // Auto-hide messages
    useEffect(() => {
        if (successMessage) {
            const timer = setTimeout(() => setSuccessMessage(''), 3000);
            return () => clearTimeout(timer);
        }
    }, [successMessage]);

    useEffect(() => {
        if (error) {
            const timer = setTimeout(() => setError(''), 5000);
            return () => clearTimeout(timer);
        }
    }, [error]);

    // Update profile data when userProfile changes
    useEffect(() => {
        if (userProfile) {
            setProfileData({
                displayName: userProfile.displayName || '',
                phone: userProfile.phone || '',
                address: userProfile.address || ''
            });
        }
    }, [userProfile]);

    const handleProfileUpdate = async () => {
        if (!profileData.displayName.trim()) {
            setError('Display name is required');
            return;
        }
        
        setLoading(true);
        try {
            const services = window.FirebaseServices;
            if (services?.userService && currentUser) {
                const result = await services.userService.updateUserProfile(currentUser.uid, {
                    displayName: profileData.displayName.trim(),
                    phone: profileData.phone.trim(),
                    address: profileData.address.trim()
                });
                
                if (result.success) {
                    setSuccessMessage('Profile updated successfully!');
                } else {
                    setError(result.error || 'Failed to update profile');
                }
            }
        } catch (err) {
            setError(err.message || 'Failed to update profile');
        } finally {
            setLoading(false);
        }
    };

    const handlePasswordChange = async () => {
        if (!passwordData.newPassword || !passwordData.confirmPassword) {
            setError('Please fill in all password fields');
            return;
        }
        if (passwordData.newPassword !== passwordData.confirmPassword) {
            setError('New passwords do not match');
            return;
        }
        if (passwordData.newPassword.length < 6) {
            setError('Password must be at least 6 characters');
            return;
        }
        
        setLoading(true);
        try {
            const services = window.FirebaseServices;
            if (services?.authService) {
                const result = await services.authService.updatePassword(passwordData.newPassword);
                if (result.success) {
                    setSuccessMessage('Password changed successfully!');
                    setPasswordData({ currentPassword: '', newPassword: '', confirmPassword: '' });
                } else {
                    setError(result.error || 'Failed to change password');
                }
            }
        } catch (err) {
            setError(err.message || 'Failed to change password');
        } finally {
            setLoading(false);
        }
    };

    const tabs = [
        { id: 'profile', label: 'My Profile', icon: 'üë§' },
        { id: 'account', label: 'Account Settings', icon: '‚öôÔ∏è' },
        { id: 'support', label: 'Help & Support', icon: '‚ùì' }
    ];

    const inputStyle = {
        width: '100%',
        padding: '12px 14px',
        border: `1px solid ${theme.border}`,
        borderRadius: '0',
        fontSize: '14px',
        backgroundColor: theme.inputBg,
        color: theme.text,
        outline: 'none',
        transition: 'border-color 0.2s',
        boxSizing: 'border-box'
    };

    const labelStyle = {
        display: 'block',
        marginBottom: '8px',
        fontSize: '13px',
        fontWeight: '600',
        color: theme.text,
        textTransform: 'uppercase',
        letterSpacing: '0.5px'
    };

    const cardStyle = {
        background: theme.bg,
        border: `1px solid ${theme.border}`,
        borderRadius: '0',
        padding: '28px',
        marginBottom: '24px',
        boxShadow: theme.cardShadow
    };

    return (
        <div style={{ padding: '0', maxWidth: '100%' }}>
            {/* Messages */}
            {successMessage && (
                <div style={{ 
                    padding: '14px 20px', 
                    background: '#dcfce7', 
                    border: '1px solid #86efac', 
                    borderRadius: '0', 
                    color: '#166534', 
                    marginBottom: '24px',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '10px',
                    fontWeight: '500'
                }}>
                    <span>‚úì</span> {successMessage}
                </div>
            )}
            {error && (
                <div style={{ 
                    padding: '14px 20px', 
                    background: '#fef2f2', 
                    border: '1px solid #fecaca', 
                    borderRadius: '0', 
                    color: '#dc2626', 
                    marginBottom: '24px',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '10px',
                    fontWeight: '500'
                }}>
                    <span>‚úï</span> {error}
                </div>
            )}

            {/* Tabs */}
            <div style={{ 
                display: 'flex', 
                gap: '0', 
                marginBottom: '32px',
                background: 'transparent',
                borderBottom: `2px solid ${theme.border}`
            }}>
                {tabs.map(tab => (
                    <button
                        key={tab.id}
                        onClick={() => setActiveTab(tab.id)}
                        style={{
                            padding: '14px 28px',
                            border: 'none',
                            borderBottom: activeTab === tab.id ? '2px solid #3b82f6' : '2px solid transparent',
                            marginBottom: '-2px',
                            borderRadius: '0',
                            background: 'transparent',
                            color: activeTab === tab.id ? '#3b82f6' : theme.textSecondary,
                            fontWeight: activeTab === tab.id ? '600' : '500',
                            fontSize: '14px',
                            cursor: 'pointer',
                            transition: 'all 0.2s',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '10px'
                        }}
                    >
                        <span style={{ fontSize: '16px' }}>{tab.icon}</span>
                        {tab.label}
                    </button>
                ))}
            </div>

            {/* Profile Tab */}
            {activeTab === 'profile' && (
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '24px' }}>
                    {/* Left Column - Profile Card */}
                    <div style={cardStyle}>
                        <h3 style={{ margin: '0 0 24px', color: theme.text, fontSize: '16px', fontWeight: '700', textTransform: 'uppercase', letterSpacing: '0.5px', borderBottom: `1px solid ${theme.border}`, paddingBottom: '16px' }}>
                            Profile Information
                        </h3>
                        
                        {/* Profile Header */}
                        <div style={{ 
                            display: 'flex', 
                            alignItems: 'center', 
                            gap: '24px', 
                            marginBottom: '28px',
                            padding: '24px',
                            background: theme.bgSecondary,
                            border: `1px solid ${theme.border}`
                        }}>
                            <div style={{ position: 'relative' }}>
                                <input
                                    type="file"
                                    ref={fileInputRef}
                                    onChange={handleImageUpload}
                                    accept="image/*"
                                    style={{ display: 'none' }}
                                />
                                <div 
                                    onClick={() => fileInputRef.current?.click()}
                                    style={{
                                        width: '80px',
                                        height: '80px',
                                        background: profileImage ? `url(${profileImage}) center/cover` : 'linear-gradient(135deg, #3b82f6 0%, #1e40af 100%)',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        color: 'white',
                                        fontSize: '32px',
                                        fontWeight: '600',
                                        cursor: 'pointer',
                                        position: 'relative',
                                        overflow: 'hidden'
                                    }}
                                >
                                    {!profileImage && (userProfile?.displayName || userProfile?.email || 'U').charAt(0).toUpperCase()}
                                    <div style={{
                                        position: 'absolute',
                                        bottom: 0,
                                        left: 0,
                                        right: 0,
                                        background: 'rgba(0,0,0,0.6)',
                                        color: 'white',
                                        fontSize: '10px',
                                        padding: '4px 0',
                                        textAlign: 'center',
                                        fontWeight: '500'
                                    }}>
                                        {uploadingImage ? '...' : 'üì∑ Edit'}
                                    </div>
                                </div>
                            </div>
                            <div style={{ flex: 1 }}>
                                <div style={{ fontSize: '20px', fontWeight: '700', color: theme.text }}>
                                    {userProfile?.displayName || userProfile?.email?.split('@')[0] || 'User'}
                                </div>
                                <div style={{ fontSize: '14px', color: theme.textSecondary, marginTop: '6px' }}>
                                    {userProfile?.email}
                                </div>
                                <div style={{ 
                                    display: 'inline-block',
                                    marginTop: '10px',
                                    padding: '6px 14px',
                                    background: '#3b82f6',
                                    color: 'white',
                                    fontSize: '11px',
                                    fontWeight: '600',
                                    textTransform: 'uppercase',
                                    letterSpacing: '0.5px'
                                }}>
                                    {userProfile?.role || 'User'}
                                </div>
                            </div>
                        </div>

                        {/* Profile Form */}
                        <div style={{ display: 'grid', gap: '20px' }}>
                            <div>
                                <label style={labelStyle}>Display Name</label>
                                <input
                                    type="text"
                                    value={profileData.displayName}
                                    onChange={(e) => setProfileData(prev => ({ ...prev, displayName: e.target.value }))}
                                    placeholder="Enter your name"
                                    style={inputStyle}
                                />
                            </div>
                            <div>
                                <label style={labelStyle}>Phone Number</label>
                                <input
                                    type="tel"
                                    value={profileData.phone}
                                    onChange={(e) => setProfileData(prev => ({ ...prev, phone: e.target.value }))}
                                    placeholder="Enter phone number"
                                    style={inputStyle}
                                />
                            </div>
                            <div>
                                <label style={labelStyle}>Address</label>
                                <input
                                    type="text"
                                    value={profileData.address}
                                    onChange={(e) => setProfileData(prev => ({ ...prev, address: e.target.value }))}
                                    placeholder="Enter your address"
                                    style={inputStyle}
                                />
                            </div>
                        </div>

                        <div style={{ marginTop: '28px', display: 'flex', justifyContent: 'flex-end' }}>
                            <button
                                onClick={handleProfileUpdate}
                                disabled={loading}
                                style={{
                                    padding: '12px 32px',
                                    background: loading ? '#93c5fd' : '#3b82f6',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '0',
                                    fontSize: '13px',
                                    fontWeight: '600',
                                    cursor: loading ? 'wait' : 'pointer',
                                    textTransform: 'uppercase',
                                    letterSpacing: '0.5px'
                                }}
                            >
                                {loading ? 'Saving...' : 'Save Changes'}
                            </button>
                        </div>
                    </div>

                    {/* Right Column - Account Info */}
                    <div>
                        <div style={cardStyle}>
                            <h3 style={{ margin: '0 0 24px', color: theme.text, fontSize: '16px', fontWeight: '700', textTransform: 'uppercase', letterSpacing: '0.5px', borderBottom: `1px solid ${theme.border}`, paddingBottom: '16px' }}>
                                Account Details
                            </h3>
                            <div style={{ display: 'grid', gap: '16px' }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', padding: '14px 16px', background: theme.bgSecondary, border: `1px solid ${theme.border}` }}>
                                    <span style={{ color: theme.textSecondary, fontWeight: '500' }}>Email Address</span>
                                    <span style={{ color: theme.text, fontWeight: '600' }}>{userProfile?.email || '-'}</span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', padding: '14px 16px', background: theme.bgSecondary, border: `1px solid ${theme.border}` }}>
                                    <span style={{ color: theme.textSecondary, fontWeight: '500' }}>Role</span>
                                    <span style={{ color: theme.text, fontWeight: '600', textTransform: 'capitalize' }}>{userProfile?.role || 'User'}</span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', padding: '14px 16px', background: theme.bgSecondary, border: `1px solid ${theme.border}` }}>
                                    <span style={{ color: theme.textSecondary, fontWeight: '500' }}>Status</span>
                                    <span style={{ color: '#22c55e', fontWeight: '600' }}>‚óè Active</span>
                                </div>
                            </div>
                        </div>

                        <div style={cardStyle}>
                            <h3 style={{ margin: '0 0 24px', color: theme.text, fontSize: '16px', fontWeight: '700', textTransform: 'uppercase', letterSpacing: '0.5px', borderBottom: `1px solid ${theme.border}`, paddingBottom: '16px' }}>
                                Session Info
                            </h3>
                            <div style={{ display: 'grid', gap: '16px' }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', padding: '14px 16px', background: theme.bgSecondary, border: `1px solid ${theme.border}` }}>
                                    <span style={{ color: theme.textSecondary, fontWeight: '500' }}>Last Login</span>
                                    <span style={{ color: theme.text, fontSize: '13px' }}>{currentUser?.metadata?.lastSignInTime ? new Date(currentUser.metadata.lastSignInTime).toLocaleDateString() : '-'}</span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', padding: '14px 16px', background: theme.bgSecondary, border: `1px solid ${theme.border}` }}>
                                    <span style={{ color: theme.textSecondary, fontWeight: '500' }}>Member Since</span>
                                    <span style={{ color: theme.text, fontSize: '13px' }}>{currentUser?.metadata?.creationTime ? new Date(currentUser.metadata.creationTime).toLocaleDateString() : '-'}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* Account Settings Tab */}
            {activeTab === 'account' && (
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '24px' }}>
                    {/* Left Column */}
                    <div>
                        {/* Change Password */}
                        <div style={cardStyle}>
                            <h3 style={{ margin: '0 0 24px', color: theme.text, fontSize: '16px', fontWeight: '700', textTransform: 'uppercase', letterSpacing: '0.5px', borderBottom: `1px solid ${theme.border}`, paddingBottom: '16px' }}>
                                üîê Change Password
                            </h3>
                            <div style={{ display: 'grid', gap: '20px' }}>
                                <div>
                                    <label style={labelStyle}>New Password</label>
                                    <input
                                        type="password"
                                        value={passwordData.newPassword}
                                        onChange={(e) => setPasswordData(prev => ({ ...prev, newPassword: e.target.value }))}
                                        placeholder="Enter new password"
                                        style={inputStyle}
                                    />
                                </div>
                                <div>
                                    <label style={labelStyle}>Confirm New Password</label>
                                    <input
                                        type="password"
                                        value={passwordData.confirmPassword}
                                        onChange={(e) => setPasswordData(prev => ({ ...prev, confirmPassword: e.target.value }))}
                                        placeholder="Confirm new password"
                                        style={inputStyle}
                                    />
                                </div>
                                <button
                                    onClick={handlePasswordChange}
                                    disabled={loading}
                                    style={{
                                        padding: '12px 32px',
                                        background: loading ? '#fca5a5' : '#ef4444',
                                        color: 'white',
                                        border: 'none',
                                        borderRadius: '0',
                                        fontSize: '13px',
                                        fontWeight: '600',
                                        cursor: loading ? 'wait' : 'pointer',
                                        width: 'fit-content',
                                        textTransform: 'uppercase',
                                        letterSpacing: '0.5px'
                                    }}
                                >
                                    {loading ? 'Changing...' : 'Change Password'}
                                </button>
                            </div>
                        </div>

                        {/* Preferences */}
                        <div style={cardStyle}>
                            <h3 style={{ margin: '0 0 24px', color: theme.text, fontSize: '16px', fontWeight: '700', textTransform: 'uppercase', letterSpacing: '0.5px', borderBottom: `1px solid ${theme.border}`, paddingBottom: '16px' }}>
                                üé® Preferences
                            </h3>
                            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', padding: '16px', background: theme.bgSecondary, border: `1px solid ${theme.border}` }}>
                                <div>
                                    <div style={{ color: theme.text, fontWeight: '600' }}>Dark Mode</div>
                                    <div style={{ color: theme.textSecondary, fontSize: '13px', marginTop: '4px' }}>Toggle dark/light theme</div>
                                </div>
                                <button
                                    onClick={toggleTheme}
                                    style={{ 
                                        padding: '10px 20px', 
                                        background: isDark ? '#3b82f6' : '#e2e8f0', 
                                        color: isDark ? 'white' : '#64748b',
                                        fontSize: '12px',
                                        fontWeight: '600',
                                        textTransform: 'uppercase',
                                        letterSpacing: '0.5px',
                                        border: 'none',
                                        cursor: 'pointer',
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '8px',
                                        transition: 'all 0.2s'
                                    }}
                                >
                                    {isDark ? 'üåô' : '‚òÄÔ∏è'} {isDark ? 'Dark' : 'Light'}
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* Right Column */}
                    <div>
                        {/* Session Info */}
                        <div style={cardStyle}>
                            <h3 style={{ margin: '0 0 24px', color: theme.text, fontSize: '16px', fontWeight: '700', textTransform: 'uppercase', letterSpacing: '0.5px', borderBottom: `1px solid ${theme.border}`, paddingBottom: '16px' }}>
                                üì± Session Information
                            </h3>
                            <div style={{ display: 'grid', gap: '16px' }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', padding: '14px 16px', background: theme.bgSecondary, border: `1px solid ${theme.border}` }}>
                                    <span style={{ color: theme.textSecondary, fontWeight: '500' }}>User ID</span>
                                    <span style={{ color: theme.text, fontFamily: 'monospace', fontSize: '11px' }}>{currentUser?.uid ? currentUser.uid.substring(0, 16) + '...' : '-'}</span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', padding: '14px 16px', background: theme.bgSecondary, border: `1px solid ${theme.border}` }}>
                                    <span style={{ color: theme.textSecondary, fontWeight: '500' }}>Last Sign In</span>
                                    <span style={{ color: theme.text, fontSize: '13px' }}>{currentUser?.metadata?.lastSignInTime ? new Date(currentUser.metadata.lastSignInTime).toLocaleString() : '-'}</span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', padding: '14px 16px', background: theme.bgSecondary, border: `1px solid ${theme.border}` }}>
                                    <span style={{ color: theme.textSecondary, fontWeight: '500' }}>Account Created</span>
                                    <span style={{ color: theme.text, fontSize: '13px' }}>{currentUser?.metadata?.creationTime ? new Date(currentUser.metadata.creationTime).toLocaleString() : '-'}</span>
                                </div>
                            </div>
                        </div>

                        {/* Security Status */}
                        <div style={cardStyle}>
                            <h3 style={{ margin: '0 0 24px', color: theme.text, fontSize: '16px', fontWeight: '700', textTransform: 'uppercase', letterSpacing: '0.5px', borderBottom: `1px solid ${theme.border}`, paddingBottom: '16px' }}>
                                üîí Security Status
                            </h3>
                            <div style={{ display: 'grid', gap: '16px' }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '14px 16px', background: theme.bgSecondary, border: `1px solid ${theme.border}` }}>
                                    <span style={{ color: theme.textSecondary, fontWeight: '500' }}>Email Verified</span>
                                    <span style={{ color: currentUser?.emailVerified ? '#22c55e' : '#f59e0b', fontWeight: '600' }}>
                                        {currentUser?.emailVerified ? '‚óè Verified' : '‚óã Pending'}
                                    </span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '14px 16px', background: theme.bgSecondary, border: `1px solid ${theme.border}` }}>
                                    <span style={{ color: theme.textSecondary, fontWeight: '500' }}>Account Status</span>
                                    <span style={{ color: '#22c55e', fontWeight: '600' }}>‚óè Active</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* Help & Support Tab */}
            {activeTab === 'support' && (
                <div>
                    {/* Quick Help */}
                    <div style={cardStyle}>
                        <h3 style={{ margin: '0 0 24px', color: theme.text, fontSize: '16px', fontWeight: '700', textTransform: 'uppercase', letterSpacing: '0.5px', borderBottom: `1px solid ${theme.border}`, paddingBottom: '16px' }}>
                            üìö Quick Help
                        </h3>
                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '20px' }}>
                            {[
                                { icon: 'üöó', title: 'Vehicle Intake', desc: 'Register vehicles and manage queue' },
                                { icon: 'üí≥', title: 'Billing & Payments', desc: 'Process payments and invoices' },
                                { icon: 'üë•', title: 'Customer Management', desc: 'Manage customers and loyalty' },
                                { icon: 'üìä', title: 'Reports', desc: 'Analytics and performance' }
                            ].map((item, idx) => (
                                <div key={idx} style={{ 
                                    padding: '20px', 
                                    background: theme.bgSecondary, 
                                    border: `1px solid ${theme.border}`,
                                    cursor: 'pointer',
                                    transition: 'all 0.2s',
                                    textAlign: 'center'
                                }}>
                                    <div style={{ fontSize: '32px', marginBottom: '12px' }}>{item.icon}</div>
                                    <div style={{ fontWeight: '600', color: theme.text, marginBottom: '6px', fontSize: '14px' }}>{item.title}</div>
                                    <div style={{ fontSize: '12px', color: theme.textSecondary }}>{item.desc}</div>
                                </div>
                            ))}
                        </div>
                    </div>

                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '24px' }}>
                        {/* Contact Support */}
                        <div style={cardStyle}>
                            <h3 style={{ margin: '0 0 24px', color: theme.text, fontSize: '16px', fontWeight: '700', textTransform: 'uppercase', letterSpacing: '0.5px', borderBottom: `1px solid ${theme.border}`, paddingBottom: '16px' }}>
                                üìû Contact Support
                            </h3>
                            <div style={{ display: 'grid', gap: '16px' }}>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '16px', padding: '18px', background: theme.bgSecondary, border: `1px solid ${theme.border}` }}>
                                    <div style={{ width: '44px', height: '44px', background: '#3b82f6', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '20px', color: 'white' }}>üìß</div>
                                    <div>
                                        <div style={{ fontWeight: '600', color: theme.text, fontSize: '14px' }}>Email Support</div>
                                        <div style={{ fontSize: '13px', color: theme.textSecondary, marginTop: '2px' }}>support@ecospark.co.ke</div>
                                    </div>
                                </div>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '16px', padding: '18px', background: theme.bgSecondary, border: `1px solid ${theme.border}` }}>
                                    <div style={{ width: '44px', height: '44px', background: '#22c55e', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '20px', color: 'white' }}>üì±</div>
                                    <div>
                                        <div style={{ fontWeight: '600', color: theme.text, fontSize: '14px' }}>Phone Support</div>
                                        <div style={{ fontSize: '13px', color: theme.textSecondary, marginTop: '2px' }}>+254 700 000 000</div>
                                    </div>
                                </div>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '16px', padding: '18px', background: theme.bgSecondary, border: `1px solid ${theme.border}` }}>
                                    <div style={{ width: '44px', height: '44px', background: '#22c55e', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '20px', color: 'white' }}>üí¨</div>
                                    <div>
                                        <div style={{ fontWeight: '600', color: theme.text, fontSize: '14px' }}>WhatsApp</div>
                                        <div style={{ fontSize: '13px', color: theme.textSecondary, marginTop: '2px' }}>+254 700 000 000</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* System Info */}
                        <div style={cardStyle}>
                            <h3 style={{ margin: '0 0 24px', color: theme.text, fontSize: '16px', fontWeight: '700', textTransform: 'uppercase', letterSpacing: '0.5px', borderBottom: `1px solid ${theme.border}`, paddingBottom: '16px' }}>
                                ‚ÑπÔ∏è System Information
                            </h3>
                            <div style={{ display: 'grid', gap: '0' }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', padding: '14px 0', borderBottom: `1px solid ${theme.border}` }}>
                                    <span style={{ color: theme.textSecondary, fontWeight: '500' }}>Application</span>
                                    <span style={{ color: theme.text, fontWeight: '600' }}>EcoSpark</span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', padding: '14px 0', borderBottom: `1px solid ${theme.border}` }}>
                                    <span style={{ color: theme.textSecondary, fontWeight: '500' }}>Version</span>
                                    <span style={{ color: theme.text }}>1.0.0</span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', padding: '14px 0' }}>
                                    <span style={{ color: theme.textSecondary, fontWeight: '500' }}>Last Updated</span>
                                    <span style={{ color: theme.text }}>January 2026</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}

// Reports & Analytics Component
function ReportsAnalytics() {
    const [loading, setLoading] = useState(true);
    const [activeTab, setActiveTab] = useState('overview');
    const [dateRange, setDateRange] = useState('month');
    const [reportType, setReportType] = useState('summary');
    const [showPreview, setShowPreview] = useState(false);
    const [previewContent, setPreviewContent] = useState('');
    const [data, setData] = useState({
        billing: [], expenses: [], inventory: [], fleet: [], customers: [], staff: [], vehicles: []
    });
    const [isDark, setIsDark] = useState(document.documentElement.getAttribute('data-theme') === 'dark');

    useEffect(() => {
        const observer = new MutationObserver(() => setIsDark(document.documentElement.getAttribute('data-theme') === 'dark'));
        observer.observe(document.documentElement, { attributes: true });
        return () => observer.disconnect();
    }, []);

    const theme = {
        bg: isDark ? '#1e293b' : 'white',
        bgSecondary: isDark ? '#0f172a' : '#f8fafc',
        bgTertiary: isDark ? '#334155' : '#f1f5f9',
        text: isDark ? '#f1f5f9' : '#1e293b',
        textSecondary: isDark ? '#94a3b8' : '#64748b',
        border: isDark ? '#334155' : '#e2e8f0',
        inputBg: isDark ? '#1e293b' : 'white'
    };

    const formatCurrency = (amt) => `KSH ${(amt || 0).toLocaleString()}`;

    // Load all data
    useEffect(() => {
        const unsubs = [];
        const init = async () => {
            let services = window.FirebaseServices;
            let attempts = 0;
            while (!services && attempts < 50) {
                await new Promise(r => setTimeout(r, 100));
                services = window.FirebaseServices;
                attempts++;
            }
            if (!services) { setLoading(false); return; }

            // Subscribe to billing/invoices (real-time revenue data)
            if (services.billingService?.subscribeToInvoices) {
                unsubs.push(services.billingService.subscribeToInvoices((invoices) => {
                    setData(prev => ({ ...prev, billing: invoices }));
                }));
            }
            // Subscribe to expenses
            if (services.expensesService?.subscribeToExpenses) {
                unsubs.push(services.expensesService.subscribeToExpenses((records) => {
                    setData(prev => ({ ...prev, expenses: records }));
                }));
            }
            // Subscribe to inventory
            if (services.inventoryService?.subscribeToItems) {
                unsubs.push(services.inventoryService.subscribeToItems((items) => {
                    setData(prev => ({ ...prev, inventory: items }));
                }));
            }
            // Subscribe to fleet
            if (services.fleetService?.subscribeToAccounts) {
                unsubs.push(services.fleetService.subscribeToAccounts((accounts) => {
                    setData(prev => ({ ...prev, fleet: accounts }));
                }));
            }
            // Subscribe to customers
            if (services.customerService?.subscribeToCustomers) {
                unsubs.push(services.customerService.subscribeToCustomers((customers) => {
                    setData(prev => ({ ...prev, customers: customers }));
                }));
            }
            // Subscribe to staff
            if (services.staffService?.subscribeToStaff) {
                unsubs.push(services.staffService.subscribeToStaff((staff) => {
                    setData(prev => ({ ...prev, staff: staff }));
                }));
            }
            // Subscribe to vehicles/intake
            if (services.intakeRecordsService?.subscribeToRecords) {
                unsubs.push(services.intakeRecordsService.subscribeToRecords((vehicles) => {
                    setData(prev => ({ ...prev, vehicles: vehicles }));
                }));
            }
            setLoading(false);
        };
        init();
        return () => unsubs.forEach(u => u && u());
    }, []);

    // Calculate analytics
    const now = new Date();
    const getDateFilter = () => {
        if (dateRange === 'today') return new Date(now.getFullYear(), now.getMonth(), now.getDate());
        if (dateRange === 'week') { const d = new Date(now); d.setDate(d.getDate() - 7); return d; }
        if (dateRange === 'month') return new Date(now.getFullYear(), now.getMonth(), 1);
        if (dateRange === 'year') return new Date(now.getFullYear(), 0, 1);
        return new Date(0);
    };
    const filterDate = getDateFilter();

    const filterByDate = (items, dateField = 'createdAt') => {
        return items.filter(item => {
            const d = item[dateField] || item.date || item.createdAt;
            return d && new Date(d) >= filterDate;
        });
    };

    const filteredBilling = filterByDate(data.billing);
    const filteredExpenses = filterByDate(data.expenses, 'date');
    const filteredVehicles = filterByDate(data.vehicles);

    // Key Metrics - using totalAmount from invoices, with fallbacks
    const totalRevenue = filteredBilling.reduce((s, b) => s + (b.totalAmount || b.total || b.amount || 0), 0);
    const totalExpenses = filteredExpenses.reduce((s, e) => s + (e.amount || 0), 0);
    const netProfit = totalRevenue - totalExpenses;
    const totalServices = filteredBilling.length;
    const avgTicket = totalServices > 0 ? totalRevenue / totalServices : 0;

    // Count paid vs unpaid
    const paidInvoices = filteredBilling.filter(b => b.paymentStatus === 'paid');
    const unpaidInvoices = filteredBilling.filter(b => b.paymentStatus !== 'paid');
    const paidRevenue = paidInvoices.reduce((s, b) => s + (b.totalAmount || b.total || b.amount || 0), 0);
    const unpaidRevenue = unpaidInvoices.reduce((s, b) => s + (b.totalAmount || b.total || b.amount || 0), 0);

    // Inventory stats
    const inventoryValue = data.inventory.reduce((s, i) => s + ((i.quantity || 0) * (i.unitCost || 0)), 0);
    const lowStockItems = data.inventory.filter(i => (i.quantity || 0) <= (i.reorderLevel || 5)).length;

    // Fleet stats
    const fleetBalance = data.fleet.reduce((s, f) => s + (f.balance || 0), 0);
    const fleetSpent = data.fleet.reduce((s, f) => s + (f.totalSpent || 0), 0);
    const fleetVehicles = data.fleet.reduce((s, f) => s + (f.vehicles?.length || 0), 0);

    // Customer stats
    const totalCustomers = data.customers.length;
    const loyaltyPoints = data.customers.reduce((s, c) => s + (c.loyaltyPoints || 0), 0);

    // Revenue by service type/source
    const revenueByService = {};
    filteredBilling.forEach(b => {
        // Try to get service name from services array, or use source
        let svc = 'Other';
        if (b.services && b.services.length > 0) {
            svc = b.services[0].name || b.source || 'Other';
        } else {
            svc = b.source === 'wash' ? 'Car Wash' : b.source === 'garage' ? 'Garage Service' : (b.service || b.packageName || 'Other');
        }
        revenueByService[svc] = (revenueByService[svc] || 0) + (b.totalAmount || b.total || b.amount || 0);
    });
    const topServices = Object.entries(revenueByService).sort((a, b) => b[1] - a[1]).slice(0, 5);

    // Expenses by category
    const expensesByCategory = {};
    filteredExpenses.forEach(e => {
        const cat = e.category || 'Other';
        expensesByCategory[cat] = (expensesByCategory[cat] || 0) + (e.amount || 0);
    });
    const topExpenseCategories = Object.entries(expensesByCategory).sort((a, b) => b[1] - a[1]).slice(0, 5);

    // Daily revenue for chart (last 7 days)
    const dailyRevenue = [];
    for (let i = 6; i >= 0; i--) {
        const d = new Date(now);
        d.setDate(d.getDate() - i);
        const dateStr = d.toISOString().split('T')[0];
        const dayRevenue = data.billing.filter(b => (b.createdAt || b.date || '').startsWith(dateStr)).reduce((s, b) => s + (b.totalAmount || b.total || b.amount || 0), 0);
        dailyRevenue.push({ day: d.toLocaleDateString('en', { weekday: 'short' }), date: dateStr, amount: dayRevenue });
    }
    const maxDailyRevenue = Math.max(...dailyRevenue.map(d => d.amount), 1);

    // Print report
    const printReport = () => {
        const content = `
<!DOCTYPE html><html><head><title>EcoSpark Analytics Report</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}body{font-family:'Segoe UI',Arial,sans-serif;padding:30px;color:#1e293b}
.header{text-align:center;margin-bottom:30px;padding-bottom:20px;border-bottom:2px solid #1e293b}
.logo{font-size:28px;font-weight:800;color:#10b981}.logo span{color:#1e293b}
.subtitle{color:#64748b;margin-top:8px}
.section{margin-bottom:24px}.section-title{font-size:16px;font-weight:700;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid #e2e8f0}
.grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px}
.card{background:#f8fafc;border:1px solid #e2e8f0;padding:16px;text-align:center}
.card .value{font-size:24px;font-weight:800}.card .label{font-size:11px;color:#64748b;text-transform:uppercase;margin-top:4px}
.green{color:#10b981}.red{color:#ef4444}.blue{color:#3b82f6}.purple{color:#8b5cf6}
table{width:100%;border-collapse:collapse}th{background:#1e293b;color:white;padding:10px;text-align:left;font-size:11px;text-transform:uppercase}
td{padding:10px;border-bottom:1px solid #e2e8f0}tr:nth-child(even){background:#f8fafc}
.footer{margin-top:30px;text-align:center;color:#64748b;font-size:12px;padding-top:20px;border-top:1px solid #e2e8f0}
@media print{body{padding:20px}}
</style></head><body>
<div class="header"><div class="logo">Eco<span>Spark</span></div><div class="subtitle">Analytics Report - ${new Date().toLocaleDateString()}</div></div>

<div class="section"><div class="section-title">Key Performance Metrics (${dateRange === 'today' ? 'Today' : dateRange === 'week' ? 'Last 7 Days' : dateRange === 'month' ? 'This Month' : 'This Year'})</div>
<div class="grid">
<div class="card"><div class="value green">KSH ${totalRevenue.toLocaleString()}</div><div class="label">Total Revenue</div></div>
<div class="card"><div class="value red">KSH ${totalExpenses.toLocaleString()}</div><div class="label">Total Expenses</div></div>
<div class="card"><div class="value ${netProfit >= 0 ? 'green' : 'red'}">KSH ${netProfit.toLocaleString()}</div><div class="label">Net Profit</div></div>
<div class="card"><div class="value blue">${totalServices}</div><div class="label">Services Completed</div></div>
</div></div>

<div class="section"><div class="section-title">Business Summary</div>
<div class="grid">
<div class="card"><div class="value blue">KSH ${avgTicket.toLocaleString()}</div><div class="label">Avg Ticket</div></div>
<div class="card"><div class="value purple">${totalCustomers}</div><div class="label">Total Customers</div></div>
<div class="card"><div class="value green">KSH ${inventoryValue.toLocaleString()}</div><div class="label">Inventory Value</div></div>
<div class="card"><div class="value blue">${fleetVehicles}</div><div class="label">Fleet Vehicles</div></div>
</div></div>

${topServices.length > 0 ? `<div class="section"><div class="section-title">Top Services by Revenue</div>
<table><thead><tr><th>Service</th><th style="text-align:right">Revenue</th><th style="text-align:right">% of Total</th></tr></thead>
<tbody>${topServices.map(([svc, amt]) => `<tr><td>${svc}</td><td style="text-align:right">KSH ${amt.toLocaleString()}</td><td style="text-align:right">${totalRevenue > 0 ? ((amt / totalRevenue) * 100).toFixed(1) : 0}%</td></tr>`).join('')}</tbody></table></div>` : ''}

${topExpenseCategories.length > 0 ? `<div class="section"><div class="section-title">Expenses by Category</div>
<table><thead><tr><th>Category</th><th style="text-align:right">Amount</th><th style="text-align:right">% of Total</th></tr></thead>
<tbody>${topExpenseCategories.map(([cat, amt]) => `<tr><td>${cat}</td><td style="text-align:right">KSH ${amt.toLocaleString()}</td><td style="text-align:right">${totalExpenses > 0 ? ((amt / totalExpenses) * 100).toFixed(1) : 0}%</td></tr>`).join('')}</tbody></table></div>` : ''}

<div class="footer">Generated on ${new Date().toLocaleString()} | EcoSpark Car Wash Management System</div>
</body></html>`;
        const w = window.open('', '_blank');
        w.document.write(content);
        w.document.close();
        w.onload = () => w.print();
    };

    const tabStyle = (active) => ({
        padding: '12px 24px', background: active ? '#3b82f6' : 'transparent', color: active ? 'white' : theme.textSecondary,
        border: 'none', cursor: 'pointer', fontWeight: '600', fontSize: '13px', borderBottom: active ? 'none' : `1px solid ${theme.border}`
    });
    const cardStyle = { background: theme.bg, border: `1px solid ${theme.border}`, padding: '20px' };
    const metricCard = (value, label, color = theme.text) => (
        <div style={{ ...cardStyle, textAlign: 'center' }}>
            <div style={{ fontSize: '28px', fontWeight: '800', color }}>{value}</div>
            <div style={{ fontSize: '11px', color: theme.textSecondary, textTransform: 'uppercase', marginTop: '6px', fontWeight: '600' }}>{label}</div>
        </div>
    );

    if (loading) {
        return <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', height: '400px', color: theme.textSecondary }}>Loading analytics...</div>;
    }

    return (
        <div style={{ padding: 0, width: '100%' }}>
            {/* Header */}
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '16px 20px', background: theme.bg, borderBottom: `1px solid ${theme.border}` }}>
                <div style={{ display: 'flex', gap: '0' }}>
                    <button onClick={() => setActiveTab('overview')} style={tabStyle(activeTab === 'overview')}>Overview</button>
                    <button onClick={() => setActiveTab('revenue')} style={tabStyle(activeTab === 'revenue')}>Revenue</button>
                    <button onClick={() => setActiveTab('expenses')} style={tabStyle(activeTab === 'expenses')}>Expenses</button>
                    <button onClick={() => setActiveTab('operations')} style={tabStyle(activeTab === 'operations')}>Operations</button>
                    <button onClick={() => setActiveTab('generate')} style={tabStyle(activeTab === 'generate')}>Generate Reports</button>
                </div>
                <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '6px', padding: '8px 12px', background: '#10b981', color: 'white', fontSize: '12px', fontWeight: '600' }}>
                        <span style={{ width: '8px', height: '8px', background: '#fff', borderRadius: '50%', animation: 'pulse 1.5s infinite' }}></span>
                        LIVE
                    </div>
                    <select value={dateRange} onChange={(e) => setDateRange(e.target.value)} style={{ padding: '10px 14px', border: `1px solid ${theme.border}`, background: theme.inputBg, color: theme.text, fontSize: '13px' }}>
                        <option value="today">Today</option>
                        <option value="week">Last 7 Days</option>
                        <option value="month">This Month</option>
                        <option value="year">This Year</option>
                        <option value="all">All Time</option>
                    </select>
                    <button onClick={printReport} style={{ padding: '10px 20px', background: '#1e293b', color: 'white', border: 'none', fontWeight: '600', cursor: 'pointer' }}>Print Report</button>
                </div>
            </div>

            {/* Overview Tab */}
            {activeTab === 'overview' && (
                <div style={{ padding: '20px' }}>
                    {/* Key Metrics */}
                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(5, 1fr)', gap: '16px', marginBottom: '24px' }}>
                        {metricCard(formatCurrency(totalRevenue), 'Total Revenue', '#10b981')}
                        {metricCard(formatCurrency(totalExpenses), 'Total Expenses', '#ef4444')}
                        {metricCard(formatCurrency(netProfit), 'Net Profit', netProfit >= 0 ? '#10b981' : '#ef4444')}
                        {metricCard(totalServices.toString(), 'Services', '#3b82f6')}
                        {metricCard(formatCurrency(avgTicket), 'Avg Ticket', '#8b5cf6')}
                    </div>

                    {/* Charts Row */}
                    <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr', gap: '20px', marginBottom: '24px' }}>
                        {/* Revenue Chart */}
                        <div style={cardStyle}>
                            <h4 style={{ margin: '0 0 16px', color: theme.text, fontWeight: '700' }}>Daily Revenue (Last 7 Days)</h4>
                            <div style={{ display: 'flex', alignItems: 'flex-end', gap: '8px', height: '180px' }}>
                                {dailyRevenue.map((d, i) => (
                                    <div key={i} style={{ flex: 1, display: 'flex', flexDirection: 'column', alignItems: 'center', height: '100%', justifyContent: 'flex-end' }}>
                                        <div style={{ fontSize: '10px', color: '#10b981', fontWeight: '600', marginBottom: '4px' }}>{d.amount > 0 ? `${(d.amount / 1000).toFixed(0)}K` : ''}</div>
                                        <div style={{ width: '100%', background: '#10b981', height: `${(d.amount / maxDailyRevenue) * 140}px`, minHeight: d.amount > 0 ? '4px' : '0' }}></div>
                                        <div style={{ fontSize: '11px', color: theme.textSecondary, marginTop: '8px', fontWeight: '600' }}>{d.day}</div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* Quick Stats */}
                        <div style={cardStyle}>
                            <h4 style={{ margin: '0 0 16px', color: theme.text, fontWeight: '700' }}>Quick Stats</h4>
                            <div style={{ display: 'grid', gap: '12px' }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', padding: '12px', background: theme.bgSecondary }}>
                                    <span style={{ color: theme.textSecondary }}>Customers</span>
                                    <span style={{ fontWeight: '700', color: theme.text }}>{totalCustomers}</span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', padding: '12px', background: theme.bgSecondary }}>
                                    <span style={{ color: theme.textSecondary }}>Fleet Accounts</span>
                                    <span style={{ fontWeight: '700', color: theme.text }}>{data.fleet.length}</span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', padding: '12px', background: theme.bgSecondary }}>
                                    <span style={{ color: theme.textSecondary }}>Fleet Vehicles</span>
                                    <span style={{ fontWeight: '700', color: theme.text }}>{fleetVehicles}</span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', padding: '12px', background: theme.bgSecondary }}>
                                    <span style={{ color: theme.textSecondary }}>Staff Members</span>
                                    <span style={{ fontWeight: '700', color: theme.text }}>{data.staff.length}</span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', padding: '12px', background: theme.bgSecondary }}>
                                    <span style={{ color: theme.textSecondary }}>Inventory Items</span>
                                    <span style={{ fontWeight: '700', color: theme.text }}>{data.inventory.length}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Bottom Row */}
                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '20px' }}>
                        {/* Top Services */}
                        <div style={cardStyle}>
                            <h4 style={{ margin: '0 0 16px', color: theme.text, fontWeight: '700' }}>Top Services</h4>
                            {topServices.length > 0 ? topServices.map(([svc, amt], i) => (
                                <div key={i} style={{ display: 'flex', justifyContent: 'space-between', padding: '10px 0', borderBottom: `1px solid ${theme.border}` }}>
                                    <span style={{ color: theme.text }}>{svc}</span>
                                    <span style={{ fontWeight: '700', color: '#10b981' }}>{formatCurrency(amt)}</span>
                                </div>
                            )) : <div style={{ color: theme.textSecondary, textAlign: 'center', padding: '20px' }}>No data</div>}
                        </div>

                        {/* Expense Categories */}
                        <div style={cardStyle}>
                            <h4 style={{ margin: '0 0 16px', color: theme.text, fontWeight: '700' }}>Top Expense Categories</h4>
                            {topExpenseCategories.length > 0 ? topExpenseCategories.map(([cat, amt], i) => (
                                <div key={i} style={{ display: 'flex', justifyContent: 'space-between', padding: '10px 0', borderBottom: `1px solid ${theme.border}` }}>
                                    <span style={{ color: theme.text }}>{cat}</span>
                                    <span style={{ fontWeight: '700', color: '#ef4444' }}>{formatCurrency(amt)}</span>
                                </div>
                            )) : <div style={{ color: theme.textSecondary, textAlign: 'center', padding: '20px' }}>No data</div>}
                        </div>

                        {/* Inventory & Fleet */}
                        <div style={cardStyle}>
                            <h4 style={{ margin: '0 0 16px', color: theme.text, fontWeight: '700' }}>Assets Overview</h4>
                            <div style={{ display: 'flex', justifyContent: 'space-between', padding: '10px 0', borderBottom: `1px solid ${theme.border}` }}>
                                <span style={{ color: theme.textSecondary }}>Inventory Value</span>
                                <span style={{ fontWeight: '700', color: '#3b82f6' }}>{formatCurrency(inventoryValue)}</span>
                            </div>
                            <div style={{ display: 'flex', justifyContent: 'space-between', padding: '10px 0', borderBottom: `1px solid ${theme.border}` }}>
                                <span style={{ color: theme.textSecondary }}>Low Stock Items</span>
                                <span style={{ fontWeight: '700', color: lowStockItems > 0 ? '#ef4444' : '#10b981' }}>{lowStockItems}</span>
                            </div>
                            <div style={{ display: 'flex', justifyContent: 'space-between', padding: '10px 0', borderBottom: `1px solid ${theme.border}` }}>
                                <span style={{ color: theme.textSecondary }}>Fleet Balance</span>
                                <span style={{ fontWeight: '700', color: '#10b981' }}>{formatCurrency(fleetBalance)}</span>
                            </div>
                            <div style={{ display: 'flex', justifyContent: 'space-between', padding: '10px 0' }}>
                                <span style={{ color: theme.textSecondary }}>Fleet Revenue</span>
                                <span style={{ fontWeight: '700', color: '#8b5cf6' }}>{formatCurrency(fleetSpent)}</span>
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* Revenue Tab */}
            {activeTab === 'revenue' && (
                <div style={{ padding: '20px' }}>
                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(5, 1fr)', gap: '16px', marginBottom: '24px' }}>
                        {metricCard(formatCurrency(totalRevenue), 'Total Revenue', '#10b981')}
                        {metricCard(formatCurrency(paidRevenue), 'Paid', '#3b82f6')}
                        {metricCard(formatCurrency(unpaidRevenue), 'Unpaid', '#f59e0b')}
                        {metricCard(totalServices.toString(), 'Invoices', '#8b5cf6')}
                        {metricCard(formatCurrency(avgTicket), 'Avg Ticket', '#06b6d4')}
                    </div>
                    <div style={cardStyle}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
                            <h4 style={{ margin: 0, color: theme.text, fontWeight: '700' }}>Recent Transactions (Real-time)</h4>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '6px', padding: '6px 10px', background: '#10b981', color: 'white', fontSize: '11px', fontWeight: '600' }}>
                                <span style={{ width: '6px', height: '6px', background: '#fff', borderRadius: '50%' }}></span>
                                LIVE
                            </div>
                        </div>
                        <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                            <thead>
                                <tr style={{ background: theme.bgTertiary }}>
                                    <th style={{ padding: '12px', textAlign: 'left', fontSize: '11px', color: theme.textSecondary, fontWeight: '700', textTransform: 'uppercase' }}>Date</th>
                                    <th style={{ padding: '12px', textAlign: 'left', fontSize: '11px', color: theme.textSecondary, fontWeight: '700', textTransform: 'uppercase' }}>Invoice</th>
                                    <th style={{ padding: '12px', textAlign: 'left', fontSize: '11px', color: theme.textSecondary, fontWeight: '700', textTransform: 'uppercase' }}>Customer</th>
                                    <th style={{ padding: '12px', textAlign: 'left', fontSize: '11px', color: theme.textSecondary, fontWeight: '700', textTransform: 'uppercase' }}>Service</th>
                                    <th style={{ padding: '12px', textAlign: 'center', fontSize: '11px', color: theme.textSecondary, fontWeight: '700', textTransform: 'uppercase' }}>Status</th>
                                    <th style={{ padding: '12px', textAlign: 'right', fontSize: '11px', color: theme.textSecondary, fontWeight: '700', textTransform: 'uppercase' }}>Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                {filteredBilling.slice(0, 20).map((b, i) => (
                                    <tr key={i} style={{ borderBottom: `1px solid ${theme.border}` }}>
                                        <td style={{ padding: '12px', color: theme.textSecondary, fontSize: '13px' }}>{new Date(b.createdAt || b.date).toLocaleDateString()}</td>
                                        <td style={{ padding: '12px', color: '#3b82f6', fontWeight: '600', fontFamily: 'monospace', fontSize: '12px' }}>{b.invoiceNumber || '-'}</td>
                                        <td style={{ padding: '12px', color: theme.text }}>{b.customerName || 'Walk-in'}</td>
                                        <td style={{ padding: '12px', color: theme.text, fontWeight: '500' }}>{b.services?.[0]?.name || b.source || '-'}</td>
                                        <td style={{ padding: '12px', textAlign: 'center' }}>
                                            <span style={{ padding: '4px 10px', fontSize: '10px', fontWeight: '700', textTransform: 'uppercase', background: b.paymentStatus === 'paid' ? '#dcfce7' : '#fef3c7', color: b.paymentStatus === 'paid' ? '#166534' : '#92400e' }}>
                                                {b.paymentStatus || 'pending'}
                                            </span>
                                        </td>
                                        <td style={{ padding: '12px', textAlign: 'right', fontWeight: '700', color: '#10b981' }}>{formatCurrency(b.totalAmount || b.total || b.amount)}</td>
                                    </tr>
                                ))}
                                {filteredBilling.length === 0 && (
                                    <tr><td colSpan="6" style={{ padding: '40px', textAlign: 'center', color: theme.textSecondary }}>No transactions found for this period</td></tr>
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>
            )}

            {/* Expenses Tab */}
            {activeTab === 'expenses' && (
                <div style={{ padding: '20px' }}>
                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '16px', marginBottom: '24px' }}>
                        {metricCard(formatCurrency(totalExpenses), 'Total Expenses', '#ef4444')}
                        {metricCard(filteredExpenses.length.toString(), 'Expense Count', '#3b82f6')}
                        {metricCard(formatCurrency(filteredExpenses.length > 0 ? totalExpenses / filteredExpenses.length : 0), 'Avg Expense', '#8b5cf6')}
                        {metricCard(formatCurrency(totalRevenue - totalExpenses), 'Net Profit', netProfit >= 0 ? '#10b981' : '#ef4444')}
                    </div>
                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 2fr', gap: '20px' }}>
                        <div style={cardStyle}>
                            <h4 style={{ margin: '0 0 16px', color: theme.text, fontWeight: '700' }}>By Category</h4>
                            {topExpenseCategories.map(([cat, amt], i) => (
                                <div key={i} style={{ marginBottom: '12px' }}>
                                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '4px' }}>
                                        <span style={{ color: theme.text, fontSize: '13px' }}>{cat}</span>
                                        <span style={{ color: '#ef4444', fontWeight: '600', fontSize: '13px' }}>{formatCurrency(amt)}</span>
                                    </div>
                                    <div style={{ height: '8px', background: theme.bgTertiary }}>
                                        <div style={{ height: '100%', background: '#ef4444', width: `${(amt / totalExpenses) * 100}%` }}></div>
                                    </div>
                                </div>
                            ))}
                        </div>
                        <div style={cardStyle}>
                            <h4 style={{ margin: '0 0 16px', color: theme.text, fontWeight: '700' }}>Recent Expenses</h4>
                            <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                                <thead>
                                    <tr style={{ background: theme.bgTertiary }}>
                                        <th style={{ padding: '12px', textAlign: 'left', fontSize: '11px', color: theme.textSecondary, fontWeight: '700', textTransform: 'uppercase' }}>Date</th>
                                        <th style={{ padding: '12px', textAlign: 'left', fontSize: '11px', color: theme.textSecondary, fontWeight: '700', textTransform: 'uppercase' }}>Description</th>
                                        <th style={{ padding: '12px', textAlign: 'left', fontSize: '11px', color: theme.textSecondary, fontWeight: '700', textTransform: 'uppercase' }}>Category</th>
                                        <th style={{ padding: '12px', textAlign: 'right', fontSize: '11px', color: theme.textSecondary, fontWeight: '700', textTransform: 'uppercase' }}>Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {filteredExpenses.slice(0, 10).map((e, i) => (
                                        <tr key={i} style={{ borderBottom: `1px solid ${theme.border}` }}>
                                            <td style={{ padding: '12px', color: theme.textSecondary, fontSize: '13px' }}>{new Date(e.date).toLocaleDateString()}</td>
                                            <td style={{ padding: '12px', color: theme.text, fontWeight: '500' }}>{e.description || '-'}</td>
                                            <td style={{ padding: '12px', color: theme.textSecondary }}>{e.category || '-'}</td>
                                            <td style={{ padding: '12px', textAlign: 'right', fontWeight: '700', color: '#ef4444' }}>{formatCurrency(e.amount)}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            )}

            {/* Operations Tab */}
            {activeTab === 'operations' && (
                <div style={{ padding: '20px' }}>
                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(5, 1fr)', gap: '16px', marginBottom: '24px' }}>
                        {metricCard(totalCustomers.toString(), 'Customers', '#3b82f6')}
                        {metricCard(data.fleet.length.toString(), 'Fleet Accounts', '#8b5cf6')}
                        {metricCard(fleetVehicles.toString(), 'Fleet Vehicles', '#f59e0b')}
                        {metricCard(data.staff.length.toString(), 'Staff', '#10b981')}
                        {metricCard(data.inventory.length.toString(), 'Inventory Items', '#ef4444')}
                    </div>
                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '20px', marginBottom: '20px' }}>
                        <div style={cardStyle}>
                            <h4 style={{ margin: '0 0 16px', color: theme.text, fontWeight: '700' }}>Fleet Accounts</h4>
                            {data.fleet.slice(0, 8).map((f, i) => (
                                <div key={i} style={{ display: 'flex', justifyContent: 'space-between', padding: '10px 0', borderBottom: `1px solid ${theme.border}` }}>
                                    <div>
                                        <div style={{ color: theme.text, fontWeight: '600' }}>{f.companyName}</div>
                                        <div style={{ fontSize: '11px', color: theme.textSecondary }}>{f.vehicles?.length || 0} vehicles</div>
                                    </div>
                                    <div style={{ textAlign: 'right' }}>
                                        <div style={{ fontWeight: '700', color: f.balance >= 0 ? '#10b981' : '#ef4444' }}>{formatCurrency(f.balance)}</div>
                                        <div style={{ fontSize: '11px', color: theme.textSecondary }}>Spent: {formatCurrency(f.totalSpent)}</div>
                                    </div>
                                </div>
                            ))}
                            {data.fleet.length === 0 && <div style={{ color: theme.textSecondary, textAlign: 'center', padding: '20px' }}>No fleet accounts</div>}
                        </div>
                        <div style={cardStyle}>
                            <h4 style={{ margin: '0 0 16px', color: theme.text, fontWeight: '700' }}>Low Stock Alerts</h4>
                            {data.inventory.filter(i => (i.quantity || 0) <= (i.reorderLevel || 5)).slice(0, 8).map((item, i) => (
                                <div key={i} style={{ display: 'flex', justifyContent: 'space-between', padding: '10px 0', borderBottom: `1px solid ${theme.border}` }}>
                                    <div>
                                        <div style={{ color: theme.text, fontWeight: '600' }}>{item.name}</div>
                                        <div style={{ fontSize: '11px', color: theme.textSecondary }}>{item.category || 'Uncategorized'}</div>
                                    </div>
                                    <div style={{ textAlign: 'right' }}>
                                        <div style={{ fontWeight: '700', color: '#ef4444' }}>{item.quantity || 0} {item.unit || 'pcs'}</div>
                                        <div style={{ fontSize: '11px', color: theme.textSecondary }}>Reorder: {item.reorderLevel || 5}</div>
                                    </div>
                                </div>
                            ))}
                            {lowStockItems === 0 && <div style={{ color: theme.textSecondary, textAlign: 'center', padding: '20px' }}>All items well stocked</div>}
                        </div>
                    </div>

                    {/* Full Inventory Table */}
                    <div style={cardStyle}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
                            <h4 style={{ margin: 0, color: theme.text, fontWeight: '700' }}>Inventory Items (Real-time)</h4>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                                <div style={{ fontSize: '13px', color: theme.textSecondary }}>
                                    Total Value: <span style={{ fontWeight: '700', color: '#3b82f6' }}>{formatCurrency(inventoryValue)}</span>
                                </div>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '6px', padding: '6px 10px', background: '#10b981', color: 'white', fontSize: '11px', fontWeight: '600' }}>
                                    <span style={{ width: '6px', height: '6px', background: '#fff', borderRadius: '50%' }}></span>
                                    LIVE
                                </div>
                            </div>
                        </div>
                        <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                            <thead>
                                <tr style={{ background: theme.bgTertiary }}>
                                    <th style={{ padding: '12px', textAlign: 'left', fontSize: '11px', color: theme.textSecondary, fontWeight: '700', textTransform: 'uppercase' }}>Item Name</th>
                                    <th style={{ padding: '12px', textAlign: 'left', fontSize: '11px', color: theme.textSecondary, fontWeight: '700', textTransform: 'uppercase' }}>Category</th>
                                    <th style={{ padding: '12px', textAlign: 'center', fontSize: '11px', color: theme.textSecondary, fontWeight: '700', textTransform: 'uppercase' }}>Quantity</th>
                                    <th style={{ padding: '12px', textAlign: 'center', fontSize: '11px', color: theme.textSecondary, fontWeight: '700', textTransform: 'uppercase' }}>Unit</th>
                                    <th style={{ padding: '12px', textAlign: 'right', fontSize: '11px', color: theme.textSecondary, fontWeight: '700', textTransform: 'uppercase' }}>Unit Cost</th>
                                    <th style={{ padding: '12px', textAlign: 'right', fontSize: '11px', color: theme.textSecondary, fontWeight: '700', textTransform: 'uppercase' }}>Total Value</th>
                                    <th style={{ padding: '12px', textAlign: 'center', fontSize: '11px', color: theme.textSecondary, fontWeight: '700', textTransform: 'uppercase' }}>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {data.inventory.map((item, i) => {
                                    const isLow = (item.quantity || 0) <= (item.reorderLevel || 5);
                                    const itemValue = (item.quantity || 0) * (item.unitCost || 0);
                                    return (
                                        <tr key={i} style={{ borderBottom: `1px solid ${theme.border}` }}>
                                            <td style={{ padding: '12px', color: theme.text, fontWeight: '600' }}>{item.name}</td>
                                            <td style={{ padding: '12px', color: theme.textSecondary }}>{item.category || 'Uncategorized'}</td>
                                            <td style={{ padding: '12px', textAlign: 'center', fontWeight: '700', color: isLow ? '#ef4444' : theme.text }}>{item.quantity || 0}</td>
                                            <td style={{ padding: '12px', textAlign: 'center', color: theme.textSecondary }}>{item.unit || 'pcs'}</td>
                                            <td style={{ padding: '12px', textAlign: 'right', color: theme.text }}>{formatCurrency(item.unitCost || 0)}</td>
                                            <td style={{ padding: '12px', textAlign: 'right', fontWeight: '700', color: '#3b82f6' }}>{formatCurrency(itemValue)}</td>
                                            <td style={{ padding: '12px', textAlign: 'center' }}>
                                                <span style={{ padding: '4px 10px', fontSize: '10px', fontWeight: '700', textTransform: 'uppercase', background: isLow ? '#fef2f2' : '#dcfce7', color: isLow ? '#dc2626' : '#166534' }}>
                                                    {isLow ? 'Low Stock' : 'In Stock'}
                                                </span>
                                            </td>
                                        </tr>
                                    );
                                })}
                                {data.inventory.length === 0 && (
                                    <tr><td colSpan="7" style={{ padding: '40px', textAlign: 'center', color: theme.textSecondary }}>No inventory items found</td></tr>
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>
            )}

            {/* Generate Reports Tab */}
            {activeTab === 'generate' && (
                <div style={{ padding: '20px' }}>
                    <div style={{ display: 'grid', gridTemplateColumns: '350px 1fr', gap: '20px' }}>
                        {/* Report Options */}
                        <div style={cardStyle}>
                            <h4 style={{ margin: '0 0 20px', color: theme.text, fontWeight: '700' }}>Report Generator</h4>
                            
                            <div style={{ marginBottom: '16px' }}>
                                <label style={{ display: 'block', fontSize: '11px', color: theme.textSecondary, textTransform: 'uppercase', fontWeight: '600', marginBottom: '6px' }}>Report Type</label>
                                <select value={reportType} onChange={(e) => setReportType(e.target.value)} style={{ width: '100%', padding: '12px', border: `1px solid ${theme.border}`, background: theme.inputBg, color: theme.text, fontSize: '14px' }}>
                                    <option value="summary">Executive Summary</option>
                                    <option value="revenue">Revenue Report</option>
                                    <option value="expenses">Expenses Report</option>
                                    <option value="fleet">Fleet Account Report</option>
                                    <option value="inventory">Inventory Report</option>
                                    <option value="customers">Customer Report</option>
                                    <option value="staff">Staff Report</option>
                                    <option value="profit">Profit & Loss Statement</option>
                                </select>
                            </div>

                            <div style={{ marginBottom: '16px' }}>
                                <label style={{ display: 'block', fontSize: '11px', color: theme.textSecondary, textTransform: 'uppercase', fontWeight: '600', marginBottom: '6px' }}>Date Range</label>
                                <select value={dateRange} onChange={(e) => setDateRange(e.target.value)} style={{ width: '100%', padding: '12px', border: `1px solid ${theme.border}`, background: theme.inputBg, color: theme.text, fontSize: '14px' }}>
                                    <option value="today">Today</option>
                                    <option value="week">Last 7 Days</option>
                                    <option value="month">This Month</option>
                                    <option value="year">This Year</option>
                                    <option value="all">All Time</option>
                                </select>
                            </div>

                            <div style={{ background: theme.bgSecondary, padding: '16px', marginBottom: '20px', border: `1px solid ${theme.border}` }}>
                                <div style={{ fontSize: '12px', color: theme.textSecondary, marginBottom: '8px' }}>Report Summary</div>
                                <div style={{ fontSize: '14px', color: theme.text }}>
                                    {reportType === 'summary' && 'Complete overview with key metrics, revenue breakdown, and expenses.'}
                                    {reportType === 'revenue' && `${filteredBilling.length} transactions totaling ${formatCurrency(totalRevenue)}`}
                                    {reportType === 'expenses' && `${filteredExpenses.length} expenses totaling ${formatCurrency(totalExpenses)}`}
                                    {reportType === 'fleet' && `${data.fleet.length} fleet accounts with ${fleetVehicles} vehicles`}
                                    {reportType === 'inventory' && `${data.inventory.length} items valued at ${formatCurrency(inventoryValue)}`}
                                    {reportType === 'customers' && `${totalCustomers} registered customers`}
                                    {reportType === 'staff' && `${data.staff.length} staff members`}
                                    {reportType === 'profit' && `Net Profit: ${formatCurrency(netProfit)}`}
                                </div>
                            </div>

                            <div style={{ display: 'grid', gap: '10px' }}>
                                <button onClick={() => generateReport('preview')} style={{ padding: '14px 20px', background: '#3b82f6', color: 'white', border: 'none', fontWeight: '600', cursor: 'pointer', fontSize: '14px' }}>Preview Report</button>
                                <button onClick={() => generateReport('print')} style={{ padding: '14px 20px', background: '#1e293b', color: 'white', border: 'none', fontWeight: '600', cursor: 'pointer', fontSize: '14px' }}>Print Report</button>
                                <button onClick={() => generateReport('pdf')} style={{ padding: '14px 20px', background: 'none', border: `1px solid ${theme.border}`, color: theme.text, fontWeight: '600', cursor: 'pointer', fontSize: '14px' }}>Download PDF</button>
                            </div>
                        </div>

                        {/* Available Reports */}
                        <div>
                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '16px' }}>
                                {[
                                    { type: 'summary', title: 'Executive Summary', desc: 'Complete business overview', icon: 'üìä', color: '#3b82f6' },
                                    { type: 'revenue', title: 'Revenue Report', desc: 'All transactions and income', icon: 'üí∞', color: '#10b981' },
                                    { type: 'expenses', title: 'Expenses Report', desc: 'All expenses by category', icon: 'üìâ', color: '#ef4444' },
                                    { type: 'profit', title: 'Profit & Loss', desc: 'Income vs expenses analysis', icon: 'üìà', color: '#8b5cf6' },
                                    { type: 'fleet', title: 'Fleet Accounts', desc: 'All fleet account details', icon: 'üöõ', color: '#f59e0b' },
                                    { type: 'inventory', title: 'Inventory Report', desc: 'Stock levels and values', icon: 'üì¶', color: '#06b6d4' },
                                    { type: 'customers', title: 'Customer Report', desc: 'Customer database summary', icon: 'üë•', color: '#ec4899' },
                                    { type: 'staff', title: 'Staff Report', desc: 'Staff roster and details', icon: 'üëî', color: '#84cc16' },
                                ].map((r, i) => (
                                    <div key={i} onClick={() => setReportType(r.type)} style={{ ...cardStyle, cursor: 'pointer', border: reportType === r.type ? `2px solid ${r.color}` : `1px solid ${theme.border}`, transition: 'all 0.2s' }}>
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                                            <div style={{ fontSize: '32px' }}>{r.icon}</div>
                                            <div>
                                                <div style={{ fontWeight: '700', color: theme.text }}>{r.title}</div>
                                                <div style={{ fontSize: '12px', color: theme.textSecondary }}>{r.desc}</div>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>

                            {/* Quick Stats for Selected Report */}
                            <div style={{ ...cardStyle, marginTop: '20px' }}>
                                <h4 style={{ margin: '0 0 16px', color: theme.text, fontWeight: '700' }}>
                                    {reportType === 'summary' && 'Executive Summary Preview'}
                                    {reportType === 'revenue' && 'Revenue Preview'}
                                    {reportType === 'expenses' && 'Expenses Preview'}
                                    {reportType === 'profit' && 'Profit & Loss Preview'}
                                    {reportType === 'fleet' && 'Fleet Preview'}
                                    {reportType === 'inventory' && 'Inventory Preview'}
                                    {reportType === 'customers' && 'Customer Preview'}
                                    {reportType === 'staff' && 'Staff Preview'}
                                </h4>
                                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '12px' }}>
                                    {reportType === 'summary' && <>
                                        <div style={{ background: theme.bgSecondary, padding: '16px', textAlign: 'center' }}>
                                            <div style={{ fontSize: '20px', fontWeight: '800', color: '#10b981' }}>{formatCurrency(totalRevenue)}</div>
                                            <div style={{ fontSize: '10px', color: theme.textSecondary, textTransform: 'uppercase' }}>Revenue</div>
                                        </div>
                                        <div style={{ background: theme.bgSecondary, padding: '16px', textAlign: 'center' }}>
                                            <div style={{ fontSize: '20px', fontWeight: '800', color: '#ef4444' }}>{formatCurrency(totalExpenses)}</div>
                                            <div style={{ fontSize: '10px', color: theme.textSecondary, textTransform: 'uppercase' }}>Expenses</div>
                                        </div>
                                        <div style={{ background: theme.bgSecondary, padding: '16px', textAlign: 'center' }}>
                                            <div style={{ fontSize: '20px', fontWeight: '800', color: netProfit >= 0 ? '#10b981' : '#ef4444' }}>{formatCurrency(netProfit)}</div>
                                            <div style={{ fontSize: '10px', color: theme.textSecondary, textTransform: 'uppercase' }}>Net Profit</div>
                                        </div>
                                        <div style={{ background: theme.bgSecondary, padding: '16px', textAlign: 'center' }}>
                                            <div style={{ fontSize: '20px', fontWeight: '800', color: '#3b82f6' }}>{totalServices}</div>
                                            <div style={{ fontSize: '10px', color: theme.textSecondary, textTransform: 'uppercase' }}>Services</div>
                                        </div>
                                    </>}
                                    {reportType === 'revenue' && filteredBilling.slice(0, 4).map((b, i) => (
                                        <div key={i} style={{ background: theme.bgSecondary, padding: '12px' }}>
                                            <div style={{ fontSize: '11px', color: theme.textSecondary }}>{new Date(b.createdAt || b.date).toLocaleDateString()}</div>
                                            <div style={{ fontWeight: '600', color: theme.text, fontSize: '13px' }}>{b.service || b.packageName || 'Service'}</div>
                                            <div style={{ fontWeight: '700', color: '#10b981' }}>{formatCurrency(b.total || b.amount)}</div>
                                        </div>
                                    ))}
                                    {reportType === 'expenses' && filteredExpenses.slice(0, 4).map((e, i) => (
                                        <div key={i} style={{ background: theme.bgSecondary, padding: '12px' }}>
                                            <div style={{ fontSize: '11px', color: theme.textSecondary }}>{e.category || 'Other'}</div>
                                            <div style={{ fontWeight: '600', color: theme.text, fontSize: '13px' }}>{e.description || 'Expense'}</div>
                                            <div style={{ fontWeight: '700', color: '#ef4444' }}>{formatCurrency(e.amount)}</div>
                                        </div>
                                    ))}
                                    {reportType === 'fleet' && data.fleet.slice(0, 4).map((f, i) => (
                                        <div key={i} style={{ background: theme.bgSecondary, padding: '12px' }}>
                                            <div style={{ fontWeight: '600', color: theme.text, fontSize: '13px' }}>{f.companyName}</div>
                                            <div style={{ fontSize: '11px', color: theme.textSecondary }}>{f.vehicles?.length || 0} vehicles</div>
                                            <div style={{ fontWeight: '700', color: f.balance >= 0 ? '#10b981' : '#ef4444' }}>{formatCurrency(f.balance)}</div>
                                        </div>
                                    ))}
                                    {reportType === 'inventory' && data.inventory.slice(0, 4).map((item, i) => (
                                        <div key={i} style={{ background: theme.bgSecondary, padding: '12px' }}>
                                            <div style={{ fontWeight: '600', color: theme.text, fontSize: '13px' }}>{item.name}</div>
                                            <div style={{ fontSize: '11px', color: theme.textSecondary }}>{item.quantity || 0} {item.unit || 'pcs'}</div>
                                            <div style={{ fontWeight: '700', color: '#3b82f6' }}>{formatCurrency((item.quantity || 0) * (item.unitCost || 0))}</div>
                                        </div>
                                    ))}
                                    {reportType === 'customers' && <>
                                        <div style={{ background: theme.bgSecondary, padding: '16px', textAlign: 'center' }}>
                                            <div style={{ fontSize: '20px', fontWeight: '800', color: '#3b82f6' }}>{totalCustomers}</div>
                                            <div style={{ fontSize: '10px', color: theme.textSecondary, textTransform: 'uppercase' }}>Total</div>
                                        </div>
                                        <div style={{ background: theme.bgSecondary, padding: '16px', textAlign: 'center' }}>
                                            <div style={{ fontSize: '20px', fontWeight: '800', color: '#10b981' }}>{loyaltyPoints.toLocaleString()}</div>
                                            <div style={{ fontSize: '10px', color: theme.textSecondary, textTransform: 'uppercase' }}>Loyalty Pts</div>
                                        </div>
                                    </>}
                                    {reportType === 'staff' && <>
                                        <div style={{ background: theme.bgSecondary, padding: '16px', textAlign: 'center' }}>
                                            <div style={{ fontSize: '20px', fontWeight: '800', color: '#3b82f6' }}>{data.staff.length}</div>
                                            <div style={{ fontSize: '10px', color: theme.textSecondary, textTransform: 'uppercase' }}>Total Staff</div>
                                        </div>
                                        <div style={{ background: theme.bgSecondary, padding: '16px', textAlign: 'center' }}>
                                            <div style={{ fontSize: '20px', fontWeight: '800', color: '#10b981' }}>{data.staff.filter(s => s.status === 'active').length}</div>
                                            <div style={{ fontSize: '10px', color: theme.textSecondary, textTransform: 'uppercase' }}>Active</div>
                                        </div>
                                    </>}
                                    {reportType === 'profit' && <>
                                        <div style={{ background: theme.bgSecondary, padding: '16px', textAlign: 'center' }}>
                                            <div style={{ fontSize: '20px', fontWeight: '800', color: '#10b981' }}>{formatCurrency(totalRevenue)}</div>
                                            <div style={{ fontSize: '10px', color: theme.textSecondary, textTransform: 'uppercase' }}>Income</div>
                                        </div>
                                        <div style={{ background: theme.bgSecondary, padding: '16px', textAlign: 'center' }}>
                                            <div style={{ fontSize: '20px', fontWeight: '800', color: '#ef4444' }}>{formatCurrency(totalExpenses)}</div>
                                            <div style={{ fontSize: '10px', color: theme.textSecondary, textTransform: 'uppercase' }}>Expenses</div>
                                        </div>
                                        <div style={{ background: theme.bgSecondary, padding: '16px', textAlign: 'center' }}>
                                            <div style={{ fontSize: '20px', fontWeight: '800', color: netProfit >= 0 ? '#10b981' : '#ef4444' }}>{formatCurrency(netProfit)}</div>
                                            <div style={{ fontSize: '10px', color: theme.textSecondary, textTransform: 'uppercase' }}>Net Profit</div>
                                        </div>
                                        <div style={{ background: theme.bgSecondary, padding: '16px', textAlign: 'center' }}>
                                            <div style={{ fontSize: '20px', fontWeight: '800', color: '#8b5cf6' }}>{totalRevenue > 0 ? ((netProfit / totalRevenue) * 100).toFixed(1) : 0}%</div>
                                            <div style={{ fontSize: '10px', color: theme.textSecondary, textTransform: 'uppercase' }}>Margin</div>
                                        </div>
                                    </>}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* Report Preview Modal */}
            {showPreview && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.7)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 }} onClick={() => setShowPreview(false)}>
                    <div style={{ background: 'white', width: '900px', maxWidth: '95vw', maxHeight: '90vh', overflow: 'auto', border: '1px solid #e2e8f0' }} onClick={(e) => e.stopPropagation()}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '16px 20px', background: '#1e293b', color: 'white' }}>
                            <h3 style={{ margin: 0, fontWeight: '700' }}>Report Preview</h3>
                            <div style={{ display: 'flex', gap: '8px' }}>
                                <button onClick={() => { generateReport('print'); setShowPreview(false); }} style={{ padding: '8px 16px', background: '#10b981', border: 'none', color: 'white', fontWeight: '600', cursor: 'pointer' }}>Print</button>
                                <button onClick={() => setShowPreview(false)} style={{ padding: '8px 16px', background: 'none', border: '1px solid white', color: 'white', fontWeight: '600', cursor: 'pointer' }}>Close</button>
                            </div>
                        </div>
                        <div dangerouslySetInnerHTML={{ __html: previewContent }} style={{ padding: '20px' }}></div>
                    </div>
                </div>
            )}
        </div>
    );

    function generateReport(action) {
        const periodLabel = dateRange === 'today' ? 'Today' : dateRange === 'week' ? 'Last 7 Days' : dateRange === 'month' ? 'This Month' : dateRange === 'year' ? 'This Year' : 'All Time';
        
        let reportTitle = '';
        let reportBody = '';

        if (reportType === 'summary' || reportType === 'profit') {
            reportTitle = reportType === 'summary' ? 'Executive Summary Report' : 'Profit & Loss Statement';
            reportBody = `
                <div class="section"><div class="section-title">Key Performance Metrics</div>
                <div class="grid">
                    <div class="card"><div class="value green">KSH ${totalRevenue.toLocaleString()}</div><div class="label">Total Revenue</div></div>
                    <div class="card"><div class="value red">KSH ${totalExpenses.toLocaleString()}</div><div class="label">Total Expenses</div></div>
                    <div class="card"><div class="value ${netProfit >= 0 ? 'green' : 'red'}">KSH ${netProfit.toLocaleString()}</div><div class="label">Net Profit</div></div>
                    <div class="card"><div class="value blue">${totalServices}</div><div class="label">Services</div></div>
                </div></div>
                ${topServices.length > 0 ? `<div class="section"><div class="section-title">Revenue by Service</div>
                <table><thead><tr><th>Service</th><th style="text-align:right">Revenue</th><th style="text-align:right">%</th></tr></thead>
                <tbody>${topServices.map(([svc, amt]) => `<tr><td>${svc}</td><td style="text-align:right">KSH ${amt.toLocaleString()}</td><td style="text-align:right">${((amt/totalRevenue)*100).toFixed(1)}%</td></tr>`).join('')}</tbody></table></div>` : ''}
                ${topExpenseCategories.length > 0 ? `<div class="section"><div class="section-title">Expenses by Category</div>
                <table><thead><tr><th>Category</th><th style="text-align:right">Amount</th><th style="text-align:right">%</th></tr></thead>
                <tbody>${topExpenseCategories.map(([cat, amt]) => `<tr><td>${cat}</td><td style="text-align:right">KSH ${amt.toLocaleString()}</td><td style="text-align:right">${((amt/totalExpenses)*100).toFixed(1)}%</td></tr>`).join('')}</tbody></table></div>` : ''}`;
        } else if (reportType === 'revenue') {
            reportTitle = 'Revenue Report';
            reportBody = `
                <div class="section"><div class="section-title">Revenue Summary</div>
                <div class="grid">
                    <div class="card"><div class="value green">KSH ${totalRevenue.toLocaleString()}</div><div class="label">Total Revenue</div></div>
                    <div class="card"><div class="value blue">${filteredBilling.length}</div><div class="label">Transactions</div></div>
                    <div class="card"><div class="value purple">KSH ${avgTicket.toLocaleString()}</div><div class="label">Avg Ticket</div></div>
                </div></div>
                <div class="section"><div class="section-title">Transactions</div>
                <table><thead><tr><th>Date</th><th>Service</th><th>Customer</th><th style="text-align:right">Amount</th></tr></thead>
                <tbody>${filteredBilling.slice(0, 50).map(b => `<tr><td>${new Date(b.createdAt || b.date).toLocaleDateString()}</td><td>${b.service || b.packageName || '-'}</td><td>${b.customerName || '-'}</td><td style="text-align:right" class="green">KSH ${(b.total || b.amount || 0).toLocaleString()}</td></tr>`).join('')}</tbody></table></div>`;
        } else if (reportType === 'expenses') {
            reportTitle = 'Expenses Report';
            reportBody = `
                <div class="section"><div class="section-title">Expenses Summary</div>
                <div class="grid">
                    <div class="card"><div class="value red">KSH ${totalExpenses.toLocaleString()}</div><div class="label">Total Expenses</div></div>
                    <div class="card"><div class="value blue">${filteredExpenses.length}</div><div class="label">Count</div></div>
                </div></div>
                <div class="section"><div class="section-title">Expense List</div>
                <table><thead><tr><th>Date</th><th>Description</th><th>Category</th><th style="text-align:right">Amount</th></tr></thead>
                <tbody>${filteredExpenses.slice(0, 50).map(e => `<tr><td>${new Date(e.date).toLocaleDateString()}</td><td>${e.description || '-'}</td><td>${e.category || '-'}</td><td style="text-align:right" class="red">KSH ${(e.amount || 0).toLocaleString()}</td></tr>`).join('')}</tbody></table></div>`;
        } else if (reportType === 'fleet') {
            reportTitle = 'Fleet Account Report';
            reportBody = `
                <div class="section"><div class="section-title">Fleet Summary</div>
                <div class="grid">
                    <div class="card"><div class="value blue">${data.fleet.length}</div><div class="label">Accounts</div></div>
                    <div class="card"><div class="value purple">${fleetVehicles}</div><div class="label">Vehicles</div></div>
                    <div class="card"><div class="value green">KSH ${fleetBalance.toLocaleString()}</div><div class="label">Total Balance</div></div>
                    <div class="card"><div class="value orange">KSH ${fleetSpent.toLocaleString()}</div><div class="label">Total Spent</div></div>
                </div></div>
                <div class="section"><div class="section-title">Fleet Accounts</div>
                <table><thead><tr><th>Company</th><th>Contact</th><th style="text-align:center">Vehicles</th><th style="text-align:right">Balance</th><th style="text-align:right">Spent</th></tr></thead>
                <tbody>${data.fleet.map(f => `<tr><td>${f.companyName}</td><td>${f.contactPerson || '-'}</td><td style="text-align:center">${f.vehicles?.length || 0}</td><td style="text-align:right" class="${f.balance >= 0 ? 'green' : 'red'}">KSH ${(f.balance || 0).toLocaleString()}</td><td style="text-align:right">KSH ${(f.totalSpent || 0).toLocaleString()}</td></tr>`).join('')}</tbody></table></div>`;
        } else if (reportType === 'inventory') {
            reportTitle = 'Inventory Report';
            reportBody = `
                <div class="section"><div class="section-title">Inventory Summary</div>
                <div class="grid">
                    <div class="card"><div class="value blue">${data.inventory.length}</div><div class="label">Total Items</div></div>
                    <div class="card"><div class="value green">KSH ${inventoryValue.toLocaleString()}</div><div class="label">Total Value</div></div>
                    <div class="card"><div class="value red">${lowStockItems}</div><div class="label">Low Stock</div></div>
                </div></div>
                <div class="section"><div class="section-title">Inventory Items</div>
                <table><thead><tr><th>Item</th><th>Category</th><th style="text-align:center">Qty</th><th style="text-align:right">Unit Cost</th><th style="text-align:right">Value</th></tr></thead>
                <tbody>${data.inventory.map(i => `<tr><td>${i.name}</td><td>${i.category || '-'}</td><td style="text-align:center">${i.quantity || 0} ${i.unit || ''}</td><td style="text-align:right">KSH ${(i.unitCost || 0).toLocaleString()}</td><td style="text-align:right" class="green">KSH ${((i.quantity || 0) * (i.unitCost || 0)).toLocaleString()}</td></tr>`).join('')}</tbody></table></div>`;
        } else if (reportType === 'customers') {
            reportTitle = 'Customer Report';
            reportBody = `
                <div class="section"><div class="section-title">Customer Summary</div>
                <div class="grid">
                    <div class="card"><div class="value blue">${totalCustomers}</div><div class="label">Total Customers</div></div>
                    <div class="card"><div class="value purple">${loyaltyPoints.toLocaleString()}</div><div class="label">Loyalty Points</div></div>
                </div></div>
                <div class="section"><div class="section-title">Customer List</div>
                <table><thead><tr><th>Name</th><th>Phone</th><th>Email</th><th style="text-align:right">Loyalty Points</th></tr></thead>
                <tbody>${data.customers.slice(0, 50).map(c => `<tr><td>${c.name}</td><td>${c.phone || '-'}</td><td>${c.email || '-'}</td><td style="text-align:right">${(c.loyaltyPoints || 0).toLocaleString()}</td></tr>`).join('')}</tbody></table></div>`;
        } else if (reportType === 'staff') {
            reportTitle = 'Staff Report';
            reportBody = `
                <div class="section"><div class="section-title">Staff Summary</div>
                <div class="grid">
                    <div class="card"><div class="value blue">${data.staff.length}</div><div class="label">Total Staff</div></div>
                    <div class="card"><div class="value green">${data.staff.filter(s => s.status === 'active').length}</div><div class="label">Active</div></div>
                </div></div>
                <div class="section"><div class="section-title">Staff List</div>
                <table><thead><tr><th>Name</th><th>Role</th><th>Phone</th><th>Status</th></tr></thead>
                <tbody>${data.staff.map(s => `<tr><td>${s.name}</td><td>${s.role || '-'}</td><td>${s.phone || '-'}</td><td class="${s.status === 'active' ? 'green' : 'red'}">${s.status || 'Unknown'}</td></tr>`).join('')}</tbody></table></div>`;
        }

        const content = `
<!DOCTYPE html><html><head><title>EcoSpark - ${reportTitle}</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}body{font-family:'Segoe UI',Arial,sans-serif;padding:30px;color:#1e293b;font-size:12px}
.header{text-align:center;margin-bottom:30px;padding-bottom:20px;border-bottom:2px solid #1e293b}
.logo{font-size:28px;font-weight:800;color:#10b981}.logo span{color:#1e293b}
.subtitle{color:#64748b;margin-top:8px}
.section{margin-bottom:24px}.section-title{font-size:14px;font-weight:700;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid #e2e8f0}
.grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px}
.card{background:#f8fafc;border:1px solid #e2e8f0;padding:14px;text-align:center}
.card .value{font-size:20px;font-weight:800}.card .label{font-size:10px;color:#64748b;text-transform:uppercase;margin-top:4px}
.green{color:#10b981}.red{color:#ef4444}.blue{color:#3b82f6}.purple{color:#8b5cf6}.orange{color:#f59e0b}
table{width:100%;border-collapse:collapse}th{background:#1e293b;color:white;padding:8px 10px;text-align:left;font-size:10px;text-transform:uppercase}
td{padding:8px 10px;border-bottom:1px solid #e2e8f0;font-size:11px}tr:nth-child(even){background:#f8fafc}
.footer{margin-top:30px;text-align:center;color:#64748b;font-size:11px;padding-top:20px;border-top:1px solid #e2e8f0}
@media print{body{padding:15px}.grid{grid-template-columns:repeat(4,1fr)}}
</style></head><body>
<div class="header"><div class="logo">Eco<span>Spark</span></div><div class="subtitle">${reportTitle} - ${periodLabel}</div></div>
${reportBody}
<div class="footer">Generated on ${new Date().toLocaleString()} | EcoSpark Car Wash Management System</div>
</body></html>`;

        if (action === 'preview') {
            setPreviewContent(reportBody);
            setShowPreview(true);
        } else if (action === 'print' || action === 'pdf') {
            const w = window.open('', '_blank');
            w.document.write(content);
            w.document.close();
            w.onload = () => w.print();
        }
    }
}

// ==================== MARKETING CRM MODULE ====================
function MarketingCRM() {
    const [customers, setCustomers] = useState([]);
    const [campaigns, setCampaigns] = useState([]);
    const [messages, setMessages] = useState([]);
    const [loading, setLoading] = useState(true);
    const [activeTab, setActiveTab] = useState('customers'); // 'customers', 'campaigns', 'messages', 'templates'
    const [searchQuery, setSearchQuery] = useState('');
    const [selectedCustomers, setSelectedCustomers] = useState([]);
    const [showComposeModal, setShowComposeModal] = useState(false);
    const [showCampaignModal, setShowCampaignModal] = useState(false);
    const [showTemplateModal, setShowTemplateModal] = useState(false);
    const [actionLoading, setActionLoading] = useState(false);
    const [error, setError] = useState(null);
    const [successMessage, setSuccessMessage] = useState(null);
    const [customerFilter, setCustomerFilter] = useState('all'); // 'all', 'active', 'inactive', 'loyal', 'new'
    const [isDark, setIsDark] = useState(document.documentElement.getAttribute('data-theme') === 'dark');

    // Message templates
    const [templates, setTemplates] = useState([
        { id: 1, name: 'Welcome Message', content: 'Welcome to EcoSpark Car Wash! Thank you for choosing us. Enjoy 10% off your next visit with code: WELCOME10', category: 'welcome' },
        { id: 2, name: 'Service Reminder', content: 'Hi {name}, your vehicle is due for a wash! Book now and get priority service. Visit us today at EcoSpark.', category: 'reminder' },
        { id: 3, name: 'Loyalty Reward', content: 'Congratulations {name}! You\'ve earned {points} loyalty points. Redeem them on your next visit for discounts!', category: 'loyalty' },
        { id: 4, name: 'Special Offer', content: 'üéâ Special Offer! Get 20% off all premium washes this weekend only. Don\'t miss out! - EcoSpark', category: 'promo' },
        { id: 5, name: 'Birthday Wish', content: 'Happy Birthday {name}! üéÇ Enjoy a FREE basic wash on us. Valid this week only. - EcoSpark Team', category: 'birthday' }
    ]);

    const [composeForm, setComposeForm] = useState({
        subject: '',
        message: '',
        sendVia: 'sms', // 'sms', 'email', 'both'
        scheduleTime: '',
        isScheduled: false
    });

    const [campaignForm, setCampaignForm] = useState({
        name: '',
        description: '',
        targetAudience: 'all',
        messageTemplate: '',
        startDate: '',
        endDate: '',
        status: 'draft'
    });

    const [templateForm, setTemplateForm] = useState({
        name: '',
        content: '',
        category: 'general'
    });

    // Listen for theme changes
    useEffect(() => {
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.attributeName === 'data-theme') {
                    setIsDark(document.documentElement.getAttribute('data-theme') === 'dark');
                }
            });
        });
        observer.observe(document.documentElement, { attributes: true });
        return () => observer.disconnect();
    }, []);

    // Theme colors
    const theme = {
        bg: isDark ? '#1e293b' : 'white',
        bgSecondary: isDark ? '#0f172a' : '#f8fafc',
        bgTertiary: isDark ? '#334155' : '#f1f5f9',
        text: isDark ? '#f1f5f9' : '#1e293b',
        textSecondary: isDark ? '#94a3b8' : '#64748b',
        border: isDark ? '#334155' : '#e2e8f0',
        inputBg: isDark ? '#1e293b' : 'white',
        cardBg: isDark ? '#1e293b' : 'white',
        hoverBg: isDark ? '#334155' : '#f1f5f9'
    };

    // Fetch customers from customer service
    useEffect(() => {
        const services = window.FirebaseServices;
        if (!services?.customerService) {
            setLoading(false);
            return;
        }
        const unsubscribe = services.customerService.subscribeToCustomers(
            (data) => {
                setCustomers(data);
                setLoading(false);
            },
            (err) => {
                setError('Failed to load customers');
                setLoading(false);
            }
        );
        return () => unsubscribe && unsubscribe();
    }, []);

    // Clear success message
    useEffect(() => {
        if (successMessage) {
            const timer = setTimeout(() => setSuccessMessage(null), 3000);
            return () => clearTimeout(timer);
        }
    }, [successMessage]);

    // Filter customers
    const filteredCustomers = customers.filter(customer => {
        const matchesSearch = customer.name?.toLowerCase().includes(searchQuery.toLowerCase()) ||
            customer.phone?.includes(searchQuery) ||
            customer.email?.toLowerCase().includes(searchQuery.toLowerCase());
        
        if (customerFilter === 'all') return matchesSearch;
        if (customerFilter === 'loyal') return matchesSearch && (customer.loyaltyPoints || 0) >= 100;
        if (customerFilter === 'new') {
            const createdAt = new Date(customer.createdAt);
            const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
            return matchesSearch && createdAt > thirtyDaysAgo;
        }
        return matchesSearch;
    });

    // Toggle customer selection
    const toggleCustomerSelection = (customerId) => {
        setSelectedCustomers(prev => 
            prev.includes(customerId) 
                ? prev.filter(id => id !== customerId)
                : [...prev, customerId]
        );
    };

    // Select all filtered customers
    const selectAllCustomers = () => {
        if (selectedCustomers.length === filteredCustomers.length) {
            setSelectedCustomers([]);
        } else {
            setSelectedCustomers(filteredCustomers.map(c => c.id));
        }
    };

    // Send message to selected customers
    const handleSendMessage = async () => {
        if (selectedCustomers.length === 0) {
            setError('Please select at least one customer');
            return;
        }
        if (!composeForm.message.trim()) {
            setError('Please enter a message');
            return;
        }

        setActionLoading(true);
        setError(null);

        try {
            const selectedCustomerData = customers.filter(c => selectedCustomers.includes(c.id));
            
            // Create message record
            const newMessage = {
                id: Date.now(),
                subject: composeForm.subject || 'No Subject',
                content: composeForm.message,
                recipients: selectedCustomerData.map(c => ({ id: c.id, name: c.name, phone: c.phone, email: c.email })),
                recipientCount: selectedCustomers.length,
                sendVia: composeForm.sendVia,
                status: composeForm.isScheduled ? 'scheduled' : 'sent',
                scheduledTime: composeForm.isScheduled ? composeForm.scheduleTime : null,
                sentAt: composeForm.isScheduled ? null : new Date().toISOString(),
                createdAt: new Date().toISOString()
            };

            setMessages(prev => [newMessage, ...prev]);
            setSuccessMessage(`Message ${composeForm.isScheduled ? 'scheduled' : 'sent'} to ${selectedCustomers.length} customer(s)`);
            setShowComposeModal(false);
            setSelectedCustomers([]);
            setComposeForm({ subject: '', message: '', sendVia: 'sms', scheduleTime: '', isScheduled: false });

            // Log activity
            if (window.FirebaseServices?.activityService) {
                await window.FirebaseServices.activityService.logActivity({
                    type: 'marketing',
                    action: 'message_sent',
                    details: `Sent ${composeForm.sendVia} to ${selectedCustomers.length} customers`,
                    metadata: { recipientCount: selectedCustomers.length, sendVia: composeForm.sendVia }
                });
            }
        } catch (err) {
            setError(err.message);
        } finally {
            setActionLoading(false);
        }
    };

    // Create campaign
    const handleCreateCampaign = async () => {
        if (!campaignForm.name.trim()) {
            setError('Please enter campaign name');
            return;
        }

        setActionLoading(true);
        setError(null);

        try {
            const newCampaign = {
                id: Date.now(),
                ...campaignForm,
                createdAt: new Date().toISOString(),
                stats: { sent: 0, opened: 0, clicked: 0 }
            };

            setCampaigns(prev => [newCampaign, ...prev]);
            setSuccessMessage('Campaign created successfully');
            setShowCampaignModal(false);
            setCampaignForm({ name: '', description: '', targetAudience: 'all', messageTemplate: '', startDate: '', endDate: '', status: 'draft' });
        } catch (err) {
            setError(err.message);
        } finally {
            setActionLoading(false);
        }
    };

    // Save template
    const handleSaveTemplate = () => {
        if (!templateForm.name.trim() || !templateForm.content.trim()) {
            setError('Please fill in template name and content');
            return;
        }

        const newTemplate = {
            id: Date.now(),
            ...templateForm
        };

        setTemplates(prev => [...prev, newTemplate]);
        setSuccessMessage('Template saved successfully');
        setShowTemplateModal(false);
        setTemplateForm({ name: '', content: '', category: 'general' });
    };

    // Use template
    const useTemplate = (template) => {
        setComposeForm(prev => ({ ...prev, message: template.content }));
        setShowComposeModal(true);
    };

    // Stats
    const stats = {
        totalCustomers: customers.length,
        selectedCount: selectedCustomers.length,
        messagesSent: messages.filter(m => m.status === 'sent').length,
        activeCampaigns: campaigns.filter(c => c.status === 'active').length,
        loyalCustomers: customers.filter(c => (c.loyaltyPoints || 0) >= 100).length
    };

    const inputStyle = {
        width: '100%',
        padding: '12px 16px',
        border: `1px solid ${theme.border}`,
        borderRadius: '4px',
        fontSize: '14px',
        background: theme.inputBg,
        color: theme.text,
        outline: 'none'
    };

    const labelStyle = {
        display: 'block',
        marginBottom: '8px',
        fontSize: '13px',
        fontWeight: '600',
        color: theme.textSecondary,
        textTransform: 'uppercase',
        letterSpacing: '0.5px'
    };

    const tabStyle = (isActive) => ({
        padding: '14px 28px',
        background: isActive ? '#3b82f6' : 'transparent',
        color: isActive ? 'white' : theme.textSecondary,
        border: isActive ? 'none' : `1px solid ${theme.border}`,
        cursor: 'pointer',
        fontSize: '14px',
        fontWeight: '600',
        borderRadius: '4px',
        transition: 'all 0.2s'
    });

    if (loading) {
        return (
            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', height: '400px' }}>
                <div style={{ textAlign: 'center' }}>
                    <div style={{ fontSize: '40px', marginBottom: '16px' }}>üì£</div>
                    <div style={{ color: theme.textSecondary }}>Loading Marketing CRM...</div>
                </div>
            </div>
        );
    }

    return (
        <div style={{ padding: '32px', maxWidth: '1600px', margin: '0 auto' }}>
            {/* Header with Stats */}
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '24px', marginBottom: '32px' }}>
                <div style={{ background: theme.cardBg, padding: '24px', borderRadius: '4px', border: `1px solid ${theme.border}` }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
                        <div style={{ width: '56px', height: '56px', borderRadius: '4px', background: '#dbeafe', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '28px' }}>üë•</div>
                        <div>
                            <div style={{ fontSize: '32px', fontWeight: '700', color: theme.text, lineHeight: '1' }}>{stats.totalCustomers}</div>
                            <div style={{ fontSize: '13px', color: theme.textSecondary, marginTop: '4px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Total Customers</div>
                        </div>
                    </div>
                </div>
                <div style={{ background: theme.cardBg, padding: '24px', borderRadius: '4px', border: `1px solid ${theme.border}` }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
                        <div style={{ width: '56px', height: '56px', borderRadius: '4px', background: '#d1fae5', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '28px' }}>‚≠ê</div>
                        <div>
                            <div style={{ fontSize: '32px', fontWeight: '700', color: theme.text, lineHeight: '1' }}>{stats.loyalCustomers}</div>
                            <div style={{ fontSize: '13px', color: theme.textSecondary, marginTop: '4px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Loyal Customers</div>
                        </div>
                    </div>
                </div>
                <div style={{ background: theme.cardBg, padding: '24px', borderRadius: '4px', border: `1px solid ${theme.border}` }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
                        <div style={{ width: '56px', height: '56px', borderRadius: '4px', background: '#fef3c7', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '28px' }}>‚úâÔ∏è</div>
                        <div>
                            <div style={{ fontSize: '32px', fontWeight: '700', color: theme.text, lineHeight: '1' }}>{stats.messagesSent}</div>
                            <div style={{ fontSize: '13px', color: theme.textSecondary, marginTop: '4px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Messages Sent</div>
                        </div>
                    </div>
                </div>
                <div style={{ background: theme.cardBg, padding: '24px', borderRadius: '4px', border: `1px solid ${theme.border}` }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
                        <div style={{ width: '56px', height: '56px', borderRadius: '4px', background: '#f3e8ff', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '28px' }}>üì¢</div>
                        <div>
                            <div style={{ fontSize: '32px', fontWeight: '700', color: theme.text, lineHeight: '1' }}>{stats.activeCampaigns}</div>
                            <div style={{ fontSize: '13px', color: theme.textSecondary, marginTop: '4px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Active Campaigns</div>
                        </div>
                    </div>
                </div>
            </div>

            {/* Success/Error Messages */}
            {successMessage && (
                <div style={{ padding: '16px 20px', background: '#d1fae5', color: '#065f46', borderRadius: '4px', marginBottom: '24px', display: 'flex', alignItems: 'center', gap: '12px', fontWeight: '500' }}>
                    ‚úÖ {successMessage}
                </div>
            )}
            {error && (
                <div style={{ padding: '16px 20px', background: '#fee2e2', color: '#991b1b', borderRadius: '4px', marginBottom: '24px', display: 'flex', alignItems: 'center', justifyContent: 'space-between', fontWeight: '500' }}>
                    <span>‚ùå {error}</span>
                    <button onClick={() => setError(null)} style={{ background: 'none', border: 'none', cursor: 'pointer', fontSize: '20px', color: '#991b1b' }}>√ó</button>
                </div>
            )}

            {/* Tabs */}
            <div style={{ display: 'flex', gap: '12px', marginBottom: '32px', borderBottom: `2px solid ${theme.border}`, paddingBottom: '16px' }}>
                <button onClick={() => setActiveTab('customers')} style={tabStyle(activeTab === 'customers')}>üë• Customers</button>
                <button onClick={() => setActiveTab('campaigns')} style={tabStyle(activeTab === 'campaigns')}>üì¢ Campaigns</button>
                <button onClick={() => setActiveTab('messages')} style={tabStyle(activeTab === 'messages')}>‚úâÔ∏è Message History</button>
                <button onClick={() => setActiveTab('templates')} style={tabStyle(activeTab === 'templates')}>üìù Templates</button>
            </div>

            {/* Customers Tab */}
            {activeTab === 'customers' && (
                <div style={{ background: theme.cardBg, borderRadius: '4px', border: `1px solid ${theme.border}`, overflow: 'hidden' }}>
                    <div style={{ padding: '20px 24px', borderBottom: `1px solid ${theme.border}`, display: 'flex', gap: '16px', flexWrap: 'wrap', alignItems: 'center', justifyContent: 'space-between', background: theme.bgSecondary }}>
                        <div style={{ display: 'flex', gap: '16px', flexWrap: 'wrap', alignItems: 'center' }}>
                            <input
                                type="text"
                                placeholder="Search customers..."
                                value={searchQuery}
                                onChange={(e) => setSearchQuery(e.target.value)}
                                style={{ ...inputStyle, width: '300px' }}
                            />
                            <select value={customerFilter} onChange={(e) => setCustomerFilter(e.target.value)} style={{ ...inputStyle, width: '180px' }}>
                                <option value="all">All Customers</option>
                                <option value="loyal">Loyal (100+ pts)</option>
                                <option value="new">New (30 days)</option>
                            </select>
                        </div>
                        <div style={{ display: 'flex', gap: '16px' }}>
                            {selectedCustomers.length > 0 && (
                                <button
                                    onClick={() => setShowComposeModal(true)}
                                    style={{ padding: '12px 24px', background: '#3b82f6', color: 'white', border: 'none', borderRadius: '4px', fontWeight: '600', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '10px' }}
                                >
                                    ‚úâÔ∏è Send Message ({selectedCustomers.length})
                                </button>
                            )}
                            <button
                                onClick={selectAllCustomers}
                                style={{ padding: '12px 24px', background: theme.bgTertiary, color: theme.text, border: `1px solid ${theme.border}`, borderRadius: '4px', fontWeight: '600', cursor: 'pointer' }}
                            >
                                {selectedCustomers.length === filteredCustomers.length ? 'Deselect All' : 'Select All'}
                            </button>
                        </div>
                    </div>
                    <div style={{ maxHeight: '600px', overflowY: 'auto' }}>
                        <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                            <thead>
                                <tr style={{ background: theme.bgTertiary }}>
                                    <th style={{ padding: '16px 20px', textAlign: 'left', fontWeight: '700', color: theme.text, borderBottom: `2px solid ${theme.border}`, width: '50px', textTransform: 'uppercase', fontSize: '12px', letterSpacing: '0.5px' }}>
                                        <input
                                            type="checkbox"
                                            checked={selectedCustomers.length === filteredCustomers.length && filteredCustomers.length > 0}
                                            onChange={selectAllCustomers}
                                            style={{ width: '18px', height: '18px', cursor: 'pointer' }}
                                        />
                                    </th>
                                    <th style={{ padding: '16px 20px', textAlign: 'left', fontWeight: '700', color: theme.text, borderBottom: `2px solid ${theme.border}`, textTransform: 'uppercase', fontSize: '12px', letterSpacing: '0.5px' }}>Customer</th>
                                    <th style={{ padding: '16px 20px', textAlign: 'left', fontWeight: '700', color: theme.text, borderBottom: `2px solid ${theme.border}`, textTransform: 'uppercase', fontSize: '12px', letterSpacing: '0.5px' }}>Contact</th>
                                    <th style={{ padding: '16px 20px', textAlign: 'center', fontWeight: '700', color: theme.text, borderBottom: `2px solid ${theme.border}`, textTransform: 'uppercase', fontSize: '12px', letterSpacing: '0.5px' }}>Loyalty</th>
                                    <th style={{ padding: '16px 20px', textAlign: 'center', fontWeight: '700', color: theme.text, borderBottom: `2px solid ${theme.border}`, textTransform: 'uppercase', fontSize: '12px', letterSpacing: '0.5px' }}>Visits</th>
                                    <th style={{ padding: '16px 20px', textAlign: 'center', fontWeight: '700', color: theme.text, borderBottom: `2px solid ${theme.border}`, textTransform: 'uppercase', fontSize: '12px', letterSpacing: '0.5px' }}>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {filteredCustomers.length === 0 ? (
                                    <tr><td colSpan="6" style={{ padding: '60px', textAlign: 'center', color: theme.textSecondary, fontSize: '15px' }}>No customers found</td></tr>
                                ) : (
                                    filteredCustomers.map(customer => (
                                        <tr key={customer.id} style={{ borderBottom: `1px solid ${theme.border}`, background: selectedCustomers.includes(customer.id) ? (isDark ? '#1e3a5f' : '#eff6ff') : 'transparent', transition: 'background 0.15s' }}>
                                            <td style={{ padding: '16px 20px' }}>
                                                <input
                                                    type="checkbox"
                                                    checked={selectedCustomers.includes(customer.id)}
                                                    onChange={() => toggleCustomerSelection(customer.id)}
                                                    style={{ width: '18px', height: '18px', cursor: 'pointer' }}
                                                />
                                            </td>
                                            <td style={{ padding: '16px 20px' }}>
                                                <div style={{ fontWeight: '600', color: theme.text, fontSize: '15px' }}>{customer.name}</div>
                                                <div style={{ fontSize: '12px', color: theme.textSecondary, marginTop: '4px' }}>Since {new Date(customer.createdAt).toLocaleDateString()}</div>
                                            </td>
                                            <td style={{ padding: '16px 20px' }}>
                                                <div style={{ color: theme.text, fontSize: '14px' }}>{customer.phone || '-'}</div>
                                                <div style={{ fontSize: '12px', color: theme.textSecondary, marginTop: '4px' }}>{customer.email || '-'}</div>
                                            </td>
                                            <td style={{ padding: '16px 20px', textAlign: 'center' }}>
                                                <span style={{ padding: '6px 14px', background: (customer.loyaltyPoints || 0) >= 100 ? '#d1fae5' : '#f3f4f6', color: (customer.loyaltyPoints || 0) >= 100 ? '#059669' : '#6b7280', borderRadius: '4px', fontWeight: '700', fontSize: '13px', display: 'inline-block' }}>
                                                    ‚≠ê {customer.loyaltyPoints || 0}
                                                </span>
                                            </td>
                                            <td style={{ padding: '16px 20px', textAlign: 'center', color: theme.text, fontWeight: '700', fontSize: '15px' }}>
                                                {customer.visitCount || 0}
                                            </td>
                                            <td style={{ padding: '16px 20px', textAlign: 'center' }}>
                                                <button
                                                    onClick={() => { setSelectedCustomers([customer.id]); setShowComposeModal(true); }}
                                                    style={{ padding: '8px 16px', background: '#3b82f6', color: 'white', border: 'none', borderRadius: '4px', cursor: 'pointer', fontSize: '13px', fontWeight: '600' }}
                                                >
                                                    ‚úâÔ∏è Message
                                                </button>
                                            </td>
                                        </tr>
                                    ))
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>
            )}

            {/* Campaigns Tab */}
            {activeTab === 'campaigns' && (
                <div style={{ background: theme.cardBg, borderRadius: '4px', border: `1px solid ${theme.border}`, overflow: 'hidden' }}>
                    <div style={{ padding: '20px 24px', borderBottom: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'space-between', alignItems: 'center', background: theme.bgSecondary }}>
                        <h3 style={{ margin: 0, color: theme.text, fontSize: '18px', fontWeight: '700' }}>Marketing Campaigns</h3>
                        <button
                            onClick={() => setShowCampaignModal(true)}
                            style={{ padding: '12px 24px', background: '#3b82f6', color: 'white', border: 'none', borderRadius: '4px', fontWeight: '600', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '10px' }}
                        >
                            ‚ûï New Campaign
                        </button>
                    </div>
                    <div style={{ padding: '24px' }}>
                        {campaigns.length === 0 ? (
                            <div style={{ textAlign: 'center', padding: '80px 20px', color: theme.textSecondary }}>
                                <div style={{ fontSize: '56px', marginBottom: '20px' }}>üì¢</div>
                                <div style={{ fontSize: '18px', marginBottom: '8px', fontWeight: '600', color: theme.text }}>No campaigns yet</div>
                                <div style={{ fontSize: '14px' }}>Create your first marketing campaign to engage customers</div>
                            </div>
                        ) : (
                            <div style={{ display: 'grid', gap: '20px' }}>
                                {campaigns.map(campaign => (
                                    <div key={campaign.id} style={{ padding: '24px', border: `1px solid ${theme.border}`, borderRadius: '4px', background: theme.bg }}>
                                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '16px' }}>
                                            <div>
                                                <h4 style={{ margin: '0 0 6px', color: theme.text, fontSize: '18px', fontWeight: '700' }}>{campaign.name}</h4>
                                                <p style={{ margin: 0, color: theme.textSecondary, fontSize: '14px' }}>{campaign.description || 'No description'}</p>
                                            </div>
                                            <span style={{ padding: '6px 14px', borderRadius: '4px', fontSize: '12px', fontWeight: '700', textTransform: 'uppercase', letterSpacing: '0.5px', background: campaign.status === 'active' ? '#d1fae5' : campaign.status === 'draft' ? '#fef3c7' : '#f3f4f6', color: campaign.status === 'active' ? '#059669' : campaign.status === 'draft' ? '#d97706' : '#6b7280' }}>
                                                {campaign.status}
                                            </span>
                                        </div>
                                        <div style={{ display: 'flex', gap: '32px', fontSize: '13px', color: theme.textSecondary }}>
                                            <span>üìÖ {campaign.startDate || 'Not scheduled'}</span>
                                            <span>üéØ {campaign.targetAudience === 'all' ? 'All Customers' : campaign.targetAudience}</span>
                                            <span>üìä Sent: {campaign.stats?.sent || 0}</span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            )}

            {/* Messages Tab */}
            {activeTab === 'messages' && (
                <div style={{ background: theme.cardBg, borderRadius: '4px', border: `1px solid ${theme.border}`, overflow: 'hidden' }}>
                    <div style={{ padding: '20px 24px', borderBottom: `1px solid ${theme.border}`, background: theme.bgSecondary }}>
                        <h3 style={{ margin: 0, color: theme.text, fontSize: '18px', fontWeight: '700' }}>Message History</h3>
                    </div>
                    <div style={{ padding: '24px' }}>
                        {messages.length === 0 ? (
                            <div style={{ textAlign: 'center', padding: '80px 20px', color: theme.textSecondary }}>
                                <div style={{ fontSize: '56px', marginBottom: '20px' }}>‚úâÔ∏è</div>
                                <div style={{ fontSize: '18px', marginBottom: '8px', fontWeight: '600', color: theme.text }}>No messages sent yet</div>
                                <div style={{ fontSize: '14px' }}>Select customers and send them a message</div>
                            </div>
                        ) : (
                            <div style={{ display: 'grid', gap: '16px' }}>
                                {messages.map(message => (
                                    <div key={message.id} style={{ padding: '20px', border: `1px solid ${theme.border}`, borderRadius: '4px', background: theme.bg }}>
                                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '12px' }}>
                                            <div style={{ fontWeight: '700', color: theme.text, fontSize: '16px' }}>{message.subject}</div>
                                            <span style={{ padding: '6px 12px', borderRadius: '4px', fontSize: '11px', fontWeight: '700', textTransform: 'uppercase', letterSpacing: '0.5px', background: message.status === 'sent' ? '#d1fae5' : '#fef3c7', color: message.status === 'sent' ? '#059669' : '#d97706' }}>
                                                {message.status === 'sent' ? '‚úì Sent' : '‚è± Scheduled'}
                                            </span>
                                        </div>
                                        <p style={{ margin: '0 0 16px', color: theme.textSecondary, fontSize: '14px', lineHeight: '1.6' }}>{message.content}</p>
                                        <div style={{ display: 'flex', gap: '24px', fontSize: '13px', color: theme.textSecondary, paddingTop: '12px', borderTop: `1px solid ${theme.border}` }}>
                                            <span>üë• {message.recipientCount} recipients</span>
                                            <span>üì± {message.sendVia.toUpperCase()}</span>
                                            <span>üìÖ {new Date(message.sentAt || message.scheduledTime).toLocaleString()}</span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            )}

            {/* Templates Tab */}
            {activeTab === 'templates' && (
                <div style={{ background: theme.cardBg, borderRadius: '4px', border: `1px solid ${theme.border}`, overflow: 'hidden' }}>
                    <div style={{ padding: '20px 24px', borderBottom: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'space-between', alignItems: 'center', background: theme.bgSecondary }}>
                        <h3 style={{ margin: 0, color: theme.text, fontSize: '18px', fontWeight: '700' }}>Message Templates</h3>
                        <button
                            onClick={() => setShowTemplateModal(true)}
                            style={{ padding: '12px 24px', background: '#3b82f6', color: 'white', border: 'none', borderRadius: '4px', fontWeight: '600', cursor: 'pointer' }}
                        >
                            ‚ûï New Template
                        </button>
                    </div>
                    <div style={{ padding: '24px', display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(350px, 1fr))', gap: '20px' }}>
                        {templates.map(template => (
                            <div key={template.id} style={{ padding: '20px', border: `1px solid ${theme.border}`, borderRadius: '4px', background: theme.bg }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '12px' }}>
                                    <div style={{ fontWeight: '700', color: theme.text, fontSize: '16px' }}>{template.name}</div>
                                    <span style={{ padding: '4px 10px', borderRadius: '4px', fontSize: '11px', fontWeight: '600', textTransform: 'uppercase', letterSpacing: '0.5px', background: theme.bgTertiary, color: theme.textSecondary }}>
                                        {template.category}
                                    </span>
                                </div>
                                <p style={{ margin: '0 0 16px', color: theme.textSecondary, fontSize: '14px', lineHeight: '1.6' }}>{template.content}</p>
                                <button
                                    onClick={() => useTemplate(template)}
                                    style={{ padding: '10px 18px', background: '#10b981', color: 'white', border: 'none', borderRadius: '4px', cursor: 'pointer', fontSize: '13px', fontWeight: '600' }}
                                >
                                    Use Template
                                </button>
                            </div>
                        ))}
                    </div>
                </div>
            )}

            {/* Compose Message Modal */}
            {showComposeModal && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.6)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 }} onClick={() => setShowComposeModal(false)}>
                    <div style={{ background: theme.bg, width: '100%', maxWidth: '600px', maxHeight: '90vh', overflow: 'auto', margin: '20px', borderRadius: '4px', boxShadow: '0 25px 50px -12px rgba(0,0,0,0.4)' }} onClick={e => e.stopPropagation()}>
                        <div style={{ padding: '24px', borderBottom: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'space-between', alignItems: 'center', background: theme.bgSecondary }}>
                            <h2 style={{ margin: 0, color: theme.text, fontSize: '20px', fontWeight: '700' }}>‚úâÔ∏è Compose Message</h2>
                            <button onClick={() => setShowComposeModal(false)} style={{ background: 'none', border: 'none', fontSize: '28px', cursor: 'pointer', color: theme.textSecondary, lineHeight: '1' }}>√ó</button>
                        </div>
                        <div style={{ padding: '24px' }}>
                            <div style={{ marginBottom: '20px', padding: '16px', background: theme.bgTertiary, borderRadius: '4px' }}>
                                <div style={{ fontSize: '12px', color: theme.textSecondary, marginBottom: '4px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Sending to:</div>
                                <div style={{ fontWeight: '700', color: theme.text, fontSize: '16px' }}>{selectedCustomers.length} customer(s) selected</div>
                            </div>
                            <div style={{ marginBottom: '20px' }}>
                                <label style={labelStyle}>Subject (optional)</label>
                                <input
                                    type="text"
                                    value={composeForm.subject}
                                    onChange={(e) => setComposeForm({ ...composeForm, subject: e.target.value })}
                                    placeholder="Enter subject..."
                                    style={inputStyle}
                                />
                            </div>
                            <div style={{ marginBottom: '20px' }}>
                                <label style={labelStyle}>Message *</label>
                                <textarea
                                    value={composeForm.message}
                                    onChange={(e) => setComposeForm({ ...composeForm, message: e.target.value })}
                                    placeholder="Type your message here... Use {name} for customer name"
                                    style={{ ...inputStyle, minHeight: '140px', resize: 'vertical' }}
                                />
                            </div>
                            <div style={{ marginBottom: '20px' }}>
                                <label style={labelStyle}>Send Via</label>
                                <div style={{ display: 'flex', gap: '16px' }}>
                                    {['sms', 'email', 'both'].map(type => (
                                        <button
                                            key={type}
                                            onClick={() => setComposeForm({ ...composeForm, sendVia: type })}
                                            style={{ flex: 1, padding: '14px', border: `2px solid ${composeForm.sendVia === type ? '#3b82f6' : theme.border}`, background: composeForm.sendVia === type ? '#eff6ff' : 'transparent', color: composeForm.sendVia === type ? '#3b82f6' : theme.text, borderRadius: '4px', cursor: 'pointer', fontWeight: '700', fontSize: '14px' }}
                                        >
                                            {type === 'sms' ? 'üì± SMS' : type === 'email' ? 'üìß Email' : 'üì® Both'}
                                        </button>
                                    ))}
                                </div>
                            </div>
                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'flex', alignItems: 'center', gap: '10px', cursor: 'pointer' }}>
                                    <input
                                        type="checkbox"
                                        checked={composeForm.isScheduled}
                                        onChange={(e) => setComposeForm({ ...composeForm, isScheduled: e.target.checked })}
                                        style={{ width: '18px', height: '18px' }}
                                    />
                                    <span style={{ fontSize: '14px', color: theme.text }}>Schedule for later</span>
                                </label>
                                {composeForm.isScheduled && (
                                    <input
                                        type="datetime-local"
                                        value={composeForm.scheduleTime}
                                        onChange={(e) => setComposeForm({ ...composeForm, scheduleTime: e.target.value })}
                                        style={{ ...inputStyle, marginTop: '12px' }}
                                    />
                                )}
                            </div>
                            <div style={{ display: 'flex', gap: '16px', marginTop: '28px' }}>
                                <button onClick={() => setShowComposeModal(false)} style={{ flex: 1, padding: '16px', border: `1px solid ${theme.border}`, background: 'transparent', color: theme.text, borderRadius: '4px', cursor: 'pointer', fontWeight: '600', fontSize: '14px' }}>Cancel</button>
                                <button onClick={handleSendMessage} disabled={actionLoading} style={{ flex: 1, padding: '16px', border: 'none', background: '#3b82f6', color: 'white', borderRadius: '4px', cursor: actionLoading ? 'wait' : 'pointer', fontWeight: '700', fontSize: '14px' }}>
                                    {actionLoading ? 'Sending...' : composeForm.isScheduled ? '‚è± Schedule' : '‚úàÔ∏è Send Now'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* Campaign Modal */}
            {showCampaignModal && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.6)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 }} onClick={() => setShowCampaignModal(false)}>
                    <div style={{ background: theme.bg, width: '100%', maxWidth: '600px', maxHeight: '90vh', overflow: 'auto', margin: '20px', borderRadius: '4px', boxShadow: '0 25px 50px -12px rgba(0,0,0,0.4)' }} onClick={e => e.stopPropagation()}>
                        <div style={{ padding: '24px', borderBottom: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'space-between', alignItems: 'center', background: theme.bgSecondary }}>
                            <h2 style={{ margin: 0, color: theme.text, fontSize: '20px', fontWeight: '700' }}>üì¢ Create Campaign</h2>
                            <button onClick={() => setShowCampaignModal(false)} style={{ background: 'none', border: 'none', fontSize: '28px', cursor: 'pointer', color: theme.textSecondary, lineHeight: '1' }}>√ó</button>
                        </div>
                        <div style={{ padding: '24px' }}>
                            <div style={{ marginBottom: '20px' }}>
                                <label style={labelStyle}>Campaign Name *</label>
                                <input type="text" value={campaignForm.name} onChange={(e) => setCampaignForm({ ...campaignForm, name: e.target.value })} placeholder="e.g., Summer Promotion" style={inputStyle} />
                            </div>
                            <div style={{ marginBottom: '20px' }}>
                                <label style={labelStyle}>Description</label>
                                <textarea value={campaignForm.description} onChange={(e) => setCampaignForm({ ...campaignForm, description: e.target.value })} placeholder="Describe your campaign..." style={{ ...inputStyle, minHeight: '100px', resize: 'vertical' }} />
                            </div>
                            <div style={{ marginBottom: '20px' }}>
                                <label style={labelStyle}>Target Audience</label>
                                <select value={campaignForm.targetAudience} onChange={(e) => setCampaignForm({ ...campaignForm, targetAudience: e.target.value })} style={inputStyle}>
                                    <option value="all">All Customers</option>
                                    <option value="loyal">Loyal Customers (100+ points)</option>
                                    <option value="new">New Customers (30 days)</option>
                                    <option value="inactive">Inactive Customers</option>
                                </select>
                            </div>
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px', marginBottom: '20px' }}>
                                <div>
                                    <label style={labelStyle}>Start Date</label>
                                    <input type="date" value={campaignForm.startDate} onChange={(e) => setCampaignForm({ ...campaignForm, startDate: e.target.value })} style={inputStyle} />
                                </div>
                                <div>
                                    <label style={labelStyle}>End Date</label>
                                    <input type="date" value={campaignForm.endDate} onChange={(e) => setCampaignForm({ ...campaignForm, endDate: e.target.value })} style={inputStyle} />
                                </div>
                            </div>
                            <div style={{ display: 'flex', gap: '16px', marginTop: '28px' }}>
                                <button onClick={() => setShowCampaignModal(false)} style={{ flex: 1, padding: '16px', border: `1px solid ${theme.border}`, background: 'transparent', color: theme.text, borderRadius: '4px', cursor: 'pointer', fontWeight: '600', fontSize: '14px' }}>Cancel</button>
                                <button onClick={handleCreateCampaign} disabled={actionLoading} style={{ flex: 1, padding: '16px', border: 'none', background: '#3b82f6', color: 'white', borderRadius: '4px', cursor: actionLoading ? 'wait' : 'pointer', fontWeight: '700', fontSize: '14px' }}>
                                    {actionLoading ? 'Creating...' : '‚úì Create Campaign'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* Template Modal */}
            {showTemplateModal && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.6)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 }} onClick={() => setShowTemplateModal(false)}>
                    <div style={{ background: theme.bg, width: '100%', maxWidth: '550px', maxHeight: '90vh', overflow: 'auto', margin: '20px', borderRadius: '4px', boxShadow: '0 25px 50px -12px rgba(0,0,0,0.4)' }} onClick={e => e.stopPropagation()}>
                        <div style={{ padding: '24px', borderBottom: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'space-between', alignItems: 'center', background: theme.bgSecondary }}>
                            <h2 style={{ margin: 0, color: theme.text, fontSize: '20px', fontWeight: '700' }}>üìù New Template</h2>
                            <button onClick={() => setShowTemplateModal(false)} style={{ background: 'none', border: 'none', fontSize: '28px', cursor: 'pointer', color: theme.textSecondary, lineHeight: '1' }}>√ó</button>
                        </div>
                        <div style={{ padding: '24px' }}>
                            <div style={{ marginBottom: '20px' }}>
                                <label style={labelStyle}>Template Name *</label>
                                <input type="text" value={templateForm.name} onChange={(e) => setTemplateForm({ ...templateForm, name: e.target.value })} placeholder="e.g., Weekly Reminder" style={inputStyle} />
                            </div>
                            <div style={{ marginBottom: '20px' }}>
                                <label style={labelStyle}>Category</label>
                                <select value={templateForm.category} onChange={(e) => setTemplateForm({ ...templateForm, category: e.target.value })} style={inputStyle}>
                                    <option value="general">General</option>
                                    <option value="welcome">Welcome</option>
                                    <option value="reminder">Reminder</option>
                                    <option value="promo">Promotion</option>
                                    <option value="loyalty">Loyalty</option>
                                    <option value="birthday">Birthday</option>
                                </select>
                            </div>
                            <div style={{ marginBottom: '20px' }}>
                                <label style={labelStyle}>Message Content *</label>
                                <textarea value={templateForm.content} onChange={(e) => setTemplateForm({ ...templateForm, content: e.target.value })} placeholder="Enter template message... Use {name} for customer name, {points} for loyalty points" style={{ ...inputStyle, minHeight: '120px', resize: 'vertical' }} />
                            </div>
                            <div style={{ display: 'flex', gap: '16px', marginTop: '28px' }}>
                                <button onClick={() => setShowTemplateModal(false)} style={{ flex: 1, padding: '16px', border: `1px solid ${theme.border}`, background: 'transparent', color: theme.text, borderRadius: '4px', cursor: 'pointer', fontWeight: '600', fontSize: '14px' }}>Cancel</button>
                                <button onClick={handleSaveTemplate} style={{ flex: 1, padding: '16px', border: 'none', background: '#3b82f6', color: 'white', borderRadius: '4px', cursor: 'pointer', fontWeight: '700', fontSize: '14px' }}>‚úì Save Template</button>
                            </div>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}

// ==================== ACTIVITIES MODULE ====================
function ActivitiesModule() {
    const [activities, setActivities] = useState([]);
    const [loading, setLoading] = useState(true);
    const [searchQuery, setSearchQuery] = useState('');
    const [dateFilter, setDateFilter] = useState('all');
    const [typeFilter, setTypeFilter] = useState('all');
    const [isDark, setIsDark] = useState(document.documentElement.getAttribute('data-theme') === 'dark');

    // Theme detection
    useEffect(() => {
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.attributeName === 'data-theme') {
                    setIsDark(document.documentElement.getAttribute('data-theme') === 'dark');
                }
            });
        });
        observer.observe(document.documentElement, { attributes: true });
        return () => observer.disconnect();
    }, []);

    const theme = {
        bg: isDark ? '#1e293b' : 'white',
        bgSecondary: isDark ? '#0f172a' : '#f8fafc',
        text: isDark ? '#f1f5f9' : '#1e293b',
        textSecondary: isDark ? '#94a3b8' : '#64748b',
        border: isDark ? '#334155' : '#e2e8f0',
        cardShadow: isDark ? '0 2px 8px rgba(0,0,0,0.3)' : '0 2px 8px rgba(0,0,0,0.08)',
        inputBg: isDark ? '#1e293b' : 'white',
    };

    // Subscribe to activities
    useEffect(() => {
        const services = window.FirebaseServices;
        if (!services?.activityService?.subscribeToActivities) {
            setLoading(false);
            return;
        }

        const unsub = services.activityService.subscribeToActivities(
            (data) => {
                setActivities(data);
                setLoading(false);
            },
            500 // Get lots of activities for filtering
        );

        return () => {
            if (unsub) unsub();
        };
    }, []);

    // Date filter logic
    const getFilteredActivities = () => {
        let filtered = activities;
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);
        const weekStart = new Date(today);
        weekStart.setDate(weekStart.getDate() - 7);
        const monthStart = new Date(today);
        monthStart.setDate(monthStart.getDate() - 30);

        // Date filter
        if (dateFilter !== 'all') {
            filtered = filtered.filter(a => {
                const aDate = new Date(a.timestamp);
                aDate.setHours(0, 0, 0, 0);
                switch (dateFilter) {
                    case 'today':
                        return aDate.getTime() === today.getTime();
                    case 'yesterday':
                        return aDate.getTime() === yesterday.getTime();
                    case 'week':
                        return aDate >= weekStart;
                    case 'month':
                        return aDate >= monthStart;
                    default:
                        return true;
                }
            });
        }

        // Type filter
        if (typeFilter !== 'all') {
            filtered = filtered.filter(a => a.type === typeFilter);
        }

        // Search filter
        if (searchQuery.trim()) {
            const query = searchQuery.toLowerCase();
            filtered = filtered.filter(a =>
                a.action?.toLowerCase().includes(query) ||
                a.description?.toLowerCase().includes(query) ||
                a.details?.toLowerCase().includes(query) ||
                a.user?.toLowerCase().includes(query) ||
                a.type?.toLowerCase().includes(query) ||
                a.loggedBy?.toLowerCase().includes(query) ||
                a.loggedByRole?.toLowerCase().includes(query)
            );
        }

        return filtered;
    };

    const filteredActivities = getFilteredActivities();

    const dateFilters = [
        { id: 'all', label: 'All Time' },
        { id: 'today', label: 'Today' },
        { id: 'yesterday', label: 'Yesterday' },
        { id: 'week', label: 'This Week' },
        { id: 'month', label: 'This Month' }
    ];

    const typeFilters = [
        { id: 'all', label: 'All Types' },
        { id: 'intake', label: 'Intake' },
        { id: 'wash', label: 'Wash' },
        { id: 'billing', label: 'Billing' },
        { id: 'garage', label: 'Garage' },
        { id: 'inventory', label: 'Inventory' },
        { id: 'staff', label: 'Staff' },
        { id: 'system', label: 'System' }
    ];

    const getTypeIcon = (type) => {
        switch(type) {
            case 'intake': return 'üöó';
            case 'billing': return 'üí≥';
            case 'wash': return 'üöø';
            case 'garage': return 'üîß';
            case 'inventory': return 'üì¶';
            case 'staff': return 'üë§';
            case 'system': return '‚öôÔ∏è';
            default: return 'üìã';
        }
    };

    const getTypeColor = (type) => {
        switch(type) {
            case 'intake': return '#3b82f6';
            case 'billing': return '#10b981';
            case 'wash': return '#6366f1';
            case 'garage': return '#f59e0b';
            case 'inventory': return '#8b5cf6';
            case 'staff': return '#ec4899';
            case 'system': return '#64748b';
            default: return '#94a3b8';
        }
    };

    if (loading) {
        return (
            <div style={{ padding: '40px', textAlign: 'center', color: theme.textSecondary }}>
                Loading activities...
            </div>
        );
    }

    return (
        <div style={{ padding: '24px', maxWidth: '1400px', margin: '0 auto' }}>
            {/* Header */}
            <div style={{ marginBottom: '24px' }}>
                <h2 style={{ margin: 0, color: theme.text, fontSize: '24px', fontWeight: '600' }}>
                    Activity Log
                </h2>
                <p style={{ margin: '8px 0 0', color: theme.textSecondary, fontSize: '14px' }}>
                    View all system activities and events
                </p>
            </div>

            {/* Stats Row */}
            <div style={{ 
                display: 'grid', 
                gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))', 
                gap: '16px', 
                marginBottom: '24px' 
            }}>
                {[
                    { label: 'Total', value: activities.length, color: '#64748b' },
                    { label: 'Today', value: activities.filter(a => {
                        const aDate = new Date(a.timestamp);
                        const today = new Date();
                        return aDate.toDateString() === today.toDateString();
                    }).length, color: '#3b82f6' },
                    { label: 'This Week', value: activities.filter(a => {
                        const aDate = new Date(a.timestamp);
                        const weekAgo = new Date();
                        weekAgo.setDate(weekAgo.getDate() - 7);
                        return aDate >= weekAgo;
                    }).length, color: '#10b981' },
                    { label: 'Filtered', value: filteredActivities.length, color: '#8b5cf6' }
                ].map((stat, idx) => (
                    <div key={idx} style={{
                        padding: '20px 24px',
                        background: theme.bg,
                        borderRadius: '0',
                        border: `1px solid ${theme.border}`,
                        boxShadow: theme.cardShadow
                    }}>
                        <div style={{ fontSize: '12px', color: theme.textSecondary, marginBottom: '6px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>{stat.label}</div>
                        <div style={{ fontSize: '28px', fontWeight: '700', color: stat.color }}>{stat.value}</div>
                    </div>
                ))}
            </div>

            {/* Filters Row */}
            <div style={{ 
                display: 'flex', 
                gap: '16px', 
                marginBottom: '20px', 
                flexWrap: 'wrap',
                alignItems: 'center'
            }}>
                {/* Search */}
                <div style={{ flex: '1', minWidth: '200px', maxWidth: '350px' }}>
                    <input
                        type="text"
                        placeholder="Search activities..."
                        value={searchQuery}
                        onChange={e => setSearchQuery(e.target.value)}
                        style={{
                            width: '100%',
                            padding: '12px 16px',
                            borderRadius: '0',
                            border: `1px solid ${theme.border}`,
                            background: theme.inputBg,
                            color: theme.text,
                            fontSize: '14px'
                        }}
                    />
                </div>

                {/* Date Filter */}
                <div style={{ display: 'flex', gap: '2px', background: theme.bgSecondary, borderRadius: '0', padding: '4px' }}>
                    {dateFilters.map(f => (
                        <button
                            key={f.id}
                            onClick={() => setDateFilter(f.id)}
                            style={{
                                padding: '10px 16px',
                                border: 'none',
                                borderRadius: '0',
                                background: dateFilter === f.id ? theme.bg : 'transparent',
                                color: dateFilter === f.id ? theme.text : theme.textSecondary,
                                fontSize: '13px',
                                fontWeight: dateFilter === f.id ? '600' : '400',
                                cursor: 'pointer',
                                boxShadow: dateFilter === f.id ? '0 1px 3px rgba(0,0,0,0.1)' : 'none'
                            }}
                        >
                            {f.label}
                        </button>
                    ))}
                </div>

                {/* Type Filter */}
                <select
                    value={typeFilter}
                    onChange={e => setTypeFilter(e.target.value)}
                    style={{
                        padding: '12px 16px',
                        borderRadius: '0',
                        border: `1px solid ${theme.border}`,
                        background: theme.inputBg,
                        color: theme.text,
                        fontSize: '14px',
                        cursor: 'pointer',
                        minWidth: '140px'
                    }}
                >
                    {typeFilters.map(f => (
                        <option key={f.id} value={f.id}>{f.label}</option>
                    ))}
                </select>
            </div>

            {/* Activities List */}
            <div style={{
                background: theme.bg,
                borderRadius: '0',
                border: `1px solid ${theme.border}`,
                boxShadow: theme.cardShadow,
                overflow: 'hidden'
            }}>
                {filteredActivities.length === 0 ? (
                    <div style={{ padding: '60px 20px', textAlign: 'center', color: theme.textSecondary }}>
                        <div style={{ fontSize: '48px', marginBottom: '16px' }}>üìã</div>
                        <div style={{ fontSize: '16px', fontWeight: '500' }}>No activities found</div>
                        <div style={{ fontSize: '14px', marginTop: '8px' }}>
                            {searchQuery || dateFilter !== 'all' || typeFilter !== 'all' 
                                ? 'Try adjusting your filters' 
                                : 'Activities will appear here as they occur'}
                        </div>
                    </div>
                ) : (
                    <div style={{ maxHeight: '600px', overflowY: 'auto' }}>
                        {filteredActivities.map((activity, idx) => (
                            <div 
                                key={activity.id || idx}
                                style={{
                                    display: 'flex',
                                    alignItems: 'flex-start',
                                    gap: '16px',
                                    padding: '16px 20px',
                                    borderBottom: idx < filteredActivities.length - 1 ? `1px solid ${theme.border}` : 'none',
                                    transition: 'background 0.15s'
                                }}
                            >
                                {/* Icon */}
                                <div style={{
                                    width: '44px',
                                    height: '44px',
                                    borderRadius: '0',
                                    background: `${getTypeColor(activity.type)}15`,
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    fontSize: '18px',
                                    flexShrink: 0
                                }}>
                                    {getTypeIcon(activity.type)}
                                </div>

                                {/* Content */}
                                <div style={{ flex: 1, minWidth: 0 }}>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '4px' }}>
                                        <span style={{ 
                                            fontWeight: '600', 
                                            color: theme.text, 
                                            fontSize: '14px' 
                                        }}>
                                            {activity.action || activity.description || 'Activity'}
                                        </span>
                                        <span style={{
                                            padding: '2px 8px',
                                            borderRadius: '4px',
                                            fontSize: '11px',
                                            fontWeight: '600',
                                            textTransform: 'uppercase',
                                            background: `${getTypeColor(activity.type)}20`,
                                            color: getTypeColor(activity.type)
                                        }}>
                                            {activity.type || 'general'}
                                        </span>
                                    </div>
                                    <div style={{ fontSize: '13px', color: theme.textSecondary }}>
                                        {activity.details || activity.user || '-'}
                                    </div>
                                </div>

                                {/* Logged By Column */}
                                <div style={{ 
                                    minWidth: '140px', 
                                    flexShrink: 0,
                                    padding: '0 12px',
                                    borderLeft: `1px solid ${theme.border}`,
                                    borderRight: `1px solid ${theme.border}`
                                }}>
                                    <div style={{ fontSize: '11px', color: theme.textSecondary, marginBottom: '4px', textTransform: 'uppercase' }}>
                                        Logged By
                                    </div>
                                    <div style={{ 
                                        fontSize: '13px', 
                                        fontWeight: '500', 
                                        color: theme.text,
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '6px'
                                    }}>
                                        <span style={{
                                            width: '24px',
                                            height: '24px',
                                            borderRadius: '0',
                                            background: '#3b82f6',
                                            color: 'white',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            fontSize: '11px',
                                            fontWeight: '600'
                                        }}>
                                            {(activity.loggedBy || 'S').charAt(0).toUpperCase()}
                                        </span>
                                        <div>
                                            <div style={{ fontSize: '13px' }}>{activity.loggedBy || 'System'}</div>
                                            {activity.loggedByRole && (
                                                <div style={{ 
                                                    fontSize: '10px', 
                                                    color: theme.textSecondary,
                                                    textTransform: 'capitalize'
                                                }}>
                                                    {activity.loggedByRole}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>

                                {/* Time & Status */}
                                <div style={{ textAlign: 'right', flexShrink: 0, minWidth: '90px' }}>
                                    <div style={{ fontSize: '12px', color: theme.textSecondary }}>
                                        {new Date(activity.timestamp).toLocaleDateString('en-US', {
                                            month: 'short',
                                            day: 'numeric'
                                        })}
                                    </div>
                                    <div style={{ fontSize: '12px', color: theme.textSecondary }}>
                                        {new Date(activity.timestamp).toLocaleTimeString('en-US', {
                                            hour: '2-digit',
                                            minute: '2-digit'
                                        })}
                                    </div>
                                    {activity.status && (
                                        <div style={{
                                            marginTop: '4px',
                                            padding: '2px 8px',
                                            borderRadius: '4px',
                                            fontSize: '10px',
                                            fontWeight: '600',
                                            textTransform: 'uppercase',
                                            background: activity.status === 'success' ? '#d1fae5' :
                                                       activity.status === 'pending' ? '#fef3c7' :
                                                       activity.status === 'error' ? '#fee2e2' :
                                                       theme.bgSecondary,
                                            color: activity.status === 'success' ? '#059669' :
                                                   activity.status === 'pending' ? '#d97706' :
                                                   activity.status === 'error' ? '#dc2626' :
                                                   theme.textSecondary
                                        }}>
                                            {activity.status}
                                        </div>
                                    )}
                                </div>
                            </div>
                        ))}
                    </div>
                )}
            </div>
        </div>
    );
}

// Content Area Component
function ContentArea({ activeModule, onModuleClick, settingsTab }) {
    const currentModule = menuItems.find(item => item.id === activeModule);
    
    return (
        <div className="content-area">
            <div className="module-header">
                <div className="module-header-icon">{currentModule?.icon}</div>
                <h1 className="module-header-title">{currentModule?.label}</h1>
            </div>
            <div className="content-placeholder">
                {activeModule === 'dashboard' && <Dashboard onModuleClick={onModuleClick} />}
                {activeModule === 'vehicle-intake' && <VehicleIntake />}
                {activeModule === 'service-packages' && <ServicePackages />}
                {activeModule === 'equipment' && <EquipmentManagement />}
                {activeModule === 'customers' && <CustomerManagement />}
                {activeModule === 'fleet' && <FleetAccounts />}
                {activeModule === 'garage-management' && <GarageManagement />}
                {activeModule === 'wash-bays' && <WashBays />}
                {activeModule === 'staff' && <StaffManagement />}
                {activeModule === 'hr' && <HRModule />}
                {activeModule === 'billing' && <BillingModule />}
                {activeModule === 'inventory' && <InventoryModule />}
                {activeModule === 'expenses' && <ExpensesModule />}
                {activeModule === 'reports' && <ReportsAnalytics />}
                {activeModule === 'marketing' && <MarketingCRM />}
                {activeModule === 'activities' && <ActivitiesModule />}
                {activeModule === 'settings' && <SystemSettings initialTab={settingsTab} />}
            </div>
        </div>
    );
}

// Main App Component with Authentication
function App() {
    const [isSidebarCollapsed, setIsSidebarCollapsed] = useState(false);
    const [isDarkMode, setIsDarkMode] = useState(false);
    const [activeModule, setActiveModule] = useState('dashboard');
    const [settingsTab, setSettingsTab] = useState('profile');
    
    // Authentication state
    const [isAuthenticated, setIsAuthenticated] = useState(false);
    const [currentUser, setCurrentUser] = useState(null);
    const [userProfile, setUserProfile] = useState(null);
    const [authLoading, setAuthLoading] = useState(true);
    
    // Permission denied modal state
    const [showPermissionModal, setShowPermissionModal] = useState(false);
    const [deniedModule, setDeniedModule] = useState('');

    // Check authentication state on mount
    useEffect(() => {
        let unsubscribe = null;
        
        const checkAuth = async () => {
            // Wait for Firebase services (up to ~5s)
            let services = window.FirebaseServices;
            let attempts = 0;
            while (!services && attempts < 100) {
                await new Promise(resolve => setTimeout(resolve, 50));
                services = window.FirebaseServices;
                attempts++;
            }
            
            if (!services || !services.authService) {
                console.error('Auth service not available after', attempts, 'attempts');
                setAuthLoading(false);
                return;
            }

            // Listen to auth state changes
            unsubscribe = services.authService.onAuthStateChanged(async (user) => {
                if (user) {
                    // User is signed in
                    const profileResult = await services.userService.getUserProfile(user.uid);
                    if (profileResult.success && profileResult.data) {
                        if (profileResult.data.isActive) {
                            setCurrentUser(user);
                            setUserProfile(profileResult.data);
                            setIsAuthenticated(true);
                            // Store globally for activity logging
                            window.currentUserProfile = profileResult.data;
                            
                            // Redirect to first accessible module
                            const profile = profileResult.data;
                            const allModuleIds = menuItems.map(m => m.id);
                            let firstModule = 'dashboard';
                            for (const moduleId of allModuleIds) {
                                if (profile.permissions && profile.permissions[moduleId]?.view) {
                                    firstModule = moduleId;
                                    break;
                                }
                                if (services.userService.hasModuleAccess(profile.role, moduleId, profile.permissions)) {
                                    firstModule = moduleId;
                                    break;
                                }
                            }
                            setActiveModule(firstModule);
                            
                            // Subscribe to user profile changes for real-time permission updates
                            if (services.userService.subscribeToUserProfile) {
                                services.userService.subscribeToUserProfile(user.uid, (updatedProfile) => {
                                    if (updatedProfile) {
                                        setUserProfile(updatedProfile);
                                        window.currentUserProfile = updatedProfile;
                                        // If user is deactivated, sign them out
                                        if (!updatedProfile.isActive) {
                                            services.authService.signOut();
                                        }
                                    }
                                });
                            }
                        } else {
                            // User is deactivated
                            await services.authService.signOut();
                            setIsAuthenticated(false);
                        }
                    } else {
                        // No profile, sign out
                        setIsAuthenticated(false);
                    }
                } else {
                    // User is signed out
                    setCurrentUser(null);
                    setUserProfile(null);
                    setIsAuthenticated(false);
                }
                setAuthLoading(false);
            });
        };

        checkAuth();

        return () => {
            if (unsubscribe) unsubscribe();
        };
    }, []);

    const handleLoginSuccess = (user, profile) => {
        setCurrentUser(user);
        setUserProfile(profile);
        setIsAuthenticated(true);
        // Store globally for activity logging
        window.currentUserProfile = profile;
        
        // Redirect to first accessible module
        const getFirstAccessibleModule = () => {
            const allModuleIds = menuItems.map(m => m.id);
            for (const moduleId of allModuleIds) {
                // Check if user has access via permissions or role
                if (profile.permissions && profile.permissions[moduleId]?.view) {
                    return moduleId;
                }
                // Fall back to role-based check
                if (window.FirebaseServices?.userService?.hasModuleAccess(profile.role, moduleId, profile.permissions)) {
                    return moduleId;
                }
            }
            return 'dashboard'; // fallback
        };
        setActiveModule(getFirstAccessibleModule());
    };

    const handleLogout = async () => {
        const services = window.FirebaseServices;
        if (services && services.authService) {
            // Log logout before signing out
            await services.auditService?.logLogout(currentUser);
            await services.authService.signOut();
        }
        setCurrentUser(null);
        setUserProfile(null);
        setIsAuthenticated(false);
        setActiveModule('dashboard');
        // Clear global user
        window.currentUserProfile = null;
    };

    const toggleSidebar = () => {
        setIsSidebarCollapsed(!isSidebarCollapsed);
    };

    const toggleTheme = () => {
        setIsDarkMode(!isDarkMode);
        document.documentElement.setAttribute('data-theme', !isDarkMode ? 'dark' : 'light');
    };

    const handleModuleClick = (moduleId, tab = null) => {
        // Check if user has access to this module
        if (userProfile && window.FirebaseServices?.userService) {
            const hasAccess = window.FirebaseServices.userService.hasModuleAccess(userProfile.role, moduleId, userProfile.permissions);
            if (!hasAccess) {
                const moduleName = menuItems.find(m => m.id === moduleId)?.label || moduleId;
                setDeniedModule(moduleName);
                setShowPermissionModal(true);
                return;
            }
        }
        setActiveModule(moduleId);
        // Handle settings tab
        if (moduleId === 'settings' && tab) {
            setSettingsTab(tab);
        }
    };

    // Permission helper functions
    const hasModuleAccess = (moduleId) => {
        if (!userProfile) return false;
        if (!window.FirebaseServices?.userService) return true;
        return window.FirebaseServices.userService.hasModuleAccess(userProfile.role, moduleId, userProfile.permissions);
    };

    const hasPermission = (moduleId, action = 'view') => {
        if (!userProfile) return false;
        if (!window.FirebaseServices?.userService) return true;
        return window.FirebaseServices.userService.hasPermission(userProfile.role, moduleId, action, userProfile.permissions);
    };

    // Show login page if loading or not authenticated
    if (authLoading || !isAuthenticated) {
        return <LoginPage onLoginSuccess={handleLoginSuccess} />;
    }

    // Permission context value
    const permissionValue = {
        hasModuleAccess,
        hasPermission,
        userRole: userProfile?.role || 'receptionist',
        userProfile,
        currentUser
    };

    return (
        <PermissionContext.Provider value={permissionValue}>
            <AuthContext.Provider value={{ currentUser, userProfile, logout: handleLogout }}>
                <div className="app-container">
                    <Sidebar 
                        isCollapsed={isSidebarCollapsed} 
                        activeModule={activeModule}
                        onModuleClick={handleModuleClick}
                        userProfile={userProfile}
                        hasModuleAccess={hasModuleAccess}
                    />
                    <div className="main-content">
                        <TopBar 
                            onToggleSidebar={toggleSidebar} 
                            onToggleTheme={toggleTheme}
                            isDarkMode={isDarkMode}
                            userProfile={userProfile}
                            onLogout={handleLogout}
                            onModuleClick={handleModuleClick}
                        />
                        <ContentArea activeModule={activeModule} onModuleClick={handleModuleClick} settingsTab={settingsTab} />
                    </div>
                    
                    {/* Permission Denied Modal */}
                    {showPermissionModal && (
                        <div 
                            style={{
                                position: 'fixed',
                                top: 0,
                                left: 0,
                                right: 0,
                                bottom: 0,
                                background: 'rgba(0, 0, 0, 0.5)',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                zIndex: 9999,
                                backdropFilter: 'blur(4px)'
                            }}
                            onClick={() => setShowPermissionModal(false)}
                        >
                            <div 
                                style={{
                                    background: isDarkMode ? '#1e293b' : 'white',
                                    borderRadius: '16px',
                                    padding: '32px',
                                    maxWidth: '400px',
                                    width: '90%',
                                    textAlign: 'center',
                                    boxShadow: '0 20px 60px rgba(0, 0, 0, 0.3)',
                                    animation: 'slideIn 0.2s ease-out'
                                }}
                                onClick={e => e.stopPropagation()}
                            >
                                <div style={{
                                    width: '64px',
                                    height: '64px',
                                    borderRadius: '50%',
                                    background: '#fef2f2',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    margin: '0 auto 20px',
                                    fontSize: '32px'
                                }}>
                                    üîí
                                </div>
                                <h3 style={{
                                    margin: '0 0 12px',
                                    fontSize: '20px',
                                    fontWeight: '700',
                                    color: isDarkMode ? '#f1f5f9' : '#1e293b'
                                }}>
                                    Access Denied
                                </h3>
                                <p style={{
                                    margin: '0 0 8px',
                                    fontSize: '15px',
                                    color: isDarkMode ? '#94a3b8' : '#64748b',
                                    lineHeight: '1.6'
                                }}>
                                    You don't have permission to access
                                </p>
                                <p style={{
                                    margin: '0 0 20px',
                                    fontSize: '16px',
                                    fontWeight: '600',
                                    color: isDarkMode ? '#f1f5f9' : '#1e293b'
                                }}>
                                    "{deniedModule}"
                                </p>
                                <p style={{
                                    margin: '0 0 24px',
                                    fontSize: '13px',
                                    color: isDarkMode ? '#64748b' : '#94a3b8'
                                }}>
                                    Please contact your administrator to request access.
                                </p>
                                <button
                                    onClick={() => setShowPermissionModal(false)}
                                    style={{
                                        padding: '12px 32px',
                                        background: '#3b82f6',
                                        color: 'white',
                                        border: 'none',
                                        borderRadius: '8px',
                                        fontSize: '14px',
                                        fontWeight: '600',
                                        cursor: 'pointer',
                                        transition: 'all 0.2s'
                                    }}
                                    onMouseOver={e => e.target.style.background = '#2563eb'}
                                    onMouseOut={e => e.target.style.background = '#3b82f6'}
                                >
                                    OK, Got it
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            </AuthContext.Provider>
        </PermissionContext.Provider>
    );
}

// Render the app
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);
