const { useState, useEffect, useCallback, createContext, useContext } = React;

// ==================== AUTH CONTEXT ====================
const AuthContext = createContext(null);

const useAuth = () => {
    const context = useContext(AuthContext);
    if (!context) {
        throw new Error('useAuth must be used within an AuthProvider');
    }
    return context;
};

// ==================== BRANDING CONTEXT ====================
const BrandingContext = createContext(null);

// Try to get initial branding from localStorage for fast first paint
const getInitialBranding = () => {
    const defaults = {
        companyName: '',
        tagline: '',
        shortName: 'ES',
        address: '',
        city: '',
        phone: '',
        email: '',
        website: '',
        taxPin: '',
        businessReg: '',
        primaryColor: '#3b82f6',
        secondaryColor: '#10b981',
        accentColor: '#f59e0b',
        receiptHeader: 'OFFICIAL RECEIPT',
        receiptFooter: 'Thank you for choosing us!',
        invoiceFooter: 'Payment due within 30 days',
        termsAndConditions: '',
        logoUrl: '',
        logoType: 'icon',
        facebook: '',
        instagram: '',
        twitter: '',
        currency: 'KES',
        currencySymbol: 'KSh',
        timezone: 'Africa/Nairobi',
        dateFormat: 'DD/MM/YYYY'
    };
    
    try {
        const cached = localStorage.getItem('ecospark_branding');
        if (cached) {
            const parsed = JSON.parse(cached);
            // Merge cached values with defaults, cached takes priority
            const result = { ...defaults, ...parsed };
            // Ensure companyName and tagline have fallbacks only if truly empty
            if (!result.companyName) result.companyName = 'Car Wash';
            if (!result.tagline) result.tagline = 'Management System';
            return result;
        }
    } catch (e) {
        // Ignore localStorage errors
    }
    
    // Only use hardcoded defaults if no cache exists at all
    return {
        ...defaults,
        companyName: 'Car Wash',
        tagline: 'Management System'
    };
};

const DEFAULT_BRANDING = getInitialBranding();

const useBranding = () => {
    const context = useContext(BrandingContext);
    if (!context) {
        // Return defaults if used outside provider
        return { branding: DEFAULT_BRANDING, loading: false, refreshBranding: () => {} };
    }
    return context;
};

// Branding Provider Component
function BrandingProvider({ children }) {
    const [branding, setBranding] = useState(DEFAULT_BRANDING);
    const [loading, setLoading] = useState(true);

    // Helper to save branding to localStorage for loading screen - cache ALL important fields
    const cacheBrandingToLocalStorage = (brandingData) => {
        try {
            localStorage.setItem('ecospark_branding', JSON.stringify({
                companyName: brandingData.companyName,
                tagline: brandingData.tagline,
                logoUrl: brandingData.logoUrl,
                logoType: brandingData.logoType,
                primaryColor: brandingData.primaryColor,
                secondaryColor: brandingData.secondaryColor,
                accentColor: brandingData.accentColor,
                address: brandingData.address,
                city: brandingData.city,
                phone: brandingData.phone,
                email: brandingData.email,
                website: brandingData.website,
                taxPin: brandingData.taxPin,
                businessReg: brandingData.businessReg,
                receiptHeader: brandingData.receiptHeader,
                receiptFooter: brandingData.receiptFooter,
                invoiceFooter: brandingData.invoiceFooter,
                currency: brandingData.currency,
                currencySymbol: brandingData.currencySymbol,
                timezone: brandingData.timezone,
                dateFormat: brandingData.dateFormat,
                facebook: brandingData.facebook,
                instagram: brandingData.instagram,
                twitter: brandingData.twitter,
                shortName: brandingData.shortName
            }));
        } catch (e) {
            console.log('Could not cache branding to localStorage');
        }
    };

    const loadBranding = useCallback(async () => {
        try {
            const services = window.FirebaseServices;
            if (services?.brandingService) {
                const result = await services.brandingService.getBranding();
                if (result.success && result.data) {
                    // Firebase data takes full priority - only use DEFAULT_BRANDING for missing fields
                    const newBranding = { ...DEFAULT_BRANDING };
                    // Overwrite with Firebase data, ensuring empty strings from Firebase override defaults
                    Object.keys(result.data).forEach(key => {
                        if (result.data[key] !== undefined) {
                            newBranding[key] = result.data[key];
                        }
                    });
                    setBranding(newBranding);
                    // Update global cache for receipts
                    if (window.updateCachedBranding) window.updateCachedBranding(newBranding);
                    // Cache to localStorage for loading screen
                    cacheBrandingToLocalStorage(newBranding);
                    // Update document title - use newBranding which has proper fallbacks
                    document.title = `${newBranding.companyName} - ${newBranding.tagline}`;
                    // Update CSS variables for branding colors
                    if (newBranding.primaryColor) {
                        document.documentElement.style.setProperty('--brand-primary', newBranding.primaryColor);
                    }
                    if (newBranding.secondaryColor) {
                        document.documentElement.style.setProperty('--brand-secondary', newBranding.secondaryColor);
                    }
                }
            }
        } catch (error) {
            console.error('Error loading branding:', error);
        } finally {
            setLoading(false);
        }
    }, []);

    useEffect(() => {
        loadBranding();
        
        // Subscribe to real-time updates
        const services = window.FirebaseServices;
        let unsubscribe;
        if (services?.brandingService?.subscribeToBranding) {
            unsubscribe = services.brandingService.subscribeToBranding((data) => {
                // Firebase data takes full priority
                const newBranding = { ...DEFAULT_BRANDING };
                Object.keys(data).forEach(key => {
                    if (data[key] !== undefined) {
                        newBranding[key] = data[key];
                    }
                });
                setBranding(newBranding);
                // Update global cache for receipts
                if (window.updateCachedBranding) window.updateCachedBranding(newBranding);
                // Cache to localStorage for loading screen
                cacheBrandingToLocalStorage(newBranding);
                // Use newBranding which has proper fallbacks
                document.title = `${newBranding.companyName} - ${newBranding.tagline}`;
                if (newBranding.primaryColor) {
                    document.documentElement.style.setProperty('--brand-primary', newBranding.primaryColor);
                }
                if (newBranding.secondaryColor) {
                    document.documentElement.style.setProperty('--brand-secondary', newBranding.secondaryColor);
                }
            });
        }
        
        return () => {
            if (unsubscribe) unsubscribe();
        };
    }, [loadBranding]);

    const value = {
        branding,
        loading,
        refreshBranding: loadBranding
    };

    return React.createElement(BrandingContext.Provider, { value }, children);
}

// Global branding getter for use in non-React contexts (like receipt printing)
const getBrandingForReceipts = () => {
    // Try to get branding from Firebase services cache first
    const cached = window._cachedBranding;
    if (cached && cached.companyName) return cached;
    
    // Fallback to localStorage
    try {
        const localCached = localStorage.getItem('ecospark_branding');
        if (localCached) {
            const parsed = JSON.parse(localCached);
            // Only return if we have actual cached company name
            if (parsed.companyName) {
                return {
                    companyName: parsed.companyName,
                    tagline: parsed.tagline || 'Car Wash Management System',
                    address: parsed.address || '',
                    city: parsed.city || '',
                    phone: parsed.phone || '',
                    email: parsed.email || '',
                    taxPin: parsed.taxPin || '',
                    receiptHeader: parsed.receiptHeader || 'OFFICIAL RECEIPT',
                    receiptFooter: parsed.receiptFooter || 'Thank you for choosing us!',
                    currencySymbol: parsed.currencySymbol || 'KSh',
                    primaryColor: parsed.primaryColor || '#3b82f6',
                    secondaryColor: parsed.secondaryColor || '#10b981',
                    ...parsed
                };
            }
        }
    } catch (e) {
        console.log('Could not read branding from localStorage');
    }
    
    // Final fallback - use DEFAULT_BRANDING which already has proper values
    return DEFAULT_BRANDING;
};

// Update cached branding when context changes (called from BrandingProvider)
window.updateCachedBranding = (branding) => {
    window._cachedBranding = branding;
};

// ==================== LOGIN PAGE COMPONENT ====================
function LoginPage({ onLoginSuccess }) {
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState('');
    const [showPassword, setShowPassword] = useState(false);
    const { branding } = useBranding();

    const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        
        if (!email.trim() || !password.trim()) {
            setError('Please enter email and password');
            return;
        }

        setLoading(true);
        
        try {
            const services = window.FirebaseServices;
            if (!services?.authService) {
                setError('System initializing... please wait and try again');
                setLoading(false);
                return;
            }

            const result = await services.authService.signIn(email, password);
            
            if (result.success) {
                const userResult = await services.userService.getUserProfile(result.user.uid);
                
                if (userResult.success && userResult.data) {
                    if (!userResult.data.isActive) {
                        setError('Account deactivated. Contact administrator.');
                        await services.auditService?.logLogin(result.user, false, 'Account deactivated');
                        await services.authService.signOut();
                        setLoading(false);
                        return;
                    }
                    // Log successful login and start session
                    await services.auditService?.logLogin(result.user, true);
                    await services.auditService?.startSession(result.user);
                    onLoginSuccess(result.user, userResult.data);
                } else {
                    const initResult = await services.userService.initializeAdminUser(result.user.uid, result.user.email);
                    if (initResult.isFirstUser) {
                        const newUserResult = await services.userService.getUserProfile(result.user.uid);
                        await services.auditService?.logLogin(result.user, true);
                        await services.auditService?.startSession(result.user);
                        onLoginSuccess(result.user, newUserResult.data);
                    } else {
                        await services.userService.createUserProfile(result.user.uid, {
                            email: result.user.email,
                            displayName: result.user.email.split('@')[0],
                            role: 'receptionist'
                        });
                        const newUserResult = await services.userService.getUserProfile(result.user.uid);
                        await services.auditService?.logLogin(result.user, true);
                        await services.auditService?.startSession(result.user);
                        onLoginSuccess(result.user, newUserResult.data);
                    }
                }
            } else {
                let msg = result.error || 'Login failed';
                // Log failed login attempt
                await services.auditService?.logLogin({ email }, false, msg);
                if (msg.includes('user-not-found')) msg = 'No account found with this email';
                else if (msg.includes('wrong-password') || msg.includes('invalid-credential')) msg = 'Invalid email or password';
                else if (msg.includes('invalid-email')) msg = 'Please enter a valid email address';
                else if (msg.includes('too-many-requests')) msg = 'Too many attempts. Please try again later.';
                setError(msg);
            }
        } catch (err) {
            setError(err.message || 'Login failed');
        } finally {
            setLoading(false);
        }
    };

    // Car wash animation SVG icon
    const CarIcon = () => (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" style={{ width: '100%', height: '100%' }}>
            <path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9L18 10l-1.6-3.2A2 2 0 0014.6 5H9.4a2 2 0 00-1.8 1.1L6 10l-2.5.8C2.7 11.3 2 12.1 2 13v3c0 .6.4 1 1 1h2"/>
            <circle cx="7" cy="17" r="2"/>
            <circle cx="17" cy="17" r="2"/>
            <path d="M9 17h6"/>
        </svg>
    );

    return (
        <div style={{ 
            minHeight: '100vh', 
            display: 'flex',
            flexDirection: 'column',
            justifyContent: 'center',
            alignItems: 'center',
            background: '#1e3a5f',
            padding: '20px',
            position: 'relative',
            overflow: 'hidden'
        }}>
            {/* Background Pattern */}
            <div style={{
                position: 'absolute',
                inset: 0,
                opacity: 0.05,
                backgroundImage: `url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E")`,
            }}></div>
            
            {/* Floating elements for visual interest */}
            <div style={{
                position: 'absolute',
                top: '10%',
                left: '10%',
                width: '120px',
                height: '120px',
                background: 'rgba(59, 130, 246, 0.1)',
                borderRadius: '50%',
                filter: 'blur(40px)'
            }}></div>
            <div style={{
                position: 'absolute',
                bottom: '20%',
                right: '15%',
                width: '160px',
                height: '160px',
                background: 'rgba(16, 185, 129, 0.1)',
                borderRadius: '50%',
                filter: 'blur(50px)'
            }}></div>

            {/* Centered Login Card */}
            <div style={{ 
                position: 'relative',
                zIndex: 1,
                width: '100%',
                maxWidth: '420px',
                background: 'white',
                padding: '48px 40px',
                boxShadow: '0 25px 50px -12px rgba(0, 0, 0, 0.25)'
            }}>
                {/* Logo */}
                <div style={{
                    textAlign: 'center',
                    marginBottom: '32px'
                }}>
                    <div style={{
                        width: '72px',
                        height: '72px',
                        margin: '0 auto 16px',
                        background: `linear-gradient(135deg, ${branding.primaryColor || '#3b82f6'} 0%, ${branding.secondaryColor || '#10b981'} 100%)`,
                        borderRadius: '16px',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        color: 'white',
                        boxShadow: `0 8px 20px ${branding.primaryColor || '#3b82f6'}40`
                    }}>
                        {branding.logoUrl ? (
                            <img src={branding.logoUrl} alt="Logo" style={{ width: '50px', height: '50px', objectFit: 'contain' }} />
                        ) : (
                            <div style={{ width: '42px', height: '42px' }}>
                                <CarIcon />
                            </div>
                        )}
                    </div>
                    <h1 style={{ 
                        fontSize: '28px', 
                        fontWeight: '700', 
                        color: '#1e293b', 
                        margin: '0 0 4px',
                        letterSpacing: '-0.5px'
                    }}>{branding.companyName}</h1>
                    <p style={{ 
                        fontSize: '14px', 
                        color: '#64748b', 
                        margin: 0 
                    }}>{branding.tagline || 'Car Wash Management System'}</p>
                </div>

                {/* Welcome Text */}
                <div style={{ marginBottom: '24px', textAlign: 'center' }}>
                    <h2 style={{ 
                        fontSize: '20px', 
                        fontWeight: '600', 
                        color: '#1e293b', 
                        margin: '0 0 4px'
                    }}>Welcome back</h2>
                    <p style={{ 
                        fontSize: '14px', 
                        color: '#64748b', 
                        margin: 0 
                    }}>Sign in to your account to continue</p>
                </div>

                    {/* Error Message */}
                    {error && (
                        <div style={{ 
                            background: '#fef2f2', 
                            border: '1px solid #fecaca', 
                            color: '#dc2626', 
                            padding: '14px 16px', 
                            marginBottom: '24px', 
                            fontSize: '14px',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '10px'
                        }}>
                            <span style={{ fontSize: '18px' }}>‚ö†Ô∏è</span>
                            <span>{error}</span>
                        </div>
                    )}

                    {/* Login Form */}
                    <form onSubmit={handleSubmit}>
                        <div style={{ marginBottom: '20px' }}>
                            <label style={{ 
                                display: 'block', 
                                fontSize: '14px', 
                                fontWeight: '500', 
                                color: '#374151', 
                                marginBottom: '8px' 
                            }}>Email Address</label>
                            <div style={{ position: 'relative' }}>
                                <span style={{
                                    position: 'absolute',
                                    left: '14px',
                                    top: '50%',
                                    transform: 'translateY(-50%)',
                                    color: '#9ca3af',
                                    fontSize: '18px'
                                }}>üìß</span>
                                <input
                                    type="email"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    placeholder="you@example.com"
                                    style={{ 
                                        width: '100%', 
                                        padding: '14px 14px 14px 46px', 
                                        border: '1px solid #e2e8f0', 
                                        fontSize: '15px', 
                                        outline: 'none', 
                                        boxSizing: 'border-box',
                                        transition: 'border-color 0.2s, box-shadow 0.2s'
                                    }}
                                    onFocus={(e) => {
                                        e.target.style.borderColor = '#3b82f6';
                                        e.target.style.boxShadow = '0 0 0 3px rgba(59, 130, 246, 0.1)';
                                    }}
                                    onBlur={(e) => {
                                        e.target.style.borderColor = '#e2e8f0';
                                        e.target.style.boxShadow = 'none';
                                    }}
                                />
                            </div>
                        </div>

                        <div style={{ marginBottom: '28px' }}>
                            <label style={{ 
                                display: 'block', 
                                fontSize: '14px', 
                                fontWeight: '500', 
                                color: '#374151', 
                                marginBottom: '8px' 
                            }}>Password</label>
                            <div style={{ position: 'relative' }}>
                                <span style={{
                                    position: 'absolute',
                                    left: '14px',
                                    top: '50%',
                                    transform: 'translateY(-50%)',
                                    color: '#9ca3af',
                                    fontSize: '18px'
                                }}>üîí</span>
                                <input
                                    type={showPassword ? 'text' : 'password'}
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    placeholder="Enter your password"
                                    style={{ 
                                        width: '100%', 
                                        padding: '14px 46px 14px 46px', 
                                        border: '1px solid #e2e8f0', 
                                        fontSize: '15px', 
                                        outline: 'none', 
                                        boxSizing: 'border-box',
                                        transition: 'border-color 0.2s, box-shadow 0.2s'
                                    }}
                                    onFocus={(e) => {
                                        e.target.style.borderColor = '#3b82f6';
                                        e.target.style.boxShadow = '0 0 0 3px rgba(59, 130, 246, 0.1)';
                                    }}
                                    onBlur={(e) => {
                                        e.target.style.borderColor = '#e2e8f0';
                                        e.target.style.boxShadow = 'none';
                                    }}
                                />
                                <button
                                    type="button"
                                    onClick={() => setShowPassword(!showPassword)}
                                    style={{
                                        position: 'absolute',
                                        right: '14px',
                                        top: '50%',
                                        transform: 'translateY(-50%)',
                                        background: 'none',
                                        border: 'none',
                                        color: '#9ca3af',
                                        cursor: 'pointer',
                                        fontSize: '16px',
                                        padding: '0'
                                    }}
                                >
                                    {showPassword ? 'üëÅÔ∏è' : 'üëÅÔ∏è‚Äçüó®Ô∏è'}
                                </button>
                            </div>
                        </div>

                        <button
                            type="submit"
                            disabled={loading}
                            style={{ 
                                width: '100%', 
                                padding: '14px', 
                                background: loading ? `${branding.primaryColor || '#3b82f6'}80` : (branding.primaryColor || '#3b82f6'), 
                                color: 'white', 
                                border: 'none', 
                                fontSize: '15px', 
                                fontWeight: '600', 
                                cursor: loading ? 'wait' : 'pointer',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                gap: '10px',
                                transition: 'background 0.2s'
                            }}
                            onMouseOver={(e) => !loading && (e.target.style.background = branding.primaryColor ? `${branding.primaryColor}dd` : '#2563eb')}
                            onMouseOut={(e) => !loading && (e.target.style.background = branding.primaryColor || '#3b82f6')}
                        >
                            {loading ? (
                                <>
                                    <span style={{
                                        width: '18px',
                                        height: '18px',
                                        border: '2px solid rgba(255,255,255,0.3)',
                                        borderTopColor: 'white',
                                        borderRadius: '50%',
                                        animation: 'spin 0.8s linear infinite'
                                    }}></span>
                                    Signing in...
                                </>
                            ) : 'Sign In'}
                        </button>
                    </form>

                    {/* Help text */}
                    <div style={{ 
                        marginTop: '24px', 
                        textAlign: 'center',
                        padding: '16px',
                        background: '#f8fafc'
                    }}>
                        <p style={{ fontSize: '13px', color: '#64748b', margin: 0 }}>
                            <span style={{ marginRight: '6px' }}>üîê</span>
                            Need help? Contact your system administrator
                        </p>
                    </div>
                </div>

            {/* Footer */}
            <div style={{
                position: 'absolute',
                bottom: '20px',
                left: '0',
                right: '0',
                textAlign: 'center',
                color: 'rgba(255,255,255,0.5)',
                fontSize: '13px',
                zIndex: 1
            }}>
                ¬© {new Date().getFullYear()} {branding.companyName}. All rights reserved.
            </div>

            {/* CSS */}
            <style>{`
                @keyframes spin {
                    to { transform: rotate(360deg); }
                }
            `}</style>
        </div>
    );
}

// ==================== PERMISSION HELPER ====================
const PermissionContext = createContext(null);

const usePermissions = () => {
    const context = useContext(PermissionContext);
    if (!context) {
        return {
            hasModuleAccess: () => true,
            hasPermission: () => true,
            userRole: 'admin',
            isSuperAdmin: false,
            canCreate: () => true,
            canEdit: () => true,
            canDelete: () => true,
            canView: () => true
        };
    }
    return {
        ...context,
        canCreate: (moduleId) => context.hasPermission(moduleId, 'create'),
        canEdit: (moduleId) => context.hasPermission(moduleId, 'edit'),
        canDelete: (moduleId) => context.hasPermission(moduleId, 'delete'),
        canView: (moduleId) => context.hasPermission(moduleId, 'view')
    };
};

// Permission Denied Toast Component
const PermissionDeniedToast = ({ show, onClose, action = 'perform this action' }) => {
    useEffect(() => {
        if (show) {
            const timer = setTimeout(onClose, 3000);
            return () => clearTimeout(timer);
        }
    }, [show, onClose]);
    
    if (!show) return null;
    
    return (
        <div style={{
            position: 'fixed',
            bottom: '24px',
            right: '24px',
            background: '#fef2f2',
            border: '1px solid #fecaca',
            borderRadius: '12px',
            padding: '16px 20px',
            display: 'flex',
            alignItems: 'center',
            gap: '12px',
            boxShadow: '0 10px 25px rgba(239, 68, 68, 0.2)',
            zIndex: 9999,
            animation: 'slideIn 0.3s ease'
        }}>
            <div style={{ 
                width: '40px', 
                height: '40px', 
                background: '#fee2e2', 
                borderRadius: '50%', 
                display: 'flex', 
                alignItems: 'center', 
                justifyContent: 'center',
                fontSize: '20px'
            }}>üîí</div>
            <div>
                <div style={{ fontWeight: '600', color: '#dc2626', fontSize: '14px' }}>Permission Denied</div>
                <div style={{ color: '#991b1b', fontSize: '13px' }}>You don't have permission to {action}</div>
            </div>
            <button onClick={onClose} style={{ 
                background: 'none', 
                border: 'none', 
                color: '#dc2626', 
                cursor: 'pointer',
                fontSize: '18px',
                padding: '4px'
            }}>√ó</button>
        </div>
    );
};

// Icon Components
const Icons = {
    dashboard: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>,
    car: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 16H9m10 0h3l-3.5-7a2 2 0 0 0-1.9-1.3H7.4a2 2 0 0 0-1.9 1.3L2 16h3m0 0a2 2 0 1 0 4 0m4 0a2 2 0 1 0 4 0"/></svg>,
    package: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/></svg>,
    plus: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
    play: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>,
    pause: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>,
    x: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
    refresh: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"/><path d="M3 22v-6h6"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"/></svg>,
    star: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>,
    clock: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
    check: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>,
    arrowRight: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>,
    edit: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>,
    eye: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>,
    fileText: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>,
    scan: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/><line x1="7" y1="12" x2="17" y2="12"/></svg>,
    building: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="4" y="2" width="16" height="20" rx="2"/><path d="M9 22v-4h6v4"/><path d="M8 6h.01"/><path d="M16 6h.01"/><path d="M12 6h.01"/><path d="M12 10h.01"/><path d="M12 14h.01"/><path d="M16 10h.01"/><path d="M16 14h.01"/><path d="M8 10h.01"/><path d="M8 14h.01"/></svg>,
    droplet: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/></svg>,
    tool: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>,
    users: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
    truck: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 18V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v11a1 1 0 0 0 1 1h2"/><path d="M15 18H9"/><path d="M19 18h2a1 1 0 0 0 1-1v-3.65a1 1 0 0 0-.22-.624l-3.48-4.35A1 1 0 0 0 17.52 8H14"/><circle cx="17" cy="18" r="2"/><circle cx="7" cy="18" r="2"/></svg>,
    briefcase: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>,
    calendar: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>,
    creditCard: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>,
    clipboard: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1"/></svg>,
    trendingUp: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>,
    megaphone: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m3 11 18-5v12L3 13v-2z"/><path d="M11.6 16.8a3 3 0 1 1-5.8-1.6"/></svg>,
    settings: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6M4.2 4.2l4.2 4.2m5.6 5.6l4.2 4.2M1 12h6m6 0h6M4.2 19.8l4.2-4.2m5.6-5.6l4.2-4.2"/></svg>,
    printer: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
};

// ==================== ALERT MODAL COMPONENT ====================
// Reusable modal for alerts, confirmations, and notifications
function AlertModal({ isOpen, onClose, title, message, type = 'info', confirmText = 'OK', cancelText = 'Cancel', onConfirm, showCancel = false }) {
    if (!isOpen) return null;

    const typeConfig = {
        success: {
            icon: (
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none">
                    <circle cx="12" cy="12" r="10" fill="#dcfce7" stroke="#22c55e" strokeWidth="2"/>
                    <path d="M8 12l2.5 2.5L16 9" stroke="#22c55e" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"/>
                </svg>
            ),
            accentColor: '#22c55e',
            bgGradient: 'linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%)'
        },
        error: {
            icon: (
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none">
                    <circle cx="12" cy="12" r="10" fill="#fee2e2" stroke="#ef4444" strokeWidth="2"/>
                    <path d="M15 9l-6 6M9 9l6 6" stroke="#ef4444" strokeWidth="2.5" strokeLinecap="round"/>
                </svg>
            ),
            accentColor: '#ef4444',
            bgGradient: 'linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%)'
        },
        warning: {
            icon: (
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none">
                    <circle cx="12" cy="12" r="10" fill="#fef3c7" stroke="#f59e0b" strokeWidth="2"/>
                    <path d="M12 8v4M12 16h.01" stroke="#f59e0b" strokeWidth="2.5" strokeLinecap="round"/>
                </svg>
            ),
            accentColor: '#f59e0b',
            bgGradient: 'linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%)'
        },
        info: {
            icon: (
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none">
                    <circle cx="12" cy="12" r="10" fill="#dbeafe" stroke="#3b82f6" strokeWidth="2"/>
                    <path d="M12 16v-4M12 8h.01" stroke="#3b82f6" strokeWidth="2.5" strokeLinecap="round"/>
                </svg>
            ),
            accentColor: '#3b82f6',
            bgGradient: 'linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%)'
        },
        loyalty: {
            icon: (
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none">
                    <circle cx="12" cy="12" r="10" fill="#fae8ff" stroke="#a855f7" strokeWidth="2"/>
                    <path d="M12 2l2.4 7.4h7.6l-6 4.6 2.3 7-6.3-4.6-6.3 4.6 2.3-7-6-4.6h7.6z" fill="#a855f7" stroke="#a855f7" strokeWidth="1"/>
                </svg>
            ),
            accentColor: '#a855f7',
            bgGradient: 'linear-gradient(135deg, #fdf4ff 0%, #fae8ff 100%)'
        }
    };

    const config = typeConfig[type] || typeConfig.info;

    const handleConfirm = () => {
        if (onConfirm) {
            onConfirm();
        }
        onClose();
    };

    return (
        <div 
            className="alert-modal-overlay" 
            onClick={onClose}
            style={{
                position: 'fixed',
                inset: 0,
                backgroundColor: 'rgba(15, 23, 42, 0.6)',
                backdropFilter: 'blur(4px)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                zIndex: 10000,
                animation: 'alertFadeIn 0.2s ease-out'
            }}
        >
            <div 
                className="alert-modal-content"
                onClick={e => e.stopPropagation()}
                style={{
                    background: 'white',
                    borderRadius: '16px',
                    boxShadow: '0 25px 50px -12px rgba(0, 0, 0, 0.25)',
                    maxWidth: '400px',
                    width: '90%',
                    overflow: 'hidden',
                    animation: 'alertSlideIn 0.3s ease-out'
                }}
            >
                {/* Icon Section */}
                <div style={{
                    background: config.bgGradient,
                    padding: '32px 24px 24px',
                    display: 'flex',
                    flexDirection: 'column',
                    alignItems: 'center',
                    borderBottom: `3px solid ${config.accentColor}`
                }}>
                    <div style={{ marginBottom: '16px' }}>
                        {config.icon}
                    </div>
                    {title && (
                        <h3 style={{
                            margin: 0,
                            fontSize: '20px',
                            fontWeight: '700',
                            color: '#1e293b',
                            textAlign: 'center'
                        }}>
                            {title}
                        </h3>
                    )}
                </div>

                {/* Message Section */}
                <div style={{ padding: '24px' }}>
                    <p style={{
                        margin: 0,
                        fontSize: '15px',
                        lineHeight: '1.6',
                        color: '#475569',
                        textAlign: 'center',
                        whiteSpace: 'pre-line'
                    }}>
                        {message}
                    </p>
                </div>

                {/* Action Buttons */}
                <div style={{
                    padding: '16px 24px 24px',
                    display: 'flex',
                    gap: '12px',
                    justifyContent: 'center'
                }}>
                    {showCancel && (
                        <button
                            onClick={onClose}
                            style={{
                                padding: '12px 24px',
                                borderRadius: '10px',
                                border: '1px solid #e2e8f0',
                                background: 'white',
                                color: '#64748b',
                                fontSize: '14px',
                                fontWeight: '600',
                                cursor: 'pointer',
                                transition: 'all 0.2s ease',
                                minWidth: '100px'
                            }}
                            onMouseOver={e => e.target.style.background = '#f8fafc'}
                            onMouseOut={e => e.target.style.background = 'white'}
                        >
                            {cancelText}
                        </button>
                    )}
                    <button
                        onClick={handleConfirm}
                        style={{
                            padding: '12px 24px',
                            borderRadius: '10px',
                            border: 'none',
                            background: config.accentColor,
                            color: 'white',
                            fontSize: '14px',
                            fontWeight: '600',
                            cursor: 'pointer',
                            transition: 'all 0.2s ease',
                            minWidth: '100px',
                            boxShadow: `0 4px 12px ${config.accentColor}40`
                        }}
                        onMouseOver={e => e.target.style.transform = 'translateY(-1px)'}
                        onMouseOut={e => e.target.style.transform = 'translateY(0)'}
                    >
                        {confirmText}
                    </button>
                </div>
            </div>

            <style>{`
                @keyframes alertFadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }
                @keyframes alertSlideIn {
                    from { opacity: 0; transform: scale(0.95) translateY(-10px); }
                    to { opacity: 1; transform: scale(1) translateY(0); }
                }
            `}</style>
        </div>
    );
}

// Menu items configuration with categories
const menuGroups = [
    {
        label: 'Main',
        items: [
            { id: 'dashboard', label: 'Dashboard', icon: Icons.dashboard }
        ]
    },
    {
        label: 'Vehicle Management',
        items: [
            { 
                id: 'vehicle-intake', 
                label: 'Vehicle Intake', 
                icon: Icons.car,
                subItems: [
                    { id: 'vehicle-intake-all', label: 'View All Records', icon: 'üìã' }
                ]
            },
            { id: 'service-packages', label: 'Service Packages', icon: Icons.package }
        ]
    },
    {
        label: 'Operations',
        items: [
            { id: 'garage-management', label: 'Garage Management', icon: Icons.building },
            { id: 'wash-bays', label: 'Wash Bays', icon: Icons.droplet },
            { id: 'parking', label: 'Parking Management', icon: Icons.calendar },
            { id: 'equipment', label: 'Equipment Management', icon: Icons.tool }
        ]
    },
    {
        label: 'Customer Relations',
        items: [
            { id: 'customers', label: 'Customer Management', icon: Icons.users },
            { id: 'fleet', label: 'Fleet Accounts', icon: Icons.truck }
        ]
    },
    {
        label: 'Staff',
        items: [
            { id: 'staff', label: 'Staff Management', icon: Icons.briefcase }
        ]
    },
    {
        label: 'Human Resources',
        items: [
            { id: 'hr', label: 'HR Statistics', icon: Icons.users }
        ]
    },
    {
        label: 'Financial',
        items: [
            { id: 'billing', label: 'Billing Payments', icon: Icons.creditCard },
            { id: 'expenses', label: 'Expenses', icon: Icons.trendingUp },
            { id: 'inventory', label: 'Inventory Management', icon: Icons.clipboard }
        ]
    },
    {
        label: 'Analytics & Marketing',
        items: [
            { id: 'reports', label: 'Reports Analytics', icon: Icons.trendingUp },
            { id: 'marketing', label: 'Marketing CRM', icon: Icons.megaphone }
        ]
    }
];

const settingsItem = { id: 'settings', label: 'System Settings', icon: Icons.settings };
const activitiesItem = { id: 'activities', label: 'Activities', icon: Icons.clipboard };

// Flatten menu items for easy lookup (including sub-items)
const menuItems = [
    ...menuGroups.flatMap(group => group.items.flatMap(item => 
        item.subItems ? [item, ...item.subItems] : [item]
    )),
    settingsItem,
    activitiesItem
];

// Sidebar Component
function Sidebar({ isCollapsed, activeModule, onModuleClick, userProfile, hasModuleAccess }) {
    const { branding } = useBranding();
    
    // Filter menu groups based on user permissions
    const filteredMenuGroups = menuGroups.map(group => ({
        ...group,
        items: group.items.filter(item => hasModuleAccess ? hasModuleAccess(item.id) : true)
    })).filter(group => group.items.length > 0);

    const canAccessSettings = hasModuleAccess ? hasModuleAccess('settings') : true;

    return (
        <div className={`sidebar ${isCollapsed ? 'collapsed' : ''}`}>
            <div className="sidebar-logo">
                {branding.logoUrl ? (
                    <img src={branding.logoUrl} alt="Logo" style={{ width: '32px', height: '32px', objectFit: 'contain', borderRadius: '6px' }} />
                ) : (
                    <div className="sidebar-logo-icon">üöó</div>
                )}
                <div className="sidebar-logo-text">{branding.companyName}</div>
            </div>
            <div className="sidebar-menu">
                {filteredMenuGroups.map((group, groupIndex) => (
                    <div key={groupIndex} className="sidebar-menu-group">
                        {!isCollapsed && <div className="sidebar-menu-header">{group.label}</div>}
                        {group.items.map((item) => (
                            <React.Fragment key={item.id}>
                                <div
                                    className={`sidebar-menu-item ${activeModule === item.id || (item.subItems && item.subItems.some(s => s.id === activeModule)) ? 'active' : ''}`}
                                    onClick={() => onModuleClick(item.id)}
                                    style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}
                                >
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                                        <span className="sidebar-menu-item-icon">{item.icon}</span>
                                        <span>{item.label}</span>
                                    </div>
                                    {/* Dropdown indicator */}
                                    {item.subItems && !isCollapsed && (
                                        <span style={{ 
                                            fontSize: '10px', 
                                            opacity: 0.6,
                                            transition: 'transform 0.2s',
                                            transform: (activeModule === item.id || item.subItems.some(s => s.id === activeModule)) ? 'rotate(180deg)' : 'rotate(0deg)'
                                        }}>
                                            ‚ñº
                                        </span>
                                    )}
                                </div>
                                {/* Sub-items - clean dropdown */}
                                {item.subItems && !isCollapsed && (activeModule === item.id || item.subItems.some(s => s.id === activeModule)) && (
                                    <div style={{ marginLeft: '32px', marginTop: '4px', marginBottom: '4px' }}>
                                        {item.subItems.map(subItem => (
                                            <div
                                                key={subItem.id}
                                                onClick={(e) => { e.stopPropagation(); onModuleClick(subItem.id); }}
                                                style={{ 
                                                    padding: '8px 12px', 
                                                    fontSize: '12px',
                                                    color: activeModule === subItem.id ? '#fff' : 'rgba(255,255,255,0.7)',
                                                    backgroundColor: activeModule === subItem.id ? 'rgba(255,255,255,0.1)' : 'transparent',
                                                    borderRadius: '6px',
                                                    cursor: 'pointer',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    gap: '8px',
                                                    transition: 'all 0.15s'
                                                }}
                                                onMouseEnter={(e) => { if (activeModule !== subItem.id) e.currentTarget.style.backgroundColor = 'rgba(255,255,255,0.05)'; }}
                                                onMouseLeave={(e) => { if (activeModule !== subItem.id) e.currentTarget.style.backgroundColor = 'transparent'; }}
                                            >
                                                <span style={{ fontSize: '12px' }}>{subItem.icon}</span>
                                                <span>{subItem.label}</span>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </React.Fragment>
                        ))}
                    </div>
                ))}
                
                <div className="sidebar-spacer"></div>
                
                {canAccessSettings && (
                    <div className="sidebar-menu-group sidebar-menu-group-settings">
                        <div className="sidebar-separator"></div>
                        <div
                            className={`sidebar-menu-item ${activeModule === settingsItem.id ? 'active' : ''}`}
                            onClick={() => onModuleClick(settingsItem.id)}
                        >
                            <span className="sidebar-menu-item-icon">{settingsItem.icon}</span>
                            <span>{settingsItem.label}</span>
                        </div>
                    </div>
                )}
            </div>
            
            {/* User info at bottom of sidebar */}
            {userProfile && !isCollapsed && (
                <div style={{
                    padding: '12px 16px',
                    borderTop: '1px solid rgba(255,255,255,0.1)',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '10px'
                }}>
                    <div style={{
                        width: '32px',
                        height: '32px',
                        borderRadius: '50%',
                        backgroundColor: '#3b82f6',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        color: 'white',
                        fontSize: '13px',
                        fontWeight: '600'
                    }}>
                        {(userProfile.displayName || userProfile.email || 'U').charAt(0).toUpperCase()}
                    </div>
                    <div style={{ flex: 1, minWidth: 0 }}>
                        <div style={{ 
                            fontSize: '13px', 
                            fontWeight: '500', 
                            color: 'white',
                            overflow: 'hidden',
                            textOverflow: 'ellipsis',
                            whiteSpace: 'nowrap'
                        }}>
                            {userProfile.displayName || userProfile.email?.split('@')[0] || 'User'}
                        </div>
                        <div style={{ 
                            fontSize: '11px', 
                            color: 'rgba(255,255,255,0.6)',
                            textTransform: 'capitalize'
                        }}>
                            {userProfile.role || 'User'}
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}

// Notification Dropdown Component - Real-time Global Notifications
function NotificationDropdown({ isOpen, onClose, onModuleClick, notifications, unreadCount, onMarkAsRead, onMarkAllRead, onClearAll }) {
    const formatTime = (timestamp) => {
        if (!timestamp) return '';
        try {
            let date;
            if (timestamp.toDate) date = timestamp.toDate();
            else if (timestamp.seconds) date = new Date(timestamp.seconds * 1000);
            else date = new Date(timestamp);
            
            const now = new Date();
            const diff = now - date;
            const mins = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (mins < 1) return 'Just now';
            if (mins < 60) return `${mins}m ago`;
            if (hours < 24) return `${hours}h ago`;
            if (days === 1) return 'Yesterday';
            return date.toLocaleDateString();
        } catch { return ''; }
    };

    const handleNotificationClick = (notification) => {
        onMarkAsRead(notification.id);
        if (onModuleClick && notification.module) {
            onModuleClick(notification.module);
        }
        onClose();
    };

    if (!isOpen) return null;

    return (
        <>
            <div className="dropdown-overlay" onClick={onClose}></div>
            <div className="dropdown notification-dropdown" style={{ 
                width: '380px', 
                maxHeight: '500px',
                borderRadius: '0'
            }}>
                <div className="dropdown-header" style={{ 
                    padding: '14px 20px', 
                    borderBottom: '1px solid var(--border-color)',
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center'
                }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                        <h3 style={{ margin: 0, fontSize: '16px', fontWeight: '600' }}>Notifications</h3>
                        {unreadCount > 0 && (
                            <span style={{ 
                                fontSize: '11px', 
                                padding: '2px 8px', 
                                background: '#ef4444',
                                color: 'white',
                                borderRadius: '10px',
                                fontWeight: '600'
                            }}>
                                {unreadCount} new
                            </span>
                        )}
                    </div>
                    <div style={{ display: 'flex', gap: '8px' }}>
                        {unreadCount > 0 && (
                            <button 
                                onClick={onMarkAllRead}
                                style={{
                                    background: 'none',
                                    border: 'none',
                                    color: 'var(--accent-color)',
                                    fontSize: '12px',
                                    cursor: 'pointer',
                                    padding: '4px 8px',
                                    fontWeight: '500'
                                }}
                                title="Mark all as read"
                            >
                                ‚úì Mark all read
                            </button>
                        )}
                        {notifications.length > 0 && (
                            <button 
                                onClick={onClearAll}
                                style={{
                                    background: 'none',
                                    border: 'none',
                                    color: '#ef4444',
                                    fontSize: '12px',
                                    cursor: 'pointer',
                                    padding: '4px 8px',
                                    fontWeight: '500'
                                }}
                                title="Clear all notifications"
                            >
                                ‚úï Clear all
                            </button>
                        )}
                    </div>
                </div>
                <div className="dropdown-content" style={{ 
                    maxHeight: '400px', 
                    overflowY: 'auto',
                    padding: 0
                }}>
                    {notifications.length === 0 ? (
                        <div className="empty-state" style={{ padding: '40px', textAlign: 'center' }}>
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" style={{ color: 'var(--text-secondary)', marginBottom: '12px' }}>
                                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                                <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                            </svg>
                            <p style={{ color: 'var(--text-secondary)', margin: 0 }}>No notifications</p>
                        </div>
                    ) : (
                        notifications.map((notif, idx) => (
                            <div 
                                key={notif.id} 
                                onClick={() => handleNotificationClick(notif)}
                                style={{ 
                                    padding: '14px 20px',
                                    display: 'flex',
                                    gap: '14px',
                                    cursor: 'pointer',
                                    borderBottom: idx < notifications.length - 1 ? '1px solid var(--border-color)' : 'none',
                                    transition: 'background 0.15s',
                                    background: notif.priority === 'high' ? 'rgba(239, 68, 68, 0.05)' : notif.isRead ? 'transparent' : 'rgba(59, 130, 246, 0.03)',
                                    opacity: notif.isRead ? 0.7 : 1,
                                    position: 'relative'
                                }}
                                className="notification-item"
                            >
                                {/* Unread indicator */}
                                {!notif.isRead && (
                                    <div style={{
                                        position: 'absolute',
                                        left: '8px',
                                        width: '6px',
                                        height: '6px',
                                        borderRadius: '50%',
                                        background: '#3b82f6',
                                        top: '50%',
                                        transform: 'translateY(-50%)'
                                    }}></div>
                                )}
                                <div style={{
                                    width: '40px',
                                    height: '40px',
                                    borderRadius: '0',
                                    background: `${notif.color}15`,
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    fontSize: '18px',
                                    flexShrink: 0
                                }}>
                                    {notif.icon}
                                </div>
                                <div style={{ flex: 1, minWidth: 0 }}>
                                    <div style={{ 
                                        fontSize: '14px', 
                                        fontWeight: notif.isRead ? '400' : '600', 
                                        color: 'var(--text-primary)',
                                        marginBottom: '4px',
                                        overflow: 'hidden',
                                        textOverflow: 'ellipsis',
                                        whiteSpace: 'nowrap'
                                    }}>
                                        {notif.title}
                                    </div>
                                    <div style={{ 
                                        fontSize: '12px', 
                                        color: 'var(--text-secondary)',
                                        display: 'flex',
                                        justifyContent: 'space-between',
                                        alignItems: 'center'
                                    }}>
                                        <span style={{ overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>{notif.subtitle}</span>
                                        <span style={{ flexShrink: 0, marginLeft: '8px', fontSize: '11px' }}>{formatTime(notif.timestamp)}</span>
                                    </div>
                                </div>
                                <div style={{ display: 'flex', gap: '4px', alignItems: 'center', flexShrink: 0 }}>
                                    {!notif.isRead && (
                                        <button
                                            onClick={(e) => { e.stopPropagation(); onMarkAsRead(notif.id); }}
                                            style={{
                                                background: 'none',
                                                border: 'none',
                                                color: 'var(--text-secondary)',
                                                cursor: 'pointer',
                                                padding: '4px',
                                                fontSize: '14px',
                                                opacity: 0.6,
                                                transition: 'opacity 0.15s'
                                            }}
                                            title="Mark as read"
                                            onMouseEnter={(e) => e.target.style.opacity = 1}
                                            onMouseLeave={(e) => e.target.style.opacity = 0.6}
                                        >
                                            ‚úì
                                        </button>
                                    )}
                                    {notif.priority === 'high' && (
                                        <div style={{
                                            width: '8px',
                                            height: '8px',
                                            borderRadius: '50%',
                                            background: '#ef4444'
                                        }}></div>
                                    )}
                                </div>
                            </div>
                        ))
                    )}
                </div>
                {notifications.length > 0 && (
                    <div style={{ 
                        padding: '12px 20px', 
                        borderTop: '1px solid var(--border-color)',
                        textAlign: 'center'
                    }}>
                        <button 
                            onClick={() => { onModuleClick && onModuleClick('activities'); onClose(); }}
                            style={{
                                background: 'none',
                                border: 'none',
                                color: 'var(--accent-color)',
                                fontSize: '13px',
                                fontWeight: '600',
                                cursor: 'pointer'
                            }}
                        >
                            View All Activities ‚Üí
                        </button>
                    </div>
                )}
            </div>
        </>
    );
}

// Team Chat Dropdown Component
function TeamChatDropdown({ isOpen, onClose, userProfile }) {
    const [messages, setMessages] = useState([]);
    const [usersList, setUsersList] = useState([]);
    const [newMessage, setNewMessage] = useState('');
    const [selectedRecipient, setSelectedRecipient] = useState('all');
    const [isComposing, setIsComposing] = useState(false);
    const [lastMessageCount, setLastMessageCount] = useState(0);
    const [showClearConfirm, setShowClearConfirm] = useState(false);
    const [isClearing, setIsClearing] = useState(false);
    const [showEmojiPicker, setShowEmojiPicker] = useState(false);
    const messagesEndRef = React.useRef(null);
    const chatContainerRef = React.useRef(null);
    const audioContextRef = React.useRef(null);

    const currentUserId = userProfile?.id || userProfile?.uid || 'user';
    const currentUserName = userProfile?.name || userProfile?.displayName || userProfile?.email?.split('@')[0] || 'Unknown User';
    const currentUserRole = userProfile?.role || 'User';

    // Professional emoji set
    const emojiList = [
        'üëç', 'üëå', 'üëè', 'üôå', 'üí™', 'ü§ù',
        'üòä', 'üòÑ', 'üôÇ', 'üòÅ', 'üòÖ', 'ü§ó',
        '‚úÖ', '‚ùå', '‚≠ê', 'üî•', 'üíØ', 'üéâ',
        'üëÄ', 'üí°', 'üìå', 'üöÄ', '‚ö°', 'üí∞',
        'üôè', '‚ù§Ô∏è', 'üíô', 'üíö', '‚è∞', 'üìû'
    ];

    // Insert emoji into message
    const insertEmoji = (emoji) => {
        setNewMessage(prev => prev + emoji);
        setShowEmojiPicker(false);
    };

    // Handle clear all chats
    const handleClearAllChats = async () => {
        setIsClearing(true);
        const svc = window.FirebaseServices;
        if (svc?.teamChatService?.clearAllMessages) {
            await svc.teamChatService.clearAllMessages();
        }
        setIsClearing(false);
        setShowClearConfirm(false);
    };

    // Play send sound
    const playSendSound = () => {
        try {
            if (!audioContextRef.current) {
                audioContextRef.current = new (window.AudioContext || window.webkitAudioContext)();
            }
            const ctx = audioContextRef.current;
            const oscillator = ctx.createOscillator();
            const gainNode = ctx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(ctx.destination);
            oscillator.frequency.setValueAtTime(800, ctx.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(1200, ctx.currentTime + 0.1);
            gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.15);
            oscillator.start(ctx.currentTime);
            oscillator.stop(ctx.currentTime + 0.15);
        } catch (e) { console.log('Sound not supported'); }
    };

    // Play receive sound
    const playReceiveSound = () => {
        try {
            if (!audioContextRef.current) {
                audioContextRef.current = new (window.AudioContext || window.webkitAudioContext)();
            }
            const ctx = audioContextRef.current;
            const oscillator = ctx.createOscillator();
            const gainNode = ctx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(ctx.destination);
            oscillator.frequency.setValueAtTime(600, ctx.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(900, ctx.currentTime + 0.08);
            oscillator.frequency.exponentialRampToValueAtTime(700, ctx.currentTime + 0.15);
            gainNode.gain.setValueAtTime(0.2, ctx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);
            oscillator.start(ctx.currentTime);
            oscillator.stop(ctx.currentTime + 0.2);
        } catch (e) { console.log('Sound not supported'); }
    };

    // Subscribe to messages and users
    useEffect(() => {
        let unsubMessages = null;
        let unsubUsers = null;
        const init = async () => {
            const svc = window.FirebaseServices;
            if (!svc?.teamChatService) return;
            
            // Subscribe to users list
            unsubUsers = svc.teamChatService.subscribeToUsers((users) => {
                setUsersList(users.filter(u => u.id !== currentUserId));
            });

            // Subscribe to messages
            unsubMessages = svc.teamChatService.subscribeToMessages(currentUserId, (msgs) => {
                // Check for new messages (play sound)
                if (msgs.length > lastMessageCount && lastMessageCount > 0) {
                    const newestMsg = msgs[msgs.length - 1];
                    if (newestMsg && newestMsg.senderId !== currentUserId) {
                        playReceiveSound();
                    }
                }
                setLastMessageCount(msgs.length);
                setMessages(msgs);
                
                // Mark as delivered
                msgs.forEach(msg => {
                    if (msg.senderId !== currentUserId && (!msg.deliveredTo || !msg.deliveredTo[currentUserId])) {
                        svc.teamChatService.markAsDelivered(msg.id, currentUserId);
                    }
                });
                
                // Auto-scroll to bottom on new messages
                setTimeout(() => {
                    if (chatContainerRef.current) {
                        chatContainerRef.current.scrollTop = chatContainerRef.current.scrollHeight;
                    }
                }, 100);
            });
        };
        init();
        return () => { 
            if (unsubMessages) unsubMessages(); 
            if (unsubUsers) unsubUsers();
        };
    }, [currentUserId, lastMessageCount]);

    // Mark messages as read when dropdown is open
    useEffect(() => {
        if (!isOpen) return;
        const svc = window.FirebaseServices;
        if (!svc?.teamChatService) return;
        
        messages.forEach(msg => {
            if (msg.senderId !== currentUserId && (!msg.readBy || !msg.readBy[currentUserId])) {
                svc.teamChatService.markAsRead(msg.id, currentUserId);
            }
        });
    }, [isOpen, messages, currentUserId]);

    const handleSendMessage = async () => {
        if (!newMessage.trim()) return;
        const svc = window.FirebaseServices;
        if (!svc?.teamChatService) return;

        const recipient = selectedRecipient === 'all' 
            ? { id: 'all', name: 'All Users' }
            : usersList.find(u => u.id === selectedRecipient) || { id: selectedRecipient, name: 'User' };

        playSendSound();

        await svc.teamChatService.sendMessage({
            senderId: currentUserId,
            senderName: currentUserName,
            senderRole: currentUserRole,
            recipientId: recipient.id,
            recipientName: recipient.name || recipient.displayName || recipient.email?.split('@')[0],
            message: newMessage.trim()
        });

        setNewMessage('');
        setIsComposing(false);
    };

    const formatTime = (timestamp) => {
        if (!timestamp) return '';
        try {
            const date = new Date(timestamp);
            const now = new Date();
            const isToday = date.toDateString() === now.toDateString();
            if (isToday) {
                return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }
            return date.toLocaleDateString([], { month: 'short', day: 'numeric' }) + ' ' + 
                   date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        } catch { return ''; }
    };

    // Message status ticks component
    const MessageTicks = ({ msg, isOwn }) => {
        if (!isOwn) return null;
        
        const status = msg.status || 'sent';
        const hasBeenRead = msg.readBy && Object.keys(msg.readBy).length > 1;
        const hasBeenDelivered = msg.deliveredTo && Object.keys(msg.deliveredTo).length > 1;
        
        let tickColor = '#94a3b8'; // gray for sent
        let tickCount = 1;
        
        if (hasBeenRead) {
            tickColor = '#3b82f6'; // blue for read
            tickCount = 2;
        } else if (hasBeenDelivered || status === 'delivered') {
            tickColor = '#94a3b8'; // gray double tick for delivered
            tickCount = 2;
        }
        
        return (
            <span style={{ marginLeft: '6px', display: 'inline-flex', alignItems: 'center' }}>
                {tickCount === 2 ? (
                    <svg width="16" height="12" viewBox="0 0 16 12" fill="none">
                        <path d="M1 6l3 3 5-6" stroke={tickColor} strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"/>
                        <path d="M6 6l3 3 5-6" stroke={tickColor} strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"/>
                    </svg>
                ) : (
                    <svg width="12" height="12" viewBox="0 0 12 12" fill="none">
                        <path d="M2 6l3 3 5-6" stroke={tickColor} strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"/>
                    </svg>
                )}
            </span>
        );
    };

    const unreadCount = messages.filter(m => 
        m.senderId !== currentUserId && (!m.readBy || !m.readBy[currentUserId])
    ).length;

    if (!isOpen) return null;

    return (
        <>
            <div className="dropdown-overlay" onClick={onClose}></div>
            <div className="dropdown team-chat-dropdown" style={{ 
                width: '400px', 
                maxHeight: '550px',
                borderRadius: '0',
                display: 'flex',
                flexDirection: 'column'
            }}>
                {/* Header */}
                <div style={{ 
                    padding: '14px 16px', 
                    borderBottom: '1px solid var(--border-color)',
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center',
                    flexShrink: 0
                }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                        <h3 style={{ margin: 0, fontSize: '16px', fontWeight: '600' }}>Team Chat</h3>
                        {unreadCount > 0 && (
                            <span style={{ 
                                fontSize: '11px', 
                                padding: '2px 8px', 
                                background: '#3b82f6',
                                color: 'white',
                                borderRadius: '10px',
                                fontWeight: '600'
                            }}>
                                {unreadCount} new
                            </span>
                        )}
                    </div>
                    <div style={{ display: 'flex', gap: '8px' }}>
                        {messages.length > 0 && (
                            <button 
                                onClick={() => setShowClearConfirm(true)}
                                style={{
                                    background: 'transparent',
                                    border: 'none',
                                    color: '#ef4444',
                                    padding: '6px 10px',
                                    borderRadius: '6px',
                                    fontSize: '12px',
                                    fontWeight: '500',
                                    cursor: 'pointer',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '4px'
                                }}
                                title="Clear all chats"
                            >
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                    <polyline points="3 6 5 6 21 6"/>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                </svg>
                                Clear
                            </button>
                        )}
                        <button 
                            onClick={() => setIsComposing(!isComposing)}
                            style={{
                                background: isComposing ? 'var(--bg-secondary)' : '#3b82f6',
                                border: 'none',
                                color: isComposing ? 'var(--text-primary)' : 'white',
                                padding: '6px 12px',
                                borderRadius: '6px',
                                fontSize: '12px',
                                fontWeight: '600',
                                cursor: 'pointer',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '6px'
                            }}
                        >
                            {isComposing ? '‚úï Cancel' : '+ New'}
                        </button>
                    </div>
                </div>

                {/* Compose Area */}
                {isComposing && (
                    <div style={{ 
                        padding: '12px 16px', 
                        borderBottom: '1px solid var(--border-color)',
                        background: 'var(--bg-secondary)',
                        flexShrink: 0
                    }}>
                        <div style={{ marginBottom: '10px' }}>
                            <label style={{ fontSize: '12px', fontWeight: '600', color: 'var(--text-secondary)', display: 'block', marginBottom: '6px' }}>
                                Send to:
                            </label>
                            <select 
                                value={selectedRecipient} 
                                onChange={(e) => setSelectedRecipient(e.target.value)}
                                style={{
                                    width: '100%',
                                    padding: '8px 10px',
                                    border: '1px solid var(--border-color)',
                                    borderRadius: '6px',
                                    background: 'var(--bg-primary)',
                                    color: 'var(--text-primary)',
                                    fontSize: '13px'
                                }}
                            >
                                <option value="all">üì¢ All Users (Broadcast)</option>
                                {usersList.map(user => (
                                    <option key={user.id} value={user.id}>
                                        üë§ {user.name || user.displayName || user.email?.split('@')[0]} ({user.role || 'User'})
                                    </option>
                                ))}
                            </select>
                        </div>
                        <div style={{ display: 'flex', gap: '8px', position: 'relative' }}>
                            <div style={{ flex: 1, position: 'relative' }}>
                                <textarea
                                    value={newMessage}
                                    onChange={(e) => setNewMessage(e.target.value)}
                                    onKeyDown={(e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSendMessage(); }}}
                                    placeholder="Type your message..."
                                    style={{
                                        width: '100%',
                                        padding: '10px 40px 10px 10px',
                                        border: '1px solid var(--border-color)',
                                        borderRadius: '6px',
                                        background: 'var(--bg-primary)',
                                        color: 'var(--text-primary)',
                                        fontSize: '13px',
                                        resize: 'none',
                                        minHeight: '60px',
                                        fontFamily: 'inherit',
                                        boxSizing: 'border-box'
                                    }}
                                />
                                {/* Emoji Button */}
                                <button
                                    type="button"
                                    onClick={() => setShowEmojiPicker(!showEmojiPicker)}
                                    style={{
                                        position: 'absolute',
                                        right: '8px',
                                        bottom: '8px',
                                        background: 'transparent',
                                        border: 'none',
                                        cursor: 'pointer',
                                        fontSize: '18px',
                                        padding: '4px',
                                        borderRadius: '4px',
                                        opacity: 0.7,
                                        transition: 'opacity 0.2s'
                                    }}
                                    onMouseEnter={(e) => e.target.style.opacity = 1}
                                    onMouseLeave={(e) => e.target.style.opacity = 0.7}
                                    title="Add emoji"
                                >
                                    üòä
                                </button>
                                {/* Emoji Picker */}
                                {showEmojiPicker && (
                                    <div style={{
                                        position: 'absolute',
                                        bottom: '100%',
                                        right: '0',
                                        marginBottom: '8px',
                                        background: 'var(--bg-primary)',
                                        border: '1px solid var(--border-color)',
                                        borderRadius: '12px',
                                        padding: '12px',
                                        boxShadow: '0 4px 20px rgba(0, 0, 0, 0.15)',
                                        zIndex: 100,
                                        width: '220px'
                                    }}>
                                        <div style={{ 
                                            fontSize: '11px', 
                                            fontWeight: '600', 
                                            color: 'var(--text-secondary)', 
                                            marginBottom: '8px',
                                            display: 'flex',
                                            justifyContent: 'space-between',
                                            alignItems: 'center'
                                        }}>
                                            <span>Quick Emojis</span>
                                            <button 
                                                onClick={() => setShowEmojiPicker(false)}
                                                style={{ background: 'none', border: 'none', cursor: 'pointer', fontSize: '14px', color: 'var(--text-secondary)' }}
                                            >‚úï</button>
                                        </div>
                                        <div style={{ 
                                            display: 'grid', 
                                            gridTemplateColumns: 'repeat(6, 1fr)', 
                                            gap: '4px' 
                                        }}>
                                            {emojiList.map((emoji, idx) => (
                                                <button
                                                    key={idx}
                                                    onClick={() => insertEmoji(emoji)}
                                                    style={{
                                                        background: 'transparent',
                                                        border: 'none',
                                                        fontSize: '20px',
                                                        cursor: 'pointer',
                                                        padding: '6px',
                                                        borderRadius: '6px',
                                                        transition: 'background 0.2s'
                                                    }}
                                                    onMouseEnter={(e) => e.target.style.background = 'var(--bg-secondary)'}
                                                    onMouseLeave={(e) => e.target.style.background = 'transparent'}
                                                >
                                                    {emoji}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                            <button
                                onClick={handleSendMessage}
                                disabled={!newMessage.trim()}
                                style={{
                                    background: newMessage.trim() ? '#3b82f6' : 'var(--border-color)',
                                    border: 'none',
                                    color: 'white',
                                    padding: '0 16px',
                                    borderRadius: '6px',
                                    cursor: newMessage.trim() ? 'pointer' : 'not-allowed',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center'
                                }}
                            >
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                    <line x1="22" y1="2" x2="11" y2="13"/>
                                    <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                )}

                {/* Messages List */}
                <div 
                    ref={chatContainerRef}
                    style={{ 
                        flex: 1,
                        overflowY: 'auto',
                        padding: '12px 16px',
                        display: 'flex',
                        flexDirection: 'column',
                        gap: '12px',
                        minHeight: '200px',
                        maxHeight: '350px'
                    }}
                >
                    {messages.length === 0 ? (
                        <div style={{ 
                            flex: 1, 
                            display: 'flex', 
                            flexDirection: 'column',
                            alignItems: 'center', 
                            justifyContent: 'center',
                            color: 'var(--text-secondary)',
                            gap: '12px',
                            padding: '40px 0'
                        }}>
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" style={{ opacity: 0.5 }}>
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                            </svg>
                            <p style={{ margin: 0, fontSize: '14px' }}>No messages yet</p>
                            <p style={{ margin: 0, fontSize: '12px', opacity: 0.7 }}>Start a conversation with your team</p>
                        </div>
                    ) : (
                        messages.map((msg) => {
                            const isOwn = msg.senderId === currentUserId;
                            const isBroadcast = msg.type === 'broadcast' || msg.recipientId === 'all';
                            return (
                                <div 
                                    key={msg.id}
                                    style={{
                                        display: 'flex',
                                        flexDirection: 'column',
                                        alignItems: isOwn ? 'flex-end' : 'flex-start',
                                        maxWidth: '85%',
                                        alignSelf: isOwn ? 'flex-end' : 'flex-start'
                                    }}
                                >
                                    {/* Sender info - Show for ALL messages */}
                                    <div style={{ 
                                        fontSize: '11px', 
                                        color: 'var(--text-secondary)',
                                        marginBottom: '4px',
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '6px',
                                        flexDirection: isOwn ? 'row-reverse' : 'row'
                                    }}>
                                        <span style={{ fontWeight: '600', color: isOwn ? '#10b981' : '#3b82f6' }}>
                                            {isOwn ? 'You' : msg.senderName}
                                        </span>
                                        {isBroadcast && (
                                            <span style={{ 
                                                background: '#f59e0b20', 
                                                color: '#f59e0b', 
                                                padding: '1px 6px', 
                                                borderRadius: '4px',
                                                fontSize: '10px',
                                                fontWeight: '600'
                                            }}>
                                                üì¢ Broadcast
                                            </span>
                                        )}
                                        {!isBroadcast && !isOwn && (
                                            <span style={{ 
                                                background: '#3b82f620', 
                                                color: '#3b82f6', 
                                                padding: '1px 6px', 
                                                borderRadius: '4px',
                                                fontSize: '10px',
                                                fontWeight: '600'
                                            }}>
                                                Direct
                                            </span>
                                        )}
                                    </div>
                                    {/* Message bubble */}
                                    <div style={{
                                        background: isOwn 
                                            ? 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)' 
                                            : 'var(--bg-secondary)',
                                        color: isOwn ? 'white' : 'var(--text-primary)',
                                        padding: '10px 14px',
                                        borderRadius: isOwn ? '16px 16px 4px 16px' : '16px 16px 16px 4px',
                                        fontSize: '13px',
                                        lineHeight: '1.4',
                                        wordBreak: 'break-word',
                                        boxShadow: isOwn ? '0 2px 8px rgba(59, 130, 246, 0.3)' : 'none'
                                    }}>
                                        {msg.message}
                                    </div>
                                    {/* Time and ticks */}
                                    <div style={{ 
                                        fontSize: '10px', 
                                        color: 'var(--text-secondary)',
                                        marginTop: '4px',
                                        opacity: 0.7,
                                        display: 'flex',
                                        alignItems: 'center'
                                    }}>
                                        {formatTime(msg.timestamp)}
                                        <MessageTicks msg={msg} isOwn={isOwn} />
                                    </div>
                                </div>
                            );
                        })
                    )}
                    <div ref={messagesEndRef} />
                </div>

                {/* Quick Reply (when not composing) */}
                {!isComposing && messages.length > 0 && (
                    <div style={{ 
                        padding: '12px 16px', 
                        borderTop: '1px solid var(--border-color)',
                        display: 'flex',
                        gap: '8px',
                        flexShrink: 0,
                        position: 'relative'
                    }}>
                        <div style={{ flex: 1, position: 'relative' }}>
                            <input
                                type="text"
                                value={newMessage}
                                onChange={(e) => setNewMessage(e.target.value)}
                                onKeyDown={(e) => { if (e.key === 'Enter') handleSendMessage(); }}
                                placeholder="Quick reply to all..."
                                style={{
                                    width: '100%',
                                    padding: '10px 40px 10px 14px',
                                    border: '1px solid var(--border-color)',
                                    borderRadius: '20px',
                                    background: 'var(--bg-secondary)',
                                    color: 'var(--text-primary)',
                                    fontSize: '13px',
                                    outline: 'none',
                                    boxSizing: 'border-box'
                                }}
                                onFocus={() => setSelectedRecipient('all')}
                            />
                            {/* Emoji Button for Quick Reply */}
                            <button
                                type="button"
                                onClick={() => setShowEmojiPicker(!showEmojiPicker)}
                                style={{
                                    position: 'absolute',
                                    right: '10px',
                                    top: '50%',
                                    transform: 'translateY(-50%)',
                                    background: 'transparent',
                                    border: 'none',
                                    cursor: 'pointer',
                                    fontSize: '16px',
                                    padding: '2px',
                                    opacity: 0.6,
                                    transition: 'opacity 0.2s'
                                }}
                                onMouseEnter={(e) => e.target.style.opacity = 1}
                                onMouseLeave={(e) => e.target.style.opacity = 0.6}
                                title="Add emoji"
                            >
                                üòä
                            </button>
                            {/* Emoji Picker for Quick Reply */}
                            {showEmojiPicker && (
                                <div style={{
                                    position: 'absolute',
                                    bottom: '100%',
                                    right: '0',
                                    marginBottom: '8px',
                                    background: 'var(--bg-primary)',
                                    border: '1px solid var(--border-color)',
                                    borderRadius: '12px',
                                    padding: '12px',
                                    boxShadow: '0 4px 20px rgba(0, 0, 0, 0.15)',
                                    zIndex: 100,
                                    width: '220px'
                                }}>
                                    <div style={{ 
                                        fontSize: '11px', 
                                        fontWeight: '600', 
                                        color: 'var(--text-secondary)', 
                                        marginBottom: '8px',
                                        display: 'flex',
                                        justifyContent: 'space-between',
                                        alignItems: 'center'
                                    }}>
                                        <span>Quick Emojis</span>
                                        <button 
                                            onClick={() => setShowEmojiPicker(false)}
                                            style={{ background: 'none', border: 'none', cursor: 'pointer', fontSize: '14px', color: 'var(--text-secondary)' }}
                                        >‚úï</button>
                                    </div>
                                    <div style={{ 
                                        display: 'grid', 
                                        gridTemplateColumns: 'repeat(6, 1fr)', 
                                        gap: '4px' 
                                    }}>
                                        {emojiList.map((emoji, idx) => (
                                            <button
                                                key={idx}
                                                onClick={() => insertEmoji(emoji)}
                                                style={{
                                                    background: 'transparent',
                                                    border: 'none',
                                                    fontSize: '20px',
                                                    cursor: 'pointer',
                                                    padding: '6px',
                                                    borderRadius: '6px',
                                                    transition: 'background 0.2s'
                                                }}
                                                onMouseEnter={(e) => e.target.style.background = 'var(--bg-secondary)'}
                                                onMouseLeave={(e) => e.target.style.background = 'transparent'}
                                            >
                                                {emoji}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                        <button
                            onClick={handleSendMessage}
                            disabled={!newMessage.trim()}
                            style={{
                                width: '40px',
                                height: '40px',
                                background: newMessage.trim() ? '#3b82f6' : 'var(--bg-secondary)',
                                border: 'none',
                                borderRadius: '50%',
                                color: newMessage.trim() ? 'white' : 'var(--text-secondary)',
                                cursor: newMessage.trim() ? 'pointer' : 'not-allowed',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                flexShrink: 0
                            }}
                        >
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                <line x1="22" y1="2" x2="11" y2="13"/>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                            </svg>
                        </button>
                    </div>
                )}

                {/* Clear Chats Confirmation Modal */}
                {showClearConfirm && (
                    <div style={{
                        position: 'absolute',
                        inset: 0,
                        background: 'rgba(0, 0, 0, 0.5)',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        zIndex: 10,
                        backdropFilter: 'blur(4px)'
                    }}>
                        <div style={{
                            background: 'var(--bg-primary)',
                            borderRadius: '16px',
                            padding: '24px',
                            width: '320px',
                            boxShadow: '0 20px 50px rgba(0, 0, 0, 0.3)',
                            animation: 'modalSlideIn 0.2s ease-out'
                        }}>
                            {/* Icon */}
                            <div style={{
                                width: '56px',
                                height: '56px',
                                background: 'linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%)',
                                borderRadius: '50%',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                margin: '0 auto 16px'
                            }}>
                                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#ef4444" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                    <polyline points="3 6 5 6 21 6"/>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                    <line x1="10" y1="11" x2="10" y2="17"/>
                                    <line x1="14" y1="11" x2="14" y2="17"/>
                                </svg>
                            </div>

                            {/* Title */}
                            <h3 style={{
                                margin: '0 0 8px',
                                fontSize: '18px',
                                fontWeight: '700',
                                textAlign: 'center',
                                color: 'var(--text-primary)'
                            }}>
                                Clear All Chats?
                            </h3>

                            {/* Description */}
                            <p style={{
                                margin: '0 0 24px',
                                fontSize: '14px',
                                color: 'var(--text-secondary)',
                                textAlign: 'center',
                                lineHeight: '1.5'
                            }}>
                                This will permanently delete all messages for everyone. This action cannot be undone.
                            </p>

                            {/* Buttons */}
                            <div style={{ display: 'flex', gap: '12px' }}>
                                <button
                                    onClick={() => setShowClearConfirm(false)}
                                    disabled={isClearing}
                                    style={{
                                        flex: 1,
                                        padding: '12px 16px',
                                        background: 'var(--bg-secondary)',
                                        border: '1px solid var(--border-color)',
                                        borderRadius: '10px',
                                        color: 'var(--text-primary)',
                                        fontSize: '14px',
                                        fontWeight: '600',
                                        cursor: 'pointer',
                                        transition: 'all 0.2s'
                                    }}
                                >
                                    Cancel
                                </button>
                                <button
                                    onClick={handleClearAllChats}
                                    disabled={isClearing}
                                    style={{
                                        flex: 1,
                                        padding: '12px 16px',
                                        background: isClearing ? '#f87171' : 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)',
                                        border: 'none',
                                        borderRadius: '10px',
                                        color: 'white',
                                        fontSize: '14px',
                                        fontWeight: '600',
                                        cursor: isClearing ? 'not-allowed' : 'pointer',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        gap: '8px',
                                        boxShadow: '0 4px 12px rgba(239, 68, 68, 0.3)',
                                        transition: 'all 0.2s'
                                    }}
                                >
                                    {isClearing ? (
                                        <>
                                            <svg width="16" height="16" viewBox="0 0 24 24" style={{ animation: 'spin 1s linear infinite' }}>
                                                <circle cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="3" fill="none" strokeDasharray="31.4 31.4" strokeLinecap="round"/>
                                            </svg>
                                            Clearing...
                                        </>
                                    ) : (
                                        <>
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                                <polyline points="3 6 5 6 21 6"/>
                                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/>
                                            </svg>
                                            Clear All
                                        </>
                                    )}
                                </button>
                            </div>
                        </div>
                    </div>
                )}
            </div>
        </>
    );
}

// Team Chat Unread Badge Hook with notification
function useTeamChatUnread(userId) {
    const [unreadCount, setUnreadCount] = useState(0);
    const [hasNewMessage, setHasNewMessage] = useState(false);
    const prevCountRef = React.useRef(0);
    const audioContextRef = React.useRef(null);
    
    // Play notification sound for new messages
    const playNotificationSound = () => {
        try {
            if (!audioContextRef.current) {
                audioContextRef.current = new (window.AudioContext || window.webkitAudioContext)();
            }
            const ctx = audioContextRef.current;
            const oscillator = ctx.createOscillator();
            const gainNode = ctx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(ctx.destination);
            // Two-tone notification
            oscillator.frequency.setValueAtTime(523, ctx.currentTime); // C5
            oscillator.frequency.setValueAtTime(659, ctx.currentTime + 0.1); // E5
            oscillator.frequency.setValueAtTime(784, ctx.currentTime + 0.2); // G5
            gainNode.gain.setValueAtTime(0.15, ctx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.4);
            oscillator.start(ctx.currentTime);
            oscillator.stop(ctx.currentTime + 0.4);
        } catch (e) { console.log('Notification sound not supported'); }
    };
    
    useEffect(() => {
        if (!userId) return;
        let unsub = null;
        const init = async () => {
            const svc = window.FirebaseServices;
            if (!svc?.teamChatService) return;
            unsub = svc.teamChatService.subscribeToMessages(userId, (msgs) => {
                const unread = msgs.filter(m => 
                    m.senderId !== userId && (!m.readBy || !m.readBy[userId])
                ).length;
                
                // Check if there's a new message
                if (unread > prevCountRef.current) {
                    setHasNewMessage(true);
                    playNotificationSound();
                    // Reset animation after 3 seconds
                    setTimeout(() => setHasNewMessage(false), 3000);
                }
                
                prevCountRef.current = unread;
                setUnreadCount(unread);
            });
        };
        init();
        return () => { if (unsub) unsub(); };
    }, [userId]);
    
    return { unreadCount, hasNewMessage };
}

// Profile Dropdown Component
function ProfileDropdown({ isOpen, onClose }) {
    if (!isOpen) return null;

    return (
        <>
            <div className="dropdown-overlay" onClick={onClose}></div>
            <div className="dropdown profile-dropdown">
                <div className="dropdown-content">
                    <a href="#" className="dropdown-menu-item">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                            <circle cx="12" cy="7" r="4"/>
                        </svg>
                        <span>My Profile</span>
                    </a>
                    <a href="#" className="dropdown-menu-item">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                            <circle cx="12" cy="12" r="3"/>
                            <path d="M12 1v6m0 6v6M4.2 4.2l4.2 4.2m5.6 5.6l4.2 4.2M1 12h6m6 0h6M4.2 19.8l4.2-4.2m5.6-5.6l4.2-4.2"/>
                        </svg>
                        <span>Settings</span>
                    </a>
                    <a href="#" className="dropdown-menu-item">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M12 16v-4"/>
                            <path d="M12 8h.01"/>
                        </svg>
                        <span>Help & Support</span>
                    </a>
                    <div className="dropdown-divider"></div>
                    <a href="#" className="dropdown-menu-item logout">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                            <polyline points="16 17 21 12 16 7"/>
                            <line x1="21" y1="12" x2="9" y2="12"/>
                        </svg>
                        <span>Logout</span>
                    </a>
                </div>
            </div>
        </>
    );
}

// Top Bar Component
function TopBar({ onToggleSidebar, onToggleTheme, isDarkMode, userProfile, onLogout, onModuleClick }) {
    const [notificationOpen, setNotificationOpen] = useState(false);
    const [chatOpen, setChatOpen] = useState(false);
    const [profileOpen, setProfileOpen] = useState(false);
    const [notifications, setNotifications] = useState([]);
    const [profilePhoto, setProfilePhoto] = useState(userProfile?.photoURL || null);
    const [readNotifications, setReadNotifications] = useState(() => {
        try {
            const saved = localStorage.getItem('ecospark_read_notifications');
            return saved ? JSON.parse(saved) : [];
        } catch { return []; }
    });
    
    // Listen for profile photo updates from Settings module
    useEffect(() => {
        const handlePhotoUpdate = (e) => {
            if (e.detail?.photoURL) {
                setProfilePhoto(e.detail.photoURL);
            }
        };
        window.addEventListener('userProfilePhotoUpdated', handlePhotoUpdate);
        return () => window.removeEventListener('userProfilePhotoUpdated', handlePhotoUpdate);
    }, []);
    
    // Sync with userProfile prop
    useEffect(() => {
        if (userProfile?.photoURL) {
            setProfilePhoto(userProfile.photoURL);
        }
    }, [userProfile?.photoURL]);

    // Team chat unread count with notification state
    const { unreadCount: chatUnreadCount, hasNewMessage: chatHasNewMessage } = useTeamChatUnread(userProfile?.id || userProfile?.uid || 'user');

    // Real-time notification subscriptions
    useEffect(() => {
        const unsubs = [];
        let allNotifications = [];

        const updateNotifications = (type, items) => {
            // Remove old notifications of this type
            allNotifications = allNotifications.filter(n => !n.id.startsWith(type));
            // Add new ones
            allNotifications = [...allNotifications, ...items];
            // Sort by timestamp
            allNotifications.sort((a, b) => {
                try {
                    const dateA = a.timestamp?.toDate ? a.timestamp.toDate() : new Date(a.timestamp || 0);
                    const dateB = b.timestamp?.toDate ? b.timestamp.toDate() : new Date(b.timestamp || 0);
                    return dateB - dateA;
                } catch { return 0; }
            });
            // Limit to 50 and update state
            setNotifications([...allNotifications.slice(0, 50)]);
        };

        const initSubscriptions = async () => {
            let svc = window.FirebaseServices;
            let attempts = 0;
            while (!svc && attempts < 30) {
                await new Promise(r => setTimeout(r, 100));
                svc = window.FirebaseServices;
                attempts++;
            }
            if (!svc) return;

            // Subscribe to inventory for low stock alerts
            if (svc.inventoryService?.subscribeToItems) {
                unsubs.push(svc.inventoryService.subscribeToItems((items) => {
                    const alerts = [];
                    items.filter(i => (i.quantity || 0) <= (i.minStock || i.reorderLevel || 5)).forEach(i => {
                        const isOutOfStock = (i.quantity || 0) === 0;
                        alerts.push({
                            id: `inventory-${i.id}`,
                            type: 'alert',
                            icon: isOutOfStock ? 'üö´' : '‚ö†Ô∏è',
                            title: isOutOfStock ? `Out of Stock: ${i.name}` : `Low Stock: ${i.name}`,
                            subtitle: `${i.quantity || 0} ${i.unit || 'units'} remaining`,
                            timestamp: i.updatedAt || new Date().toISOString(),
                            module: 'inventory',
                            color: '#ef4444',
                            priority: isOutOfStock ? 'high' : 'medium'
                        });
                    });
                    updateNotifications('inventory-', alerts);
                }));
            }

            // Subscribe to billing for pending payments
            if (svc.billingService?.subscribeToInvoices) {
                unsubs.push(svc.billingService.subscribeToInvoices((invoices) => {
                    const alerts = [];
                    const today = new Date().toISOString().split('T')[0];
                    const pendingInvoices = invoices.filter(i => i.paymentStatus === 'pending' || i.paymentStatus === 'partial' || i.paymentStatus === 'unpaid' || !i.paymentStatus);
                    const todaysPendingInvoices = pendingInvoices.filter(i => i.createdAt?.startsWith(today));
                    
                    // Add individual pending invoice notifications for today
                    todaysPendingInvoices.slice(0, 5).forEach(inv => {
                        alerts.push({
                            id: `billing-pending-${inv.id}`,
                            type: 'payment',
                            icon: '‚è≥',
                            title: `${inv.plateNumber || 'Vehicle'} - Pending Payment`,
                            subtitle: `${inv.customerName || 'Walk-in'} ‚Ä¢ ${getBrandingForReceipts().currencySymbol || 'KES'} ${(inv.totalAmount || inv.total || 0).toLocaleString()}`,
                            timestamp: inv.createdAt || new Date().toISOString(),
                            module: 'billing',
                            color: '#ef4444',
                            priority: 'high'
                        });
                    });
                    
                    // Summary notification if there are more pending
                    if (todaysPendingInvoices.length > 5) {
                        const totalPending = todaysPendingInvoices.reduce((sum, i) => sum + (i.totalAmount || i.total || 0), 0);
                        alerts.push({
                            id: 'billing-pending-summary',
                            type: 'payment',
                            icon: 'üí∞',
                            title: `${todaysPendingInvoices.length} Pending Payments Today`,
                            subtitle: `Total: ${getBrandingForReceipts().currencySymbol || 'KES'} ${totalPending.toLocaleString()}`,
                            timestamp: new Date().toISOString(),
                            module: 'billing',
                            color: '#f59e0b'
                        });
                    }
                    // Also add recent paid invoices as notifications
                    const todayDate = new Date().toISOString().split('T')[0];
                    const todaysPaidInvoices = invoices.filter(i => i.paymentStatus === 'paid' && (i.paidAt?.startsWith(todayDate) || i.updatedAt?.startsWith(todayDate) || i.createdAt?.startsWith(todayDate)));
                    todaysPaidInvoices.slice(0, 5).forEach(inv => {
                        const serviceInfo = inv.services?.map(s => s.name || s.service).join(', ') || inv.source || 'Service';
                        alerts.push({
                            id: `billing-paid-${inv.id}`,
                            type: 'success',
                            icon: '‚úÖ',
                            title: `${inv.plateNumber || 'Vehicle'} - Payment Received`,
                            subtitle: `${inv.customerName || 'Walk-in'} ‚Ä¢ ${serviceInfo} ‚Ä¢ ${getBrandingForReceipts().currencySymbol || 'KES'} ${(inv.totalAmount || inv.total || 0).toLocaleString()}`,
                            timestamp: inv.paidAt || inv.updatedAt || inv.createdAt,
                            module: 'billing',
                            color: '#10b981'
                        });
                    });
                    updateNotifications('billing-', alerts);
                }));
            }

            // Subscribe to equipment for maintenance alerts
            if (svc.equipmentService?.subscribeToEquipment) {
                unsubs.push(svc.equipmentService.subscribeToEquipment((equipment) => {
                    const alerts = [];
                    equipment.filter(e => e.status === 'maintenance' || e.status === 'repair').forEach(eq => {
                        alerts.push({
                            id: `equipment-${eq.id}`,
                            type: 'maintenance',
                            icon: 'üîß',
                            title: `${eq.name} under ${eq.status}`,
                            subtitle: eq.notes || 'Requires attention',
                            timestamp: eq.lastMaintenance || eq.updatedAt || new Date().toISOString(),
                            module: 'equipment',
                            color: '#8b5cf6'
                        });
                    });
                    updateNotifications('equipment-', alerts);
                }));
            }

            // Subscribe to intake queue
            if (svc.intakeQueueService?.subscribeToQueue) {
                unsubs.push(svc.intakeQueueService.subscribeToQueue((queue) => {
                    const alerts = [];
                    if (queue.length > 0) {
                        alerts.push({
                            id: 'queue-count',
                            type: 'queue',
                            icon: 'üöó',
                            title: `${queue.length} vehicle${queue.length > 1 ? 's' : ''} in queue`,
                            subtitle: 'Waiting for service',
                            timestamp: new Date().toISOString(),
                            module: 'vehicle-intake',
                            color: '#10b981'
                        });
                        // Add individual vehicle alerts for new arrivals
                        queue.slice(0, 3).forEach(v => {
                            alerts.push({
                                id: `queue-${v.id}`,
                                type: 'arrival',
                                icon: 'üöô',
                                title: `New Arrival: ${v.plateNumber || v.vehicleNumber || 'Vehicle'}`,
                                subtitle: v.customerName || v.service || 'Awaiting assignment',
                                timestamp: v.createdAt || v.arrivalTime || new Date().toISOString(),
                                module: 'vehicle-intake',
                                color: '#3b82f6'
                            });
                        });
                    }
                    updateNotifications('queue-', alerts);
                }));
            }

            // Subscribe to activities
            if (svc.activityService?.subscribeToActivities) {
                unsubs.push(svc.activityService.subscribeToActivities((activities) => {
                    const alerts = activities.slice(0, 10).map(a => ({
                        id: `activity-${a.id}`,
                        type: 'activity',
                        icon: a.type === 'intake' ? 'üöó' : a.type === 'billing' ? 'üí≥' : a.type === 'wash' ? 'üöø' : a.type === 'garage' ? 'üîß' : a.type === 'complaint' ? '‚ö†Ô∏è' : 'üìã',
                        title: a.description || a.action || 'Activity',
                        subtitle: a.user || a.loggedBy || 'System',
                        timestamp: a.timestamp || a.createdAt,
                        module: a.type === 'intake' ? 'vehicle-intake' : a.type === 'billing' ? 'billing' : a.type === 'wash' ? 'wash-bays' : a.type === 'garage' ? 'garage' : a.type === 'complaint' ? 'customers' : 'activities',
                        color: a.type === 'complaint' ? (a.status === 'success' ? '#10b981' : '#ef4444') : '#3b82f6'
                    }));
                    updateNotifications('activity-', alerts);
                }));
            }

            // Subscribe to garage jobs
            if (svc.garageService?.subscribeToActiveJobs) {
                unsubs.push(svc.garageService.subscribeToActiveJobs((jobs) => {
                    const alerts = [];
                    jobs.filter(j => j.status === 'in-progress' || j.status === 'pending').slice(0, 5).forEach(job => {
                        alerts.push({
                            id: `garage-${job.id}`,
                            type: 'job',
                            icon: 'üîß',
                            title: `Garage: ${job.vehiclePlate || job.plateNumber || 'Vehicle'}`,
                            subtitle: job.services?.join(', ') || job.description || job.status,
                            timestamp: job.createdAt || job.startTime,
                            module: 'garage',
                            color: '#f59e0b'
                        });
                    });
                    updateNotifications('garage-', alerts);
                }));
            }

            // Subscribe to complaints for responses
            if (svc.complaintsService?.subscribeToComplaints) {
                unsubs.push(svc.complaintsService.subscribeToComplaints((complaints) => {
                    const alerts = [];
                    // Show resolved complaints notifications
                    complaints.filter(c => c.status === 'resolved' || c.status === 'completed').forEach(complaint => {
                        alerts.push({
                            id: `complaint-resolved-${complaint.id}`,
                            type: 'complaint',
                            icon: '‚úÖ',
                            title: `Complaint Resolved: #${complaint.complaintNumber || complaint.id?.slice(0,8) || 'N/A'}`,
                            subtitle: `${complaint.customerName || 'Customer'} - ${complaint.complaintType || 'Complaint'}${complaint.resolution ? ': ' + complaint.resolution.substring(0, 40) + (complaint.resolution.length > 40 ? '...' : '') : ''}`,
                            timestamp: complaint.resolvedAt || complaint.updatedAt,
                            module: 'customers',
                            color: '#22c55e',
                            priority: 'high'
                        });
                    });
                    // Show open complaints notifications
                    complaints.filter(c => c.status === 'open' || c.status === 'in-progress').forEach(complaint => {
                        alerts.push({
                            id: `complaint-open-${complaint.id}`,
                            type: 'complaint',
                            icon: '‚ö†Ô∏è',
                            title: `Your complaint #${complaint.complaintNumber || complaint.id?.slice(0,8) || 'N/A'} has been received`,
                            subtitle: `${complaint.complaintType || 'Complaint'} - ${complaint.priority || 'normal'} priority`,
                            timestamp: complaint.createdAt || complaint.updatedAt,
                            module: 'customers',
                            color: complaint.priority === 'urgent' ? '#dc2626' : '#f59e0b'
                        });
                    });
                    updateNotifications('complaint-', alerts);
                }));
            }
        };

        initSubscriptions();
        return () => unsubs.forEach(unsub => unsub && unsub());
    }, []);

    // Add isRead status to notifications
    const notificationsWithReadStatus = notifications.map(n => ({
        ...n,
        isRead: readNotifications.includes(n.id)
    }));

    const unreadCount = notificationsWithReadStatus.filter(n => !n.isRead).length;

    const handleMarkAsRead = (notifId) => {
        if (!readNotifications.includes(notifId)) {
            const newRead = [...readNotifications, notifId];
            setReadNotifications(newRead);
            try {
                localStorage.setItem('ecospark_read_notifications', JSON.stringify(newRead));
            } catch {}
        }
    };

    const handleMarkAllRead = () => {
        const allIds = notifications.map(n => n.id);
        setReadNotifications(allIds);
        try {
            localStorage.setItem('ecospark_read_notifications', JSON.stringify(allIds));
        } catch {}
    };

    const handleClearAll = () => {
        handleMarkAllRead();
    };

    const handleNotificationClick = () => {
        setNotificationOpen(!notificationOpen);
        setChatOpen(false);
        setProfileOpen(false);
    };

    const handleChatClick = () => {
        setChatOpen(!chatOpen);
        setNotificationOpen(false);
        setProfileOpen(false);
    };

    const handleProfileClick = () => {
        setProfileOpen(!profileOpen);
        setNotificationOpen(false);
        setChatOpen(false);
    };

    const handleLogoutClick = () => {
        setProfileOpen(false);
        if (onLogout) onLogout();
    };

    const handleSettingsClick = (tab) => {
        setProfileOpen(false);
        if (onModuleClick) {
            onModuleClick('settings', tab);
        }
    };

    return (
        <div className="topbar">
            <div className="topbar-left">
                <button className="topbar-button" onClick={onToggleSidebar} title="Toggle Sidebar">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                        <line x1="3" y1="6" x2="21" y2="6"/>
                        <line x1="3" y1="12" x2="21" y2="12"/>
                        <line x1="3" y1="18" x2="21" y2="18"/>
                    </svg>
                </button>
            </div>
            <div className="topbar-right">
                <div className="dropdown-container">
                    <button className="topbar-button" onClick={handleNotificationClick} title="Notifications" style={{ position: 'relative' }}>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                            <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                        </svg>
                        {unreadCount > 0 && (
                            <span style={{
                                position: 'absolute',
                                top: '2px',
                                right: '2px',
                                background: '#ef4444',
                                color: 'white',
                                fontSize: '10px',
                                fontWeight: '700',
                                minWidth: '16px',
                                height: '16px',
                                borderRadius: '8px',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                padding: '0 4px',
                                boxShadow: '0 2px 4px rgba(239, 68, 68, 0.3)'
                            }}>
                                {unreadCount > 9 ? '9+' : unreadCount}
                            </span>
                        )}
                    </button>
                    <NotificationDropdown 
                        isOpen={notificationOpen} 
                        onClose={() => setNotificationOpen(false)} 
                        onModuleClick={onModuleClick}
                        notifications={notificationsWithReadStatus}
                        unreadCount={unreadCount}
                        onMarkAsRead={handleMarkAsRead}
                        onMarkAllRead={handleMarkAllRead}
                        onClearAll={handleClearAll}
                    />
                </div>
                {/* Team Chat Button */}
                <div className="dropdown-container">
                    <button 
                        className="topbar-button" 
                        onClick={handleChatClick} 
                        title="Team Chat" 
                        style={{ 
                            position: 'relative',
                            animation: chatHasNewMessage ? 'shake 0.5s ease-in-out' : 'none'
                        }}
                    >
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke={chatHasNewMessage ? '#ef4444' : 'currentColor'} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                        </svg>
                        {chatUnreadCount > 0 && (
                            <span style={{
                                position: 'absolute',
                                top: '2px',
                                right: '2px',
                                background: '#ef4444',
                                color: 'white',
                                fontSize: '10px',
                                fontWeight: '700',
                                minWidth: '16px',
                                height: '16px',
                                borderRadius: '8px',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                padding: '0 4px',
                                boxShadow: '0 2px 4px rgba(239, 68, 68, 0.3)'
                            }}>
                                {chatUnreadCount > 9 ? '9+' : chatUnreadCount}
                            </span>
                        )}
                    </button>
                    <TeamChatDropdown 
                        isOpen={chatOpen} 
                        onClose={() => setChatOpen(false)} 
                        userProfile={userProfile}
                    />
                </div>
                <button className="topbar-button" onClick={onToggleTheme} title="Toggle Theme">
                    {isDarkMode ? (
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                            <circle cx="12" cy="12" r="5"/>
                            <line x1="12" y1="1" x2="12" y2="3"/>
                            <line x1="12" y1="21" x2="12" y2="23"/>
                            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                            <line x1="1" y1="12" x2="3" y2="12"/>
                            <line x1="21" y1="12" x2="23" y2="12"/>
                            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                        </svg>
                    ) : (
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    )}
                </button>
                {/* Divider */}
                <div style={{ width: '1px', height: '28px', backgroundColor: isDarkMode ? '#334155' : '#e2e8f0', margin: '0 8px' }}></div>
                
                {/* Profile Section */}
                <div className="dropdown-container">
                    <button 
                        onClick={handleProfileClick} 
                        title="Profile"
                        style={{
                            display: 'flex',
                            alignItems: 'center',
                            gap: '10px',
                            padding: '6px 12px 6px 6px',
                            background: profileOpen 
                                ? (isDarkMode ? '#334155' : '#f1f5f9') 
                                : 'transparent',
                            border: isDarkMode ? '1px solid transparent' : '1px solid transparent',
                            borderRadius: '0',
                            cursor: 'pointer'
                        }}
                        onMouseEnter={(e) => {
                            e.currentTarget.style.background = isDarkMode ? '#334155' : '#f1f5f9';
                            e.currentTarget.style.border = isDarkMode ? '1px solid #475569' : '1px solid #e2e8f0';
                        }}
                        onMouseLeave={(e) => {
                            e.currentTarget.style.background = profileOpen ? (isDarkMode ? '#334155' : '#f1f5f9') : 'transparent';
                            e.currentTarget.style.border = '1px solid transparent';
                        }}
                    >
                        {profilePhoto ? (
                            <img 
                                src={profilePhoto} 
                                alt="Profile" 
                                style={{
                                    width: '36px',
                                    height: '36px',
                                    borderRadius: '50%',
                                    objectFit: 'cover',
                                    border: '2px solid #3b82f6'
                                }}
                            />
                        ) : (
                            <div style={{
                                width: '36px',
                                height: '36px',
                                borderRadius: '50%',
                                background: 'linear-gradient(135deg, #3b82f6 0%, #1e40af 100%)',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                color: 'white',
                                fontSize: '14px',
                                fontWeight: '700',
                                letterSpacing: '0.5px'
                            }}>
                                {(userProfile?.displayName || userProfile?.email || 'U').charAt(0).toUpperCase()}
                            </div>
                        )}
                        <div style={{ textAlign: 'left', lineHeight: '1.3' }}>
                            <div style={{ 
                                fontSize: '13px', 
                                fontWeight: '600', 
                                color: isDarkMode ? '#f1f5f9' : '#1e293b',
                                maxWidth: '120px',
                                overflow: 'hidden',
                                textOverflow: 'ellipsis',
                                whiteSpace: 'nowrap'
                            }}>
                                {userProfile?.displayName || userProfile?.email?.split('@')[0] || 'User'}
                            </div>
                            <div style={{ 
                                fontSize: '11px', 
                                color: isDarkMode ? '#94a3b8' : '#64748b', 
                                textTransform: 'capitalize',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '5px'
                            }}>
                                <span style={{
                                    width: '7px',
                                    height: '7px',
                                    backgroundColor: '#22c55e',
                                    borderRadius: '50%',
                                    display: 'inline-block'
                                }}></span>
                                {userProfile?.role || 'User'}
                            </div>
                        </div>
                        <svg 
                            width="14" 
                            height="14" 
                            viewBox="0 0 24 24" 
                            fill="none" 
                            stroke={isDarkMode ? '#94a3b8' : '#64748b'}
                            strokeWidth="2.5" 
                            strokeLinecap="round" 
                            strokeLinejoin="round"
                            style={{
                                transform: profileOpen ? 'rotate(180deg)' : 'rotate(0deg)'
                            }}
                        >
                            <polyline points="6 9 12 15 18 9"/>
                        </svg>
                    </button>
                    
                    {profileOpen && (
                        <>
                            <div className="dropdown-overlay" onClick={() => setProfileOpen(false)}></div>
                            <div style={{
                                position: 'absolute',
                                top: 'calc(100% + 10px)',
                                right: '0',
                                width: '300px',
                                backgroundColor: isDarkMode ? '#1e293b' : 'white',
                                borderRadius: '0',
                                boxShadow: isDarkMode 
                                    ? '0 4px 12px rgba(0,0,0,0.4)' 
                                    : '0 4px 12px rgba(0,0,0,0.1)',
                                border: isDarkMode ? '1px solid #334155' : '1px solid #e2e8f0',
                                zIndex: 1000,
                                overflow: 'hidden'
                            }}>
                                {/* Profile Header */}
                                <div style={{ 
                                    padding: '24px 20px',
                                    background: isDarkMode ? '#1e3a5f' : '#3b82f6',
                                    position: 'relative'
                                }}>
                                    
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '16px', position: 'relative' }}>
                                        {profilePhoto ? (
                                            <img 
                                                src={profilePhoto} 
                                                alt="Profile" 
                                                style={{
                                                    width: '60px',
                                                    height: '60px',
                                                    borderRadius: '50%',
                                                    objectFit: 'cover',
                                                    border: '3px solid rgba(255,255,255,0.4)'
                                                }}
                                            />
                                        ) : (
                                            <div style={{
                                                width: '60px',
                                                height: '60px',
                                                borderRadius: '50%',
                                                backgroundColor: 'rgba(255,255,255,0.2)',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                fontSize: '24px',
                                                fontWeight: '700',
                                                color: 'white',
                                                border: '2px solid rgba(255,255,255,0.3)'
                                            }}>
                                                {(userProfile?.displayName || userProfile?.email || 'U').charAt(0).toUpperCase()}
                                            </div>
                                        )}
                                        <div style={{ flex: 1, minWidth: 0, color: 'white' }}>
                                            <div style={{ 
                                                fontWeight: '700', 
                                                fontSize: '16px',
                                                whiteSpace: 'nowrap',
                                                overflow: 'hidden',
                                                textOverflow: 'ellipsis',
                                                marginBottom: '4px'
                                            }}>
                                                {userProfile?.displayName || userProfile?.email?.split('@')[0] || 'User'}
                                            </div>
                                            <div style={{ 
                                                fontSize: '12px', 
                                                color: 'rgba(255,255,255,0.75)',
                                                whiteSpace: 'nowrap',
                                                overflow: 'hidden',
                                                textOverflow: 'ellipsis',
                                                marginBottom: '8px'
                                            }}>
                                                {userProfile?.email || ''}
                                            </div>
                                            <div style={{ 
                                                display: 'inline-flex',
                                                alignItems: 'center',
                                                gap: '6px',
                                                padding: '4px 10px',
                                                backgroundColor: 'rgba(255,255,255,0.2)',
                                                borderRadius: '0',
                                                fontSize: '11px',
                                                fontWeight: '600',
                                                textTransform: 'uppercase',
                                                letterSpacing: '0.5px'
                                            }}>
                                                <span style={{
                                                    width: '6px',
                                                    height: '6px',
                                                    borderRadius: '50%',
                                                    backgroundColor: '#22c55e'
                                                }}></span>
                                                {userProfile?.role || 'User'}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                {/* Quick Stats */}
                                <div style={{ 
                                    display: 'grid', 
                                    gridTemplateColumns: '1fr 1fr', 
                                    gap: '1px',
                                    background: isDarkMode ? '#334155' : '#e2e8f0',
                                    borderBottom: isDarkMode ? '1px solid #334155' : '1px solid #e2e8f0'
                                }}>
                                    <div style={{ 
                                        padding: '12px 16px', 
                                        background: isDarkMode ? '#1e293b' : 'white',
                                        textAlign: 'center'
                                    }}>
                                        <div style={{ fontSize: '18px', fontWeight: '700', color: '#3b82f6' }}>
                                            {new Date().toLocaleDateString('en-US', { weekday: 'short' })}
                                        </div>
                                        <div style={{ fontSize: '10px', color: isDarkMode ? '#64748b' : '#94a3b8', textTransform: 'uppercase' }}>
                                            Today
                                        </div>
                                    </div>
                                    <div style={{ 
                                        padding: '12px 16px', 
                                        background: isDarkMode ? '#1e293b' : 'white',
                                        textAlign: 'center'
                                    }}>
                                        <div style={{ fontSize: '18px', fontWeight: '700', color: '#10b981' }}>
                                            {new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true })}
                                        </div>
                                        <div style={{ fontSize: '10px', color: isDarkMode ? '#64748b' : '#94a3b8', textTransform: 'uppercase' }}>
                                            Current Time
                                        </div>
                                    </div>
                                </div>
                                
                                {/* Menu Items */}
                                <div style={{ padding: '8px' }}>
                                    <a 
                                        href="#" 
                                        onClick={(e) => { e.preventDefault(); handleSettingsClick('profile'); }}
                                        style={{
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '14px',
                                            padding: '12px 14px',
                                            color: isDarkMode ? '#e2e8f0' : '#475569',
                                            textDecoration: 'none',
                                            fontSize: '13px',
                                            fontWeight: '500',
                                            borderRadius: '0'
                                        }}
                                        onMouseEnter={(e) => {
                                            e.currentTarget.style.backgroundColor = isDarkMode ? '#334155' : '#f1f5f9';
                                        }}
                                        onMouseLeave={(e) => {
                                            e.currentTarget.style.backgroundColor = 'transparent';
                                        }}
                                    >
                                        <div style={{
                                            width: '36px',
                                            height: '36px',
                                            borderRadius: '0',
                                            background: isDarkMode ? '#334155' : '#eff6ff',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center'
                                        }}>
                                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                                <circle cx="12" cy="7" r="4"/>
                                            </svg>
                                        </div>
                                        <div>
                                            <div style={{ fontWeight: '600' }}>My Profile</div>
                                            <div style={{ fontSize: '11px', color: isDarkMode ? '#64748b' : '#94a3b8', marginTop: '2px' }}>View and edit profile</div>
                                        </div>
                                    </a>
                                    
                                    <a 
                                        href="#" 
                                        onClick={(e) => { e.preventDefault(); handleSettingsClick('account'); }}
                                        style={{
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '14px',
                                            padding: '12px 14px',
                                            color: isDarkMode ? '#e2e8f0' : '#475569',
                                            textDecoration: 'none',
                                            fontSize: '13px',
                                            fontWeight: '500',
                                            borderRadius: '0'
                                        }}
                                        onMouseEnter={(e) => {
                                            e.currentTarget.style.backgroundColor = isDarkMode ? '#334155' : '#f1f5f9';
                                        }}
                                        onMouseLeave={(e) => {
                                            e.currentTarget.style.backgroundColor = 'transparent';
                                        }}
                                    >
                                        <div style={{
                                            width: '36px',
                                            height: '36px',
                                            borderRadius: '0',
                                            background: isDarkMode ? '#334155' : '#f0fdf4',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center'
                                        }}>
                                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#10b981" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                                <circle cx="12" cy="12" r="3"/>
                                                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                                            </svg>
                                        </div>
                                        <div>
                                            <div style={{ fontWeight: '600' }}>Settings</div>
                                            <div style={{ fontSize: '11px', color: isDarkMode ? '#64748b' : '#94a3b8', marginTop: '2px' }}>Account & preferences</div>
                                        </div>
                                    </a>
                                    
                                    <a 
                                        href="#" 
                                        onClick={(e) => { e.preventDefault(); handleSettingsClick('support'); }}
                                        style={{
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '14px',
                                            padding: '12px 14px',
                                            color: isDarkMode ? '#e2e8f0' : '#475569',
                                            textDecoration: 'none',
                                            fontSize: '13px',
                                            fontWeight: '500',
                                            borderRadius: '0'
                                        }}
                                        onMouseEnter={(e) => {
                                            e.currentTarget.style.backgroundColor = isDarkMode ? '#334155' : '#f1f5f9';
                                        }}
                                        onMouseLeave={(e) => {
                                            e.currentTarget.style.backgroundColor = 'transparent';
                                        }}
                                    >
                                        <div style={{
                                            width: '36px',
                                            height: '36px',
                                            borderRadius: '0',
                                            background: isDarkMode ? '#334155' : '#faf5ff',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center'
                                        }}>
                                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#8b5cf6" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                                <circle cx="12" cy="12" r="10"/>
                                                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                                                <line x1="12" y1="17" x2="12.01" y2="17"/>
                                            </svg>
                                        </div>
                                        <div>
                                            <div style={{ fontWeight: '600' }}>Help & Support</div>
                                            <div style={{ fontSize: '11px', color: isDarkMode ? '#64748b' : '#94a3b8', marginTop: '2px' }}>Get assistance</div>
                                        </div>
                                    </a>
                                </div>
                                
                                {/* Theme Toggle */}
                                <div style={{ 
                                    padding: '8px', 
                                    borderTop: isDarkMode ? '1px solid #334155' : '1px solid #e2e8f0'
                                }}>
                                    <div 
                                        onClick={onToggleTheme}
                                        style={{
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'space-between',
                                            padding: '12px 14px',
                                            borderRadius: '0',
                                            cursor: 'pointer'
                                        }}
                                        onMouseEnter={(e) => e.currentTarget.style.backgroundColor = isDarkMode ? '#334155' : '#f1f5f9'}
                                        onMouseLeave={(e) => e.currentTarget.style.backgroundColor = 'transparent'}
                                    >
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '14px' }}>
                                            <div style={{
                                                width: '36px',
                                                height: '36px',
                                                borderRadius: '0',
                                                background: isDarkMode ? '#334155' : '#fef3c7',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center'
                                            }}>
                                                {isDarkMode ? (
                                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#fbbf24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                                        <circle cx="12" cy="12" r="5"/>
                                                        <line x1="12" y1="1" x2="12" y2="3"/>
                                                        <line x1="12" y1="21" x2="12" y2="23"/>
                                                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                                                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                                                        <line x1="1" y1="12" x2="3" y2="12"/>
                                                        <line x1="21" y1="12" x2="23" y2="12"/>
                                                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                                                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                                                    </svg>
                                                ) : (
                                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#6366f1" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                                                    </svg>
                                                )}
                                            </div>
                                            <div>
                                                <div style={{ fontWeight: '600', color: isDarkMode ? '#e2e8f0' : '#475569', fontSize: '13px' }}>
                                                    {isDarkMode ? 'Light Mode' : 'Dark Mode'}
                                                </div>
                                                <div style={{ fontSize: '11px', color: isDarkMode ? '#64748b' : '#94a3b8', marginTop: '2px' }}>
                                                    Switch to {isDarkMode ? 'light' : 'dark'} theme
                                                </div>
                                            </div>
                                        </div>
                                        <div style={{
                                            width: '44px',
                                            height: '24px',
                                            borderRadius: '0',
                                            background: isDarkMode ? '#3b82f6' : '#e2e8f0',
                                            position: 'relative'
                                        }}>
                                            <div style={{
                                                width: '20px',
                                                height: '20px',
                                                borderRadius: '0',
                                                background: 'white',
                                                position: 'absolute',
                                                top: '2px',
                                                left: isDarkMode ? '22px' : '2px'
                                            }}></div>
                                        </div>
                                    </div>
                                </div>
                                
                                {/* Sign Out */}
                                <div style={{ 
                                    padding: '8px', 
                                    borderTop: isDarkMode ? '1px solid #334155' : '1px solid #e2e8f0'
                                }}>
                                    <a 
                                        href="#" 
                                        onClick={(e) => { e.preventDefault(); handleLogoutClick(); }}
                                        style={{
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '14px',
                                            padding: '12px 14px',
                                            color: '#ef4444',
                                            textDecoration: 'none',
                                            fontSize: '13px',
                                            fontWeight: '600',
                                            borderRadius: '0'
                                        }}
                                        onMouseEnter={(e) => {
                                            e.currentTarget.style.backgroundColor = isDarkMode ? 'rgba(239,68,68,0.1)' : '#fef2f2';
                                        }}
                                        onMouseLeave={(e) => {
                                            e.currentTarget.style.backgroundColor = 'transparent';
                                        }}
                                    >
                                        <div style={{
                                            width: '36px',
                                            height: '36px',
                                            borderRadius: '0',
                                            background: isDarkMode ? 'rgba(239,68,68,0.15)' : '#fef2f2',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center'
                                        }}>
                                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#ef4444" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                                                <polyline points="16 17 21 12 16 7"/>
                                                <line x1="21" y1="12" x2="9" y2="12"/>
                                            </svg>
                                        </div>
                                        <div>
                                            <div>Sign Out</div>
                                            <div style={{ fontSize: '11px', color: isDarkMode ? '#94a3b8' : '#f87171', fontWeight: '400', marginTop: '2px' }}>
                                                End your session
                                            </div>
                                        </div>
                                    </a>
                                </div>
                            </div>
                        </>
                    )}
                </div>
            </div>
        </div>
    );
}

// Generate unique ID
const generateId = () => Math.random().toString(36).substr(2, 9);

// Format time elapsed
const formatTimeElapsed = (dateString) => {
    if (!dateString) return '-';
    const date = typeof dateString === 'string' ? new Date(dateString) : dateString;
    const now = new Date();
    const diff = Math.floor((now - date) / 1000 / 60);
    if (diff < 1) return 'Just now';
    if (diff < 60) return `${diff}m ago`;
    const hours = Math.floor(diff / 60);
    if (hours < 24) return `${hours}h ${diff % 60}m`;
    return `${Math.floor(hours / 24)}d ago`;
};

// Format time for display
const formatTime = (dateString) => {
    if (!dateString) return '-';
    const date = typeof dateString === 'string' ? new Date(dateString) : dateString;
    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
};

// Service types
const SERVICE_TYPES = [
    { id: 'basic', name: 'Basic Wash', price: 500 },
    { id: 'standard', name: 'Standard Wash', price: 800 },
    { id: 'premium', name: 'Premium Wash', price: 1200 },
    { id: 'full-detail', name: 'Full Detail', price: 2500 },
    { id: 'interior-only', name: 'Interior Only', price: 600 },
    { id: 'exterior-only', name: 'Exterior Only', price: 400 }
];

// Intake categories and item types
const INTAKE_CATEGORIES = [
    { id: 'vehicle', label: 'Vehicle', icon: 'üöó' },
    { id: 'motorbike', label: 'Motorbike', icon: 'üèçÔ∏è' },
    { id: 'bicycle', label: 'Bicycle', icon: 'üö≤' },
    { id: 'carpet', label: 'Carpet', icon: 'üßπ' },
    { id: 'other', label: 'Other', icon: 'üì¶' }
];

const ITEM_TYPES = {
    vehicle: ['Sedan', 'SUV', 'Truck', 'Van', 'Bus', 'Pickup'],
    motorbike: ['Sport Bike', 'Cruiser', 'Scooter', 'Off-road', 'Standard'],
    bicycle: ['Mountain Bike', 'Road Bike', 'BMX', 'Electric Bike', 'Standard'],
    carpet: ['Small (< 2m)', 'Medium (2-4m)', 'Large (4-6m)', 'Extra Large (> 6m)'],
    other: ['Boat Cover', 'Car Seat', 'Floor Mats', 'Custom Item']
};

// Legacy support
const VEHICLE_TYPES = ['Sedan', 'SUV', 'Truck', 'Van', 'Motorcycle', 'Bus'];

// Default bays (fallback if Firebase not initialized)
const DEFAULT_BAYS = [
    { id: 'bay-1', name: 'Bay 1', status: 'available', currentVehicle: null },
    { id: 'bay-2', name: 'Bay 2', status: 'available', currentVehicle: null },
    { id: 'bay-3', name: 'Bay 3', status: 'available', currentVehicle: null },
    { id: 'bay-4', name: 'Bay 4', status: 'available', currentVehicle: null }
];

// Vehicle Intake Module Component - Firebase Integrated
function VehicleIntake() {
    const { canCreate, canEdit, canDelete, hasPermission } = usePermissions();
    const canChangeStatus = hasPermission('vehicle-intake', 'change-status');
    
    // Dark mode detection
    const [isDark, setIsDark] = useState(document.documentElement.getAttribute('data-theme') === 'dark');
    
    // Listen for theme changes
    useEffect(() => {
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.attributeName === 'data-theme') {
                    setIsDark(document.documentElement.getAttribute('data-theme') === 'dark');
                }
            });
        });
        observer.observe(document.documentElement, { attributes: true, attributeFilter: ['data-theme'] });
        return () => observer.disconnect();
    }, []);
    
    // State management
    const [queue, setQueue] = useState([]);
    const [vehicles, setVehicles] = useState([]);
    const [bays, setBays] = useState(DEFAULT_BAYS);
    const [servicePackages, setServicePackages] = useState([]);
    const [vehicleProfiles, setVehicleProfiles] = useState([]); // Track all vehicle profiles
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState(null);
    const [actionLoading, setActionLoading] = useState(false);
    const [showAddModal, setShowAddModal] = useState(false);
    const [showAssignModal, setShowAssignModal] = useState(false);
    const [showViewModal, setShowViewModal] = useState(false);
    const [showEditModal, setShowEditModal] = useState(false);
    const [showInvoiceModal, setShowInvoiceModal] = useState(false);
    const [showHistoryModal, setShowHistoryModal] = useState(false); // Visit history modal
    const [selectedVehicle, setSelectedVehicle] = useState(null);
    const [selectedVehicleHistory, setSelectedVehicleHistory] = useState(null); // For visit history
    const [editFormData, setEditFormData] = useState({});
    const [formData, setFormData] = useState({
        plateNumber: '',
        category: 'vehicle',
        itemType: 'Sedan',
        service: '', // Will be set when packages load
        priority: 'normal',
        customerName: '',
        customerPhone: ''
    });
    const [searchQuery, setSearchQuery] = useState('');
    const [dateFilter, setDateFilter] = useState('all');
    const [currentPage, setCurrentPage] = useState(1);
    const [itemsPerPage, setItemsPerPage] = useState(10);
    const [plateSearchResults, setPlateSearchResults] = useState([]); // Search results for existing vehicles
    const [showPlateSearchResults, setShowPlateSearchResults] = useState(false);
    const [selectedExistingVehicle, setSelectedExistingVehicle] = useState(null);
    
    // Staff list for assignment
    const [staffList, setStaffList] = useState([]);
    const [selectedStaffId, setSelectedStaffId] = useState('');
    
    // Additional services for fleet washes
    const [selectedAdditionalServices, setSelectedAdditionalServices] = useState([]);
    
    // Primary service for fleet vehicles (since they come without a service)
    const [selectedFleetService, setSelectedFleetService] = useState(null);
    
    // Invoices for payment status tracking
    const [invoices, setInvoices] = useState([]);
    
    // Export modal state
    const [showExportModal, setShowExportModal] = useState(false);
    const [exportDateRange, setExportDateRange] = useState('today');
    const [exportCustomStart, setExportCustomStart] = useState('');
    const [exportCustomEnd, setExportCustomEnd] = useState('');
    const [exporting, setExporting] = useState(false);
    
    // Scroll navigation state
    const [showScrollNav, setShowScrollNav] = useState(false);
    
    // Garage services modal state
    const [showGarageModal, setShowGarageModal] = useState(false);
    const [garageVehicle, setGarageVehicle] = useState(null);
    const [garageServices, setGarageServices] = useState([]);
    const [selectedGarageServices, setSelectedGarageServices] = useState([]);
    const [garageNotes, setGarageNotes] = useState('');
    
    // Customer items notes modal state
    const [showItemsNotesModal, setShowItemsNotesModal] = useState(false);
    const [itemsNotesVehicle, setItemsNotesVehicle] = useState(null);
    const [customerItemsNotes, setCustomerItemsNotes] = useState('');
    const [showItemsHistory, setShowItemsHistory] = useState(false);
    
    // Alert modal state
    const [alertModal, setAlertModal] = useState({
        isOpen: false,
        title: '',
        message: '',
        type: 'info',
        onConfirm: null,
        showCancel: false
    });
    
    // Helper to show alert modal
    const showAlert = (title, message, type = 'info', onConfirm = null, showCancel = false) => {
        setAlertModal({
            isOpen: true,
            title,
            message,
            type,
            onConfirm,
            showCancel
        });
    };
    
    const closeAlert = () => {
        setAlertModal(prev => ({ ...prev, isOpen: false }));
    };

    // Scroll detection for navigation
    React.useEffect(() => {
        let scrollTimeout;
        let isScrolling = false;
        
        const handleScroll = () => {
            if (!isScrolling) {
                setShowScrollNav(true);
                isScrolling = true;
            }
            
            clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(() => {
                setShowScrollNav(false);
                isScrolling = false;
            }, 1500); // Hide 1.5 seconds after scrolling stops
        };
        
        // Use passive listener for better scroll performance
        window.addEventListener('scroll', handleScroll, { passive: true });
        return () => {
            window.removeEventListener('scroll', handleScroll);
            clearTimeout(scrollTimeout);
        };
    }, []);

    // Export intake records to PDF
    const handleExportRecords = async () => {
        setExporting(true);
        try {
            const now = new Date();
            let startDate, endDate, rangeLabel;
            
            switch (exportDateRange) {
                case 'today':
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);
                    rangeLabel = `Today (${startDate.toLocaleDateString()})`;
                    break;
                case 'week':
                    const dayOfWeek = now.getDay();
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - dayOfWeek);
                    endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);
                    rangeLabel = `This Week (${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()})`;
                    break;
                case 'month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);
                    rangeLabel = `This Month (${startDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })})`;
                    break;
                case 'custom':
                    if (!exportCustomStart || !exportCustomEnd) {
                        showAlert('Error', 'Please select both start and end dates.', 'error');
                        setExporting(false);
                        return;
                    }
                    startDate = new Date(exportCustomStart);
                    endDate = new Date(exportCustomEnd + 'T23:59:59');
                    rangeLabel = `${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}`;
                    break;
                default:
                    startDate = new Date(0);
                    endDate = now;
                    rangeLabel = 'All Records';
            }
            
            // Filter records by date range
            const filteredRecords = vehicles.filter(v => {
                const recordDate = new Date(v.timeIn || v.createdAt);
                return recordDate >= startDate && recordDate <= endDate;
            }).sort((a, b) => new Date(b.timeIn || b.createdAt) - new Date(a.timeIn || a.createdAt));
            
            if (filteredRecords.length === 0) {
                showAlert('No Records', 'No intake records found for the selected date range.', 'info');
                setExporting(false);
                return;
            }
            
            // Get branding
            const branding = getBrandingForReceipts();
            const currencySymbol = branding.currencySymbol || 'KES';
            
            // Generate PDF content
            const pdfContent = `
<!DOCTYPE html>
<html>
<head>
    <title>Intake Records - ${rangeLabel}</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Arial, sans-serif; padding: 30px; color: #1e293b; background: #fff; }
        .header { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #e2e8f0; }
        .header h1 { font-size: 24px; color: #0f172a; margin-bottom: 5px; }
        .header .company { font-size: 14px; color: #64748b; margin-bottom: 10px; }
        .header .date-range { font-size: 16px; font-weight: 600; color: #3b82f6; }
        .summary { display: flex; justify-content: space-around; margin-bottom: 25px; padding: 15px; background: #f8fafc; border-radius: 8px; }
        .summary-item { text-align: center; }
        .summary-item .value { font-size: 24px; font-weight: 700; color: #1e293b; }
        .summary-item .label { font-size: 12px; color: #64748b; text-transform: uppercase; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 11px; }
        th { background: #1e293b; color: #fff; padding: 10px 8px; text-align: left; font-weight: 600; }
        td { padding: 10px 8px; border-bottom: 1px solid #e2e8f0; }
        tr:nth-child(even) { background: #f8fafc; }
        .plate { font-weight: 600; color: #1e293b; }
        .status { display: inline-block; padding: 3px 8px; border-radius: 12px; font-size: 10px; font-weight: 600; }
        .status-waiting { background: #fef3c7; color: #92400e; }
        .status-in-progress { background: #dbeafe; color: #1e40af; }
        .status-completed { background: #dcfce7; color: #166534; }
        .footer { margin-top: 30px; text-align: center; font-size: 11px; color: #94a3b8; padding-top: 20px; border-top: 1px solid #e2e8f0; }
        @media print { body { padding: 15px; } .no-print { display: none; } }
    </style>
</head>
<body>
    <div class="header">
        <h1>${branding.companyName}</h1>
        <div class="company">${branding.email || ''} ${branding.phone ? '| ' + branding.phone : ''}</div>
        <div class="date-range">Intake Records: ${rangeLabel}</div>
    </div>
    
    <div class="summary">
        <div class="summary-item">
            <div class="value">${filteredRecords.length}</div>
            <div class="label">Total Records</div>
        </div>
        <div class="summary-item">
            <div class="value">${filteredRecords.filter(r => r.status === 'completed').length}</div>
            <div class="label">Completed</div>
        </div>
        <div class="summary-item">
            <div class="value">${filteredRecords.filter(r => r.status === 'in-progress').length}</div>
            <div class="label">In Progress</div>
        </div>
        <div class="summary-item">
            <div class="value">${currencySymbol} ${filteredRecords.reduce((sum, r) => sum + (r.service?.price || 0), 0).toLocaleString()}</div>
            <div class="label">Total Value</div>
        </div>
    </div>
    
    <table>
        <thead>
            <tr>
                <th>#</th>
                <th>Plate / ID</th>
                <th>Category</th>
                <th>Type</th>
                <th>Customer</th>
                <th>Phone</th>
                <th>Service</th>
                <th>Price</th>
                <th>Status</th>
                <th>Date/Time</th>
            </tr>
        </thead>
        <tbody>
            ${filteredRecords.map((r, i) => `
                <tr>
                    <td>${i + 1}</td>
                    <td class="plate">${r.plateNumber || '-'}</td>
                    <td>${(INTAKE_CATEGORIES.find(c => c.id === r.category)?.label) || r.category || 'Vehicle'}</td>
                    <td>${r.itemType || r.vehicleType || '-'}</td>
                    <td>${r.customerName || '-'}</td>
                    <td>${r.customerPhone || '-'}</td>
                    <td>${r.service?.name || '-'}</td>
                    <td>${r.service?.price ? currencySymbol + ' ' + r.service.price.toLocaleString() : '-'}</td>
                    <td><span class="status status-${r.status || 'waiting'}">${(r.status || 'waiting').toUpperCase()}</span></td>
                    <td>${r.timeIn ? new Date(r.timeIn).toLocaleString() : '-'}</td>
                </tr>
            `).join('')}
        </tbody>
    </table>
    
    <div class="footer">
        Generated on ${new Date().toLocaleString()} | ${branding.companyName}
    </div>
    
    <script>window.onload = function() { window.print(); }</script>
</body>
</html>`;
            
            // Open in new window for printing/saving as PDF
            const printWindow = window.open('', '_blank');
            printWindow.document.write(pdfContent);
            printWindow.document.close();
            
            setShowExportModal(false);
            setExportDateRange('today');
            setExportCustomStart('');
            setExportCustomEnd('');
        } catch (err) {
            console.error('Export error:', err);
            showAlert('Export Failed', 'Failed to generate export. Please try again.', 'error');
        } finally {
            setExporting(false);
        }
    };

    // Generate next auto-ID for non-vehicle categories
    const generateNextId = (category) => {
        const prefix = {
            'motorbike': 'MB',
            'bicycle': 'BC',
            'carpet': 'CP',
            'other': 'OT'
        }[category] || 'ID';
        
        // Get all existing IDs with this prefix from queue and vehicles
        const allItems = [...queue, ...vehicles];
        const existingIds = allItems
            .filter(item => item.plateNumber?.startsWith(prefix + '-'))
            .map(item => {
                const num = parseInt(item.plateNumber.replace(prefix + '-', ''), 10);
                return isNaN(num) ? 0 : num;
            });
        
        const nextNum = existingIds.length > 0 ? Math.max(...existingIds) + 1 : 1;
        return `${prefix}-${String(nextNum).padStart(3, '0')}`;
    };

    // Set default service when packages load or category changes
    useEffect(() => {
        if (servicePackages.length > 0) {
            // Filter services for the current category
            const filteredServices = servicePackages.filter(service => 
                !service.appliesTo || 
                service.appliesTo === 'all' || 
                service.appliesTo === formData.category
            );
            // Set first matching service as default if current service is not valid for category
            if (filteredServices.length > 0) {
                const currentServiceValid = filteredServices.some(s => s.id === formData.service);
                if (!currentServiceValid) {
                    setFormData(prev => ({ ...prev, service: filteredServices[0].id }));
                }
            }
        }
    }, [servicePackages, formData.category]);

    // Filter vehicles based on search and date
    // SORTED: Most recent first (by timeIn or updatedAt) - returning vehicles appear at top
    const getFilteredVehicles = () => {
        if (!Array.isArray(vehicles)) return [];
        let filtered = vehicles.filter(v => v != null);

        // Search filter
        if (searchQuery.trim()) {
            const query = searchQuery.toLowerCase();
            filtered = filtered.filter(v => 
                v.plateNumber?.toLowerCase()?.includes(query) ||
                v.customerName?.toLowerCase()?.includes(query) ||
                v.customerPhone?.includes(query) ||
                v.service?.name?.toLowerCase()?.includes(query) ||
                v.vehicleType?.toLowerCase()?.includes(query)
            );
        }

        // Date filter
        if (dateFilter !== 'all') {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            const weekStart = new Date(today);
            weekStart.setDate(weekStart.getDate() - 7);
            const monthStart = new Date(today);
            monthStart.setDate(monthStart.getDate() - 30);

            filtered = filtered.filter(v => {
                const vehicleDate = new Date(v.timeIn);
                switch (dateFilter) {
                    case 'today':
                        return vehicleDate >= today;
                    case 'yesterday':
                        return vehicleDate >= yesterday && vehicleDate < today;
                    case 'week':
                        return vehicleDate >= weekStart;
                    case 'month':
                        return vehicleDate >= monthStart;
                    default:
                        return true;
                }
            });
        }

        // SORT: Most recent first - new vehicles and returning vehicles appear at top
        // Priority: updatedAt (for returning vehicles) or timeIn (for new vehicles)
        filtered.sort((a, b) => {
            // Use the most recent timestamp between timeIn and updatedAt
            const aTime = new Date(a.updatedAt || a.timeIn || a.createdAt).getTime();
            const bTime = new Date(b.updatedAt || b.timeIn || b.createdAt).getTime();
            return bTime - aTime; // Descending order (newest first)
        });

        return filtered;
    };

    const filteredVehicles = getFilteredVehicles() || [];
    
    // Pagination calculations - with safety
    const totalPages = Math.ceil((filteredVehicles.length || 0) / (itemsPerPage || 10)) || 1;
    const startIndex = ((currentPage || 1) - 1) * (itemsPerPage || 10);
    const endIndex = startIndex + (itemsPerPage || 10);
    const paginatedVehicles = Array.isArray(filteredVehicles) ? filteredVehicles.slice(startIndex, endIndex) : [];
    
    // Reset to page 1 when filters change
    useEffect(() => {
        setCurrentPage(1);
    }, [searchQuery, dateFilter, vehicles.length]);

    // Auto-complete vehicles when payment is confirmed
    // FIXED: Only match invoices created AFTER the vehicle's timeIn to prevent false matches
    useEffect(() => {
        if (!invoices.length || !vehicles.length) return;
        
        const svc = window.FirebaseServices;
        if (!svc?.intakeRecordsService) return;
        
        // Find vehicles that are not completed but have a paid invoice
        vehicles.forEach(async (vehicle) => {
            if (vehicle.status === 'completed') return; // Already completed
            if (vehicle.autoCompletedByPayment) return; // Already auto-completed
            
            const vehicleTimeIn = new Date(vehicle.timeIn);
            
            // Check if there's a matching paid invoice for THIS SPECIFIC VISIT
            const matchingInvoice = invoices.find(inv => {
                if (inv.paymentStatus !== 'paid') return false;
                
                const invoiceTime = new Date(inv.createdAt);
                
                // Invoice MUST be created AFTER the vehicle's timeIn (current visit started)
                // This prevents matching invoices from PREVIOUS visits
                if (invoiceTime < vehicleTimeIn) {
                    return false; // Invoice is from before this visit started - skip!
                }
                
                // Primary match: by record ID (most reliable)
                if (inv.washRecordId === vehicle.id) return true;
                
                // Secondary match: by plateNumber + visitNumber (if available)
                if (inv.visitNumber && vehicle.visitNumber && inv.plateNumber === vehicle.plateNumber) {
                    return inv.visitNumber === vehicle.visitNumber;
                }
                
                // Fallback: plateNumber + time window (invoice must be AFTER timeIn)
                if (inv.plateNumber === vehicle.plateNumber) {
                    // Invoice was created within 2 hours AFTER vehicle timeIn
                    const timeDiff = invoiceTime - vehicleTimeIn;
                    return timeDiff >= 0 && timeDiff < 7200000; // 0 to 2 hours after
                }
                return false;
            });
            
            if (matchingInvoice) {
                console.log('üîÑ Auto-completing vehicle due to payment:', vehicle.plateNumber, 'Visit #' + vehicle.visitNumber);
                try {
                    await svc.intakeRecordsService.updateRecord(vehicle.id, {
                        status: 'completed',
                        timeOut: vehicle.timeOut || new Date().toISOString(),
                        autoCompletedByPayment: true,
                        matchedInvoiceId: matchingInvoice.id
                    });
                    
                    // Free bay if assigned
                    if (vehicle.assignedBayId && svc.washBayService) {
                        await svc.washBayService.releaseBay(vehicle.assignedBayId);
                    }
                    
                    // Record visit in vehicle history
                    if (vehicle.category === 'vehicle' && vehicle.plateNumber && svc.vehicleHistoryService) {
                        await svc.vehicleHistoryService.recordVehicleVisit(vehicle.plateNumber, {
                            service: vehicle.service,
                            amount: vehicle.service?.price || 0,
                            vehicleType: vehicle.vehicleType || vehicle.itemType,
                            category: vehicle.category,
                            status: 'completed',
                            assignedBay: vehicle.assignedBay,
                            timeIn: vehicle.timeIn,
                            timeOut: new Date().toISOString(),
                            customerName: vehicle.customerName,
                            customerPhone: vehicle.customerPhone,
                            recordId: vehicle.id,
                            autoCompletedByPayment: true
                        });
                    }
                    
                    console.log('‚úÖ Auto-completed:', vehicle.plateNumber);
                } catch (err) {
                    console.error('Failed to auto-complete vehicle:', err);
                }
            }
        });
    }, [invoices, vehicles]);

    // Initialize Firebase subscriptions - using refs for proper cleanup
    const subscriptionsRef = React.useRef({
        queue: null,
        records: null,
        bays: null,
        packages: null,
        vehicleProfiles: null,
        mounted: true
    });

    useEffect(() => {
        console.log('üîÑ VehicleIntake: Initializing Firebase subscriptions...');
        subscriptionsRef.current.mounted = true;
        
        // Function to get services safely
        const getServices = () => window.FirebaseServices;

        const initializeData = async () => {
            // Check if still mounted
            if (!subscriptionsRef.current.mounted) return;
            
            let services = getServices();

            // Wait for services if not ready - faster polling with exponential backoff
            if (!services) {
                let attempts = 0;
                let delay = 25;
                while (!services && attempts < 15 && subscriptionsRef.current.mounted) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                    services = getServices();
                    attempts++;
                    delay = Math.min(delay * 1.5, 100); // Exponential backoff up to 100ms
                }
                
                if (!services) {
                    console.error('‚ùå FirebaseServices not available');
                    if (subscriptionsRef.current.mounted) {
                        setError('Connecting...');
                        setTimeout(initializeData, 50);
                    }
                    return;
                }
            }
            
            // Check if still mounted before proceeding
            if (!subscriptionsRef.current.mounted) return;
            
            // Clear loading error if we got services
            setError(null);
            
            // Set loading false early to show UI faster
            setLoading(false);

            const { intakeQueueService, intakeRecordsService, intakeBaysService, packagesService } = services;
            
            if (!intakeQueueService || !intakeRecordsService) {
                console.error('‚ùå Required intake services not available');
                setError('Required services incomplete.');
                return;
            }

            try {
                // Subscribe to critical data first (queue and records) - in parallel
                const criticalSubscriptions = [];
                
                // Subscribe to queue (Realtime Database) - CRITICAL
                criticalSubscriptions.push(new Promise(resolve => {
                    subscriptionsRef.current.queue = intakeQueueService.subscribeToQueue(
                        (queueData) => {
                            if (subscriptionsRef.current.mounted) {
                                setQueue(queueData);
                            }
                            resolve();
                        },
                        (err) => {
                            console.error('Queue subscription error:', err);
                            resolve();
                        }
                    );
                }));

                // Subscribe to vehicle records (Firestore) - CRITICAL
                criticalSubscriptions.push(new Promise(resolve => {
                    subscriptionsRef.current.records = intakeRecordsService.subscribeToRecords(
                        (recordsData) => {
                            if (subscriptionsRef.current.mounted) {
                                setVehicles(recordsData);
                            }
                            resolve();
                        },
                        (err) => {
                            console.error('Records subscription error:', err);
                            resolve();
                        }
                    );
                }));
                
                // Wait for critical subscriptions to get first data
                await Promise.race([
                    Promise.all(criticalSubscriptions),
                    new Promise(resolve => setTimeout(resolve, 500)) // Max 500ms wait
                ]);
                
                if (!subscriptionsRef.current.mounted) return;

                // Subscribe to non-critical data in background (don't await)
                // Bays
                if (services.washBayService?.subscribeToBays) {
                    subscriptionsRef.current.bays = services.washBayService.subscribeToBays(
                        (baysData) => {
                            if (subscriptionsRef.current.mounted) {
                                setBays(baysData.length > 0 ? baysData : DEFAULT_BAYS);
                            }
                        },
                        () => {} // Silent error
                    );
                } else if (intakeBaysService?.subscribeToBays) {
                    subscriptionsRef.current.bays = intakeBaysService.subscribeToBays(
                        (baysData) => {
                            if (subscriptionsRef.current.mounted) {
                                setBays(baysData.length > 0 ? baysData : DEFAULT_BAYS);
                            }
                        }
                    );
                }

                // Service packages - load async
                if (packagesService) {
                    subscriptionsRef.current.packages = packagesService.subscribeToPackages(
                        (packagesData) => {
                            if (subscriptionsRef.current.mounted) {
                                setServicePackages(packagesData.filter(p => p.isActive !== false));
                            }
                        }
                    );
                }

                // Vehicle profiles - load async (non-critical)
                if (services.vehicleHistoryService) {
                    subscriptionsRef.current.vehicleProfiles = services.vehicleHistoryService.subscribeToVehicleProfiles(
                        (profilesData) => {
                            if (subscriptionsRef.current.mounted) {
                                setVehicleProfiles(profilesData);
                            }
                        }
                    );
                }

                // Staff list - load async
                if (services.staffService?.subscribeToAllStaff) {
                    subscriptionsRef.current.staff = services.staffService.subscribeToAllStaff(
                        (staffData) => {
                            if (subscriptionsRef.current.mounted) {
                                setStaffList(staffData.filter(s => s.status === 'active'));
                            }
                        }
                    );
                }

                // Invoices - load async
                if (services.billingService?.subscribeToInvoices) {
                    subscriptionsRef.current.invoices = services.billingService.subscribeToInvoices(
                        (invoicesData) => {
                            if (subscriptionsRef.current.mounted) {
                                setInvoices(invoicesData);
                            }
                        }
                    );
                }

                // Garage Services - load async
                if (services.garageServicesService?.subscribeToServices) {
                    subscriptionsRef.current.garageServices = services.garageServicesService.subscribeToServices(
                        (servicesData) => {
                            if (subscriptionsRef.current.mounted) {
                                setGarageServices(servicesData.filter(s => s.isActive !== false));
                            }
                        }
                    );
                }

                console.log('‚úÖ VehicleIntake: Subscriptions active');
                
            } catch (err) {
                console.error('‚ùå Failed to initialize:', err);
                if (subscriptionsRef.current.mounted) {
                    setError('Failed to initialize data. Please refresh.');
                    setLoading(false);
                }
            }
        };

        initializeData();

        // Cleanup subscriptions on unmount
        return () => {
            console.log('üßπ VehicleIntake: Cleaning up subscriptions');
            subscriptionsRef.current.mounted = false;
            if (subscriptionsRef.current.queue) subscriptionsRef.current.queue();
            if (subscriptionsRef.current.records) subscriptionsRef.current.records();
            if (subscriptionsRef.current.bays) subscriptionsRef.current.bays();
            if (subscriptionsRef.current.packages) subscriptionsRef.current.packages();
            if (subscriptionsRef.current.vehicleProfiles) subscriptionsRef.current.vehicleProfiles();
            if (subscriptionsRef.current.invoices) subscriptionsRef.current.invoices();
            if (subscriptionsRef.current.garageServices) subscriptionsRef.current.garageServices();
        };
    }, []);

    // Calculate stats from live data - with null safety
    const stats = {
        waiting: Array.isArray(queue) ? queue.filter(v => v && v.status === 'waiting').length : 0,
        inProgress: Array.isArray(vehicles) ? vehicles.filter(v => v && v.status === 'in-progress').length : 0,
        availableBays: Array.isArray(bays) ? bays.filter(b => b && b.status === 'available').length : 0,
        avgWaitTime: Array.isArray(queue) && queue.length > 0 
            ? Math.round(queue.reduce((acc, v) => {
                if (!v || !v.timeIn) return acc;
                const timeIn = new Date(v.timeIn);
                return acc + (new Date() - timeIn) / 1000 / 60;
            }, 0) / queue.length) 
            : 0
    };

    // Get visit count for a plate number from vehicle profiles
    const getVehicleVisitCount = (plateNumber) => {
        if (!plateNumber) return 0;
        const normalizedPlate = plateNumber.toUpperCase().replace(/\s+/g, ' ').trim();
        const profile = vehicleProfiles.find(p => p.plateNumber === normalizedPlate);
        return profile?.totalVisits || 0;
    };

    // Get vehicle profile by plate
    const getVehicleProfile = (plateNumber) => {
        if (!plateNumber) return null;
        const normalizedPlate = plateNumber.toUpperCase().replace(/\s+/g, ' ').trim();
        return vehicleProfiles.find(p => p.plateNumber === normalizedPlate) || null;
    };

    // Get payment status for a vehicle record
    // Uses BOTH record paymentStatus AND invoice matching (like Wash Bay History)
    // FIXED: Only match invoices created AFTER vehicle's timeIn to prevent false matches from previous visits
    const getPaymentStatusForVehicle = (vehicle) => {
        if (!vehicle) return { isPaid: false, invoice: null };
        
        // Check 1: Vehicle record's own paymentStatus field (most reliable)
        const isPaidFromRecord = vehicle.paymentStatus === 'paid';
        
        // If already paid in record, return immediately
        if (isPaidFromRecord) {
            return { isPaid: true, invoice: null };
        }
        
        // Check 2: Find matching invoice for THIS SPECIFIC VISIT only
        const vehicleTimeIn = new Date(vehicle.timeIn);
        
        const matchingInvoice = invoices.find(inv => {
            const invoiceTime = new Date(inv.createdAt);
            
            // CRITICAL: Invoice MUST be created AFTER the vehicle's timeIn (current visit)
            // This prevents matching invoices from PREVIOUS visits of returning vehicles
            if (invoiceTime < vehicleTimeIn) {
                return false; // Invoice is from before this visit - skip!
            }
            
            // Primary match: by washRecordId or recordId (most reliable)
            if (inv.washRecordId && inv.washRecordId === vehicle.id) return true;
            if (inv.recordId && inv.recordId === vehicle.id) return true;
            
            // Secondary match: by visitNumber (if available)
            if (inv.visitNumber && vehicle.visitNumber && inv.plateNumber === vehicle.plateNumber) {
                return inv.visitNumber === vehicle.visitNumber;
            }
            
            // Fallback: plate match + time window (invoice must be AFTER timeIn)
            if (inv.plateNumber === vehicle.plateNumber) {
                // Invoice was created within 4 hours AFTER vehicle timeIn
                const timeDiff = invoiceTime - vehicleTimeIn;
                return timeDiff >= 0 && timeDiff < 14400000; // 0 to 4 hours after
            }
            return false;
        });
        
        const isPaidFromInvoice = matchingInvoice?.paymentStatus === 'paid';
        
        return {
            isPaid: isPaidFromInvoice,
            invoice: matchingInvoice
        };
    };

    // Open visit history modal
    const openHistoryModal = async (plateNumber) => {
        const services = window.FirebaseServices;
        if (!services?.vehicleHistoryService) {
            setError('Vehicle history service not available');
            return;
        }
        
        setActionLoading(true);
        try {
            const result = await services.vehicleHistoryService.getVehicleHistory(plateNumber);
            if (result.success && result.data) {
                setSelectedVehicleHistory(result.data);
                setShowHistoryModal(true);
            } else {
                setError('No visit history found for this vehicle');
            }
        } catch (err) {
            console.error('Error loading vehicle history:', err);
            setError('Failed to load vehicle history');
        } finally {
            setActionLoading(false);
        }
    };

    // Search for existing vehicles by plate (in intake records)
    const handlePlateSearch = async (searchTerm) => {
        if (!searchTerm || searchTerm.length < 2) {
            setPlateSearchResults([]);
            setShowPlateSearchResults(false);
            return;
        }
        
        const services = window.FirebaseServices;
        if (!services?.intakeRecordsService) return;
        
        try {
            // Search intake records for existing vehicles
            const result = await services.intakeRecordsService.searchByPlate(searchTerm);
            if (result.success) {
                setPlateSearchResults(result.data);
                setShowPlateSearchResults(result.data.length > 0);
            }
        } catch (err) {
            console.error('Error searching vehicles:', err);
        }
    };

    // Debounced plate search
    const plateSearchTimeout = React.useRef(null);
    const handlePlateInputChange = (value) => {
        setFormData({ ...formData, plateNumber: value });
        setSelectedExistingVehicle(null);
        
        // Clear previous timeout
        if (plateSearchTimeout.current) {
            clearTimeout(plateSearchTimeout.current);
        }
        
        // Debounce the search
        plateSearchTimeout.current = setTimeout(() => {
            handlePlateSearch(value);
        }, 300);
    };

    // Select an existing vehicle from search results (intake record)
    const selectExistingVehicle = (record) => {
        setSelectedExistingVehicle(record);
        setFormData({
            ...formData,
            plateNumber: record.plateNumber,
            customerName: record.customerName || formData.customerName,
            customerPhone: record.customerPhone || formData.customerPhone,
            itemType: record.itemType || record.vehicleType || formData.itemType
        });
        setShowPlateSearchResults(false);
    };

    // Add item to queue (saves to Realtime Database)
    const handleAddVehicle = async () => {
        // For vehicles, plate number is required. For others, auto-generate if empty
        let plateNumber = formData.plateNumber.trim();
        if (formData.category === 'vehicle' && !plateNumber) {
            setError('Plate number is required for vehicles.');
            return;
        }
        if (formData.category !== 'vehicle' && !plateNumber) {
            plateNumber = generateNextId(formData.category);
        }
        
        const services = window.FirebaseServices;
        if (!services || !services.intakeQueueService) {
            setError('Firebase not ready. Please wait and try again.');
            return;
        }
        
        setActionLoading(true);
        try {
            const serviceInfo = servicePackages.find(s => s.id === formData.service) || servicePackages[0];
            const normalizedPlate = plateNumber.toUpperCase().replace(/\s+/g, ' ').trim();
            
            // Check if this plate already has a record in intake (for showing returning info in queue)
            let existingInfo = null;
            if (formData.category === 'vehicle' && services.intakeRecordsService?.findByPlateNumber) {
                try {
                    const existing = await services.intakeRecordsService.findByPlateNumber(normalizedPlate);
                    if (existing.success && existing.exists && existing.data) {
                        existingInfo = {
                            visitNumber: existing.data.visitNumber || 1,
                            isReturning: true,
                            lastService: existing.data.service?.name,
                            lastVisit: existing.data.updatedAt || existing.data.createdAt
                        };
                    }
                } catch (err) {
                    console.warn('Could not check existing record:', err);
                }
            }
            
            const vehicleData = {
                plateNumber: normalizedPlate,
                category: formData.category,
                itemType: formData.itemType,
                vehicleType: formData.itemType,
                service: serviceInfo ? { id: serviceInfo.id, name: serviceInfo.name, price: serviceInfo.price } : null,
                priority: formData.priority,
                customerName: formData.customerName || null,
                customerPhone: formData.customerPhone || null,
                // Info for queue display (actual record handling happens when assigning bay)
                existingVisits: existingInfo?.visitNumber || 0,
                isReturningVehicle: existingInfo?.isReturning || false
            };

            const result = await services.intakeQueueService.addToQueue(vehicleData);
            
            if (result.success) {
                console.log('‚úÖ Added to queue:', normalizedPlate, existingInfo ? `(Returning - Visit #${existingInfo.visitNumber + 1})` : '(New)');
                
                // Log activity
                if (services.activityService) {
                    const currentUser = window.currentUserProfile;
                    services.activityService.logActivity({
                        type: 'intake',
                        action: 'Vehicle Added to Queue',
                        details: `${formData.category === 'vehicle' ? 'Vehicle' : INTAKE_CATEGORIES.find(c => c.id === formData.category)?.label}: ${normalizedPlate} - ${serviceInfo?.name || 'No service'}`,
                        status: 'success',
                        loggedBy: currentUser?.displayName || currentUser?.email?.split('@')[0] || 'System',
                        loggedByEmail: currentUser?.email || null,
                        loggedByRole: currentUser?.role || null
                    });
                }
                
                setFormData({
                    plateNumber: '',
                    category: 'vehicle',
                    itemType: 'Sedan',
                    service: servicePackages.length > 0 ? servicePackages[0].id : '',
                    priority: 'normal',
                    customerName: '',
                    customerPhone: ''
                });
                setShowAddModal(false);
                setShowPlateSearchResults(false);
                setSelectedExistingVehicle(null);
            } else {
                setError('Failed to add vehicle: ' + result.error);
            }
        } catch (err) {
            console.error('Error adding vehicle:', err);
            setError('Failed to add vehicle. Please try again.');
        } finally {
            setActionLoading(false);
        }
    };

    // Assign bay to vehicle from queue
    const handleAssignBay = async (bayId) => {
        if (!selectedVehicle) return;
        
        const services = window.FirebaseServices;
        if (!services || !services.intakeRecordsService) {
            setError('Firebase not ready. Please wait and try again.');
            return;
        }
        
        setActionLoading(true);
        try {
            const bay = bays.find(b => b.id === bayId);
            const { id: queueId, ...vehicleData } = selectedVehicle;
            
            // Get selected staff info (who will wash the vehicle)
            const assignedStaff = staffList.find(s => s.id === selectedStaffId);
            const washedBy = assignedStaff?.name || '';
            
            // Get the current logged-in user (who is assigning the vehicle)
            const currentUser = window.currentUserProfile;
            const assignedByUser = (currentUser && currentUser.displayName) || (currentUser && currentUser.email) || 'System';
            
            // For fleet vehicles, use the selected fleet service; otherwise use vehicle service
            const effectiveService = selectedVehicle.priority === 'fleet' && selectedFleetService 
                ? selectedFleetService 
                : selectedVehicle.service;
            
            // Calculate total price including additional services for fleet washes
            const basePrice = effectiveService?.price || 0;
            const additionalServicesTotal = selectedVehicle.priority === 'fleet' 
                ? selectedAdditionalServices.reduce((sum, s) => sum + (parseFloat(s.price) || 0), 0)
                : 0;
            const totalServicePrice = basePrice + additionalServicesTotal;
            
            // Deep sanitize to remove undefined values (Firebase doesn't accept undefined)
            const deepSanitize = (obj) => {
                if (obj === null || obj === undefined) return null;
                if (Array.isArray(obj)) {
                    return obj.map(item => deepSanitize(item)).filter(item => item !== undefined);
                }
                if (typeof obj === 'object') {
                    const sanitized = {};
                    for (const [key, value] of Object.entries(obj)) {
                        if (value !== undefined) {
                            sanitized[key] = deepSanitize(value);
                        }
                    }
                    return sanitized;
                }
                return obj;
            };
            
            // Sanitize vehicleData to remove undefined values
            const sanitizedVehicleData = deepSanitize(vehicleData);
            
            // Prepare vehicle record data
            const recordData = {
                ...sanitizedVehicleData,
                queueId: queueId || null,
                status: 'in-progress',
                paymentStatus: 'pending', // Always reset to pending for new/returning visits
                assignedBay: bay.name || '',
                assignedBayId: bayId || null,
                assignedBy: assignedByUser || 'System',
                washedBy: washedBy || '',
                assignedStaffId: selectedStaffId || null,
                assignedTime: new Date().toISOString(),
                timeIn: new Date().toISOString(),
                // Additional services for fleet washes
                additionalServices: selectedVehicle.priority === 'fleet' ? selectedAdditionalServices : [],
                totalServicePrice: totalServicePrice,
                // Use effective service (fleet selected service or vehicle's original service)
                service: effectiveService || { name: 'Unknown', price: 0 },
                // Fleet account info - stored in record for tracking
                fleetAccountId: selectedVehicle.fleetAccountId || null,
                fleetAccountNumber: selectedVehicle.fleetAccountNumber || null,
                isFleetWash: selectedVehicle.priority === 'fleet',
                driverName: selectedVehicle.driverName || '',
                driverPhone: selectedVehicle.driverPhone || ''
            };
            
            // Use addOrUpdateRecord - it handles returning vehicles automatically
            const result = await services.intakeRecordsService.addOrUpdateRecord(
                selectedVehicle.plateNumber,
                recordData
            );
            
            if (!result.success) {
                throw new Error(result.error || 'Failed to process vehicle record');
            }
            
            console.log(result.isReturning 
                ? `‚úÖ RETURNING vehicle updated - Visit #${result.visitNumber}` 
                : `‚úÖ NEW vehicle created - Visit #1`
            );
            
            // Show loyalty points notification if awarded
            if (result.loyaltyPointsAwarded > 0 && result.customerFound) {
                const rewardMsg = result.qualifiesForReward 
                    ? `\n\nüéÅ Customer now qualifies for a reward!` 
                    : '';
                showAlert(
                    'Loyalty Points Awarded!',
                    `+${result.loyaltyPointsAwarded} points added to customer account.${rewardMsg}`,
                    'loyalty'
                );
            }

            // Update wash bay status (this is the source of truth for bay status)
            if (services.washBayService) {
                const vehicleDataForBay = {
                    plateNumber: selectedVehicle.plateNumber,
                    customerName: selectedVehicle.customerName || '',
                    customerPhone: selectedVehicle.customerPhone || '',
                    vehicleType: selectedVehicle.vehicleType || selectedVehicle.itemType || 'sedan',
                    service: effectiveService || { name: 'Car Wash', price: 0 },
                    servicePrice: totalServicePrice,
                    additionalServices: selectedVehicle.priority === 'fleet' ? selectedAdditionalServices : [],
                    recordId: result.id,
                    queueId: queueId,
                    assignedBy: assignedByUser,
                    washedBy: washedBy,
                    assignedStaffId: selectedStaffId || null,
                    startTime: new Date().toISOString(),
                    // Visit tracking for returning vehicles
                    visitNumber: result.visitNumber || 1,
                    isReturningVehicle: result.isReturning || false,
                    // Fleet account info for tracking
                    fleetAccountId: selectedVehicle.fleetAccountId || null,
                    fleetAccountNumber: selectedVehicle.fleetAccountNumber || null,
                    isFleetWash: selectedVehicle.priority === 'fleet',
                    // Driver info for fleet vehicles
                    driverName: selectedVehicle.driverName || '',
                    driverPhone: selectedVehicle.driverPhone || ''
                };
                await services.washBayService.assignVehicle(bayId, vehicleDataForBay);
                console.log('‚úÖ Wash bay updated to occupied:', bayId, 'Assigned by:', assignedByUser, 'Washed by:', washedBy);
            }

            // Remove from queue
            await services.intakeQueueService.removeFromQueue(selectedVehicle.id);

            setShowAssignModal(false);
            setSelectedVehicle(null);
            setSelectedStaffId(''); // Reset staff selection
            setSelectedAdditionalServices([]); // Reset additional services
            setSelectedFleetService(null); // Reset fleet service selection
            
        } catch (err) {
            console.error('Error assigning bay:', err);
            setError('Failed to assign bay: ' + err.message);
        } finally {
            setActionLoading(false);
        }
    };

    // Open garage services modal
    const handleSendToGarage = (vehicle) => {
        setGarageVehicle(vehicle);
        setSelectedGarageServices([]);
        setGarageNotes('');
        setShowGarageModal(true);
    };

    // Toggle garage service selection
    const toggleGarageService = (service) => {
        setSelectedGarageServices(prev => {
            const exists = prev.find(s => s.id === service.id);
            if (exists) {
                return prev.filter(s => s.id !== service.id);
            } else {
                return [...prev, service];
            }
        });
    };

    // Calculate total cost of selected garage services
    const getGarageServicesTotal = () => {
        return selectedGarageServices.reduce((sum, s) => sum + (parseFloat(s.price) || 0), 0);
    };

    // Confirm send to garage with selected services
    const handleConfirmSendToGarage = async () => {
        if (!garageVehicle || selectedGarageServices.length === 0) return;
        
        const services = window.FirebaseServices;
        if (!services || !services.intakeRecordsService) {
            setError('Firebase not ready. Please wait and try again.');
            return;
        }
        
        setActionLoading(true);
        try {
            const { id: queueId, ...vehicleData } = garageVehicle;
            const totalCost = getGarageServicesTotal();
            
            // Create a "Garage" service with selected services and total cost
            const garageService = {
                id: 'garage-service',
                name: selectedGarageServices.map(s => s.name).join(', '),
                price: totalCost,
                description: 'Garage services: ' + selectedGarageServices.map(s => s.name).join(', ')
            };
            
            // Prepare record data for garage
            const recordData = {
                ...vehicleData,
                queueId: queueId,
                service: garageService,
                status: 'garage',
                assignedBay: 'Garage',
                assignedBayId: null,
                assignedTime: new Date().toISOString(),
                timeIn: new Date().toISOString(),
                sentToGarage: true,
                garageTimeIn: new Date().toISOString(),
                garageServices: selectedGarageServices,
                garageNotes: garageNotes
            };
            
            // Use addOrUpdateRecord - handles returning vehicles automatically
            const result = await services.intakeRecordsService.addOrUpdateRecord(
                garageVehicle.plateNumber,
                recordData
            );
            
            if (!result.success) {
                throw new Error(result.error || 'Failed to process vehicle record');
            }
            
            // Also add to garage queue if garageQueueService is available
            if (services.garageQueueService) {
                try {
                    await services.garageQueueService.addToQueue({
                        plateNumber: garageVehicle.plateNumber,
                        vehicleType: garageVehicle.vehicleType || garageVehicle.itemType,
                        customerName: garageVehicle.customerName || '',
                        customerPhone: garageVehicle.customerPhone || '',
                        services: selectedGarageServices,
                        notes: garageNotes || `From Vehicle Intake`,
                        priority: garageVehicle.priority || 'normal',
                        sourceId: result.recordId || garageVehicle.id,
                        source: 'intake-queue',
                        totalCost: totalCost,
                        intakeTimeIn: garageVehicle.timeIn || new Date().toISOString(),
                        originalService: garageVehicle.service
                    });
                    console.log('‚úÖ Vehicle added to garage queue:', garageVehicle.plateNumber);
                } catch (garageErr) {
                    console.error('Failed to add to garage queue (non-critical):', garageErr);
                }
            }
            
            // Remove from intake queue
            await services.intakeQueueService.removeFromQueue(garageVehicle.id);
            
            console.log(result.isReturning 
                ? `‚úÖ RETURNING vehicle sent to garage - Visit #${result.visitNumber}` 
                : `‚úÖ NEW vehicle sent to garage - Visit #1`
            );
            
            // Close modal and reset
            setShowGarageModal(false);
            setGarageVehicle(null);
            setSelectedGarageServices([]);
            setGarageNotes('');
            
            showAlert(
                'üîß Sent to Garage',
                `${garageVehicle.plateNumber} has been sent to the Garage with ${selectedGarageServices.length} service(s).\nTotal: ${getBrandingForReceipts().currencySymbol || 'KSh'} ${totalCost.toLocaleString()}`,
                'success'
            );
            
            // Show loyalty points notification if awarded
            if (result.loyaltyPointsAwarded > 0 && result.customerFound) {
                const rewardMsg = result.qualifiesForReward 
                    ? `\n\nüéÅ Customer now qualifies for a reward!` 
                    : '';
                showAlert(
                    'Loyalty Points Awarded!',
                    `+${result.loyaltyPointsAwarded} points added to customer account.${rewardMsg}`,
                    'loyalty'
                );
            }
        } catch (err) {
            console.error('Error sending to garage:', err);
            setError('Failed to send to garage: ' + err.message);
            showAlert('Error', 'Failed to send to garage: ' + err.message, 'error');
        } finally {
            setActionLoading(false);
        }
    };

    // Mark vehicle as complete - REBUILT
    const handleComplete = async (vehicle) => {
        console.log('=== COMPLETE ACTION ===');
        console.log('Vehicle:', vehicle.plateNumber, 'ID:', vehicle.id);
        
        // Get fresh services reference
        const svc = window.FirebaseServices;
        console.log('Services available:', !!svc);
        console.log('intakeRecordsService:', !!svc?.intakeRecordsService);
        
        if (!svc?.intakeRecordsService) {
            showAlert('Connection Error', 'Firebase not ready. Please refresh the page.', 'error');
            return;
        }
        
        setActionLoading(true);
        setError(null);
        
        try {
            const updatePayload = {
                status: 'completed',
                timeOut: new Date().toISOString()
            };
            console.log('Update payload:', updatePayload);
            
            const result = await svc.intakeRecordsService.updateRecord(vehicle.id, updatePayload);
            console.log('Update result:', result);

            if (!result.success) {
                throw new Error(result.error || 'Update failed');
            }

            // Free up the bay if assigned (use washBayService as source of truth)
            if (vehicle.assignedBayId) {
                console.log('Freeing bay:', vehicle.assignedBayId);
                if (svc.washBayService) {
                    await svc.washBayService.releaseBay(vehicle.assignedBayId);
                }
            }

            // Record visit in vehicle history (for vehicles category)
            if (vehicle.category === 'vehicle' && vehicle.plateNumber && svc.vehicleHistoryService) {
                try {
                    await svc.vehicleHistoryService.recordVehicleVisit(vehicle.plateNumber, {
                        service: vehicle.service,
                        amount: vehicle.service?.price || 0,
                        vehicleType: vehicle.vehicleType || vehicle.itemType,
                        category: vehicle.category,
                        status: 'completed',
                        assignedBay: vehicle.assignedBay,
                        timeIn: vehicle.timeIn,
                        timeOut: new Date().toISOString(),
                        customerName: vehicle.customerName,
                        customerPhone: vehicle.customerPhone,
                        recordId: vehicle.id
                    });
                    console.log('‚úÖ Visit recorded for:', vehicle.plateNumber);
                } catch (historyErr) {
                    console.error('Failed to record visit history:', historyErr);
                    // Don't fail the completion if history recording fails
                }
            }

            console.log('SUCCESS: Vehicle completed');
        } catch (err) {
            console.error('FAILED:', err);
            setError('Complete failed: ' + err.message);
            showAlert('Action Failed', 'Failed to complete: ' + err.message, 'error');
        } finally {
            setActionLoading(false);
        }
    };

    // Mark vehicle as paid - Updates payment status and marks as completed
    const handleMarkAsPaid = async (vehicle) => {
        console.log('=== MARK AS PAID ===');
        console.log('Vehicle:', vehicle.plateNumber, 'ID:', vehicle.id);
        
        const svc = window.FirebaseServices;
        if (!svc?.intakeRecordsService) {
            showAlert('Connection Error', 'Firebase not ready. Please refresh the page.', 'error');
            return;
        }
        
        setActionLoading(true);
        setError(null);
        
        try {
            // Update record with both status: completed and paymentStatus: paid
            const updatePayload = {
                status: 'completed',
                paymentStatus: 'paid',
                paidAt: new Date().toISOString(),
                timeOut: vehicle.timeOut || new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            const result = await svc.intakeRecordsService.updateRecord(vehicle.id, updatePayload);
            
            if (!result.success) {
                throw new Error(result.error || 'Update failed');
            }

            // Free up the bay if assigned
            if (vehicle.assignedBayId && svc.washBayService) {
                await svc.washBayService.releaseBay(vehicle.assignedBayId);
            }

            // Record visit in vehicle history
            if (vehicle.category === 'vehicle' && vehicle.plateNumber && svc.vehicleHistoryService) {
                try {
                    await svc.vehicleHistoryService.recordVehicleVisit(vehicle.plateNumber, {
                        service: vehicle.service,
                        amount: vehicle.service?.price || 0,
                        vehicleType: vehicle.vehicleType || vehicle.itemType,
                        category: vehicle.category,
                        status: 'completed',
                        assignedBay: vehicle.assignedBay,
                        timeIn: vehicle.timeIn,
                        timeOut: new Date().toISOString(),
                        customerName: vehicle.customerName,
                        customerPhone: vehicle.customerPhone,
                        recordId: vehicle.id
                    });
                } catch (historyErr) {
                    console.error('Failed to record visit history:', historyErr);
                }
            }

            showAlert('Payment Confirmed', `${vehicle.plateNumber} has been marked as paid and completed.`, 'success');
            
            // Auto-close alert after 2 seconds
            setTimeout(() => closeAlert(), 2000);
            
            console.log('SUCCESS: Vehicle marked as paid');
        } catch (err) {
            console.error('FAILED:', err);
            setError('Mark as paid failed: ' + err.message);
            showAlert('Action Failed', 'Failed to mark as paid: ' + err.message, 'error');
        } finally {
            setActionLoading(false);
        }
    };

    // Update vehicle status - REBUILT  
    const handleStatusChange = async (vehicle, newStatus) => {
        console.log('=== STATUS CHANGE ===');
        console.log('Vehicle:', vehicle.plateNumber, 'New Status:', newStatus);
        
        const svc = window.FirebaseServices;
        if (!svc?.intakeRecordsService) {
            showAlert('Connection Error', 'Firebase not ready. Please refresh the page.', 'error');
            return;
        }
        
        setActionLoading(true);
        setError(null);
        
        try {
            const updatePayload = { status: newStatus };
            
            // If completing, add timeOut
            if (newStatus === 'completed') {
                updatePayload.timeOut = new Date().toISOString();
            }
            
            const result = await svc.intakeRecordsService.updateRecord(vehicle.id, updatePayload);
            
            if (!result.success) {
                throw new Error(result.error || 'Update failed');
            }

            // Free bay if completing (use washBayService as source of truth)
            if (newStatus === 'completed' && vehicle.assignedBayId) {
                if (svc.washBayService) {
                    await svc.washBayService.releaseBay(vehicle.assignedBayId);
                }
            }

            // Record visit in vehicle history when completing (for vehicles category)
            if (newStatus === 'completed' && vehicle.category === 'vehicle' && vehicle.plateNumber && svc.vehicleHistoryService) {
                try {
                    await svc.vehicleHistoryService.recordVehicleVisit(vehicle.plateNumber, {
                        service: vehicle.service,
                        amount: vehicle.service?.price || 0,
                        vehicleType: vehicle.vehicleType || vehicle.itemType,
                        category: vehicle.category,
                        status: 'completed',
                        assignedBay: vehicle.assignedBay,
                        timeIn: vehicle.timeIn,
                        timeOut: new Date().toISOString(),
                        customerName: vehicle.customerName,
                        customerPhone: vehicle.customerPhone,
                        recordId: vehicle.id
                    });
                    console.log('‚úÖ Visit recorded for:', vehicle.plateNumber);
                } catch (historyErr) {
                    console.error('Failed to record visit history:', historyErr);
                    // Don't fail the status change if history recording fails
                }
            }

            console.log('SUCCESS: Status changed to', newStatus);
        } catch (err) {
            console.error('FAILED:', err);
            setError('Status change failed: ' + err.message);
            showAlert('Action Failed', 'Failed to update status: ' + err.message, 'error');
        } finally {
            setActionLoading(false);
        }
    };

    // Remove from queue
    const handleRemoveFromQueue = async (vehicleId) => {
        const services = window.FirebaseServices;
        if (!services) {
            setError('Firebase not ready. Please try again.');
            return;
        }
        
        setActionLoading(true);
        try {
            await services.intakeQueueService.removeFromQueue(vehicleId);
            console.log('‚úÖ Vehicle removed from queue');
        } catch (err) {
            console.error('Error removing from queue:', err);
            setError('Failed to remove vehicle. Please try again.');
        } finally {
            setActionLoading(false);
        }
    };

    // Toggle hold status for a queue item
    const handleToggleHold = async (vehicle) => {
        const services = window.FirebaseServices;
        if (!services?.intakeQueueService) {
            setError('Firebase not ready. Please try again.');
            return;
        }
        
        try {
            const newHoldStatus = !vehicle.isOnHold;
            await services.intakeQueueService.updateQueueItem(vehicle.id, { 
                isOnHold: newHoldStatus,
                holdTime: newHoldStatus ? new Date().toISOString() : null
            });
            console.log(`‚úÖ Vehicle ${newHoldStatus ? 'placed on hold' : 'resumed'}`);
        } catch (err) {
            console.error('Error toggling hold status:', err);
            setError('Failed to update hold status. Please try again.');
        }
    };

    // Open assign modal
    const openAssignModal = (vehicle) => {
        setSelectedVehicle(vehicle);
        setShowAssignModal(true);
    };

    // Open customer items notes modal
    const openItemsNotesModal = (vehicle) => {
        setItemsNotesVehicle(vehicle);
        setCustomerItemsNotes(vehicle.customerItems || '');
        setShowItemsNotesModal(true);
    };

    // Save customer items notes
    const handleSaveItemsNotes = async () => {
        if (!itemsNotesVehicle) return;
        
        const services = window.FirebaseServices;
        if (!services?.intakeRecordsService) {
            setError('Services not available');
            return;
        }
        
        setActionLoading(true);
        try {
            await services.intakeRecordsService.updateRecord(itemsNotesVehicle.id, {
                customerItems: customerItemsNotes,
                customerItemsUpdatedAt: new Date().toISOString()
            });
            
            showAlert('‚úÖ Items Saved', 'Customer items have been recorded successfully.', 'success');
            setShowItemsNotesModal(false);
            setItemsNotesVehicle(null);
        } catch (err) {
            console.error('Error saving items notes:', err);
            setError('Failed to save items: ' + err.message);
        } finally {
            setActionLoading(false);
        }
    };

    // Clear customer items notes (upon issuance)
    const handleClearItemsNotes = async () => {
        if (!itemsNotesVehicle) return;
        
        const services = window.FirebaseServices;
        if (!services?.intakeRecordsService) {
            setError('Services not available');
            return;
        }
        
        setActionLoading(true);
        try {
            await services.intakeRecordsService.updateRecord(itemsNotesVehicle.id, {
                customerItems: '',
                customerItemsIssuedAt: new Date().toISOString()
            });
            
            showAlert('‚úÖ Items Issued', 'Customer items have been cleared/issued.', 'success');
            setShowItemsNotesModal(false);
            setItemsNotesVehicle(null);
            setCustomerItemsNotes('');
        } catch (err) {
            console.error('Error clearing items:', err);
            setError('Failed to clear items: ' + err.message);
        } finally {
            setActionLoading(false);
        }
    };

    // Mark car key as issued
    const handleKeyIssued = async () => {
        if (!itemsNotesVehicle) return;
        
        const services = window.FirebaseServices;
        if (!services?.intakeRecordsService) {
            setError('Services not available');
            return;
        }
        
        setActionLoading(true);
        try {
            await services.intakeRecordsService.updateRecord(itemsNotesVehicle.id, {
                keyIssued: true,
                keyIssuedAt: new Date().toISOString()
            });
            
            // Update local state
            setItemsNotesVehicle(prev => ({ ...prev, keyIssued: true, keyIssuedAt: new Date().toISOString() }));
            showAlert('‚úÖ Key Issued', 'Car key has been marked as returned to customer.', 'success');
        } catch (err) {
            console.error('Error marking key issued:', err);
            setError('Failed to update key status: ' + err.message);
        } finally {
            setActionLoading(false);
        }
    };

    // Revert car key issued status (undo accidental marking)
    const handleKeyRevert = async () => {
        if (!itemsNotesVehicle) return;
        
        const services = window.FirebaseServices;
        if (!services?.intakeRecordsService) {
            setError('Services not available');
            return;
        }
        
        // Confirm before reverting
        showAlert(
            'üîë Revert Key Status?',
            'Are you sure you want to mark the key as NOT issued? This should only be done if the key was accidentally marked as issued.',
            'warning',
            async () => {
                setActionLoading(true);
                try {
                    await services.intakeRecordsService.updateRecord(itemsNotesVehicle.id, {
                        keyIssued: false,
                        keyIssuedAt: null,
                        keyRevertedAt: new Date().toISOString()
                    });
                    
                    // Update local state
                    setItemsNotesVehicle(prev => ({ ...prev, keyIssued: false, keyIssuedAt: null }));
                    showAlert('üîë Key Status Reverted', 'Key has been marked as NOT issued. Please ensure the key is still with staff.', 'success');
                } catch (err) {
                    console.error('Error reverting key status:', err);
                    setError('Failed to revert key status: ' + err.message);
                } finally {
                    setActionLoading(false);
                }
            },
            true // showCancel
        );
    };

    // Print key tag label
    const printKeyTag = (vehicle) => {
        const printWindow = window.open('', '_blank', 'width=300,height=200');
        if (!printWindow) {
            showAlert('Print Blocked', 'Please allow popups to print the key tag.', 'warning');
            return;
        }
        
        const tagContent = `
            <!DOCTYPE html>
            <html>
            <head>
                <title>Key Tag - ${vehicle.plateNumber}</title>
                <style>
                    @media print {
                        @page { size: 60mm 30mm; margin: 2mm; }
                        body { margin: 0; }
                    }
                    body {
                        font-family: Arial, sans-serif;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        min-height: 100vh;
                        margin: 0;
                        background: #f5f5f5;
                    }
                    .key-tag {
                        width: 55mm;
                        height: 25mm;
                        background: white;
                        border: 2px solid #333;
                        border-radius: 4px;
                        padding: 3mm;
                        box-sizing: border-box;
                        display: flex;
                        flex-direction: column;
                        justify-content: center;
                        align-items: center;
                    }
                    .plate-number {
                        font-size: 16px;
                        font-weight: bold;
                        font-family: monospace;
                        letter-spacing: 1px;
                        margin-bottom: 2mm;
                    }
                    .vehicle-type {
                        font-size: 9px;
                        color: #666;
                    }
                    .logo {
                        font-size: 8px;
                        color: #999;
                        margin-top: 1mm;
                    }
                </style>
            </head>
            <body>
                <div class="key-tag">
                    <div class="plate-number">${vehicle.plateNumber}</div>
                    <div class="vehicle-type">${vehicle.itemType || vehicle.vehicleType || 'Vehicle'}</div>
                    <div class="logo">üöó ${getBrandingForReceipts().companyName}</div>
                </div>
                <script>
                    window.onload = function() {
                        window.print();
                        setTimeout(function() { window.close(); }, 500);
                    };
                <\/script>
            </body>
            </html>
        `;
        
        printWindow.document.write(tagContent);
        printWindow.document.close();
    };

    // Reset all (items + key status) for next wash
    const handleResetForNextWash = async () => {
        if (!itemsNotesVehicle) return;
        
        const services = window.FirebaseServices;
        if (!services?.intakeRecordsService) {
            setError('Services not available');
            return;
        }
        
        setActionLoading(true);
        try {
            // Save current items to history before clearing
            const currentHistory = itemsNotesVehicle.itemsHistory || [];
            const newHistoryEntry = customerItemsNotes ? {
                items: customerItemsNotes,
                date: new Date().toISOString(),
                keyIssued: itemsNotesVehicle.keyIssued || false
            } : null;
            
            const updatedHistory = newHistoryEntry 
                ? [...currentHistory, newHistoryEntry].slice(-10) // Keep last 10 entries
                : currentHistory;
            
            await services.intakeRecordsService.updateRecord(itemsNotesVehicle.id, {
                customerItems: '',
                keyIssued: false,
                keyIssuedAt: null,
                itemsHistory: updatedHistory,
                lastResetAt: new Date().toISOString()
            });
            
            // Update local state
            setItemsNotesVehicle(prev => ({ 
                ...prev, 
                customerItems: '',
                keyIssued: false,
                keyIssuedAt: null,
                itemsHistory: updatedHistory
            }));
            setCustomerItemsNotes('');
            
            showAlert('‚úÖ Reset Complete', 'Items and key status have been reset for next wash.', 'success');
        } catch (err) {
            console.error('Error resetting:', err);
            setError('Failed to reset: ' + err.message);
        } finally {
            setActionLoading(false);
        }
    };

    // Clear all items history
    const handleClearItemsHistory = async () => {
        if (!itemsNotesVehicle) return;
        
        const services = window.FirebaseServices;
        if (!services?.intakeRecordsService) {
            setError('Services not available');
            return;
        }
        
        setActionLoading(true);
        try {
            await services.intakeRecordsService.updateRecord(itemsNotesVehicle.id, {
                itemsHistory: []
            });
            
            // Update local state
            setItemsNotesVehicle(prev => ({ ...prev, itemsHistory: [] }));
            setShowItemsHistory(false);
            
            showAlert('‚úÖ History Cleared', 'All items history has been cleared.', 'success');
        } catch (err) {
            console.error('Error clearing history:', err);
            setError('Failed to clear history: ' + err.message);
        } finally {
            setActionLoading(false);
        }
    };

    // Open view modal
    const openViewModal = (vehicle) => {
        setSelectedVehicle(vehicle);
        setShowViewModal(true);
    };

    // Open edit modal
    const openEditModal = (vehicle) => {
        setSelectedVehicle(vehicle);
        setEditFormData({
            plateNumber: vehicle.plateNumber || '',
            category: vehicle.category || 'vehicle',
            itemType: vehicle.itemType || vehicle.vehicleType || 'Sedan',
            service: vehicle.service?.id || 'basic',
            priority: vehicle.priority || 'normal',
            customerName: vehicle.customerName || '',
            customerPhone: vehicle.customerPhone || '',
            status: vehicle.status || 'in-progress'
        });
        setShowEditModal(true);
    };

    // Handle edit vehicle
    const handleEditVehicle = async () => {
        if (!selectedVehicle) return;
        
        const services = window.FirebaseServices;
        if (!services || !services.intakeRecordsService) {
            console.error('‚ùå Firebase services not available');
            setError('Firebase not ready. Please wait and try again.');
            return;
        }
        
        setActionLoading(true);
        try {
            const serviceInfo = servicePackages.find(s => s.id === editFormData.service) || servicePackages[0];
            const updateData = {
                plateNumber: editFormData.plateNumber.toUpperCase(),
                category: editFormData.category,
                itemType: editFormData.itemType,
                vehicleType: editFormData.itemType, // Legacy support
                service: serviceInfo ? { id: serviceInfo.id, name: serviceInfo.name, price: serviceInfo.price } : null,
                priority: editFormData.priority,
                customerName: editFormData.customerName || null,
                customerPhone: editFormData.customerPhone || null,
                status: editFormData.status
            };
            
            // If status changed to completed, set timeOut
            if (editFormData.status === 'completed' && selectedVehicle.status !== 'completed') {
                updateData.timeOut = new Date().toISOString();
                // Free the bay if assigned (use washBayService as source of truth)
                if (selectedVehicle.assignedBayId && services.washBayService) {
                    await services.washBayService.releaseBay(selectedVehicle.assignedBayId);
                }
            }

            console.log('üì§ Updating vehicle:', selectedVehicle.id, updateData);
            const result = await services.intakeRecordsService.updateRecord(selectedVehicle.id, updateData);
            console.log('üì§ Update result:', result);
            
            setShowEditModal(false);
            setSelectedVehicle(null);
        } catch (err) {
            console.error('‚ùå Error updating vehicle:', err);
            setError('Failed to update vehicle: ' + err.message);
        } finally {
            setActionLoading(false);
        }
    };

    // Open invoice modal
    const openInvoiceModal = (vehicle) => {
        setSelectedVehicle(vehicle);
        setShowInvoiceModal(true);
    };

    // Print Receipt - Clean thermal receipt style
    const printReceipt = (vehicle) => {
        const total = vehicle.service?.price || 0;
        const receiptNumber = `ECO-${Date.now().toString().slice(-8)}`;
        const printDate = new Date().toLocaleString();
        const brand = getBrandingForReceipts();
        
        const receiptHTML = `
            <!DOCTYPE html>
            <html>
            <head>
                <title>Receipt - ${vehicle.plateNumber}</title>
                <style>
                    * { margin: 0; padding: 0; box-sizing: border-box; }
                    body { 
                        font-family: 'Courier New', monospace; 
                        width: 280px; 
                        margin: 0 auto; 
                        padding: 20px 10px;
                        background: #fff;
                    }
                    .receipt { text-align: center; }
                    .header { margin-bottom: 15px; border-bottom: 2px dashed #000; padding-bottom: 15px; }
                    .logo { font-size: 24px; font-weight: bold; margin-bottom: 5px; }
                    .tagline { font-size: 10px; color: #666; }
                    .company-info { font-size: 9px; color: #666; margin-top: 5px; }
                    .receipt-no { font-size: 11px; margin-top: 10px; }
                    .section { margin: 15px 0; text-align: left; }
                    .section-title { font-weight: bold; font-size: 12px; margin-bottom: 8px; border-bottom: 1px solid #ccc; padding-bottom: 3px; }
                    .row { display: flex; justify-content: space-between; font-size: 12px; margin: 4px 0; }
                    .row-label { color: #666; }
                    .plate { font-size: 18px; font-weight: bold; letter-spacing: 2px; margin: 10px 0; }
                    .divider { border-top: 1px dashed #000; margin: 15px 0; }
                    .total-section { margin: 15px 0; padding: 10px 0; border-top: 2px solid #000; border-bottom: 2px solid #000; }
                    .total { display: flex; justify-content: space-between; font-size: 16px; font-weight: bold; }
                    .footer { margin-top: 20px; font-size: 10px; color: #666; text-align: center; }
                    .barcode { font-family: 'Libre Barcode 39', cursive; font-size: 36px; margin: 10px 0; }
                    @media print {
                        body { width: 80mm; padding: 5mm; }
                        @page { margin: 0; size: 80mm auto; }
                    }
                </style>
            </head>
            <body>
                <div class="receipt">
                    <div class="header">
                        <div class="logo">üöó ${brand.companyName }</div>
                        <div class="tagline">${brand.tagline || 'Premium Car Wash Services'}</div>
                        ${brand.address ? `<div class="company-info">${brand.address}${brand.city ? ', ' + brand.city : ''}</div>` : ''}
                        ${brand.phone ? `<div class="company-info">Tel: ${brand.phone}</div>` : ''}
                        ${brand.taxPin ? `<div class="company-info">PIN: ${brand.taxPin}</div>` : ''}
                        <div class="receipt-no">${brand.receiptHeader || 'Receipt'} #${receiptNumber}</div>
                    </div>
                    
                    <div class="plate">${vehicle.plateNumber}</div>
                    
                    <div class="section">
                        <div class="section-title">VEHICLE INFO</div>
                        <div class="row">
                            <span class="row-label">Type:</span>
                            <span>${vehicle.vehicleType}</span>
                        </div>
                        <div class="row">
                            <span class="row-label">Bay:</span>
                            <span>${vehicle.assignedBay || 'N/A'}</span>
                        </div>
                        <div class="row">
                            <span class="row-label">Status:</span>
                            <span>${(vehicle.status || 'pending').toUpperCase()}</span>
                        </div>
                    </div>
                    
                    ${vehicle.customerName ? `
                    <div class="section">
                        <div class="section-title">CUSTOMER</div>
                        <div class="row">
                            <span class="row-label">Name:</span>
                            <span>${vehicle.customerName}</span>
                        </div>
                        ${vehicle.customerPhone ? `<div class="row">
                            <span class="row-label">Phone:</span>
                            <span>${vehicle.customerPhone}</span>
                        </div>` : ''}
                    </div>
                    ` : ''}
                    
                    <div class="section">
                        <div class="section-title">SERVICE</div>
                        <div class="row">
                            <span>${vehicle.service?.name || 'Car Wash'}</span>
                            <span>${brand.currencySymbol || 'KSH'} ${total}</span>
                        </div>
                    </div>
                    
                    <div class="total-section">
                        <div class="total">
                            <span>TOTAL</span>
                            <span>${brand.currencySymbol || 'KSH'} ${total}</span>
                        </div>
                    </div>
                    
                    <div class="section" style="text-align: center;">
                        <div class="row" style="justify-content: center;">
                            <span class="row-label">Time In: ${vehicle.timeIn ? new Date(vehicle.timeIn).toLocaleString() : '-'}</span>
                        </div>
                        ${vehicle.timeOut ? `
                        <div class="row" style="justify-content: center;">
                            <span class="row-label">Time Out: ${new Date(vehicle.timeOut).toLocaleString()}</span>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div class="divider"></div>
                    
                    <div class="footer">
                        <p>${brand.receiptFooter || 'Thank you for choosing us!'}</p>
                        <p style="margin-top: 10px; font-size: 9px;">Printed: ${printDate}</p>
                    </div>
                </div>
                <script>
                    window.onload = function() { window.print(); window.onafterprint = function() { window.close(); } }
                </script>
            </body>
            </html>
        `;
        
        const printWindow = window.open('', '_blank', 'width=320,height=600');
        printWindow.document.write(receiptHTML);
        printWindow.document.close();
    };

    // Delete vehicle record
    const handleDeleteRecord = async (vehicle) => {
        showAlert(
            'Confirm Delete',
            'Are you sure you want to delete this record? This action cannot be undone.',
            'warning',
            async () => {
                const services = window.FirebaseServices;
                if (!services) {
                    setError('Firebase not ready. Please try again.');
                    return;
                }
                
                setActionLoading(true);
                try {
                    await services.intakeRecordsService.deleteRecord(vehicle.id);
                    console.log('‚úÖ Vehicle record deleted:', vehicle.id);
                    setShowViewModal(false);
                    setSelectedVehicle(null);
                    showAlert('Deleted', 'Record has been successfully deleted.', 'success');
                } catch (err) {
                    console.error('Error deleting record:', err);
                    setError('Failed to delete record. Please try again.');
                } finally {
                    setActionLoading(false);
                }
            },
            true // showCancel
        );
    };

    // Clear error message
    const clearError = () => setError(null);

    // Priority badge color
    const getPriorityColor = (priority) => {
        switch(priority) {
            case 'vip': return '#f59e0b';
            case 'fleet': return '#8b5cf6';
            default: return '#64748b';
        }
    };

    // Status badge color
    const getStatusColor = (status) => {
        switch(status) {
            case 'waiting': return '#f59e0b';
            case 'in-progress': return '#3b82f6';
            case 'completed': return '#10b981';
            case 'garage': return '#8b5cf6';
            default: return '#64748b';
        }
    };

    return (
        <div className="vehicle-intake">
            {/* Quick Scroll Navigation - always visible */}
            <div style={{
                position: 'fixed',
                right: '20px',
                top: '50%',
                transform: 'translateY(-50%)',
                display: 'flex',
                flexDirection: 'column',
                gap: '8px',
                zIndex: 100,
                background: isDark ? 'rgba(31, 41, 55, 0.95)' : 'rgba(255,255,255,0.95)',
                padding: '8px',
                borderRadius: '12px',
                boxShadow: isDark ? '0 2px 12px rgba(0,0,0,0.4)' : '0 2px 12px rgba(0,0,0,0.15)',
                border: isDark ? '1px solid #374151' : '1px solid #e2e8f0'
            }}>
                <button
                    onClick={() => window.scrollTo({ top: 0, behavior: 'smooth' })}
                    title="Scroll to Top"
                    style={{
                        width: '36px',
                        height: '36px',
                        borderRadius: '8px',
                        border: isDark ? '1px solid #4b5563' : '1px solid #e2e8f0',
                        background: isDark ? '#374151' : '#fff',
                        cursor: 'pointer',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        color: isDark ? '#9ca3af' : '#64748b',
                        transition: 'all 0.2s'
                    }}
                    onMouseOver={e => { e.currentTarget.style.background = '#3b82f6'; e.currentTarget.style.color = '#fff'; }}
                    onMouseOut={e => { e.currentTarget.style.background = isDark ? '#374151' : '#fff'; e.currentTarget.style.color = isDark ? '#9ca3af' : '#64748b'; }}
                >
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                        <path d="M18 15l-6-6-6 6"/>
                    </svg>
                </button>
                <button
                    onClick={() => document.querySelector('.intake-table-container')?.scrollIntoView({ behavior: 'smooth', block: 'start' })}
                    title="Go to Intake Records"
                    style={{
                        width: '36px',
                        height: '36px',
                        borderRadius: '8px',
                        border: isDark ? '1px solid #4b5563' : '1px solid #e2e8f0',
                        background: isDark ? '#374151' : '#fff',
                        cursor: 'pointer',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        color: isDark ? '#9ca3af' : '#64748b',
                        fontSize: '16px',
                        transition: 'all 0.2s'
                    }}
                    onMouseOver={e => { e.currentTarget.style.background = '#10b981'; e.currentTarget.style.color = '#fff'; }}
                    onMouseOut={e => { e.currentTarget.style.background = isDark ? '#374151' : '#fff'; e.currentTarget.style.color = isDark ? '#9ca3af' : '#64748b'; }}
                >
                    üìã
                </button>
                <button
                    onClick={() => window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' })}
                    title="Scroll to Bottom"
                    style={{
                        width: '36px',
                        height: '36px',
                        borderRadius: '8px',
                        border: isDark ? '1px solid #4b5563' : '1px solid #e2e8f0',
                        background: isDark ? '#374151' : '#fff',
                        cursor: 'pointer',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        color: isDark ? '#9ca3af' : '#64748b',
                        transition: 'all 0.2s'
                    }}
                    onMouseOver={e => { e.currentTarget.style.background = '#3b82f6'; e.currentTarget.style.color = '#fff'; }}
                    onMouseOut={e => { e.currentTarget.style.background = isDark ? '#374151' : '#fff'; e.currentTarget.style.color = isDark ? '#9ca3af' : '#64748b'; }}
                >
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                        <path d="M6 9l6 6 6-6"/>
                    </svg>
                </button>
            </div>

            {/* Error Notification */}
            {error && (
                <div className="intake-error-banner" style={{ 
                    backgroundColor: isDark ? 'rgba(239, 68, 68, 0.15)' : '#fef2f2', 
                    border: isDark ? '1px solid rgba(239, 68, 68, 0.3)' : '1px solid #fecaca', 
                    borderRadius: '8px', 
                    padding: '12px 16px', 
                    marginBottom: '16px',
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center'
                }}>
                    <span style={{ color: isDark ? '#f87171' : '#dc2626' }}>{error}</span>
                    <button 
                        onClick={clearError}
                        style={{ 
                            background: 'none', 
                            border: 'none', 
                            color: '#dc2626', 
                            cursor: 'pointer',
                            padding: '4px'
                        }}
                    >
                        {Icons.x}
                    </button>
                </div>
            )}

            {/* Action Loading Overlay */}
            {actionLoading && (
                <div style={{ 
                    position: 'fixed', 
                    top: 0, 
                    left: 0, 
                    right: 0, 
                    bottom: 0, 
                    backgroundColor: isDark ? 'rgba(15, 23, 42, 0.7)' : 'rgba(255,255,255,0.7)', 
                    display: 'flex', 
                    justifyContent: 'center', 
                    alignItems: 'center', 
                    zIndex: 9999 
                }}>
                    <div style={{ 
                        width: '40px', 
                        height: '40px', 
                        border: isDark ? '3px solid #374151' : '3px solid #e2e8f0', 
                        borderTopColor: '#3b82f6', 
                        borderRadius: '50%', 
                        animation: 'spin 0.8s linear infinite' 
                    }}></div>
                </div>
            )}

            {/* Action Bar */}
            <div className="intake-action-bar">
                <div className="action-bar-primary">
                    {canCreate('vehicle-intake') && <button className="action-btn action-btn-primary" onClick={() => setShowAddModal(true)}>
                        {Icons.plus}
                        <span>Add Item</span>
                    </button>}
                    <button className="action-btn action-btn-secondary" disabled={queue.length === 0}>
                        {Icons.package}
                        <span>Assign Service</span>
                    </button>
                    <button className="action-btn action-btn-secondary" disabled={queue.length === 0}>
                        {Icons.arrowRight}
                        <span>Send to Queue</span>
                    </button>
                    <button className="action-btn action-btn-danger" disabled={queue.length === 0}>
                        {Icons.pause}
                        <span>Hold</span>
                    </button>
                </div>
                <div className="action-bar-secondary">
                    <button className="action-btn action-btn-ghost">
                        {Icons.scan}
                        <span>Scan Plate</span>
                    </button>
                    <button className="action-btn action-btn-ghost">
                        {Icons.star}
                        <span>Priority Tag</span>
                    </button>
                    <button className="action-btn action-btn-ghost" onClick={() => window.location.reload()}>
                        {Icons.refresh}
                        <span>Refresh</span>
                    </button>
                </div>
            </div>

            {/* Stat Cards - Compact One-Line */}
            <div className="intake-stats">
                <div className="intake-stat-card">
                    <span className="intake-stat-label">Waiting</span>
                    <span className="intake-stat-value">{stats.waiting}</span>
                </div>
                <div className="intake-stat-card">
                    <span className="intake-stat-label">In Progress</span>
                    <span className="intake-stat-value">{stats.inProgress}</span>
                </div>
                <div className="intake-stat-card">
                    <span className="intake-stat-label">Available Bays</span>
                    <span className="intake-stat-value">{stats.availableBays}</span>
                </div>
                <div className="intake-stat-card">
                    <span className="intake-stat-label">Avg Wait</span>
                    <span className="intake-stat-value">{stats.avgWaitTime}m</span>
                </div>
            </div>

            {/* Queue Section */}
            <div className="intake-section">
                <div className="intake-section-header">
                    <h3>Queue</h3>
                    <span className="intake-section-count">{queue.length} items</span>
                </div>
                <div className="intake-queue">
                    {!Array.isArray(queue) || queue.length === 0 ? (
                        <div className="intake-empty">
                            <p>No items in queue</p>
                            {canCreate('vehicle-intake') && <button className="action-btn action-btn-primary" onClick={() => setShowAddModal(true)}>
                                {Icons.plus} Add Item
                            </button>}
                        </div>
                    ) : (
                        queue.filter(v => v != null).map((vehicle, index) => {
                            const existingVisits = vehicle?.existingVisits || 0;
                            const isReturning = vehicle?.isReturningVehicle || existingVisits >= 1;
                            const isOnHold = vehicle?.isOnHold || false;
                            return (
                            <div 
                                key={vehicle.id} 
                                className={`queue-card ${isOnHold ? 'queue-card-on-hold' : ''}`} 
                                style={{ 
                                    borderLeft: isOnHold ? '3px solid #f59e0b' : (isReturning ? '3px solid #16a34a' : undefined),
                                    opacity: isOnHold ? 0.75 : 1,
                                    background: isOnHold 
                                        ? (isDark ? 'rgba(245, 158, 11, 0.2)' : '#fef3c7') 
                                        : (isReturning ? (isDark ? 'rgba(34, 197, 94, 0.1)' : undefined) : undefined)
                                }}
                            >
                                <div className="queue-card-header">
                                    <span className="queue-card-plate">
                                        {INTAKE_CATEGORIES.find(c => c.id === vehicle.category)?.icon || 'üöó'} {vehicle.plateNumber}
                                        {isOnHold && (
                                            <span style={{
                                                marginLeft: '6px',
                                                fontSize: '9px',
                                                padding: '2px 6px',
                                                background: isDark ? 'rgba(251, 191, 36, 0.3)' : '#fbbf24',
                                                color: isDark ? '#fcd34d' : '#78350f',
                                                borderRadius: '8px',
                                                fontWeight: '600'
                                            }}>
                                                ‚è∏Ô∏è ON HOLD
                                            </span>
                                        )}
                                        {isReturning && !isOnHold && (
                                            <span style={{
                                                marginLeft: '6px',
                                                fontSize: '9px',
                                                padding: '2px 6px',
                                                background: isDark ? 'rgba(34, 197, 94, 0.3)' : '#dcfce7',
                                                color: isDark ? '#4ade80' : '#166534',
                                                borderRadius: '8px',
                                                fontWeight: '600'
                                            }}>
                                                üîÑ RETURNING (Visit #{existingVisits + 1})
                                            </span>
                                        )}
                                    </span>
                                    <span 
                                        className="queue-card-priority" 
                                        style={{ backgroundColor: getPriorityColor(vehicle.priority) }}
                                    >
                                        {(vehicle.priority || 'normal').toUpperCase()}
                                    </span>
                                </div>
                                <div className="queue-card-body">
                                    <div className="queue-card-info">
                                        <span className="queue-card-service">{vehicle.service?.name || 'No Service'}</span>
                                        <span className="queue-card-time">{Icons.clock} {formatTimeElapsed(vehicle.timeIn)}</span>
                                    </div>
                                    <span className="queue-card-type">{vehicle.itemType || vehicle.vehicleType}</span>
                                </div>
                                <div className="queue-card-actions">
                                    <button 
                                        className={`queue-action-btn ${isOnHold ? 'queue-action-resume' : 'queue-action-hold'}`}
                                        onClick={() => handleToggleHold(vehicle)}
                                        title={isOnHold ? 'Resume' : 'Put on Hold'}
                                        style={{
                                            background: isOnHold ? '#22c55e' : '#f59e0b',
                                            color: 'white',
                                            border: 'none',
                                            minWidth: '38px'
                                        }}
                                    >
                                        {isOnHold ? Icons.play : Icons.pause}
                                    </button>
                                    <button 
                                        className="queue-action-btn queue-action-primary"
                                        onClick={() => openAssignModal(vehicle)}
                                        disabled={isOnHold}
                                        title={isOnHold ? 'Resume first to assign' : 'Assign Bay'}
                                    >
                                        Assign Bay
                                    </button>
                                    <button 
                                        className="queue-action-btn"
                                        onClick={() => handleSendToGarage(vehicle)}
                                        disabled={isOnHold}
                                        title={isOnHold ? 'Resume first to send to garage' : 'Send to Garage'}
                                    >
                                        Garage
                                    </button>
                                    <button 
                                        className="queue-action-btn queue-action-danger"
                                        onClick={() => handleRemoveFromQueue(vehicle.id)}
                                    >
                                        Remove
                                    </button>
                                </div>
                            </div>
                        );})
                    )}
                </div>
            </div>

            {/* Vehicle Management Table */}
            <div className="intake-section">
                <div className="intake-section-header" style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', flexWrap: 'wrap', gap: '12px' }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                        <h3 style={{ margin: 0 }}>Intake Records</h3>
                        <span className="intake-section-count">{filteredVehicles.length} of {vehicles.length}</span>
                    </div>
                    
                    {/* Search and Filter Bar */}
                    <div style={{ display: 'flex', gap: '12px', alignItems: 'center' }}>
                        {/* Search Input */}
                        <div style={{ position: 'relative', minWidth: '200px' }}>
                            <input
                                type="text"
                                placeholder="Search..."
                                value={searchQuery}
                                onChange={(e) => setSearchQuery(e.target.value)}
                                style={{
                                    width: '100%',
                                    padding: '8px 12px 8px 32px',
                                    border: isDark ? '1px solid #4b5563' : '1px solid #e2e8f0',
                                    backgroundColor: isDark ? '#1f2937' : '#fff',
                                    color: isDark ? '#e5e7eb' : 'inherit',
                                    borderRadius: '6px',
                                    fontSize: '13px',
                                    outline: 'none'
                                }}
                            />
                            <svg 
                                style={{ position: 'absolute', left: '10px', top: '50%', transform: 'translateY(-50%)', color: isDark ? '#6b7280' : '#94a3b8' }}
                                width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"
                            >
                                <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
                            </svg>
                            {searchQuery && (
                                <button 
                                    onClick={() => setSearchQuery('')}
                                    style={{ position: 'absolute', right: '6px', top: '50%', transform: 'translateY(-50%)', background: 'none', border: 'none', cursor: 'pointer', color: isDark ? '#6b7280' : '#94a3b8', padding: '2px' }}
                                >
                                    {Icons.x}
                                </button>
                            )}
                        </div>
                        
                        {/* Date Filter Buttons */}
                        <div style={{ display: 'flex', gap: '2px', backgroundColor: isDark ? 'rgba(51, 65, 85, 0.5)' : '#f1f5f9', borderRadius: '6px', padding: '3px' }}>
                            {[
                                { id: 'all', label: 'All' },
                                { id: 'today', label: 'Today' },
                                { id: 'yesterday', label: 'Yesterday' },
                                { id: 'week', label: 'Week' },
                                { id: 'month', label: 'Month' }
                            ].map(filter => (
                                <button
                                    key={filter.id}
                                    onClick={() => setDateFilter(filter.id)}
                                    style={{
                                        padding: '5px 10px',
                                        border: 'none',
                                        borderRadius: '4px',
                                        fontSize: '12px',
                                        fontWeight: '500',
                                        cursor: 'pointer',
                                        backgroundColor: dateFilter === filter.id ? (isDark ? '#475569' : '#fff') : 'transparent',
                                        color: dateFilter === filter.id ? (isDark ? '#f1f5f9' : '#1e293b') : (isDark ? '#94a3b8' : '#64748b'),
                                        boxShadow: dateFilter === filter.id ? '0 1px 2px rgba(0,0,0,0.05)' : 'none'
                                    }}
                                >
                                    {filter.label}
                                </button>
                            ))}
                        </div>
                        
                        {/* Export Button */}
                        <button
                            onClick={() => setShowExportModal(true)}
                            style={{
                                display: 'flex',
                                alignItems: 'center',
                                gap: '6px',
                                padding: '7px 14px',
                                background: '#10b981',
                                color: '#fff',
                                border: 'none',
                                borderRadius: '6px',
                                fontSize: '12px',
                                fontWeight: '600',
                                cursor: 'pointer'
                            }}
                        >
                            {Icons.download} Export
                        </button>
                    </div>
                </div>
                
                <div className="intake-table-container">
                    <table className="intake-table">
                        <thead>
                            <tr>
                                <th>ID / Plate</th>
                                <th>Category</th>
                                <th>Type</th>
                                <th>Visit #</th>
                                <th>Service</th>
                                <th>Price</th>
                                <th>Status</th>
                                <th>Payment</th>
                                <th>Time In</th>
                                <th>Time Out</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {filteredVehicles.length === 0 ? (
                                <tr>
                                    <td colSpan="11" className="intake-table-empty">
                                        {vehicles.length === 0 
                                            ? 'No intake records. Add items from the queue above.'
                                            : 'No records match your search or filter.'}
                                    </td>
                                </tr>
                            ) : (
                                paginatedVehicles.filter(v => v != null).map(vehicle => (
                                    <tr key={vehicle.id || Math.random()} style={{ 
                                        backgroundColor: vehicle.isReturningVehicle 
                                            ? (isDark ? 'rgba(34, 197, 94, 0.15)' : '#f0fdf4') 
                                            : undefined 
                                    }}>
                                        <td className="intake-table-plate">
                                            <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                                                {INTAKE_CATEGORIES.find(c => c.id === vehicle.category)?.icon || 'üöó'} {vehicle.plateNumber || 'N/A'}
                                                {vehicle.isReturningVehicle && (
                                                    <span style={{
                                                        fontSize: '9px',
                                                        padding: '2px 6px',
                                                        background: isDark ? 'rgba(34, 197, 94, 0.3)' : '#dcfce7',
                                                        color: isDark ? '#4ade80' : '#166534',
                                                        borderRadius: '8px',
                                                        fontWeight: '600'
                                                    }}>
                                                        RETURNING
                                                    </span>
                                                )}
                                            </div>
                                        </td>
                                        <td>{INTAKE_CATEGORIES.find(c => c.id === vehicle.category)?.label || 'Vehicle'}</td>
                                        <td>{vehicle.itemType || vehicle.vehicleType}</td>
                                        <td>
                                            <span
                                                style={{
                                                    display: 'inline-flex',
                                                    alignItems: 'center',
                                                    justifyContent: 'center',
                                                    minWidth: '32px',
                                                    height: '28px',
                                                    padding: '4px 10px',
                                                    background: (vehicle.visitNumber || 1) > 1 ? '#3b82f6' : '#10b981',
                                                    borderRadius: '14px',
                                                    fontSize: '13px',
                                                    fontWeight: '700',
                                                    color: '#fff',
                                                    boxShadow: '0 1px 3px rgba(0,0,0,0.2)'
                                                }}
                                                title={`Visit #${vehicle.visitNumber || 1}`}
                                            >
                                                {vehicle.visitNumber || 1}
                                            </span>
                                        </td>
                                        <td>{vehicle.service?.name || '-'}</td>
                                        <td style={{ color: isDark ? '#4ade80' : '#10b981', fontWeight: '600' }}>{getBrandingForReceipts().currencySymbol || 'KSH'} {vehicle.service?.price || 0}</td>
                                        <td>
                                            {/* Status - Dropdown for authorized users, Text badge for others */}
                                            {canChangeStatus ? (
                                                <select
                                                    value={vehicle.status || 'in-progress'}
                                                    onChange={(e) => handleStatusChange(vehicle, e.target.value)}
                                                    disabled={actionLoading}
                                                    style={{
                                                        padding: '6px 10px',
                                                        borderRadius: '6px',
                                                        border: isDark ? '1px solid #475569' : '1px solid #e2e8f0',
                                                        fontSize: '12px',
                                                        fontWeight: '500',
                                                        cursor: 'pointer',
                                                        backgroundColor: getStatusColor(vehicle.status),
                                                        color: '#fff',
                                                        outline: 'none'
                                                    }}
                                                >
                                                    <option value="in-progress" style={{ backgroundColor: '#3b82f6', color: '#fff' }}>In Progress</option>
                                                    <option value="completed" style={{ backgroundColor: '#10b981', color: '#fff' }}>Completed</option>
                                                    <option value="garage" style={{ backgroundColor: '#8b5cf6', color: '#fff' }}>Garage</option>
                                                    <option value="waiting" style={{ backgroundColor: '#f59e0b', color: '#fff' }}>Waiting</option>
                                                </select>
                                            ) : (
                                                <span style={{
                                                    padding: '6px 12px',
                                                    borderRadius: '6px',
                                                    fontSize: '12px',
                                                    fontWeight: '600',
                                                    backgroundColor: getStatusColor(vehicle.status),
                                                    color: '#fff',
                                                    display: 'inline-block',
                                                    textTransform: 'capitalize'
                                                }}>
                                                    {(vehicle.status || 'in-progress').replace('-', ' ')}
                                                </span>
                                            )}
                                        </td>
                                        <td>
                                            {/* Payment Status */}
                                            {(() => {
                                                const { isPaid } = getPaymentStatusForVehicle(vehicle);
                                                const price = vehicle.service?.price || 0;
                                                return isPaid ? (
                                                    <span style={{
                                                        display: 'inline-flex',
                                                        alignItems: 'center',
                                                        gap: '4px',
                                                        padding: '4px 10px',
                                                        borderRadius: '12px',
                                                        fontSize: '11px',
                                                        fontWeight: '600',
                                                        backgroundColor: isDark ? 'rgba(16, 185, 129, 0.2)' : '#d1fae5',
                                                        color: isDark ? '#4ade80' : '#059669'
                                                    }}>
                                                        ‚úì Paid
                                                    </span>
                                                ) : (
                                                    <span style={{
                                                        display: 'inline-flex',
                                                        alignItems: 'center',
                                                        gap: '4px',
                                                        padding: '4px 10px',
                                                        borderRadius: '12px',
                                                        fontSize: '11px',
                                                        fontWeight: '600',
                                                        backgroundColor: isDark ? 'rgba(245, 158, 11, 0.2)' : '#fef3c7',
                                                        color: isDark ? '#fcd34d' : '#d97706'
                                                    }}>
                                                        üí∞ Awaiting
                                                    </span>
                                                );
                                            })()}
                                        </td>
                                        <td>{formatTime(vehicle.timeIn)}</td>
                                        <td>{formatTime(vehicle.timeOut)}</td>
                                        <td>
                                            <div className="intake-table-actions">
                                                <button 
                                                    className="table-action-btn" 
                                                    title="View Details"
                                                    onClick={() => openViewModal(vehicle)}
                                                >
                                                    {Icons.eye}
                                                </button>
                                                <button 
                                                    className="table-action-btn" 
                                                    title="Edit Vehicle"
                                                    onClick={() => openEditModal(vehicle)}
                                                >
                                                    {Icons.edit}
                                                </button>
                                                {/* Customer Items Notes Button */}
                                                <button 
                                                    className="table-action-btn" 
                                                    title={vehicle.customerItems ? 'View/Edit Items (' + vehicle.customerItems.split('\n').filter(i => i.trim()).length + ')' : 'Add Customer Items'}
                                                    onClick={() => openItemsNotesModal(vehicle)}
                                                    style={{ 
                                                        color: vehicle.customerItems ? '#f59e0b' : '#94a3b8',
                                                        position: 'relative'
                                                    }}
                                                >
                                                    üìã
                                                    {vehicle.customerItems && (
                                                        <span style={{
                                                            position: 'absolute',
                                                            top: '-2px',
                                                            right: '-2px',
                                                            width: '8px',
                                                            height: '8px',
                                                            backgroundColor: '#f59e0b',
                                                            borderRadius: '50%'
                                                        }}></span>
                                                    )}
                                                </button>
                                                {/* Visit History Button */}
                                                <button 
                                                    className="table-action-btn" 
                                                    title={`Visit History (${getVehicleVisitCount(vehicle.plateNumber)} visits)`}
                                                    onClick={() => openHistoryModal(vehicle.plateNumber)}
                                                    style={{ color: getVehicleVisitCount(vehicle.plateNumber) > 0 ? '#0284c7' : '#94a3b8' }}
                                                >
                                                    {Icons.clock}
                                                </button>
                                                <button 
                                                    className="table-action-btn" 
                                                    title="Print Receipt"
                                                    onClick={() => printReceipt(vehicle)}
                                                    style={{ color: '#6366f1' }}
                                                >
                                                    {Icons.printer}
                                                </button>
                                                {/* Mark as Paid button - show if not already paid and user has change-status permission */}
                                                {vehicle.paymentStatus !== 'paid' && canChangeStatus && (
                                                    <button 
                                                        className="table-action-btn" 
                                                        title="Mark as Paid"
                                                        onClick={() => handleMarkAsPaid(vehicle)}
                                                        disabled={actionLoading}
                                                        style={{ color: '#10b981', fontWeight: '600' }}
                                                    >
                                                        üí∞
                                                    </button>
                                                )}
                                                {vehicle.status !== 'completed' && canChangeStatus && (
                                                    <button 
                                                        className="table-action-btn table-action-complete" 
                                                        title="Mark Complete"
                                                        onClick={() => handleComplete(vehicle)}
                                                        disabled={actionLoading}
                                                    >
                                                        {Icons.check}
                                                    </button>
                                                )}
                                                {vehicle.status === 'completed' && (
                                                    <button 
                                                        className="table-action-btn" 
                                                        title="View Invoice"
                                                        onClick={() => openInvoiceModal(vehicle)}
                                                    >
                                                        {Icons.fileText}
                                                    </button>
                                                )}
                                            </div>
                                        </td>
                                    </tr>
                                ))
                            )}
                        </tbody>
                    </table>
                </div>
                
                {/* Pagination Controls */}
                {filteredVehicles.length > 0 && (
                    <div style={{
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'center',
                        padding: '12px 16px',
                        borderTop: isDark ? '1px solid #374151' : '1px solid #e2e8f0',
                        backgroundColor: isDark ? '#1f2937' : '#f8fafc',
                        borderRadius: '0 0 8px 8px',
                        flexWrap: 'wrap',
                        gap: '12px'
                    }}>
                        {/* Left side - showing info */}
                        <div style={{ display: 'flex', alignItems: 'center', gap: '16px', fontSize: '13px', color: isDark ? '#9ca3af' : '#64748b' }}>
                            <span>Showing {startIndex + 1}-{Math.min(endIndex, filteredVehicles.length)} of {filteredVehicles.length}</span>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                                <span>Per page:</span>
                                <select
                                    value={itemsPerPage}
                                    onChange={(e) => {
                                        setItemsPerPage(Number(e.target.value));
                                        setCurrentPage(1);
                                    }}
                                    style={{
                                        padding: '4px 8px',
                                        border: isDark ? '1px solid #4b5563' : '1px solid #e2e8f0',
                                        borderRadius: '4px',
                                        fontSize: '13px',
                                        cursor: 'pointer',
                                        backgroundColor: isDark ? '#374151' : '#fff',
                                        color: isDark ? '#e5e7eb' : 'inherit'
                                    }}
                                >
                                    <option value={5}>5</option>
                                    <option value={10}>10</option>
                                    <option value={20}>20</option>
                                    <option value={50}>50</option>
                                    <option value={100}>100</option>
                                </select>
                            </div>
                        </div>
                        
                        {/* Right side - page navigation */}
                        <div style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                            <button
                                onClick={() => setCurrentPage(1)}
                                disabled={currentPage === 1}
                                style={{
                                    padding: '6px 10px',
                                    border: isDark ? '1px solid #4b5563' : '1px solid #e2e8f0',
                                    borderRadius: '4px',
                                    backgroundColor: currentPage === 1 ? (isDark ? '#374151' : '#f1f5f9') : (isDark ? '#1f2937' : '#fff'),
                                    color: currentPage === 1 ? (isDark ? '#6b7280' : '#94a3b8') : (isDark ? '#e5e7eb' : '#1e293b'),
                                    cursor: currentPage === 1 ? 'not-allowed' : 'pointer',
                                    fontSize: '12px',
                                    fontWeight: '500'
                                }}
                            >
                                First
                            </button>
                            <button
                                onClick={() => setCurrentPage(p => Math.max(1, p - 1))}
                                disabled={currentPage === 1}
                                style={{
                                    padding: '6px 12px',
                                    border: isDark ? '1px solid #4b5563' : '1px solid #e2e8f0',
                                    borderRadius: '4px',
                                    backgroundColor: currentPage === 1 ? (isDark ? '#374151' : '#f1f5f9') : (isDark ? '#1f2937' : '#fff'),
                                    color: currentPage === 1 ? (isDark ? '#6b7280' : '#94a3b8') : (isDark ? '#e5e7eb' : '#1e293b'),
                                    cursor: currentPage === 1 ? 'not-allowed' : 'pointer',
                                    fontSize: '14px'
                                }}
                            >
                                ‚Äπ
                            </button>
                            
                            {/* Page numbers */}
                            {(() => {
                                const pages = [];
                                const maxVisible = 5;
                                let start = Math.max(1, currentPage - Math.floor(maxVisible / 2));
                                let end = Math.min(totalPages, start + maxVisible - 1);
                                if (end - start + 1 < maxVisible) {
                                    start = Math.max(1, end - maxVisible + 1);
                                }
                                
                                for (let i = start; i <= end; i++) {
                                    pages.push(
                                        <button
                                            key={i}
                                            onClick={() => setCurrentPage(i)}
                                            style={{
                                                padding: '6px 12px',
                                                border: '1px solid',
                                                borderColor: currentPage === i ? '#3b82f6' : (isDark ? '#4b5563' : '#e2e8f0'),
                                                borderRadius: '4px',
                                                backgroundColor: currentPage === i ? '#3b82f6' : (isDark ? '#1f2937' : '#fff'),
                                                color: currentPage === i ? '#fff' : (isDark ? '#e5e7eb' : '#1e293b'),
                                                cursor: 'pointer',
                                                fontSize: '13px',
                                                fontWeight: currentPage === i ? '600' : '400',
                                                minWidth: '36px'
                                            }}
                                        >
                                            {i}
                                        </button>
                                    );
                                }
                                return pages;
                            })()}
                            
                            <button
                                onClick={() => setCurrentPage(p => Math.min(totalPages, p + 1))}
                                disabled={currentPage === totalPages}
                                style={{
                                    padding: '6px 12px',
                                    border: isDark ? '1px solid #4b5563' : '1px solid #e2e8f0',
                                    borderRadius: '4px',
                                    backgroundColor: currentPage === totalPages ? (isDark ? '#374151' : '#f1f5f9') : (isDark ? '#1f2937' : '#fff'),
                                    color: currentPage === totalPages ? (isDark ? '#6b7280' : '#94a3b8') : (isDark ? '#e5e7eb' : '#1e293b'),
                                    cursor: currentPage === totalPages ? 'not-allowed' : 'pointer',
                                    fontSize: '14px'
                                }}
                            >
                                ‚Ä∫
                            </button>
                            <button
                                onClick={() => setCurrentPage(totalPages)}
                                disabled={currentPage === totalPages}
                                style={{
                                    padding: '6px 10px',
                                    border: isDark ? '1px solid #4b5563' : '1px solid #e2e8f0',
                                    borderRadius: '4px',
                                    backgroundColor: currentPage === totalPages ? (isDark ? '#374151' : '#f1f5f9') : (isDark ? '#1f2937' : '#fff'),
                                    color: currentPage === totalPages ? (isDark ? '#6b7280' : '#94a3b8') : (isDark ? '#e5e7eb' : '#1e293b'),
                                    cursor: currentPage === totalPages ? 'not-allowed' : 'pointer',
                                    fontSize: '12px',
                                    fontWeight: '500'
                                }}
                            >
                                Last
                            </button>
                        </div>
                    </div>
                )}
            </div>

            {/* Add Item Modal */}
            {showAddModal && (
                <div className="modal-overlay" onClick={() => setShowAddModal(false)}>
                    <div className="modal" onClick={e => e.stopPropagation()}>
                        <div className="modal-header">
                            <h2>Add to Queue</h2>
                            <button className="modal-close" onClick={() => { setShowAddModal(false); setShowPlateSearchResults(false); setSelectedExistingVehicle(null); }}>
                                {Icons.x}
                            </button>
                        </div>
                        <div className="modal-body">
                            <div className="form-group">
                                <label>Category</label>
                                <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                                    {INTAKE_CATEGORIES.map(cat => (
                                        <button
                                            key={cat.id}
                                            type="button"
                                            onClick={() => {
                                                const newCategory = cat.id;
                                                const autoId = newCategory !== 'vehicle' ? generateNextId(newCategory) : '';
                                                setFormData({
                                                    ...formData, 
                                                    category: newCategory, 
                                                    itemType: ITEM_TYPES[newCategory][0],
                                                    plateNumber: autoId
                                                });
                                                setSelectedExistingVehicle(null);
                                                setShowPlateSearchResults(false);
                                            }}
                                            style={{
                                                padding: '8px 12px',
                                                border: formData.category === cat.id ? '2px solid #3b82f6' : '1px solid #e5e7eb',
                                                borderRadius: '8px',
                                                background: formData.category === cat.id ? '#eff6ff' : '#fff',
                                                cursor: 'pointer',
                                                display: 'flex',
                                                alignItems: 'center',
                                                gap: '6px',
                                                fontSize: '13px',
                                                fontWeight: formData.category === cat.id ? '600' : '400'
                                            }}
                                        >
                                            <span>{cat.icon}</span>
                                            <span>{cat.label}</span>
                                        </button>
                                    ))}
                                </div>
                            </div>
                            <div className="form-group">
                                <label>{formData.category === 'vehicle' ? 'Plate Number * (Search existing)' : 'ID (Auto-generated)'}</label>
                                {formData.category === 'vehicle' ? (
                                    <div style={{ position: 'relative' }}>
                                        <div style={{ position: 'relative' }}>
                                            <input 
                                                type="text" 
                                                value={formData.plateNumber}
                                                onChange={e => handlePlateInputChange(e.target.value.toUpperCase())}
                                                placeholder="TYPE PLATE NUMBER..."
                                                autoFocus
                                                style={{
                                                    paddingRight: '90px',
                                                    borderColor: selectedExistingVehicle ? '#10b981' : undefined,
                                                    backgroundColor: selectedExistingVehicle ? '#f0fdf4' : undefined,
                                                    textTransform: 'uppercase',
                                                    fontWeight: '600',
                                                    letterSpacing: '1px'
                                                }}
                                            />
                                            {selectedExistingVehicle && (
                                                <div style={{
                                                    position: 'absolute',
                                                    right: '10px',
                                                    top: '50%',
                                                    transform: 'translateY(-50%)',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    gap: '4px',
                                                    fontSize: '11px',
                                                    color: '#16a34a',
                                                    fontWeight: '600'
                                                }}>
                                                    {Icons.check} Returning
                                                </div>
                                            )}
                                        </div>
                                        
                                        {/* Search Results Dropdown */}
                                        {showPlateSearchResults && plateSearchResults.length > 0 && (
                                            <div style={{
                                                position: 'absolute',
                                                top: '100%',
                                                left: 0,
                                                right: 0,
                                                background: '#fff',
                                                border: '1px solid #e2e8f0',
                                                borderRadius: '8px',
                                                boxShadow: '0 4px 12px rgba(0,0,0,0.1)',
                                                zIndex: 100,
                                                maxHeight: '200px',
                                                overflowY: 'auto',
                                                marginTop: '4px'
                                            }}>
                                                <div style={{ padding: '8px 12px', background: '#f8fafc', borderBottom: '1px solid #e2e8f0', fontSize: '11px', color: '#64748b', fontWeight: '600' }}>
                                                    EXISTING VEHICLES ({plateSearchResults.length})
                                                </div>
                                                {plateSearchResults.map(record => (
                                                    <div
                                                        key={record.id}
                                                        onClick={() => selectExistingVehicle(record)}
                                                        style={{
                                                            padding: '10px 12px',
                                                            cursor: 'pointer',
                                                            borderBottom: '1px solid #f1f5f9',
                                                            display: 'flex',
                                                            justifyContent: 'space-between',
                                                            alignItems: 'center'
                                                        }}
                                                        onMouseOver={e => e.currentTarget.style.backgroundColor = '#f8fafc'}
                                                        onMouseOut={e => e.currentTarget.style.backgroundColor = '#fff'}
                                                    >
                                                        <div>
                                                            <div style={{ fontWeight: '600', color: '#1e293b' }}>{record.plateNumber}</div>
                                                            <div style={{ fontSize: '11px', color: '#64748b' }}>
                                                                {record.itemType || record.vehicleType || 'Unknown'} ‚Ä¢ {record.customerName || 'No name'}
                                                            </div>
                                                        </div>
                                                        <div style={{ textAlign: 'right' }}>
                                                            <div style={{ fontSize: '12px', fontWeight: '600', color: record.visitNumber >= 1 ? '#16a34a' : '#0284c7' }}>
                                                                Visit #{record.visitNumber || 1}
                                                            </div>
                                                            <div style={{ fontSize: '10px', color: '#64748b' }}>
                                                                {record.service?.name || 'No service'}
                                                            </div>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        )}

                                        {/* Existing Vehicle Info Card */}
                                        {selectedExistingVehicle && (
                                            <div style={{
                                                marginTop: '10px',
                                                padding: '12px',
                                                background: (selectedExistingVehicle.visitNumber || selectedExistingVehicle.totalVisits || 0) >= 1 ? '#f0fdf4' : '#f8fafc',
                                                border: (selectedExistingVehicle.visitNumber || selectedExistingVehicle.totalVisits || 0) >= 1 ? '1px solid #bbf7d0' : '1px solid #e2e8f0',
                                                borderRadius: '8px'
                                            }}>
                                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' }}>
                                                    <span style={{ fontSize: '12px', fontWeight: '600', color: (selectedExistingVehicle.visitNumber || selectedExistingVehicle.totalVisits || 0) >= 1 ? '#16a34a' : '#64748b' }}>
                                                        {(selectedExistingVehicle.visitNumber || selectedExistingVehicle.totalVisits || 0) >= 1 ? 'üîÑ RETURNING CUSTOMER' : 'üÜï NEW CUSTOMER'}
                                                    </span>
                                                    <button 
                                                        onClick={() => { setSelectedExistingVehicle(null); setFormData({...formData, customerName: '', customerPhone: ''}); }}
                                                        style={{ background: 'none', border: 'none', cursor: 'pointer', color: '#64748b', fontSize: '11px' }}
                                                    >
                                                        Clear
                                                    </button>
                                                </div>
                                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px', fontSize: '12px' }}>
                                                    <div><span style={{ color: '#64748b' }}>Current Visit #:</span> <strong>{selectedExistingVehicle.visitNumber || selectedExistingVehicle.totalVisits || 1}</strong></div>
                                                    <div><span style={{ color: '#64748b' }}>Last Service:</span> <strong>{selectedExistingVehicle.service?.name || selectedExistingVehicle.lastService || '-'}</strong></div>
                                                    <div style={{ gridColumn: 'span 2', color: '#0284c7', fontWeight: '600' }}>
                                                        üìù This will update to Visit #{(selectedExistingVehicle.visitNumber || selectedExistingVehicle.totalVisits || 0) + 1}
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                ) : (
                                    <div style={{ 
                                        display: 'flex', 
                                        alignItems: 'center', 
                                        gap: '10px',
                                        padding: '10px 14px',
                                        background: '#f1f5f9',
                                        borderRadius: '8px',
                                        border: '1px solid #e2e8f0'
                                    }}>
                                        <span style={{ fontSize: '16px', fontWeight: '600', color: '#1e293b' }}>
                                            {formData.plateNumber || generateNextId(formData.category)}
                                        </span>
                                        <span style={{ fontSize: '12px', color: '#64748b' }}>
                                            (Auto-assigned)
                                        </span>
                                    </div>
                                )}
                            </div>
                            <div className="form-row">
                                <div className="form-group">
                                    <label>Type</label>
                                    <select 
                                        value={formData.itemType}
                                        onChange={e => setFormData({...formData, itemType: e.target.value})}
                                    >
                                        {(ITEM_TYPES[formData.category] || ITEM_TYPES.vehicle).map(type => (
                                            <option key={type} value={type}>{type}</option>
                                        ))}
                                    </select>
                                </div>
                                <div className="form-group">
                                    <label>Service *</label>
                                    <select 
                                        value={formData.service}
                                        onChange={e => setFormData({...formData, service: e.target.value})}
                                    >
                                        {servicePackages.filter(service => 
                                            !service.appliesTo || 
                                            service.appliesTo === 'all' || 
                                            service.appliesTo === formData.category
                                        ).length > 0 ? servicePackages.filter(service => 
                                            !service.appliesTo || 
                                            service.appliesTo === 'all' || 
                                            service.appliesTo === formData.category
                                        ).map(service => (
                                            <option key={service.id} value={service.id}>
                                                {service.name} - {getBrandingForReceipts().currencySymbol || 'KES'} {service.price?.toLocaleString()}
                                            </option>
                                        )) : (
                                            <option value="">No services for this category</option>
                                        )}
                                    </select>
                                </div>
                            </div>
                            <div className="form-group">
                                <label>Priority</label>
                                <div className="priority-options">
                                    {['normal', 'vip', 'fleet'].map(p => (
                                        <button 
                                            key={p}
                                            className={`priority-option ${formData.priority === p ? 'active' : ''}`}
                                            onClick={() => setFormData({...formData, priority: p})}
                                            type="button"
                                        >
                                            {p.toUpperCase()}
                                        </button>
                                    ))}
                                </div>
                            </div>
                            <div className="form-row">
                                <div className="form-group">
                                    <label>Customer Name</label>
                                    <input 
                                        type="text" 
                                        value={formData.customerName}
                                        onChange={e => setFormData({...formData, customerName: e.target.value})}
                                        placeholder="Optional"
                                    />
                                </div>
                                <div className="form-group">
                                    <label>Phone Number *</label>
                                    <input 
                                        type="text" 
                                        value={formData.customerPhone}
                                        onChange={e => setFormData({...formData, customerPhone: e.target.value})}
                                        placeholder="Required"
                                        required
                                        style={{
                                            borderColor: !formData.customerPhone?.trim() ? '#f87171' : undefined
                                        }}
                                    />
                                </div>
                            </div>
                        </div>
                        <div className="modal-footer">
                            <button className="modal-btn modal-btn-secondary" onClick={() => setShowAddModal(false)}>
                                Cancel
                            </button>
                            <button 
                                className="modal-btn modal-btn-primary" 
                                onClick={handleAddVehicle}
                                disabled={(formData.category === 'vehicle' && !formData.plateNumber.trim()) || !formData.customerPhone?.trim()}
                            >
                                Add to Queue
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* Assign Bay Modal */}
            {showAssignModal && selectedVehicle && (
                <div className="modal-overlay" onClick={() => setShowAssignModal(false)}>
                    <div className="modal modal-small" onClick={e => e.stopPropagation()}>
                        <div className="modal-header">
                            <h2>Assign Bay & Staff</h2>
                            <button className="modal-close" onClick={() => { setShowAssignModal(false); setSelectedStaffId(''); setSelectedAdditionalServices([]); }}>
                                {Icons.x}
                            </button>
                        </div>
                        <div className="modal-body">
                            <p className="assign-vehicle-info" style={{ marginBottom: '16px', padding: '12px', background: 'var(--bg-secondary)', borderRadius: '8px' }}>
                                <strong style={{ fontSize: '16px', fontFamily: 'monospace' }}>{selectedVehicle.plateNumber}</strong>
                                <span style={{ display: 'block', fontSize: '13px', color: 'var(--text-secondary)', marginTop: '4px' }}>
                                    {selectedVehicle.service?.name || 'No Service'} ‚Ä¢ {selectedVehicle.customerName || 'Walk-in'}
                                </span>
                            </p>
                            
                            {/* Staff Assignment - Required */}
                            <div style={{ marginBottom: '16px' }}>
                                <label style={{ display: 'block', fontSize: '13px', fontWeight: '600', marginBottom: '8px', color: 'var(--text-primary)' }}>
                                    üë§ Assign Staff <span style={{ color: '#ef4444' }}>*</span>
                                </label>
                                <select 
                                    value={selectedStaffId}
                                    onChange={(e) => setSelectedStaffId(e.target.value)}
                                    style={{
                                        width: '100%',
                                        padding: '12px',
                                        border: '2px solid var(--border-color)',
                                        borderRadius: '8px',
                                        fontSize: '14px',
                                        background: 'var(--bg-primary)',
                                        color: 'var(--text-primary)',
                                        cursor: 'pointer'
                                    }}
                                >
                                    <option value="">-- Select Staff Member --</option>
                                    {staffList.map(staff => (
                                        <option key={staff.id} value={staff.id}>
                                            {staff.name} {staff.role ? `(${staff.role})` : ''}
                                        </option>
                                    ))}
                                </select>
                                {staffList.length === 0 && (
                                    <p style={{ fontSize: '12px', color: '#f59e0b', marginTop: '6px' }}>
                                        ‚ö†Ô∏è No active staff found. Add staff in Staff Management.
                                    </p>
                                )}
                            </div>
                            
                            {/* Primary Service - Required for Fleet Washes */}
                            {selectedVehicle.priority === 'fleet' && (
                                <div style={{ marginBottom: '16px' }}>
                                    <label style={{ display: 'block', fontSize: '13px', fontWeight: '600', marginBottom: '8px', color: 'var(--text-primary)' }}>
                                        üöó Select Service <span style={{ color: '#ef4444' }}>*</span>
                                    </label>
                                    <select 
                                        value={selectedFleetService ? selectedFleetService.id : ''}
                                        onChange={(e) => {
                                            const service = servicePackages.find(s => s.id === e.target.value);
                                            setSelectedFleetService(service || null);
                                            // Remove from additional services if selected as primary
                                            if (service) {
                                                setSelectedAdditionalServices(prev => prev.filter(s => s.id !== service.id));
                                            }
                                        }}
                                        style={{
                                            width: '100%',
                                            padding: '12px',
                                            border: '2px solid var(--border-color)',
                                            borderRadius: '8px',
                                            fontSize: '14px',
                                            background: 'var(--bg-primary)',
                                            color: 'var(--text-primary)',
                                            cursor: 'pointer'
                                        }}
                                    >
                                        <option value="">-- Select Service Package --</option>
                                        {servicePackages.map(service => (
                                            <option key={service.id} value={service.id}>
                                                {service.name} - {getBrandingForReceipts().currencySymbol || 'KSH'} {service.price || 0}
                                            </option>
                                        ))}
                                    </select>
                                    {servicePackages.length === 0 && (
                                        <p style={{ fontSize: '12px', color: '#f59e0b', marginTop: '6px' }}>
                                            ‚ö†Ô∏è No service packages found. Add services in Service Packages.
                                        </p>
                                    )}
                                </div>
                            )}
                            
                            {/* Additional Services - Only for Fleet Washes */}
                            {selectedVehicle.priority === 'fleet' && (
                                <div style={{ marginBottom: '16px' }}>
                                    <label style={{ display: 'block', fontSize: '13px', fontWeight: '600', marginBottom: '8px', color: 'var(--text-primary)' }}>
                                        üõ†Ô∏è Additional Services (Fleet)
                                    </label>
                                    <div style={{ 
                                        border: '2px solid var(--border-color)', 
                                        borderRadius: '8px', 
                                        maxHeight: '150px', 
                                        overflowY: 'auto',
                                        background: 'var(--bg-primary)'
                                    }}>
                                        {servicePackages.length > 0 ? servicePackages.map(service => {
                                            const isSelected = selectedAdditionalServices.some(s => s.id === service.id);
                                            const isMainService = selectedFleetService?.id === service.id;
                                            return (
                                                <label 
                                                    key={service.id}
                                                    style={{
                                                        display: 'flex',
                                                        alignItems: 'center',
                                                        padding: '10px 12px',
                                                        cursor: isMainService ? 'not-allowed' : 'pointer',
                                                        borderBottom: '1px solid var(--border-color)',
                                                        background: isSelected ? 'rgba(139, 92, 246, 0.1)' : 'transparent',
                                                        opacity: isMainService ? 0.5 : 1,
                                                        transition: 'background 0.2s'
                                                    }}
                                                >
                                                    <input 
                                                        type="checkbox"
                                                        checked={isSelected}
                                                        disabled={isMainService}
                                                        onChange={() => {
                                                            if (isMainService) return;
                                                            setSelectedAdditionalServices(prev => {
                                                                if (isSelected) {
                                                                    return prev.filter(s => s.id !== service.id);
                                                                } else {
                                                                    return [...prev, { id: service.id, name: service.name, price: service.price }];
                                                                }
                                                            });
                                                        }}
                                                        style={{ marginRight: '10px', cursor: isMainService ? 'not-allowed' : 'pointer' }}
                                                    />
                                                    <span style={{ flex: 1, fontSize: '13px', color: 'var(--text-primary)' }}>
                                                        {service.name}
                                                        {isMainService && <span style={{ color: '#8b5cf6', marginLeft: '8px', fontSize: '11px' }}>(Primary)</span>}
                                                    </span>
                                                    <span style={{ fontSize: '13px', fontWeight: '600', color: '#22c55e' }}>
                                                        {getBrandingForReceipts().currencySymbol || 'KSH'} {service.price || 0}
                                                    </span>
                                                </label>
                                            );
                                        }) : (
                                            <p style={{ padding: '12px', fontSize: '13px', color: 'var(--text-secondary)', textAlign: 'center' }}>
                                                No services available
                                            </p>
                                        )}
                                    </div>
                                    {selectedAdditionalServices.length > 0 && (
                                        <div style={{ marginTop: '8px', padding: '8px 12px', background: 'rgba(139, 92, 246, 0.1)', borderRadius: '6px' }}>
                                            <span style={{ fontSize: '12px', color: '#8b5cf6', fontWeight: '600' }}>
                                                +{selectedAdditionalServices.length} additional service(s): {getBrandingForReceipts().currencySymbol || 'KSH'} {selectedAdditionalServices.reduce((sum, s) => sum + (parseFloat(s.price) || 0), 0)}
                                            </span>
                                        </div>
                                    )}
                                </div>
                            )}
                            
                            {/* Available Bays Count */}
                            <div style={{ marginBottom: '12px', fontSize: '13px', color: 'var(--text-secondary)' }}>
                                <span style={{ color: bays.filter(b => b.status === 'available').length > 0 ? '#22c55e' : '#ef4444', fontWeight: '600' }}>
                                    {bays.filter(b => b.status === 'available').length}
                                </span> of {bays.length} bays available
                            </div>
                            
                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '12px' }}>
                                {bays.map(bay => {
                                    const isAvailable = bay.status === 'available';
                                    const isOccupied = bay.status === 'occupied';
                                    // For fleet vehicles, require service selection in addition to staff
                                    const fleetServiceRequired = selectedVehicle.priority === 'fleet' && !selectedFleetService;
                                    const canAssign = isAvailable && selectedStaffId && !fleetServiceRequired;
                                    const isMaintenance = bay.status === 'maintenance';
                                    
                                    return (
                                        <button 
                                            key={bay.id}
                                            onClick={() => canAssign && handleAssignBay(bay.id)}
                                            disabled={!canAssign}
                                            title={isAvailable && !selectedStaffId ? 'Please select a staff member first' : (fleetServiceRequired ? 'Please select a service first' : '')}
                                            style={{
                                                padding: '16px',
                                                border: canAssign ? '2px solid #22c55e' : isAvailable ? '2px solid #94a3b8' : isOccupied ? '2px solid #3b82f6' : '2px solid #f59e0b',
                                                borderRadius: '10px',
                                                background: canAssign 
                                                    ? 'linear-gradient(135deg, #f0fdf4, #dcfce7)' 
                                                    : isAvailable
                                                        ? 'linear-gradient(135deg, #f8fafc, #f1f5f9)'
                                                        : isOccupied 
                                                            ? 'linear-gradient(135deg, #eff6ff, #dbeafe)'
                                                            : 'linear-gradient(135deg, #fefce8, #fef9c3)',
                                                cursor: canAssign ? 'pointer' : 'not-allowed',
                                                opacity: canAssign ? 1 : 0.7,
                                                textAlign: 'left',
                                                transition: 'all 0.2s ease',
                                                position: 'relative',
                                                overflow: 'hidden'
                                            }}
                                        >
                                            {/* Lock icon for occupied bays */}
                                            {!isAvailable && (
                                                <span style={{ 
                                                    position: 'absolute', 
                                                    top: '8px', 
                                                    right: '8px', 
                                                    fontSize: '14px' 
                                                }}>
                                                    {isOccupied ? 'üîÑ' : 'üîß'}
                                                </span>
                                            )}
                                            
                                            <span style={{ 
                                                display: 'block', 
                                                fontSize: '15px', 
                                                fontWeight: '600', 
                                                color: isAvailable ? '#166534' : isOccupied ? '#1e40af' : '#854d0e',
                                                marginBottom: '4px'
                                            }}>
                                                {bay.name}
                                            </span>
                                            
                                            <span style={{ 
                                                display: 'inline-block',
                                                padding: '2px 8px',
                                                borderRadius: '4px',
                                                fontSize: '11px',
                                                fontWeight: '600',
                                                textTransform: 'uppercase',
                                                background: isAvailable ? '#22c55e' : isOccupied ? '#3b82f6' : '#f59e0b',
                                                color: 'white'
                                            }}>
                                                {bay.status === 'available' ? '‚úì AVAILABLE' : bay.status === 'occupied' ? 'üîÑ IN PROGRESS' : 'üîß MAINTENANCE'}
                                            </span>
                                            
                                            {bay.currentVehicle && (
                                                <span style={{ 
                                                    display: 'block', 
                                                    marginTop: '8px', 
                                                    fontSize: '12px', 
                                                    color: '#1e40af',
                                                    fontFamily: 'monospace',
                                                    fontWeight: '500'
                                                }}>
                                                    üöó {bay.currentVehicle.plateNumber}
                                                </span>
                                            )}
                                        </button>
                                    );
                                })}
                            </div>
                            
                            {/* Staff selection reminder */}
                            {bays.filter(b => b.status === 'available').length > 0 && !selectedStaffId && (
                                <div style={{ 
                                    marginTop: '16px', 
                                    padding: '12px', 
                                    background: '#fef3c7', 
                                    borderRadius: '8px', 
                                    textAlign: 'center',
                                    border: '1px solid #fcd34d'
                                }}>
                                    <span style={{ color: '#92400e', fontSize: '13px', fontWeight: '500' }}>
                                        üëÜ Please select a staff member above to enable bay assignment
                                    </span>
                                </div>
                            )}
                            
                            {bays.filter(b => b.status === 'available').length === 0 && (
                                <div style={{ 
                                    marginTop: '16px', 
                                    padding: '16px', 
                                    background: '#fef2f2', 
                                    borderRadius: '8px', 
                                    textAlign: 'center',
                                    border: '1px solid #fecaca'
                                }}>
                                    <span style={{ fontSize: '24px', display: 'block', marginBottom: '8px' }}>‚ö†Ô∏è</span>
                                    <span style={{ color: '#991b1b', fontSize: '14px', fontWeight: '500' }}>
                                        All bays are currently occupied. Please wait for a bay to become available.
                                    </span>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            )}

            {/* View Details Modal */}
            {showViewModal && selectedVehicle && (
                <div className="modal-overlay" onClick={() => setShowViewModal(false)}>
                    <div className="modal" onClick={e => e.stopPropagation()}>
                        <div className="modal-header">
                            <h2>Item Details</h2>
                            <button className="modal-close" onClick={() => setShowViewModal(false)}>
                                {Icons.x}
                            </button>
                        </div>
                        <div className="modal-body">
                            <div className="vehicle-details">
                                <div className="detail-row">
                                    <span className="detail-label">ID / Plate Number</span>
                                    <span className="detail-value" style={{ fontWeight: 'bold', fontSize: '1.2em' }}>
                                        {INTAKE_CATEGORIES.find(c => c.id === selectedVehicle.category)?.icon || 'üöó'} {selectedVehicle.plateNumber}
                                    </span>
                                </div>
                                <div className="detail-row">
                                    <span className="detail-label">Category</span>
                                    <span className="detail-value">{INTAKE_CATEGORIES.find(c => c.id === selectedVehicle.category)?.label || 'Vehicle'}</span>
                                </div>
                                <div className="detail-row">
                                    <span className="detail-label">Type</span>
                                    <span className="detail-value">{selectedVehicle.itemType || selectedVehicle.vehicleType}</span>
                                </div>
                                <div className="detail-row">
                                    <span className="detail-label">Service</span>
                                    <span className="detail-value">{selectedVehicle.service?.name || '-'} ({getBrandingForReceipts().currencySymbol || 'KSH'} {selectedVehicle.service?.price || 0})</span>
                                </div>
                                <div className="detail-row">
                                    <span className="detail-label">Priority</span>
                                    <span className="detail-value" style={{ textTransform: 'uppercase', color: getPriorityColor(selectedVehicle.priority) }}>{selectedVehicle.priority}</span>
                                </div>
                                <div className="detail-row">
                                    <span className="detail-label">Status</span>
                                    <span className="intake-status-badge" style={{ backgroundColor: getStatusColor(selectedVehicle.status) }}>
                                        {selectedVehicle.status?.replace('-', ' ')}
                                    </span>
                                </div>
                                <div className="detail-row">
                                    <span className="detail-label">Assigned Bay</span>
                                    <span className="detail-value">{selectedVehicle.assignedBay || 'Not assigned'}</span>
                                </div>
                                <div className="detail-row">
                                    <span className="detail-label">Customer Name</span>
                                    <span className="detail-value">{selectedVehicle.customerName || '-'}</span>
                                </div>
                                <div className="detail-row">
                                    <span className="detail-label">Customer Phone</span>
                                    <span className="detail-value">{selectedVehicle.customerPhone || '-'}</span>
                                </div>
                                <div className="detail-row">
                                    <span className="detail-label">Time In</span>
                                    <span className="detail-value">{selectedVehicle.timeIn ? new Date(selectedVehicle.timeIn).toLocaleString() : '-'}</span>
                                </div>
                                <div className="detail-row">
                                    <span className="detail-label">Time Out</span>
                                    <span className="detail-value">{selectedVehicle.timeOut ? new Date(selectedVehicle.timeOut).toLocaleString() : '-'}</span>
                                </div>
                            </div>
                        </div>
                        <div className="modal-footer">
                            <button 
                                className="modal-btn modal-btn-danger" 
                                onClick={() => handleDeleteRecord(selectedVehicle)}
                            >
                                Delete Record
                            </button>
                            <button 
                                className="modal-btn modal-btn-secondary" 
                                onClick={() => {
                                    setShowViewModal(false);
                                    openEditModal(selectedVehicle);
                                }}
                            >
                                Edit
                            </button>
                            <button className="modal-btn modal-btn-primary" onClick={() => setShowViewModal(false)}>
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* Edit Vehicle Modal */}
            {showEditModal && selectedVehicle && (
                <div className="modal-overlay" onClick={() => setShowEditModal(false)}>
                    <div className="modal" onClick={e => e.stopPropagation()}>
                        <div className="modal-header">
                            <h2>Edit Record</h2>
                            <button className="modal-close" onClick={() => setShowEditModal(false)}>
                                {Icons.x}
                            </button>
                        </div>
                        <div className="modal-body">
                            <div className="form-group">
                                <label>ID / Plate Number *</label>
                                <input 
                                    type="text" 
                                    value={editFormData.plateNumber}
                                    onChange={e => setEditFormData({...editFormData, plateNumber: e.target.value})}
                                    placeholder={editFormData.category === 'carpet' ? 'e.g., CARPET-001' : 'e.g., KAA 123A'}
                                />
                            </div>
                            <div className="form-group">
                                <label>Category</label>
                                <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                                    {INTAKE_CATEGORIES.map(cat => (
                                        <button
                                            key={cat.id}
                                            type="button"
                                            onClick={() => setEditFormData({
                                                ...editFormData, 
                                                category: cat.id, 
                                                itemType: ITEM_TYPES[cat.id][0]
                                            })}
                                            style={{
                                                padding: '8px 12px',
                                                border: editFormData.category === cat.id ? '2px solid #3b82f6' : '1px solid #e5e7eb',
                                                borderRadius: '8px',
                                                background: editFormData.category === cat.id ? '#eff6ff' : '#fff',
                                                cursor: 'pointer',
                                                display: 'flex',
                                                alignItems: 'center',
                                                gap: '6px',
                                                fontSize: '13px',
                                                fontWeight: editFormData.category === cat.id ? '600' : '400'
                                            }}
                                        >
                                            <span>{cat.icon}</span>
                                            <span>{cat.label}</span>
                                        </button>
                                    ))}
                                </div>
                            </div>
                            <div className="form-row">
                                <div className="form-group">
                                    <label>Type</label>
                                    <select 
                                        value={editFormData.itemType}
                                        onChange={e => setEditFormData({...editFormData, itemType: e.target.value})}
                                    >
                                        {(ITEM_TYPES[editFormData.category] || ITEM_TYPES.vehicle).map(type => (
                                            <option key={type} value={type}>{type}</option>
                                        ))}
                                    </select>
                                </div>
                                <div className="form-group">
                                    <label>Service</label>
                                    <select 
                                        value={editFormData.service}
                                        onChange={e => setEditFormData({...editFormData, service: e.target.value})}
                                    >
                                        {servicePackages.length > 0 ? servicePackages.map(service => (
                                            <option key={service.id} value={service.id}>
                                                {service.name} - {getBrandingForReceipts().currencySymbol || 'KES'} {service.price?.toLocaleString()}
                                            </option>
                                        )) : (
                                            <option value="">Loading packages...</option>
                                        )}
                                    </select>
                                </div>
                            </div>
                            <div className="form-row">
                                <div className="form-group">
                                    <label>Priority</label>
                                    <div className="priority-options">
                                        {['normal', 'vip', 'fleet'].map(p => (
                                            <button 
                                                key={p}
                                                className={`priority-option ${editFormData.priority === p ? 'active' : ''}`}
                                                onClick={() => setEditFormData({...editFormData, priority: p})}
                                                type="button"
                                            >
                                                {p.toUpperCase()}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                                <div className="form-group">
                                    <label>Status</label>
                                    <select 
                                        value={editFormData.status}
                                        onChange={e => setEditFormData({...editFormData, status: e.target.value})}
                                    >
                                        <option value="in-progress">In Progress</option>
                                        <option value="completed">Completed</option>
                                        <option value="garage">Garage</option>
                                    </select>
                                </div>
                            </div>
                            <div className="form-row">
                                <div className="form-group">
                                    <label>Customer Name</label>
                                    <input 
                                        type="text" 
                                        value={editFormData.customerName}
                                        onChange={e => setEditFormData({...editFormData, customerName: e.target.value})}
                                        placeholder="Optional"
                                    />
                                </div>
                                <div className="form-group">
                                    <label>Phone</label>
                                    <input 
                                        type="text" 
                                        value={editFormData.customerPhone}
                                        onChange={e => setEditFormData({...editFormData, customerPhone: e.target.value})}
                                        placeholder="Optional"
                                    />
                                </div>
                            </div>
                        </div>
                        <div className="modal-footer">
                            <button className="modal-btn modal-btn-secondary" onClick={() => setShowEditModal(false)}>
                                Cancel
                            </button>
                            <button 
                                className="modal-btn modal-btn-primary" 
                                onClick={handleEditVehicle}
                                disabled={!editFormData.plateNumber?.trim()}
                            >
                                Save Changes
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* Invoice Modal */}
            {showInvoiceModal && selectedVehicle && (
                <div className="modal-overlay" onClick={() => setShowInvoiceModal(false)}>
                    <div className="modal" onClick={e => e.stopPropagation()}>
                        <div className="modal-header">
                            <h2>Invoice</h2>
                            <button className="modal-close" onClick={() => setShowInvoiceModal(false)}>
                                {Icons.x}
                            </button>
                        </div>
                        <div className="modal-body">
                            <div className="invoice-content" style={{ padding: '20px', backgroundColor: '#f8fafc', borderRadius: '8px' }}>
                                {(() => {
                                    const brand = getBrandingForReceipts();
                                    return (
                                        <>
                                        <div style={{ textAlign: 'center', marginBottom: '24px' }}>
                                            {brand.logoUrl ? (
                                                <img src={brand.logoUrl} alt="Logo" style={{ width: '60px', height: '60px', objectFit: 'contain', marginBottom: '8px' }} />
                                            ) : (
                                                <div style={{ width: '60px', height: '60px', margin: '0 auto 8px', background: `linear-gradient(135deg, ${brand.primaryColor || '#3b82f6'}, ${brand.secondaryColor || '#10b981'})`, borderRadius: '12px', display: 'flex', alignItems: 'center', justifyContent: 'center', color: 'white', fontSize: '24px' }}>
                                                    üöó
                                                </div>
                                            )}
                                            <h3 style={{ margin: 0, color: '#1e293b' }}>{brand.companyName}</h3>
                                            <p style={{ margin: '4px 0', color: '#64748b', fontSize: '14px' }}>{brand.receiptHeader || 'Service Invoice'}</p>
                                            {brand.address && <p style={{ margin: '4px 0 0', color: '#94a3b8', fontSize: '12px' }}>{brand.address}{brand.city ? `, ${brand.city}` : ''}</p>}
                                            {brand.phone && <p style={{ margin: '2px 0 0', color: '#94a3b8', fontSize: '12px' }}>Tel: {brand.phone}</p>}
                                            {brand.taxPin && <p style={{ margin: '2px 0 0', color: '#94a3b8', fontSize: '12px' }}>PIN: {brand.taxPin}</p>}
                                        </div>
                                
                                        <div style={{ borderTop: '1px dashed #cbd5e1', borderBottom: '1px dashed #cbd5e1', padding: '16px 0', marginBottom: '16px' }}>
                                            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '8px' }}>
                                                <span style={{ color: '#64748b' }}>Invoice #</span>
                                                <span style={{ fontWeight: '500' }}>INV-{selectedVehicle.id?.slice(0, 8).toUpperCase()}</span>
                                            </div>
                                            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '8px' }}>
                                                <span style={{ color: '#64748b' }}>Date</span>
                                                <span>{new Date().toLocaleDateString()}</span>
                                            </div>
                                            <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                                                <span style={{ color: '#64748b' }}>Vehicle</span>
                                                <span style={{ fontWeight: '500' }}>{selectedVehicle.plateNumber}</span>
                                            </div>
                                        </div>

                                        <div style={{ marginBottom: '16px' }}>
                                            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '8px' }}>
                                                <span style={{ color: '#64748b' }}>Customer</span>
                                                <span>{selectedVehicle.customerName || 'Walk-in'}</span>
                                            </div>
                                            {selectedVehicle.customerPhone && (
                                                <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                                                    <span style={{ color: '#64748b' }}>Phone</span>
                                                    <span>{selectedVehicle.customerPhone}</span>
                                                </div>
                                            )}
                                        </div>

                                        <div style={{ borderTop: '1px solid #e2e8f0', paddingTop: '16px' }}>
                                            <h4 style={{ margin: '0 0 12px 0', color: '#1e293b' }}>Service</h4>
                                            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '8px' }}>
                                                <span>{selectedVehicle.service?.name || 'Service'}</span>
                                                <span>{brand.currencySymbol || 'KSH'} {selectedVehicle.service?.price || 0}</span>
                                            </div>
                                            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '8px' }}>
                                                <span style={{ color: '#64748b' }}>Vehicle Type</span>
                                                <span>{selectedVehicle.vehicleType}</span>
                                            </div>
                                        </div>

                                        <div style={{ borderTop: '2px solid #1e293b', marginTop: '16px', paddingTop: '16px' }}>
                                            <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: '1.2em', fontWeight: 'bold' }}>
                                                <span>Total</span>
                                                <span style={{ color: brand.primaryColor || '#10b981' }}>{brand.currencySymbol || 'KSH'} {selectedVehicle.service?.price || 0}</span>
                                            </div>
                                        </div>

                                        <div style={{ marginTop: '24px', textAlign: 'center', color: '#64748b', fontSize: '12px' }}>
                                            <p style={{ margin: 0 }}>{brand.receiptFooter || 'Thank you for choosing us!'}</p>
                                            <p style={{ margin: '4px 0 0 0' }}>Time In: {selectedVehicle.timeIn ? new Date(selectedVehicle.timeIn).toLocaleString() : '-'}</p>
                                            <p style={{ margin: '4px 0 0 0' }}>Time Out: {selectedVehicle.timeOut ? new Date(selectedVehicle.timeOut).toLocaleString() : '-'}</p>
                                        </div>
                                        </>
                                    );
                                })()}
                            </div>
                        </div>
                        <div className="modal-footer">
                            <button className="modal-btn modal-btn-secondary" onClick={() => setShowInvoiceModal(false)}>
                                Close
                            </button>
                            <button 
                                className="modal-btn modal-btn-primary" 
                                onClick={() => printReceipt(selectedVehicle)}
                            >
                                Print Invoice
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* Visit History Modal */}
            {showHistoryModal && selectedVehicleHistory && (
                <div className="modal-overlay" onClick={() => { setShowHistoryModal(false); setSelectedVehicleHistory(null); }}>
                    <div className="modal" style={{ maxWidth: '700px' }} onClick={e => e.stopPropagation()}>
                        <div className="modal-header">
                            <h2>Visit History - {selectedVehicleHistory.plateNumber}</h2>
                            <button className="modal-close" onClick={() => { setShowHistoryModal(false); setSelectedVehicleHistory(null); }}>
                                {Icons.x}
                            </button>
                        </div>
                        <div className="modal-body">
                            {/* Summary Stats */}
                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '12px', marginBottom: '20px' }}>
                                <div style={{ background: isDark ? 'rgba(14, 165, 233, 0.15)' : '#f0f9ff', borderRadius: '8px', padding: '16px', textAlign: 'center' }}>
                                    <div style={{ fontSize: '24px', fontWeight: 'bold', color: isDark ? '#38bdf8' : '#0284c7' }}>{selectedVehicleHistory.totalVisits || 0}</div>
                                    <div style={{ fontSize: '12px', color: isDark ? '#9ca3af' : '#64748b' }}>Total Visits</div>
                                </div>
                                <div style={{ background: isDark ? 'rgba(34, 197, 94, 0.15)' : '#f0fdf4', borderRadius: '8px', padding: '16px', textAlign: 'center' }}>
                                    <div style={{ fontSize: '24px', fontWeight: 'bold', color: isDark ? '#4ade80' : '#16a34a' }}>{getBrandingForReceipts().currencySymbol || 'KSH'} {(selectedVehicleHistory.totalSpent || 0).toLocaleString()}</div>
                                    <div style={{ fontSize: '12px', color: isDark ? '#9ca3af' : '#64748b' }}>Total Spent</div>
                                </div>
                                <div style={{ background: isDark ? 'rgba(139, 92, 246, 0.15)' : '#faf5ff', borderRadius: '8px', padding: '16px', textAlign: 'center' }}>
                                    <div style={{ fontSize: '14px', fontWeight: '600', color: isDark ? '#a78bfa' : '#7c3aed' }}>{selectedVehicleHistory.lastVisit ? new Date(selectedVehicleHistory.lastVisit).toLocaleDateString() : '-'}</div>
                                    <div style={{ fontSize: '12px', color: isDark ? '#9ca3af' : '#64748b' }}>Last Visit</div>
                                </div>
                            </div>

                            {/* Customer Info */}
                            {(selectedVehicleHistory.customerName || selectedVehicleHistory.customerPhone) && (
                                <div style={{ background: isDark ? '#374151' : '#f8fafc', borderRadius: '8px', padding: '12px', marginBottom: '16px' }}>
                                    <div style={{ display: 'flex', gap: '20px', fontSize: '13px' }}>
                                        {selectedVehicleHistory.customerName && (
                                            <div><span style={{ color: isDark ? '#9ca3af' : '#64748b' }}>Customer:</span> <strong>{selectedVehicleHistory.customerName}</strong></div>
                                        )}
                                        {selectedVehicleHistory.customerPhone && (
                                            <div><span style={{ color: isDark ? '#9ca3af' : '#64748b' }}>Phone:</span> <strong>{selectedVehicleHistory.customerPhone}</strong></div>
                                        )}
                                        {selectedVehicleHistory.vehicleType && (
                                            <div><span style={{ color: isDark ? '#9ca3af' : '#64748b' }}>Type:</span> <strong>{selectedVehicleHistory.vehicleType}</strong></div>
                                        )}
                                    </div>
                                </div>
                            )}

                            {/* Visit History Table */}
                            <div style={{ fontSize: '13px', fontWeight: '600', color: isDark ? '#e5e7eb' : '#1e293b', marginBottom: '8px' }}>Visit History</div>
                            <div style={{ maxHeight: '300px', overflowY: 'auto', border: isDark ? '1px solid #4b5563' : '1px solid #e2e8f0', borderRadius: '8px' }}>
                                <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '13px' }}>
                                    <thead style={{ background: isDark ? '#374151' : '#f8fafc', position: 'sticky', top: 0 }}>
                                        <tr>
                                            <th style={{ padding: '10px', textAlign: 'left', borderBottom: isDark ? '1px solid #4b5563' : '1px solid #e2e8f0', color: isDark ? '#9ca3af' : 'inherit' }}>Date</th>
                                            <th style={{ padding: '10px', textAlign: 'left', borderBottom: isDark ? '1px solid #4b5563' : '1px solid #e2e8f0', color: isDark ? '#9ca3af' : 'inherit' }}>Time</th>
                                            <th style={{ padding: '10px', textAlign: 'left', borderBottom: isDark ? '1px solid #4b5563' : '1px solid #e2e8f0', color: isDark ? '#9ca3af' : 'inherit' }}>Service</th>
                                            <th style={{ padding: '10px', textAlign: 'left', borderBottom: isDark ? '1px solid #4b5563' : '1px solid #e2e8f0', color: isDark ? '#9ca3af' : 'inherit' }}>Bay</th>
                                            <th style={{ padding: '10px', textAlign: 'right', borderBottom: isDark ? '1px solid #4b5563' : '1px solid #e2e8f0', color: isDark ? '#9ca3af' : 'inherit' }}>Amount</th>
                                            <th style={{ padding: '10px', textAlign: 'center', borderBottom: isDark ? '1px solid #4b5563' : '1px solid #e2e8f0', color: isDark ? '#9ca3af' : 'inherit' }}>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {(selectedVehicleHistory.visitHistory || []).length === 0 ? (
                                            <tr>
                                                <td colSpan="6" style={{ padding: '20px', textAlign: 'center', color: isDark ? '#9ca3af' : '#64748b' }}>
                                                    No visit history recorded yet
                                                </td>
                                            </tr>
                                        ) : (
                                            (selectedVehicleHistory.visitHistory || []).map((visit, index) => (
                                                <tr key={visit.id || index} style={{ borderBottom: isDark ? '1px solid #374151' : '1px solid #f1f5f9' }}>
                                                    <td style={{ padding: '10px' }}>{visit.date ? new Date(visit.date).toLocaleDateString() : '-'}</td>
                                                    <td style={{ padding: '10px' }}>{visit.timeIn ? new Date(visit.timeIn).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '-'}</td>
                                                    <td style={{ padding: '10px' }}>{visit.service?.name || '-'}</td>
                                                    <td style={{ padding: '10px' }}>{visit.bay || '-'}</td>
                                                    <td style={{ padding: '10px', textAlign: 'right', fontWeight: '600', color: isDark ? '#4ade80' : '#10b981' }}>{getBrandingForReceipts().currencySymbol || 'KSH'} {(visit.amount || 0).toLocaleString()}</td>
                                                    <td style={{ padding: '10px', textAlign: 'center' }}>
                                                        <span style={{
                                                            padding: '2px 8px',
                                                            borderRadius: '10px',
                                                            fontSize: '11px',
                                                            fontWeight: '500',
                                                            background: visit.status === 'completed' ? (isDark ? 'rgba(34, 197, 94, 0.2)' : '#dcfce7') : visit.status === 'in-progress' ? (isDark ? 'rgba(59, 130, 246, 0.2)' : '#dbeafe') : (isDark ? 'rgba(245, 158, 11, 0.2)' : '#fef3c7'),
                                                            color: visit.status === 'completed' ? (isDark ? '#4ade80' : '#166534') : visit.status === 'in-progress' ? (isDark ? '#60a5fa' : '#1e40af') : (isDark ? '#fcd34d' : '#92400e')
                                                        }}>
                                                            {visit.status || 'unknown'}
                                                        </span>
                                                    </td>
                                                </tr>
                                            ))
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div className="modal-footer">
                            <button className="modal-btn modal-btn-primary" onClick={() => { setShowHistoryModal(false); setSelectedVehicleHistory(null); }}>
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* Garage Services Selection Modal */}
            {showGarageModal && garageVehicle && (
                <div className="modal-overlay" onClick={() => { setShowGarageModal(false); setGarageVehicle(null); }}>
                    <div className="modal" style={{ maxWidth: '600px', maxHeight: '85vh', overflow: 'auto' }} onClick={(e) => e.stopPropagation()}>
                        <div className="modal-header">
                            <h2>üîß Send to Garage</h2>
                            <button className="modal-close" onClick={() => { setShowGarageModal(false); setGarageVehicle(null); }}>
                                {Icons.x}
                            </button>
                        </div>
                        <div className="modal-body">
                            {/* Vehicle Info */}
                            <div style={{ marginBottom: '20px', padding: '16px', background: 'var(--bg-secondary)', borderRadius: '12px', border: '1px solid var(--border-color)' }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                    <div>
                                        <span style={{ fontSize: '20px', fontWeight: '700', fontFamily: 'monospace', color: 'var(--text-primary)' }}>
                                            {garageVehicle.plateNumber}
                                        </span>
                                        <div style={{ fontSize: '13px', color: 'var(--text-secondary)', marginTop: '4px' }}>
                                            {garageVehicle.customerName || 'Walk-in'} ‚Ä¢ {garageVehicle.itemType || garageVehicle.vehicleType}
                                        </div>
                                    </div>
                                    <span style={{ padding: '4px 12px', background: '#fef3c7', color: '#92400e', borderRadius: '20px', fontSize: '12px', fontWeight: '600' }}>
                                        {garageVehicle.priority?.toUpperCase() || 'NORMAL'}
                                    </span>
                                </div>
                            </div>

                            {/* Select Services */}
                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: 'var(--text-primary)', marginBottom: '12px' }}>
                                    Select Garage Services <span style={{ color: '#ef4444' }}>*</span>
                                </label>
                                
                                {garageServices.length === 0 ? (
                                    <div style={{ padding: '24px', textAlign: 'center', background: '#fef2f2', borderRadius: '8px', color: '#991b1b' }}>
                                        <p style={{ margin: 0, fontWeight: '500' }}>No garage services available</p>
                                        <p style={{ margin: '8px 0 0', fontSize: '13px' }}>Please add services in Garage Management first.</p>
                                    </div>
                                ) : (
                                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '12px', maxHeight: '300px', overflowY: 'auto', padding: '4px' }}>
                                        {garageServices.map(service => {
                                            const isSelected = selectedGarageServices.some(s => s.id === service.id);
                                            return (
                                                <div
                                                    key={service.id}
                                                    onClick={() => toggleGarageService(service)}
                                                    style={{
                                                        padding: '14px',
                                                        border: isSelected ? '2px solid #10b981' : '1px solid var(--border-color)',
                                                        borderRadius: '8px',
                                                        cursor: 'pointer',
                                                        background: isSelected ? '#ecfdf5' : 'var(--bg-primary)',
                                                        transition: 'all 0.15s ease'
                                                    }}
                                                >
                                                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                                                        <div style={{ flex: 1 }}>
                                                            <div style={{ fontWeight: '600', color: 'var(--text-primary)', fontSize: '14px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                                                                {isSelected && <span style={{ color: '#10b981', fontWeight: '700' }}>‚úì</span>}
                                                                {service.name}
                                                            </div>
                                                            {service.duration && (
                                                                <div style={{ fontSize: '12px', color: 'var(--text-secondary)', marginTop: '4px' }}>
                                                                    ‚è±Ô∏è {service.duration} mins
                                                                </div>
                                                            )}
                                                        </div>
                                                        <div style={{ fontWeight: '700', color: isSelected ? '#059669' : '#10b981', fontSize: '14px', whiteSpace: 'nowrap' }}>
                                                            {getBrandingForReceipts().currencySymbol || 'KSh'} {(parseFloat(service.price) || 0).toLocaleString()}
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}
                                
                                {/* Selected Summary */}
                                {selectedGarageServices.length > 0 && (
                                    <div style={{ marginTop: '14px', padding: '14px 16px', background: '#ecfdf5', border: '1px solid #a7f3d0', borderRadius: '10px', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                        <span style={{ color: '#065f46', fontSize: '14px', fontWeight: '500' }}>
                                            {selectedGarageServices.length} service(s) selected
                                        </span>
                                        <span style={{ fontWeight: '700', color: '#065f46', fontSize: '18px' }}>
                                            Total: {getBrandingForReceipts().currencySymbol || 'KSh'} {getGarageServicesTotal().toLocaleString()}
                                        </span>
                                    </div>
                                )}
                            </div>

                            {/* Notes */}
                            <div>
                                <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: 'var(--text-primary)', marginBottom: '8px' }}>
                                    Notes (Optional)
                                </label>
                                <textarea
                                    value={garageNotes}
                                    onChange={(e) => setGarageNotes(e.target.value)}
                                    placeholder="Any special instructions for the garage..."
                                    rows={3}
                                    style={{
                                        width: '100%',
                                        padding: '12px',
                                        border: '2px solid var(--border-color)',
                                        borderRadius: '8px',
                                        fontSize: '14px',
                                        resize: 'vertical',
                                        background: 'var(--bg-primary)',
                                        color: 'var(--text-primary)'
                                    }}
                                />
                            </div>
                        </div>
                        <div className="modal-footer" style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <span style={{ fontSize: '13px', color: '#ef4444' }}>
                                {selectedGarageServices.length === 0 && '‚ö†Ô∏è Please select at least one service'}
                            </span>
                            <div style={{ display: 'flex', gap: '12px' }}>
                                <button
                                    className="modal-btn"
                                    onClick={() => { setShowGarageModal(false); setGarageVehicle(null); }}
                                >
                                    Cancel
                                </button>
                                <button
                                    className="modal-btn modal-btn-primary"
                                    onClick={handleConfirmSendToGarage}
                                    disabled={actionLoading || selectedGarageServices.length === 0}
                                    style={{
                                        background: selectedGarageServices.length === 0 ? '#94a3b8' : '#10b981',
                                        cursor: selectedGarageServices.length === 0 ? 'not-allowed' : 'pointer'
                                    }}
                                >
                                    {actionLoading ? 'Sending...' : `üîß Send to Garage (${getBrandingForReceipts().currencySymbol || 'KSh'} ${getGarageServicesTotal().toLocaleString()})`}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* Customer Items Notes Modal */}
            {showItemsNotesModal && itemsNotesVehicle && (
                <div className="modal-overlay" onClick={() => { setShowItemsNotesModal(false); setItemsNotesVehicle(null); }}>
                    <div className="modal" style={{ maxWidth: '500px' }} onClick={(e) => e.stopPropagation()}>
                        <div className="modal-header">
                            <h2>üìã Customer Items</h2>
                            <button className="modal-close" onClick={() => { setShowItemsNotesModal(false); setItemsNotesVehicle(null); }}>
                                {Icons.x}
                            </button>
                        </div>
                        <div className="modal-body">
                            {/* Vehicle Info */}
                            <div style={{ marginBottom: '20px', padding: '14px 16px', background: 'var(--bg-secondary)', borderRadius: '10px', border: '1px solid var(--border-color)' }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                    <div>
                                        <span style={{ fontSize: '18px', fontWeight: '700', fontFamily: 'monospace', color: 'var(--text-primary)' }}>
                                            {itemsNotesVehicle.plateNumber}
                                        </span>
                                        <div style={{ fontSize: '13px', color: 'var(--text-secondary)', marginTop: '2px' }}>
                                            {itemsNotesVehicle.customerName || 'Walk-in'} ‚Ä¢ {itemsNotesVehicle.service?.name || 'Service'}
                                        </div>
                                    </div>
                                    <span style={{
                                        padding: '4px 10px',
                                        borderRadius: '6px',
                                        fontSize: '11px',
                                        fontWeight: '600',
                                        background: itemsNotesVehicle.status === 'completed' ? '#d1fae5' : itemsNotesVehicle.status === 'in-progress' ? '#dbeafe' : '#fef3c7',
                                        color: itemsNotesVehicle.status === 'completed' ? '#059669' : itemsNotesVehicle.status === 'in-progress' ? '#2563eb' : '#d97706'
                                    }}>
                                        {itemsNotesVehicle.status?.toUpperCase() || 'PENDING'}
                                    </span>
                                </div>
                            </div>

                            {/* Items Notes Input */}
                            <div style={{ marginBottom: '16px' }}>
                                <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: 'var(--text-primary)', marginBottom: '8px' }}>
                                    üì¶ Items Left by Customer
                                </label>
                                <p style={{ fontSize: '12px', color: 'var(--text-secondary)', marginBottom: '10px', margin: '0 0 10px 0' }}>
                                    List items the customer has left in the vehicle (one per line)
                                </p>
                                <textarea
                                    value={customerItemsNotes}
                                    onChange={(e) => setCustomerItemsNotes(e.target.value)}
                                    placeholder="e.g.&#10;- Phone charger&#10;- Sunglasses&#10;- Umbrella&#10;- Laptop bag"
                                    rows={6}
                                    style={{
                                        width: '100%',
                                        padding: '12px',
                                        border: '2px solid var(--border-color)',
                                        borderRadius: '8px',
                                        fontSize: '14px',
                                        resize: 'vertical',
                                        background: 'var(--bg-primary)',
                                        color: 'var(--text-primary)',
                                        fontFamily: 'inherit',
                                        lineHeight: '1.5'
                                    }}
                                />
                            </div>

                            {/* Items Count */}
                            {customerItemsNotes && (
                                <div style={{ 
                                    padding: '10px 14px', 
                                    background: '#fef3c7', 
                                    border: '1px solid #fcd34d', 
                                    borderRadius: '8px',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '8px',
                                    marginBottom: '16px'
                                }}>
                                    <span style={{ fontSize: '16px' }}>‚ö†Ô∏è</span>
                                    <span style={{ fontSize: '13px', color: '#92400e', fontWeight: '500' }}>
                                        {customerItemsNotes.split('\n').filter(i => i.trim()).length} item(s) recorded - Remember to return upon completion
                                    </span>
                                </div>
                            )}

                            {/* Car Key Section */}
                            <div style={{ 
                                padding: '16px', 
                                background: 'var(--bg-secondary)', 
                                border: '1px solid var(--border-color)', 
                                borderRadius: '10px'
                            }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                        <span style={{ fontSize: '20px' }}>üîë</span>
                                        <span style={{ fontSize: '14px', fontWeight: '600', color: 'var(--text-primary)' }}>Car Key</span>
                                    </div>
                                    {itemsNotesVehicle.keyIssued ? (
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                            <span style={{
                                                padding: '4px 10px',
                                                background: '#d1fae5',
                                                color: '#059669',
                                                borderRadius: '6px',
                                                fontSize: '11px',
                                                fontWeight: '600'
                                            }}>
                                                ‚úÖ Issued
                                            </span>
                                            <button
                                                onClick={handleKeyRevert}
                                                disabled={actionLoading}
                                                title="Undo - Mark key as NOT issued"
                                                style={{
                                                    padding: '4px 8px',
                                                    background: '#fef2f2',
                                                    color: '#dc2626',
                                                    border: '1px solid #fecaca',
                                                    borderRadius: '6px',
                                                    fontSize: '11px',
                                                    fontWeight: '600',
                                                    cursor: 'pointer',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    gap: '4px'
                                                }}
                                            >
                                                ‚Ü©Ô∏è Undo
                                            </button>
                                        </div>
                                    ) : (
                                        <button
                                            onClick={handleKeyIssued}
                                            disabled={actionLoading}
                                            style={{
                                                padding: '6px 12px',
                                                background: '#10b981',
                                                color: 'white',
                                                border: 'none',
                                                borderRadius: '6px',
                                                fontSize: '12px',
                                                fontWeight: '600',
                                                cursor: 'pointer',
                                                display: 'flex',
                                                alignItems: 'center',
                                                gap: '4px'
                                            }}
                                        >
                                            üîë Mark as Issued
                                        </button>
                                    )}
                                </div>
                                
                                {/* Key Tag Label */}
                                <div style={{ 
                                    display: 'flex', 
                                    alignItems: 'center', 
                                    justifyContent: 'space-between',
                                    padding: '12px',
                                    background: 'white',
                                    border: '2px dashed #d1d5db',
                                    borderRadius: '8px'
                                }}>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                                        <div style={{
                                            padding: '8px 14px',
                                            background: '#f8fafc',
                                            border: '2px solid #1e293b',
                                            borderRadius: '4px',
                                            textAlign: 'center'
                                        }}>
                                            <div style={{ 
                                                fontSize: '14px', 
                                                fontWeight: '700', 
                                                fontFamily: 'monospace',
                                                letterSpacing: '1px',
                                                color: '#1e293b'
                                            }}>
                                                {itemsNotesVehicle.plateNumber}
                                            </div>
                                            <div style={{ fontSize: '9px', color: '#64748b', marginTop: '2px' }}>
                                                {itemsNotesVehicle.itemType || itemsNotesVehicle.vehicleType || 'Vehicle'}
                                            </div>
                                        </div>
                                        <div style={{ fontSize: '12px', color: 'var(--text-secondary)' }}>
                                            Key Tag Label
                                        </div>
                                    </div>
                                    <button
                                        onClick={() => printKeyTag(itemsNotesVehicle)}
                                        style={{
                                            padding: '8px 14px',
                                            background: '#3b82f6',
                                            color: 'white',
                                            border: 'none',
                                            borderRadius: '6px',
                                            fontSize: '12px',
                                            fontWeight: '600',
                                            cursor: 'pointer',
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '6px'
                                        }}
                                    >
                                        üñ®Ô∏è Print Tag
                                    </button>
                                </div>
                            </div>

                            {/* Items History Section */}
                            <div style={{ marginTop: '16px' }}>
                                <div 
                                    onClick={() => setShowItemsHistory(!showItemsHistory)}
                                    style={{ 
                                        display: 'flex', 
                                        justifyContent: 'space-between', 
                                        alignItems: 'center',
                                        padding: '10px 14px',
                                        background: 'var(--bg-secondary)',
                                        border: '1px solid var(--border-color)',
                                        borderRadius: showItemsHistory ? '8px 8px 0 0' : '8px',
                                        cursor: 'pointer'
                                    }}
                                >
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                        <span style={{ fontSize: '14px' }}>üìú</span>
                                        <span style={{ fontSize: '13px', fontWeight: '600', color: 'var(--text-primary)' }}>
                                            Previous Items History ({(itemsNotesVehicle.itemsHistory || []).length})
                                        </span>
                                    </div>
                                    <span style={{ fontSize: '12px', color: 'var(--text-secondary)' }}>
                                        {showItemsHistory ? '‚ñ≤' : '‚ñº'}
                                    </span>
                                </div>
                                
                                {showItemsHistory && (
                                    <div style={{ 
                                        border: '1px solid var(--border-color)',
                                        borderTop: 'none',
                                        borderRadius: '0 0 8px 8px',
                                        maxHeight: '200px',
                                        overflowY: 'auto'
                                    }}>
                                        {(itemsNotesVehicle.itemsHistory || []).length === 0 ? (
                                            <div style={{ padding: '16px', textAlign: 'center', color: 'var(--text-secondary)', fontSize: '13px' }}>
                                                No previous items recorded
                                            </div>
                                        ) : (
                                            <>
                                                {(itemsNotesVehicle.itemsHistory || []).slice().reverse().map((entry, idx) => (
                                                    <div key={idx} style={{ 
                                                        padding: '12px 14px', 
                                                        borderBottom: idx < (itemsNotesVehicle.itemsHistory || []).length - 1 ? '1px solid var(--border-color)' : 'none',
                                                        background: idx % 2 === 0 ? 'var(--bg-primary)' : 'var(--bg-secondary)'
                                                    }}>
                                                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '6px' }}>
                                                            <span style={{ fontSize: '11px', color: 'var(--text-secondary)' }}>
                                                                {new Date(entry.date).toLocaleDateString()} {new Date(entry.date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                                                            </span>
                                                            {entry.keyIssued && (
                                                                <span style={{ fontSize: '10px', padding: '2px 6px', background: '#d1fae5', color: '#059669', borderRadius: '4px' }}>
                                                                    üîë Key Issued
                                                                </span>
                                                            )}
                                                        </div>
                                                        <div style={{ fontSize: '12px', color: 'var(--text-primary)', whiteSpace: 'pre-wrap', lineHeight: '1.4' }}>
                                                            {entry.items || 'No items'}
                                                        </div>
                                                    </div>
                                                ))}
                                                <div style={{ padding: '10px 14px', background: '#fef2f2', borderTop: '1px solid #fecaca' }}>
                                                    <button
                                                        onClick={handleClearItemsHistory}
                                                        disabled={actionLoading}
                                                        style={{
                                                            width: '100%',
                                                            padding: '8px',
                                                            background: 'white',
                                                            border: '1px solid #fca5a5',
                                                            borderRadius: '6px',
                                                            color: '#dc2626',
                                                            fontSize: '12px',
                                                            fontWeight: '600',
                                                            cursor: 'pointer',
                                                            display: 'flex',
                                                            alignItems: 'center',
                                                            justifyContent: 'center',
                                                            gap: '6px'
                                                        }}
                                                    >
                                                        ‚úï Clear All History
                                                    </button>
                                                </div>
                                            </>
                                        )}
                                    </div>
                                )}
                            </div>
                        </div>
                        <div className="modal-footer" style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', gap: '12px' }}>
                            <div style={{ display: 'flex', gap: '8px' }}>
                                {(itemsNotesVehicle.customerItems || itemsNotesVehicle.keyIssued) && (
                                    <button
                                        className="modal-btn"
                                        onClick={handleResetForNextWash}
                                        disabled={actionLoading}
                                        style={{ 
                                            background: '#e0e7ff', 
                                            color: '#4338ca',
                                            border: 'none',
                                            fontSize: '13px'
                                        }}
                                    >
                                        üîÑ Reset for Next Wash
                                    </button>
                                )}
                            </div>
                            <div style={{ display: 'flex', gap: '12px' }}>
                                <button
                                    className="modal-btn"
                                    onClick={() => { setShowItemsNotesModal(false); setItemsNotesVehicle(null); }}
                                >
                                    Cancel
                                </button>
                                <button
                                    className="modal-btn modal-btn-primary"
                                    onClick={handleSaveItemsNotes}
                                    disabled={actionLoading}
                                    style={{ background: '#f59e0b' }}
                                >
                                    {actionLoading ? 'Saving...' : 'üíæ Save Items'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* Export Records Modal */}
            {showExportModal && (
                <div className="modal-overlay" onClick={() => setShowExportModal(false)}>
                    <div className="modal modal-small" onClick={e => e.stopPropagation()} style={{ maxWidth: '400px' }}>
                        <div className="modal-header">
                            <h2>üìÑ Export Intake Records</h2>
                            <button className="modal-close" onClick={() => setShowExportModal(false)}>
                                {Icons.x}
                            </button>
                        </div>
                        <div className="modal-body">
                            <div className="form-group">
                                <label>Select Date Range</label>
                                <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                                    {[
                                        { id: 'today', label: 'üìÖ Today', desc: 'Current day records' },
                                        { id: 'week', label: 'üìÜ This Week', desc: 'Sunday to today' },
                                        { id: 'month', label: 'üóìÔ∏è This Month', desc: 'First of month to today' },
                                        { id: 'custom', label: 'üìù Custom Range', desc: 'Select specific dates' }
                                    ].map(option => (
                                        <button
                                            key={option.id}
                                            onClick={() => setExportDateRange(option.id)}
                                            style={{
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'space-between',
                                                padding: '12px 16px',
                                                border: exportDateRange === option.id ? '2px solid #10b981' : '1px solid #e2e8f0',
                                                borderRadius: '8px',
                                                background: exportDateRange === option.id ? '#ecfdf5' : '#fff',
                                                cursor: 'pointer',
                                                textAlign: 'left'
                                            }}
                                        >
                                            <div>
                                                <div style={{ fontWeight: '600', color: '#1e293b', fontSize: '14px' }}>{option.label}</div>
                                                <div style={{ fontSize: '11px', color: '#64748b' }}>{option.desc}</div>
                                            </div>
                                            {exportDateRange === option.id && (
                                                <span style={{ color: '#10b981', fontWeight: 'bold' }}>‚úì</span>
                                            )}
                                        </button>
                                    ))}
                                </div>
                            </div>
                            
                            {/* Custom Date Range Inputs */}
                            {exportDateRange === 'custom' && (
                                <div style={{ display: 'flex', gap: '12px', marginTop: '12px' }}>
                                    <div className="form-group" style={{ flex: 1, marginBottom: 0 }}>
                                        <label>Start Date</label>
                                        <input
                                            type="date"
                                            value={exportCustomStart}
                                            onChange={e => setExportCustomStart(e.target.value)}
                                            style={{ width: '100%' }}
                                        />
                                    </div>
                                    <div className="form-group" style={{ flex: 1, marginBottom: 0 }}>
                                        <label>End Date</label>
                                        <input
                                            type="date"
                                            value={exportCustomEnd}
                                            onChange={e => setExportCustomEnd(e.target.value)}
                                            style={{ width: '100%' }}
                                        />
                                    </div>
                                </div>
                            )}
                            
                            <div style={{ marginTop: '16px', padding: '12px', background: '#f8fafc', borderRadius: '8px', fontSize: '12px', color: '#64748b' }}>
                                üí° The export will open in a new window. Use your browser's print function (Ctrl+P) to save as PDF.
                            </div>
                        </div>
                        <div className="modal-footer">
                            <button 
                                className="modal-btn modal-btn-secondary" 
                                onClick={() => setShowExportModal(false)}
                            >
                                Cancel
                            </button>
                            <button 
                                className="modal-btn modal-btn-primary" 
                                onClick={handleExportRecords}
                                disabled={exporting || (exportDateRange === 'custom' && (!exportCustomStart || !exportCustomEnd))}
                                style={{ background: '#10b981' }}
                            >
                                {exporting ? 'Generating...' : 'üìÑ Export PDF'}
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* Alert Modal */}
            <AlertModal
                isOpen={alertModal.isOpen}
                onClose={closeAlert}
                title={alertModal.title}
                message={alertModal.message}
                type={alertModal.type}
                onConfirm={alertModal.onConfirm}
                showCancel={alertModal.showCancel}
            />
        </div>
    );
}

// Vehicle Intake All Records - Sub-module for viewing all records in scrollable list
function VehicleIntakeAll({ onBackClick }) {
    const [vehicles, setVehicles] = useState([]);
    const [invoices, setInvoices] = useState([]);
    const [loading, setLoading] = useState(true);
    const [searchQuery, setSearchQuery] = useState('');
    const [dateFilter, setDateFilter] = useState('all');
    
    // Dark mode detection
    const [isDark, setIsDark] = useState(document.documentElement.getAttribute('data-theme') === 'dark');
    
    // Listen for theme changes
    useEffect(() => {
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.attributeName === 'data-theme') {
                    setIsDark(document.documentElement.getAttribute('data-theme') === 'dark');
                }
            });
        });
        observer.observe(document.documentElement, { attributes: true, attributeFilter: ['data-theme'] });
        return () => observer.disconnect();
    }, []);
    
    // Pagination state
    const [currentPage, setCurrentPage] = useState(1);
    const [itemsPerPage, setItemsPerPage] = useState(25);
    
    // Modal states
    const [showViewModal, setShowViewModal] = useState(false);
    const [showHistoryModal, setShowHistoryModal] = useState(false);
    const [showNotesModal, setShowNotesModal] = useState(false);
    const [selectedVehicle, setSelectedVehicle] = useState(null);
    const [vehicleHistory, setVehicleHistory] = useState(null);
    
    // Subscribe to data
    useEffect(() => {
        let mounted = true;
        let unsubRecords = null;
        let unsubInvoices = null;
        
        const initData = async () => {
            const services = window.FirebaseServices;
            if (!services?.intakeRecordsService) {
                setLoading(false);
                return;
            }
            
            // Subscribe to intake records
            unsubRecords = services.intakeRecordsService.subscribeToRecords(
                (data) => {
                    if (mounted) setVehicles(data || []);
                    setLoading(false);
                },
                (err) => {
                    console.error('Error loading records:', err);
                    setLoading(false);
                }
            );
            
            // Subscribe to invoices for payment status
            if (services.invoiceService) {
                unsubInvoices = services.invoiceService.subscribeToInvoices(
                    (data) => { if (mounted) setInvoices(data || []); },
                    () => {}
                );
            }
        };
        
        initData();
        return () => {
            mounted = false;
            if (unsubRecords) unsubRecords();
            if (unsubInvoices) unsubInvoices();
        };
    }, []);
    
    // View vehicle details
    const handleView = (vehicle) => {
        setSelectedVehicle(vehicle);
        setShowViewModal(true);
    };
    
    // View visit history
    const handleHistory = async (plateNumber) => {
        const services = window.FirebaseServices;
        if (services?.vehicleHistoryService) {
            try {
                const result = await services.vehicleHistoryService.getVehicleHistory(plateNumber);
                if (result.success && result.data) {
                    setVehicleHistory(result.data);
                    setShowHistoryModal(true);
                }
            } catch (err) {
                console.error('Error loading history:', err);
            }
        }
    };
    
    // View notes
    const handleNotes = (vehicle) => {
        setSelectedVehicle(vehicle);
        setShowNotesModal(true);
    };
    
    // Print receipt - same as main intake module
    const handlePrint = (vehicle) => {
        const total = vehicle.service?.price || 0;
        const receiptNumber = `ECO-${Date.now().toString().slice(-8)}`;
        const printDate = new Date().toLocaleString();
        const brand = getBrandingForReceipts();
        
        const receiptHTML = `
            <!DOCTYPE html>
            <html>
            <head>
                <title>Receipt - ${vehicle.plateNumber}</title>
                <style>
                    * { margin: 0; padding: 0; box-sizing: border-box; }
                    body { 
                        font-family: 'Courier New', monospace; 
                        width: 280px; 
                        margin: 0 auto; 
                        padding: 20px 10px;
                        background: #fff;
                    }
                    .receipt { text-align: center; }
                    .header { margin-bottom: 15px; border-bottom: 2px dashed #000; padding-bottom: 15px; }
                    .logo { font-size: 24px; font-weight: bold; margin-bottom: 5px; }
                    .tagline { font-size: 10px; color: #666; }
                    .company-info { font-size: 9px; color: #666; margin-top: 5px; }
                    .receipt-no { font-size: 11px; margin-top: 10px; }
                    .section { margin: 15px 0; text-align: left; }
                    .section-title { font-weight: bold; font-size: 12px; margin-bottom: 8px; border-bottom: 1px solid #ccc; padding-bottom: 3px; }
                    .row { display: flex; justify-content: space-between; font-size: 12px; margin: 4px 0; }
                    .row-label { color: #666; }
                    .plate { font-size: 18px; font-weight: bold; letter-spacing: 2px; margin: 10px 0; }
                    .divider { border-top: 1px dashed #000; margin: 15px 0; }
                    .total-section { margin: 15px 0; padding: 10px 0; border-top: 2px solid #000; border-bottom: 2px solid #000; }
                    .total { display: flex; justify-content: space-between; font-size: 16px; font-weight: bold; }
                    .footer { margin-top: 20px; font-size: 10px; color: #666; text-align: center; }
                    @media print {
                        body { width: 80mm; padding: 5mm; }
                        @page { margin: 0; size: 80mm auto; }
                    }
                </style>
            </head>
            <body>
                <div class="receipt">
                    <div class="header">
                        <div class="logo">üöó ${brand.companyName }</div>
                        <div class="tagline">${brand.tagline || 'Premium Car Wash Services'}</div>
                        ${brand.address ? `<div class="company-info">${brand.address}${brand.city ? ', ' + brand.city : ''}</div>` : ''}
                        ${brand.phone ? `<div class="company-info">Tel: ${brand.phone}</div>` : ''}
                        ${brand.taxPin ? `<div class="company-info">PIN: ${brand.taxPin}</div>` : ''}
                        <div class="receipt-no">${brand.receiptHeader || 'Receipt'} #${receiptNumber}</div>
                    </div>
                    
                    <div class="plate">${vehicle.plateNumber}</div>
                    
                    <div class="section">
                        <div class="section-title">VEHICLE INFO</div>
                        <div class="row">
                            <span class="row-label">Type:</span>
                            <span>${vehicle.itemType || vehicle.vehicleType || '-'}</span>
                        </div>
                        <div class="row">
                            <span class="row-label">Bay:</span>
                            <span>${vehicle.assignedBay || 'N/A'}</span>
                        </div>
                        <div class="row">
                            <span class="row-label">Status:</span>
                            <span>${(vehicle.status || 'pending').toUpperCase()}</span>
                        </div>
                    </div>
                    
                    ${vehicle.customerName ? `
                    <div class="section">
                        <div class="section-title">CUSTOMER</div>
                        <div class="row">
                            <span class="row-label">Name:</span>
                            <span>${vehicle.customerName}</span>
                        </div>
                        ${vehicle.customerPhone ? `<div class="row">
                            <span class="row-label">Phone:</span>
                            <span>${vehicle.customerPhone}</span>
                        </div>` : ''}
                    </div>
                    ` : ''}
                    
                    <div class="section">
                        <div class="section-title">SERVICE</div>
                        <div class="row">
                            <span>${vehicle.service?.name || 'Car Wash'}</span>
                            <span>${brand.currencySymbol || 'KSH'} ${total}</span>
                        </div>
                    </div>
                    
                    <div class="total-section">
                        <div class="total">
                            <span>TOTAL</span>
                            <span>${brand.currencySymbol || 'KSH'} ${total}</span>
                        </div>
                    </div>
                    
                    <div class="section" style="text-align: center;">
                        <div class="row" style="justify-content: center;">
                            <span class="row-label">Time In: ${vehicle.timeIn ? new Date(vehicle.timeIn).toLocaleString() : '-'}</span>
                        </div>
                        ${vehicle.timeOut ? `
                        <div class="row" style="justify-content: center;">
                            <span class="row-label">Time Out: ${new Date(vehicle.timeOut).toLocaleString()}</span>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div class="divider"></div>
                    
                    <div class="footer">
                        <p>${brand.receiptFooter || 'Thank you for choosing us!'}</p>
                        <p style="margin-top: 10px; font-size: 9px;">Printed: ${printDate}</p>
                    </div>
                </div>
                <script>
                    window.onload = function() { window.print(); }
                </script>
            </body>
            </html>
        `;
        
        const printWindow = window.open('', '_blank', 'width=320,height=600');
        printWindow.document.write(receiptHTML);
        printWindow.document.close();
    };
    
    // Filter and sort vehicles
    const filteredVehicles = React.useMemo(() => {
        let filtered = vehicles.filter(v => v != null);
        
        // Search filter
        if (searchQuery.trim()) {
            const query = searchQuery.toLowerCase();
            filtered = filtered.filter(v => 
                v.plateNumber?.toLowerCase()?.includes(query) ||
                v.customerName?.toLowerCase()?.includes(query) ||
                v.customerPhone?.includes(query) ||
                v.service?.name?.toLowerCase()?.includes(query)
            );
        }
        
        // Date filter
        if (dateFilter !== 'all') {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            filtered = filtered.filter(v => {
                const vehicleDate = new Date(v.timeIn);
                switch (dateFilter) {
                    case 'today': return vehicleDate >= today;
                    case 'week': 
                        const weekStart = new Date(today);
                        weekStart.setDate(weekStart.getDate() - 7);
                        return vehicleDate >= weekStart;
                    case 'month':
                        const monthStart = new Date(today);
                        monthStart.setDate(monthStart.getDate() - 30);
                        return vehicleDate >= monthStart;
                    default: return true;
                }
            });
        }
        
        // Sort by most recent
        filtered.sort((a, b) => {
            const aTime = new Date(a.updatedAt || a.timeIn || a.createdAt).getTime();
            const bTime = new Date(b.updatedAt || b.timeIn || b.createdAt).getTime();
            return bTime - aTime;
        });
        
        return filtered;
    }, [vehicles, searchQuery, dateFilter]);
    
    // Payment status helper
    const getPaymentStatus = (vehicle) => {
        if (vehicle.paymentStatus === 'paid') return true;
        const vehicleTimeIn = new Date(vehicle.timeIn);
        const matchingInvoice = invoices.find(inv => {
            if (inv.paymentStatus !== 'paid') return false;
            const invoiceTime = new Date(inv.createdAt);
            if (invoiceTime < vehicleTimeIn) return false;
            if (inv.washRecordId === vehicle.id) return true;
            if (inv.plateNumber === vehicle.plateNumber) {
                const timeDiff = invoiceTime - vehicleTimeIn;
                return timeDiff >= 0 && timeDiff < 14400000;
            }
            return false;
        });
        return !!matchingInvoice;
    };
    
    // Status color helper
    const getStatusColor = (status) => {
        switch (status) {
            case 'completed': return '#10b981';
            case 'in-progress': return '#3b82f6';
            case 'waiting': return '#f59e0b';
            case 'garage': return '#8b5cf6';
            default: return '#3b82f6';
        }
    };
    
    // Format time helper
    const formatTime = (dateString) => {
        if (!dateString) return '-';
        const date = new Date(dateString);
        return date.toLocaleString('en-US', { 
            month: 'short', day: 'numeric', 
            hour: '2-digit', minute: '2-digit' 
        });
    };
    
    // Pagination calculations
    const totalPages = Math.ceil(filteredVehicles.length / itemsPerPage);
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const paginatedVehicles = filteredVehicles.slice(startIndex, endIndex);
    
    // Reset to page 1 when filters change
    React.useEffect(() => {
        setCurrentPage(1);
    }, [searchQuery, dateFilter]);
    
    if (loading) {
        return (
            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', height: '400px' }}>
                <div style={{ textAlign: 'center' }}>
                    <div style={{ fontSize: '32px', marginBottom: '16px' }}>‚è≥</div>
                    <p style={{ color: '#64748b' }}>Loading all records...</p>
                </div>
            </div>
        );
    }
    
    return (
        <div className="intake-module" style={{ height: '100%', display: 'flex', flexDirection: 'column' }}>
            {/* Header with filters */}
            <div style={{ 
                padding: '16px 20px', 
                background: '#fff', 
                borderBottom: '1px solid #e2e8f0',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'space-between',
                flexWrap: 'wrap',
                gap: '12px'
            }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: '16px', flexWrap: 'wrap' }}>
                    <button
                        onClick={onBackClick}
                        style={{
                            display: 'flex',
                            alignItems: 'center',
                            gap: '6px',
                            padding: '8px 16px',
                            background: '#f1f5f9',
                            border: '1px solid #e2e8f0',
                            borderRadius: '6px',
                            fontSize: '13px',
                            fontWeight: '600',
                            cursor: 'pointer',
                            color: '#475569'
                        }}
                    >
                        ‚Üê Back to Intake
                    </button>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                        <span style={{ 
                            padding: '6px 14px', 
                            background: '#dbeafe', 
                            color: '#1e40af', 
                            borderRadius: '20px', 
                            fontSize: '13px', 
                            fontWeight: '600' 
                        }}>
                            {filteredVehicles.length.toLocaleString()} {searchQuery || dateFilter !== 'all' ? 'matching' : 'total'} records
                        </span>
                        {vehicles.length !== filteredVehicles.length && (
                            <span style={{ fontSize: '12px', color: '#64748b' }}>
                                (of {vehicles.length.toLocaleString()} total)
                            </span>
                        )}
                    </div>
                </div>
                
                <div style={{ display: 'flex', gap: '12px', alignItems: 'center' }}>
                    {/* Search */}
                    <div style={{ position: 'relative', minWidth: '250px' }}>
                        <input
                            type="text"
                            placeholder="Search plate, customer, service..."
                            value={searchQuery}
                            onChange={(e) => setSearchQuery(e.target.value)}
                            style={{
                                width: '100%',
                                padding: '10px 14px 10px 36px',
                                border: isDark ? '1px solid #4b5563' : '1px solid #e2e8f0',
                                backgroundColor: isDark ? '#1f2937' : '#fff',
                                color: isDark ? '#e5e7eb' : 'inherit',
                                borderRadius: '8px',
                                fontSize: '13px',
                                outline: 'none'
                            }}
                        />
                        <svg 
                            style={{ position: 'absolute', left: '12px', top: '50%', transform: 'translateY(-50%)', color: isDark ? '#6b7280' : '#94a3b8' }}
                            width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"
                        >
                            <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
                        </svg>
                    </div>
                    
                    {/* Date Filter */}
                    <div style={{ display: 'flex', gap: '2px', backgroundColor: isDark ? 'rgba(51, 65, 85, 0.5)' : '#f1f5f9', borderRadius: '6px', padding: '3px' }}>
                        {[
                            { id: 'all', label: 'All' },
                            { id: 'today', label: 'Today' },
                            { id: 'week', label: 'Week' },
                            { id: 'month', label: 'Month' }
                        ].map(filter => (
                            <button
                                key={filter.id}
                                onClick={() => setDateFilter(filter.id)}
                                style={{
                                    padding: '6px 12px',
                                    border: 'none',
                                    borderRadius: '4px',
                                    fontSize: '12px',
                                    fontWeight: '500',
                                    cursor: 'pointer',
                                    backgroundColor: dateFilter === filter.id ? (isDark ? '#475569' : '#fff') : 'transparent',
                                    color: dateFilter === filter.id ? (isDark ? '#f1f5f9' : '#1e293b') : (isDark ? '#94a3b8' : '#64748b'),
                                    boxShadow: dateFilter === filter.id ? '0 1px 2px rgba(0,0,0,0.05)' : 'none'
                                }}
                            >
                                {filter.label}
                            </button>
                        ))}
                    </div>
                </div>
            </div>
            
            {/* Scrollable Table */}
            <div style={{ flex: 1, overflow: 'auto', padding: '20px' }}>
                <div style={{
                    background: isDark ? '#1f2937' : '#fff',
                    borderRadius: '12px',
                    border: isDark ? '1px solid #374151' : '1px solid #e2e8f0',
                    overflow: 'hidden'
                }}>
                    <table className="intake-table" style={{ margin: 0, width: '100%' }}>
                        <thead style={{ position: 'sticky', top: 0, background: isDark ? '#1f2937' : '#f8fafc', zIndex: 10 }}>
                            <tr>
                                <th style={{ padding: '14px 16px', textAlign: 'left', fontWeight: '600', color: isDark ? '#9ca3af' : '#475569', borderBottom: isDark ? '2px solid #374151' : '2px solid #e2e8f0' }}>ID / Plate</th>
                                <th style={{ padding: '14px 16px', textAlign: 'left', fontWeight: '600', color: isDark ? '#9ca3af' : '#475569', borderBottom: isDark ? '2px solid #374151' : '2px solid #e2e8f0' }}>Type</th>
                                <th style={{ padding: '14px 16px', textAlign: 'left', fontWeight: '600', color: isDark ? '#9ca3af' : '#475569', borderBottom: isDark ? '2px solid #374151' : '2px solid #e2e8f0' }}>Visit #</th>
                                <th style={{ padding: '14px 16px', textAlign: 'left', fontWeight: '600', color: isDark ? '#9ca3af' : '#475569', borderBottom: isDark ? '2px solid #374151' : '2px solid #e2e8f0' }}>Service</th>
                                <th style={{ padding: '14px 16px', textAlign: 'left', fontWeight: '600', color: isDark ? '#9ca3af' : '#475569', borderBottom: isDark ? '2px solid #374151' : '2px solid #e2e8f0' }}>Price</th>
                                <th style={{ padding: '14px 16px', textAlign: 'left', fontWeight: '600', color: isDark ? '#9ca3af' : '#475569', borderBottom: isDark ? '2px solid #374151' : '2px solid #e2e8f0' }}>Status</th>
                                <th style={{ padding: '14px 16px', textAlign: 'left', fontWeight: '600', color: isDark ? '#9ca3af' : '#475569', borderBottom: isDark ? '2px solid #374151' : '2px solid #e2e8f0' }}>Payment</th>
                                <th style={{ padding: '14px 16px', textAlign: 'left', fontWeight: '600', color: isDark ? '#9ca3af' : '#475569', borderBottom: isDark ? '2px solid #374151' : '2px solid #e2e8f0' }}>Time In</th>
                                <th style={{ padding: '14px 16px', textAlign: 'left', fontWeight: '600', color: isDark ? '#9ca3af' : '#475569', borderBottom: isDark ? '2px solid #374151' : '2px solid #e2e8f0' }}>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {paginatedVehicles.map((vehicle, index) => {
                                const isPaid = getPaymentStatus(vehicle);
                                return (
                                    <tr key={vehicle.id} style={{ 
                                        background: index % 2 === 0 ? (isDark ? '#1f2937' : '#fff') : (isDark ? '#263445' : '#fafafa'),
                                        borderBottom: isDark ? '1px solid #374151' : '1px solid #f1f5f9'
                                    }}>
                                        <td style={{ padding: '14px 16px' }}>
                                            <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                                <span style={{ fontWeight: '600', fontFamily: 'monospace', fontSize: '14px' }}>
                                                    üöó {vehicle.plateNumber}
                                                </span>
                                                {vehicle.isReturningVehicle && (
                                                    <span style={{
                                                        padding: '2px 6px',
                                                        background: isDark ? 'rgba(59, 130, 246, 0.3)' : '#dbeafe',
                                                        color: isDark ? '#93c5fd' : '#1e40af',
                                                        borderRadius: '4px',
                                                        fontSize: '9px',
                                                        fontWeight: '700'
                                                    }}>
                                                        RETURNING
                                                    </span>
                                                )}
                                            </div>
                                        </td>
                                        <td style={{ padding: '14px 16px', color: isDark ? '#9ca3af' : '#64748b' }}>{vehicle.itemType || vehicle.vehicleType || '-'}</td>
                                        <td style={{ padding: '14px 16px' }}>
                                            <span style={{
                                                display: 'inline-flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                minWidth: '28px',
                                                height: '24px',
                                                padding: '2px 8px',
                                                background: (vehicle.visitNumber || 1) > 1 ? '#3b82f6' : '#10b981',
                                                borderRadius: '12px',
                                                fontSize: '12px',
                                                fontWeight: '700',
                                                color: '#fff'
                                            }}>
                                                {vehicle.visitNumber || 1}
                                            </span>
                                        </td>
                                        <td style={{ padding: '14px 16px', fontWeight: '500' }}>{vehicle.service?.name || '-'}</td>
                                        <td style={{ padding: '14px 16px', color: isDark ? '#4ade80' : '#10b981', fontWeight: '600' }}>
                                            KSH {vehicle.service?.price || 0}
                                        </td>
                                        <td style={{ padding: '14px 16px' }}>
                                            <span style={{
                                                padding: '5px 12px',
                                                borderRadius: '6px',
                                                fontSize: '11px',
                                                fontWeight: '600',
                                                backgroundColor: getStatusColor(vehicle.status),
                                                color: '#fff',
                                                textTransform: 'capitalize'
                                            }}>
                                                {(vehicle.status || 'in-progress').replace('-', ' ')}
                                            </span>
                                        </td>
                                        <td style={{ padding: '14px 16px' }}>
                                            {isPaid ? (
                                                <span style={{
                                                    display: 'inline-flex',
                                                    alignItems: 'center',
                                                    gap: '4px',
                                                    padding: '5px 12px',
                                                    borderRadius: '12px',
                                                    fontSize: '11px',
                                                    fontWeight: '600',
                                                    backgroundColor: isDark ? 'rgba(16, 185, 129, 0.2)' : '#d1fae5',
                                                    color: isDark ? '#4ade80' : '#059669'
                                                }}>
                                                    ‚úì Paid
                                                </span>
                                            ) : (
                                                <span style={{
                                                    display: 'inline-flex',
                                                    alignItems: 'center',
                                                    gap: '4px',
                                                    padding: '5px 12px',
                                                    borderRadius: '12px',
                                                    fontSize: '11px',
                                                    fontWeight: '600',
                                                    backgroundColor: isDark ? 'rgba(245, 158, 11, 0.2)' : '#fef3c7',
                                                    color: isDark ? '#fcd34d' : '#d97706'
                                                }}>
                                                    üí∞ Awaiting
                                                </span>
                                            )}
                                        </td>
                                        <td style={{ padding: '14px 16px', fontSize: '12px', color: isDark ? '#9ca3af' : '#64748b' }}>{formatTime(vehicle.timeIn)}</td>
                                        <td>
                                            <div className="intake-table-actions">
                                                <button 
                                                    className="table-action-btn" 
                                                    title="View Details"
                                                    onClick={() => handleView(vehicle)}
                                                >
                                                    {Icons.eye}
                                                </button>
                                                {/* Customer Items Notes Button */}
                                                <button 
                                                    className="table-action-btn" 
                                                    title={vehicle.customerItems ? 'View Items (' + vehicle.customerItems.split('\n').filter(i => i.trim()).length + ')' : 'No Items'}
                                                    onClick={() => handleNotes(vehicle)}
                                                    style={{ 
                                                        color: vehicle.customerItems ? '#f59e0b' : '#94a3b8',
                                                        position: 'relative'
                                                    }}
                                                >
                                                    üìã
                                                    {vehicle.customerItems && (
                                                        <span style={{
                                                            position: 'absolute',
                                                            top: '-2px',
                                                            right: '-2px',
                                                            width: '8px',
                                                            height: '8px',
                                                            backgroundColor: '#f59e0b',
                                                            borderRadius: '50%'
                                                        }}></span>
                                                    )}
                                                </button>
                                                {/* Visit History Button */}
                                                <button 
                                                    className="table-action-btn" 
                                                    title="Visit History"
                                                    onClick={() => handleHistory(vehicle.plateNumber)}
                                                    style={{ color: '#0284c7' }}
                                                >
                                                    {Icons.clock}
                                                </button>
                                                <button 
                                                    className="table-action-btn" 
                                                    title="Print Receipt"
                                                    onClick={() => handlePrint(vehicle)}
                                                    style={{ color: '#6366f1' }}
                                                >
                                                    {Icons.printer}
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                );
                            })}
                        </tbody>
                    </table>
                    {filteredVehicles.length === 0 && (
                        <div style={{ 
                            textAlign: 'center', 
                            padding: '80px 20px', 
                            color: isDark ? '#9ca3af' : '#64748b' 
                        }}>
                            <div style={{ fontSize: '64px', marginBottom: '20px' }}>üì≠</div>
                            <h3 style={{ margin: '0 0 8px', color: isDark ? '#e5e7eb' : '#1e293b' }}>No Records Found</h3>
                            <p style={{ margin: 0 }}>Try adjusting your search or filters</p>
                        </div>
                    )}
                </div>
                
                {/* Pagination Controls */}
                {filteredVehicles.length > 0 && (
                    <div style={{
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'center',
                        padding: '16px 20px',
                        background: isDark ? '#1f2937' : '#f8fafc',
                        borderTop: isDark ? '1px solid #374151' : '1px solid #e2e8f0',
                        borderRadius: '0 0 12px 12px',
                        flexWrap: 'wrap',
                        gap: '12px'
                    }}>
                        {/* Left side - showing info */}
                        <div style={{ display: 'flex', alignItems: 'center', gap: '16px', fontSize: '13px', color: isDark ? '#9ca3af' : '#64748b' }}>
                            <span>Showing {startIndex + 1}-{Math.min(endIndex, filteredVehicles.length)} of {filteredVehicles.length.toLocaleString()} records</span>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                                <span>Per page:</span>
                                <select
                                    value={itemsPerPage}
                                    onChange={(e) => {
                                        setItemsPerPage(Number(e.target.value));
                                        setCurrentPage(1);
                                    }}
                                    style={{
                                        padding: '4px 8px',
                                        border: isDark ? '1px solid #4b5563' : '1px solid #e2e8f0',
                                        borderRadius: '4px',
                                        fontSize: '13px',
                                        cursor: 'pointer',
                                        backgroundColor: isDark ? '#374151' : '#fff',
                                        color: isDark ? '#e5e7eb' : 'inherit'
                                    }}
                                >
                                    <option value={10}>10</option>
                                    <option value={25}>25</option>
                                    <option value={50}>50</option>
                                    <option value={100}>100</option>
                                    <option value={250}>250</option>
                                </select>
                            </div>
                        </div>
                        
                        {/* Right side - page navigation */}
                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                            <button
                                onClick={() => setCurrentPage(1)}
                                disabled={currentPage === 1}
                                style={{
                                    padding: '6px 10px',
                                    border: isDark ? '1px solid #4b5563' : '1px solid #e2e8f0',
                                    borderRadius: '6px',
                                    background: currentPage === 1 ? (isDark ? '#374151' : '#f1f5f9') : (isDark ? '#1f2937' : '#fff'),
                                    color: currentPage === 1 ? (isDark ? '#6b7280' : '#94a3b8') : (isDark ? '#e5e7eb' : '#1e293b'),
                                    cursor: currentPage === 1 ? 'not-allowed' : 'pointer',
                                    fontSize: '12px',
                                    fontWeight: '500'
                                }}
                            >
                                ‚èÆ First
                            </button>
                            <button
                                onClick={() => setCurrentPage(p => Math.max(1, p - 1))}
                                disabled={currentPage === 1}
                                style={{
                                    padding: '6px 12px',
                                    border: isDark ? '1px solid #4b5563' : '1px solid #e2e8f0',
                                    borderRadius: '6px',
                                    background: currentPage === 1 ? (isDark ? '#374151' : '#f1f5f9') : (isDark ? '#1f2937' : '#fff'),
                                    color: currentPage === 1 ? (isDark ? '#6b7280' : '#94a3b8') : (isDark ? '#e5e7eb' : '#1e293b'),
                                    cursor: currentPage === 1 ? 'not-allowed' : 'pointer',
                                    fontSize: '12px',
                                    fontWeight: '500'
                                }}
                            >
                                ‚Üê Prev
                            </button>
                            
                            <div style={{ display: 'flex', alignItems: 'center', gap: '4px', padding: '0 8px' }}>
                                <span style={{ fontSize: '13px', color: isDark ? '#9ca3af' : '#64748b' }}>Page</span>
                                <input
                                    type="number"
                                    min={1}
                                    max={totalPages}
                                    value={currentPage}
                                    onChange={(e) => {
                                        const page = parseInt(e.target.value);
                                        if (page >= 1 && page <= totalPages) {
                                            setCurrentPage(page);
                                        }
                                    }}
                                    style={{
                                        width: '50px',
                                        padding: '4px 6px',
                                        border: isDark ? '1px solid #4b5563' : '1px solid #e2e8f0',
                                        borderRadius: '4px',
                                        fontSize: '13px',
                                        textAlign: 'center',
                                        backgroundColor: isDark ? '#374151' : '#fff',
                                        color: isDark ? '#e5e7eb' : 'inherit'
                                    }}
                                />
                                <span style={{ fontSize: '13px', color: isDark ? '#9ca3af' : '#64748b' }}>of {totalPages.toLocaleString()}</span>
                            </div>
                            
                            <button
                                onClick={() => setCurrentPage(p => Math.min(totalPages, p + 1))}
                                disabled={currentPage === totalPages}
                                style={{
                                    padding: '6px 12px',
                                    border: isDark ? '1px solid #4b5563' : '1px solid #e2e8f0',
                                    borderRadius: '6px',
                                    background: currentPage === totalPages ? (isDark ? '#374151' : '#f1f5f9') : (isDark ? '#1f2937' : '#fff'),
                                    color: currentPage === totalPages ? (isDark ? '#6b7280' : '#94a3b8') : (isDark ? '#e5e7eb' : '#1e293b'),
                                    cursor: currentPage === totalPages ? 'not-allowed' : 'pointer',
                                    fontSize: '12px',
                                    fontWeight: '500'
                                }}
                            >
                                Next ‚Üí
                            </button>
                            <button
                                onClick={() => setCurrentPage(totalPages)}
                                disabled={currentPage === totalPages}
                                style={{
                                    padding: '6px 10px',
                                    border: isDark ? '1px solid #4b5563' : '1px solid #e2e8f0',
                                    borderRadius: '6px',
                                    background: currentPage === totalPages ? (isDark ? '#374151' : '#f1f5f9') : (isDark ? '#1f2937' : '#fff'),
                                    color: currentPage === totalPages ? (isDark ? '#6b7280' : '#94a3b8') : (isDark ? '#e5e7eb' : '#1e293b'),
                                    cursor: currentPage === totalPages ? 'not-allowed' : 'pointer',
                                    fontSize: '12px',
                                    fontWeight: '500'
                                }}
                            >
                                Last ‚è≠
                            </button>
                        </div>
                    </div>
                )}
            </div>
            
            {/* View Details Modal */}
            {showViewModal && selectedVehicle && (
                <div className="modal-overlay" onClick={() => setShowViewModal(false)}>
                    <div className="modal" onClick={e => e.stopPropagation()}>
                        <div className="modal-header">
                            <h2>Item Details</h2>
                            <button className="modal-close" onClick={() => setShowViewModal(false)}>
                                {Icons.x}
                            </button>
                        </div>
                        <div className="modal-body">
                            <div className="vehicle-details">
                                <div className="detail-row">
                                    <span className="detail-label">ID / Plate Number</span>
                                    <span className="detail-value" style={{ fontWeight: 'bold', fontSize: '1.2em' }}>
                                        {INTAKE_CATEGORIES.find(c => c.id === selectedVehicle.category)?.icon || 'üöó'} {selectedVehicle.plateNumber}
                                    </span>
                                </div>
                                <div className="detail-row">
                                    <span className="detail-label">Category</span>
                                    <span className="detail-value">{INTAKE_CATEGORIES.find(c => c.id === selectedVehicle.category)?.label || 'Vehicle'}</span>
                                </div>
                                <div className="detail-row">
                                    <span className="detail-label">Type</span>
                                    <span className="detail-value">{selectedVehicle.itemType || selectedVehicle.vehicleType}</span>
                                </div>
                                <div className="detail-row">
                                    <span className="detail-label">Service</span>
                                    <span className="detail-value">{selectedVehicle.service?.name || '-'} (KSH {selectedVehicle.service?.price || 0})</span>
                                </div>
                                <div className="detail-row">
                                    <span className="detail-label">Priority</span>
                                    <span className="detail-value" style={{ textTransform: 'uppercase', color: selectedVehicle.priority === 'urgent' ? '#ef4444' : selectedVehicle.priority === 'high' ? '#f59e0b' : '#64748b' }}>{selectedVehicle.priority || 'normal'}</span>
                                </div>
                                <div className="detail-row">
                                    <span className="detail-label">Status</span>
                                    <span className="intake-status-badge" style={{ backgroundColor: getStatusColor(selectedVehicle.status) }}>
                                        {selectedVehicle.status?.replace('-', ' ')}
                                    </span>
                                </div>
                                <div className="detail-row">
                                    <span className="detail-label">Assigned Bay</span>
                                    <span className="detail-value">{selectedVehicle.assignedBay || 'Not assigned'}</span>
                                </div>
                                <div className="detail-row">
                                    <span className="detail-label">Customer Name</span>
                                    <span className="detail-value">{selectedVehicle.customerName || '-'}</span>
                                </div>
                                <div className="detail-row">
                                    <span className="detail-label">Customer Phone</span>
                                    <span className="detail-value">{selectedVehicle.customerPhone || '-'}</span>
                                </div>
                                <div className="detail-row">
                                    <span className="detail-label">Time In</span>
                                    <span className="detail-value">{selectedVehicle.timeIn ? new Date(selectedVehicle.timeIn).toLocaleString() : '-'}</span>
                                </div>
                                <div className="detail-row">
                                    <span className="detail-label">Time Out</span>
                                    <span className="detail-value">{selectedVehicle.timeOut ? new Date(selectedVehicle.timeOut).toLocaleString() : '-'}</span>
                                </div>
                            </div>
                        </div>
                        <div className="modal-footer">
                            <button className="modal-btn modal-btn-primary" onClick={() => setShowViewModal(false)}>
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            )}
            
            {/* Customer Items Notes Modal */}
            {showNotesModal && selectedVehicle && (
                <div className="modal-overlay" onClick={() => setShowNotesModal(false)}>
                    <div className="modal" style={{ maxWidth: '500px' }} onClick={e => e.stopPropagation()}>
                        <div className="modal-header">
                            <h2>üìã Customer Items - {selectedVehicle.plateNumber}</h2>
                            <button className="modal-close" onClick={() => setShowNotesModal(false)}>
                                {Icons.x}
                            </button>
                        </div>
                        <div className="modal-body">
                            {selectedVehicle.customerItems ? (
                                <div style={{
                                    background: '#fffbeb',
                                    border: '1px solid #fde68a',
                                    borderRadius: '8px',
                                    padding: '16px',
                                    whiteSpace: 'pre-wrap',
                                    fontSize: '14px',
                                    lineHeight: '1.6'
                                }}>
                                    {selectedVehicle.customerItems}
                                </div>
                            ) : (
                                <div style={{
                                    textAlign: 'center',
                                    padding: '40px',
                                    color: '#94a3b8'
                                }}>
                                    <div style={{ fontSize: '48px', marginBottom: '12px' }}>üìù</div>
                                    <p>No customer items recorded for this vehicle</p>
                                </div>
                            )}
                        </div>
                        <div className="modal-footer">
                            <button className="modal-btn modal-btn-primary" onClick={() => setShowNotesModal(false)}>
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            )}
            
            {/* Visit History Modal */}
            {showHistoryModal && vehicleHistory && (
                <div className="modal-overlay" onClick={() => { setShowHistoryModal(false); setVehicleHistory(null); }}>
                    <div className="modal" style={{ maxWidth: '700px' }} onClick={e => e.stopPropagation()}>
                        <div className="modal-header">
                            <h2>Visit History - {vehicleHistory.plateNumber}</h2>
                            <button className="modal-close" onClick={() => { setShowHistoryModal(false); setVehicleHistory(null); }}>
                                {Icons.x}
                            </button>
                        </div>
                        <div className="modal-body">
                            {/* Summary Stats */}
                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '12px', marginBottom: '20px' }}>
                                <div style={{ background: isDark ? 'rgba(14, 165, 233, 0.15)' : '#f0f9ff', borderRadius: '8px', padding: '16px', textAlign: 'center' }}>
                                    <div style={{ fontSize: '24px', fontWeight: 'bold', color: isDark ? '#38bdf8' : '#0284c7' }}>{vehicleHistory.totalVisits || 0}</div>
                                    <div style={{ fontSize: '12px', color: isDark ? '#9ca3af' : '#64748b' }}>Total Visits</div>
                                </div>
                                <div style={{ background: isDark ? 'rgba(34, 197, 94, 0.15)' : '#f0fdf4', borderRadius: '8px', padding: '16px', textAlign: 'center' }}>
                                    <div style={{ fontSize: '24px', fontWeight: 'bold', color: isDark ? '#4ade80' : '#16a34a' }}>KSH {(vehicleHistory.totalSpent || 0).toLocaleString()}</div>
                                    <div style={{ fontSize: '12px', color: isDark ? '#9ca3af' : '#64748b' }}>Total Spent</div>
                                </div>
                                <div style={{ background: isDark ? 'rgba(139, 92, 246, 0.15)' : '#faf5ff', borderRadius: '8px', padding: '16px', textAlign: 'center' }}>
                                    <div style={{ fontSize: '14px', fontWeight: '600', color: isDark ? '#a78bfa' : '#7c3aed' }}>{vehicleHistory.lastVisit ? new Date(vehicleHistory.lastVisit).toLocaleDateString() : '-'}</div>
                                    <div style={{ fontSize: '12px', color: isDark ? '#9ca3af' : '#64748b' }}>Last Visit</div>
                                </div>
                            </div>

                            {/* Customer Info */}
                            {(vehicleHistory.customerName || vehicleHistory.customerPhone) && (
                                <div style={{ background: isDark ? '#374151' : '#f8fafc', borderRadius: '8px', padding: '12px', marginBottom: '16px' }}>
                                    <div style={{ display: 'flex', gap: '20px', fontSize: '13px' }}>
                                        {vehicleHistory.customerName && (
                                            <div><span style={{ color: isDark ? '#9ca3af' : '#64748b' }}>Customer:</span> <strong>{vehicleHistory.customerName}</strong></div>
                                        )}
                                        {vehicleHistory.customerPhone && (
                                            <div><span style={{ color: isDark ? '#9ca3af' : '#64748b' }}>Phone:</span> <strong>{vehicleHistory.customerPhone}</strong></div>
                                        )}
                                        {vehicleHistory.vehicleType && (
                                            <div><span style={{ color: isDark ? '#9ca3af' : '#64748b' }}>Type:</span> <strong>{vehicleHistory.vehicleType}</strong></div>
                                        )}
                                    </div>
                                </div>
                            )}

                            {/* Visit History Table */}
                            <div style={{ fontSize: '13px', fontWeight: '600', color: isDark ? '#e5e7eb' : '#1e293b', marginBottom: '8px' }}>Visit History</div>
                            <div style={{ maxHeight: '300px', overflowY: 'auto', border: isDark ? '1px solid #4b5563' : '1px solid #e2e8f0', borderRadius: '8px' }}>
                                <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '13px' }}>
                                    <thead style={{ background: isDark ? '#374151' : '#f8fafc', position: 'sticky', top: 0 }}>
                                        <tr>
                                            <th style={{ padding: '10px', textAlign: 'left', borderBottom: isDark ? '1px solid #4b5563' : '1px solid #e2e8f0', color: isDark ? '#9ca3af' : 'inherit' }}>Date</th>
                                            <th style={{ padding: '10px', textAlign: 'left', borderBottom: isDark ? '1px solid #4b5563' : '1px solid #e2e8f0', color: isDark ? '#9ca3af' : 'inherit' }}>Time</th>
                                            <th style={{ padding: '10px', textAlign: 'left', borderBottom: isDark ? '1px solid #4b5563' : '1px solid #e2e8f0', color: isDark ? '#9ca3af' : 'inherit' }}>Service</th>
                                            <th style={{ padding: '10px', textAlign: 'left', borderBottom: isDark ? '1px solid #4b5563' : '1px solid #e2e8f0', color: isDark ? '#9ca3af' : 'inherit' }}>Bay</th>
                                            <th style={{ padding: '10px', textAlign: 'right', borderBottom: isDark ? '1px solid #4b5563' : '1px solid #e2e8f0', color: isDark ? '#9ca3af' : 'inherit' }}>Amount</th>
                                            <th style={{ padding: '10px', textAlign: 'center', borderBottom: isDark ? '1px solid #4b5563' : '1px solid #e2e8f0', color: isDark ? '#9ca3af' : 'inherit' }}>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {(vehicleHistory.visitHistory || []).length === 0 ? (
                                            <tr>
                                                <td colSpan="6" style={{ padding: '20px', textAlign: 'center', color: isDark ? '#9ca3af' : '#64748b' }}>
                                                    No visit history recorded yet
                                                </td>
                                            </tr>
                                        ) : (
                                            (vehicleHistory.visitHistory || []).map((visit, index) => (
                                                <tr key={visit.id || index} style={{ borderBottom: isDark ? '1px solid #374151' : '1px solid #f1f5f9' }}>
                                                    <td style={{ padding: '10px' }}>{visit.date ? new Date(visit.date).toLocaleDateString() : '-'}</td>
                                                    <td style={{ padding: '10px' }}>{visit.timeIn ? new Date(visit.timeIn).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '-'}</td>
                                                    <td style={{ padding: '10px' }}>{visit.service?.name || '-'}</td>
                                                    <td style={{ padding: '10px' }}>{visit.bay || '-'}</td>
                                                    <td style={{ padding: '10px', textAlign: 'right', fontWeight: '600', color: isDark ? '#4ade80' : '#10b981' }}>KSH {(visit.amount || 0).toLocaleString()}</td>
                                                    <td style={{ padding: '10px', textAlign: 'center' }}>
                                                        <span style={{
                                                            padding: '2px 8px',
                                                            borderRadius: '10px',
                                                            fontSize: '11px',
                                                            fontWeight: '500',
                                                            background: visit.status === 'completed' ? (isDark ? 'rgba(34, 197, 94, 0.2)' : '#dcfce7') : visit.status === 'in-progress' ? (isDark ? 'rgba(59, 130, 246, 0.2)' : '#dbeafe') : (isDark ? 'rgba(245, 158, 11, 0.2)' : '#fef3c7'),
                                                            color: visit.status === 'completed' ? (isDark ? '#4ade80' : '#166534') : visit.status === 'in-progress' ? (isDark ? '#60a5fa' : '#1e40af') : (isDark ? '#fcd34d' : '#92400e')
                                                        }}>
                                                            {visit.status || 'unknown'}
                                                        </span>
                                                    </td>
                                                </tr>
                                            ))
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div className="modal-footer">
                            <button className="modal-btn modal-btn-primary" onClick={() => { setShowHistoryModal(false); setVehicleHistory(null); }}>
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}

// Service Packages Module Component - Firebase Integrated
function ServicePackages() {
    const { canCreate, canEdit, canDelete } = usePermissions();
    const [packages, setPackages] = useState([]);
    const [loading, setLoading] = useState(true);
    const [showModal, setShowModal] = useState(false);
    const [showConfirmModal, setShowConfirmModal] = useState(false);
    const [deleteTargetId, setDeleteTargetId] = useState(null);
    const [editingPackage, setEditingPackage] = useState(null);
    const [formData, setFormData] = useState({
        name: '',
        price: '',
        description: '',
        features: '',
        category: 'standard',
        appliesTo: 'all'
    });
    const [notification, setNotification] = useState(null);

    // Show notification helper
    const showNotification = (message, type = 'success') => {
        setNotification({ message, type });
        setTimeout(() => setNotification(null), 3000);
    };

    // Subscribe to packages on mount
    useEffect(() => {
        const services = window.FirebaseServices;
        if (!services?.packagesService) {
            console.error('PackagesService not available');
            setLoading(false);
            return;
        }

        // Subscribe to real-time updates FIRST for instant loading
        const unsubscribe = services.packagesService.subscribeToPackages(
            (packagesData) => {
                setPackages(packagesData);
                setLoading(false);
                
                // Initialize default packages only if none exist (background, non-blocking)
                if (packagesData.length === 0) {
                    services.packagesService.initializeDefaultPackages();
                }
            },
            (error) => {
                console.error('Error subscribing to packages:', error);
                showNotification('Error loading packages', 'error');
                setLoading(false);
            }
        );

        return () => unsubscribe && unsubscribe();
    }, []);

    // Handle form input changes
    const handleInputChange = (e) => {
        const { name, value } = e.target;
        setFormData(prev => ({ ...prev, [name]: value }));
    };

    // Open modal for new package
    const handleAddNew = () => {
        setEditingPackage(null);
        setFormData({
            name: '',
            price: '',
            description: '',
            features: '',
            category: 'standard',
            appliesTo: 'all'
        });
        setShowModal(true);
    };

    // Open modal for editing
    const handleEdit = (pkg) => {
        setEditingPackage(pkg);
        setFormData({
            name: pkg.name,
            price: pkg.price.toString(),
            description: pkg.description || '',
            features: Array.isArray(pkg.features) ? pkg.features.join(', ') : '',
            category: pkg.category || 'standard',
            appliesTo: pkg.appliesTo || 'all'
        });
        setShowModal(true);
    };

    // Save package (add or update)
    const handleSave = async () => {
        const services = window.FirebaseServices;
        if (!services?.packagesService) {
            showNotification('Service not available. Please refresh.', 'error');
            return;
        }

        if (!formData.name.trim() || !formData.price) {
            showNotification('Name and price are required', 'error');
            return;
        }

        const packageData = {
            name: formData.name.trim(),
            price: parseFloat(formData.price),
            description: formData.description.trim(),
            features: formData.features.split(',').map(f => f.trim()).filter(f => f),
            category: formData.category,
            appliesTo: formData.appliesTo || 'all',
            isActive: true
        };

        try {
            let result;
            if (editingPackage) {
                result = await services.packagesService.updatePackage(editingPackage.id, packageData);
                if (result.success) {
                    showNotification('Package updated successfully');
                    setShowModal(false);
                } else {
                    showNotification(result.error || 'Error updating package', 'error');
                }
            } else {
                result = await services.packagesService.addPackage(packageData);
                if (result.success) {
                    showNotification('Package added successfully');
                    setShowModal(false);
                } else {
                    showNotification(result.error || 'Error adding package', 'error');
                }
            }
        } catch (error) {
            console.error('Error saving package:', error);
            showNotification('Error saving package: ' + error.message, 'error');
        }
    };

    // Delete package - show confirmation modal
    const handleDelete = (pkgId) => {
        setDeleteTargetId(pkgId);
        setShowConfirmModal(true);
    };

    // Confirm delete package
    const confirmDelete = async () => {
        if (!deleteTargetId) return;
        
        const services = window.FirebaseServices;
        if (!services?.packagesService) {
            showNotification('Service not available', 'error');
            return;
        }

        try {
            const result = await services.packagesService.deletePackage(deleteTargetId);
            if (result.success) {
                showNotification('Package deleted successfully');
            } else {
                showNotification(result.error || 'Error deleting package', 'error');
            }
        } catch (error) {
            console.error('Error deleting package:', error);
            showNotification('Error deleting package: ' + error.message, 'error');
        } finally {
            setShowConfirmModal(false);
            setDeleteTargetId(null);
        }
    };

    // Toggle package active status
    const handleToggleActive = async (pkg) => {
        const services = window.FirebaseServices;
        if (!services?.packagesService) {
            showNotification('Service not available', 'error');
            return;
        }

        try {
            const result = await services.packagesService.updatePackage(pkg.id, { isActive: !pkg.isActive });
            if (result.success) {
                showNotification(`Package ${pkg.isActive ? 'deactivated' : 'activated'}`);
            } else {
                showNotification(result.error || 'Error updating package', 'error');
            }
        } catch (error) {
            console.error('Error toggling package:', error);
            showNotification('Error updating package status', 'error');
        }
    };

    // Get category color
    const getCategoryColor = (category) => {
        switch (category) {
            case 'premium': return '#f59e0b';
            case 'special': return '#8b5cf6';
            default: return '#3b82f6';
        }
    };

    return (
        <div className="module-content">
            {/* Notification */}
            {notification && (
                <div className={`notification ${notification.type}`}>
                    {notification.type === 'success' ? (
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                            <polyline points="22 4 12 14.01 9 11.01"/>
                        </svg>
                    ) : (
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="12" y1="8" x2="12" y2="12"/>
                            <line x1="12" y1="16" x2="12.01" y2="16"/>
                        </svg>
                    )}
                    <span>{notification.message}</span>
                </div>
            )}

            {/* Header with Add Button */}
            <div className="section-header" style={{ marginBottom: '24px' }}>
                <h2 className="section-title">Service Packages</h2>
                {canCreate('service-packages') && <button className="add-package-btn" onClick={handleAddNew}>
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5">
                        <line x1="12" y1="5" x2="12" y2="19"/>
                        <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    Add Package
                </button>}
            </div>

            {/* Packages Grid - Instant render with flash effect */}
            {packages.length === 0 && !loading ? (
                <div className="empty-state">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5">
                        <rect x="3" y="3" width="18" height="18" rx="2"/>
                        <path d="M3 9h18"/>
                        <path d="M9 21V9"/>
                    </svg>
                    <h3>No Packages Yet</h3>
                    <p>Create your first service package to get started</p>
                    {canCreate('service-packages') && <button className="primary-button" onClick={handleAddNew}>Create Package</button>}
                </div>
            ) : (
                <div className="packages-grid" style={{ 
                    opacity: loading ? 0.6 : 1, 
                    transition: 'opacity 0.15s ease-out',
                    animation: !loading && packages.length > 0 ? 'fadeIn 0.2s ease-out' : 'none'
                }}>
                    {loading && packages.length === 0 ? (
                        // Skeleton cards for instant perceived loading
                        [...Array(6)].map((_, i) => (
                            <div key={`skeleton-${i}`} className="package-card" style={{ 
                                background: 'linear-gradient(90deg, var(--bg-secondary) 25%, var(--bg-tertiary) 50%, var(--bg-secondary) 75%)',
                                backgroundSize: '200% 100%',
                                animation: 'shimmer 1.2s infinite',
                                minHeight: '200px'
                            }}>
                                <div style={{ padding: '16px' }}>
                                    <div style={{ height: '24px', width: '60px', background: 'var(--bg-tertiary)', borderRadius: '12px', marginBottom: '12px' }}></div>
                                    <div style={{ height: '20px', width: '70%', background: 'var(--bg-tertiary)', borderRadius: '4px', marginBottom: '8px' }}></div>
                                    <div style={{ height: '28px', width: '40%', background: 'var(--bg-tertiary)', borderRadius: '4px' }}></div>
                                </div>
                            </div>
                        ))
                    ) : packages.map(pkg => (
                        <div key={pkg.id} className={`package-card ${!pkg.isActive ? 'inactive' : ''}`}>
                            <div className="package-header">
                                <div style={{ display: 'flex', gap: '6px', flexWrap: 'wrap' }}>
                                    <span 
                                        className="package-category" 
                                        style={{ backgroundColor: getCategoryColor(pkg.category) }}
                                    >
                                        {pkg.category || 'standard'}
                                    </span>
                                    {pkg.appliesTo && pkg.appliesTo !== 'all' && (
                                        <span style={{ 
                                            fontSize: '10px', 
                                            padding: '2px 8px', 
                                            borderRadius: '10px', 
                                            background: 'var(--bg-secondary)',
                                            color: 'var(--text-secondary)',
                                            border: '1px solid var(--border-color)'
                                        }}>
                                            {pkg.appliesTo === 'vehicle' && 'üöó'}
                                            {pkg.appliesTo === 'motorbike' && 'üèçÔ∏è'}
                                            {pkg.appliesTo === 'bicycle' && 'üö≤'}
                                            {pkg.appliesTo === 'carpet' && 'üßπ'}
                                            {pkg.appliesTo === 'other' && 'üì¶'}
                                            {' '}{pkg.appliesTo}
                                        </span>
                                    )}
                                </div>
                                <div className="package-actions">
                                    <button 
                                        className="icon-btn" 
                                        onClick={() => handleToggleActive(pkg)}
                                        title={pkg.isActive ? 'Deactivate' : 'Activate'}
                                    >
                                        {pkg.isActive ? (
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#10b981" strokeWidth="2">
                                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                                <polyline points="22 4 12 14.01 9 11.01"/>
                                            </svg>
                                        ) : (
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#9ca3af" strokeWidth="2">
                                                <circle cx="12" cy="12" r="10"/>
                                                <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/>
                                            </svg>
                                        )}
                                    </button>
                                    {canEdit('service-packages') && <button className="icon-btn" onClick={() => handleEdit(pkg)} title="Edit">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                        </svg>
                                    </button>}
                                    {canDelete('service-packages') && <button className="icon-btn delete" onClick={() => handleDelete(pkg.id)} title="Delete">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                            <polyline points="3 6 5 6 21 6"/>
                                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                        </svg>
                                    </button>}
                                </div>
                            </div>
                            <div className="package-body">
                                <h3 className="package-name">{pkg.name}</h3>
                                <div className="package-price">{getBrandingForReceipts().currencySymbol || 'KES'} {pkg.price?.toLocaleString()}</div>
                                {pkg.description && <p className="package-description">{pkg.description}</p>}
                            </div>
                            {pkg.features && pkg.features.length > 0 && (
                                <div className="package-features">
                                    <h4>Includes:</h4>
                                    <ul>
                                        {pkg.features.map((feature, idx) => (
                                            <li key={idx}>
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#10b981" strokeWidth="2">
                                                    <polyline points="20 6 9 17 4 12"/>
                                                </svg>
                                                {feature}
                                            </li>
                                        ))}
                                    </ul>
                                </div>
                            )}
                        </div>
                    ))}
                </div>
            )}

            {/* Add/Edit Modal */}
            {showModal && (
                <div className="modal-overlay" onClick={() => setShowModal(false)}>
                    <div className="modal" onClick={e => e.stopPropagation()}>
                        <div className="modal-header">
                            <h3>{editingPackage ? 'Edit Package' : 'Add New Package'}</h3>
                            <button className="modal-close" onClick={() => setShowModal(false)}>√ó</button>
                        </div>
                        <div className="modal-body">
                            <div className="form-group">
                                <label>Package Name *</label>
                                <input
                                    type="text"
                                    name="name"
                                    value={formData.name}
                                    onChange={handleInputChange}
                                    placeholder="e.g., Premium Wash"
                                    className="form-input"
                                />
                            </div>
                            <div className="form-row">
                                <div className="form-group">
                                    <label>Price ({getBrandingForReceipts().currencySymbol || 'KES'}) *</label>
                                    <input
                                        type="number"
                                        name="price"
                                        value={formData.price}
                                        onChange={handleInputChange}
                                        placeholder="e.g., 1200"
                                        className="form-input"
                                    />
                                </div>
                                <div className="form-group">
                                    <label>Category</label>
                                    <select
                                        name="category"
                                        value={formData.category}
                                        onChange={handleInputChange}
                                        className="form-select"
                                    >
                                        <option value="standard">Standard</option>
                                        <option value="premium">Premium</option>
                                        <option value="special">Special</option>
                                    </select>
                                </div>
                            </div>
                            <div className="form-group">
                                <label>Applies To (Item Type)</label>
                                <select
                                    name="appliesTo"
                                    value={formData.appliesTo || 'all'}
                                    onChange={handleInputChange}
                                    className="form-select"
                                >
                                    <option value="all">üåê All Categories</option>
                                    <option value="vehicle">üöó Vehicles (Cars)</option>
                                    <option value="motorbike">üèçÔ∏è Motorbikes</option>
                                    <option value="bicycle">üö≤ Bicycles</option>
                                    <option value="carpet">üßπ Carpets</option>
                                    <option value="other">üì¶ Other Items</option>
                                </select>
                            </div>
                            <div className="form-group">
                                <label>Description</label>
                                <textarea
                                    name="description"
                                    value={formData.description}
                                    onChange={handleInputChange}
                                    placeholder="Brief description of this package"
                                    className="form-textarea"
                                    rows="2"
                                ></textarea>
                            </div>
                            <div className="form-group">
                                <label>Features (comma separated)</label>
                                <textarea
                                    name="features"
                                    value={formData.features}
                                    onChange={handleInputChange}
                                    placeholder="e.g., Exterior Wash, Interior Vacuum, Hand Dry"
                                    className="form-textarea"
                                    rows="3"
                                ></textarea>
                            </div>
                        </div>
                        <div className="modal-footer">
                            <button className="modal-btn-cancel" onClick={() => setShowModal(false)}>Cancel</button>
                            <button className="modal-btn-save" onClick={handleSave}>
                                {editingPackage ? 'Update Package' : 'Add Package'}
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* Confirmation Modal */}
            {showConfirmModal && (
                <div className="modal-overlay" onClick={() => setShowConfirmModal(false)}>
                    <div className="confirm-modal" onClick={e => e.stopPropagation()}>
                        <div className="confirm-modal-icon">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#ef4444" strokeWidth="2">
                                <circle cx="12" cy="12" r="10"/>
                                <line x1="12" y1="8" x2="12" y2="12"/>
                                <line x1="12" y1="16" x2="12.01" y2="16"/>
                            </svg>
                        </div>
                        <h3 className="confirm-modal-title">Delete Package</h3>
                        <p className="confirm-modal-text">Are you sure you want to delete this package? This action cannot be undone.</p>
                        <div className="confirm-modal-actions">
                            <button className="modal-btn-cancel" onClick={() => setShowConfirmModal(false)}>Cancel</button>
                            <button className="modal-btn-delete" onClick={confirmDelete}>Delete</button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}

// ==================== PARKING MANAGEMENT MODULE ====================
function ParkingManagement() {
    const [parkedVehicles, setParkedVehicles] = useState([]);
    const [parkingHistory, setParkingHistory] = useState([]);
    const [parkingSettings, setParkingSettings] = useState({ rates: [], gracePeriod: 15, defaultRate: '', parkingSpaces: [] });
    const [loading, setLoading] = useState(false); // Start with false for instant render
    const [spacesLoaded, setSpacesLoaded] = useState(false); // Track when spaces data arrives
    const [activeTab, setActiveTab] = useState('spaces'); // 'spaces', 'parked', 'history', 'settings'
    const [showAddModal, setShowAddModal] = useState(false);
    const [showApplyFeeModal, setShowApplyFeeModal] = useState(false);
    const [showSettingsModal, setShowSettingsModal] = useState(false);
    const [showAddSpaceModal, setShowAddSpaceModal] = useState(false);
    const [showBulkAddModal, setShowBulkAddModal] = useState(false);
    const [selectedVehicle, setSelectedVehicle] = useState(null);
    const [selectedSpace, setSelectedSpace] = useState(null);
    const [selectedRate, setSelectedRate] = useState('');
    const [actionLoading, setActionLoading] = useState(false);
    const [stats, setStats] = useState({ currentlyParked: 0, todayRevenue: 0, todayReleased: 0 });
    const [searchQuery, setSearchQuery] = useState('');
    const [selectedZone, setSelectedZone] = useState('all');
    const [historySearch, setHistorySearch] = useState('');
    const [historyDateFilter, setHistoryDateFilter] = useState('all'); // 'all', 'today', 'yesterday', 'week', 'month'
    const [parkingInvoices, setParkingInvoices] = useState([]); // For tracking payment status
    const [clockTick, setClockTick] = useState(0); // For real-time fee updates
    
    // Pagination state
    const [currentPage, setCurrentPage] = useState(1);
    const [itemsPerPage, setItemsPerPage] = useState(25);
    const ITEMS_PER_PAGE_OPTIONS = [10, 25, 50, 100];
    
    // Alert modal state
    const [alertModal, setAlertModal] = useState({
        isOpen: false,
        title: '',
        message: '',
        type: 'info',
        onConfirm: null,
        showCancel: false
    });
    
    const showAlert = (title, message, type = 'info', onConfirm = null, showCancel = false) => {
        setAlertModal({ isOpen: true, title, message, type, onConfirm, showCancel });
    };
    
    const closeAlert = () => {
        setAlertModal(prev => ({ ...prev, isOpen: false }));
    };
    
    const [isDark, setIsDark] = useState(document.documentElement.getAttribute('data-theme') === 'dark');
    
    // Intake records for vehicle search
    const [intakeRecords, setIntakeRecords] = useState([]);
    const [intakeSearch, setIntakeSearch] = useState('');
    const [showIntakeResults, setShowIntakeResults] = useState(false);
    
    const [parkingForm, setParkingForm] = useState({
        plateNumber: '',
        vehicleType: 'Sedan',
        customerName: '',
        customerPhone: '',
        notes: '',
        parkingSpaceId: ''
    });

    const [spaceForm, setSpaceForm] = useState({
        name: '',
        zone: 'A',
        type: 'standard'
    });

    const [bulkForm, setBulkForm] = useState({
        zone: 'A',
        prefix: 'A',
        startNum: 1,
        endNum: 10,
        type: 'standard'
    });

    // Theme detection
    useEffect(() => {
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.attributeName === 'data-theme') {
                    setIsDark(document.documentElement.getAttribute('data-theme') === 'dark');
                }
            });
        });
        observer.observe(document.documentElement, { attributes: true });
        return () => observer.disconnect();
    }, []);

    const theme = {
        bg: isDark ? '#1e293b' : 'white',
        bgSecondary: isDark ? '#0f172a' : '#f8fafc',
        text: isDark ? '#f1f5f9' : '#1e293b',
        textSecondary: isDark ? '#94a3b8' : '#64748b',
        border: isDark ? '#334155' : '#e2e8f0',
        cardShadow: isDark ? '0 2px 8px rgba(0,0,0,0.3)' : '0 2px 8px rgba(0,0,0,0.08)',
        inputBg: isDark ? '#0f172a' : 'white',
    };

    // Styles
    const modalOverlay = { position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.6)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000, padding: '20px' };
    const modalContent = { background: isDark ? '#1e293b' : 'white', borderRadius: '2px', padding: '24px', width: '100%', maxWidth: '500px', maxHeight: '90vh', overflow: 'auto', boxShadow: '0 25px 50px -12px rgba(0,0,0,0.25)' };
    const inputStyle = { width: '100%', padding: '10px 12px', border: `1px solid ${theme.border}`, borderRadius: '2px', background: theme.inputBg, color: theme.text, fontSize: '14px', boxSizing: 'border-box', outline: 'none' };
    const selectStyle = { ...inputStyle, cursor: 'pointer' };
    const labelStyle = { display: 'block', fontSize: '13px', fontWeight: '500', color: theme.textSecondary, marginBottom: '6px' };
    const btnPrimary = { background: '#3b82f6', color: 'white', border: 'none', padding: '10px 20px', borderRadius: '2px', cursor: 'pointer', fontSize: '14px', fontWeight: '500' };
    const btnSecondary = { background: isDark ? '#334155' : '#e2e8f0', color: theme.text, border: 'none', padding: '10px 16px', borderRadius: '2px', cursor: 'pointer', fontSize: '14px' };

    const VEHICLE_TYPES = ['Sedan', 'SUV', 'Pickup', 'Van', 'Motorcycle', 'Truck', 'Bus', 'Other'];
    const SPACE_TYPES = [
        { id: 'standard', name: 'Standard', color: '#3b82f6' },
        { id: 'vip', name: 'VIP', color: '#8b5cf6' },
        { id: 'disabled', name: 'Disabled', color: '#f59e0b' },
        { id: 'reserved', name: 'Reserved', color: '#ef4444' }
    ];
    const ZONES = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];

    // Subscribe to data - optimized for fast loading
    useEffect(() => {
        let mounted = true;
        const services = window.FirebaseServices;
        
        if (!services || !services.parkingService) {
            return;
        }

        // Critical subscriptions - load immediately
        const unsubParking = services.parkingService.subscribeToParking((data) => {
            if (mounted) setParkedVehicles(data || []);
        }, (error) => {
            console.error('Parking subscription error:', error);
        });

        const unsubSettings = services.parkingService.subscribeToSettings((data) => {
            if (mounted) {
                setParkingSettings(data || { rates: [], gracePeriod: 15, defaultRate: '', parkingSpaces: [] });
                setSpacesLoaded(true); // Mark spaces as loaded
            }
        });

        // Defer non-critical subscriptions for faster initial load
        let unsubHistory, unsubInvoices, unsubIntake;
        const deferredLoad = setTimeout(() => {
            if (!mounted) return;
            
            unsubHistory = services.parkingService.subscribeToParkingHistory((data) => {
                if (mounted) setParkingHistory(data || []);
            });

            if (services.billingService) {
                unsubInvoices = services.billingService.subscribeToInvoices((data) => {
                    const parkingInvs = (data || []).filter(inv => inv.source === 'parking');
                    if (mounted) setParkingInvoices(parkingInvs);
                });
            }
            
            // Subscribe to intake records for vehicle search
            if (services.intakeRecordsService?.subscribeToRecords) {
                unsubIntake = services.intakeRecordsService.subscribeToRecords((data) => {
                    if (mounted) setIntakeRecords(data || []);
                });
            }

            // Get stats in background
            services.parkingService.getStats().then(result => {
                if (mounted && result.success) setStats(result.data);
            });
        }, 100); // Small delay to let UI render first

        return () => {
            mounted = false;
            clearTimeout(deferredLoad);
            if (unsubParking) unsubParking();
            if (unsubSettings) unsubSettings();
            if (unsubHistory) unsubHistory();
            if (unsubInvoices) unsubInvoices();
            if (unsubIntake) unsubIntake();
        };
    }, []);

    // Refresh stats when vehicles change
    useEffect(() => {
        const services = window.FirebaseServices;
        if (services?.parkingService) {
            services.parkingService.getStats().then(result => {
                if (result.success) setStats(result.data);
            });
        }
    }, [parkedVehicles, parkingHistory]);

    // Real-time clock tick for auto-updating parking fees every 30 seconds
    useEffect(() => {
        const timer = setInterval(() => {
            setClockTick(prev => prev + 1);
        }, 30000); // Update every 30 seconds
        return () => clearInterval(timer);
    }, []);

    // Get currency from branding
    const getCurrency = () => getBrandingForReceipts().currencySymbol || 'KES';

    // Get payment status for a parking history record
    const getPaymentStatus = (recordId) => {
        const invoice = parkingInvoices.find(inv => inv.parkingRecordId === recordId);
        if (!invoice) return { status: 'pending', invoice: null };
        return {
            status: invoice.paymentStatus === 'paid' ? 'cleared' : 'pending',
            invoice: invoice
        };
    };

    // Print gate pass receipt
    const printGatePass = (record) => {
        const paymentInfo = getPaymentStatus(record.id);
        const branding = getBrandingForReceipts();
        const currency = branding.currencySymbol || 'KES';
        const isPaid = paymentInfo.status === 'cleared';
        const isWaived = record.feeWaived === true;
        
        const printContent = `
<!DOCTYPE html>
<html>
<head>
    <title>Gate Pass - ${record.plateNumber}</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Courier New', monospace; 
            padding: 8px;
            max-width: 280px;
            margin: 0 auto;
            font-size: 12px;
            line-height: 1.4;
        }
        .header { text-align: center; padding-bottom: 8px; border-bottom: 1px dashed #000; }
        .logo { font-size: 14px; font-weight: bold; }
        .subtitle { font-size: 10px; }
        .plate { 
            font-size: 20px; 
            font-weight: bold; 
            text-align: center; 
            padding: 8px 0;
            letter-spacing: 1px;
            border-bottom: 1px dashed #000;
        }
        .status {
            text-align: center;
            padding: 6px 0;
            font-weight: bold;
            font-size: 11px;
            background: ${isWaived ? '#fff' : (isPaid ? '#000' : '#fff')};
            color: ${isWaived ? '#000' : (isPaid ? '#fff' : '#000')};
            border: 1px solid #000;
            margin: 6px 0;
        }
        .row { display: flex; justify-content: space-between; padding: 2px 0; }
        .row .label { }
        .row .value { font-weight: bold; text-align: right; }
        .divider { border-top: 1px dashed #000; margin: 6px 0; }
        .amount { 
            font-size: 16px; 
            font-weight: bold; 
            text-align: center;
            padding: 6px 0;
        }
        .footer { 
            text-align: center; 
            padding-top: 6px; 
            border-top: 1px dashed #000;
            font-size: 10px;
        }
        @media print {
            body { padding: 4px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">${branding.companyName}</div>
        <div class="subtitle">PARKING GATE PASS</div>
    </div>
    
    <div class="plate">${record.plateNumber}</div>
    
    <div class="status">${isWaived ? '*** FEE WAIVED ***' : (isPaid ? '*** CLEARED ***' : '-- PENDING PAYMENT --')}</div>
    
    <div class="row"><span class="label">Type:</span><span class="value">${record.vehicleType || 'Vehicle'}</span></div>
    <div class="row"><span class="label">Customer:</span><span class="value">${record.customerName || 'Walk-in'}</span></div>
    ${record.customerPhone ? `<div class="row"><span class="label">Phone:</span><span class="value">${record.customerPhone}</span></div>` : ''}
    
    <div class="divider"></div>
    
    <div class="row"><span class="label">In:</span><span class="value">${record.parkedAt ? new Date(record.parkedAt).toLocaleString([], { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : '-'}</span></div>
    <div class="row"><span class="label">Out:</span><span class="value">${record.releasedAt ? new Date(record.releasedAt).toLocaleString([], { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : '-'}</span></div>
    ${record.parkingSpaceName ? `<div class="row"><span class="label">Space:</span><span class="value">${record.parkingSpaceName}</span></div>` : ''}
    <div class="row"><span class="label">Rate:</span><span class="value">${isWaived ? 'WAIVED' : (record.rateApplied || 'Standard')}</span></div>
    
    <div class="divider"></div>
    
    <div class="amount">${isWaived ? 'NO CHARGE' : `${currency} ${(record.parkingFee || 0).toLocaleString()}`}</div>
    
    ${isWaived ? `
    <div class="row"><span class="label">Waived by:</span><span class="value">${record.feeWaivedBy?.name || 'Staff'}</span></div>
    ${record.feeWaivedAt ? `<div class="row"><span class="label">Waived:</span><span class="value">${new Date(record.feeWaivedAt).toLocaleString([], { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</span></div>` : ''}
    ` : paymentInfo.invoice ? `
    <div class="row"><span class="label">Invoice:</span><span class="value">${paymentInfo.invoice.invoiceNumber || '-'}</span></div>
    ${isPaid && paymentInfo.invoice.paymentMethod ? `<div class="row"><span class="label">Paid via:</span><span class="value">${paymentInfo.invoice.paymentMethod.toUpperCase()}</span></div>` : ''}
    ${isPaid && paymentInfo.invoice.paidAt ? `<div class="row"><span class="label">Paid:</span><span class="value">${new Date(paymentInfo.invoice.paidAt).toLocaleString([], { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</span></div>` : ''}
    ` : ''}
    
    <div class="divider"></div>
    
    <div class="row"><span class="label">Released by:</span><span class="value">${record.releasedBy?.name || record.releasedBy?.email?.split('@')[0] || 'Staff'}</span></div>
    ${paymentInfo.invoice?.paidBy ? `<div class="row"><span class="label">Billed by:</span><span class="value">${paymentInfo.invoice.paidBy?.name || paymentInfo.invoice.paidBy?.email?.split('@')[0] || 'Staff'}</span></div>` : ''}
    <div class="row"><span class="label">Printed:</span><span class="value">${new Date().toLocaleString([], { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</span></div>
    
    <div class="footer">
        <div>Present this pass at the gate</div>
        ${branding.phone ? `<div>${branding.phone}</div>` : ''}
    </div>
</body>
</html>`;
        
        const printWindow = window.open('', '_blank', 'width=320,height=500');
        if (printWindow) {
            printWindow.document.write(printContent);
            printWindow.document.close();
            setTimeout(() => {
                printWindow.print();
            }, 250);
        } else {
            showAlert('Print Blocked', 'Please allow popups to print the gate pass.', 'warning');
        }
    };

    // Get filter label for exports
    const getFilterLabel = () => {
        const labels = { all: 'All Time', today: 'Today', yesterday: 'Yesterday', week: 'This Week', month: 'This Month' };
        return labels[historyDateFilter] || 'All';
    };

    // Export parking history to Excel
    const exportHistoryToExcel = () => {
        const branding = getBrandingForReceipts();
        const currency = branding.currencySymbol || 'KES';
        const data = filteredHistory;
        
        if (data.length === 0) {
            showAlert('No Data', 'No records to export for the selected filter.', 'info');
            return;
        }
        
        let html = '<html><head><meta charset="UTF-8"></head><body>';
        html += `<h2>${branding.companyName} - Parking History Report</h2>`;
        html += `<p>Period: ${getFilterLabel()} | Exported: ${new Date().toLocaleString()}</p>`;
        html += `<table border="1" style="border-collapse: collapse;">`;
        html += `<tr style="background:#f0f0f0;"><th>Plate Number</th><th>Vehicle Type</th><th>Customer</th><th>Phone</th><th>Parked At</th><th>Released At</th><th>Space</th><th>Rate</th><th>Fee (${currency})</th><th>Status</th><th>Released By</th></tr>`;
        
        let totalFee = 0;
        let clearedFee = 0;
        
        data.forEach(record => {
            const paymentInfo = getPaymentStatus(record.id);
            const isCleared = paymentInfo.status === 'cleared';
            totalFee += record.parkingFee || 0;
            if (isCleared) clearedFee += record.parkingFee || 0;
            
            html += `<tr>`;
            html += `<td>${record.plateNumber || '-'}</td>`;
            html += `<td>${record.vehicleType || '-'}</td>`;
            html += `<td>${record.customerName || 'Walk-in'}</td>`;
            html += `<td>${record.customerPhone || '-'}</td>`;
            html += `<td>${record.parkedAt ? new Date(record.parkedAt).toLocaleString() : '-'}</td>`;
            html += `<td>${record.releasedAt ? new Date(record.releasedAt).toLocaleString() : '-'}</td>`;
            html += `<td>${record.parkingSpaceName || '-'}</td>`;
            html += `<td>${record.rateApplied || 'Standard'}</td>`;
            html += `<td style="text-align:right;">${(record.parkingFee || 0).toLocaleString()}</td>`;
            html += `<td>${isCleared ? 'Cleared' : 'Pending'}</td>`;
            html += `<td>${record.releasedBy?.name || '-'}</td>`;
            html += `</tr>`;
        });
        
        html += `<tr style="background:#f0f0f0; font-weight:bold;"><td colspan="8" style="text-align:right;">Total:</td><td style="text-align:right;">${totalFee.toLocaleString()}</td><td colspan="2"></td></tr>`;
        html += `<tr style="background:#dcfce7; font-weight:bold;"><td colspan="8" style="text-align:right;">Cleared Revenue:</td><td style="text-align:right;">${clearedFee.toLocaleString()}</td><td colspan="2"></td></tr>`;
        html += '</table></body></html>';
        
        const blob = new Blob([html], { type: 'application/vnd.ms-excel' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `parking_history_${historyDateFilter}_${new Date().toISOString().split('T')[0]}.xls`;
        a.click();
        URL.revokeObjectURL(url);
    };

    // Export parking history to PDF
    const exportHistoryToPDF = () => {
        const branding = getBrandingForReceipts();
        const currency = branding.currencySymbol || 'KES';
        const data = filteredHistory;
        
        if (data.length === 0) {
            showAlert('No Data', 'No records to export for the selected filter.', 'info');
            return;
        }
        
        let totalFee = 0;
        let clearedFee = 0;
        let clearedCount = 0;
        
        data.forEach(record => {
            const paymentInfo = getPaymentStatus(record.id);
            totalFee += record.parkingFee || 0;
            if (paymentInfo.status === 'cleared') {
                clearedFee += record.parkingFee || 0;
                clearedCount++;
            }
        });
        
        const printWindow = window.open('', '_blank');
        if (!printWindow) {
            showAlert('Print Blocked', 'Please allow popups to generate the PDF.', 'warning');
            return;
        }
        
        let html = `<!DOCTYPE html><html><head><title>Parking History Report</title><style>
            body { font-family: Arial, sans-serif; padding: 20px; font-size: 12px; }
            h1 { color: #1f2937; margin-bottom: 5px; font-size: 20px; }
            .subtitle { color: #6b7280; margin-bottom: 20px; }
            table { width: 100%; border-collapse: collapse; margin-top: 15px; }
            th, td { border: 1px solid #e5e7eb; padding: 8px; text-align: left; }
            th { background: #f3f4f6; font-weight: 600; font-size: 11px; }
            .text-right { text-align: right; }
            .text-center { text-align: center; }
            .cleared { background: #dcfce7; color: #166534; }
            .pending { background: #fef3c7; color: #92400e; }
            .stats { display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; }
            .stat-box { padding: 12px 16px; border: 1px solid #e5e7eb; background: #f9fafb; }
            .stat-box strong { display: block; font-size: 18px; color: #1f2937; }
            .stat-box span { font-size: 11px; color: #6b7280; }
            .total-row { font-weight: bold; background: #f3f4f6; }
            .footer { margin-top: 20px; text-align: center; font-size: 10px; color: #9ca3af; }
            @media print { body { padding: 10px; } }
        </style></head><body>`;
        
        html += `<h1>${branding.companyName}</h1>`;
        html += `<div class="subtitle">Parking History Report ‚Ä¢ ${getFilterLabel()} ‚Ä¢ Generated: ${new Date().toLocaleString()}</div>`;
        
        html += `<div class="stats">`;
        html += `<div class="stat-box"><strong>${data.length}</strong><span>Total Vehicles</span></div>`;
        html += `<div class="stat-box"><strong>${clearedCount}</strong><span>Cleared</span></div>`;
        html += `<div class="stat-box"><strong>${data.length - clearedCount}</strong><span>Pending</span></div>`;
        html += `<div class="stat-box"><strong>${currency} ${totalFee.toLocaleString()}</strong><span>Total Fees</span></div>`;
        html += `<div class="stat-box"><strong>${currency} ${clearedFee.toLocaleString()}</strong><span>Cleared Revenue</span></div>`;
        html += `</div>`;
        
        html += `<table><thead><tr>`;
        html += `<th>Plate</th><th>Type</th><th>Customer</th><th>Phone</th><th>Parked</th><th>Released</th><th class="text-right">Fee</th><th class="text-center">Status</th></tr></thead><tbody>`;
        
        data.forEach(record => {
            const paymentInfo = getPaymentStatus(record.id);
            const isCleared = paymentInfo.status === 'cleared';
            
            html += `<tr>`;
            html += `<td><strong>${record.plateNumber || '-'}</strong></td>`;
            html += `<td>${record.vehicleType || '-'}</td>`;
            html += `<td>${record.customerName || 'Walk-in'}</td>`;
            html += `<td>${record.customerPhone || '-'}</td>`;
            html += `<td>${record.parkedAt ? new Date(record.parkedAt).toLocaleString([], { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : '-'}</td>`;
            html += `<td>${record.releasedAt ? new Date(record.releasedAt).toLocaleString([], { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : '-'}</td>`;
            html += `<td class="text-right">${currency} ${(record.parkingFee || 0).toLocaleString()}</td>`;
            html += `<td class="text-center ${isCleared ? 'cleared' : 'pending'}">${isCleared ? 'Cleared' : 'Pending'}</td>`;
            html += `</tr>`;
        });
        
        html += `<tr class="total-row"><td colspan="6" class="text-right">Total:</td><td class="text-right">${currency} ${totalFee.toLocaleString()}</td><td></td></tr>`;
        html += `</tbody></table>`;
        
        html += `<div class="footer">`;
        if (branding.address) html += `<div>${branding.address}</div>`;
        if (branding.phone) html += `<div>${branding.phone}</div>`;
        html += `</div>`;
        
        html += `</body></html>`;
        
        printWindow.document.write(html);
        printWindow.document.close();
        setTimeout(() => printWindow.print(), 300);
    };

    // Get available spaces (not occupied)
    const getAvailableSpaces = () => {
        return (parkingSettings.parkingSpaces || []).filter(s => s.status === 'available');
    };

    // Get zones from spaces
    const getZones = () => {
        const zones = [...new Set((parkingSettings.parkingSpaces || []).map(s => s.zone))];
        return zones.sort();
    };

    // Handle add vehicle to parking
    const handleAddVehicle = async () => {
        if (!parkingForm.plateNumber.trim()) {
            showAlert('Error', 'Plate number is required', 'error');
            return;
        }
        if (!parkingForm.parkingSpaceId) {
            showAlert('Error', 'Please select a parking space', 'error');
            return;
        }
        if (!parkingForm.customerPhone.trim()) {
            showAlert('Error', 'Phone number is required', 'error');
            return;
        }
        
        setActionLoading(true);
        try {
            const services = window.FirebaseServices;
            const result = await services.parkingService.addToParking({
                plateNumber: parkingForm.plateNumber.toUpperCase(),
                vehicleType: parkingForm.vehicleType,
                customerName: parkingForm.customerName,
                customerPhone: parkingForm.customerPhone,
                notes: parkingForm.notes,
                parkingSpaceId: parkingForm.parkingSpaceId || null,
                parkingSpaceName: parkingForm.parkingSpaceId ? 
                    (parkingSettings.parkingSpaces || []).find(s => s.id === parkingForm.parkingSpaceId)?.name : null,
                source: 'manual'
            });
            
            if (result.success) {
                showAlert('Success', 'Vehicle added to parking successfully', 'success');
                setParkingForm({ plateNumber: '', vehicleType: 'Sedan', customerName: '', customerPhone: '', notes: '', parkingSpaceId: '' });
                setShowAddModal(false);
                setSelectedSpace(null);
            } else {
                showAlert('Error', result.error || 'Failed to add vehicle', 'error');
            }
        } catch (err) {
            showAlert('Error', 'Failed to add vehicle: ' + err.message, 'error');
        } finally {
            setActionLoading(false);
        }
    };

    // Handle add parking space
    const handleAddSpace = async () => {
        if (!spaceForm.name.trim()) {
            showAlert('Error', 'Space name is required', 'error');
            return;
        }
        
        setActionLoading(true);
        try {
            const services = window.FirebaseServices;
            const result = await services.parkingService.addParkingSpace(spaceForm);
            
            if (result.success) {
                showAlert('Success', 'Parking space added successfully', 'success');
                setSpaceForm({ name: '', zone: 'A', type: 'standard' });
                setShowAddSpaceModal(false);
            } else {
                showAlert('Error', result.error || 'Failed to add space', 'error');
            }
        } catch (err) {
            showAlert('Error', 'Failed to add space: ' + err.message, 'error');
        } finally {
            setActionLoading(false);
        }
    };

    // Handle bulk add parking spaces
    const handleBulkAddSpaces = async () => {
        if (bulkForm.startNum >= bulkForm.endNum) {
            showAlert('Error', 'End number must be greater than start number', 'error');
            return;
        }
        
        setActionLoading(true);
        try {
            const services = window.FirebaseServices;
            const result = await services.parkingService.bulkAddParkingSpaces(
                bulkForm.zone,
                bulkForm.prefix,
                bulkForm.startNum,
                bulkForm.endNum,
                bulkForm.type
            );
            
            if (result.success) {
                showAlert('Success', `${result.count} parking spaces added successfully`, 'success');
                setBulkForm({ zone: 'A', prefix: 'A', startNum: 1, endNum: 10, type: 'standard' });
                setShowBulkAddModal(false);
            } else {
                showAlert('Error', result.error || 'Failed to add spaces', 'error');
            }
        } catch (err) {
            showAlert('Error', 'Failed to add spaces: ' + err.message, 'error');
        } finally {
            setActionLoading(false);
        }
    };

    // Handle delete parking space
    const handleDeleteSpace = async (spaceId) => {
        showAlert(
            'Delete Space',
            'Are you sure you want to delete this parking space?',
            'warning',
            async () => {
                setActionLoading(true);
                try {
                    const services = window.FirebaseServices;
                    const result = await services.parkingService.deleteParkingSpace(spaceId);
                    
                    if (result.success) {
                        showAlert('Success', 'Parking space deleted successfully', 'success');
                    } else {
                        showAlert('Error', result.error || 'Failed to delete space', 'error');
                    }
                } catch (err) {
                    showAlert('Error', 'Failed to delete space: ' + err.message, 'error');
                } finally {
                    setActionLoading(false);
                }
            },
            true
        );
    };

    // Handle clicking on a parking space
    const handleSpaceClick = (space) => {
        if (space.status === 'occupied') {
            // Find the parked vehicle
            const vehicle = parkedVehicles.find(v => v.parkingSpaceId === space.id);
            if (vehicle) {
                setSelectedVehicle(vehicle);
                setSelectedRate('');
                setShowApplyFeeModal(true);
            }
        } else if (space.status === 'available') {
            // Open add vehicle modal with space pre-selected
            setSelectedSpace(space);
            setParkingForm({ ...parkingForm, parkingSpaceId: space.id });
            setShowAddModal(true);
        }
    };

    // Handle apply fee and release
    const handleApplyFeeAndRelease = async () => {
        if (!selectedVehicle || !selectedRate) {
            showAlert('Error', 'Please select a rate', 'error');
            return;
        }
        
        setActionLoading(true);
        try {
            const services = window.FirebaseServices;
            const rate = parkingSettings.rates?.find(r => r.name === selectedRate || r.id === selectedRate);
            
            if (!rate) {
                showAlert('Error', 'Rate not found', 'error');
                setActionLoading(false);
                return;
            }
            
            // Calculate fee
            const feeCalc = services.parkingService.calculateFee(selectedVehicle.parkedAt, parkingSettings.rates, selectedRate);
            
            // Create invoice in billing module FIRST (as pending/unpaid)
            if (services.billingService && feeCalc.fee > 0) {
                const invoiceResult = await services.billingService.createInvoice({
                    source: 'parking',
                    parkingRecordId: selectedVehicle.id,
                    plateNumber: selectedVehicle.plateNumber,
                    vehicleType: selectedVehicle.vehicleType || 'Vehicle',
                    customerName: selectedVehicle.customerName || 'Walk-in',
                    customerPhone: selectedVehicle.customerPhone || '',
                    services: [{ name: `Parking Fee (${rate.name})`, price: feeCalc.fee, duration: feeCalc.duration }],
                    totalAmount: feeCalc.fee,
                    notes: `Parking: ${feeCalc.duration} | Rate: ${rate.name}`,
                    parkingSpaceName: selectedVehicle.parkingSpaceName || null,
                    parkedAt: selectedVehicle.parkedAt,
                    releasedAt: new Date().toISOString(),
                    paymentStatus: 'unpaid'
                });
                
                if (!invoiceResult.success) {
                    showAlert('Error', 'Failed to create billing invoice: ' + (invoiceResult.error || 'Unknown error'), 'error');
                    setActionLoading(false);
                    return;
                }
                
                console.log('‚úÖ Parking invoice created:', invoiceResult.invoiceNumber);
            }
            
            // Apply fee and release vehicle to history
            await services.parkingService.applyFee(selectedVehicle.id, feeCalc.fee, rate.name);
            await services.parkingService.releaseVehicle(selectedVehicle.id, 'pending'); // Mark as pending payment
            
            showAlert('Invoice Sent to Billing', `${selectedVehicle.plateNumber} released.\nFee: ${getCurrency()} ${feeCalc.fee.toLocaleString()}\n\nInvoice sent to Billing for payment processing.`, 'success');
            setShowApplyFeeModal(false);
            setSelectedVehicle(null);
            setSelectedRate('');
        } catch (err) {
            showAlert('Error', 'Failed to release vehicle: ' + err.message, 'error');
        } finally {
            setActionLoading(false);
        }
    };

    // Quick release with auto-calculated fee
    const handleQuickRelease = async (vehicle) => {
        const services = window.FirebaseServices;
        const feeCalc = services.parkingService.calculateFee(vehicle.parkedAt, parkingSettings.rates);
        
        showAlert(
            'Release Vehicle',
            `Release ${vehicle.plateNumber}?\n\nFee: ${getCurrency()} ${feeCalc.fee.toLocaleString()}\nDuration: ${feeCalc.duration}\nRate: ${feeCalc.rateUsed}\n\nInvoice will be sent to Billing for payment.`,
            'info',
            async () => {
                setActionLoading(true);
                try {
                    // Create invoice in billing module FIRST (as pending/unpaid)
                    if (services.billingService && feeCalc.fee > 0) {
                        const invoiceResult = await services.billingService.createInvoice({
                            source: 'parking',
                            parkingRecordId: vehicle.id,
                            plateNumber: vehicle.plateNumber,
                            vehicleType: vehicle.vehicleType || 'Vehicle',
                            customerName: vehicle.customerName || 'Walk-in',
                            customerPhone: vehicle.customerPhone || '',
                            services: [{ name: `Parking Fee (${feeCalc.rateUsed})`, price: feeCalc.fee, duration: feeCalc.duration }],
                            totalAmount: feeCalc.fee,
                            notes: `Parking: ${feeCalc.duration} | Rate: ${feeCalc.rateUsed}`,
                            parkingSpaceName: vehicle.parkingSpaceName || null,
                            parkedAt: vehicle.parkedAt,
                            releasedAt: new Date().toISOString(),
                            paymentStatus: 'unpaid'
                        });
                        
                        if (!invoiceResult.success) {
                            showAlert('Error', 'Failed to create billing invoice: ' + (invoiceResult.error || 'Unknown error'), 'error');
                            setActionLoading(false);
                            return;
                        }
                        
                        console.log('‚úÖ Parking invoice created:', invoiceResult.invoiceNumber);
                    }
                    
                    // Apply fee and release vehicle to history
                    await services.parkingService.applyFee(vehicle.id, feeCalc.fee, feeCalc.rateUsed);
                    await services.parkingService.releaseVehicle(vehicle.id, 'pending'); // Mark as pending payment
                    
                    showAlert('Invoice Sent to Billing', `${vehicle.plateNumber} released.\nFee: ${getCurrency()} ${feeCalc.fee.toLocaleString()}\n\nInvoice sent to Billing for payment.`, 'success');
                } catch (err) {
                    showAlert('Error', 'Failed to release vehicle: ' + err.message, 'error');
                } finally {
                    setActionLoading(false);
                }
            },
            true
        );
    };

    // Waive parking fee and release vehicle (for inactive/short stays)
    const handleWaiveFee = async (vehicle) => {
        showAlert(
            'Waive Parking Fee',
            `Waive fee for ${vehicle.plateNumber}?\n\nThe vehicle will be released with no charge.\nThis will be recorded in history as "Waived".`,
            'info',
            async () => {
                setActionLoading(true);
                try {
                    const services = window.FirebaseServices;
                    await services.parkingService.waiveFee(vehicle.id, 'Short stay / Inactive');
                    showAlert('Success', `${vehicle.plateNumber} released.\nFee waived successfully.`, 'success');
                } catch (err) {
                    showAlert('Error', 'Failed to waive fee: ' + err.message, 'error');
                } finally {
                    setActionLoading(false);
                }
            },
            true
        );
    };

    // Save settings
    const handleSaveSettings = async () => {
        setActionLoading(true);
        try {
            const services = window.FirebaseServices;
            await services.parkingService.saveSettings(parkingSettings);
            showAlert('Success', 'Settings saved successfully', 'success');
            setShowSettingsModal(false);
        } catch (err) {
            showAlert('Error', 'Failed to save settings: ' + err.message, 'error');
        } finally {
            setActionLoading(false);
        }
    };

    // Filter vehicles by search
    const filteredVehicles = parkedVehicles.filter(v => {
        if (!searchQuery) return true;
        const q = searchQuery.toLowerCase();
        return v.plateNumber?.toLowerCase().includes(q) || 
               v.customerName?.toLowerCase().includes(q) ||
               v.vehicleType?.toLowerCase().includes(q);
    });

    // Memoize history filter for better performance
    const filteredHistory = React.useMemo(() => {
        return parkingHistory.filter(v => {
            // Date filter
            if (historyDateFilter !== 'all') {
                const recordDate = v.releasedAt ? new Date(v.releasedAt) : null;
                if (!recordDate) return false;
                
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                const weekAgo = new Date(today);
                weekAgo.setDate(weekAgo.getDate() - 7);
                const monthAgo = new Date(today);
                monthAgo.setMonth(monthAgo.getMonth() - 1);
                
                if (historyDateFilter === 'today' && recordDate < today) return false;
                if (historyDateFilter === 'yesterday' && (recordDate < yesterday || recordDate >= today)) return false;
                if (historyDateFilter === 'week' && recordDate < weekAgo) return false;
                if (historyDateFilter === 'month' && recordDate < monthAgo) return false;
            }
            
            // Search filter
            if (!historySearch) return true;
            const q = historySearch.toLowerCase();
            return v.plateNumber?.toLowerCase().includes(q) || 
                   v.customerName?.toLowerCase().includes(q);
        });
    }, [parkingHistory, historyDateFilter, historySearch]);

    // Pagination calculations - memoized for performance
    const paginationData = React.useMemo(() => {
        const totalItems = filteredHistory.length;
        const totalPages = Math.ceil(totalItems / itemsPerPage);
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const paginatedItems = filteredHistory.slice(startIndex, endIndex);
        
        // Calculate page range for pagination controls (show max 7 pages)
        let startPage = Math.max(1, currentPage - 3);
        let endPage = Math.min(totalPages, startPage + 6);
        if (endPage - startPage < 6) {
            startPage = Math.max(1, endPage - 6);
        }
        const pageNumbers = [];
        for (let i = startPage; i <= endPage; i++) {
            pageNumbers.push(i);
        }
        
        return {
            totalItems,
            totalPages,
            startIndex,
            endIndex: Math.min(endIndex, totalItems),
            paginatedItems,
            pageNumbers,
            hasNext: currentPage < totalPages,
            hasPrev: currentPage > 1
        };
    }, [filteredHistory, currentPage, itemsPerPage]);

    // Reset to page 1 when filters change
    React.useEffect(() => {
        setCurrentPage(1);
    }, [historyDateFilter, historySearch, itemsPerPage]);

    // Filter spaces by zone - memoized
    const filteredSpaces = React.useMemo(() => {
        return (parkingSettings.parkingSpaces || []).filter(s => {
            if (selectedZone === 'all') return true;
            return s.zone === selectedZone;
        });
    }, [parkingSettings.parkingSpaces, selectedZone]);

    // Get space stats - memoized
    const spaceStats = React.useMemo(() => {
        const spaces = parkingSettings.parkingSpaces || [];
        return {
            total: spaces.length,
            available: spaces.filter(s => s.status === 'available').length,
            occupied: spaces.filter(s => s.status === 'occupied').length,
            maintenance: spaces.filter(s => s.status === 'maintenance').length
        };
    }, [parkingSettings.parkingSpaces]);

    if (loading) {
        return (
            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', height: '400px' }}>
                <div style={{ textAlign: 'center' }}>
                    <div style={{ fontSize: '48px', marginBottom: '16px' }}>üÖøÔ∏è</div>
                    <p style={{ color: theme.textSecondary }}>Loading parking data...</p>
                </div>
            </div>
        );
    }

    return (
        <div style={{ padding: '24px' }}>
            {/* Stats Cards */}
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(180px, 1fr))', gap: '16px', marginBottom: '24px' }}>
                <div style={{ backgroundColor: theme.bg, borderRadius: '2px', padding: '20px', border: `1px solid ${theme.border}` }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                        <div style={{ width: '48px', height: '48px', borderRadius: '2px', backgroundColor: '#dbeafe', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '24px' }}>üÖøÔ∏è</div>
                        <div>
                            <div style={{ fontSize: '28px', fontWeight: '700', color: theme.text }}>{spaceStats.total}</div>
                            <div style={{ fontSize: '13px', color: theme.textSecondary }}>Total Spaces</div>
                        </div>
                    </div>
                </div>
                <div style={{ backgroundColor: theme.bg, borderRadius: '2px', padding: '20px', border: `1px solid ${theme.border}` }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                        <div style={{ width: '48px', height: '48px', borderRadius: '2px', backgroundColor: '#d1fae5', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '24px' }}>‚úÖ</div>
                        <div>
                            <div style={{ fontSize: '28px', fontWeight: '700', color: '#10b981' }}>{spaceStats.available}</div>
                            <div style={{ fontSize: '13px', color: theme.textSecondary }}>Available</div>
                        </div>
                    </div>
                </div>
                <div style={{ backgroundColor: theme.bg, borderRadius: '2px', padding: '20px', border: `1px solid ${theme.border}` }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                        <div style={{ width: '48px', height: '48px', borderRadius: '2px', backgroundColor: '#fef3c7', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '24px' }}>üöó</div>
                        <div>
                            <div style={{ fontSize: '28px', fontWeight: '700', color: '#f59e0b' }}>{spaceStats.occupied}</div>
                            <div style={{ fontSize: '13px', color: theme.textSecondary }}>Occupied</div>
                        </div>
                    </div>
                </div>
                <div style={{ backgroundColor: theme.bg, borderRadius: '2px', padding: '20px', border: `1px solid ${theme.border}` }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                        <div style={{ width: '48px', height: '48px', borderRadius: '2px', backgroundColor: '#ede9fe', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '24px' }}>üí∞</div>
                        <div>
                            <div style={{ fontSize: '28px', fontWeight: '700', color: '#059669' }}>{getCurrency()} {(stats.todayRevenue || 0).toLocaleString()}</div>
                            <div style={{ fontSize: '13px', color: theme.textSecondary }}>Today's Revenue</div>
                        </div>
                    </div>
                </div>
            </div>

            {/* Tabs & Actions */}
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px', flexWrap: 'wrap', gap: '12px' }}>
                <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                    {['spaces', 'parked', 'history'].map(tab => (
                        <button
                            key={tab}
                            onClick={() => setActiveTab(tab)}
                            style={{
                                padding: '10px 20px',
                                borderRadius: '2px',
                                border: 'none',
                                backgroundColor: activeTab === tab ? '#3b82f6' : theme.bgSecondary,
                                color: activeTab === tab ? 'white' : theme.text,
                                fontWeight: '600',
                                cursor: 'pointer',
                                position: 'relative'
                            }}
                        >
                            {tab === 'spaces' ? `üÖøÔ∏è Parking Area (${spaceStats.total})` : tab === 'parked' ? `üöó Parked (${parkedVehicles.length})` : 'üìã History'}
                        </button>
                    ))}
                </div>
                <div style={{ display: 'flex', gap: '10px', flexWrap: 'wrap' }}>
                    {activeTab === 'spaces' && (
                        <>
                            <select value={selectedZone} onChange={(e) => setSelectedZone(e.target.value)} style={{ ...selectStyle, width: '120px' }}>
                                <option value="all">All Zones</option>
                                {getZones().map(z => <option key={z} value={z}>Zone {z}</option>)}
                            </select>
                            <button onClick={() => setShowBulkAddModal(true)} style={{ ...btnSecondary, display: 'flex', alignItems: 'center', gap: '6px' }}>
                                üì¶ Bulk Add
                            </button>
                            <button onClick={() => setShowAddSpaceModal(true)} style={{ ...btnSecondary, display: 'flex', alignItems: 'center', gap: '6px' }}>
                                ‚ûï Add Space
                            </button>
                        </>
                    )}
                    <button onClick={() => setShowSettingsModal(true)} style={{ ...btnSecondary, display: 'flex', alignItems: 'center', gap: '6px' }}>
                        ‚öôÔ∏è Settings
                    </button>
                    <button onClick={() => { setParkingForm({ plateNumber: '', vehicleType: 'Sedan', customerName: '', customerPhone: '', notes: '', parkingSpaceId: '' }); setSelectedSpace(null); setShowAddModal(true); }} style={{ ...btnPrimary, backgroundColor: '#10b981', display: 'flex', alignItems: 'center', gap: '6px' }}>
                        + Add Vehicle
                    </button>
                </div>
            </div>

            {/* Parking Spaces Grid View */}
            {activeTab === 'spaces' && (
                <div style={{ backgroundColor: theme.bg, borderRadius: '2px', border: `1px solid ${theme.border}`, padding: '20px' }}>
                    {!spacesLoaded ? (
                        /* Fast skeleton loading - shows instantly */
                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(100px, 1fr))', gap: '12px' }}>
                            {[...Array(12)].map((_, i) => (
                                <div key={i} style={{
                                    padding: '12px',
                                    borderRadius: '8px',
                                    border: '2px solid #e2e8f0',
                                    backgroundColor: isDark ? '#334155' : '#f1f5f9',
                                    minHeight: '80px',
                                    display: 'flex',
                                    flexDirection: 'column',
                                    justifyContent: 'center',
                                    alignItems: 'center',
                                    animation: 'pulse 1.5s ease-in-out infinite'
                                }}>
                                    <div style={{ width: '40px', height: '16px', backgroundColor: isDark ? '#475569' : '#e2e8f0', borderRadius: '4px', marginBottom: '8px' }}></div>
                                    <div style={{ width: '60px', height: '10px', backgroundColor: isDark ? '#475569' : '#e2e8f0', borderRadius: '4px' }}></div>
                                </div>
                            ))}
                        </div>
                    ) : filteredSpaces.length === 0 ? (
                        <div style={{ padding: '60px 20px', textAlign: 'center' }}>
                            <div style={{ fontSize: '48px', marginBottom: '16px' }}>üÖøÔ∏è</div>
                            <h3 style={{ color: theme.text, marginBottom: '8px' }}>No Parking Spaces Configured</h3>
                            <p style={{ color: theme.textSecondary, fontSize: '14px', marginBottom: '20px' }}>Add parking spaces to visualize your parking area</p>
                            <div style={{ display: 'flex', gap: '12px', justifyContent: 'center' }}>
                                <button onClick={() => setShowBulkAddModal(true)} style={{ ...btnPrimary, backgroundColor: '#3b82f6' }}>üì¶ Bulk Add Spaces</button>
                                <button onClick={() => setShowAddSpaceModal(true)} style={btnSecondary}>‚ûï Add Single Space</button>
                            </div>
                        </div>
                    ) : (
                        <>
                            {/* Legend */}
                            <div style={{ display: 'flex', gap: '20px', marginBottom: '20px', flexWrap: 'wrap' }}>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                    <div style={{ width: '20px', height: '20px', backgroundColor: '#d1fae5', border: '2px solid #10b981', borderRadius: '4px' }}></div>
                                    <span style={{ fontSize: '13px', color: theme.textSecondary }}>Available</span>
                                </div>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                    <div style={{ width: '20px', height: '20px', backgroundColor: '#fee2e2', border: '2px solid #ef4444', borderRadius: '4px' }}></div>
                                    <span style={{ fontSize: '13px', color: theme.textSecondary }}>Occupied</span>
                                </div>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                    <div style={{ width: '20px', height: '20px', backgroundColor: '#fef3c7', border: '2px solid #f59e0b', borderRadius: '4px' }}></div>
                                    <span style={{ fontSize: '13px', color: theme.textSecondary }}>Maintenance</span>
                                </div>
                            </div>
                            
                            {/* Parking Grid */}
                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(100px, 1fr))', gap: '12px' }}>
                                {filteredSpaces.map(space => {
                                    const isOccupied = space.status === 'occupied';
                                    const isMaintenance = space.status === 'maintenance';
                                    const vehicle = isOccupied ? parkedVehicles.find(v => v.parkingSpaceId === space.id) : null;
                                    const typeInfo = SPACE_TYPES.find(t => t.id === space.type) || SPACE_TYPES[0];
                                    
                                    return (
                                        <div
                                            key={space.id}
                                            onClick={() => handleSpaceClick(space)}
                                            style={{
                                                padding: '12px',
                                                borderRadius: '8px',
                                                border: `2px solid ${isOccupied ? '#ef4444' : isMaintenance ? '#f59e0b' : '#10b981'}`,
                                                backgroundColor: isOccupied ? '#fee2e2' : isMaintenance ? '#fef3c7' : '#d1fae5',
                                                cursor: isMaintenance ? 'not-allowed' : 'pointer',
                                                transition: 'all 0.2s',
                                                minHeight: '80px',
                                                display: 'flex',
                                                flexDirection: 'column',
                                                justifyContent: 'center',
                                                alignItems: 'center',
                                                position: 'relative'
                                            }}
                                        >
                                            {/* Space Type Badge */}
                                            {space.type !== 'standard' && (
                                                <div style={{
                                                    position: 'absolute',
                                                    top: '4px',
                                                    right: '4px',
                                                    fontSize: '10px',
                                                    padding: '2px 6px',
                                                    borderRadius: '10px',
                                                    backgroundColor: typeInfo.color,
                                                    color: 'white',
                                                    fontWeight: '600'
                                                }}>
                                                    {typeInfo.name}
                                                </div>
                                            )}
                                            
                                            {/* Space Name */}
                                            <div style={{ fontSize: '18px', fontWeight: '700', color: isOccupied ? '#dc2626' : isMaintenance ? '#d97706' : '#059669' }}>
                                                {space.name}
                                            </div>
                                            
                                            {/* Vehicle Info or Status */}
                                            {isOccupied && vehicle ? (
                                                <div style={{ fontSize: '11px', color: '#7f1d1d', marginTop: '4px', textAlign: 'center' }}>
                                                    <div style={{ fontWeight: '600' }}>{vehicle.plateNumber}</div>
                                                    <div>{vehicle.vehicleType}</div>
                                                </div>
                                            ) : isOccupied && space.currentVehicle ? (
                                                <div style={{ fontSize: '11px', color: '#7f1d1d', marginTop: '4px', textAlign: 'center' }}>
                                                    <div style={{ fontWeight: '600' }}>{space.currentVehicle.plateNumber}</div>
                                                </div>
                                            ) : (
                                                <div style={{ fontSize: '11px', color: isMaintenance ? '#92400e' : '#047857', marginTop: '4px' }}>
                                                    {isMaintenance ? 'Under Maintenance' : 'Available'}
                                                </div>
                                            )}
                                            
                                            {/* Delete button (only for available spaces) */}
                                            {!isOccupied && !isMaintenance && (
                                                <button
                                                    onClick={(e) => { e.stopPropagation(); handleDeleteSpace(space.id); }}
                                                    style={{
                                                        position: 'absolute',
                                                        bottom: '4px',
                                                        right: '4px',
                                                        background: 'none',
                                                        border: 'none',
                                                        fontSize: '12px',
                                                        cursor: 'pointer',
                                                        color: '#dc2626',
                                                        opacity: 0.6
                                                    }}
                                                    title="Delete space"
                                                >
                                                    üóëÔ∏è
                                                </button>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                        </>
                    )}
                </div>
            )}

            {/* Parked Vehicles Tab */}
            {activeTab === 'parked' && (
                <div style={{ backgroundColor: theme.bg, borderRadius: '2px', border: `1px solid ${theme.border}`, overflow: 'hidden' }}>
                    {/* Search bar */}
                    <div style={{ padding: '16px', borderBottom: `1px solid ${theme.border}` }}>
                        <input
                            type="text"
                            placeholder="Search by plate number, customer..."
                            value={searchQuery}
                            onChange={(e) => setSearchQuery(e.target.value)}
                            style={{ ...inputStyle, maxWidth: '300px' }}
                        />
                    </div>
                    {filteredVehicles.length === 0 ? (
                        <div style={{ padding: '60px 20px', textAlign: 'center' }}>
                            <div style={{ fontSize: '48px', marginBottom: '16px' }}>üÖøÔ∏è</div>
                            <h3 style={{ color: theme.text, marginBottom: '8px' }}>No Vehicles Parked</h3>
                            <p style={{ color: theme.textSecondary, fontSize: '14px' }}>Click "Add Vehicle" to add a vehicle to parking</p>
                        </div>
                    ) : (
                        <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                            <thead>
                                <tr style={{ backgroundColor: theme.bgSecondary }}>
                                    <th style={{ padding: '14px 16px', textAlign: 'left', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase' }}>Vehicle</th>
                                    <th style={{ padding: '14px 16px', textAlign: 'center', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase' }}>Space</th>
                                    <th style={{ padding: '14px 16px', textAlign: 'left', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase' }}>Customer</th>
                                    <th style={{ padding: '14px 16px', textAlign: 'center', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase' }}>Parked At</th>
                                    <th style={{ padding: '14px 16px', textAlign: 'center', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase' }}>Duration</th>
                                    <th style={{ padding: '14px 16px', textAlign: 'center', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase' }}>Parking Status</th>
                                    <th style={{ padding: '14px 16px', textAlign: 'right', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase' }}>Est. Fee</th>
                                    <th style={{ padding: '14px 16px', textAlign: 'center', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase' }}>Fee Status</th>
                                    <th style={{ padding: '14px 16px', textAlign: 'center', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase' }}>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {filteredVehicles.map(vehicle => {
                                    const services = window.FirebaseServices;
                                    // Re-calculate fee on each render (triggered by clockTick for real-time updates)
                                    const feeCalc = services.parkingService.calculateFee(vehicle.parkedAt, parkingSettings.rates);
                                    const parkedTime = new Date(vehicle.parkedAt);
                                    // Determine fee status - applied if fee was sent to billing
                                    const isFeeApplied = vehicle.feeAppliedAt || vehicle.parkingFee > 0;
                                    // Check if meets minimum threshold (at least 1 hour or configured grace period)
                                    const gracePeriodMinutes = parkingSettings.gracePeriod || 15;
                                    const meetsThreshold = feeCalc.totalMinutes >= gracePeriodMinutes;
                                    return (
                                        <tr key={vehicle.id} style={{ borderTop: `1px solid ${theme.border}` }}>
                                            <td style={{ padding: '14px 16px' }}>
                                                <div style={{ fontWeight: '600', color: theme.text, fontSize: '15px' }}>{vehicle.plateNumber}</div>
                                                <div style={{ fontSize: '12px', color: theme.textSecondary }}>{vehicle.vehicleType}</div>
                                            </td>
                                            <td style={{ padding: '14px 16px', textAlign: 'center' }}>
                                                {vehicle.parkingSpaceName ? (
                                                    <span style={{ padding: '4px 10px', backgroundColor: '#dbeafe', color: '#1d4ed8', borderRadius: '4px', fontSize: '12px', fontWeight: '600' }}>
                                                        {vehicle.parkingSpaceName}
                                                    </span>
                                                ) : (
                                                    <span style={{ color: theme.textSecondary, fontSize: '12px' }}>‚Äî</span>
                                                )}
                                            </td>
                                            <td style={{ padding: '14px 16px' }}>
                                                <div style={{ fontWeight: '500', color: theme.text }}>{vehicle.customerName || 'Walk-in'}</div>
                                                {vehicle.customerPhone && <div style={{ fontSize: '12px', color: theme.textSecondary }}>{vehicle.customerPhone}</div>}
                                            </td>
                                            <td style={{ padding: '14px 16px', textAlign: 'center', fontSize: '13px', color: theme.text }}>
                                                {parkedTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                                                <div style={{ fontSize: '11px', color: theme.textSecondary }}>{parkedTime.toLocaleDateString()}</div>
                                            </td>
                                            <td style={{ padding: '14px 16px', textAlign: 'center' }}>
                                                <span style={{ fontWeight: '600', color: feeCalc.hours >= 24 ? '#dc2626' : feeCalc.hours >= 6 ? '#f59e0b' : '#10b981', fontSize: '14px' }}>
                                                    {feeCalc.duration}
                                                </span>
                                            </td>
                                            <td style={{ padding: '14px 16px', textAlign: 'center' }}>
                                                {meetsThreshold ? (
                                                    <span style={{ 
                                                        padding: '4px 10px', 
                                                        backgroundColor: '#d1fae5', 
                                                        color: '#059669', 
                                                        borderRadius: '4px', 
                                                        fontSize: '11px', 
                                                        fontWeight: '600' 
                                                    }}>
                                                        üü¢ Active
                                                    </span>
                                                ) : (
                                                    <span style={{ 
                                                        padding: '4px 10px', 
                                                        backgroundColor: isDark ? '#334155' : '#f1f5f9', 
                                                        color: theme.textSecondary, 
                                                        borderRadius: '4px', 
                                                        fontSize: '11px', 
                                                        fontWeight: '600' 
                                                    }}>
                                                        ‚è≥ Inactive
                                                    </span>
                                                )}
                                            </td>
                                            <td style={{ padding: '14px 16px', textAlign: 'right' }}>
                                                <div style={{ fontWeight: '600', color: '#059669', fontSize: '15px' }}>{getCurrency()} {feeCalc.fee.toLocaleString()}</div>
                                                <div style={{ fontSize: '11px', color: theme.textSecondary }}>
                                                    {feeCalc.rateUsed} {feeCalc.rateType ? `(${feeCalc.rateType === 'minute' ? `${getCurrency()} ${feeCalc.rateAmount}/min` : feeCalc.rateType === 'hourly' ? `${getCurrency()} ${feeCalc.rateAmount}/hr` : feeCalc.rateType === 'daily' ? `${getCurrency()} ${feeCalc.rateAmount}/day` : feeCalc.rateType})` : ''}
                                                </div>
                                            </td>
                                            <td style={{ padding: '14px 16px', textAlign: 'center' }}>
                                                {isFeeApplied ? (
                                                    <span style={{ 
                                                        padding: '4px 10px', 
                                                        backgroundColor: '#d1fae5', 
                                                        color: '#059669', 
                                                        borderRadius: '4px', 
                                                        fontSize: '11px', 
                                                        fontWeight: '600' 
                                                    }}>
                                                        ‚úì Applied
                                                    </span>
                                                ) : meetsThreshold ? (
                                                    <span style={{ 
                                                        padding: '4px 10px', 
                                                        backgroundColor: '#fef3c7', 
                                                        color: '#d97706', 
                                                        borderRadius: '4px', 
                                                        fontSize: '11px', 
                                                        fontWeight: '600' 
                                                    }}>
                                                        Pending
                                                    </span>
                                                ) : (
                                                    <span style={{ 
                                                        padding: '4px 10px', 
                                                        backgroundColor: isDark ? '#334155' : '#f1f5f9', 
                                                        color: theme.textSecondary, 
                                                        borderRadius: '4px', 
                                                        fontSize: '11px', 
                                                        fontWeight: '600' 
                                                    }}>
                                                        Not Applied
                                                    </span>
                                                )}
                                            </td>
                                            <td style={{ padding: '14px 16px', textAlign: 'center' }}>
                                                <div style={{ display: 'flex', gap: '6px', justifyContent: 'center', flexWrap: 'wrap' }}>
                                                    <button
                                                        onClick={() => { setSelectedVehicle(vehicle); setSelectedRate(''); setShowApplyFeeModal(true); }}
                                                        style={{ padding: '6px 12px', borderRadius: '2px', border: 'none', backgroundColor: '#dbeafe', color: '#1d4ed8', fontSize: '12px', fontWeight: '500', cursor: 'pointer' }}
                                                    >
                                                        Apply Fee
                                                    </button>
                                                    <button
                                                        onClick={() => handleQuickRelease(vehicle)}
                                                        disabled={actionLoading}
                                                        style={{ padding: '6px 12px', borderRadius: '2px', border: 'none', backgroundColor: '#d1fae5', color: '#059669', fontSize: '12px', fontWeight: '500', cursor: 'pointer' }}
                                                    >
                                                        Release
                                                    </button>
                                                    {!meetsThreshold && (
                                                        <button
                                                            onClick={() => handleWaiveFee(vehicle)}
                                                            disabled={actionLoading}
                                                            style={{ padding: '6px 12px', borderRadius: '2px', border: 'none', backgroundColor: '#fef3c7', color: '#d97706', fontSize: '12px', fontWeight: '500', cursor: 'pointer' }}
                                                        >
                                                            Waive
                                                        </button>
                                                    )}
                                                </div>
                                            </td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    )}
                </div>
            )}

            {/* History Tab */}
            {activeTab === 'history' && (
                <div style={{ backgroundColor: theme.bg, borderRadius: '2px', border: `1px solid ${theme.border}`, overflow: 'hidden' }}>
                    {/* Search and Filter Bar */}
                    <div style={{ padding: '16px', borderBottom: `1px solid ${theme.border}`, display: 'flex', gap: '12px', flexWrap: 'wrap', alignItems: 'center', justifyContent: 'space-between' }}>
                        <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                            {[{ id: 'all', label: 'All' }, { id: 'today', label: 'Today' }, { id: 'yesterday', label: 'Yesterday' }, { id: 'week', label: 'This Week' }, { id: 'month', label: 'This Month' }].map(filter => (
                                <button
                                    key={filter.id}
                                    onClick={() => setHistoryDateFilter(filter.id)}
                                    style={{
                                        padding: '6px 14px',
                                        borderRadius: '20px',
                                        border: 'none',
                                        backgroundColor: historyDateFilter === filter.id ? '#3b82f6' : (isDark ? '#334155' : '#e2e8f0'),
                                        color: historyDateFilter === filter.id ? 'white' : theme.text,
                                        fontSize: '13px',
                                        fontWeight: '500',
                                        cursor: 'pointer',
                                        transition: 'all 0.2s'
                                    }}
                                >
                                    {filter.label}
                                </button>
                            ))}
                        </div>
                        <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
                            <input
                                type="text"
                                placeholder="Search plate, customer..."
                                value={historySearch}
                                onChange={(e) => setHistorySearch(e.target.value)}
                                style={{ ...inputStyle, width: '200px', padding: '8px 12px' }}
                            />
                            {historySearch && (
                                <button onClick={() => setHistorySearch('')} style={{ background: 'none', border: 'none', cursor: 'pointer', color: theme.textSecondary, fontSize: '16px' }}>√ó</button>
                            )}
                            <div style={{ borderLeft: `1px solid ${theme.border}`, height: '24px', margin: '0 4px' }}></div>
                            <button
                                onClick={exportHistoryToExcel}
                                style={{
                                    padding: '8px 12px',
                                    borderRadius: '4px',
                                    border: `1px solid ${theme.border}`,
                                    backgroundColor: theme.bg,
                                    color: theme.text,
                                    fontSize: '12px',
                                    fontWeight: '500',
                                    cursor: 'pointer',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '4px'
                                }}
                                title="Export to Excel"
                            >
                                üìä Excel
                            </button>
                            <button
                                onClick={exportHistoryToPDF}
                                style={{
                                    padding: '8px 12px',
                                    borderRadius: '4px',
                                    border: `1px solid ${theme.border}`,
                                    backgroundColor: theme.bg,
                                    color: theme.text,
                                    fontSize: '12px',
                                    fontWeight: '500',
                                    cursor: 'pointer',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '4px'
                                }}
                                title="Export to PDF"
                            >
                                üìÑ PDF
                            </button>
                        </div>
                    </div>
                    {/* Results count with pagination info */}
                    <div style={{ padding: '10px 16px', backgroundColor: theme.bgSecondary, fontSize: '13px', color: theme.textSecondary, borderBottom: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: '8px' }}>
                        <span>
                            Showing {paginationData.totalItems > 0 ? paginationData.startIndex + 1 : 0}-{paginationData.endIndex} of {paginationData.totalItems.toLocaleString()} records
                            {historyDateFilter !== 'all' && ` ‚Ä¢ Filter: ${historyDateFilter === 'today' ? 'Today' : historyDateFilter === 'yesterday' ? 'Yesterday' : historyDateFilter === 'week' ? 'This Week' : 'This Month'}`}
                        </span>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                            <span>Per page:</span>
                            <select 
                                value={itemsPerPage} 
                                onChange={(e) => setItemsPerPage(Number(e.target.value))}
                                style={{ padding: '4px 8px', borderRadius: '4px', border: `1px solid ${theme.border}`, background: theme.inputBg, color: theme.text, fontSize: '13px', cursor: 'pointer' }}
                            >
                                {ITEMS_PER_PAGE_OPTIONS.map(opt => (
                                    <option key={opt} value={opt}>{opt}</option>
                                ))}
                            </select>
                        </div>
                    </div>
                    {paginationData.totalItems === 0 ? (
                        <div style={{ padding: '60px 20px', textAlign: 'center' }}>
                            <div style={{ fontSize: '48px', marginBottom: '16px' }}>üìã</div>
                            <h3 style={{ color: theme.text, marginBottom: '8px' }}>No Parking History</h3>
                            <p style={{ color: theme.textSecondary, fontSize: '14px' }}>Released vehicles will appear here</p>
                        </div>
                    ) : (
                        <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                            <thead>
                                <tr style={{ backgroundColor: theme.bgSecondary }}>
                                    <th style={{ padding: '14px 16px', textAlign: 'left', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase' }}>Vehicle</th>
                                    <th style={{ padding: '14px 16px', textAlign: 'left', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase' }}>Customer</th>
                                    <th style={{ padding: '14px 16px', textAlign: 'left', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase' }}>Phone</th>
                                    <th style={{ padding: '14px 16px', textAlign: 'center', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase' }}>Parked</th>
                                    <th style={{ padding: '14px 16px', textAlign: 'center', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase' }}>Released</th>
                                    <th style={{ padding: '14px 16px', textAlign: 'center', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase' }}>Duration</th>
                                    <th style={{ padding: '14px 16px', textAlign: 'right', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase' }}>Rate Applied</th>
                                    <th style={{ padding: '14px 16px', textAlign: 'right', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase' }}>Fee</th>
                                    <th style={{ padding: '14px 16px', textAlign: 'center', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase' }}>Status</th>
                                    <th style={{ padding: '14px 16px', textAlign: 'center', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase' }}>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {paginationData.paginatedItems.map(record => {
                                    const paymentInfo = getPaymentStatus(record.id);
                                    const isCleared = paymentInfo.status === 'cleared';
                                    const isWaived = record.feeWaived === true;
                                    return (
                                        <tr key={record.id} style={{ borderTop: `1px solid ${theme.border}` }}>
                                            <td style={{ padding: '14px 16px' }}>
                                                <div style={{ fontWeight: '600', color: theme.text }}>{record.plateNumber}</div>
                                                <div style={{ fontSize: '12px', color: theme.textSecondary }}>{record.vehicleType}</div>
                                            </td>
                                            <td style={{ padding: '14px 16px', color: theme.text }}>{record.customerName || 'Walk-in'}</td>
                                            <td style={{ padding: '14px 16px', color: theme.text, fontSize: '13px' }}>
                                                {record.customerPhone ? (
                                                    <a href={`tel:${record.customerPhone}`} style={{ color: '#3b82f6', textDecoration: 'none' }}>{record.customerPhone}</a>
                                                ) : (
                                                    <span style={{ color: theme.textSecondary }}>-</span>
                                                )}
                                            </td>
                                            <td style={{ padding: '14px 16px', textAlign: 'center', fontSize: '13px', color: theme.text }}>
                                                {record.parkedAt ? new Date(record.parkedAt).toLocaleString([], { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : '-'}
                                            </td>
                                            <td style={{ padding: '14px 16px', textAlign: 'center', fontSize: '13px', color: theme.text }}>
                                                {record.releasedAt ? new Date(record.releasedAt).toLocaleString([], { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : '-'}
                                            </td>
                                            <td style={{ padding: '14px 16px', textAlign: 'center' }}>
                                                {(() => {
                                                    if (!record.parkedAt || !record.releasedAt) return '-';
                                                    const parked = new Date(record.parkedAt);
                                                    const released = new Date(record.releasedAt);
                                                    const diffMs = released - parked;
                                                    const totalMinutes = Math.floor(diffMs / 60000);
                                                    const hours = Math.floor(totalMinutes / 60);
                                                    const minutes = totalMinutes % 60;
                                                    if (hours >= 24) {
                                                        const days = Math.floor(hours / 24);
                                                        const remHours = hours % 24;
                                                        return <span style={{ fontWeight: '600', color: '#dc2626', fontSize: '13px' }}>{days}d {remHours}h {minutes}m</span>;
                                                    } else if (hours >= 6) {
                                                        return <span style={{ fontWeight: '600', color: '#f59e0b', fontSize: '13px' }}>{hours}h {minutes}m</span>;
                                                    } else {
                                                        return <span style={{ fontWeight: '600', color: '#10b981', fontSize: '13px' }}>{hours}h {minutes}m</span>;
                                                    }
                                                })()}
                                            </td>
                                            <td style={{ padding: '14px 16px', textAlign: 'right' }}>
                                                <div style={{ fontSize: '13px', fontWeight: '500', color: theme.text }}>
                                                    {isWaived ? 'Waived' : (record.rateUsed || 'Standard')}
                                                </div>
                                                <div style={{ fontSize: '11px', color: theme.textSecondary }}>
                                                    {isWaived ? 'No charge' : `${getCurrency()} ${(record.defaultRate || record.hourlyRate || record.parkingFee || 0).toLocaleString()}`}
                                                </div>
                                            </td>
                                            <td style={{ padding: '14px 16px', textAlign: 'right', fontWeight: '600', color: isWaived ? theme.textSecondary : '#059669' }}>
                                                {isWaived ? `${getCurrency()} 0` : `${getCurrency()} ${(record.parkingFee || 0).toLocaleString()}`}
                                            </td>
                                            <td style={{ padding: '14px 16px', textAlign: 'center' }}>
                                                <span style={{
                                                    display: 'inline-flex',
                                                    alignItems: 'center',
                                                    gap: '4px',
                                                    padding: '4px 12px',
                                                    borderRadius: '20px',
                                                    fontSize: '12px',
                                                    fontWeight: '600',
                                                    backgroundColor: isWaived ? '#e0e7ff' : (isCleared ? '#dcfce7' : '#fef3c7'),
                                                    color: isWaived ? '#4338ca' : (isCleared ? '#166534' : '#92400e')
                                                }}>
                                                    {isWaived ? 'üè∑Ô∏è Waived' : (isCleared ? '‚úì Cleared' : '‚è≥ Pending')}
                                                </span>
                                            </td>
                                            <td style={{ padding: '14px 16px', textAlign: 'center' }}>
                                                {(isWaived || isCleared) ? (
                                                    <button
                                                        onClick={() => printGatePass(record)}
                                                        style={{
                                                            padding: '6px 12px',
                                                            borderRadius: '4px',
                                                            border: 'none',
                                                            backgroundColor: '#3b82f6',
                                                            color: 'white',
                                                            fontSize: '12px',
                                                            fontWeight: '500',
                                                            cursor: 'pointer',
                                                            display: 'inline-flex',
                                                            alignItems: 'center',
                                                            gap: '4px'
                                                        }}
                                                        title="Print Gate Pass"
                                                    >
                                                        üñ®Ô∏è Gate Pass
                                                    </button>
                                                ) : (
                                                    <span style={{ fontSize: '12px', color: theme.textSecondary }}>Awaiting payment</span>
                                                )}
                                            </td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    )}
                    
                    {/* Pagination Controls */}
                    {paginationData.totalPages > 1 && (
                        <div style={{ 
                            padding: '16px', 
                            borderTop: `1px solid ${theme.border}`, 
                            display: 'flex', 
                            justifyContent: 'center', 
                            alignItems: 'center', 
                            gap: '4px',
                            flexWrap: 'wrap'
                        }}>
                            {/* First & Previous */}
                            <button
                                onClick={() => setCurrentPage(1)}
                                disabled={!paginationData.hasPrev}
                                style={{
                                    padding: '8px 12px',
                                    borderRadius: '4px',
                                    border: `1px solid ${theme.border}`,
                                    background: theme.bg,
                                    color: paginationData.hasPrev ? theme.text : theme.textSecondary,
                                    cursor: paginationData.hasPrev ? 'pointer' : 'not-allowed',
                                    fontSize: '13px',
                                    opacity: paginationData.hasPrev ? 1 : 0.5
                                }}
                                title="First page"
                            >
                                ‚ü®‚ü®
                            </button>
                            <button
                                onClick={() => setCurrentPage(p => Math.max(1, p - 1))}
                                disabled={!paginationData.hasPrev}
                                style={{
                                    padding: '8px 12px',
                                    borderRadius: '4px',
                                    border: `1px solid ${theme.border}`,
                                    background: theme.bg,
                                    color: paginationData.hasPrev ? theme.text : theme.textSecondary,
                                    cursor: paginationData.hasPrev ? 'pointer' : 'not-allowed',
                                    fontSize: '13px',
                                    opacity: paginationData.hasPrev ? 1 : 0.5
                                }}
                                title="Previous page"
                            >
                                ‚ü® Prev
                            </button>
                            
                            {/* Page Numbers */}
                            {paginationData.pageNumbers[0] > 1 && (
                                <span style={{ padding: '8px 4px', color: theme.textSecondary }}>...</span>
                            )}
                            {paginationData.pageNumbers.map(pageNum => (
                                <button
                                    key={pageNum}
                                    onClick={() => setCurrentPage(pageNum)}
                                    style={{
                                        padding: '8px 14px',
                                        borderRadius: '4px',
                                        border: pageNum === currentPage ? 'none' : `1px solid ${theme.border}`,
                                        background: pageNum === currentPage ? '#3b82f6' : theme.bg,
                                        color: pageNum === currentPage ? 'white' : theme.text,
                                        cursor: 'pointer',
                                        fontSize: '13px',
                                        fontWeight: pageNum === currentPage ? '600' : '400',
                                        minWidth: '40px'
                                    }}
                                >
                                    {pageNum.toLocaleString()}
                                </button>
                            ))}
                            {paginationData.pageNumbers[paginationData.pageNumbers.length - 1] < paginationData.totalPages && (
                                <span style={{ padding: '8px 4px', color: theme.textSecondary }}>...</span>
                            )}
                            
                            {/* Next & Last */}
                            <button
                                onClick={() => setCurrentPage(p => Math.min(paginationData.totalPages, p + 1))}
                                disabled={!paginationData.hasNext}
                                style={{
                                    padding: '8px 12px',
                                    borderRadius: '4px',
                                    border: `1px solid ${theme.border}`,
                                    background: theme.bg,
                                    color: paginationData.hasNext ? theme.text : theme.textSecondary,
                                    cursor: paginationData.hasNext ? 'pointer' : 'not-allowed',
                                    fontSize: '13px',
                                    opacity: paginationData.hasNext ? 1 : 0.5
                                }}
                                title="Next page"
                            >
                                Next ‚ü©
                            </button>
                            <button
                                onClick={() => setCurrentPage(paginationData.totalPages)}
                                disabled={!paginationData.hasNext}
                                style={{
                                    padding: '8px 12px',
                                    borderRadius: '4px',
                                    border: `1px solid ${theme.border}`,
                                    background: theme.bg,
                                    color: paginationData.hasNext ? theme.text : theme.textSecondary,
                                    cursor: paginationData.hasNext ? 'pointer' : 'not-allowed',
                                    fontSize: '13px',
                                    opacity: paginationData.hasNext ? 1 : 0.5
                                }}
                                title="Last page"
                            >
                                ‚ü©‚ü©
                            </button>
                            
                            {/* Jump to page */}
                            <div style={{ marginLeft: '16px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                                <span style={{ fontSize: '13px', color: theme.textSecondary }}>Go to:</span>
                                <input
                                    type="number"
                                    min="1"
                                    max={paginationData.totalPages}
                                    placeholder={currentPage.toString()}
                                    onKeyDown={(e) => {
                                        if (e.key === 'Enter') {
                                            const page = parseInt(e.target.value);
                                            if (page >= 1 && page <= paginationData.totalPages) {
                                                setCurrentPage(page);
                                                e.target.value = '';
                                            }
                                        }
                                    }}
                                    style={{
                                        width: '70px',
                                        padding: '6px 10px',
                                        borderRadius: '4px',
                                        border: `1px solid ${theme.border}`,
                                        background: theme.inputBg,
                                        color: theme.text,
                                        fontSize: '13px',
                                        textAlign: 'center'
                                    }}
                                />
                                <span style={{ fontSize: '13px', color: theme.textSecondary }}>of {paginationData.totalPages.toLocaleString()}</span>
                            </div>
                        </div>
                    )}
                </div>
            )}

            {/* Add Vehicle Modal */}
            {showAddModal && (
                <div style={modalOverlay} onClick={() => setShowAddModal(false)}>
                    <div style={{ ...modalContent, maxWidth: '550px' }} onClick={e => e.stopPropagation()}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px' }}>
                            <h2 style={{ margin: 0, fontSize: '18px', fontWeight: '600', color: theme.text }}>Add Vehicle to Parking</h2>
                            <button onClick={() => setShowAddModal(false)} style={{ background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer', color: theme.textSecondary }}>√ó</button>
                        </div>
                        
                        {/* Search from Intake Records Section */}
                        <div style={{ marginBottom: '20px', padding: '16px', backgroundColor: isDark ? '#0f172a' : '#f0f9ff', borderRadius: '8px', border: `1px solid ${isDark ? '#334155' : '#bae6fd'}` }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '12px' }}>
                                <span style={{ fontSize: '18px' }}>üîç</span>
                                <span style={{ fontSize: '14px', fontWeight: '600', color: theme.text }}>Search from Intake Records</span>
                            </div>
                            <div style={{ position: 'relative' }}>
                                <input
                                    type="text"
                                    value={intakeSearch}
                                    onChange={(e) => {
                                        setIntakeSearch(e.target.value);
                                        setShowIntakeResults(e.target.value.length >= 2);
                                    }}
                                    placeholder="Search by plate number or customer name..."
                                    style={{ ...inputStyle, paddingRight: '40px' }}
                                />
                                {intakeSearch && (
                                    <button
                                        onClick={() => { setIntakeSearch(''); setShowIntakeResults(false); }}
                                        style={{ position: 'absolute', right: '10px', top: '50%', transform: 'translateY(-50%)', background: 'none', border: 'none', fontSize: '18px', cursor: 'pointer', color: theme.textSecondary }}
                                    >√ó</button>
                                )}
                            </div>
                            
                            {/* Search Results Dropdown */}
                            {showIntakeResults && intakeSearch.length >= 2 && (
                                <div style={{ 
                                    marginTop: '8px', 
                                    maxHeight: '200px', 
                                    overflowY: 'auto', 
                                    backgroundColor: theme.bg, 
                                    border: `1px solid ${theme.border}`, 
                                    borderRadius: '6px',
                                    boxShadow: '0 4px 12px rgba(0,0,0,0.15)'
                                }}>
                                    {(() => {
                                        const searchLower = intakeSearch.toLowerCase();
                                        const filtered = intakeRecords.filter(r => 
                                            r.plateNumber?.toLowerCase().includes(searchLower) ||
                                            r.customerName?.toLowerCase().includes(searchLower) ||
                                            r.customerPhone?.includes(intakeSearch)
                                        ).slice(0, 10);
                                        
                                        if (filtered.length === 0) {
                                            return (
                                                <div style={{ padding: '16px', textAlign: 'center', color: theme.textSecondary, fontSize: '13px' }}>
                                                    No vehicles found in intake records
                                                </div>
                                            );
                                        }
                                        
                                        return filtered.map(record => (
                                            <div
                                                key={record.id}
                                                onClick={() => {
                                                    setParkingForm({
                                                        ...parkingForm,
                                                        plateNumber: record.plateNumber || '',
                                                        vehicleType: record.vehicleType || record.category || 'Sedan',
                                                        customerName: record.customerName || record.ownerName || '',
                                                        customerPhone: record.customerPhone || record.ownerPhone || '',
                                                        notes: record.notes || ''
                                                    });
                                                    setIntakeSearch('');
                                                    setShowIntakeResults(false);
                                                }}
                                                style={{
                                                    padding: '12px 16px',
                                                    borderBottom: `1px solid ${theme.border}`,
                                                    cursor: 'pointer',
                                                    transition: 'background 0.2s'
                                                }}
                                                onMouseEnter={(e) => e.currentTarget.style.backgroundColor = isDark ? '#334155' : '#f1f5f9'}
                                                onMouseLeave={(e) => e.currentTarget.style.backgroundColor = 'transparent'}
                                            >
                                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                                    <div>
                                                        <div style={{ fontWeight: '600', color: theme.text, fontSize: '14px' }}>{record.plateNumber}</div>
                                                        <div style={{ fontSize: '12px', color: theme.textSecondary }}>
                                                            {record.customerName || record.ownerName || 'Unknown'}
                                                            {record.customerPhone && ` ‚Ä¢ ${record.customerPhone}`}
                                                        </div>
                                                    </div>
                                                    <div style={{ fontSize: '12px', color: '#3b82f6', fontWeight: '500' }}>
                                                        {record.vehicleType || record.category || 'Vehicle'}
                                                    </div>
                                                </div>
                                            </div>
                                        ));
                                    })()}
                                </div>
                            )}
                            <div style={{ fontSize: '11px', color: theme.textSecondary, marginTop: '8px' }}>
                                üí° Search to auto-fill from existing vehicle records
                            </div>
                        </div>
                        
                        <div style={{ borderTop: `1px solid ${theme.border}`, paddingTop: '16px', marginBottom: '4px' }}>
                            <span style={{ fontSize: '12px', color: theme.textSecondary, textTransform: 'uppercase', fontWeight: '600' }}>Or Enter Manually</span>
                        </div>

                        <div style={{ marginBottom: '20px' }}>
                            <label style={labelStyle}>Plate Number *</label>
                            <input type="text" value={parkingForm.plateNumber} onChange={(e) => setParkingForm({...parkingForm, plateNumber: e.target.value.toUpperCase()})} placeholder="e.g. KAA 123X" style={inputStyle} required />
                        </div>

                        <div style={{ marginBottom: '20px' }}>
                            <label style={labelStyle}>Parking Space *</label>
                            <select value={parkingForm.parkingSpaceId} onChange={(e) => setParkingForm({...parkingForm, parkingSpaceId: e.target.value})} style={selectStyle}>
                                <option value="">Select a parking space...</option>
                                {getAvailableSpaces().map(space => (
                                    <option key={space.id} value={space.id}>{space.name} ({space.zone}) - {space.type}</option>
                                ))}
                            </select>
                            {selectedSpace && (
                                <div style={{ marginTop: '8px', padding: '8px 12px', backgroundColor: '#dbeafe', borderRadius: '4px', fontSize: '13px', color: '#1d4ed8' }}>
                                    Pre-selected: <strong>{selectedSpace.name}</strong>
                                </div>
                            )}
                            {getAvailableSpaces().length === 0 && parkingSettings.parkingSpaces?.length > 0 && (
                                <div style={{ marginTop: '8px', fontSize: '12px', color: '#f59e0b' }}>All parking spaces are occupied</div>
                            )}
                        </div>

                        <div style={{ marginBottom: '20px' }}>
                            <label style={labelStyle}>Vehicle Type</label>
                            <select value={parkingForm.vehicleType} onChange={(e) => setParkingForm({...parkingForm, vehicleType: e.target.value})} style={selectStyle}>
                                {VEHICLE_TYPES.map(t => <option key={t} value={t}>{t}</option>)}
                            </select>
                        </div>

                        <div style={{ marginBottom: '20px' }}>
                            <label style={labelStyle}>Customer Name</label>
                            <input type="text" value={parkingForm.customerName} onChange={(e) => setParkingForm({...parkingForm, customerName: e.target.value})} placeholder="Optional" style={inputStyle} />
                        </div>

                        <div style={{ marginBottom: '20px' }}>
                            <label style={labelStyle}>Phone Number *</label>
                            <input type="tel" value={parkingForm.customerPhone} onChange={(e) => setParkingForm({...parkingForm, customerPhone: e.target.value})} placeholder="e.g. 0712345678" style={inputStyle} required />
                        </div>

                        <div style={{ marginBottom: '20px' }}>
                            <label style={labelStyle}>Notes</label>
                            <textarea value={parkingForm.notes} onChange={(e) => setParkingForm({...parkingForm, notes: e.target.value})} placeholder="Any special notes..." style={{ ...inputStyle, minHeight: '80px', resize: 'vertical' }} />
                        </div>

                        <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end' }}>
                            <button style={btnSecondary} onClick={() => setShowAddModal(false)}>Cancel</button>
                            <button style={{ ...btnPrimary, backgroundColor: '#10b981' }} onClick={handleAddVehicle} disabled={actionLoading || !parkingForm.plateNumber || !parkingForm.parkingSpaceId || !parkingForm.customerPhone}>
                                {actionLoading ? 'Adding...' : 'Add to Parking'}
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* Apply Fee Modal */}
            {showApplyFeeModal && selectedVehicle && (
                <div style={modalOverlay} onClick={() => { setShowApplyFeeModal(false); setSelectedVehicle(null); }}>
                    <div style={modalContent} onClick={e => e.stopPropagation()}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px' }}>
                            <h2 style={{ margin: 0, fontSize: '18px', fontWeight: '600', color: theme.text }}>Apply Parking Fee</h2>
                            <button onClick={() => { setShowApplyFeeModal(false); setSelectedVehicle(null); }} style={{ background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer', color: theme.textSecondary }}>√ó</button>
                        </div>

                        <div style={{ padding: '16px', backgroundColor: isDark ? '#0f172a' : '#f0f9ff', borderRadius: '8px', marginBottom: '20px', border: `1px solid ${isDark ? '#334155' : '#bae6fd'}` }}>
                            <div style={{ fontSize: '24px', fontWeight: 'bold', color: theme.text, letterSpacing: '1px' }}>{selectedVehicle.plateNumber}</div>
                            <div style={{ fontSize: '13px', color: theme.textSecondary, marginTop: '4px' }}>
                                {selectedVehicle.vehicleType} ‚Ä¢ Parked: {new Date(selectedVehicle.parkedAt).toLocaleString()}
                            </div>
                            {(() => {
                                const now = new Date();
                                const entry = new Date(selectedVehicle.parkedAt);
                                const diffMs = now - entry;
                                const hours = Math.floor(diffMs / (1000 * 60 * 60));
                                const minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                                return (
                                    <div style={{ fontSize: '14px', fontWeight: '600', color: '#3b82f6', marginTop: '8px' }}>
                                        Duration: {hours}h {minutes}m
                                    </div>
                                );
                            })()}
                        </div>

                        <div style={{ marginBottom: '20px' }}>
                            <label style={labelStyle}>Select Parking Rate *</label>
                            <select value={selectedRate} onChange={(e) => setSelectedRate(e.target.value)} style={selectStyle}>
                                <option value="">Choose a rate...</option>
                                {parkingSettings.rates?.map((rate, index) => (
                                    <option key={index} value={rate.name || rate.id}>{rate.name} - {getCurrency()} {rate.amount} ({rate.type})</option>
                                ))}
                            </select>
                        </div>

                        {selectedRate && (() => {
                            const rate = parkingSettings.rates?.find(r => r.name === selectedRate || r.id === selectedRate);
                            if (rate) {
                                const services = window.FirebaseServices;
                                const feeCalc = services.parkingService.calculateFee(selectedVehicle.parkedAt, parkingSettings.rates, selectedRate);
                                return (
                                    <div style={{ padding: '20px', backgroundColor: isDark ? '#064e3b' : '#ecfdf5', borderRadius: '8px', marginBottom: '20px', textAlign: 'center', border: `1px solid ${isDark ? '#065f46' : '#a7f3d0'}` }}>
                                        <div style={{ fontSize: '13px', color: isDark ? '#a7f3d0' : '#065f46', marginBottom: '4px' }}>Calculated Fee</div>
                                        <div style={{ fontSize: '32px', fontWeight: 'bold', color: isDark ? '#10b981' : '#059669' }}>
                                            {getCurrency()} {feeCalc.fee.toLocaleString()}
                                        </div>
                                        <div style={{ fontSize: '12px', color: isDark ? '#6ee7b7' : '#047857', marginTop: '4px' }}>{feeCalc.duration}</div>
                                    </div>
                                );
                            }
                            return null;
                        })()}

                        <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end' }}>
                            <button style={btnSecondary} onClick={() => { setShowApplyFeeModal(false); setSelectedVehicle(null); }}>Cancel</button>
                            <button style={{ ...btnPrimary, backgroundColor: '#10b981' }} onClick={handleApplyFeeAndRelease} disabled={actionLoading || !selectedRate}>
                                {actionLoading ? 'Processing...' : 'Apply Fee & Release'}
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* Fee Settings Modal */}
            {showSettingsModal && (
                <div style={modalOverlay} onClick={() => setShowSettingsModal(false)}>
                    <div style={{ ...modalContent, maxWidth: '600px' }} onClick={e => e.stopPropagation()}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px' }}>
                            <h2 style={{ margin: 0, fontSize: '18px', fontWeight: '600', color: theme.text }}>Parking Fee Settings</h2>
                            <button onClick={() => setShowSettingsModal(false)} style={{ background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer', color: theme.textSecondary }}>√ó</button>
                        </div>

                        <div style={{ marginBottom: '24px' }}>
                            <h3 style={{ fontSize: '14px', fontWeight: '600', color: theme.text, marginBottom: '16px' }}>Fee Rates</h3>
                            
                            {parkingSettings.rates?.map((rate, index) => (
                                <div key={index} style={{ padding: '16px', backgroundColor: theme.bgSecondary, borderRadius: '8px', marginBottom: '12px', border: `1px solid ${theme.border}` }}>
                                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr auto', gap: '12px', alignItems: 'end' }}>
                                        <div>
                                            <label style={{ ...labelStyle, fontSize: '12px' }}>Rate Name</label>
                                            <input type="text" value={rate.name} onChange={(e) => {
                                                const newRates = [...parkingSettings.rates];
                                                newRates[index].name = e.target.value;
                                                setParkingSettings({...parkingSettings, rates: newRates});
                                            }} placeholder="e.g. Hourly" style={{ ...inputStyle, padding: '8px 12px' }} />
                                        </div>
                                        <div>
                                            <label style={{ ...labelStyle, fontSize: '12px' }}>Amount ({getCurrency()})</label>
                                            <input type="number" value={rate.amount} onChange={(e) => {
                                                const newRates = [...parkingSettings.rates];
                                                newRates[index].amount = parseFloat(e.target.value) || 0;
                                                setParkingSettings({...parkingSettings, rates: newRates});
                                            }} placeholder="0" style={{ ...inputStyle, padding: '8px 12px' }} />
                                        </div>
                                        <div>
                                            <label style={{ ...labelStyle, fontSize: '12px' }}>Type</label>
                                            <select value={rate.type} onChange={(e) => {
                                                const newRates = [...parkingSettings.rates];
                                                newRates[index].type = e.target.value;
                                                setParkingSettings({...parkingSettings, rates: newRates});
                                            }} style={{ ...selectStyle, padding: '8px 12px' }}>
                                                <option value="minute">Per Minute</option>
                                                <option value="hourly">Per Hour</option>
                                                <option value="daily">Per Day</option>
                                                <option value="flat">Flat Rate</option>
                                                <option value="overnight">Overnight</option>
                                                <option value="member">Member Rate</option>
                                            </select>
                                        </div>
                                        <button onClick={() => {
                                            const newRates = parkingSettings.rates.filter((_, i) => i !== index);
                                            setParkingSettings({...parkingSettings, rates: newRates});
                                        }} style={{ background: '#fee2e2', border: 'none', color: '#dc2626', padding: '8px 12px', borderRadius: '4px', cursor: 'pointer', fontWeight: '500' }}>‚úï</button>
                                    </div>
                                </div>
                            ))}

                            <button onClick={() => {
                                const newRates = [...(parkingSettings.rates || []), { id: `rate_${Date.now()}`, name: '', amount: 0, type: 'hourly' }];
                                setParkingSettings({...parkingSettings, rates: newRates});
                            }} style={{ width: '100%', padding: '12px', border: `2px dashed ${theme.border}`, backgroundColor: 'transparent', color: theme.textSecondary, borderRadius: '8px', cursor: 'pointer', fontWeight: '500' }}>+ Add Rate</button>
                        </div>

                        <div style={{ marginBottom: '24px' }}>
                            <h3 style={{ fontSize: '14px', fontWeight: '600', color: theme.text, marginBottom: '16px' }}>Default Settings</h3>
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px' }}>
                                <div>
                                    <label style={labelStyle}>Grace Period (minutes)</label>
                                    <input type="number" value={parkingSettings.gracePeriod || 15} onChange={(e) => setParkingSettings({...parkingSettings, gracePeriod: parseInt(e.target.value) || 0})} style={inputStyle} />
                                </div>
                                <div>
                                    <label style={labelStyle}>Default Rate</label>
                                    <select value={parkingSettings.defaultRate || ''} onChange={(e) => setParkingSettings({...parkingSettings, defaultRate: e.target.value})} style={selectStyle}>
                                        <option value="">Select default...</option>
                                        {parkingSettings.rates?.map((rate, index) => (
                                            <option key={index} value={rate.name || rate.id}>{rate.name} - {getCurrency()} {rate.amount}</option>
                                        ))}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end' }}>
                            <button style={btnSecondary} onClick={() => setShowSettingsModal(false)}>Cancel</button>
                            <button style={btnPrimary} onClick={handleSaveSettings} disabled={actionLoading}>
                                {actionLoading ? 'Saving...' : 'Save Settings'}
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* Add Single Space Modal */}
            {showAddSpaceModal && (
                <div style={modalOverlay} onClick={() => setShowAddSpaceModal(false)}>
                    <div style={modalContent} onClick={e => e.stopPropagation()}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px' }}>
                            <h2 style={{ margin: 0, fontSize: '18px', fontWeight: '600', color: theme.text }}>Add Parking Space</h2>
                            <button onClick={() => setShowAddSpaceModal(false)} style={{ background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer', color: theme.textSecondary }}>√ó</button>
                        </div>

                        <div style={{ marginBottom: '20px' }}>
                            <label style={labelStyle}>Space Name *</label>
                            <input type="text" value={spaceForm.name} onChange={(e) => setSpaceForm({...spaceForm, name: e.target.value.toUpperCase()})} placeholder="e.g. A1, B5, VIP1" style={inputStyle} required />
                        </div>

                        <div style={{ marginBottom: '20px' }}>
                            <label style={labelStyle}>Zone</label>
                            <select value={spaceForm.zone} onChange={(e) => setSpaceForm({...spaceForm, zone: e.target.value})} style={selectStyle}>
                                {ZONES.map(z => <option key={z} value={z}>Zone {z}</option>)}
                            </select>
                        </div>

                        <div style={{ marginBottom: '20px' }}>
                            <label style={labelStyle}>Space Type</label>
                            <select value={spaceForm.type} onChange={(e) => setSpaceForm({...spaceForm, type: e.target.value})} style={selectStyle}>
                                {SPACE_TYPES.map(t => <option key={t.id} value={t.id}>{t.name}</option>)}
                            </select>
                        </div>

                        <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end' }}>
                            <button style={btnSecondary} onClick={() => setShowAddSpaceModal(false)}>Cancel</button>
                            <button style={btnPrimary} onClick={handleAddSpace} disabled={actionLoading || !spaceForm.name}>
                                {actionLoading ? 'Adding...' : 'Add Space'}
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* Bulk Add Spaces Modal */}
            {showBulkAddModal && (
                <div style={modalOverlay} onClick={() => setShowBulkAddModal(false)}>
                    <div style={modalContent} onClick={e => e.stopPropagation()}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px' }}>
                            <h2 style={{ margin: 0, fontSize: '18px', fontWeight: '600', color: theme.text }}>Bulk Add Parking Spaces</h2>
                            <button onClick={() => setShowBulkAddModal(false)} style={{ background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer', color: theme.textSecondary }}>√ó</button>
                        </div>

                        <div style={{ padding: '16px', backgroundColor: isDark ? '#0f172a' : '#f0f9ff', borderRadius: '8px', marginBottom: '20px', border: `1px solid ${isDark ? '#334155' : '#bae6fd'}` }}>
                            <div style={{ fontSize: '13px', color: theme.textSecondary }}>
                                This will create multiple spaces automatically. For example, setting prefix "A" with numbers 1-10 will create: A1, A2, A3... A10
                            </div>
                        </div>

                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px', marginBottom: '20px' }}>
                            <div>
                                <label style={labelStyle}>Zone</label>
                                <select value={bulkForm.zone} onChange={(e) => setBulkForm({...bulkForm, zone: e.target.value})} style={selectStyle}>
                                    {ZONES.map(z => <option key={z} value={z}>Zone {z}</option>)}
                                </select>
                            </div>
                            <div>
                                <label style={labelStyle}>Prefix</label>
                                <input type="text" value={bulkForm.prefix} onChange={(e) => setBulkForm({...bulkForm, prefix: e.target.value.toUpperCase()})} placeholder="e.g. A, B, VIP" style={inputStyle} />
                            </div>
                        </div>

                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px', marginBottom: '20px' }}>
                            <div>
                                <label style={labelStyle}>Start Number</label>
                                <input type="number" min="1" value={bulkForm.startNum} onChange={(e) => setBulkForm({...bulkForm, startNum: parseInt(e.target.value) || 1})} style={inputStyle} />
                            </div>
                            <div>
                                <label style={labelStyle}>End Number</label>
                                <input type="number" min="1" value={bulkForm.endNum} onChange={(e) => setBulkForm({...bulkForm, endNum: parseInt(e.target.value) || 10})} style={inputStyle} />
                            </div>
                        </div>

                        <div style={{ marginBottom: '20px' }}>
                            <label style={labelStyle}>Space Type</label>
                            <select value={bulkForm.type} onChange={(e) => setBulkForm({...bulkForm, type: e.target.value})} style={selectStyle}>
                                {SPACE_TYPES.map(t => <option key={t.id} value={t.id}>{t.name}</option>)}
                            </select>
                        </div>

                        <div style={{ padding: '12px', backgroundColor: isDark ? '#064e3b' : '#ecfdf5', borderRadius: '8px', marginBottom: '20px', border: `1px solid ${isDark ? '#065f46' : '#a7f3d0'}` }}>
                            <div style={{ fontSize: '13px', fontWeight: '600', color: isDark ? '#10b981' : '#059669' }}>
                                Preview: {bulkForm.prefix}{bulkForm.startNum} to {bulkForm.prefix}{bulkForm.endNum} ({bulkForm.endNum - bulkForm.startNum + 1} spaces)
                            </div>
                        </div>

                        <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end' }}>
                            <button style={btnSecondary} onClick={() => setShowBulkAddModal(false)}>Cancel</button>
                            <button style={btnPrimary} onClick={handleBulkAddSpaces} disabled={actionLoading || bulkForm.startNum >= bulkForm.endNum}>
                                {actionLoading ? 'Creating...' : `Create ${bulkForm.endNum - bulkForm.startNum + 1} Spaces`}
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* Alert Modal */}
            <AlertModal
                isOpen={alertModal.isOpen}
                onClose={closeAlert}
                title={alertModal.title}
                message={alertModal.message}
                type={alertModal.type}
                onConfirm={alertModal.onConfirm}
                showCancel={alertModal.showCancel}
            />
        </div>
    );
}

// Equipment Management Module Component
function EquipmentManagement() {
    const [equipment, setEquipment] = useState([]);
    const [loading, setLoading] = useState(true);
    const [showAddModal, setShowAddModal] = useState(false);
    const [showEditModal, setShowEditModal] = useState(false);
    const [showTransferModal, setShowTransferModal] = useState(false);
    const [showMaintenanceModal, setShowMaintenanceModal] = useState(false);
    const [showHistoryModal, setShowHistoryModal] = useState(false);
    const [selectedEquipment, setSelectedEquipment] = useState(null);
    const [actionLoading, setActionLoading] = useState(false);
    const [error, setError] = useState(null);
    
    // Alert modal state
    const [alertModal, setAlertModal] = useState({
        isOpen: false,
        title: '',
        message: '',
        type: 'info',
        onConfirm: null,
        showCancel: false
    });
    
    const showAlert = (title, message, type = 'info', onConfirm = null, showCancel = false) => {
        setAlertModal({ isOpen: true, title, message, type, onConfirm, showCancel });
    };
    
    const closeAlert = () => {
        setAlertModal(prev => ({ ...prev, isOpen: false }));
    };
    const [activeTab, setActiveTab] = useState('all'); // all, due, overdue
    const [isDark, setIsDark] = useState(document.documentElement.getAttribute('data-theme') === 'dark');

    // Listen for theme changes
    useEffect(() => {
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.attributeName === 'data-theme') {
                    setIsDark(document.documentElement.getAttribute('data-theme') === 'dark');
                }
            });
        });
        observer.observe(document.documentElement, { attributes: true });
        return () => observer.disconnect();
    }, []);

    // Theme colors
    const theme = {
        bg: isDark ? '#1e293b' : 'white',
        bgSecondary: isDark ? '#0f172a' : '#f8fafc',
        bgTertiary: isDark ? '#334155' : '#f1f5f9',
        text: isDark ? '#f1f5f9' : '#1e293b',
        textSecondary: isDark ? '#94a3b8' : '#64748b',
        textMuted: isDark ? '#64748b' : '#94a3b8',
        border: isDark ? '#334155' : '#e2e8f0',
        borderLight: isDark ? '#475569' : '#d1d5db',
        cardShadow: isDark ? '0 1px 3px rgba(0,0,0,0.3)' : '0 1px 3px rgba(0,0,0,0.1)',
        modalOverlay: isDark ? 'rgba(0,0,0,0.7)' : 'rgba(0,0,0,0.5)',
        loadingOverlay: isDark ? 'rgba(15,23,42,0.8)' : 'rgba(255,255,255,0.7)',
        inputBg: isDark ? '#1e293b' : 'white',
        rowHoverBg: isDark ? '#334155' : '#f8fafc',
        rowOverdueBg: isDark ? '#450a0a' : '#fef2f2',
        rowDueBg: isDark ? '#451a03' : '#fffbeb',
        // Button colors for dark mode
        btnTransferBg: isDark ? '#4c1d95' : '#f3e8ff',
        btnTransferText: isDark ? '#c4b5fd' : '#7c3aed',
        btnTransferBorder: isDark ? '#6d28d9' : '#ddd6fe',
        btnMaintainBg: isDark ? '#064e3b' : '#d1fae5',
        btnMaintainText: isDark ? '#6ee7b7' : '#059669',
        btnMaintainBorder: isDark ? '#059669' : '#a7f3d0',
        btnHistoryBg: isDark ? '#334155' : '#f1f5f9',
        btnHistoryText: isDark ? '#cbd5e1' : '#475569',
        btnHistoryBorder: isDark ? '#475569' : '#e2e8f0',
        btnEditBg: isDark ? '#1e3a8a' : '#dbeafe',
        btnEditText: isDark ? '#93c5fd' : '#2563eb',
        btnEditBorder: isDark ? '#3b82f6' : '#bfdbfe',
        btnDeleteBg: isDark ? '#7f1d1d' : '#fee2e2',
        btnDeleteText: isDark ? '#fca5a5' : '#dc2626',
        btnDeleteBorder: isDark ? '#dc2626' : '#fecaca',
    };

    const [formData, setFormData] = useState({
        name: '',
        type: 'pressure_washer',
        location: '',
        serialNumber: '',
        purchaseDate: '',
        lastMaintenance: '',
        nextMaintenance: '',
        status: 'operational',
        notes: ''
    });
    const [transferData, setTransferData] = useState({ toLocation: '', notes: '' });
    const [maintenanceData, setMaintenanceData] = useState({ type: 'routine', description: '', cost: '', performedBy: '', nextMaintenanceDate: '' });

    const EQUIPMENT_TYPES = [
        { id: 'pressure_washer', name: 'Pressure Washer' },
        { id: 'vacuum', name: 'Vacuum Cleaner' },
        { id: 'foam_cannon', name: 'Foam Cannon' },
        { id: 'air_compressor', name: 'Air Compressor' },
        { id: 'water_pump', name: 'Water Pump' },
        { id: 'polisher', name: 'Polisher/Buffer' },
        { id: 'generator', name: 'Generator' },
        { id: 'lift', name: 'Vehicle Lift' },
        { id: 'other', name: 'Other' }
    ];

    const STATUS_OPTIONS = [
        { id: 'operational', name: 'Operational', color: '#10b981' },
        { id: 'maintenance', name: 'Under Maintenance', color: '#f59e0b' },
        { id: 'repair', name: 'Needs Repair', color: '#ef4444' },
        { id: 'retired', name: 'Retired', color: '#6b7280' }
    ];

    const LOCATIONS = ['Bay 1', 'Bay 2', 'Bay 3', 'Bay 4', 'Garage', 'Storage', 'Workshop', 'Office'];

    const MAINTENANCE_TYPES = [
        { id: 'routine', name: 'Routine Service' },
        { id: 'repair', name: 'Repair' },
        { id: 'inspection', name: 'Inspection' },
        { id: 'replacement', name: 'Part Replacement' },
        { id: 'calibration', name: 'Calibration' }
    ];

    // Get equipment due for maintenance
    const getMaintenanceDue = () => {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const weekFromNow = new Date(today);
        weekFromNow.setDate(weekFromNow.getDate() + 7);
        
        return equipment.filter(e => {
            if (!e.nextMaintenance) return false;
            const maintenanceDate = new Date(e.nextMaintenance);
            return maintenanceDate <= weekFromNow && maintenanceDate >= today;
        });
    };

    // Get overdue maintenance
    const getMaintenanceOverdue = () => {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        return equipment.filter(e => {
            if (!e.nextMaintenance) return false;
            const maintenanceDate = new Date(e.nextMaintenance);
            return maintenanceDate < today;
        });
    };

    // Get filtered equipment based on active tab
    const getFilteredEquipment = () => {
        switch(activeTab) {
            case 'due': return getMaintenanceDue();
            case 'overdue': return getMaintenanceOverdue();
            default: return equipment;
        }
    };

    // Subscribe to equipment data
    useEffect(() => {
        const services = window.FirebaseServices;
        if (!services) {
            setLoading(false);
            return;
        }

        const unsubscribe = services.equipmentService.subscribeToEquipment(
            (data) => {
                setEquipment(data);
                setLoading(false);
            },
            (err) => {
                console.error('Equipment subscription error:', err);
                setError('Failed to load equipment');
                setLoading(false);
            }
        );

        return () => unsubscribe && unsubscribe();
    }, []);

    const resetForm = () => {
        setFormData({
            name: '',
            type: 'pressure_washer',
            location: '',
            serialNumber: '',
            purchaseDate: '',
            lastMaintenance: '',
            nextMaintenance: '',
            status: 'operational',
            notes: ''
        });
    };

    const handleAddEquipment = async (e) => {
        e.preventDefault();
        const services = window.FirebaseServices;
        if (!services) {
            setError('Firebase not ready');
            return;
        }

        if (!formData.name.trim()) {
            setError('Equipment name is required');
            return;
        }

        setActionLoading(true);
        try {
            const result = await services.equipmentService.addEquipment(formData);
            if (result.success) {
                setShowAddModal(false);
                resetForm();
            } else {
                setError(result.error || 'Failed to add equipment');
            }
        } catch (err) {
            setError('Failed to add equipment');
        } finally {
            setActionLoading(false);
        }
    };

    const handleEditEquipment = async (e) => {
        e.preventDefault();
        const services = window.FirebaseServices;
        if (!services || !selectedEquipment) return;

        setActionLoading(true);
        try {
            const result = await services.equipmentService.updateEquipment(selectedEquipment.id, formData);
            if (result.success) {
                setShowEditModal(false);
                setSelectedEquipment(null);
                resetForm();
            } else {
                setError(result.error || 'Failed to update equipment');
            }
        } catch (err) {
            setError('Failed to update equipment');
        } finally {
            setActionLoading(false);
        }
    };

    const handleDeleteEquipment = async (equipmentItem) => {
        showAlert(
            'Delete Equipment',
            `Are you sure you want to delete "${equipmentItem.name}"? This action cannot be undone.`,
            'warning',
            async () => {
                const services = window.FirebaseServices;
                if (!services) return;

                setActionLoading(true);
                try {
                    await services.equipmentService.deleteEquipment(equipmentItem.id);
                    showAlert('Deleted', 'Equipment has been successfully deleted.', 'success');
                } catch (err) {
                    setError('Failed to delete equipment');
                    showAlert('Error', 'Failed to delete equipment. Please try again.', 'error');
                } finally {
                    setActionLoading(false);
                }
            },
            true
        );
    };

    const handleTransfer = async (e) => {
        e.preventDefault();
        const services = window.FirebaseServices;
        if (!services || !selectedEquipment) return;

        if (!transferData.toLocation) {
            setError('Please select a destination location');
            return;
        }

        setActionLoading(true);
        try {
            const result = await services.equipmentService.transferEquipment(
                selectedEquipment.id,
                selectedEquipment.location || 'Unknown',
                transferData.toLocation,
                transferData.notes
            );
            if (result.success) {
                setShowTransferModal(false);
                setSelectedEquipment(null);
                setTransferData({ toLocation: '', notes: '' });
            } else {
                setError(result.error || 'Failed to transfer equipment');
            }
        } catch (err) {
            setError('Failed to transfer equipment');
        } finally {
            setActionLoading(false);
        }
    };

    const handleLogMaintenance = async (e) => {
        e.preventDefault();
        const services = window.FirebaseServices;
        if (!services || !selectedEquipment) return;

        setActionLoading(true);
        try {
            const result = await services.equipmentService.logMaintenance(selectedEquipment.id, maintenanceData);
            if (result.success) {
                // Update next maintenance date if provided
                if (maintenanceData.nextMaintenanceDate) {
                    await services.equipmentService.updateEquipment(selectedEquipment.id, {
                        nextMaintenance: maintenanceData.nextMaintenanceDate
                    });
                }
                setShowMaintenanceModal(false);
                setSelectedEquipment(null);
                setMaintenanceData({ type: 'routine', description: '', cost: '', performedBy: '', nextMaintenanceDate: '' });
            } else {
                setError(result.error || 'Failed to log maintenance');
            }
        } catch (err) {
            setError('Failed to log maintenance');
        } finally {
            setActionLoading(false);
        }
    };

    const openTransferModal = (equipmentItem) => {
        setSelectedEquipment(equipmentItem);
        setTransferData({ toLocation: '', notes: '' });
        setShowTransferModal(true);
    };

    const openMaintenanceModal = (equipmentItem) => {
        setSelectedEquipment(equipmentItem);
        setMaintenanceData({ type: 'routine', description: '', cost: '', performedBy: '', nextMaintenanceDate: '' });
        setShowMaintenanceModal(true);
    };

    const openHistoryModal = (equipmentItem) => {
        setSelectedEquipment(equipmentItem);
        setShowHistoryModal(true);
    };

    const openEditModal = (equipmentItem) => {
        setSelectedEquipment(equipmentItem);
        setFormData({
            name: equipmentItem.name || '',
            type: equipmentItem.type || 'pressure_washer',
            location: equipmentItem.location || '',
            serialNumber: equipmentItem.serialNumber || '',
            purchaseDate: equipmentItem.purchaseDate || '',
            lastMaintenance: equipmentItem.lastMaintenance || '',
            nextMaintenance: equipmentItem.nextMaintenance || '',
            status: equipmentItem.status || 'operational',
            notes: equipmentItem.notes || ''
        });
        setShowEditModal(true);
    };

    const getStatusColor = (status) => {
        const statusOption = STATUS_OPTIONS.find(s => s.id === status);
        return statusOption?.color || '#6b7280';
    };

    const getStatusLabel = (status) => {
        const statusOption = STATUS_OPTIONS.find(s => s.id === status);
        return statusOption?.name || status;
    };

    const getTypeLabel = (type) => {
        const typeOption = EQUIPMENT_TYPES.find(t => t.id === type);
        return typeOption?.name || type;
    };

    if (loading) {
        return (
            <div className="equipment-management" style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', minHeight: '400px', flexDirection: 'column', gap: '16px', backgroundColor: theme.bg }}>
                <div style={{ width: '40px', height: '40px', border: `3px solid ${theme.border}`, borderTopColor: '#3b82f6', borderRadius: '50%', animation: 'spin 0.8s linear infinite' }}></div>
                <p style={{ color: theme.textSecondary }}>Loading Equipment...</p>
            </div>
        );
    }

    const overdueCount = getMaintenanceOverdue().length;
    const dueCount = getMaintenanceDue().length;
    const filteredEquipment = getFilteredEquipment();

    return (
        <div className="equipment-management" style={{ backgroundColor: theme.bgSecondary, minHeight: '100%' }}>
            {/* Error Banner */}
            {error && (
                <div style={{ backgroundColor: isDark ? '#450a0a' : '#fef2f2', border: `1px solid ${isDark ? '#7f1d1d' : '#fecaca'}`, padding: '12px 16px', marginBottom: '16px', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <span style={{ color: isDark ? '#fca5a5' : '#dc2626' }}>{error}</span>
                    <button onClick={() => setError(null)} style={{ background: 'none', border: 'none', color: isDark ? '#fca5a5' : '#dc2626', cursor: 'pointer' }}>{Icons.x}</button>
                </div>
            )}

            {/* Action Loading Overlay */}
            {actionLoading && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: theme.loadingOverlay, display: 'flex', justifyContent: 'center', alignItems: 'center', zIndex: 9999 }}>
                    <div style={{ width: '40px', height: '40px', border: `3px solid ${theme.border}`, borderTopColor: '#3b82f6', borderRadius: '50%', animation: 'spin 0.8s linear infinite' }}></div>
                </div>
            )}

            {/* Maintenance Alert Banner */}
            {overdueCount > 0 && (
                <div style={{ backgroundColor: isDark ? '#450a0a' : '#fef2f2', border: `1px solid ${isDark ? '#7f1d1d' : '#fecaca'}`, borderLeft: '4px solid #ef4444', padding: '12px 16px', marginBottom: '16px', display: 'flex', alignItems: 'center', gap: '12px' }}>
                    <span style={{ fontSize: '20px' }}>‚ö†Ô∏è</span>
                    <div>
                        <strong style={{ color: isDark ? '#fca5a5' : '#dc2626' }}>{overdueCount} equipment overdue for maintenance!</strong>
                        <p style={{ margin: '4px 0 0 0', fontSize: '13px', color: theme.textSecondary }}>Click "Overdue" tab to view and schedule maintenance.</p>
                    </div>
                </div>
            )}

            {/* Header with Add Button */}
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px' }}>
                <div>
                    <p style={{ color: theme.textSecondary, margin: 0 }}>Manage your garage and wash bay equipment</p>
                </div>
                <button 
                    onClick={() => { resetForm(); setShowAddModal(true); }}
                    style={{ 
                        display: 'flex', 
                        alignItems: 'center', 
                        gap: '8px', 
                        padding: '10px 20px', 
                        backgroundColor: '#3b82f6', 
                        color: 'white', 
                        border: 'none', 
                        cursor: 'pointer',
                        fontSize: '14px',
                        fontWeight: '500'
                    }}
                >
                    {Icons.plus}
                    <span>Add Equipment</span>
                </button>
            </div>

            {/* Stats Cards */}
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))', gap: '16px', marginBottom: '24px' }}>
                <div style={{ backgroundColor: theme.bg, padding: '16px', boxShadow: theme.cardShadow, border: `1px solid ${theme.border}` }}>
                    <div style={{ fontSize: '24px', fontWeight: '700', color: theme.text }}>{equipment.length}</div>
                    <div style={{ fontSize: '13px', color: theme.textSecondary }}>Total Equipment</div>
                </div>
                <div style={{ backgroundColor: theme.bg, padding: '16px', boxShadow: theme.cardShadow, border: `1px solid ${theme.border}` }}>
                    <div style={{ fontSize: '24px', fontWeight: '700', color: '#10b981' }}>{equipment.filter(e => e.status === 'operational').length}</div>
                    <div style={{ fontSize: '13px', color: theme.textSecondary }}>Operational</div>
                </div>
                <div style={{ backgroundColor: theme.bg, padding: '16px', boxShadow: theme.cardShadow, border: `1px solid ${theme.border}` }}>
                    <div style={{ fontSize: '24px', fontWeight: '700', color: '#f59e0b' }}>{dueCount}</div>
                    <div style={{ fontSize: '13px', color: theme.textSecondary }}>Due Soon</div>
                </div>
                <div style={{ backgroundColor: theme.bg, padding: '16px', boxShadow: theme.cardShadow, border: `1px solid ${theme.border}` }}>
                    <div style={{ fontSize: '24px', fontWeight: '700', color: '#ef4444' }}>{overdueCount}</div>
                    <div style={{ fontSize: '13px', color: theme.textSecondary }}>Overdue</div>
                </div>
            </div>

            {/* Tabs */}
            <div style={{ display: 'flex', gap: '0', marginBottom: '16px', borderBottom: `2px solid ${theme.border}` }}>
                <button 
                    onClick={() => setActiveTab('all')}
                    style={{ 
                        padding: '12px 20px', 
                        backgroundColor: activeTab === 'all' ? '#3b82f6' : theme.bg, 
                        color: activeTab === 'all' ? 'white' : theme.textSecondary, 
                        border: 'none', 
                        cursor: 'pointer', 
                        fontWeight: '500', 
                        fontSize: '14px' 
                    }}
                >
                    All Equipment ({equipment.length})
                </button>
                <button 
                    onClick={() => setActiveTab('due')}
                    style={{ 
                        padding: '12px 20px', 
                        backgroundColor: activeTab === 'due' ? '#f59e0b' : theme.bg, 
                        color: activeTab === 'due' ? 'white' : theme.textSecondary, 
                        border: 'none', 
                        cursor: 'pointer', 
                        fontWeight: '500', 
                        fontSize: '14px' 
                    }}
                >
                    Due for Maintenance ({dueCount})
                </button>
                <button 
                    onClick={() => setActiveTab('overdue')}
                    style={{ 
                        padding: '12px 20px', 
                        backgroundColor: activeTab === 'overdue' ? '#ef4444' : theme.bg, 
                        color: activeTab === 'overdue' ? 'white' : theme.textSecondary, 
                        border: 'none', 
                        cursor: 'pointer', 
                        fontWeight: '500', 
                        fontSize: '14px' 
                    }}
                >
                    Overdue ({overdueCount})
                </button>
            </div>

            {/* Equipment List */}
            {filteredEquipment.length === 0 ? (
                <div style={{ textAlign: 'center', padding: '60px 20px', backgroundColor: theme.bg, boxShadow: theme.cardShadow, border: `1px solid ${theme.border}` }}>
                    <div style={{ fontSize: '48px', marginBottom: '16px' }}>{activeTab === 'all' ? 'üîß' : '‚úÖ'}</div>
                    <h3 style={{ margin: '0 0 8px 0', color: theme.text }}>{activeTab === 'all' ? 'No Equipment Yet' : 'No Equipment in This Category'}</h3>
                    <p style={{ color: theme.textSecondary, marginBottom: '20px' }}>{activeTab === 'all' ? 'Add your first equipment to get started' : activeTab === 'due' ? 'No equipment due for maintenance in the next 7 days' : 'All equipment maintenance is up to date!'}</p>
                    {activeTab === 'all' && (
                        <button 
                            onClick={() => { resetForm(); setShowAddModal(true); }}
                            style={{ padding: '10px 24px', backgroundColor: '#3b82f6', color: 'white', border: 'none', cursor: 'pointer', fontWeight: '500' }}
                        >
                            Add Equipment
                        </button>
                    )}
                </div>
            ) : (
                <div style={{ backgroundColor: theme.bg, boxShadow: theme.cardShadow, border: `1px solid ${theme.border}`, overflow: 'hidden' }}>
                    <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                        <thead>
                            <tr style={{ backgroundColor: theme.bgSecondary, borderBottom: `1px solid ${theme.border}` }}>
                                <th style={{ padding: '12px 16px', textAlign: 'left', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase' }}>Equipment</th>
                                <th style={{ padding: '12px 16px', textAlign: 'left', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase' }}>Type</th>
                                <th style={{ padding: '12px 16px', textAlign: 'left', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase' }}>Location</th>
                                <th style={{ padding: '12px 16px', textAlign: 'left', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase' }}>Status</th>
                                <th style={{ padding: '12px 16px', textAlign: 'left', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase' }}>Next Maintenance</th>
                                <th style={{ padding: '12px 16px', textAlign: 'right', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase' }}>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {filteredEquipment.map((item) => {
                                const isOverdue = item.nextMaintenance && new Date(item.nextMaintenance) < new Date();
                                const isDueSoon = item.nextMaintenance && !isOverdue && new Date(item.nextMaintenance) <= new Date(Date.now() + 7*24*60*60*1000);
                                return (
                                    <tr key={item.id} style={{ borderBottom: `1px solid ${theme.border}`, backgroundColor: isOverdue ? theme.rowOverdueBg : isDueSoon ? theme.rowDueBg : theme.bg }}>
                                        <td style={{ padding: '16px' }}>
                                            <div style={{ fontWeight: '500', color: theme.text }}>{item.name}</div>
                                            {item.serialNumber && <div style={{ fontSize: '12px', color: theme.textMuted }}>SN: {item.serialNumber}</div>}
                                        </td>
                                        <td style={{ padding: '16px', color: theme.textSecondary }}>{getTypeLabel(item.type)}</td>
                                        <td style={{ padding: '16px', color: theme.textSecondary }}>{item.location || '-'}</td>
                                        <td style={{ padding: '16px' }}>
                                            <span style={{ 
                                                display: 'inline-block',
                                                padding: '4px 10px', 
                                                fontSize: '12px', 
                                                fontWeight: '500',
                                                backgroundColor: `${getStatusColor(item.status)}20`,
                                                color: getStatusColor(item.status)
                                            }}>
                                                {getStatusLabel(item.status)}
                                            </span>
                                        </td>
                                        <td style={{ padding: '16px' }}>
                                            {item.nextMaintenance ? (
                                                <span style={{ color: isOverdue ? '#ef4444' : isDueSoon ? '#f59e0b' : theme.textSecondary, fontWeight: isOverdue || isDueSoon ? '500' : '400' }}>
                                                    {item.nextMaintenance}
                                                    {isOverdue && ' ‚ö†Ô∏è'}
                                                    {isDueSoon && !isOverdue && ' ‚è∞'}
                                                </span>
                                            ) : '-'}
                                        </td>
                                        <td style={{ padding: '16px', textAlign: 'right' }}>
                                            <div style={{ display: 'flex', justifyContent: 'flex-end', gap: '6px' }}>
                                                <button 
                                                    onClick={() => openTransferModal(item)}
                                                    style={{ 
                                                        display: 'inline-flex', 
                                                        alignItems: 'center', 
                                                        justifyContent: 'center',
                                                        gap: '4px',
                                                        padding: '6px 10px', 
                                                        backgroundColor: theme.btnTransferBg, 
                                                        color: theme.btnTransferText, 
                                                        border: `1px solid ${theme.btnTransferBorder}`,
                                                        cursor: 'pointer', 
                                                        fontSize: '11px',
                                                        fontWeight: '500'
                                                    }}
                                                    title="Transfer Location"
                                                >
                                                    <span style={{ fontSize: '12px' }}>‚Üî</span> Transfer
                                                </button>
                                                <button 
                                                    onClick={() => openMaintenanceModal(item)}
                                                    style={{ 
                                                        display: 'inline-flex', 
                                                        alignItems: 'center', 
                                                        justifyContent: 'center',
                                                        gap: '4px',
                                                        padding: '6px 10px', 
                                                        backgroundColor: theme.btnMaintainBg, 
                                                        color: theme.btnMaintainText, 
                                                        border: `1px solid ${theme.btnMaintainBorder}`,
                                                        cursor: 'pointer', 
                                                        fontSize: '11px',
                                                        fontWeight: '500'
                                                    }}
                                                    title="Log Maintenance"
                                                >
                                                    <span style={{ fontSize: '12px' }}>üîß</span> Maintain
                                                </button>
                                                <button 
                                                    onClick={() => openHistoryModal(item)}
                                                    style={{ 
                                                        display: 'inline-flex', 
                                                        alignItems: 'center', 
                                                        justifyContent: 'center',
                                                        gap: '4px',
                                                        padding: '6px 10px', 
                                                        backgroundColor: theme.btnHistoryBg, 
                                                        color: theme.btnHistoryText, 
                                                        border: `1px solid ${theme.btnHistoryBorder}`,
                                                        cursor: 'pointer', 
                                                        fontSize: '11px',
                                                        fontWeight: '500'
                                                    }}
                                                    title="View History"
                                                >
                                                    <span style={{ fontSize: '12px' }}>üìã</span> History
                                                </button>
                                                <button 
                                                    onClick={() => openEditModal(item)}
                                                    style={{ 
                                                        display: 'inline-flex', 
                                                        alignItems: 'center', 
                                                        justifyContent: 'center',
                                                        padding: '6px 10px', 
                                                        backgroundColor: theme.btnEditBg, 
                                                        color: theme.btnEditText, 
                                                        border: `1px solid ${theme.btnEditBorder}`,
                                                        cursor: 'pointer', 
                                                        fontSize: '11px',
                                                        fontWeight: '500'
                                                    }}
                                                    title="Edit"
                                                >
                                                    {Icons.edit}
                                                </button>
                                                <button 
                                                    onClick={() => handleDeleteEquipment(item)}
                                                    style={{ 
                                                        display: 'inline-flex', 
                                                        alignItems: 'center', 
                                                        justifyContent: 'center',
                                                        padding: '6px 10px', 
                                                        backgroundColor: theme.btnDeleteBg, 
                                                        color: theme.btnDeleteText, 
                                                        border: `1px solid ${theme.btnDeleteBorder}`,
                                                        cursor: 'pointer', 
                                                        fontSize: '11px',
                                                        fontWeight: '500'
                                                    }}
                                                    title="Delete"
                                                >
                                                    {Icons.x}
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                );
                            })}
                        </tbody>
                    </table>
                </div>
            )}

            {/* Add Equipment Modal */}
            {showAddModal && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: theme.modalOverlay, display: 'flex', justifyContent: 'center', alignItems: 'center', zIndex: 1000 }} onClick={() => setShowAddModal(false)}>
                    <div style={{ backgroundColor: theme.bg, width: '100%', maxWidth: '500px', maxHeight: '90vh', overflow: 'auto', boxShadow: '0 4px 20px rgba(0,0,0,0.15)' }} onClick={e => e.stopPropagation()}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '16px 20px', borderBottom: `1px solid ${theme.border}`, backgroundColor: theme.bgSecondary }}>
                            <h2 style={{ margin: 0, fontSize: '18px', fontWeight: '600', color: theme.text }}>Add Equipment</h2>
                            <button onClick={() => setShowAddModal(false)} style={{ background: 'none', border: 'none', cursor: 'pointer', color: theme.textSecondary, padding: '4px' }}>{Icons.x}</button>
                        </div>
                        <form onSubmit={handleAddEquipment}>
                            <div style={{ padding: '20px', display: 'flex', flexDirection: 'column', gap: '16px' }}>
                                <div>
                                    <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: theme.text }}>Equipment Name *</label>
                                    <input 
                                        type="text" 
                                        value={formData.name}
                                        onChange={(e) => setFormData({...formData, name: e.target.value})}
                                        placeholder="e.g., Karcher HD 6/15 C"
                                        required
                                        style={{ width: '100%', padding: '10px 12px', border: `1px solid ${theme.borderLight}`, fontSize: '14px', outline: 'none', boxSizing: 'border-box', backgroundColor: theme.inputBg, color: theme.text }}
                                    />
                                </div>
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px' }}>
                                    <div>
                                        <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: theme.text }}>Type</label>
                                        <select 
                                            value={formData.type}
                                            onChange={(e) => setFormData({...formData, type: e.target.value})}
                                            style={{ width: '100%', padding: '10px 12px', border: `1px solid ${theme.borderLight}`, fontSize: '14px', outline: 'none', boxSizing: 'border-box', backgroundColor: theme.inputBg, color: theme.text }}
                                        >
                                            {EQUIPMENT_TYPES.map(type => (
                                                <option key={type.id} value={type.id}>{type.name}</option>
                                            ))}
                                        </select>
                                    </div>
                                    <div>
                                        <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: theme.text }}>Status</label>
                                        <select 
                                            value={formData.status}
                                            onChange={(e) => setFormData({...formData, status: e.target.value})}
                                            style={{ width: '100%', padding: '10px 12px', border: `1px solid ${theme.borderLight}`, fontSize: '14px', outline: 'none', boxSizing: 'border-box', backgroundColor: theme.inputBg, color: theme.text }}
                                        >
                                            {STATUS_OPTIONS.map(status => (
                                                <option key={status.id} value={status.id}>{status.name}</option>
                                            ))}
                                        </select>
                                    </div>
                                </div>
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px' }}>
                                    <div>
                                        <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: theme.text }}>Location</label>
                                        <input 
                                            type="text" 
                                            value={formData.location}
                                            onChange={(e) => setFormData({...formData, location: e.target.value})}
                                            placeholder="e.g., Bay 1"
                                            style={{ width: '100%', padding: '10px 12px', border: `1px solid ${theme.borderLight}`, fontSize: '14px', outline: 'none', boxSizing: 'border-box', backgroundColor: theme.inputBg, color: theme.text }}
                                        />
                                    </div>
                                    <div>
                                        <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: theme.text }}>Serial Number</label>
                                        <input 
                                            type="text" 
                                            value={formData.serialNumber}
                                            onChange={(e) => setFormData({...formData, serialNumber: e.target.value})}
                                            placeholder="e.g., KHD-2024-001"
                                            style={{ width: '100%', padding: '10px 12px', border: `1px solid ${theme.borderLight}`, fontSize: '14px', outline: 'none', boxSizing: 'border-box', backgroundColor: theme.inputBg, color: theme.text }}
                                        />
                                    </div>
                                </div>
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px' }}>
                                    <div>
                                        <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: theme.text }}>Purchase Date</label>
                                        <input 
                                            type="date" 
                                            value={formData.purchaseDate}
                                            onChange={(e) => setFormData({...formData, purchaseDate: e.target.value})}
                                            style={{ width: '100%', padding: '10px 12px', border: `1px solid ${theme.borderLight}`, fontSize: '14px', outline: 'none', boxSizing: 'border-box', backgroundColor: theme.inputBg, color: theme.text }}
                                        />
                                    </div>
                                    <div>
                                        <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: theme.text }}>Next Maintenance</label>
                                        <input 
                                            type="date" 
                                            value={formData.nextMaintenance}
                                            onChange={(e) => setFormData({...formData, nextMaintenance: e.target.value})}
                                            style={{ width: '100%', padding: '10px 12px', border: `1px solid ${theme.borderLight}`, fontSize: '14px', outline: 'none', boxSizing: 'border-box', backgroundColor: theme.inputBg, color: theme.text }}
                                        />
                                    </div>
                                </div>
                                <div>
                                    <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: theme.text }}>Notes</label>
                                    <textarea 
                                        value={formData.notes}
                                        onChange={(e) => setFormData({...formData, notes: e.target.value})}
                                        placeholder="Additional notes..."
                                        rows="3"
                                        style={{ width: '100%', padding: '10px 12px', border: `1px solid ${theme.borderLight}`, fontSize: '14px', outline: 'none', boxSizing: 'border-box', resize: 'vertical', fontFamily: 'inherit', backgroundColor: theme.inputBg, color: theme.text }}
                                    />
                                </div>
                            </div>
                            <div style={{ display: 'flex', justifyContent: 'flex-end', gap: '12px', padding: '16px 20px', borderTop: `1px solid ${theme.border}`, backgroundColor: theme.bgSecondary }}>
                                <button type="button" onClick={() => setShowAddModal(false)} style={{ padding: '10px 20px', backgroundColor: theme.bg, color: theme.text, border: `1px solid ${theme.borderLight}`, cursor: 'pointer', fontSize: '14px', fontWeight: '500' }}>Cancel</button>
                                <button type="submit" style={{ padding: '10px 20px', backgroundColor: '#3b82f6', color: 'white', border: 'none', cursor: 'pointer', fontSize: '14px', fontWeight: '500' }}>Add Equipment</button>
                            </div>
                        </form>
                    </div>
                </div>
            )}

            {/* Edit Equipment Modal */}
            {showEditModal && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: theme.modalOverlay, display: 'flex', justifyContent: 'center', alignItems: 'center', zIndex: 1000 }} onClick={() => setShowEditModal(false)}>
                    <div style={{ backgroundColor: theme.bg, width: '100%', maxWidth: '500px', maxHeight: '90vh', overflow: 'auto', boxShadow: '0 4px 20px rgba(0,0,0,0.15)' }} onClick={e => e.stopPropagation()}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '16px 20px', borderBottom: `1px solid ${theme.border}`, backgroundColor: theme.bgSecondary }}>
                            <h2 style={{ margin: 0, fontSize: '18px', fontWeight: '600', color: theme.text }}>Edit Equipment</h2>
                            <button onClick={() => setShowEditModal(false)} style={{ background: 'none', border: 'none', cursor: 'pointer', color: theme.textSecondary, padding: '4px' }}>{Icons.x}</button>
                        </div>
                        <form onSubmit={handleEditEquipment}>
                            <div style={{ padding: '20px', display: 'flex', flexDirection: 'column', gap: '16px' }}>
                                <div>
                                    <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: theme.text }}>Equipment Name *</label>
                                    <input 
                                        type="text" 
                                        value={formData.name}
                                        onChange={(e) => setFormData({...formData, name: e.target.value})}
                                        required
                                        style={{ width: '100%', padding: '10px 12px', border: `1px solid ${theme.borderLight}`, fontSize: '14px', outline: 'none', boxSizing: 'border-box', backgroundColor: theme.inputBg, color: theme.text }}
                                    />
                                </div>
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px' }}>
                                    <div>
                                        <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: theme.text }}>Type</label>
                                        <select 
                                            value={formData.type}
                                            onChange={(e) => setFormData({...formData, type: e.target.value})}
                                            style={{ width: '100%', padding: '10px 12px', border: `1px solid ${theme.borderLight}`, fontSize: '14px', outline: 'none', boxSizing: 'border-box', backgroundColor: theme.inputBg, color: theme.text }}
                                        >
                                            {EQUIPMENT_TYPES.map(type => (
                                                <option key={type.id} value={type.id}>{type.name}</option>
                                            ))}
                                        </select>
                                    </div>
                                    <div>
                                        <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: theme.text }}>Status</label>
                                        <select 
                                            value={formData.status}
                                            onChange={(e) => setFormData({...formData, status: e.target.value})}
                                            style={{ width: '100%', padding: '10px 12px', border: `1px solid ${theme.borderLight}`, fontSize: '14px', outline: 'none', boxSizing: 'border-box', backgroundColor: theme.inputBg, color: theme.text }}
                                        >
                                            {STATUS_OPTIONS.map(status => (
                                                <option key={status.id} value={status.id}>{status.name}</option>
                                            ))}
                                        </select>
                                    </div>
                                </div>
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px' }}>
                                    <div>
                                        <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: theme.text }}>Location</label>
                                        <input 
                                            type="text" 
                                            value={formData.location}
                                            onChange={(e) => setFormData({...formData, location: e.target.value})}
                                            style={{ width: '100%', padding: '10px 12px', border: `1px solid ${theme.borderLight}`, fontSize: '14px', outline: 'none', boxSizing: 'border-box', backgroundColor: theme.inputBg, color: theme.text }}
                                        />
                                    </div>
                                    <div>
                                        <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: theme.text }}>Serial Number</label>
                                        <input 
                                            type="text" 
                                            value={formData.serialNumber}
                                            onChange={(e) => setFormData({...formData, serialNumber: e.target.value})}
                                            style={{ width: '100%', padding: '10px 12px', border: `1px solid ${theme.borderLight}`, fontSize: '14px', outline: 'none', boxSizing: 'border-box', backgroundColor: theme.inputBg, color: theme.text }}
                                        />
                                    </div>
                                </div>
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px' }}>
                                    <div>
                                        <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: theme.text }}>Purchase Date</label>
                                        <input 
                                            type="date" 
                                            value={formData.purchaseDate}
                                            onChange={(e) => setFormData({...formData, purchaseDate: e.target.value})}
                                            style={{ width: '100%', padding: '10px 12px', border: `1px solid ${theme.borderLight}`, fontSize: '14px', outline: 'none', boxSizing: 'border-box', backgroundColor: theme.inputBg, color: theme.text }}
                                        />
                                    </div>
                                    <div>
                                        <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: theme.text }}>Next Maintenance</label>
                                        <input 
                                            type="date" 
                                            value={formData.nextMaintenance}
                                            onChange={(e) => setFormData({...formData, nextMaintenance: e.target.value})}
                                            style={{ width: '100%', padding: '10px 12px', border: `1px solid ${theme.borderLight}`, fontSize: '14px', outline: 'none', boxSizing: 'border-box', backgroundColor: theme.inputBg, color: theme.text }}
                                        />
                                    </div>
                                </div>
                                <div>
                                    <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: theme.text }}>Notes</label>
                                    <textarea 
                                        value={formData.notes}
                                        onChange={(e) => setFormData({...formData, notes: e.target.value})}
                                        rows="3"
                                        style={{ width: '100%', padding: '10px 12px', border: `1px solid ${theme.borderLight}`, fontSize: '14px', outline: 'none', boxSizing: 'border-box', resize: 'vertical', fontFamily: 'inherit', backgroundColor: theme.inputBg, color: theme.text }}
                                    />
                                </div>
                            </div>
                            <div style={{ display: 'flex', justifyContent: 'flex-end', gap: '12px', padding: '16px 20px', borderTop: `1px solid ${theme.border}`, backgroundColor: theme.bgSecondary }}>
                                <button type="button" onClick={() => setShowEditModal(false)} style={{ padding: '10px 20px', backgroundColor: theme.bg, color: theme.text, border: `1px solid ${theme.borderLight}`, cursor: 'pointer', fontSize: '14px', fontWeight: '500' }}>Cancel</button>
                                <button type="submit" style={{ padding: '10px 20px', backgroundColor: '#3b82f6', color: 'white', border: 'none', cursor: 'pointer', fontSize: '14px', fontWeight: '500' }}>Save Changes</button>
                            </div>
                        </form>
                    </div>
                </div>
            )}

            {/* Transfer Equipment Modal */}
            {showTransferModal && selectedEquipment && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: theme.modalOverlay, display: 'flex', justifyContent: 'center', alignItems: 'center', zIndex: 1000 }} onClick={() => setShowTransferModal(false)}>
                    <div style={{ backgroundColor: theme.bg, width: '100%', maxWidth: '400px', boxShadow: '0 4px 20px rgba(0,0,0,0.15)' }} onClick={e => e.stopPropagation()}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '16px 20px', borderBottom: `1px solid ${theme.border}`, backgroundColor: theme.bgSecondary }}>
                            <h2 style={{ margin: 0, fontSize: '18px', fontWeight: '600', color: theme.text }}>Transfer Equipment</h2>
                            <button onClick={() => setShowTransferModal(false)} style={{ background: 'none', border: 'none', cursor: 'pointer', color: theme.textSecondary, padding: '4px' }}>{Icons.x}</button>
                        </div>
                        <form onSubmit={handleTransfer}>
                            <div style={{ padding: '20px', display: 'flex', flexDirection: 'column', gap: '16px' }}>
                                <div style={{ padding: '12px', backgroundColor: theme.bgTertiary, border: `1px solid ${theme.border}` }}>
                                    <div style={{ fontWeight: '500', color: theme.text }}>{selectedEquipment.name}</div>
                                    <div style={{ fontSize: '13px', color: theme.textSecondary }}>Current Location: <strong>{selectedEquipment.location || 'Not Set'}</strong></div>
                                </div>
                                <div>
                                    <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: theme.text }}>Transfer To *</label>
                                    <select 
                                        value={transferData.toLocation}
                                        onChange={(e) => setTransferData({...transferData, toLocation: e.target.value})}
                                        required
                                        style={{ width: '100%', padding: '10px 12px', border: `1px solid ${theme.borderLight}`, fontSize: '14px', outline: 'none', boxSizing: 'border-box', backgroundColor: theme.inputBg, color: theme.text }}
                                    >
                                        <option value="">Select Location</option>
                                        {LOCATIONS.filter(loc => loc !== selectedEquipment.location).map(loc => (
                                            <option key={loc} value={loc}>{loc}</option>
                                        ))}
                                    </select>
                                </div>
                                <div>
                                    <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: theme.text }}>Transfer Notes</label>
                                    <textarea 
                                        value={transferData.notes}
                                        onChange={(e) => setTransferData({...transferData, notes: e.target.value})}
                                        placeholder="Reason for transfer..."
                                        rows="2"
                                        style={{ width: '100%', padding: '10px 12px', border: `1px solid ${theme.borderLight}`, fontSize: '14px', outline: 'none', boxSizing: 'border-box', resize: 'vertical', fontFamily: 'inherit', backgroundColor: theme.inputBg, color: theme.text }}
                                    />
                                </div>
                            </div>
                            <div style={{ display: 'flex', justifyContent: 'flex-end', gap: '12px', padding: '16px 20px', borderTop: `1px solid ${theme.border}`, backgroundColor: theme.bgSecondary }}>
                                <button type="button" onClick={() => setShowTransferModal(false)} style={{ padding: '10px 20px', backgroundColor: theme.bg, color: theme.text, border: `1px solid ${theme.borderLight}`, cursor: 'pointer', fontSize: '14px', fontWeight: '500' }}>Cancel</button>
                                <button type="submit" style={{ padding: '10px 20px', backgroundColor: '#8b5cf6', color: 'white', border: 'none', cursor: 'pointer', fontSize: '14px', fontWeight: '500' }}>Transfer</button>
                            </div>
                        </form>
                    </div>
                </div>
            )}

            {/* Log Maintenance Modal */}
            {showMaintenanceModal && selectedEquipment && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: theme.modalOverlay, display: 'flex', justifyContent: 'center', alignItems: 'center', zIndex: 1000 }} onClick={() => setShowMaintenanceModal(false)}>
                    <div style={{ backgroundColor: theme.bg, width: '100%', maxWidth: '500px', maxHeight: '90vh', overflow: 'auto', boxShadow: '0 4px 20px rgba(0,0,0,0.15)' }} onClick={e => e.stopPropagation()}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '16px 20px', borderBottom: `1px solid ${theme.border}`, backgroundColor: theme.bgSecondary }}>
                            <h2 style={{ margin: 0, fontSize: '18px', fontWeight: '600', color: theme.text }}>Log Maintenance</h2>
                            <button onClick={() => setShowMaintenanceModal(false)} style={{ background: 'none', border: 'none', cursor: 'pointer', color: theme.textSecondary, padding: '4px' }}>{Icons.x}</button>
                        </div>
                        <form onSubmit={handleLogMaintenance}>
                            <div style={{ padding: '20px', display: 'flex', flexDirection: 'column', gap: '16px' }}>
                                <div style={{ padding: '12px', backgroundColor: theme.bgTertiary, border: `1px solid ${theme.border}` }}>
                                    <div style={{ fontWeight: '500', color: theme.text }}>{selectedEquipment.name}</div>
                                    <div style={{ fontSize: '13px', color: theme.textSecondary }}>Last Maintenance: <strong>{selectedEquipment.lastMaintenance || 'Never'}</strong></div>
                                </div>
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px' }}>
                                    <div>
                                        <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: theme.text }}>Maintenance Type *</label>
                                        <select 
                                            value={maintenanceData.type}
                                            onChange={(e) => setMaintenanceData({...maintenanceData, type: e.target.value})}
                                            required
                                            style={{ width: '100%', padding: '10px 12px', border: `1px solid ${theme.borderLight}`, fontSize: '14px', outline: 'none', boxSizing: 'border-box', backgroundColor: theme.inputBg, color: theme.text }}
                                        >
                                            {MAINTENANCE_TYPES.map(type => (
                                                <option key={type.id} value={type.id}>{type.name}</option>
                                            ))}
                                        </select>
                                    </div>
                                    <div>
                                        <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: theme.text }}>Cost ({getBrandingForReceipts().currencySymbol || 'KES'})</label>
                                        <input 
                                            type="number" 
                                            value={maintenanceData.cost}
                                            onChange={(e) => setMaintenanceData({...maintenanceData, cost: e.target.value})}
                                            placeholder="0.00"
                                            step="0.01"
                                            style={{ width: '100%', padding: '10px 12px', border: `1px solid ${theme.borderLight}`, fontSize: '14px', outline: 'none', boxSizing: 'border-box', backgroundColor: theme.inputBg, color: theme.text }}
                                        />
                                    </div>
                                </div>
                                <div>
                                    <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: theme.text }}>Description *</label>
                                    <textarea 
                                        value={maintenanceData.description}
                                        onChange={(e) => setMaintenanceData({...maintenanceData, description: e.target.value})}
                                        placeholder="Describe the maintenance performed..."
                                        rows="3"
                                        required
                                        style={{ width: '100%', padding: '10px 12px', border: `1px solid ${theme.borderLight}`, fontSize: '14px', outline: 'none', boxSizing: 'border-box', resize: 'vertical', fontFamily: 'inherit', backgroundColor: theme.inputBg, color: theme.text }}
                                    />
                                </div>
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px' }}>
                                    <div>
                                        <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: theme.text }}>Performed By</label>
                                        <input 
                                            type="text" 
                                            value={maintenanceData.performedBy}
                                            onChange={(e) => setMaintenanceData({...maintenanceData, performedBy: e.target.value})}
                                            placeholder="Technician name"
                                            style={{ width: '100%', padding: '10px 12px', border: `1px solid ${theme.borderLight}`, fontSize: '14px', outline: 'none', boxSizing: 'border-box', backgroundColor: theme.inputBg, color: theme.text }}
                                        />
                                    </div>
                                    <div>
                                        <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: theme.text }}>Next Maintenance Date</label>
                                        <input 
                                            type="date" 
                                            value={maintenanceData.nextMaintenanceDate}
                                            onChange={(e) => setMaintenanceData({...maintenanceData, nextMaintenanceDate: e.target.value})}
                                            style={{ width: '100%', padding: '10px 12px', border: `1px solid ${theme.borderLight}`, fontSize: '14px', outline: 'none', boxSizing: 'border-box', backgroundColor: theme.inputBg, color: theme.text }}
                                        />
                                    </div>
                                </div>
                            </div>
                            <div style={{ display: 'flex', justifyContent: 'flex-end', gap: '12px', padding: '16px 20px', borderTop: `1px solid ${theme.border}`, backgroundColor: theme.bgSecondary }}>
                                <button type="button" onClick={() => setShowMaintenanceModal(false)} style={{ padding: '10px 20px', backgroundColor: theme.bg, color: theme.text, border: `1px solid ${theme.borderLight}`, cursor: 'pointer', fontSize: '14px', fontWeight: '500' }}>Cancel</button>
                                <button type="submit" style={{ padding: '10px 20px', backgroundColor: '#10b981', color: 'white', border: 'none', cursor: 'pointer', fontSize: '14px', fontWeight: '500' }}>Log Maintenance</button>
                            </div>
                        </form>
                    </div>
                </div>
            )}

            {/* Equipment History Modal */}
            {showHistoryModal && selectedEquipment && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: theme.modalOverlay, display: 'flex', justifyContent: 'center', alignItems: 'center', zIndex: 1000 }} onClick={() => setShowHistoryModal(false)}>
                    <div style={{ backgroundColor: theme.bg, width: '100%', maxWidth: '600px', maxHeight: '90vh', overflow: 'auto', boxShadow: '0 4px 20px rgba(0,0,0,0.15)' }} onClick={e => e.stopPropagation()}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '16px 20px', borderBottom: `1px solid ${theme.border}`, backgroundColor: theme.bgSecondary }}>
                            <h2 style={{ margin: 0, fontSize: '18px', fontWeight: '600', color: theme.text }}>Equipment History</h2>
                            <button onClick={() => setShowHistoryModal(false)} style={{ background: 'none', border: 'none', cursor: 'pointer', color: theme.textSecondary, padding: '4px' }}>{Icons.x}</button>
                        </div>
                        <div style={{ padding: '20px' }}>
                            <div style={{ padding: '12px', backgroundColor: theme.bgTertiary, border: `1px solid ${theme.border}`, marginBottom: '20px' }}>
                                <div style={{ fontWeight: '500', color: theme.text }}>{selectedEquipment.name}</div>
                                <div style={{ fontSize: '13px', color: theme.textSecondary }}>Current Location: {selectedEquipment.location || 'Not Set'} | Status: {getStatusLabel(selectedEquipment.status)}</div>
                            </div>

                            {/* Transfer History */}
                            <div style={{ marginBottom: '24px' }}>
                                <h3 style={{ fontSize: '14px', fontWeight: '600', color: theme.text, marginBottom: '12px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                                    <span>‚ÜîÔ∏è</span> Transfer History
                                </h3>
                                {(!selectedEquipment.transferHistory || selectedEquipment.transferHistory.length === 0) ? (
                                    <div style={{ padding: '16px', backgroundColor: theme.bgSecondary, border: `1px solid ${theme.border}`, color: theme.textSecondary, fontSize: '13px', textAlign: 'center' }}>
                                        No transfer history available
                                    </div>
                                ) : (
                                    <div style={{ border: `1px solid ${theme.border}` }}>
                                        {selectedEquipment.transferHistory.slice().reverse().map((transfer, idx) => (
                                            <div key={idx} style={{ padding: '12px 16px', borderBottom: idx < selectedEquipment.transferHistory.length - 1 ? `1px solid ${theme.border}` : 'none', backgroundColor: idx % 2 === 0 ? theme.bg : theme.bgSecondary }}>
                                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '4px' }}>
                                                    <span style={{ fontWeight: '500', color: theme.text }}>{transfer.fromLocation} ‚Üí {transfer.toLocation}</span>
                                                    <span style={{ fontSize: '12px', color: theme.textMuted }}>{transfer.date}</span>
                                                </div>
                                                {transfer.notes && <div style={{ fontSize: '13px', color: theme.textSecondary }}>{transfer.notes}</div>}
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>

                            {/* Maintenance History */}
                            <div>
                                <h3 style={{ fontSize: '14px', fontWeight: '600', color: theme.text, marginBottom: '12px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                                    <span>üîß</span> Maintenance History
                                </h3>
                                {(!selectedEquipment.maintenanceHistory || selectedEquipment.maintenanceHistory.length === 0) ? (
                                    <div style={{ padding: '16px', backgroundColor: theme.bgSecondary, border: `1px solid ${theme.border}`, color: theme.textSecondary, fontSize: '13px', textAlign: 'center' }}>
                                        No maintenance history available
                                    </div>
                                ) : (
                                    <div style={{ border: `1px solid ${theme.border}` }}>
                                        {selectedEquipment.maintenanceHistory.slice().reverse().map((maintenance, idx) => (
                                            <div key={idx} style={{ padding: '12px 16px', borderBottom: idx < selectedEquipment.maintenanceHistory.length - 1 ? `1px solid ${theme.border}` : 'none', backgroundColor: idx % 2 === 0 ? theme.bg : theme.bgSecondary }}>
                                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '4px' }}>
                                                    <span style={{ fontWeight: '500', color: theme.text, textTransform: 'capitalize' }}>{maintenance.type}</span>
                                                    <span style={{ fontSize: '12px', color: theme.textMuted }}>{maintenance.date}</span>
                                                </div>
                                                <div style={{ fontSize: '13px', color: theme.textSecondary, marginBottom: '4px' }}>{maintenance.description}</div>
                                                <div style={{ display: 'flex', gap: '16px', fontSize: '12px', color: theme.textMuted }}>
                                                    {maintenance.performedBy && <span>By: {maintenance.performedBy}</span>}
                                                    {maintenance.cost && <span>Cost: {getBrandingForReceipts().currencySymbol || 'KES'} {parseFloat(maintenance.cost).toFixed(2)}</span>}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                        <div style={{ display: 'flex', justifyContent: 'flex-end', padding: '16px 20px', borderTop: `1px solid ${theme.border}`, backgroundColor: theme.bgSecondary }}>
                            <button onClick={() => setShowHistoryModal(false)} style={{ padding: '10px 20px', backgroundColor: '#3b82f6', color: 'white', border: 'none', cursor: 'pointer', fontSize: '14px', fontWeight: '500' }}>Close</button>
                        </div>
                    </div>
                </div>
            )}

            {/* Alert Modal */}
            <AlertModal
                isOpen={alertModal.isOpen}
                onClose={closeAlert}
                title={alertModal.title}
                message={alertModal.message}
                type={alertModal.type}
                onConfirm={alertModal.onConfirm}
                showCancel={alertModal.showCancel}
            />
        </div>
    );
}

// Fleet Accounts Management Component
function FleetAccounts() {
    const { canCreate, canEdit, canDelete } = usePermissions();
    const [accounts, setAccounts] = useState([]);
    const [loading, setLoading] = useState(true);
    const [activeTab, setActiveTab] = useState('accounts');
    const [searchQuery, setSearchQuery] = useState('');
    const [statusFilter, setStatusFilter] = useState('all');
    const [showAddModal, setShowAddModal] = useState(false);
    const [showEditModal, setShowEditModal] = useState(false);
    const [showViewModal, setShowViewModal] = useState(false);
    const [showVehicleModal, setShowVehicleModal] = useState(false);
    const [showContactModal, setShowContactModal] = useState(false);
    const [showTopUpModal, setShowTopUpModal] = useState(false);
    const [showExpenditureModal, setShowExpenditureModal] = useState(false);
    const [showReceiptModal, setShowReceiptModal] = useState(false);
    const [editingExpenditure, setEditingExpenditure] = useState(null);
    const [selectedAccount, setSelectedAccount] = useState(null);
    const [actionLoading, setActionLoading] = useState(false);
    const [successMessage, setSuccessMessage] = useState(null);
    const [error, setError] = useState(null);
    const [stats, setStats] = useState({ total: 0, active: 0, suspended: 0, totalVehicles: 0, totalBalance: 0, totalSpent: 0, totalServices: 0, totalExpenditures: 0 });
    
    // Realtime global fleet stats (for main stat cards - uses invoice matching)
    const [globalFleetStats, setGlobalFleetStats] = useState({
        totalSpent: 0,
        awaitingPayment: 0,
        totalServices: 0,
        paidWashes: 0,
        unpaidWashes: 0
    });
    
    // Vehicle expenditure from intake records (unpaid washes)
    const [vehicleExpenditures, setVehicleExpenditures] = useState({});
    const [loadingExpenditures, setLoadingExpenditures] = useState(false);
    
    // Realtime fleet stats for view modal (uses invoice matching like wash bay history)
    const [realtimeFleetStats, setRealtimeFleetStats] = useState({
        totalSpent: 0,
        awaitingPayment: 0,
        monthlySpendByVehicle: {},  // { plateNumber: { total, count } }
        paidWashes: 0,
        unpaidWashes: 0
    });
    const [fleetStatsUnsubscribers, setFleetStatsUnsubscribers] = useState([]);
    
    // Wash history modal state
    const [showWashHistoryModal, setShowWashHistoryModal] = useState(false);
    const [washHistoryAccount, setWashHistoryAccount] = useState(null);
    const [washHistory, setWashHistory] = useState([]);
    const [loadingWashHistory, setLoadingWashHistory] = useState(false);
    const [washHistoryUnsubscribers, setWashHistoryUnsubscribers] = useState([]);
    
    // Alert modal state
    const [alertModal, setAlertModal] = useState({
        isOpen: false,
        title: '',
        message: '',
        type: 'info',
        onConfirm: null,
        showCancel: false
    });
    
    const showAlert = (title, message, type = 'info', onConfirm = null, showCancel = false) => {
        setAlertModal({ isOpen: true, title, message, type, onConfirm, showCancel });
    };
    
    const closeAlert = () => {
        setAlertModal(prev => ({ ...prev, isOpen: false }));
    };

    const [accountForm, setAccountForm] = useState({
        companyName: '', contactPerson: '', phone: '', email: '', address: '',
        paymentTerms: 'prepaid', creditLimit: 0, discount: 0, balance: 0, notes: ''
    });
    const [vehicleForm, setVehicleForm] = useState({
        plateNumber: '', make: '', model: '', color: '', vehicleType: 'Sedan', driverName: '', driverPhone: ''
    });
    const [contactForm, setContactForm] = useState({
        name: '', phone: '', email: '', role: 'Driver', canAuthorize: false
    });
    const [topUpAmount, setTopUpAmount] = useState('');
    const [topUpNote, setTopUpNote] = useState('');
    const [expenditureForm, setExpenditureForm] = useState({
        description: '', category: 'Fuel', amount: '', date: new Date().toISOString().split('T')[0], note: '', vehicle: ''
    });

    const [isDark, setIsDark] = useState(document.documentElement.getAttribute('data-theme') === 'dark');

    useEffect(() => {
        const observer = new MutationObserver(() => {
            setIsDark(document.documentElement.getAttribute('data-theme') === 'dark');
        });
        observer.observe(document.documentElement, { attributes: true });
        return () => observer.disconnect();
    }, []);

    const theme = {
        bg: isDark ? '#1e293b' : 'white',
        bgSecondary: isDark ? '#0f172a' : '#f8fafc',
        bgTertiary: isDark ? '#334155' : '#f1f5f9',
        text: isDark ? '#f1f5f9' : '#1e293b',
        textSecondary: isDark ? '#94a3b8' : '#64748b',
        border: isDark ? '#334155' : '#e2e8f0',
        inputBg: isDark ? '#1e293b' : 'white'
    };

    const formatCurrency = (amount) => `${getBrandingForReceipts().currencySymbol || 'KES'} ${(amount || 0).toLocaleString()}`;

    useEffect(() => {
        if (successMessage) {
            const timer = setTimeout(() => setSuccessMessage(null), 3000);
            return () => clearTimeout(timer);
        }
    }, [successMessage]);

    // Load fleet accounts
    useEffect(() => {
        let unsub;
        const init = async () => {
            let services = window.FirebaseServices;
            let attempts = 0;
            while (!services && attempts < 50) {
                await new Promise(r => setTimeout(r, 100));
                services = window.FirebaseServices;
                attempts++;
            }
            if (services?.fleetService) {
                unsub = services.fleetService.subscribeToAccounts((data) => {
                    setAccounts(data);
                    setStats(services.fleetService.getStats(data));
                    setLoading(false);
                });
            } else {
                setLoading(false);
            }
        };
        init();
        return () => unsub && unsub();
    }, []);

    // Subscribe to global fleet stats in realtime (uses invoice matching like wash bay history)
    useEffect(() => {
        if (accounts.length === 0) return;

        const services = window.FirebaseServices;
        if (!services?.intakeRecordsService?.subscribeToFleetWashHistory) return;

        // Get ALL plate numbers from ALL fleet accounts
        const allPlateNumbers = [];
        const allVehiclesMap = {};
        
        accounts.forEach(account => {
            if (account.vehicles && account.vehicles.length > 0) {
                account.vehicles.forEach(v => {
                    const normalizedPlate = (v.plateNumber || '').toUpperCase().replace(/\s+/g, ' ').trim();
                    if (normalizedPlate && !allPlateNumbers.includes(normalizedPlate)) {
                        allPlateNumbers.push(normalizedPlate);
                        allVehiclesMap[normalizedPlate] = v;
                    }
                });
            }
        });

        if (allPlateNumbers.length === 0) return;

        // Subscribe to all fleet vehicles wash history
        const unsub = services.intakeRecordsService.subscribeToFleetWashHistory(
            allPlateNumbers,
            allVehiclesMap,
            (history) => {
                // Calculate global stats from history (already has invoice matching)
                let totalSpent = 0;
                let awaitingPayment = 0;
                let paidWashes = 0;
                let unpaidWashes = 0;

                history.forEach(wash => {
                    const price = wash.price || 0;
                    const isPaid = wash.paymentStatus === 'paid';

                    if (isPaid) {
                        totalSpent += price;
                        paidWashes++;
                    } else {
                        awaitingPayment += price;
                        unpaidWashes++;
                    }
                });

                setGlobalFleetStats({
                    totalSpent,
                    awaitingPayment,
                    totalServices: paidWashes + unpaidWashes,
                    paidWashes,
                    unpaidWashes
                });
            },
            (error) => {
                console.error('Error in global fleet stats:', error);
            }
        );

        return () => {
            if (unsub) try { unsub(); } catch(e) {}
        };
    }, [accounts]);

    // Function to load unpaid wash expenditures for fleet vehicles from intake records
    const loadVehicleExpenditures = async (account) => {
        if (!account || !account.vehicles || account.vehicles.length === 0) return {};
        
        setLoadingExpenditures(true);
        try {
            const services = window.FirebaseServices;
            if (!services?.intakeRecordsService) return {};
            
            // Get all plate numbers from this fleet account
            const plateNumbers = account.vehicles.map(v => v.plateNumber.toUpperCase().replace(/\s+/g, ' ').trim());
            
            // Fetch intake records and filter for this account's vehicles with pending payment
            const expenditures = {};
            let totalUnpaid = 0;
            
            // Query all intake records - we'll filter by plate number and payment status
            const { collection, getDocs, query, where } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            const db = services.db || window.db;
            
            for (const plate of plateNumbers) {
                try {
                    const q = query(
                        collection(db, 'vehicleIntake'),
                        where('plateNumber', '==', plate)
                    );
                    const querySnapshot = await getDocs(q);
                    
                    let vehicleUnpaidTotal = 0;
                    let unpaidRecords = [];
                    
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        // Only count unpaid/pending records for this fleet account
                        if (data.paymentStatus === 'pending' || data.paymentStatus === 'awaiting') {
                            // Use totalServicePrice if available, otherwise use service price
                            const cost = data.totalServicePrice || data.service?.price || 0;
                            vehicleUnpaidTotal += cost;
                            unpaidRecords.push({
                                id: doc.id,
                                ...data,
                                cost: cost
                            });
                        }
                        // Also check visit history for unpaid visits
                        if (data.visitHistoryLog && Array.isArray(data.visitHistoryLog)) {
                            data.visitHistoryLog.forEach(visit => {
                                if (visit.paymentStatus === 'pending' || visit.paymentStatus === 'awaiting') {
                                    const visitCost = visit.price || visit.service?.price || 0;
                                    vehicleUnpaidTotal += visitCost;
                                }
                            });
                        }
                    });
                    
                    expenditures[plate] = {
                        total: vehicleUnpaidTotal,
                        records: unpaidRecords,
                        count: unpaidRecords.length
                    };
                    totalUnpaid += vehicleUnpaidTotal;
                } catch (err) {
                    console.error('Error fetching expenditure for', plate, err);
                    expenditures[plate] = { total: 0, records: [], count: 0 };
                }
            }
            
            expenditures._totalUnpaid = totalUnpaid;
            setVehicleExpenditures(expenditures);
            return expenditures;
        } catch (error) {
            console.error('Error loading vehicle expenditures:', error);
            return {};
        } finally {
            setLoadingExpenditures(false);
        }
    };

    // Load expenditures when viewing an account
    useEffect(() => {
        if (showViewModal && selectedAccount) {
            loadVehicleExpenditures(selectedAccount);
        }
    }, [showViewModal, selectedAccount?.id]);

    // Subscribe to realtime fleet stats when viewing an account (uses invoice matching like wash bay history)
    useEffect(() => {
        if (!showViewModal || !selectedAccount || !selectedAccount.vehicles?.length) {
            return;
        }

        const services = window.FirebaseServices;
        if (!services?.intakeRecordsService?.subscribeToFleetWashHistory) {
            return;
        }

        // Get all plate numbers from this fleet account
        const plateNumbers = selectedAccount.vehicles.map(v => 
            (v.plateNumber || '').toUpperCase().replace(/\s+/g, ' ').trim()
        ).filter(p => p.length > 0);

        // Create a map of vehicles by plate for quick lookup
        const vehiclesMap = {};
        selectedAccount.vehicles.forEach(v => {
            const normalizedPlate = (v.plateNumber || '').toUpperCase().replace(/\s+/g, ' ').trim();
            if (normalizedPlate) {
                vehiclesMap[normalizedPlate] = v;
            }
        });

        // Subscribe to fleet wash history - this already uses invoice matching for payment status
        const unsub = services.intakeRecordsService.subscribeToFleetWashHistory(
            plateNumbers,
            vehiclesMap,
            (history) => {
                // Calculate realtime stats from the history data
                // Get current month boundaries
                const now = new Date();
                const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                
                let totalSpent = 0;
                let awaitingPayment = 0;
                let paidWashes = 0;
                let unpaidWashes = 0;
                const monthlySpendByVehicle = {};
                const awaitingByVehicle = {};

                history.forEach(wash => {
                    const price = wash.price || 0;
                    const washDate = wash.date ? new Date(wash.date) : null;
                    const isThisMonth = washDate && washDate >= monthStart;
                    const plateKey = (wash.plateNumber || '').toUpperCase().replace(/\s+/g, ' ').trim();

                    // Payment status is already resolved via invoice matching in subscribeToFleetWashHistory
                    const isPaid = wash.paymentStatus === 'paid';

                    if (isPaid) {
                        totalSpent += price;
                        paidWashes++;
                        
                        // Track monthly spend per vehicle
                        if (isThisMonth && plateKey) {
                            if (!monthlySpendByVehicle[plateKey]) {
                                monthlySpendByVehicle[plateKey] = { total: 0, count: 0 };
                            }
                            monthlySpendByVehicle[plateKey].total += price;
                            monthlySpendByVehicle[plateKey].count++;
                        }
                    } else {
                        awaitingPayment += price;
                        unpaidWashes++;
                        
                        // Track awaiting payment per vehicle
                        if (plateKey) {
                            if (!awaitingByVehicle[plateKey]) {
                                awaitingByVehicle[plateKey] = { total: 0, count: 0 };
                            }
                            awaitingByVehicle[plateKey].total += price;
                            awaitingByVehicle[plateKey].count++;
                        }
                    }
                });

                setRealtimeFleetStats({
                    totalSpent,
                    awaitingPayment,
                    monthlySpendByVehicle,
                    awaitingByVehicle,
                    paidWashes,
                    unpaidWashes
                });

                // Also set washHistory so print function can use it
                setWashHistory(history);

                // Also update vehicleExpenditures for the vehicle cards (awaiting payment)
                const expenditures = { _totalUnpaid: awaitingPayment };
                Object.keys(awaitingByVehicle).forEach(plate => {
                    expenditures[plate] = awaitingByVehicle[plate];
                });
                setVehicleExpenditures(expenditures);
                setLoadingExpenditures(false);
            },
            (error) => {
                console.error('Error in realtime fleet stats:', error);
            }
        );

        setFleetStatsUnsubscribers([unsub]);

        // Cleanup
        return () => {
            if (unsub) try { unsub(); } catch(e) {}
        };
    }, [showViewModal, selectedAccount?.id]);

    // Function to load wash history for a fleet account - REALTIME with Firestore
    const loadWashHistory = (account) => {
        if (!account || !account.vehicles || account.vehicles.length === 0) {
            setWashHistory([]);
            setLoadingWashHistory(false);
            return;
        }
        
        setLoadingWashHistory(true);
        
        // Cleanup previous listeners
        washHistoryUnsubscribers.forEach(unsub => {
            try { unsub(); } catch(e) {}
        });
        setWashHistoryUnsubscribers([]);
        
        const services = window.FirebaseServices;
        if (!services?.intakeRecordsService?.subscribeToFleetWashHistory) {
            console.error('Fleet wash history service not available');
            setWashHistory([]);
            setLoadingWashHistory(false);
            return;
        }
        
        // Get all plate numbers from this fleet account (normalized)
        const plateNumbers = account.vehicles.map(v => 
            (v.plateNumber || '').toUpperCase().replace(/\s+/g, ' ').trim()
        ).filter(p => p.length > 0);
        
        // Create a map of vehicles by plate for quick lookup
        const vehiclesMap = {};
        account.vehicles.forEach(v => {
            const normalizedPlate = (v.plateNumber || '').toUpperCase().replace(/\s+/g, ' ').trim();
            if (normalizedPlate) {
                vehiclesMap[normalizedPlate] = v;
            }
        });
        
        console.log('üöó Fleet plates to search:', plateNumbers);
        
        // Subscribe to fleet wash history
        const unsub = services.intakeRecordsService.subscribeToFleetWashHistory(
            plateNumbers,
            vehiclesMap,
            (history) => {
                setWashHistory(history);
                setLoadingWashHistory(false);
            },
            (error) => {
                console.error('Error loading fleet wash history:', error);
                setWashHistory([]);
                setLoadingWashHistory(false);
            }
        );
        
        setWashHistoryUnsubscribers([unsub]);
    };

    // Cleanup wash history listeners when modal closes
    useEffect(() => {
        if (!showWashHistoryModal) {
            washHistoryUnsubscribers.forEach(unsub => unsub());
            setWashHistoryUnsubscribers([]);
        }
    }, [showWashHistoryModal]);

    // Open wash history modal
    const openWashHistoryModal = (account) => {
        setWashHistoryAccount(account);
        setShowWashHistoryModal(true);
        loadWashHistory(account);
    };

    const filteredAccounts = accounts.filter(acc => {
        const matchesSearch = acc.companyName?.toLowerCase().includes(searchQuery.toLowerCase()) ||
            acc.accountNumber?.toLowerCase().includes(searchQuery.toLowerCase()) ||
            acc.contactPerson?.toLowerCase().includes(searchQuery.toLowerCase());
        const matchesStatus = statusFilter === 'all' || acc.status === statusFilter;
        return matchesSearch && matchesStatus;
    });

    const resetAccountForm = () => setAccountForm({
        companyName: '', contactPerson: '', phone: '', email: '', address: '',
        paymentTerms: 'prepaid', creditLimit: 0, discount: 0, balance: 0, notes: ''
    });

    const handleAddAccount = async () => {
        if (!accountForm.companyName || !accountForm.phone) {
            setError('Company name and phone are required');
            return;
        }
        setActionLoading(true);
        const services = window.FirebaseServices;
        const result = await services.fleetService.addAccount(accountForm);
        if (result.success) {
            setSuccessMessage(`Fleet account ${result.accountNumber} created successfully`);
            setShowAddModal(false);
            resetAccountForm();
        } else {
            setError(result.error);
        }
        setActionLoading(false);
    };

    const handleEditAccount = async () => {
        if (!selectedAccount) return;
        setActionLoading(true);
        const services = window.FirebaseServices;
        const result = await services.fleetService.updateAccount(selectedAccount.id, accountForm);
        if (result.success) {
            setSuccessMessage('Account updated successfully');
            setShowEditModal(false);
            setSelectedAccount(null);
        } else {
            setError(result.error);
        }
        setActionLoading(false);
    };

    const handleDeleteAccount = async (account) => {
        showAlert(
            'Delete Fleet Account',
            `Delete fleet account "${account.companyName}"? This action cannot be undone.`,
            'warning',
            async () => {
                const services = window.FirebaseServices;
                const result = await services.fleetService.deleteAccount(account.id);
                if (result.success) {
                    setSuccessMessage('Account deleted');
                } else {
                    setError(result.error);
                }
            },
            true
        );
    };

    const handleAddVehicle = async () => {
        if (!vehicleForm.plateNumber) {
            setError('Plate number is required');
            return;
        }
        setActionLoading(true);
        const services = window.FirebaseServices;
        const result = await services.fleetService.addVehicle(selectedAccount.id, vehicleForm);
        if (result.success) {
            setSuccessMessage('Vehicle added successfully');
            setShowVehicleModal(false);
            setVehicleForm({ plateNumber: '', make: '', model: '', color: '', vehicleType: 'Sedan', driverName: '', driverPhone: '' });
            // Refresh selected account
            const accResult = await services.fleetService.getAccount(selectedAccount.id);
            if (accResult.success) setSelectedAccount(accResult.data);
        } else {
            setError(result.error);
        }
        setActionLoading(false);
    };

    const handleRemoveVehicle = async (vehicleId) => {
        showAlert(
            'Remove Vehicle',
            'Remove this vehicle from the fleet?',
            'warning',
            async () => {
                const services = window.FirebaseServices;
                const result = await services.fleetService.removeVehicle(selectedAccount.id, vehicleId);
                if (result.success) {
                    setSuccessMessage('Vehicle removed');
                    const accResult = await services.fleetService.getAccount(selectedAccount.id);
                    if (accResult.success) setSelectedAccount(accResult.data);
                } else {
                    setError(result.error);
                }
            },
            true
        );
    };

    const handleSendToQueue = async (vehicle) => {
        setActionLoading(true);
        const services = window.FirebaseServices;
        const vehicleData = {
            plateNumber: vehicle.plateNumber,
            vehicleType: vehicle.vehicleType || 'Sedan',
            make: vehicle.make || '',
            model: vehicle.model || '',
            color: vehicle.color || '',
            customerName: selectedAccount.companyName,
            customerPhone: selectedAccount.phone,
            driverName: vehicle.driverName || '',
            driverPhone: vehicle.driverPhone || '',
            priority: 'fleet',
            fleetAccountId: selectedAccount.id,
            fleetAccountNumber: selectedAccount.accountNumber,
            discount: selectedAccount.discount || 0,
            notes: `Fleet vehicle from ${selectedAccount.companyName}`
        };
        const result = await services.intakeQueueService.addToQueue(vehicleData);
        setActionLoading(false);
        
        if (result.success) {
            // Close all open modals first
            setShowViewModal(false);
            setShowVehicleModal(false);
            setShowContactModal(false);
            setShowTopUpModal(false);
            setShowExpenditureModal(false);
            setShowReceiptModal(false);
            setShowWashHistoryModal(false);
            
            // Show success alert with auto-dismiss
            showAlert(
                '‚úÖ Vehicle Sent to Queue',
                `${vehicle.plateNumber} (${vehicle.make || ''} ${vehicle.model || ''}) has been sent to the intake queue.\n\nCompany: ${selectedAccount.companyName}\nDriver: ${vehicle.driverName || 'Not specified'}`,
                'success'
            );
            
            // Auto-dismiss after 3 seconds
            setTimeout(() => {
                closeAlert();
            }, 3000);
        } else {
            setError(result.error || 'Failed to add to queue');
        }
    };

    const handleAddContact = async () => {
        if (!contactForm.name || !contactForm.phone) {
            setError('Name and phone are required');
            return;
        }
        setActionLoading(true);
        const services = window.FirebaseServices;
        const result = await services.fleetService.addContact(selectedAccount.id, contactForm);
        if (result.success) {
            setSuccessMessage('Contact added');
            setShowContactModal(false);
            setContactForm({ name: '', phone: '', email: '', role: 'Driver', canAuthorize: false });
            const accResult = await services.fleetService.getAccount(selectedAccount.id);
            if (accResult.success) setSelectedAccount(accResult.data);
        } else {
            setError(result.error);
        }
        setActionLoading(false);
    };

    const handleRemoveContact = async (contactId) => {
        showAlert(
            'Remove Contact',
            'Remove this contact from the account?',
            'warning',
            async () => {
                const services = window.FirebaseServices;
                const result = await services.fleetService.removeContact(selectedAccount.id, contactId);
                if (result.success) {
                    setSuccessMessage('Contact removed');
                    const accResult = await services.fleetService.getAccount(selectedAccount.id);
                    if (accResult.success) setSelectedAccount(accResult.data);
                } else {
                    setError(result.error);
                }
            },
            true
        );
    };

    const handleTopUp = async () => {
        if (!topUpAmount || Number(topUpAmount) <= 0) {
            setError('Enter a valid amount');
            return;
        }
        setActionLoading(true);
        const services = window.FirebaseServices;
        const result = await services.fleetService.addBalance(selectedAccount.id, Number(topUpAmount), topUpNote);
        if (result.success) {
            setSuccessMessage(`Balance topped up. New balance: ${formatCurrency(result.newBalance)}`);
            setShowTopUpModal(false);
            setTopUpAmount('');
            setTopUpNote('');
            const accResult = await services.fleetService.getAccount(selectedAccount.id);
            if (accResult.success) setSelectedAccount(accResult.data);
        } else {
            setError(result.error);
        }
        setActionLoading(false);
    };

    // Expenditure handlers
    const resetExpenditureForm = () => setExpenditureForm({
        description: '', category: 'Fuel', amount: '', date: new Date().toISOString().split('T')[0], note: '', vehicle: ''
    });

    const handleAddExpenditure = async () => {
        if (!expenditureForm.description || !expenditureForm.amount) {
            setError('Description and amount are required');
            return;
        }
        setActionLoading(true);
        const services = window.FirebaseServices;
        const result = await services.fleetService.addExpenditure(selectedAccount.id, expenditureForm);
        if (result.success) {
            setSuccessMessage('Expenditure added successfully');
            setShowExpenditureModal(false);
            resetExpenditureForm();
            const accResult = await services.fleetService.getAccount(selectedAccount.id);
            if (accResult.success) setSelectedAccount(accResult.data);
        } else {
            setError(result.error);
        }
        setActionLoading(false);
    };

    const handleUpdateExpenditure = async () => {
        if (!expenditureForm.description || !expenditureForm.amount) {
            setError('Description and amount are required');
            return;
        }
        setActionLoading(true);
        const services = window.FirebaseServices;
        const result = await services.fleetService.updateExpenditure(selectedAccount.id, editingExpenditure.id, expenditureForm);
        if (result.success) {
            setSuccessMessage('Expenditure updated');
            setShowExpenditureModal(false);
            setEditingExpenditure(null);
            resetExpenditureForm();
            const accResult = await services.fleetService.getAccount(selectedAccount.id);
            if (accResult.success) setSelectedAccount(accResult.data);
        } else {
            setError(result.error);
        }
        setActionLoading(false);
    };

    const handleDeleteExpenditure = async (expId) => {
        showAlert(
            'Delete Expenditure',
            'Delete this expenditure record?',
            'warning',
            async () => {
                const services = window.FirebaseServices;
                const result = await services.fleetService.deleteExpenditure(selectedAccount.id, expId);
                if (result.success) {
                    setSuccessMessage('Expenditure deleted');
                    const accResult = await services.fleetService.getAccount(selectedAccount.id);
                    if (accResult.success) setSelectedAccount(accResult.data);
                } else {
                    setError(result.error);
                }
            },
            true
        );
    };

    const openEditExpenditure = (exp) => {
        setEditingExpenditure(exp);
        setExpenditureForm({
            description: exp.description || '',
            category: exp.category || 'Fuel',
            amount: exp.amount || '',
            date: exp.date || new Date().toISOString().split('T')[0],
            note: exp.note || '',
            vehicle: exp.vehicle || ''
        });
        setShowExpenditureModal(true);
    };

    // Print receipt/invoice function
    // Generate Fleet Invoice using realtime wash history data
    const printReceipt = (account, period = 'all') => {
        const now = new Date();
        let periodLabel = 'All Time';
        let periodStart = null;

        if (period === 'month') {
            periodStart = new Date(now.getFullYear(), now.getMonth(), 1);
            periodLabel = now.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        } else if (period === 'week') {
            periodStart = new Date(now);
            periodStart.setDate(now.getDate() - 7);
            periodLabel = 'Last 7 Days';
        }

        // Filter wash history by period
        const filteredHistory = periodStart 
            ? washHistory.filter(w => w.date && new Date(w.date) >= periodStart)
            : washHistory;

        // Group washes by vehicle
        const vehicleWashes = {};
        filteredHistory.forEach(wash => {
            const plate = wash.plateNumber || 'Unknown';
            if (!vehicleWashes[plate]) {
                vehicleWashes[plate] = {
                    vehicle: account.vehicles?.find(v => v.plateNumber.toUpperCase().replace(/\s+/g, ' ').trim() === plate) || { plateNumber: plate },
                    washes: [],
                    totalAmount: 0,
                    paidAmount: 0,
                    unpaidAmount: 0
                };
            }
            vehicleWashes[plate].washes.push(wash);
            const price = wash.price || 0;
            vehicleWashes[plate].totalAmount += price;
            if (wash.paymentStatus === 'paid') {
                vehicleWashes[plate].paidAmount += price;
            } else {
                vehicleWashes[plate].unpaidAmount += price;
            }
        });

        // Calculate totals
        const totalAmount = filteredHistory.reduce((sum, w) => sum + (w.price || 0), 0);
        const paidAmount = filteredHistory.filter(w => w.paymentStatus === 'paid').reduce((sum, w) => sum + (w.price || 0), 0);
        const unpaidAmount = totalAmount - paidAmount;
        const totalWashes = filteredHistory.length;

        // Invoice number
        const invoiceNo = `INV-${account.accountNumber?.slice(-4) || '0000'}-${Date.now().toString().slice(-6)}`;

        // Due date (30 days for postpaid)
        const dueDate = new Date(now);
        dueDate.setDate(dueDate.getDate() + 30);

        const printContent = `
<!DOCTYPE html>
<html>
<head>
    <title>Fleet Invoice - ${account.companyName}</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; font-size: 11px; color: #1e293b; line-height: 1.5; background: #fff; padding: 20px; }
        
        .header { display: flex; justify-content: space-between; border-bottom: 2px solid #1e293b; padding-bottom: 16px; margin-bottom: 20px; }
        .logo { font-size: 24px; font-weight: 800; }
        .logo .eco { color: #10b981; }
        .invoice-info { text-align: right; }
        .invoice-title { font-size: 20px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
        .invoice-no { font-family: monospace; color: #64748b; margin-top: 4px; }
        
        .info-row { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .info-block { width: 48%; }
        .info-label { font-size: 9px; font-weight: 700; text-transform: uppercase; color: #64748b; margin-bottom: 6px; letter-spacing: 0.5px; }
        .company-name { font-size: 16px; font-weight: 700; margin-bottom: 4px; }
        .info-line { margin-bottom: 2px; color: #475569; }
        
        .summary-table { width: 100%; margin-bottom: 20px; border-collapse: collapse; }
        .summary-table td { padding: 8px 12px; border: 1px solid #e2e8f0; }
        .summary-table .label { color: #64748b; font-size: 10px; text-transform: uppercase; }
        .summary-table .value { font-size: 14px; font-weight: 700; }
        
        .section-title { font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin: 24px 0 12px; padding-bottom: 6px; border-bottom: 1px solid #e2e8f0; }
        
        table { width: 100%; border-collapse: collapse; margin-bottom: 16px; }
        th { background: #f8fafc; padding: 8px 10px; text-align: left; font-size: 9px; text-transform: uppercase; font-weight: 700; color: #64748b; border-bottom: 2px solid #e2e8f0; }
        td { padding: 8px 10px; border-bottom: 1px solid #f1f5f9; font-size: 11px; }
        .text-right { text-align: right; }
        .text-center { text-align: center; }
        .mono { font-family: monospace; }
        
        .vehicle-row { background: #f8fafc; font-weight: 600; }
        .vehicle-row td { border-bottom: 1px solid #e2e8f0; padding: 10px; }
        
        /* Hide browser print headers/footers with URL */
        @page { 
            margin: 10mm; 
            size: A4;
        }
        @page :first { margin-top: 10mm; }
        @page :left { margin-left: 10mm; }
        @page :right { margin-right: 10mm; }
        .wash-row td { padding-left: 24px; color: #475569; }
        .subtotal-row { background: #f8fafc; }
        .subtotal-row td { font-weight: 600; border-top: 1px solid #e2e8f0; }
        
        .totals { margin-top: 20px; border-top: 2px solid #1e293b; padding-top: 12px; }
        .totals-row { display: flex; justify-content: flex-end; margin-bottom: 4px; }
        .totals-label { width: 150px; text-align: right; padding-right: 20px; color: #64748b; }
        .totals-value { width: 120px; text-align: right; font-weight: 600; font-family: monospace; }
        .totals-final { font-size: 14px; font-weight: 700; border-top: 1px solid #e2e8f0; padding-top: 8px; margin-top: 8px; }
        .totals-final .totals-value { font-size: 14px; }
        
        .unpaid-notice { background: #fef3c7; border: 1px solid #fcd34d; padding: 12px 16px; margin-top: 20px; }
        .unpaid-notice .title { font-weight: 700; color: #92400e; margin-bottom: 4px; }
        .unpaid-notice .detail { color: #78350f; font-size: 10px; }
        
        .footer { margin-top: 30px; padding-top: 16px; border-top: 1px solid #e2e8f0; text-align: center; color: #64748b; font-size: 10px; }
        
        @media print { 
            body { padding: 10px; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            /* This helps some browsers hide headers/footers */
            html { margin: 0; padding: 0; }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div>
            <div class="logo">${getBrandingForReceipts().companyName}</div>
            <div style="font-size: 10px; color: #64748b;">${getBrandingForReceipts().tagline || 'Professional Car Wash Services'}</div>
        </div>
        <div class="invoice-info">
            <div class="invoice-title">Invoice</div>
            <div class="invoice-no">${invoiceNo}</div>
            <div style="font-size: 10px; color: #64748b; margin-top: 4px;">${now.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</div>
        </div>
    </div>
    
    <!-- Account Info -->
    <div class="info-row">
        <div class="info-block">
            <div class="info-label">Bill To</div>
            <div class="company-name">${account.companyName}</div>
            <div class="info-line">${account.contactPerson || ''}</div>
            <div class="info-line">${account.phone || ''}</div>
            <div class="info-line">${account.email || ''}</div>
            <div class="info-line mono" style="margin-top: 6px;">Account: ${account.accountNumber}</div>
        </div>
        <div class="info-block">
            <div class="info-label">Invoice Details</div>
            <div class="info-line"><strong>Period:</strong> ${periodLabel}</div>
            <div class="info-line"><strong>Payment Terms:</strong> ${(account.paymentTerms || 'Prepaid').toUpperCase()}</div>
            <div class="info-line"><strong>Due Date:</strong> ${dueDate.toLocaleDateString()}</div>
            <div class="info-line"><strong>Fleet Size:</strong> ${account.vehicles?.length || 0} vehicles</div>
            <div class="info-line"><strong>Discount:</strong> ${account.discount || 0}%</div>
        </div>
    </div>
    
    <!-- Summary -->
    <table class="summary-table">
        <tr>
            <td><div class="label">Total Washes</div><div class="value">${totalWashes}</div></td>
            <td><div class="label">Vehicles Serviced</div><div class="value">${Object.keys(vehicleWashes).length}</div></td>
            <td><div class="label">Amount Paid</div><div class="value" style="color: #10b981;">${getBrandingForReceipts().currencySymbol || 'KES'} ${paidAmount.toLocaleString()}</div></td>
            <td><div class="label">Amount Due</div><div class="value" style="color: ${unpaidAmount > 0 ? '#dc2626' : '#10b981'};">${getBrandingForReceipts().currencySymbol || 'KES'} ${unpaidAmount.toLocaleString()}</div></td>
        </tr>
    </table>
    
    <!-- Vehicle Summary -->
    <div class="section-title">Vehicle Summary</div>
    <table>
        <thead>
            <tr>
                <th>Plate Number</th>
                <th>Vehicle</th>
                <th>Driver</th>
                <th class="text-center">Washes</th>
                <th class="text-right">Total Spent</th>
                <th class="text-right">Paid</th>
                <th class="text-right">Unpaid</th>
            </tr>
        </thead>
        <tbody>
            ${Object.entries(vehicleWashes).map(([plate, data]) => `
            <tr>
                <td class="mono" style="font-weight: 600;">${plate}</td>
                <td>${data.vehicle.make || ''} ${data.vehicle.model || ''}</td>
                <td>${data.vehicle.driverName || '-'}</td>
                <td class="text-center">${data.washes.length}</td>
                <td class="text-right mono">${getBrandingForReceipts().currencySymbol || 'KES'} ${data.totalAmount.toLocaleString()}</td>
                <td class="text-right mono" style="color: #10b981;">${getBrandingForReceipts().currencySymbol || 'KES'} ${data.paidAmount.toLocaleString()}</td>
                <td class="text-right mono" style="color: ${data.unpaidAmount > 0 ? '#dc2626' : '#64748b'};">${getBrandingForReceipts().currencySymbol || 'KES'} ${data.unpaidAmount.toLocaleString()}</td>
            </tr>
            `).join('')}
            <tr class="subtotal-row">
                <td colspan="3" class="text-right">TOTAL</td>
                <td class="text-center">${totalWashes}</td>
                <td class="text-right mono">${getBrandingForReceipts().currencySymbol || 'KES'} ${totalAmount.toLocaleString()}</td>
                <td class="text-right mono" style="color: #10b981;">${getBrandingForReceipts().currencySymbol || 'KES'} ${paidAmount.toLocaleString()}</td>
                <td class="text-right mono" style="color: ${unpaidAmount > 0 ? '#dc2626' : '#64748b'};">${getBrandingForReceipts().currencySymbol || 'KES'} ${unpaidAmount.toLocaleString()}</td>
            </tr>
        </tbody>
    </table>
    
    <!-- Wash History Detail -->
    <div class="section-title">Wash History</div>
    <table>
        <thead>
            <tr>
                <th>Date</th>
                <th>Time</th>
                <th>Vehicle</th>
                <th>Driver</th>
                <th>Service</th>
                <th>Bay</th>
                <th class="text-right">Amount</th>
                <th class="text-center">Status</th>
            </tr>
        </thead>
        <tbody>
            ${filteredHistory.length > 0 ? filteredHistory.map(wash => `
            <tr>
                <td>${wash.date ? new Date(wash.date).toLocaleDateString() : '-'}</td>
                <td>${wash.date ? new Date(wash.date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '-'}</td>
                <td class="mono" style="font-weight: 500;">${wash.plateNumber || '-'}</td>
                <td>${wash.driverName || '-'}</td>
                <td>${wash.service || 'Car Wash'}${wash.additionalServices?.length > 0 ? ` (+${wash.additionalServices.length})` : ''}</td>
                <td>${wash.bay || '-'}</td>
                <td class="text-right mono">${getBrandingForReceipts().currencySymbol || 'KES'} ${(wash.price || 0).toLocaleString()}</td>
                <td class="text-center" style="color: ${wash.paymentStatus === 'paid' ? '#10b981' : '#dc2626'}; font-weight: 600;">
                    ${wash.paymentStatus === 'paid' ? 'PAID' : 'UNPAID'}
                </td>
            </tr>
            `).join('') : `
            <tr><td colspan="8" style="text-align: center; padding: 20px; color: #64748b;">No wash records for this period</td></tr>
            `}
        </tbody>
    </table>
    
    <!-- Totals -->
    <div class="totals">
        <div class="totals-row">
            <div class="totals-label">Subtotal (${totalWashes} washes):</div>
            <div class="totals-value">${getBrandingForReceipts().currencySymbol || 'KES'} ${totalAmount.toLocaleString()}</div>
        </div>
        ${account.discount > 0 ? `
        <div class="totals-row">
            <div class="totals-label">Discount (${account.discount}%):</div>
            <div class="totals-value" style="color: #10b981;">-${getBrandingForReceipts().currencySymbol || 'KES'} ${Math.round(unpaidAmount * account.discount / 100).toLocaleString()}</div>
        </div>
        ` : ''}
        <div class="totals-row">
            <div class="totals-label">Amount Paid:</div>
            <div class="totals-value" style="color: #10b981;">${getBrandingForReceipts().currencySymbol || 'KES'} ${paidAmount.toLocaleString()}</div>
        </div>
        <div class="totals-row totals-final">
            <div class="totals-label">BALANCE DUE:</div>
            <div class="totals-value" style="color: ${unpaidAmount > 0 ? '#dc2626' : '#10b981'};">${getBrandingForReceipts().currencySymbol || 'KES'} ${Math.round(unpaidAmount * (100 - (account.discount || 0)) / 100).toLocaleString()}</div>
        </div>
    </div>
    
    ${unpaidAmount > 0 ? `
    <div class="unpaid-notice">
        <div class="title">Payment Required</div>
        <div class="detail">Please settle the outstanding balance of ${getBrandingForReceipts().currencySymbol || 'KES'} ${Math.round(unpaidAmount * (100 - (account.discount || 0)) / 100).toLocaleString()} by ${dueDate.toLocaleDateString()}.</div>
        <div class="detail" style="margin-top: 6px;">Bank: Equity Bank | Account: 0123456789 | M-Pesa Paybill: 123456 | Ref: ${account.accountNumber}</div>
    </div>
    ` : ''}
    
    <!-- Footer -->
    <div class="footer">
        <div>Thank you for your business with ${getBrandingForReceipts().companyName}</div>
        <div style="margin-top: 4px;">Invoice generated on ${now.toLocaleString()} | ${invoiceNo}</div>
    </div>
</body>
</html>`;

        const printWindow = window.open('', '_blank', 'width=800,height=600');
        printWindow.document.write(printContent);
        printWindow.document.close();
        printWindow.onload = () => {
            printWindow.print();
        };
    };

    const openViewModal = (account) => {
        setSelectedAccount(account);
        setShowViewModal(true);
    };

    const openEditModal = (account) => {
        setSelectedAccount(account);
        setAccountForm({
            companyName: account.companyName || '',
            contactPerson: account.contactPerson || '',
            phone: account.phone || '',
            email: account.email || '',
            address: account.address || '',
            paymentTerms: account.paymentTerms || 'prepaid',
            creditLimit: account.creditLimit || 0,
            discount: account.discount || 0,
            balance: account.balance || 0,
            notes: account.notes || ''
        });
        setShowEditModal(true);
    };

    const btnPrimary = { padding: '10px 20px', background: '#3b82f6', color: 'white', border: 'none', cursor: 'pointer', fontWeight: '600', fontSize: '13px' };
    const btnSecondary = { padding: '10px 20px', background: theme.bgTertiary, color: theme.text, border: `1px solid ${theme.border}`, cursor: 'pointer', fontWeight: '600', fontSize: '13px' };
    const btnSuccess = { padding: '10px 20px', background: '#10b981', color: 'white', border: 'none', cursor: 'pointer', fontWeight: '600', fontSize: '13px' };
    const btnDanger = { padding: '8px 12px', background: '#ef4444', color: 'white', border: 'none', cursor: 'pointer', fontSize: '12px' };
    const inputStyle = { width: '100%', padding: '10px 14px', border: `1px solid ${theme.border}`, background: theme.inputBg, color: theme.text, fontSize: '14px', outline: 'none' };
    const labelStyle = { display: 'block', marginBottom: '6px', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase' };
    const statCardStyle = { background: theme.bg, border: `1px solid ${theme.border}`, padding: '20px 24px', display: 'flex', alignItems: 'center', gap: '16px' };

    if (loading) {
        return (
            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', height: '400px', color: theme.textSecondary }}>
                <div style={{ textAlign: 'center' }}>
                    <div style={{ fontSize: '32px', marginBottom: '12px' }}>üöõ</div>
                    <div>Loading fleet accounts...</div>
                </div>
            </div>
        );
    }

    return (
        <div style={{ padding: '0', width: '100%' }}>
            {/* Toast Messages */}
            {successMessage && (
                <div style={{ position: 'fixed', top: '20px', right: '20px', zIndex: 1000, background: '#10b981', color: 'white', padding: '14px 24px', boxShadow: '0 4px 12px rgba(0,0,0,0.15)', fontWeight: '600' }}>
                    ‚úì {successMessage}
                </div>
            )}
            {error && (
                <div style={{ position: 'fixed', top: '20px', right: '20px', zIndex: 1000, background: '#ef4444', color: 'white', padding: '14px 24px', boxShadow: '0 4px 12px rgba(0,0,0,0.15)', cursor: 'pointer', fontWeight: '600' }} onClick={() => setError(null)}>
                    ‚úï {error}
                </div>
            )}

            {/* Stats Row */}
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(7, 1fr)', gap: '0', borderBottom: `1px solid ${theme.border}` }}>
                <div style={{ ...statCardStyle, borderRight: `1px solid ${theme.border}` }}>
                    <div style={{ fontSize: '24px' }}>üè¢</div>
                    <div>
                        <div style={{ fontSize: '24px', fontWeight: '800', color: theme.text }}>{stats.total}</div>
                        <div style={{ fontSize: '11px', color: theme.textSecondary, textTransform: 'uppercase', fontWeight: '600' }}>Total Accounts</div>
                    </div>
                </div>
                <div style={{ ...statCardStyle, borderRight: `1px solid ${theme.border}` }}>
                    <div style={{ fontSize: '24px' }}>‚úì</div>
                    <div>
                        <div style={{ fontSize: '24px', fontWeight: '800', color: '#10b981' }}>{stats.active}</div>
                        <div style={{ fontSize: '11px', color: theme.textSecondary, textTransform: 'uppercase', fontWeight: '600' }}>Active</div>
                    </div>
                </div>
                <div style={{ ...statCardStyle, borderRight: `1px solid ${theme.border}` }}>
                    <div style={{ fontSize: '24px' }}>üöó</div>
                    <div>
                        <div style={{ fontSize: '24px', fontWeight: '800', color: '#3b82f6' }}>{stats.totalVehicles}</div>
                        <div style={{ fontSize: '11px', color: theme.textSecondary, textTransform: 'uppercase', fontWeight: '600' }}>Vehicles</div>
                    </div>
                </div>
                <div style={{ ...statCardStyle, borderRight: `1px solid ${theme.border}` }}>
                    <div style={{ fontSize: '24px' }}>üí∞</div>
                    <div>
                        <div style={{ fontSize: '20px', fontWeight: '800', color: '#10b981' }}>{formatCurrency(stats.totalBalance)}</div>
                        <div style={{ fontSize: '11px', color: theme.textSecondary, textTransform: 'uppercase', fontWeight: '600' }}>Total Balance</div>
                    </div>
                </div>
                <div style={{ ...statCardStyle, borderRight: `1px solid ${theme.border}` }}>
                    <div style={{ fontSize: '24px' }}>üìä</div>
                    <div>
                        <div style={{ fontSize: '20px', fontWeight: '800', color: '#8b5cf6' }}>{formatCurrency(globalFleetStats.totalSpent || stats.totalSpent)}</div>
                        <div style={{ fontSize: '11px', color: theme.textSecondary, textTransform: 'uppercase', fontWeight: '600' }}>Total Spent</div>
                    </div>
                </div>
                <div style={{ ...statCardStyle, borderRight: `1px solid ${theme.border}` }}>
                    <div style={{ fontSize: '24px' }}>‚è≥</div>
                    <div>
                        <div style={{ fontSize: '20px', fontWeight: '800', color: globalFleetStats.awaitingPayment > 0 ? '#ef4444' : theme.textSecondary }}>{formatCurrency(globalFleetStats.awaitingPayment)}</div>
                        <div style={{ fontSize: '11px', color: theme.textSecondary, textTransform: 'uppercase', fontWeight: '600' }}>Awaiting Payment</div>
                    </div>
                </div>
                <div style={{ ...statCardStyle }}>
                    <div style={{ fontSize: '24px' }}>üßæ</div>
                    <div>
                        <div style={{ fontSize: '24px', fontWeight: '800', color: theme.text }}>{globalFleetStats.totalServices || stats.totalServices}</div>
                        <div style={{ fontSize: '11px', color: theme.textSecondary, textTransform: 'uppercase', fontWeight: '600' }}>Total Services</div>
                    </div>
                </div>
            </div>

            {/* Toolbar */}
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '16px 20px', background: theme.bgSecondary, borderBottom: `1px solid ${theme.border}` }}>
                <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
                    <input
                        type="text"
                        placeholder="Search accounts..."
                        value={searchQuery}
                        onChange={(e) => setSearchQuery(e.target.value)}
                        style={{ ...inputStyle, width: '280px' }}
                    />
                    <select value={statusFilter} onChange={(e) => setStatusFilter(e.target.value)} style={{ ...inputStyle, width: '140px' }}>
                        <option value="all">All Status</option>
                        <option value="active">Active</option>
                        <option value="suspended">Suspended</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
                {canCreate('fleet') && <button onClick={() => { resetAccountForm(); setShowAddModal(true); }} style={btnSuccess}>
                    + New Fleet Account
                </button>}
            </div>

            {/* Accounts Table */}
            <div style={{ overflowX: 'auto', background: theme.bg }}>
                <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                    <thead>
                        <tr style={{ background: theme.bgTertiary, borderBottom: `2px solid ${theme.border}` }}>
                            <th style={{ padding: '14px 20px', textAlign: 'left', fontSize: '11px', fontWeight: '700', color: theme.textSecondary, textTransform: 'uppercase' }}>Account #</th>
                            <th style={{ padding: '14px 20px', textAlign: 'left', fontSize: '11px', fontWeight: '700', color: theme.textSecondary, textTransform: 'uppercase' }}>Company</th>
                            <th style={{ padding: '14px 20px', textAlign: 'left', fontSize: '11px', fontWeight: '700', color: theme.textSecondary, textTransform: 'uppercase' }}>Contact</th>
                            <th style={{ padding: '14px 20px', textAlign: 'center', fontSize: '11px', fontWeight: '700', color: theme.textSecondary, textTransform: 'uppercase' }}>Vehicles</th>
                            <th style={{ padding: '14px 20px', textAlign: 'right', fontSize: '11px', fontWeight: '700', color: theme.textSecondary, textTransform: 'uppercase' }}>Balance</th>
                            <th style={{ padding: '14px 20px', textAlign: 'center', fontSize: '11px', fontWeight: '700', color: theme.textSecondary, textTransform: 'uppercase' }}>Discount</th>
                            <th style={{ padding: '14px 20px', textAlign: 'center', fontSize: '11px', fontWeight: '700', color: theme.textSecondary, textTransform: 'uppercase' }}>Status</th>
                            <th style={{ padding: '14px 20px', textAlign: 'center', fontSize: '11px', fontWeight: '700', color: theme.textSecondary, textTransform: 'uppercase' }}>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {filteredAccounts.length === 0 ? (
                            <tr>
                                <td colSpan="8" style={{ padding: '60px 20px', textAlign: 'center', color: theme.textSecondary }}>
                                    <div style={{ fontSize: '48px', marginBottom: '16px', opacity: 0.5 }}>üöõ</div>
                                    <div style={{ fontSize: '14px', fontWeight: '600' }}>No fleet accounts found</div>
                                    <div style={{ fontSize: '12px', marginTop: '4px' }}>Create your first fleet account to get started</div>
                                </td>
                            </tr>
                        ) : (
                            filteredAccounts.map((acc, idx) => (
                                <tr key={acc.id} style={{ borderBottom: `1px solid ${theme.border}`, background: idx % 2 === 0 ? theme.bg : theme.bgSecondary }}>
                                    <td style={{ padding: '16px 20px' }}>
                                        <span style={{ fontWeight: '700', color: '#3b82f6', cursor: 'pointer', fontFamily: 'monospace' }} onClick={() => openViewModal(acc)}>
                                            {acc.accountNumber}
                                        </span>
                                    </td>
                                    <td style={{ padding: '16px 20px' }}>
                                        <div style={{ fontWeight: '600', color: theme.text }}>{acc.companyName}</div>
                                        <div style={{ fontSize: '11px', color: theme.textSecondary }}>{acc.email}</div>
                                    </td>
                                    <td style={{ padding: '16px 20px' }}>
                                        <div style={{ color: theme.text }}>{acc.contactPerson || '-'}</div>
                                        <div style={{ fontSize: '11px', color: theme.textSecondary }}>{acc.phone}</div>
                                    </td>
                                    <td style={{ padding: '16px 20px', textAlign: 'center' }}>
                                        <span style={{ background: theme.bgTertiary, padding: '4px 12px', fontWeight: '700', fontSize: '13px', color: theme.text }}>
                                            {acc.vehicles?.length || 0}
                                        </span>
                                    </td>
                                    <td style={{ padding: '16px 20px', textAlign: 'right' }}>
                                        <div style={{ fontWeight: '700', color: acc.balance >= 0 ? '#10b981' : '#ef4444', fontSize: '15px' }}>
                                            {formatCurrency(acc.balance)}
                                        </div>
                                        {acc.creditLimit > 0 && (
                                            <div style={{ fontSize: '10px', color: theme.textSecondary }}>Credit: {formatCurrency(acc.creditLimit)}</div>
                                        )}
                                    </td>
                                    <td style={{ padding: '16px 20px', textAlign: 'center' }}>
                                        {acc.discount > 0 ? (
                                            <span style={{ background: '#dbeafe', color: '#1d4ed8', padding: '4px 10px', fontWeight: '700', fontSize: '12px' }}>
                                                {acc.discount}% OFF
                                            </span>
                                        ) : '-'}
                                    </td>
                                    <td style={{ padding: '16px 20px', textAlign: 'center' }}>
                                        <span style={{
                                            padding: '4px 12px',
                                            fontSize: '11px',
                                            fontWeight: '700',
                                            textTransform: 'uppercase',
                                            background: acc.status === 'active' ? '#dcfce7' : acc.status === 'suspended' ? '#fef3c7' : '#fee2e2',
                                            color: acc.status === 'active' ? '#166534' : acc.status === 'suspended' ? '#92400e' : '#dc2626'
                                        }}>
                                            {acc.status}
                                        </span>
                                    </td>
                                    <td style={{ padding: '16px 20px', textAlign: 'center' }}>
                                        <div style={{ display: 'flex', gap: '4px', justifyContent: 'center', flexWrap: 'wrap' }}>
                                            <button onClick={() => openViewModal(acc)} style={{ padding: '8px 12px', background: 'none', border: `1px solid ${theme.border}`, cursor: 'pointer', fontSize: '12px', color: theme.text }} title="View">View</button>
                                            <button onClick={() => openWashHistoryModal(acc)} style={{ padding: '8px 12px', background: '#8b5cf6', border: 'none', cursor: 'pointer', fontSize: '12px', color: 'white', fontWeight: '600' }} title="Wash History">History</button>
                                            {canEdit('fleet') && <button onClick={() => openEditModal(acc)} style={{ padding: '8px 12px', background: 'none', border: `1px solid ${theme.border}`, cursor: 'pointer', fontSize: '12px', color: theme.text }} title="Edit">Edit</button>}
                                            {canEdit('fleet') && <button onClick={() => { setSelectedAccount(acc); setShowTopUpModal(true); }} style={{ padding: '8px 12px', background: '#10b981', border: 'none', cursor: 'pointer', fontSize: '12px', color: 'white', fontWeight: '600' }} title="Top Up">Top Up</button>}
                                            {canDelete('fleet') && <button onClick={() => handleDeleteAccount(acc)} style={{ padding: '8px 12px', background: 'none', border: `1px solid #ef4444`, cursor: 'pointer', fontSize: '12px', color: '#ef4444' }} title="Delete">Delete</button>}
                                        </div>
                                    </td>
                                </tr>
                            ))
                        )}
                    </tbody>
                </table>
            </div>

            {/* Add/Edit Account Modal */}
            {(showAddModal || showEditModal) && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 }} onClick={() => { setShowAddModal(false); setShowEditModal(false); }}>
                    <div style={{ background: theme.bg, width: '600px', maxWidth: '95vw', maxHeight: '90vh', overflow: 'auto', border: `1px solid ${theme.border}` }} onClick={(e) => e.stopPropagation()}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '20px', borderBottom: `1px solid ${theme.border}` }}>
                            <h3 style={{ margin: 0, color: theme.text, fontWeight: '700' }}>{showAddModal ? 'New Fleet Account' : 'Edit Fleet Account'}</h3>
                            <button onClick={() => { setShowAddModal(false); setShowEditModal(false); }} style={{ background: 'none', border: 'none', fontSize: '20px', cursor: 'pointer', color: theme.textSecondary }}>‚úï</button>
                        </div>
                        <div style={{ padding: '20px' }}>
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px' }}>
                                <div style={{ gridColumn: '1 / -1' }}>
                                    <label style={labelStyle}>Company Name *</label>
                                    <input type="text" value={accountForm.companyName} onChange={(e) => setAccountForm({ ...accountForm, companyName: e.target.value })} style={inputStyle} placeholder="e.g. ABC Logistics Ltd" />
                                </div>
                                <div>
                                    <label style={labelStyle}>Contact Person</label>
                                    <input type="text" value={accountForm.contactPerson} onChange={(e) => setAccountForm({ ...accountForm, contactPerson: e.target.value })} style={inputStyle} placeholder="Primary contact name" />
                                </div>
                                <div>
                                    <label style={labelStyle}>Phone *</label>
                                    <input type="text" value={accountForm.phone} onChange={(e) => setAccountForm({ ...accountForm, phone: e.target.value })} style={inputStyle} placeholder="0712345678" />
                                </div>
                                <div>
                                    <label style={labelStyle}>Email</label>
                                    <input type="email" value={accountForm.email} onChange={(e) => setAccountForm({ ...accountForm, email: e.target.value })} style={inputStyle} placeholder="accounts@company.com" />
                                </div>
                                <div>
                                    <label style={labelStyle}>Payment Terms</label>
                                    <select value={accountForm.paymentTerms} onChange={(e) => setAccountForm({ ...accountForm, paymentTerms: e.target.value })} style={inputStyle}>
                                        <option value="prepaid">Prepaid (Balance)</option>
                                        <option value="postpaid">Postpaid (Invoice)</option>
                                        <option value="credit">Credit Line</option>
                                    </select>
                                </div>
                                <div style={{ gridColumn: '1 / -1' }}>
                                    <label style={labelStyle}>Address</label>
                                    <input type="text" value={accountForm.address} onChange={(e) => setAccountForm({ ...accountForm, address: e.target.value })} style={inputStyle} placeholder="Business address" />
                                </div>
                                <div>
                                    <label style={labelStyle}>Credit Limit ({getBrandingForReceipts().currencySymbol || 'KES'})</label>
                                    <input type="number" value={accountForm.creditLimit} onChange={(e) => setAccountForm({ ...accountForm, creditLimit: Number(e.target.value) })} style={inputStyle} placeholder="0" />
                                </div>
                                <div>
                                    <label style={labelStyle}>Discount %</label>
                                    <input type="number" min="0" max="100" value={accountForm.discount} onChange={(e) => setAccountForm({ ...accountForm, discount: Number(e.target.value) })} style={inputStyle} placeholder="0" />
                                </div>
                                {showAddModal && (
                                    <div>
                                        <label style={labelStyle}>Initial Balance ({getBrandingForReceipts().currencySymbol || 'KES'})</label>
                                        <input type="number" value={accountForm.balance} onChange={(e) => setAccountForm({ ...accountForm, balance: Number(e.target.value) })} style={inputStyle} placeholder="0" />
                                    </div>
                                )}
                                <div style={{ gridColumn: '1 / -1' }}>
                                    <label style={labelStyle}>Notes</label>
                                    <textarea value={accountForm.notes} onChange={(e) => setAccountForm({ ...accountForm, notes: e.target.value })} style={{ ...inputStyle, minHeight: '80px', resize: 'vertical' }} placeholder="Special instructions or notes..." />
                                </div>
                            </div>
                        </div>
                        <div style={{ display: 'flex', gap: '8px', justifyContent: 'flex-end', padding: '20px', borderTop: `1px solid ${theme.border}` }}>
                            <button onClick={() => { setShowAddModal(false); setShowEditModal(false); }} style={{ padding: '10px 20px', background: 'none', border: `1px solid ${theme.border}`, cursor: 'pointer', fontSize: '13px', color: theme.text, fontWeight: '600' }}>Cancel</button>
                            <button onClick={showAddModal ? handleAddAccount : handleEditAccount} disabled={actionLoading} style={{ padding: '10px 20px', background: '#10b981', border: 'none', cursor: 'pointer', fontSize: '13px', color: 'white', fontWeight: '600' }}>
                                {actionLoading ? 'Saving...' : (showAddModal ? 'Create Account' : 'Save Changes')}
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* View Account Modal (Detail View) */}
            {showViewModal && selectedAccount && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 }} onClick={() => setShowViewModal(false)}>
                    <div style={{ background: theme.bg, width: '900px', maxWidth: '95vw', maxHeight: '90vh', overflow: 'auto', border: `1px solid ${theme.border}` }} onClick={(e) => e.stopPropagation()}>
                        {/* Header */}
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '20px', borderBottom: `1px solid ${theme.border}`, background: theme.bgSecondary }}>
                            <div>
                                <h3 style={{ margin: 0, color: theme.text, fontWeight: '700' }}>{selectedAccount.companyName}</h3>
                                <div style={{ fontSize: '13px', color: theme.textSecondary, marginTop: '4px', fontFamily: 'monospace' }}>{selectedAccount.accountNumber}</div>
                            </div>
                            <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
                                <span style={{
                                    padding: '6px 14px',
                                    fontSize: '12px',
                                    fontWeight: '700',
                                    textTransform: 'uppercase',
                                    background: selectedAccount.status === 'active' ? '#dcfce7' : '#fef3c7',
                                    color: selectedAccount.status === 'active' ? '#166534' : '#92400e'
                                }}>
                                    {selectedAccount.status}
                                </span>
                                <button onClick={() => setShowViewModal(false)} style={{ background: 'none', border: 'none', fontSize: '20px', cursor: 'pointer', color: theme.textSecondary }}>‚úï</button>
                            </div>
                        </div>

                        {/* Account Summary Cards */}
                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(5, 1fr)', gap: '0', borderBottom: `1px solid ${theme.border}` }}>
                            <div style={{ padding: '16px 20px', borderRight: `1px solid ${theme.border}` }}>
                                <div style={{ fontSize: '11px', color: theme.textSecondary, textTransform: 'uppercase', fontWeight: '600' }}>Balance</div>
                                <div style={{ fontSize: '22px', fontWeight: '800', color: selectedAccount.balance >= 0 ? '#10b981' : '#ef4444' }}>{formatCurrency(selectedAccount.balance)}</div>
                            </div>
                            <div style={{ padding: '16px 20px', borderRight: `1px solid ${theme.border}` }}>
                                <div style={{ fontSize: '11px', color: theme.textSecondary, textTransform: 'uppercase', fontWeight: '600' }}>Awaiting Payment</div>
                                <div style={{ fontSize: '22px', fontWeight: '800', color: realtimeFleetStats.awaitingPayment > 0 ? '#ef4444' : theme.textSecondary }}>
                                    {loadingExpenditures ? '...' : formatCurrency(realtimeFleetStats.awaitingPayment || 0)}
                                </div>
                            </div>
                            <div style={{ padding: '16px 20px', borderRight: `1px solid ${theme.border}` }}>
                                <div style={{ fontSize: '11px', color: theme.textSecondary, textTransform: 'uppercase', fontWeight: '600' }}>Credit Limit</div>
                                <div style={{ fontSize: '22px', fontWeight: '800', color: theme.text }}>{formatCurrency(selectedAccount.creditLimit)}</div>
                            </div>
                            <div style={{ padding: '16px 20px', borderRight: `1px solid ${theme.border}` }}>
                                <div style={{ fontSize: '11px', color: theme.textSecondary, textTransform: 'uppercase', fontWeight: '600' }}>Total Spent</div>
                                <div style={{ fontSize: '22px', fontWeight: '800', color: '#8b5cf6' }}>{formatCurrency(realtimeFleetStats.totalSpent || selectedAccount.totalSpent || 0)}</div>
                            </div>
                            <div style={{ padding: '16px 20px' }}>
                                <div style={{ fontSize: '11px', color: theme.textSecondary, textTransform: 'uppercase', fontWeight: '600' }}>Discount</div>
                                <div style={{ fontSize: '22px', fontWeight: '800', color: '#3b82f6' }}>{selectedAccount.discount || 0}%</div>
                            </div>
                        </div>

                        {/* Contact Info */}
                        <div style={{ padding: '16px 20px', borderBottom: `1px solid ${theme.border}`, display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '20px' }}>
                            <div>
                                <div style={{ fontSize: '11px', color: theme.textSecondary, textTransform: 'uppercase', fontWeight: '600', marginBottom: '4px' }}>Contact Person</div>
                                <div style={{ color: theme.text, fontWeight: '500' }}>{selectedAccount.contactPerson || '-'}</div>
                            </div>
                            <div>
                                <div style={{ fontSize: '11px', color: theme.textSecondary, textTransform: 'uppercase', fontWeight: '600', marginBottom: '4px' }}>Phone</div>
                                <div style={{ color: theme.text, fontWeight: '500' }}>{selectedAccount.phone}</div>
                            </div>
                            <div>
                                <div style={{ fontSize: '11px', color: theme.textSecondary, textTransform: 'uppercase', fontWeight: '600', marginBottom: '4px' }}>Email</div>
                                <div style={{ color: theme.text, fontWeight: '500' }}>{selectedAccount.email || '-'}</div>
                            </div>
                        </div>

                        {/* Vehicles Section */}
                        <div style={{ padding: '20px' }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
                                <h4 style={{ margin: 0, color: theme.text, fontWeight: '700' }}>Fleet Vehicles ({selectedAccount.vehicles?.length || 0})</h4>
                                <button onClick={() => setShowVehicleModal(true)} style={{ padding: '8px 16px', background: '#3b82f6', border: 'none', cursor: 'pointer', fontSize: '12px', color: 'white', fontWeight: '600' }}>+ Add Vehicle</button>
                            </div>
                            
                            {/* Total Unpaid Expenditure Summary - REALTIME */}
                            {realtimeFleetStats.awaitingPayment > 0 && (
                                <div style={{ 
                                    marginBottom: '12px', 
                                    padding: '12px 16px', 
                                    background: 'rgba(239, 68, 68, 0.1)', 
                                    border: '1px solid rgba(239, 68, 68, 0.3)',
                                    display: 'flex',
                                    justifyContent: 'space-between',
                                    alignItems: 'center'
                                }}>
                                    <div>
                                        <div style={{ fontSize: '11px', color: '#ef4444', textTransform: 'uppercase', fontWeight: '600' }}>Total Awaiting Payment ({realtimeFleetStats.unpaidWashes} wash{realtimeFleetStats.unpaidWashes !== 1 ? 'es' : ''})</div>
                                        <div style={{ fontSize: '18px', fontWeight: '800', color: '#ef4444' }}>{formatCurrency(realtimeFleetStats.awaitingPayment)}</div>
                                    </div>
                                    {loadingExpenditures && <span style={{ fontSize: '12px', color: theme.textSecondary }}>Loading...</span>}
                                </div>
                            )}
                            
                            {selectedAccount.vehicles?.length > 0 ? (
                                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(280px, 1fr))', gap: '12px' }}>
                                    {selectedAccount.vehicles.map(v => {
                                        const plateKey = v.plateNumber.toUpperCase().replace(/\s+/g, ' ').trim();
                                        const vehicleExp = realtimeFleetStats.awaitingByVehicle?.[plateKey] || { total: 0, count: 0 };
                                        const monthlySpend = realtimeFleetStats.monthlySpendByVehicle?.[plateKey] || { total: 0, count: 0 };
                                        return (
                                            <div key={v.id} style={{ background: theme.bgSecondary, border: `1px solid ${theme.border}`, padding: '14px' }}>
                                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                                                    <div>
                                                        <div style={{ fontWeight: '700', color: theme.text, fontSize: '15px', fontFamily: 'monospace' }}>{v.plateNumber}</div>
                                                        <div style={{ fontSize: '12px', color: theme.textSecondary }}>{v.make} {v.model} ‚Ä¢ {v.color}</div>
                                                        {v.driverName && <div style={{ fontSize: '11px', color: theme.textSecondary, marginTop: '4px' }}>Driver: {v.driverName}</div>}
                                                    </div>
                                                    <div style={{ display: 'flex', gap: '4px' }}>
                                                        <button onClick={() => handleSendToQueue(v)} style={{ padding: '4px 8px', background: '#10b981', border: 'none', cursor: 'pointer', color: 'white', fontSize: '11px', fontWeight: '600' }}>Send to Queue</button>
                                                        <button onClick={() => handleRemoveVehicle(v.id)} style={{ padding: '4px 8px', background: 'none', border: `1px solid ${theme.border}`, cursor: 'pointer', color: theme.textSecondary, fontSize: '11px' }}>Remove</button>
                                                    </div>
                                                </div>
                                                <div style={{ display: 'flex', gap: '12px', marginTop: '10px', fontSize: '11px', flexWrap: 'wrap' }}>
                                                    <span style={{ color: theme.textSecondary }}>This Month: <strong style={{ color: '#10b981' }}>{formatCurrency(monthlySpend.total)}</strong> ({monthlySpend.count} wash{monthlySpend.count !== 1 ? 'es' : ''})</span>
                                                </div>
                                                {/* Awaiting Payment Section - REALTIME */}
                                                {vehicleExp.total > 0 && (
                                                    <div style={{ 
                                                        marginTop: '10px', 
                                                        padding: '8px 10px', 
                                                        background: 'rgba(239, 68, 68, 0.1)', 
                                                        border: '1px dashed rgba(239, 68, 68, 0.4)',
                                                        display: 'flex',
                                                        justifyContent: 'space-between',
                                                        alignItems: 'center'
                                                    }}>
                                                        <span style={{ fontSize: '11px', color: '#ef4444', fontWeight: '600' }}>
                                                            üí∞ Awaiting Payment ({vehicleExp.count} wash{vehicleExp.count > 1 ? 'es' : ''})
                                                        </span>
                                                        <span style={{ fontSize: '13px', fontWeight: '700', color: '#ef4444' }}>{formatCurrency(vehicleExp.total)}</span>
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>
                            ) : (
                                <div style={{ padding: '30px', textAlign: 'center', color: theme.textSecondary, background: theme.bgSecondary }}>
                                    No vehicles registered. Add vehicles to this fleet account.
                                </div>
                            )}
                        </div>

                        {/* Authorized Contacts Section */}
                        <div style={{ padding: '20px', borderTop: `1px solid ${theme.border}` }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
                                <h4 style={{ margin: 0, color: theme.text, fontWeight: '700' }}>Authorized Contacts ({selectedAccount.authorizedContacts?.length || 0})</h4>
                                <button onClick={() => setShowContactModal(true)} style={{ padding: '8px 16px', background: '#3b82f6', border: 'none', cursor: 'pointer', fontSize: '12px', color: 'white', fontWeight: '600' }}>+ Add Contact</button>
                            </div>
                            {selectedAccount.authorizedContacts?.length > 0 ? (
                                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(220px, 1fr))', gap: '12px' }}>
                                    {selectedAccount.authorizedContacts.map(c => (
                                        <div key={c.id} style={{ background: theme.bgSecondary, border: `1px solid ${theme.border}`, padding: '12px', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                            <div>
                                                <div style={{ fontWeight: '600', color: theme.text }}>{c.name}</div>
                                                <div style={{ fontSize: '12px', color: theme.textSecondary }}>{c.phone} ‚Ä¢ {c.role}</div>
                                            </div>
                                            <button onClick={() => handleRemoveContact(c.id)} style={{ padding: '4px 8px', background: 'none', border: `1px solid ${theme.border}`, cursor: 'pointer', color: theme.textSecondary, fontSize: '11px' }}>Remove</button>
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <div style={{ padding: '20px', textAlign: 'center', color: theme.textSecondary, background: theme.bgSecondary }}>
                                    No authorized contacts. Add people who can bring vehicles for service.
                                </div>
                            )}
                        </div>

                        {/* Expenditures Section */}
                        <div style={{ padding: '20px', borderTop: `1px solid ${theme.border}` }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
                                <h4 style={{ margin: 0, color: theme.text, fontWeight: '700' }}>Fleet Expenditures ({selectedAccount.expenditures?.length || 0})</h4>
                                <button onClick={() => { resetExpenditureForm(); setEditingExpenditure(null); setShowExpenditureModal(true); }} style={{ padding: '8px 16px', background: '#8b5cf6', border: 'none', cursor: 'pointer', fontSize: '12px', color: 'white', fontWeight: '600' }}>+ Add Expenditure</button>
                            </div>
                            <div style={{ display: 'flex', gap: '16px', marginBottom: '12px' }}>
                                <div style={{ background: theme.bgSecondary, padding: '12px 16px', border: `1px solid ${theme.border}`, flex: 1 }}>
                                    <div style={{ fontSize: '10px', color: theme.textSecondary, textTransform: 'uppercase', fontWeight: '600' }}>Total Expenditures</div>
                                    <div style={{ fontSize: '20px', fontWeight: '800', color: '#ef4444' }}>{formatCurrency(selectedAccount.totalExpenditures)}</div>
                                </div>
                                <div style={{ background: theme.bgSecondary, padding: '12px 16px', border: `1px solid ${theme.border}`, flex: 1 }}>
                                    <div style={{ fontSize: '10px', color: theme.textSecondary, textTransform: 'uppercase', fontWeight: '600' }}>Net Position (Spent - Exp)</div>
                                    <div style={{ fontSize: '20px', fontWeight: '800', color: '#8b5cf6' }}>{formatCurrency((selectedAccount.totalSpent || 0) - (selectedAccount.totalExpenditures || 0))}</div>
                                </div>
                            </div>
                            {selectedAccount.expenditures?.length > 0 ? (
                                <div style={{ maxHeight: '200px', overflow: 'auto' }}>
                                    {selectedAccount.expenditures.slice(0, 15).map(exp => (
                                        <div key={exp.id} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '10px 12px', borderBottom: `1px solid ${theme.border}`, background: theme.bgSecondary, marginBottom: '4px' }}>
                                            <div style={{ flex: 1 }}>
                                                <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
                                                    <span style={{ fontSize: '13px', fontWeight: '600', color: theme.text }}>{exp.description}</span>
                                                    <span style={{ fontSize: '10px', padding: '2px 6px', background: theme.bgTertiary, color: theme.textSecondary }}>{exp.category}</span>
                                                </div>
                                                <div style={{ fontSize: '11px', color: theme.textSecondary, marginTop: '2px' }}>
                                                    {new Date(exp.date).toLocaleDateString()} {exp.vehicle && `‚Ä¢ ${exp.vehicle}`}
                                                </div>
                                            </div>
                                            <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                                                <span style={{ fontWeight: '700', color: '#ef4444' }}>{formatCurrency(exp.amount)}</span>
                                                <div style={{ display: 'flex', gap: '4px' }}>
                                                    <button onClick={() => openEditExpenditure(exp)} style={{ padding: '4px 8px', background: 'none', border: `1px solid ${theme.border}`, cursor: 'pointer', fontSize: '10px', color: theme.text }}>Edit</button>
                                                    <button onClick={() => handleDeleteExpenditure(exp.id)} style={{ padding: '4px 8px', background: 'none', border: `1px solid #ef4444`, cursor: 'pointer', fontSize: '10px', color: '#ef4444' }}>Delete</button>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <div style={{ padding: '20px', textAlign: 'center', color: theme.textSecondary, background: theme.bgSecondary }}>
                                    No expenditures recorded. Track fuel, maintenance, and other fleet costs here.
                                </div>
                            )}
                        </div>

                        {/* Recent Transactions */}
                        <div style={{ padding: '20px', borderTop: `1px solid ${theme.border}` }}>
                            <h4 style={{ margin: '0 0 12px 0', color: theme.text, fontWeight: '700' }}>üìú Recent Transactions</h4>
                            {selectedAccount.transactions?.length > 0 ? (
                                <div style={{ maxHeight: '200px', overflow: 'auto' }}>
                                    {selectedAccount.transactions.slice(0, 10).map(txn => (
                                        <div key={txn.id} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '10px 0', borderBottom: `1px solid ${theme.border}` }}>
                                            <div>
                                                <div style={{ fontSize: '12px', color: theme.textSecondary }}>{new Date(txn.date).toLocaleString()}</div>
                                                <div style={{ fontSize: '13px', color: theme.text }}>{txn.note || txn.serviceDetails?.service || (txn.type === 'credit' ? 'Top-up' : 'Service Charge')}</div>
                                            </div>
                                            <div style={{ fontWeight: '700', color: txn.type === 'credit' ? '#10b981' : '#ef4444' }}>
                                                {txn.type === 'credit' ? '+' : '-'}{formatCurrency(txn.amount)}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <div style={{ padding: '20px', textAlign: 'center', color: theme.textSecondary, background: theme.bgSecondary }}>
                                    No transactions yet.
                                </div>
                            )}
                        </div>

                        {/* Footer Actions */}
                        <div style={{ display: 'flex', gap: '8px', justifyContent: 'space-between', padding: '20px', borderTop: `1px solid ${theme.border}`, background: theme.bgSecondary }}>
                            <div style={{ display: 'flex', gap: '8px' }}>
                                <button onClick={() => setShowReceiptModal(true)} style={{ padding: '10px 20px', background: '#1e293b', border: 'none', cursor: 'pointer', fontSize: '13px', color: 'white', fontWeight: '600' }}>Print Statement</button>
                            </div>
                            <div style={{ display: 'flex', gap: '8px' }}>
                                <button onClick={() => setShowViewModal(false)} style={{ padding: '10px 20px', background: 'none', border: `1px solid ${theme.border}`, cursor: 'pointer', fontSize: '13px', color: theme.text, fontWeight: '600' }}>Close</button>
                                <button onClick={() => { setShowViewModal(false); openEditModal(selectedAccount); }} style={{ padding: '10px 20px', background: 'none', border: `1px solid #3b82f6`, cursor: 'pointer', fontSize: '13px', color: '#3b82f6', fontWeight: '600' }}>Edit Account</button>
                                <button onClick={() => { setShowTopUpModal(true); }} style={{ padding: '10px 20px', background: '#10b981', border: 'none', cursor: 'pointer', fontSize: '13px', color: 'white', fontWeight: '600' }}>Top Up Balance</button>
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* Print Invoice Modal */}
            {showReceiptModal && selectedAccount && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1002 }} onClick={() => setShowReceiptModal(false)}>
                    <div style={{ background: theme.bg, width: '420px', maxWidth: '95vw', border: `1px solid ${theme.border}` }} onClick={(e) => e.stopPropagation()}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '16px 20px', borderBottom: `1px solid ${theme.border}`, background: theme.bgSecondary }}>
                            <div>
                                <h4 style={{ margin: 0, color: theme.text, fontWeight: '700' }}>üßæ Generate Invoice</h4>
                                <div style={{ fontSize: '11px', color: theme.textSecondary, marginTop: '2px' }}>Fleet wash services invoice</div>
                            </div>
                            <button onClick={() => setShowReceiptModal(false)} style={{ background: 'none', border: 'none', fontSize: '18px', cursor: 'pointer', color: theme.textSecondary }}>‚úï</button>
                        </div>
                        <div style={{ padding: '20px' }}>
                            <div style={{ marginBottom: '16px', padding: '16px', background: theme.bgSecondary, border: `1px solid ${theme.border}` }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                                    <div>
                                        <div style={{ fontWeight: '700', color: theme.text, fontSize: '15px' }}>{selectedAccount.companyName}</div>
                                        <div style={{ fontSize: '12px', color: theme.textSecondary, fontFamily: 'monospace', marginTop: '4px' }}>{selectedAccount.accountNumber}</div>
                                    </div>
                                    <div style={{ textAlign: 'right' }}>
                                        <span style={{ 
                                            padding: '4px 10px', 
                                            fontSize: '10px', 
                                            fontWeight: '600',
                                            background: selectedAccount.paymentTerms === 'postpaid' ? '#dbeafe' : '#f3e8ff',
                                            color: selectedAccount.paymentTerms === 'postpaid' ? '#1e40af' : '#7c3aed',
                                            textTransform: 'uppercase'
                                        }}>
                                            {selectedAccount.paymentTerms || 'Prepaid'}
                                        </span>
                                    </div>
                                </div>
                                {washHistory.length > 0 && (
                                    <div style={{ display: 'flex', gap: '16px', marginTop: '12px', paddingTop: '12px', borderTop: `1px solid ${theme.border}` }}>
                                        <div>
                                            <div style={{ fontSize: '10px', color: theme.textSecondary, textTransform: 'uppercase' }}>Total Washes</div>
                                            <div style={{ fontSize: '16px', fontWeight: '700', color: theme.text }}>{washHistory.length}</div>
                                        </div>
                                        <div>
                                            <div style={{ fontSize: '10px', color: theme.textSecondary, textTransform: 'uppercase' }}>Paid</div>
                                            <div style={{ fontSize: '16px', fontWeight: '700', color: '#10b981' }}>
                                                {formatCurrency(washHistory.filter(w => w.paymentStatus === 'paid').reduce((s, w) => s + (w.price || 0), 0))}
                                            </div>
                                        </div>
                                        <div>
                                            <div style={{ fontSize: '10px', color: theme.textSecondary, textTransform: 'uppercase' }}>Unpaid</div>
                                            <div style={{ fontSize: '16px', fontWeight: '700', color: '#ef4444' }}>
                                                {formatCurrency(washHistory.filter(w => w.paymentStatus !== 'paid').reduce((s, w) => s + (w.price || 0), 0))}
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                            <div style={{ fontSize: '13px', color: theme.text, marginBottom: '12px', fontWeight: '600' }}>Select invoice period:</div>
                            <div style={{ display: 'grid', gap: '10px' }}>
                                <button onClick={() => { printReceipt(selectedAccount, 'week'); setShowReceiptModal(false); }} style={{ padding: '14px 20px', background: theme.bgSecondary, border: `1px solid ${theme.border}`, cursor: 'pointer', fontSize: '14px', color: theme.text, fontWeight: '600', textAlign: 'left', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                    <span>üìÖ Last 7 Days</span>
                                    <span style={{ fontSize: '11px', color: theme.textSecondary }}>Weekly invoice</span>
                                </button>
                                <button onClick={() => { printReceipt(selectedAccount, 'month'); setShowReceiptModal(false); }} style={{ padding: '14px 20px', background: theme.bgSecondary, border: `1px solid ${theme.border}`, cursor: 'pointer', fontSize: '14px', color: theme.text, fontWeight: '600', textAlign: 'left', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                    <span>üìÜ This Month</span>
                                    <span style={{ fontSize: '11px', color: theme.textSecondary }}>Monthly invoice</span>
                                </button>
                                <button onClick={() => { printReceipt(selectedAccount, 'all'); setShowReceiptModal(false); }} style={{ padding: '14px 20px', background: '#0f172a', border: 'none', cursor: 'pointer', fontSize: '14px', color: 'white', fontWeight: '600', textAlign: 'left', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                    <span>üìã Full Statement</span>
                                    <span style={{ fontSize: '11px', color: '#94a3b8' }}>All time</span>
                                </button>
                            </div>
                        </div>
                        <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end', padding: '16px 20px', borderTop: `1px solid ${theme.border}`, background: theme.bgSecondary }}>
                            <button onClick={() => setShowReceiptModal(false)} style={{ padding: '10px 20px', background: 'none', border: `1px solid ${theme.border}`, color: theme.text, fontWeight: '600', cursor: 'pointer' }}>Cancel</button>
                        </div>
                    </div>
                </div>
            )}

            {/* Expenditure Modal */}
            {showExpenditureModal && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1002 }} onClick={() => { setShowExpenditureModal(false); setEditingExpenditure(null); }}>
                    <div style={{ background: theme.bg, width: '450px', maxWidth: '95vw', border: `1px solid ${theme.border}` }} onClick={(e) => e.stopPropagation()}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '16px 20px', borderBottom: `1px solid ${theme.border}` }}>
                            <h4 style={{ margin: 0, color: theme.text }}>{editingExpenditure ? 'Edit Expenditure' : 'Add Expenditure'}</h4>
                            <button onClick={() => { setShowExpenditureModal(false); setEditingExpenditure(null); }} style={{ background: 'none', border: 'none', fontSize: '18px', cursor: 'pointer', color: theme.textSecondary }}>‚úï</button>
                        </div>
                        <div style={{ padding: '20px', display: 'grid', gap: '12px' }}>
                            <div>
                                <label style={labelStyle}>Description *</label>
                                <input type="text" value={expenditureForm.description} onChange={(e) => setExpenditureForm({ ...expenditureForm, description: e.target.value })} style={inputStyle} placeholder="e.g. Fuel refill, Tire change" />
                            </div>
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' }}>
                                <div>
                                    <label style={labelStyle}>Category</label>
                                    <select value={expenditureForm.category} onChange={(e) => setExpenditureForm({ ...expenditureForm, category: e.target.value })} style={inputStyle}>
                                        <option value="Fuel">Fuel</option>
                                        <option value="Maintenance">Maintenance</option>
                                        <option value="Repairs">Repairs</option>
                                        <option value="Tires">Tires</option>
                                        <option value="Insurance">Insurance</option>
                                        <option value="Parking">Parking</option>
                                        <option value="Toll">Toll</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div>
                                    <label style={labelStyle}>Amount ({getBrandingForReceipts().currencySymbol || 'KES'}) *</label>
                                    <input type="number" value={expenditureForm.amount} onChange={(e) => setExpenditureForm({ ...expenditureForm, amount: e.target.value })} style={inputStyle} placeholder="0" />
                                </div>
                            </div>
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' }}>
                                <div>
                                    <label style={labelStyle}>Date</label>
                                    <input type="date" value={expenditureForm.date} onChange={(e) => setExpenditureForm({ ...expenditureForm, date: e.target.value })} style={inputStyle} />
                                </div>
                                <div>
                                    <label style={labelStyle}>Vehicle (Optional)</label>
                                    <select value={expenditureForm.vehicle} onChange={(e) => setExpenditureForm({ ...expenditureForm, vehicle: e.target.value })} style={inputStyle}>
                                        <option value="">-- Select Vehicle --</option>
                                        {selectedAccount?.vehicles?.map(v => (
                                            <option key={v.id} value={v.plateNumber}>{v.plateNumber}</option>
                                        ))}
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label style={labelStyle}>Note</label>
                                <input type="text" value={expenditureForm.note} onChange={(e) => setExpenditureForm({ ...expenditureForm, note: e.target.value })} style={inputStyle} placeholder="Additional details..." />
                            </div>
                        </div>
                        <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end', padding: '16px 20px', borderTop: `1px solid ${theme.border}` }}>
                            <button onClick={() => { setShowExpenditureModal(false); setEditingExpenditure(null); }} style={{ padding: '10px 20px', background: 'none', border: `1px solid ${theme.border}`, color: theme.text, fontWeight: '600', cursor: 'pointer' }}>Cancel</button>
                            <button onClick={editingExpenditure ? handleUpdateExpenditure : handleAddExpenditure} disabled={actionLoading} style={{ padding: '10px 20px', background: '#8b5cf6', border: 'none', color: 'white', fontWeight: '600', cursor: 'pointer', opacity: actionLoading ? 0.7 : 1 }}>{actionLoading ? 'Saving...' : (editingExpenditure ? 'Update' : 'Add Expenditure')}</button>
                        </div>
                    </div>
                </div>
            )}

            {/* Add Vehicle Modal */}
            {showVehicleModal && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1001 }} onClick={() => setShowVehicleModal(false)}>
                    <div style={{ background: theme.bg, width: '450px', maxWidth: '95vw', border: `1px solid ${theme.border}` }} onClick={(e) => e.stopPropagation()}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '16px 20px', borderBottom: `1px solid ${theme.border}` }}>
                            <h4 style={{ margin: 0, color: theme.text }}>Add Vehicle</h4>
                            <button onClick={() => setShowVehicleModal(false)} style={{ background: 'none', border: 'none', fontSize: '18px', cursor: 'pointer', color: theme.textSecondary }}>‚úï</button>
                        </div>
                        <div style={{ padding: '20px', display: 'grid', gap: '12px' }}>
                            <div>
                                <label style={labelStyle}>Plate Number *</label>
                                <input type="text" value={vehicleForm.plateNumber} onChange={(e) => setVehicleForm({ ...vehicleForm, plateNumber: e.target.value.toUpperCase() })} style={inputStyle} placeholder="KAA 123X" />
                            </div>
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' }}>
                                <div>
                                    <label style={labelStyle}>Make</label>
                                    <input type="text" value={vehicleForm.make} onChange={(e) => setVehicleForm({ ...vehicleForm, make: e.target.value })} style={inputStyle} placeholder="Toyota" />
                                </div>
                                <div>
                                    <label style={labelStyle}>Model</label>
                                    <input type="text" value={vehicleForm.model} onChange={(e) => setVehicleForm({ ...vehicleForm, model: e.target.value })} style={inputStyle} placeholder="Hiace" />
                                </div>
                            </div>
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' }}>
                                <div>
                                    <label style={labelStyle}>Color</label>
                                    <input type="text" value={vehicleForm.color} onChange={(e) => setVehicleForm({ ...vehicleForm, color: e.target.value })} style={inputStyle} placeholder="White" />
                                </div>
                                <div>
                                    <label style={labelStyle}>Vehicle Type</label>
                                    <select value={vehicleForm.vehicleType} onChange={(e) => setVehicleForm({ ...vehicleForm, vehicleType: e.target.value })} style={inputStyle}>
                                        <option value="Sedan">Sedan</option>
                                        <option value="SUV">SUV</option>
                                        <option value="Van">Van</option>
                                        <option value="Truck">Truck</option>
                                        <option value="Bus">Bus</option>
                                        <option value="Motorcycle">Motorcycle</option>
                                    </select>
                                </div>
                            </div>
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' }}>
                                <div>
                                    <label style={labelStyle}>Driver Name</label>
                                    <input type="text" value={vehicleForm.driverName} onChange={(e) => setVehicleForm({ ...vehicleForm, driverName: e.target.value })} style={inputStyle} placeholder="Optional" />
                                </div>
                                <div>
                                    <label style={labelStyle}>Driver Phone</label>
                                    <input type="text" value={vehicleForm.driverPhone} onChange={(e) => setVehicleForm({ ...vehicleForm, driverPhone: e.target.value })} style={inputStyle} placeholder="Optional" />
                                </div>
                            </div>
                        </div>
                        <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end', padding: '16px 20px', borderTop: `1px solid ${theme.border}` }}>
                            <button onClick={() => setShowVehicleModal(false)} style={{ padding: '10px 20px', background: 'none', border: `1px solid ${theme.border}`, color: theme.text, fontWeight: '600', cursor: 'pointer' }}>Cancel</button>
                            <button onClick={handleAddVehicle} disabled={actionLoading} style={{ padding: '10px 20px', background: '#10b981', border: 'none', color: 'white', fontWeight: '600', cursor: 'pointer', opacity: actionLoading ? 0.7 : 1 }}>{actionLoading ? 'Adding...' : 'Add Vehicle'}</button>
                        </div>
                    </div>
                </div>
            )}

            {/* Add Contact Modal */}
            {showContactModal && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1001 }} onClick={() => setShowContactModal(false)}>
                    <div style={{ background: theme.bg, width: '400px', maxWidth: '95vw', border: `1px solid ${theme.border}` }} onClick={(e) => e.stopPropagation()}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '16px 20px', borderBottom: `1px solid ${theme.border}` }}>
                            <h4 style={{ margin: 0, color: theme.text }}>Add Authorized Contact</h4>
                            <button onClick={() => setShowContactModal(false)} style={{ background: 'none', border: 'none', fontSize: '18px', cursor: 'pointer', color: theme.textSecondary }}>‚úï</button>
                        </div>
                        <div style={{ padding: '20px', display: 'grid', gap: '12px' }}>
                            <div>
                                <label style={labelStyle}>Name *</label>
                                <input type="text" value={contactForm.name} onChange={(e) => setContactForm({ ...contactForm, name: e.target.value })} style={inputStyle} placeholder="Full name" />
                            </div>
                            <div>
                                <label style={labelStyle}>Phone *</label>
                                <input type="text" value={contactForm.phone} onChange={(e) => setContactForm({ ...contactForm, phone: e.target.value })} style={inputStyle} placeholder="0712345678" />
                            </div>
                            <div>
                                <label style={labelStyle}>Email</label>
                                <input type="email" value={contactForm.email} onChange={(e) => setContactForm({ ...contactForm, email: e.target.value })} style={inputStyle} placeholder="Optional" />
                            </div>
                            <div>
                                <label style={labelStyle}>Role</label>
                                <select value={contactForm.role} onChange={(e) => setContactForm({ ...contactForm, role: e.target.value })} style={inputStyle}>
                                    <option value="Driver">Driver</option>
                                    <option value="Fleet Manager">Fleet Manager</option>
                                    <option value="Accounts">Accounts</option>
                                    <option value="Supervisor">Supervisor</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                        </div>
                        <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end', padding: '16px 20px', borderTop: `1px solid ${theme.border}` }}>
                            <button onClick={() => setShowContactModal(false)} style={{ padding: '10px 20px', background: 'none', border: `1px solid ${theme.border}`, color: theme.text, fontWeight: '600', cursor: 'pointer' }}>Cancel</button>
                            <button onClick={handleAddContact} disabled={actionLoading} style={{ padding: '10px 20px', background: '#10b981', border: 'none', color: 'white', fontWeight: '600', cursor: 'pointer', opacity: actionLoading ? 0.7 : 1 }}>{actionLoading ? 'Adding...' : 'Add Contact'}</button>
                        </div>
                    </div>
                </div>
            )}

            {/* Top Up Modal */}
            {showTopUpModal && selectedAccount && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1001 }} onClick={() => setShowTopUpModal(false)}>
                    <div style={{ background: theme.bg, width: '400px', maxWidth: '95vw', border: `1px solid ${theme.border}` }} onClick={(e) => e.stopPropagation()}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '16px 20px', borderBottom: `1px solid ${theme.border}` }}>
                            <h4 style={{ margin: 0, color: theme.text }}>Top Up Balance</h4>
                            <button onClick={() => setShowTopUpModal(false)} style={{ background: 'none', border: 'none', fontSize: '18px', cursor: 'pointer', color: theme.textSecondary }}>‚úï</button>
                        </div>
                        <div style={{ padding: '20px' }}>
                            <div style={{ background: theme.bgSecondary, padding: '16px', marginBottom: '16px', borderLeft: '4px solid #10b981' }}>
                                <div style={{ fontSize: '12px', color: theme.textSecondary }}>Current Balance</div>
                                <div style={{ fontSize: '24px', fontWeight: '800', color: selectedAccount.balance >= 0 ? '#10b981' : '#ef4444' }}>{formatCurrency(selectedAccount.balance)}</div>
                            </div>
                            <div style={{ marginBottom: '12px' }}>
                                <label style={labelStyle}>Amount ({getBrandingForReceipts().currencySymbol || 'KES'}) *</label>
                                <input type="number" value={topUpAmount} onChange={(e) => setTopUpAmount(e.target.value)} style={inputStyle} placeholder="Enter amount" />
                            </div>
                            <div>
                                <label style={labelStyle}>Note / Reference</label>
                                <input type="text" value={topUpNote} onChange={(e) => setTopUpNote(e.target.value)} style={inputStyle} placeholder="e.g. Cash deposit, M-Pesa ref" />
                            </div>
                        </div>
                        <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end', padding: '16px 20px', borderTop: `1px solid ${theme.border}` }}>
                            <button onClick={() => setShowTopUpModal(false)} style={{ padding: '10px 20px', background: 'none', border: `1px solid ${theme.border}`, color: theme.text, fontWeight: '600', cursor: 'pointer' }}>Cancel</button>
                            <button onClick={handleTopUp} disabled={actionLoading} style={{ padding: '10px 20px', background: '#10b981', border: 'none', color: 'white', fontWeight: '600', cursor: 'pointer', opacity: actionLoading ? 0.7 : 1 }}>{actionLoading ? 'Processing...' : 'Add Balance'}</button>
                        </div>
                    </div>
                </div>
            )}

            {/* Wash History Modal */}
            {showWashHistoryModal && washHistoryAccount && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1001 }} onClick={() => setShowWashHistoryModal(false)}>
                    <div style={{ background: theme.bg, width: '950px', maxWidth: '95vw', maxHeight: '90vh', overflow: 'hidden', display: 'flex', flexDirection: 'column', border: `1px solid ${theme.border}` }} onClick={(e) => e.stopPropagation()}>
                        {/* Header */}
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '20px', borderBottom: `1px solid ${theme.border}`, background: theme.bgSecondary }}>
                            <div>
                                <h3 style={{ margin: 0, color: theme.text, fontWeight: '700', display: 'flex', alignItems: 'center', gap: '10px' }}>
                                    üìã Wash History
                                </h3>
                                <div style={{ fontSize: '13px', color: theme.textSecondary, marginTop: '4px' }}>
                                    {washHistoryAccount.companyName} ‚Ä¢ {washHistoryAccount.accountNumber}
                                </div>
                            </div>
                            <button onClick={() => setShowWashHistoryModal(false)} style={{ background: 'none', border: 'none', fontSize: '20px', cursor: 'pointer', color: theme.textSecondary }}>‚úï</button>
                        </div>
                        
                        {/* Summary Stats */}
                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '0', borderBottom: `1px solid ${theme.border}` }}>
                            <div style={{ padding: '14px 20px', borderRight: `1px solid ${theme.border}` }}>
                                <div style={{ fontSize: '10px', color: theme.textSecondary, textTransform: 'uppercase', fontWeight: '600' }}>Total Washes</div>
                                <div style={{ fontSize: '20px', fontWeight: '800', color: '#8b5cf6' }}>{washHistory.length}</div>
                            </div>
                            <div style={{ padding: '14px 20px', borderRight: `1px solid ${theme.border}` }}>
                                <div style={{ fontSize: '10px', color: theme.textSecondary, textTransform: 'uppercase', fontWeight: '600' }}>Vehicles</div>
                                <div style={{ fontSize: '20px', fontWeight: '800', color: '#3b82f6' }}>{washHistoryAccount.vehicles?.length || 0}</div>
                            </div>
                            <div style={{ padding: '14px 20px', borderRight: `1px solid ${theme.border}` }}>
                                <div style={{ fontSize: '10px', color: theme.textSecondary, textTransform: 'uppercase', fontWeight: '600' }}>Total Spent</div>
                                <div style={{ fontSize: '20px', fontWeight: '800', color: '#10b981' }}>{formatCurrency(washHistory.reduce((sum, w) => sum + (w.price || 0), 0))}</div>
                            </div>
                            <div style={{ padding: '14px 20px' }}>
                                <div style={{ fontSize: '10px', color: theme.textSecondary, textTransform: 'uppercase', fontWeight: '600' }}>Pending Payment</div>
                                <div style={{ fontSize: '20px', fontWeight: '800', color: '#ef4444' }}>
                                    {formatCurrency(washHistory.filter(w => w.paymentStatus === 'pending' || w.paymentStatus === 'awaiting').reduce((sum, w) => sum + (w.price || 0), 0))}
                                </div>
                            </div>
                        </div>
                        
                        {/* History Table */}
                        <div style={{ flex: 1, overflow: 'auto' }}>
                            {loadingWashHistory ? (
                                <div style={{ padding: '60px 20px', textAlign: 'center', color: theme.textSecondary }}>
                                    <div style={{ fontSize: '24px', marginBottom: '12px' }}>‚è≥</div>
                                    <div>Loading wash history...</div>
                                </div>
                            ) : washHistory.length === 0 ? (
                                <div style={{ padding: '60px 20px', textAlign: 'center', color: theme.textSecondary }}>
                                    <div style={{ fontSize: '48px', marginBottom: '12px', opacity: 0.5 }}>üöø</div>
                                    <div style={{ fontSize: '14px', fontWeight: '600' }}>No wash history found</div>
                                    <div style={{ fontSize: '12px', marginTop: '4px' }}>Wash records will appear here once vehicles are serviced</div>
                                </div>
                            ) : (
                                <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '13px' }}>
                                    <thead>
                                        <tr style={{ background: theme.bgTertiary, position: 'sticky', top: 0 }}>
                                            <th style={{ padding: '12px 16px', textAlign: 'left', fontWeight: '600', color: theme.text, borderBottom: `1px solid ${theme.border}` }}>Date</th>
                                            <th style={{ padding: '12px 16px', textAlign: 'left', fontWeight: '600', color: theme.text, borderBottom: `1px solid ${theme.border}` }}>Plate</th>
                                            <th style={{ padding: '12px 16px', textAlign: 'left', fontWeight: '600', color: theme.text, borderBottom: `1px solid ${theme.border}` }}>Driver</th>
                                            <th style={{ padding: '12px 16px', textAlign: 'left', fontWeight: '600', color: theme.text, borderBottom: `1px solid ${theme.border}` }}>Service</th>
                                            <th style={{ padding: '12px 16px', textAlign: 'right', fontWeight: '600', color: theme.text, borderBottom: `1px solid ${theme.border}` }}>Amount</th>
                                            <th style={{ padding: '12px 16px', textAlign: 'center', fontWeight: '600', color: theme.text, borderBottom: `1px solid ${theme.border}` }}>Bay</th>
                                            <th style={{ padding: '12px 16px', textAlign: 'center', fontWeight: '600', color: theme.text, borderBottom: `1px solid ${theme.border}` }}>Status</th>
                                            <th style={{ padding: '12px 16px', textAlign: 'center', fontWeight: '600', color: theme.text, borderBottom: `1px solid ${theme.border}` }}>Payment</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {washHistory.map((wash, idx) => (
                                            <tr key={wash.id} style={{ borderBottom: `1px solid ${theme.border}`, background: idx % 2 === 0 ? theme.bg : theme.bgSecondary }}>
                                                <td style={{ padding: '12px 16px' }}>
                                                    <div style={{ fontWeight: '500', color: theme.text }}>
                                                        {wash.date ? new Date(wash.date).toLocaleDateString() : '-'}
                                                    </div>
                                                    <div style={{ fontSize: '11px', color: theme.textSecondary }}>
                                                        {wash.date ? new Date(wash.date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : ''}
                                                    </div>
                                                </td>
                                                <td style={{ padding: '12px 16px' }}>
                                                    <div style={{ fontWeight: '700', color: '#3b82f6', fontFamily: 'monospace' }}>{wash.plateNumber}</div>
                                                    {wash.vehicleInfo && <div style={{ fontSize: '11px', color: theme.textSecondary }}>{wash.vehicleInfo}</div>}
                                                </td>
                                                <td style={{ padding: '12px 16px', color: theme.text }}>{wash.driverName || '-'}</td>
                                                <td style={{ padding: '12px 16px' }}>
                                                    <div style={{ color: theme.text, fontWeight: '500' }}>{wash.service}</div>
                                                    {wash.additionalServices && wash.additionalServices.length > 0 && (
                                                        <div style={{ fontSize: '10px', color: '#8b5cf6', marginTop: '2px' }}>
                                                            +{wash.additionalServices.length} add-on{wash.additionalServices.length > 1 ? 's' : ''}
                                                        </div>
                                                    )}
                                                </td>
                                                <td style={{ padding: '12px 16px', textAlign: 'right', fontWeight: '700', color: '#10b981' }}>{formatCurrency(wash.price)}</td>
                                                <td style={{ padding: '12px 16px', textAlign: 'center', color: theme.textSecondary }}>{wash.bay}</td>
                                                <td style={{ padding: '12px 16px', textAlign: 'center' }}>
                                                    <span style={{
                                                        padding: '3px 8px',
                                                        fontSize: '10px',
                                                        fontWeight: '600',
                                                        textTransform: 'uppercase',
                                                        background: wash.status === 'completed' ? '#dcfce7' : wash.status === 'in-progress' ? '#dbeafe' : '#f1f5f9',
                                                        color: wash.status === 'completed' ? '#166534' : wash.status === 'in-progress' ? '#1d4ed8' : theme.textSecondary
                                                    }}>
                                                        {wash.status}
                                                    </span>
                                                </td>
                                                <td style={{ padding: '12px 16px', textAlign: 'center' }}>
                                                    <span style={{
                                                        padding: '3px 8px',
                                                        fontSize: '10px',
                                                        fontWeight: '600',
                                                        textTransform: 'uppercase',
                                                        background: wash.paymentStatus === 'paid' ? '#dcfce7' : wash.paymentStatus === 'pending' ? '#fef3c7' : '#fee2e2',
                                                        color: wash.paymentStatus === 'paid' ? '#166534' : wash.paymentStatus === 'pending' ? '#92400e' : '#dc2626'
                                                    }}>
                                                        {wash.paymentStatus}
                                                    </span>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            )}
                        </div>
                        
                        {/* Footer */}
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '16px 20px', borderTop: `1px solid ${theme.border}`, background: theme.bgSecondary }}>
                            <div style={{ fontSize: '12px', color: theme.textSecondary }}>
                                Showing {washHistory.length} record{washHistory.length !== 1 ? 's' : ''}
                            </div>
                            <button onClick={() => setShowWashHistoryModal(false)} style={{ padding: '10px 24px', background: 'none', border: `1px solid ${theme.border}`, cursor: 'pointer', fontSize: '13px', color: theme.text, fontWeight: '600' }}>Close</button>
                        </div>
                    </div>
                </div>
            )}

            {/* Alert Modal */}
            <AlertModal
                isOpen={alertModal.isOpen}
                onClose={closeAlert}
                title={alertModal.title}
                message={alertModal.message}
                type={alertModal.type}
                onConfirm={alertModal.onConfirm}
                showCancel={alertModal.showCancel}
            />
        </div>
    );
}

// Customer Management Component
function CustomerManagement() {
    const { canCreate, canEdit, canDelete } = usePermissions();
    const { branding } = useBranding();
    const [permissionDenied, setPermissionDenied] = useState({ show: false, action: '' });
    const [customers, setCustomers] = useState([]);
    const [loading, setLoading] = useState(true);
    const [searchQuery, setSearchQuery] = useState('');
    const [showAddModal, setShowAddModal] = useState(false);
    const [showEditModal, setShowEditModal] = useState(false);
    const [showViewModal, setShowViewModal] = useState(false);
    const [showAddVehicleModal, setShowAddVehicleModal] = useState(false);
    const [showLoyaltySettingsModal, setShowLoyaltySettingsModal] = useState(false);
    const [showReceiptModal, setShowReceiptModal] = useState(false);
    const [showImportModal, setShowImportModal] = useState(false);
    const [intakeRecords, setIntakeRecords] = useState([]);
    const [selectedIntakeClient, setSelectedIntakeClient] = useState(null);
    const [receiptData, setReceiptData] = useState(null);
    const [selectedCustomer, setSelectedCustomer] = useState(null);
    const [actionLoading, setActionLoading] = useState(false);
    const [error, setError] = useState(null);
    const [activeTab, setActiveTab] = useState('customers'); // 'customers', 'reminders', 'rewards', or 'complaints'
    const [showRewardModal, setShowRewardModal] = useState(false);
    const [rewardCustomer, setRewardCustomer] = useState(null);
    
    // Complaint/Conflict Resolution state
    const [showComplaintModal, setShowComplaintModal] = useState(false);
    const [complaints, setComplaints] = useState([]);
    const [selectedComplaint, setSelectedComplaint] = useState(null);
    const [showViewComplaintModal, setShowViewComplaintModal] = useState(false);
    const [showAddNoteModal, setShowAddNoteModal] = useState(false);
    const [noteComplaint, setNoteComplaint] = useState(null);
    const [resolutionNote, setResolutionNote] = useState('');
    const [showComplaintReceiptModal, setShowComplaintReceiptModal] = useState(false);
    const [complaintReceiptData, setComplaintReceiptData] = useState(null);
    const [complaintSearch, setComplaintSearch] = useState('');
    const [complaintDateFilter, setComplaintDateFilter] = useState('all');
    const [complaintStatusFilter, setComplaintStatusFilter] = useState('all');
    const [complaintPage, setComplaintPage] = useState(1);
    const complaintsPerPage = 10;
    const [complaintFormData, setComplaintFormData] = useState({
        customerId: '',
        customerName: '',
        customerPhone: '',
        plateNumber: '',
        complaintNumber: '',
        complaintType: 'service',
        description: '',
        priority: 'medium'
    });
    
    // Alert modal state
    const [alertModal, setAlertModal] = useState({
        isOpen: false,
        title: '',
        message: '',
        type: 'info',
        onConfirm: null,
        showCancel: false
    });
    
    const showAlert = (title, message, type = 'info', onConfirm = null, showCancel = false) => {
        setAlertModal({ isOpen: true, title, message, type, onConfirm, showCancel });
    };
    
    const closeAlert = () => {
        setAlertModal(prev => ({ ...prev, isOpen: false }));
    };
    const [loyaltySettings, setLoyaltySettings] = useState({
        pointsPerVisit: 1,
        pointsPerRand: 0.1,
        redeemRate: 0.1,
        welcomeBonus: 10,
        birthdayBonus: 50,
        enabled: true,
        rewardThreshold: 20,
        rewardType: 'Free Basic Wash',
        rewardMessage: 'Congratulations! You have earned {points} points and qualify for a FREE wash! Present this message at our car wash to redeem your reward.',
        rewardEnabled: true
    });
    const [isDark, setIsDark] = useState(document.documentElement.getAttribute('data-theme') === 'dark');

    // Listen for theme changes
    useEffect(() => {
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.attributeName === 'data-theme') {
                    setIsDark(document.documentElement.getAttribute('data-theme') === 'dark');
                }
            });
        });
        observer.observe(document.documentElement, { attributes: true });
        return () => observer.disconnect();
    }, []);

    // Theme colors
    const theme = {
        bg: isDark ? '#1e293b' : 'white',
        bgSecondary: isDark ? '#0f172a' : '#f8fafc',
        bgTertiary: isDark ? '#334155' : '#f1f5f9',
        text: isDark ? '#f1f5f9' : '#1e293b',
        textSecondary: isDark ? '#94a3b8' : '#64748b',
        textMuted: isDark ? '#64748b' : '#94a3b8',
        border: isDark ? '#334155' : '#e2e8f0',
        borderLight: isDark ? '#475569' : '#d1d5db',
        cardShadow: isDark ? '0 1px 3px rgba(0,0,0,0.3)' : '0 1px 3px rgba(0,0,0,0.1)',
        modalOverlay: isDark ? 'rgba(0,0,0,0.7)' : 'rgba(0,0,0,0.5)',
        loadingOverlay: isDark ? 'rgba(15,23,42,0.8)' : 'rgba(255,255,255,0.7)',
        inputBg: isDark ? '#1e293b' : 'white',
        rowHoverBg: isDark ? '#334155' : '#f8fafc',
        btnViewBg: isDark ? '#1e3a8a' : '#dbeafe',
        btnViewText: isDark ? '#93c5fd' : '#2563eb',
        btnViewBorder: isDark ? '#3b82f6' : '#bfdbfe',
        btnEditBg: isDark ? '#064e3b' : '#d1fae5',
        btnEditText: isDark ? '#6ee7b7' : '#059669',
        btnEditBorder: isDark ? '#059669' : '#a7f3d0',
        btnDeleteBg: isDark ? '#7f1d1d' : '#fee2e2',
        btnDeleteText: isDark ? '#fca5a5' : '#dc2626',
        btnDeleteBorder: isDark ? '#dc2626' : '#fecaca',
        btnAddVehicleBg: isDark ? '#4c1d95' : '#f3e8ff',
        btnAddVehicleText: isDark ? '#c4b5fd' : '#7c3aed',
        btnAddVehicleBorder: isDark ? '#6d28d9' : '#ddd6fe',
        btnLoyaltyBg: isDark ? '#713f12' : '#fef3c7',
        btnLoyaltyText: isDark ? '#fcd34d' : '#d97706',
        btnLoyaltyBorder: isDark ? '#d97706' : '#fde68a',
    };

    const [formData, setFormData] = useState({
        name: '',
        phone: '',
        email: '',
        address: '',
        notes: ''
    });

    const [vehicleFormData, setVehicleFormData] = useState({
        plateNumber: '',
        make: '',
        model: '',
        color: '',
        year: '',
        nextServiceDate: ''
    });

    const [settingsFormData, setSettingsFormData] = useState({
        pointsPerVisit: 1,
        pointsPerRand: 0.1,
        redeemRate: 0.1,
        welcomeBonus: 10,
        birthdayBonus: 50,
        enabled: true,
        rewardThreshold: 20,
        rewardType: 'Free Basic Wash',
        rewardMessage: 'Congratulations! You have earned {points} points and qualify for a FREE wash! Present this message at our car wash to redeem your reward.',
        rewardEnabled: true
    });

    // Subscribe to customers data
    useEffect(() => {
        const services = window.FirebaseServices;
        if (!services?.customerService) return;
        const unsubscribe = services.customerService.subscribeToCustomers(
            (data) => {
                setCustomers(data);
                setLoading(false);
            },
            (err) => {
                setError('Failed to load customers');
                setLoading(false);
            }
        );
        return () => unsubscribe();
    }, []);

    // Subscribe to intake records for import feature
    useEffect(() => {
        const services = window.FirebaseServices;
        if (!services?.intakeRecordsService) return;
        const unsubscribe = services.intakeRecordsService.subscribeToRecords(
            (data) => {
                // Group by customer phone to get unique clients with their total visits
                const clientsMap = {};
                data.forEach(record => {
                    const phone = record.customerPhone || '';
                    const name = record.customerName || '';
                    if (phone || name) {
                        const key = phone || name;
                        if (!clientsMap[key]) {
                            clientsMap[key] = {
                                name: name,
                                phone: phone,
                                vehicles: [],
                                totalVisits: 0,
                                records: []
                            };
                        }
                        clientsMap[key].totalVisits += (record.visitNumber || 1);
                        clientsMap[key].records.push(record);
                        // Add vehicle if not already added
                        if (record.plateNumber && !clientsMap[key].vehicles.find(v => v.plateNumber === record.plateNumber)) {
                            clientsMap[key].vehicles.push({
                                plateNumber: record.plateNumber,
                                vehicleType: record.vehicleType || '',
                                make: record.make || '',
                                model: record.model || '',
                                color: record.color || ''
                            });
                        }
                    }
                });
                setIntakeRecords(Object.values(clientsMap));
            },
            (err) => {
                console.error('Failed to load intake records', err);
            }
        );
        return () => unsubscribe();
    }, []);

    // Subscribe to loyalty settings
    useEffect(() => {
        const services = window.FirebaseServices;
        if (!services?.loyaltySettingsService) return;
        const unsubscribe = services.loyaltySettingsService.subscribeToSettings(
            (settings) => {
                if (settings) {
                    setLoyaltySettings(settings);
                    setSettingsFormData(settings);
                }
            },
            (err) => {
                console.error('Failed to load loyalty settings', err);
            }
        );
        return () => unsubscribe();
    }, []);

    // Subscribe to complaints using complaintsService
    useEffect(() => {
        const services = window.FirebaseServices;
        if (!services?.complaintsService) return;
        
        const unsubscribe = services.complaintsService.subscribeToComplaints(
            (complaintsData) => {
                setComplaints(complaintsData);
            }
        );
        return () => unsubscribe();
    }, []);

    // Filter customers based on search
    const filteredCustomers = customers.filter(customer => {
        const query = searchQuery.toLowerCase();
        const nameMatch = customer.name?.toLowerCase().includes(query);
        const phoneMatch = customer.phone?.toLowerCase().includes(query);
        const emailMatch = customer.email?.toLowerCase().includes(query);
        const plateMatch = customer.vehicles?.some(v => v.plateNumber?.toLowerCase().includes(query));
        return nameMatch || phoneMatch || emailMatch || plateMatch;
    });

    // Reset form data
    const resetFormData = () => {
        setFormData({ name: '', phone: '', email: '', address: '', notes: '' });
    };

    const resetVehicleFormData = () => {
        setVehicleFormData({ plateNumber: '', make: '', model: '', color: '', year: '', nextServiceDate: '' });
    };

    // Get vehicles due for service (within 7 days or overdue)
    const getServiceReminders = () => {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const weekFromNow = new Date(today);
        weekFromNow.setDate(weekFromNow.getDate() + 7);
        
        const reminders = [];
        customers.forEach(customer => {
            customer.vehicles?.forEach(vehicle => {
                if (vehicle.nextServiceDate) {
                    const serviceDate = new Date(vehicle.nextServiceDate);
                    if (serviceDate <= weekFromNow) {
                        reminders.push({
                            customer,
                            vehicle,
                            dueDate: serviceDate,
                            isOverdue: serviceDate < today,
                            daysUntil: Math.ceil((serviceDate - today) / (1000 * 60 * 60 * 24))
                        });
                    }
                }
            });
        });
        return reminders.sort((a, b) => a.dueDate - b.dueDate);
    };

    // Get customers eligible for rewards (points >= threshold)
    const getRewardEligibleCustomers = () => {
        if (!loyaltySettings.rewardEnabled) return [];
        const threshold = loyaltySettings.rewardThreshold || 20;
        return customers.filter(customer => {
            const points = customer.loyaltyPoints || 0;
            const pendingReward = customer.pendingReward;
            const lastRewardAt = customer.lastRewardDeliveredAt ? new Date(customer.lastRewardDeliveredAt) : null;
            const pointsSinceLastReward = lastRewardAt ? points : points;
            // Customer is eligible if they have enough points and no pending reward
            return points >= threshold && !pendingReward;
        }).map(customer => ({
            ...customer,
            pointsOverThreshold: (customer.loyaltyPoints || 0) - threshold
        }));
    };

    // Get customers with pending rewards (not yet delivered)
    const getPendingRewards = () => {
        return customers.filter(customer => customer.pendingReward && !customer.pendingReward.deliveredAt);
    };

    // Get customers with delivered rewards (history)
    const getDeliveredRewards = () => {
        return customers.filter(customer => customer.rewardHistory && customer.rewardHistory.length > 0);
    };

    // Issue reward to customer
    const handleIssueReward = async (customer) => {
        setActionLoading(true);
        try {
            const services = window.FirebaseServices;
            const rewardData = {
                pendingReward: {
                    type: loyaltySettings.rewardType,
                    pointsAtIssue: customer.loyaltyPoints,
                    issuedAt: new Date().toISOString(),
                    message: loyaltySettings.rewardMessage.replace('{points}', customer.loyaltyPoints),
                    deliveredAt: null
                }
            };
            await services.customerService.updateCustomer(customer.id, rewardData);
            setError(null);
        } catch (err) {
            setError('Failed to issue reward');
        }
        setActionLoading(false);
    };

    // Mark reward as delivered
    const handleDeliverReward = async (customer) => {
        setActionLoading(true);
        try {
            const services = window.FirebaseServices;
            const rewardHistory = customer.rewardHistory || [];
            rewardHistory.push({
                ...customer.pendingReward,
                deliveredAt: new Date().toISOString(),
                deliveredBy: 'Staff' // Could be enhanced to track actual staff
            });
            
            // Deduct points used for reward
            const newPoints = Math.max(0, (customer.loyaltyPoints || 0) - (loyaltySettings.rewardThreshold || 20));
            
            await services.customerService.updateCustomer(customer.id, {
                pendingReward: null,
                rewardHistory,
                loyaltyPoints: newPoints,
                lastRewardDeliveredAt: new Date().toISOString()
            });
            setShowRewardModal(false);
            setRewardCustomer(null);
        } catch (err) {
            setError('Failed to mark reward as delivered');
        }
        setActionLoading(false);
    };

    // Cancel pending reward
    const handleCancelReward = async (customer) => {
        showAlert(
            'Cancel Reward',
            'Are you sure you want to cancel this pending reward?',
            'warning',
            async () => {
                setActionLoading(true);
                try {
                    const services = window.FirebaseServices;
                    await services.customerService.updateCustomer(customer.id, {
                        pendingReward: null
                    });
                } catch (err) {
                    setError('Failed to cancel reward');
                }
                setActionLoading(false);
            },
            true
        );
    };

    // Get formatted reward message for customer
    const getRewardMessage = (customer) => {
        return loyaltySettings.rewardMessage
            .replace('{points}', customer.loyaltyPoints || 0)
            .replace('{name}', customer.name || 'Valued Customer')
            .replace('{reward}', loyaltySettings.rewardType || 'Free Wash');
    };

    // Get customer complaint status
    const getCustomerComplaintStatus = (customerId) => {
        const customerComplaints = complaints.filter(c => c.customerId === customerId);
        if (customerComplaints.length === 0) return 'none';
        const hasOpen = customerComplaints.some(c => c.status === 'open' || c.status === 'in-progress');
        if (hasOpen) return 'open';
        return 'resolved';
    };

    // Get active complaints count
    const getActiveComplaintsCount = () => {
        return complaints.filter(c => c.status === 'open' || c.status === 'in-progress').length;
    };

    // Reset complaint form
    const resetComplaintForm = () => {
        setComplaintFormData({
            customerId: '',
            customerName: '',
            customerPhone: '',
            plateNumber: '',
            serviceCode: '',
            complaintType: 'service',
            description: '',
            priority: 'medium'
        });
    };

    // Generate auto complaint number
    const generateComplaintNumber = () => {
        const now = new Date();
        const year = now.getFullYear().toString().slice(-2);
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const random = Math.floor(Math.random() * 9000) + 1000;
        return `CMP-${year}${month}${day}-${random}`;
    };

    // Handle add complaint
    const handleAddComplaint = async () => {
        if (!complaintFormData.customerName || !complaintFormData.description) {
            setError('Customer name and description are required');
            return;
        }
        setActionLoading(true);
        try {
            const services = window.FirebaseServices;
            if (!services?.complaintsService) {
                throw new Error('Complaints service not available');
            }
            
            // Auto-generate complaint number
            const complaintNumber = generateComplaintNumber();
            const createdAt = new Date().toISOString();
            
            const complaintData = {
                ...complaintFormData,
                complaintNumber,
                status: 'open',
                createdAt,
                updatedAt: createdAt,
                resolvedAt: null,
                resolution: ''
            };
            
            const result = await services.complaintsService.addComplaint(complaintData);
            
            if (!result.success) {
                throw new Error(result.error || 'Failed to add complaint');
            }
            
            // Update customer complaint status if customerId exists
            if (complaintFormData.customerId && services.customerService) {
                await services.customerService.updateCustomer(complaintFormData.customerId, {
                    hasActiveComplaint: true,
                    lastComplaintAt: createdAt
                });
            }
            
            // Log activity for complaint raised
            if (services.activityService) {
                const currentUser = window.currentUserProfile;
                services.activityService.logActivity({
                    type: 'complaint',
                    action: 'Complaint Raised',
                    details: `‚ö†Ô∏è New ${complaintFormData.priority} priority ${complaintFormData.complaintType} complaint from ${complaintFormData.customerName}${complaintFormData.plateNumber ? ` (${complaintFormData.plateNumber})` : ''} - #${complaintNumber}`,
                    status: 'warning',
                    loggedBy: currentUser?.displayName || currentUser?.email?.split('@')[0] || 'System',
                    loggedByEmail: currentUser?.email || null,
                    loggedByRole: currentUser?.role || null,
                    metadata: {
                        complaintId: result.id,
                        complaintNumber,
                        customerName: complaintFormData.customerName,
                        plateNumber: complaintFormData.plateNumber,
                        complaintType: complaintFormData.complaintType,
                        priority: complaintFormData.priority
                    }
                });
            }
            
            // Prepare receipt data and show receipt
            setComplaintReceiptData({
                ...complaintData,
                id: result.id
            });
            setShowComplaintReceiptModal(true);
            
            resetComplaintForm();
        } catch (err) {
            console.error('Failed to add complaint:', err);
            setError('Failed to register complaint: ' + (err.message || 'Unknown error'));
        }
        setActionLoading(false);
    };

    // Handle resolve complaint
    const handleResolveComplaint = async (complaint, resolution = '') => {
        setActionLoading(true);
        try {
            const services = window.FirebaseServices;
            if (!services?.complaintsService) {
                throw new Error('Complaints service not available');
            }
            
            const result = await services.complaintsService.updateComplaint(complaint.id, {
                status: 'resolved',
                resolvedAt: new Date().toISOString(),
                resolution: resolution || 'Resolved by staff'
            });
            
            if (!result.success) {
                throw new Error(result.error || 'Failed to resolve complaint');
            }
            
            // Update customer complaint status
            if (complaint.customerId && services.customerService) {
                const remainingOpen = complaints.filter(c => 
                    c.customerId === complaint.customerId && 
                    c.id !== complaint.id && 
                    (c.status === 'open' || c.status === 'in-progress')
                );
                if (remainingOpen.length === 0) {
                    await services.customerService.updateCustomer(complaint.customerId, {
                        hasActiveComplaint: false,
                        lastResolvedAt: new Date().toISOString()
                    });
                }
            }
            
            setShowViewComplaintModal(false);
            setSelectedComplaint(null);
            setShowAddNoteModal(false);
            setNoteComplaint(null);
            setResolutionNote('');
            showAlert('Success', 'Complaint has been marked as resolved', 'success');
        } catch (err) {
            console.error('Failed to resolve complaint:', err);
            setError('Failed to resolve complaint: ' + (err.message || 'Unknown error'));
        }
        setActionLoading(false);
    };

    // Handle add note to complaint
    const handleAddNote = async (markAsResolved = false) => {
        if (!noteComplaint || !resolutionNote.trim()) {
            setError('Please enter a note');
            return;
        }
        setActionLoading(true);
        try {
            const services = window.FirebaseServices;
            if (!services?.complaintsService) {
                throw new Error('Complaints service not available');
            }
            
            // Get existing notes or create new array
            const existingNotes = noteComplaint.notes || [];
            const newNote = {
                text: resolutionNote.trim(),
                addedAt: new Date().toISOString(),
                addedBy: 'Staff'
            };
            
            // Determine new status
            let newStatus = noteComplaint.status;
            if (markAsResolved) {
                newStatus = 'resolved';
            } else if (noteComplaint.status === 'open') {
                newStatus = 'in-progress';
            }
            
            const updateData = {
                notes: [...existingNotes, newNote],
                status: newStatus,
                updatedAt: new Date().toISOString()
            };
            
            // Add resolution data if marking as resolved
            if (markAsResolved) {
                updateData.resolvedAt = new Date().toISOString();
                updateData.resolution = resolutionNote.trim();
            }
            
            const result = await services.complaintsService.updateComplaint(noteComplaint.id, updateData);
            
            if (!result.success) {
                throw new Error(result.error || 'Failed to add note');
            }
            
            // Update customer complaint status if resolved
            if (markAsResolved && noteComplaint.customerId && services.customerService) {
                // Check if customer has any other active complaints
                const otherActiveComplaints = complaints.filter(c => 
                    c.customerId === noteComplaint.customerId && 
                    c.id !== noteComplaint.id && 
                    c.status !== 'resolved'
                );
                if (otherActiveComplaints.length === 0) {
                    await services.customerService.updateCustomer(noteComplaint.customerId, {
                        hasActiveComplaint: false
                    });
                }
            }
            
            // Log activity for complaint resolved
            if (markAsResolved && services.activityService) {
                const currentUser = window.currentUserProfile;
                services.activityService.logActivity({
                    type: 'complaint',
                    action: 'Complaint Resolved',
                    details: `‚úÖ Complaint #${noteComplaint.complaintNumber || noteComplaint.id.slice(0,8)} resolved for ${noteComplaint.customerName}${noteComplaint.plateNumber ? ` (${noteComplaint.plateNumber})` : ''}`,
                    status: 'success',
                    loggedBy: currentUser?.displayName || currentUser?.email?.split('@')[0] || 'System',
                    loggedByEmail: currentUser?.email || null,
                    loggedByRole: currentUser?.role || null,
                    metadata: {
                        complaintId: noteComplaint.id,
                        complaintNumber: noteComplaint.complaintNumber,
                        customerName: noteComplaint.customerName,
                        plateNumber: noteComplaint.plateNumber,
                        resolution: resolutionNote.trim()
                    }
                });
            }
            
            setShowAddNoteModal(false);
            setNoteComplaint(null);
            setResolutionNote('');
            showAlert('Success', markAsResolved ? 'Complaint has been resolved' : 'Note has been added to the complaint', 'success');
        } catch (err) {
            console.error('Failed to add note:', err);
            setError('Failed to add note: ' + (err.message || 'Unknown error'));
        }
        setActionLoading(false);
    };

    // Handle delete complaint
    const handleDeleteComplaint = async (complaintId) => {
        showAlert(
            'Delete Complaint',
            'Are you sure you want to delete this complaint record?',
            'warning',
            async () => {
                setActionLoading(true);
                try {
                    const services = window.FirebaseServices;
                    if (!services?.complaintsService) {
                        throw new Error('Complaints service not available');
                    }
                    
                    const result = await services.complaintsService.deleteComplaint(complaintId);
                    if (!result.success) {
                        throw new Error(result.error || 'Failed to delete complaint');
                    }
                } catch (err) {
                    console.error('Failed to delete complaint:', err);
                    setError('Failed to delete complaint: ' + (err.message || 'Unknown error'));
                }
                setActionLoading(false);
            },
            true
        );
    };

    // Open complaint form with customer pre-filled
    const openComplaintForCustomer = (customer) => {
        setComplaintFormData({
            customerId: customer.id,
            customerName: customer.name || '',
            customerPhone: customer.phone || '',
            plateNumber: customer.vehicles?.[0]?.plateNumber || '',
            serviceCode: '',
            complaintType: 'service',
            description: '',
            priority: 'medium'
        });
        setActiveTab('complaints');
    };

    // Generate receipt for a service
    const generateReceipt = (customer, vehicle, service) => {
        const receiptNumber = 'RCP-' + Date.now().toString(36).toUpperCase();
        const currentPoints = customer.loyaltyPoints || 0;
        const pointsPerVisit = loyaltySettings.enabled ? loyaltySettings.pointsPerVisit : 0;
        const rewardThreshold = loyaltySettings.rewardThreshold || 20;
        const pointsToNextReward = Math.max(0, rewardThreshold - currentPoints);
        const qualifiesForReward = currentPoints >= rewardThreshold;
        
        const receipt = {
            receiptNumber,
            date: new Date().toISOString(),
            customer: {
                name: customer.name,
                phone: customer.phone,
                email: customer.email
            },
            vehicle: {
                plateNumber: vehicle?.plateNumber || 'N/A',
                make: vehicle?.make || '',
                model: vehicle?.model || '',
                color: vehicle?.color || ''
            },
            service: service || { name: 'Car Wash Service', price: 0 },
            // Actual loyalty data
            loyaltyEnabled: loyaltySettings.enabled,
            currentPoints: currentPoints,
            pointsEarned: pointsPerVisit,
            totalPoints: currentPoints + pointsPerVisit,
            totalVisits: customer.totalVisits || 0,
            rewardThreshold: rewardThreshold,
            pointsToNextReward: pointsToNextReward,
            qualifiesForReward: qualifiesForReward,
            pendingReward: customer.pendingReward || null,
            rewardType: loyaltySettings.rewardType || 'Free Wash'
        };
        setReceiptData(receipt);
        setShowReceiptModal(true);
    };

    // Print receipt
    const handlePrintReceipt = () => {
        const printContent = document.getElementById('receipt-content');
        const printWindow = window.open('', '', 'width=400,height=600');
        printWindow.document.write(`
            <html>
            <head>
                <title>Receipt - ${receiptData?.receiptNumber}</title>
                <style>
                    body { font-family: 'Courier New', monospace; padding: 20px; max-width: 300px; margin: 0 auto; }
                    .header { text-align: center; border-bottom: 2px dashed #000; padding-bottom: 10px; margin-bottom: 15px; }
                    .company { font-size: 20px; font-weight: bold; }
                    .tagline { font-size: 11px; color: #666; }
                    .section { margin: 15px 0; }
                    .row { display: flex; justify-content: space-between; margin: 5px 0; font-size: 12px; }
                    .label { color: #666; }
                    .value { font-weight: 500; text-align: right; }
                    .divider { border-top: 1px dashed #ccc; margin: 15px 0; }
                    .total-row { font-size: 16px; font-weight: bold; margin-top: 10px; }
                    .footer { text-align: center; margin-top: 20px; font-size: 11px; color: #666; border-top: 2px dashed #000; padding-top: 10px; }
                    .points { background: #f5f5f5; padding: 10px; text-align: center; margin-top: 15px; }
                    @media print { body { padding: 0; } }
                </style>
            </head>
            <body>
                ${printContent.innerHTML}
            </body>
            </html>
        `);
        printWindow.document.close();
        printWindow.focus();
        setTimeout(() => {
            printWindow.print();
            printWindow.close();
        }, 250);
    };

    // Handle add customer
    const handleAddCustomer = async () => {
        if (!formData.name || !formData.phone) {
            setError('Name and phone are required');
            return;
        }
        setActionLoading(true);
        try {
            const services = window.FirebaseServices;
            await services.customerService.addCustomer({
                ...formData,
                vehicles: [],
                loyaltyPoints: loyaltySettings.enabled ? loyaltySettings.welcomeBonus : 0,
                totalVisits: 0,
                totalSpent: 0
            });
            setShowAddModal(false);
            resetFormData();
        } catch (err) {
            setError('Failed to add customer');
        }
        setActionLoading(false);
    };

    // Handle import customer from intake records
    const handleImportFromIntake = async () => {
        if (!selectedIntakeClient) {
            setError('Please select a client to import');
            return;
        }
        
        // Check if customer already exists by phone
        const existingCustomer = customers.find(c => 
            c.phone && selectedIntakeClient.phone && 
            c.phone.replace(/\s/g, '') === selectedIntakeClient.phone.replace(/\s/g, '')
        );
        
        if (existingCustomer) {
            setError('A customer with this phone number already exists');
            return;
        }
        
        setActionLoading(true);
        try {
            const services = window.FirebaseServices;
            // Calculate loyalty points based on visits
            const pointsFromVisits = loyaltySettings.enabled 
                ? (selectedIntakeClient.totalVisits * loyaltySettings.pointsPerVisit) + loyaltySettings.welcomeBonus
                : 0;
            
            await services.customerService.addCustomer({
                name: selectedIntakeClient.name || '',
                phone: selectedIntakeClient.phone || '',
                email: '',
                address: '',
                notes: `Imported from Vehicle Intake. Previous visits: ${selectedIntakeClient.totalVisits}`,
                vehicles: selectedIntakeClient.vehicles || [],
                loyaltyPoints: pointsFromVisits,
                totalVisits: selectedIntakeClient.totalVisits || 0,
                totalSpent: 0
            });
            setShowImportModal(false);
            setSelectedIntakeClient(null);
        } catch (err) {
            setError('Failed to import customer');
        }
        setActionLoading(false);
    };

    // Get intake clients not yet in customers list
    const getAvailableIntakeClients = () => {
        return intakeRecords.filter(client => {
            // Filter out clients already in customers by phone number
            const phoneMatch = customers.some(c => 
                c.phone && client.phone && 
                c.phone.replace(/\s/g, '') === client.phone.replace(/\s/g, '')
            );
            return !phoneMatch && (client.phone || client.name);
        });
    };

    // Handle edit customer
    const handleEditCustomer = async () => {
        if (!formData.name || !formData.phone) {
            setError('Name and phone are required');
            return;
        }
        setActionLoading(true);
        try {
            const services = window.FirebaseServices;
            await services.customerService.updateCustomer(selectedCustomer.id, formData);
            setShowEditModal(false);
            setSelectedCustomer(null);
            resetFormData();
        } catch (err) {
            setError('Failed to update customer');
        }
        setActionLoading(false);
    };

    // Handle delete customer
    const handleDeleteCustomer = async (customerId) => {
        showAlert(
            'Delete Customer',
            'Are you sure you want to delete this customer? This action cannot be undone.',
            'warning',
            async () => {
                setActionLoading(true);
                try {
                    const services = window.FirebaseServices;
                    await services.customerService.deleteCustomer(customerId);
                } catch (err) {
                    setError('Failed to delete customer');
                }
                setActionLoading(false);
            },
            true
        );
    };

    // Handle add vehicle to customer
    const handleAddVehicle = async () => {
        if (!vehicleFormData.plateNumber) {
            setError('Plate number is required');
            return;
        }
        setActionLoading(true);
        try {
            const services = window.FirebaseServices;
            await services.customerService.addVehicleToCustomer(selectedCustomer.id, vehicleFormData);
            setShowAddVehicleModal(false);
            resetVehicleFormData();
            // Refresh selected customer
            const updated = customers.find(c => c.id === selectedCustomer.id);
            if (updated) setSelectedCustomer(updated);
        } catch (err) {
            setError('Failed to add vehicle');
        }
        setActionLoading(false);
    };

    // Handle remove vehicle from customer
    const handleRemoveVehicle = async (plateNumber) => {
        showAlert(
            'Remove Vehicle',
            'Are you sure you want to remove this vehicle from the customer?',
            'warning',
            async () => {
                setActionLoading(true);
                try {
                    const services = window.FirebaseServices;
                    await services.customerService.removeVehicleFromCustomer(selectedCustomer.id, plateNumber);
                    // Refresh selected customer
                    const updated = customers.find(c => c.id === selectedCustomer.id);
                    if (updated) setSelectedCustomer(updated);
                } catch (err) {
                    setError('Failed to remove vehicle');
                }
                setActionLoading(false);
            },
            true
        );
    };

    // Handle save loyalty settings
    const handleSaveLoyaltySettings = async () => {
        setActionLoading(true);
        try {
            const services = window.FirebaseServices;
            await services.loyaltySettingsService.updateSettings(settingsFormData);
            setShowLoyaltySettingsModal(false);
        } catch (err) {
            setError('Failed to save settings');
        }
        setActionLoading(false);
    };

    // Open edit modal
    const openEditModal = (customer) => {
        setSelectedCustomer(customer);
        setFormData({
            name: customer.name || '',
            phone: customer.phone || '',
            email: customer.email || '',
            address: customer.address || '',
            notes: customer.notes || ''
        });
        setShowEditModal(true);
    };

    // Open view modal
    const openViewModal = (customer) => {
        setSelectedCustomer(customer);
        setShowViewModal(true);
    };

    // Open add vehicle modal
    const openAddVehicleModal = (customer) => {
        setSelectedCustomer(customer);
        resetVehicleFormData();
        setShowAddVehicleModal(true);
    };

    // Input style
    const inputStyle = {
        width: '100%',
        padding: '10px 12px',
        border: `1px solid ${theme.border}`,
        fontSize: '14px',
        backgroundColor: theme.inputBg,
        color: theme.text,
        outline: 'none'
    };

    // Label style
    const labelStyle = {
        display: 'block',
        marginBottom: '6px',
        fontSize: '13px',
        fontWeight: '500',
        color: theme.textSecondary
    };

    if (loading) {
        return (
            <div style={{ padding: '40px', textAlign: 'center', color: theme.textSecondary }}>
                <div style={{ fontSize: '18px' }}>Loading customers...</div>
            </div>
        );
    }

    return (
        <div style={{ padding: '20px', backgroundColor: theme.bgSecondary, minHeight: '100%' }}>
            {/* Error message */}
            {error && (
                <div style={{ padding: '12px 16px', backgroundColor: '#fee2e2', color: '#dc2626', marginBottom: '20px', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <span>{error}</span>
                    <button onClick={() => setError(null)} style={{ background: 'none', border: 'none', color: '#dc2626', cursor: 'pointer', fontSize: '18px' }}>√ó</button>
                </div>
            )}

            {/* Tabs */}
            <div style={{ display: 'flex', gap: '0', marginBottom: '20px', borderBottom: `2px solid ${theme.border}` }}>
                <button
                    onClick={() => setActiveTab('customers')}
                    style={{ padding: '12px 24px', backgroundColor: 'transparent', color: activeTab === 'customers' ? '#3b82f6' : theme.textSecondary, border: 'none', borderBottom: activeTab === 'customers' ? '2px solid #3b82f6' : '2px solid transparent', marginBottom: '-2px', cursor: 'pointer', fontSize: '14px', fontWeight: '500' }}
                >
                    üë• Customers
                </button>
                <button
                    onClick={() => setActiveTab('reminders')}
                    style={{ padding: '12px 24px', backgroundColor: 'transparent', color: activeTab === 'reminders' ? '#3b82f6' : theme.textSecondary, border: 'none', borderBottom: activeTab === 'reminders' ? '2px solid #3b82f6' : '2px solid transparent', marginBottom: '-2px', cursor: 'pointer', fontSize: '14px', fontWeight: '500', display: 'flex', alignItems: 'center', gap: '8px' }}
                >
                    üîî Service Reminders
                    {getServiceReminders().length > 0 && (
                        <span style={{ backgroundColor: '#ef4444', color: 'white', padding: '2px 8px', fontSize: '11px', fontWeight: '600' }}>{getServiceReminders().length}</span>
                    )}
                </button>
                <button
                    onClick={() => setActiveTab('rewards')}
                    style={{ padding: '12px 24px', backgroundColor: 'transparent', color: activeTab === 'rewards' ? '#3b82f6' : theme.textSecondary, border: 'none', borderBottom: activeTab === 'rewards' ? '2px solid #3b82f6' : '2px solid transparent', marginBottom: '-2px', cursor: 'pointer', fontSize: '14px', fontWeight: '500', display: 'flex', alignItems: 'center', gap: '8px' }}
                >
                    üéÅ Loyalty Rewards
                    {(getRewardEligibleCustomers().length + getPendingRewards().length) > 0 && (
                        <span style={{ backgroundColor: '#f59e0b', color: 'white', padding: '2px 8px', fontSize: '11px', fontWeight: '600' }}>{getRewardEligibleCustomers().length + getPendingRewards().length}</span>
                    )}
                </button>
                <button
                    onClick={() => setActiveTab('complaints')}
                    style={{ padding: '12px 24px', backgroundColor: 'transparent', color: activeTab === 'complaints' ? '#3b82f6' : theme.textSecondary, border: 'none', borderBottom: activeTab === 'complaints' ? '2px solid #3b82f6' : '2px solid transparent', marginBottom: '-2px', cursor: 'pointer', fontSize: '14px', fontWeight: '500', display: 'flex', alignItems: 'center', gap: '8px' }}
                >
                    ‚ö†Ô∏è Complaints
                    {getActiveComplaintsCount() > 0 && (
                        <span style={{ backgroundColor: '#ef4444', color: 'white', padding: '2px 8px', fontSize: '11px', fontWeight: '600' }}>{getActiveComplaintsCount()}</span>
                    )}
                </button>
            </div>

            {/* Header with search and actions */}
            {activeTab === 'customers' && (
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px', flexWrap: 'wrap', gap: '15px' }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: '15px', flex: 1 }}>
                    <div style={{ position: 'relative', flex: 1, maxWidth: '400px' }}>
                        <input
                            type="text"
                            placeholder="Search by name, phone, or plate number..."
                            value={searchQuery}
                            onChange={(e) => setSearchQuery(e.target.value)}
                            style={{ ...inputStyle, paddingLeft: '40px' }}
                        />
                        <span style={{ position: 'absolute', left: '12px', top: '50%', transform: 'translateY(-50%)', color: theme.textMuted }}>üîç</span>
                    </div>
                </div>
                <div style={{ display: 'flex', gap: '10px' }}>
                    <button
                        onClick={() => { setSelectedIntakeClient(null); setShowImportModal(true); }}
                        style={{ padding: '10px 16px', backgroundColor: theme.btnAddVehicleBg, color: theme.btnAddVehicleText, border: `1px solid ${theme.btnAddVehicleBorder}`, cursor: 'pointer', fontSize: '14px', fontWeight: '500', display: 'flex', alignItems: 'center', gap: '6px' }}
                    >
                        üì• Import from Intake {getAvailableIntakeClients().length > 0 && <span style={{ backgroundColor: '#7c3aed', color: 'white', padding: '2px 6px', fontSize: '11px', borderRadius: '10px' }}>{getAvailableIntakeClients().length}</span>}
                    </button>
                    <button
                        onClick={() => setShowLoyaltySettingsModal(true)}
                        style={{ padding: '10px 16px', backgroundColor: theme.btnLoyaltyBg, color: theme.btnLoyaltyText, border: `1px solid ${theme.btnLoyaltyBorder}`, cursor: 'pointer', fontSize: '14px', fontWeight: '500', display: 'flex', alignItems: 'center', gap: '6px' }}
                    >
                        ‚öôÔ∏è Loyalty Settings
                    </button>
                    {canCreate('customers') && <button
                        onClick={() => { resetFormData(); setShowAddModal(true); }}
                        style={{ padding: '10px 20px', backgroundColor: '#3b82f6', color: 'white', border: 'none', cursor: 'pointer', fontSize: '14px', fontWeight: '500', display: 'flex', alignItems: 'center', gap: '6px' }}
                    >
                        + Add Customer
                    </button>}
                </div>
            </div>
            )}

            {/* Stats Cards */}
            {activeTab === 'customers' && (
            <>
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '15px', marginBottom: '20px' }}>
                <div style={{ backgroundColor: theme.bg, padding: '20px', boxShadow: theme.cardShadow, border: `1px solid ${theme.border}` }}>
                    <div style={{ fontSize: '13px', color: theme.textSecondary, marginBottom: '8px' }}>Total Customers</div>
                    <div style={{ fontSize: '28px', fontWeight: '600', color: theme.text }}>{customers.length}</div>
                </div>
                <div style={{ backgroundColor: theme.bg, padding: '20px', boxShadow: theme.cardShadow, border: `1px solid ${theme.border}` }}>
                    <div style={{ fontSize: '13px', color: theme.textSecondary, marginBottom: '8px' }}>Wash Count</div>
                    <div style={{ fontSize: '28px', fontWeight: '600', color: theme.text }}>{customers.reduce((sum, c) => sum + (c.vehicles?.length || 0), 0)}</div>
                </div>
                <div style={{ backgroundColor: theme.bg, padding: '20px', boxShadow: theme.cardShadow, border: `1px solid ${theme.border}` }}>
                    <div style={{ fontSize: '13px', color: theme.textSecondary, marginBottom: '8px' }}>Total Visits</div>
                    <div style={{ fontSize: '28px', fontWeight: '600', color: theme.text }}>{customers.reduce((sum, c) => sum + (c.totalVisits || 0), 0)}</div>
                </div>
                <div style={{ backgroundColor: theme.bg, padding: '20px', boxShadow: theme.cardShadow, border: `1px solid ${theme.border}` }}>
                    <div style={{ fontSize: '13px', color: theme.textSecondary, marginBottom: '8px' }}>Total Points Issued</div>
                    <div style={{ fontSize: '28px', fontWeight: '600', color: '#f59e0b' }}>{customers.reduce((sum, c) => sum + (c.loyaltyPoints || 0), 0)}</div>
                </div>
            </div>

            {/* Customers Table */}
            <div style={{ backgroundColor: theme.bg, boxShadow: theme.cardShadow, border: `1px solid ${theme.border}`, overflow: 'hidden' }}>
                <div style={{ overflowX: 'auto' }}>
                    <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                        <thead>
                            <tr style={{ backgroundColor: theme.bgTertiary }}>
                                <th style={{ padding: '14px 16px', textAlign: 'left', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase', letterSpacing: '0.5px', borderBottom: `1px solid ${theme.border}` }}>Customer</th>
                                <th style={{ padding: '14px 16px', textAlign: 'left', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase', letterSpacing: '0.5px', borderBottom: `1px solid ${theme.border}` }}>Phone</th>
                                <th style={{ padding: '14px 16px', textAlign: 'left', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase', letterSpacing: '0.5px', borderBottom: `1px solid ${theme.border}` }}>Vehicles</th>
                                <th style={{ padding: '14px 16px', textAlign: 'center', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase', letterSpacing: '0.5px', borderBottom: `1px solid ${theme.border}` }}>Visits</th>
                                <th style={{ padding: '14px 16px', textAlign: 'center', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase', letterSpacing: '0.5px', borderBottom: `1px solid ${theme.border}` }}>Points</th>
                                <th style={{ padding: '14px 16px', textAlign: 'center', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase', letterSpacing: '0.5px', borderBottom: `1px solid ${theme.border}` }}>Status</th>
                                <th style={{ padding: '14px 16px', textAlign: 'center', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase', letterSpacing: '0.5px', borderBottom: `1px solid ${theme.border}` }}>Reward</th>
                                <th style={{ padding: '14px 16px', textAlign: 'center', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase', letterSpacing: '0.5px', borderBottom: `1px solid ${theme.border}` }}>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {filteredCustomers.length === 0 ? (
                                <tr>
                                    <td colSpan="8" style={{ padding: '40px', textAlign: 'center', color: theme.textMuted }}>
                                        {searchQuery ? 'No customers found matching your search' : 'No customers yet. Add your first customer!'}
                                    </td>
                                </tr>
                            ) : (
                                filteredCustomers.map(customer => (
                                    <tr key={customer.id} style={{ borderBottom: `1px solid ${theme.border}` }}>
                                        <td style={{ padding: '14px 16px' }}>
                                            <div style={{ fontWeight: '500', color: theme.text }}>{customer.name}</div>
                                            {customer.email && <div style={{ fontSize: '12px', color: theme.textMuted }}>{customer.email}</div>}
                                        </td>
                                        <td style={{ padding: '14px 16px', color: theme.text }}>{customer.phone}</td>
                                        <td style={{ padding: '14px 16px' }}>
                                            <div style={{ display: 'flex', flexWrap: 'wrap', gap: '6px' }}>
                                                {customer.vehicles?.length > 0 ? (
                                                    customer.vehicles.map((v, idx) => (
                                                        <span key={idx} style={{ padding: '4px 8px', backgroundColor: theme.bgTertiary, fontSize: '12px', fontWeight: '500', color: theme.text, border: `1px solid ${theme.border}` }}>
                                                            {v.plateNumber}
                                                        </span>
                                                    ))
                                                ) : (
                                                    <span style={{ color: theme.textMuted, fontSize: '13px' }}>No vehicles</span>
                                                )}
                                            </div>
                                        </td>
                                        <td style={{ padding: '14px 16px', textAlign: 'center', fontWeight: '500', color: theme.text }}>{customer.totalVisits || 0}</td>
                                        <td style={{ padding: '14px 16px', textAlign: 'center' }}>
                                            <span style={{ padding: '4px 10px', backgroundColor: '#fef3c7', color: '#d97706', fontSize: '13px', fontWeight: '600' }}>
                                                {customer.loyaltyPoints || 0} pts
                                            </span>
                                        </td>
                                        <td style={{ padding: '14px 16px', textAlign: 'center' }}>
                                            {(() => {
                                                const status = getCustomerComplaintStatus(customer.id);
                                                if (status === 'open') {
                                                    return (
                                                        <span 
                                                            onClick={() => openComplaintForCustomer(customer)}
                                                            style={{ padding: '4px 10px', backgroundColor: '#fee2e2', color: '#dc2626', fontSize: '11px', fontWeight: '600', cursor: 'pointer' }}
                                                            title="Has active complaint - Click to view"
                                                        >
                                                            ‚ö†Ô∏è COMPLAINT
                                                        </span>
                                                    );
                                                } else if (status === 'resolved') {
                                                    return (
                                                        <span style={{ padding: '4px 10px', backgroundColor: '#d1fae5', color: '#059669', fontSize: '11px', fontWeight: '500' }} title="All complaints resolved">
                                                            ‚úÖ Resolved
                                                        </span>
                                                    );
                                                } else {
                                                    return (
                                                        <span style={{ padding: '4px 10px', backgroundColor: '#f0fdf4', color: '#15803d', fontSize: '11px', fontWeight: '500' }}>
                                                            ‚úì No Issues
                                                        </span>
                                                    );
                                                }
                                            })()}
                                        </td>
                                        <td style={{ padding: '14px 16px', textAlign: 'center' }}>
                                            {customer.pendingReward ? (
                                                <span 
                                                    onClick={() => { setRewardCustomer(customer); setShowRewardModal(true); }}
                                                    style={{ padding: '4px 10px', backgroundColor: '#dbeafe', color: '#2563eb', fontSize: '11px', fontWeight: '600', cursor: 'pointer' }}
                                                    title="Click to deliver reward"
                                                >
                                                    ‚è≥ PENDING
                                                </span>
                                            ) : (customer.loyaltyPoints || 0) >= (loyaltySettings.rewardThreshold || 20) ? (
                                                <span 
                                                    onClick={() => { setRewardCustomer(customer); setShowRewardModal(true); }}
                                                    style={{ padding: '4px 10px', backgroundColor: '#fef3c7', color: '#d97706', fontSize: '11px', fontWeight: '600', cursor: 'pointer', animation: 'pulse 2s infinite' }}
                                                    title="Eligible for reward! Click to issue"
                                                >
                                                    üéÅ ELIGIBLE
                                                </span>
                                            ) : customer.rewardHistory?.length > 0 ? (
                                                <span style={{ padding: '4px 10px', backgroundColor: '#d1fae5', color: '#059669', fontSize: '11px', fontWeight: '500' }} title={`${customer.rewardHistory.length} reward(s) delivered`}>
                                                    ‚úÖ {customer.rewardHistory.length}x
                                                </span>
                                            ) : (
                                                <span style={{ fontSize: '11px', color: theme.textMuted }}>
                                                    {Math.max(0, (loyaltySettings.rewardThreshold || 20) - (customer.loyaltyPoints || 0))} to go
                                                </span>
                                            )}
                                        </td>
                                        <td style={{ padding: '14px 16px', textAlign: 'center' }}>
                                            <div style={{ display: 'flex', justifyContent: 'center', gap: '8px', flexWrap: 'wrap' }}>
                                                <button onClick={() => openViewModal(customer)} style={{ padding: '6px 12px', backgroundColor: theme.btnViewBg, color: theme.btnViewText, border: `1px solid ${theme.btnViewBorder}`, cursor: 'pointer', fontSize: '12px', fontWeight: '500' }}>View</button>
                                                {canEdit('customers') && <button onClick={() => openEditModal(customer)} style={{ padding: '6px 12px', backgroundColor: theme.btnEditBg, color: theme.btnEditText, border: `1px solid ${theme.btnEditBorder}`, cursor: 'pointer', fontSize: '12px', fontWeight: '500' }}>Edit</button>}
                                                {canCreate('customers') && <button onClick={() => openAddVehicleModal(customer)} style={{ padding: '6px 12px', backgroundColor: theme.btnAddVehicleBg, color: theme.btnAddVehicleText, border: `1px solid ${theme.btnAddVehicleBorder}`, cursor: 'pointer', fontSize: '12px', fontWeight: '500' }}>+ Car</button>}
                                                <button onClick={() => generateReceipt(customer, customer.vehicles?.[0], { name: 'Service', price: 0 })} style={{ padding: '6px 12px', backgroundColor: theme.btnLoyaltyBg, color: theme.btnLoyaltyText, border: `1px solid ${theme.btnLoyaltyBorder}`, cursor: 'pointer', fontSize: '12px', fontWeight: '500' }}>üßæ</button>
                                                {canDelete('customers') && <button onClick={() => handleDeleteCustomer(customer.id)} style={{ padding: '6px 12px', backgroundColor: theme.btnDeleteBg, color: theme.btnDeleteText, border: `1px solid ${theme.btnDeleteBorder}`, cursor: 'pointer', fontSize: '12px', fontWeight: '500' }}>Delete</button>}
                                            </div>
                                        </td>
                                    </tr>
                                ))
                            )}
                        </tbody>
                    </table>
                </div>
            </div>
            </>
            )}

            {/* Service Reminders Tab */}
            {activeTab === 'reminders' && (
                <div>
                    <div style={{ marginBottom: '20px' }}>
                        <h3 style={{ margin: '0 0 8px 0', fontSize: '16px', fontWeight: '600', color: theme.text }}>Upcoming Service Reminders</h3>
                        <p style={{ margin: 0, fontSize: '13px', color: theme.textMuted }}>Vehicles due for service within the next 7 days</p>
                    </div>
                    
                    {getServiceReminders().length === 0 ? (
                        <div style={{ backgroundColor: theme.bg, padding: '60px 20px', textAlign: 'center', border: `1px solid ${theme.border}` }}>
                            <div style={{ fontSize: '48px', marginBottom: '16px' }}>‚úÖ</div>
                            <div style={{ fontSize: '16px', fontWeight: '500', color: theme.text, marginBottom: '8px' }}>No Upcoming Reminders</div>
                            <div style={{ fontSize: '13px', color: theme.textMuted }}>All vehicles are up to date with their service schedules</div>
                        </div>
                    ) : (
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                            {getServiceReminders().map((reminder, idx) => (
                                <div key={idx} style={{ backgroundColor: theme.bg, padding: '20px', border: `1px solid ${reminder.isOverdue ? '#fecaca' : theme.border}`, borderLeft: `4px solid ${reminder.isOverdue ? '#ef4444' : '#f59e0b'}` }}>
                                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', flexWrap: 'wrap', gap: '15px' }}>
                                        <div style={{ flex: 1 }}>
                                            <div style={{ display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '8px' }}>
                                                <span style={{ padding: '4px 10px', backgroundColor: reminder.isOverdue ? '#fee2e2' : '#fef3c7', color: reminder.isOverdue ? '#dc2626' : '#d97706', fontSize: '12px', fontWeight: '600' }}>
                                                    {reminder.isOverdue ? 'OVERDUE' : `Due in ${reminder.daysUntil} day${reminder.daysUntil !== 1 ? 's' : ''}`}
                                                </span>
                                                <span style={{ fontSize: '13px', color: theme.textMuted }}>{new Date(reminder.dueDate).toLocaleDateString()}</span>
                                            </div>
                                            <div style={{ fontWeight: '600', fontSize: '16px', color: theme.text, marginBottom: '4px' }}>{reminder.vehicle.plateNumber}</div>
                                            <div style={{ fontSize: '13px', color: theme.textSecondary, marginBottom: '8px' }}>
                                                {[reminder.vehicle.make, reminder.vehicle.model, reminder.vehicle.year].filter(Boolean).join(' ') || 'Vehicle'}
                                            </div>
                                            <div style={{ fontSize: '13px', color: theme.textMuted }}>
                                                Owner: <span style={{ color: theme.text, fontWeight: '500' }}>{reminder.customer.name}</span> ‚Ä¢ {reminder.customer.phone}
                                            </div>
                                        </div>
                                        <div style={{ display: 'flex', gap: '8px' }}>
                                            <button onClick={() => { window.location.href = `tel:${reminder.customer.phone}`; }} style={{ padding: '8px 16px', backgroundColor: '#3b82f6', color: 'white', border: 'none', cursor: 'pointer', fontSize: '13px', fontWeight: '500' }}>üìû Call</button>
                                            <button onClick={() => openViewModal(reminder.customer)} style={{ padding: '8px 16px', backgroundColor: theme.btnViewBg, color: theme.btnViewText, border: `1px solid ${theme.btnViewBorder}`, cursor: 'pointer', fontSize: '13px', fontWeight: '500' }}>View Customer</button>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            )}

            {/* Loyalty Rewards Tab */}
            {activeTab === 'rewards' && (
                <div>
                    {/* Reward Settings Summary */}
                    <div style={{ backgroundColor: theme.bg, padding: '16px 20px', marginBottom: '20px', border: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: '15px' }}>
                        <div>
                            <div style={{ fontSize: '14px', fontWeight: '600', color: theme.text, marginBottom: '4px' }}>üéÅ Current Reward: {loyaltySettings.rewardType || 'Free Basic Wash'}</div>
                            <div style={{ fontSize: '13px', color: theme.textMuted }}>Customers earn reward at <strong style={{ color: '#f59e0b' }}>{loyaltySettings.rewardThreshold || 20} points</strong></div>
                        </div>
                        <button onClick={() => setShowLoyaltySettingsModal(true)} style={{ padding: '8px 16px', backgroundColor: theme.btnLoyaltyBg, color: theme.btnLoyaltyText, border: `1px solid ${theme.btnLoyaltyBorder}`, cursor: 'pointer', fontSize: '13px', fontWeight: '500' }}>‚öôÔ∏è Configure</button>
                    </div>

                    {/* Stats */}
                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(180px, 1fr))', gap: '15px', marginBottom: '20px' }}>
                        <div style={{ backgroundColor: '#fef3c7', padding: '16px', border: '1px solid #fde68a' }}>
                            <div style={{ fontSize: '24px', fontWeight: '600', color: '#d97706' }}>{getRewardEligibleCustomers().length}</div>
                            <div style={{ fontSize: '12px', color: '#92400e' }}>Eligible for Reward</div>
                        </div>
                        <div style={{ backgroundColor: '#dbeafe', padding: '16px', border: '1px solid #bfdbfe' }}>
                            <div style={{ fontSize: '24px', fontWeight: '600', color: '#2563eb' }}>{getPendingRewards().length}</div>
                            <div style={{ fontSize: '12px', color: '#1e40af' }}>Pending Delivery</div>
                        </div>
                        <div style={{ backgroundColor: '#d1fae5', padding: '16px', border: '1px solid #a7f3d0' }}>
                            <div style={{ fontSize: '24px', fontWeight: '600', color: '#059669' }}>{getDeliveredRewards().length}</div>
                            <div style={{ fontSize: '12px', color: '#065f46' }}>Rewards Delivered</div>
                        </div>
                    </div>

                    {/* Eligible Customers Section */}
                    {getRewardEligibleCustomers().length > 0 && (
                        <div style={{ marginBottom: '24px' }}>
                            <h3 style={{ margin: '0 0 12px 0', fontSize: '15px', fontWeight: '600', color: theme.text, display: 'flex', alignItems: 'center', gap: '8px' }}>
                                üåü Customers Eligible for Reward
                                <span style={{ backgroundColor: '#fef3c7', color: '#d97706', padding: '2px 8px', fontSize: '11px', fontWeight: '600' }}>{getRewardEligibleCustomers().length}</span>
                            </h3>
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
                                {getRewardEligibleCustomers().map((customer) => (
                                    <div key={customer.id} style={{ backgroundColor: theme.bg, padding: '16px', border: `1px solid ${theme.border}`, borderLeft: '4px solid #f59e0b' }}>
                                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: '12px' }}>
                                            <div style={{ flex: 1 }}>
                                                <div style={{ fontWeight: '600', fontSize: '15px', color: theme.text }}>{customer.name}</div>
                                                <div style={{ fontSize: '13px', color: theme.textMuted }}>{customer.phone}</div>
                                            </div>
                                            <div style={{ textAlign: 'center', padding: '8px 16px', backgroundColor: '#fef3c7', border: '1px solid #fde68a' }}>
                                                <div style={{ fontSize: '18px', fontWeight: '700', color: '#d97706' }}>{customer.loyaltyPoints || 0}</div>
                                                <div style={{ fontSize: '10px', color: '#92400e' }}>POINTS</div>
                                            </div>
                                            <div style={{ display: 'flex', gap: '8px' }}>
                                                <button onClick={() => { setRewardCustomer(customer); setShowRewardModal(true); }} style={{ padding: '8px 16px', backgroundColor: '#f59e0b', color: 'white', border: 'none', cursor: 'pointer', fontSize: '13px', fontWeight: '500' }}>üéÅ Issue Reward</button>
                                                <button onClick={() => { window.location.href = `sms:${customer.phone}?body=${encodeURIComponent(getRewardMessage(customer))}`; }} style={{ padding: '8px 16px', backgroundColor: '#3b82f6', color: 'white', border: 'none', cursor: 'pointer', fontSize: '13px', fontWeight: '500' }}>üì± Send SMS</button>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* Pending Rewards Section */}
                    {getPendingRewards().length > 0 && (
                        <div style={{ marginBottom: '24px' }}>
                            <h3 style={{ margin: '0 0 12px 0', fontSize: '15px', fontWeight: '600', color: theme.text, display: 'flex', alignItems: 'center', gap: '8px' }}>
                                ‚è≥ Pending Reward Delivery
                                <span style={{ backgroundColor: '#dbeafe', color: '#2563eb', padding: '2px 8px', fontSize: '11px', fontWeight: '600' }}>{getPendingRewards().length}</span>
                            </h3>
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
                                {getPendingRewards().map((customer) => (
                                    <div key={customer.id} style={{ backgroundColor: theme.bg, padding: '16px', border: `1px solid ${theme.border}`, borderLeft: '4px solid #3b82f6' }}>
                                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', flexWrap: 'wrap', gap: '12px' }}>
                                            <div style={{ flex: 1 }}>
                                                <div style={{ fontWeight: '600', fontSize: '15px', color: theme.text }}>{customer.name}</div>
                                                <div style={{ fontSize: '13px', color: theme.textMuted, marginBottom: '8px' }}>{customer.phone}</div>
                                                <div style={{ fontSize: '12px', color: theme.textSecondary }}>
                                                    <strong>Reward:</strong> {customer.pendingReward?.type || loyaltySettings.rewardType}
                                                </div>
                                                <div style={{ fontSize: '11px', color: theme.textMuted, marginTop: '4px' }}>
                                                    Issued: {customer.pendingReward?.issuedAt ? new Date(customer.pendingReward.issuedAt).toLocaleDateString() : 'N/A'}
                                                </div>
                                            </div>
                                            <div style={{ display: 'flex', gap: '8px' }}>
                                                <button onClick={() => { setRewardCustomer(customer); setShowRewardModal(true); }} style={{ padding: '8px 16px', backgroundColor: '#10b981', color: 'white', border: 'none', cursor: 'pointer', fontSize: '13px', fontWeight: '500' }}>‚úÖ Mark Delivered</button>
                                                <button onClick={() => handleCancelReward(customer)} style={{ padding: '8px 16px', backgroundColor: theme.btnDeleteBg, color: theme.btnDeleteText, border: `1px solid ${theme.btnDeleteBorder}`, cursor: 'pointer', fontSize: '13px', fontWeight: '500' }}>Cancel</button>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* Delivered Rewards History */}
                    {getDeliveredRewards().length > 0 && (
                        <div>
                            <h3 style={{ margin: '0 0 12px 0', fontSize: '15px', fontWeight: '600', color: theme.text, display: 'flex', alignItems: 'center', gap: '8px' }}>
                                ‚úÖ Reward History
                            </h3>
                            <div style={{ backgroundColor: theme.bg, border: `1px solid ${theme.border}`, overflow: 'hidden' }}>
                                <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                                    <thead>
                                        <tr style={{ backgroundColor: theme.bgTertiary }}>
                                            <th style={{ padding: '12px 16px', textAlign: 'left', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, borderBottom: `1px solid ${theme.border}` }}>Customer</th>
                                            <th style={{ padding: '12px 16px', textAlign: 'left', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, borderBottom: `1px solid ${theme.border}` }}>Reward</th>
                                            <th style={{ padding: '12px 16px', textAlign: 'center', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, borderBottom: `1px solid ${theme.border}` }}>Points Used</th>
                                            <th style={{ padding: '12px 16px', textAlign: 'left', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, borderBottom: `1px solid ${theme.border}` }}>Delivered</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {getDeliveredRewards().flatMap(customer => 
                                            (customer.rewardHistory || []).map((reward, idx) => (
                                                <tr key={`${customer.id}-${idx}`} style={{ borderBottom: `1px solid ${theme.border}` }}>
                                                    <td style={{ padding: '12px 16px' }}>
                                                        <div style={{ fontWeight: '500', color: theme.text }}>{customer.name}</div>
                                                        <div style={{ fontSize: '12px', color: theme.textMuted }}>{customer.phone}</div>
                                                    </td>
                                                    <td style={{ padding: '12px 16px', color: theme.text }}>{reward.type || 'Reward'}</td>
                                                    <td style={{ padding: '12px 16px', textAlign: 'center' }}>
                                                        <span style={{ padding: '2px 8px', backgroundColor: '#fef3c7', color: '#d97706', fontSize: '12px', fontWeight: '500' }}>{loyaltySettings.rewardThreshold || 20} pts</span>
                                                    </td>
                                                    <td style={{ padding: '12px 16px', fontSize: '13px', color: theme.textSecondary }}>
                                                        {reward.deliveredAt ? new Date(reward.deliveredAt).toLocaleDateString() : 'N/A'}
                                                    </td>
                                                </tr>
                                            ))
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}

                    {/* Empty State */}
                    {getRewardEligibleCustomers().length === 0 && getPendingRewards().length === 0 && getDeliveredRewards().length === 0 && (
                        <div style={{ backgroundColor: theme.bg, padding: '60px 20px', textAlign: 'center', border: `1px solid ${theme.border}` }}>
                            <div style={{ fontSize: '48px', marginBottom: '16px' }}>üéÅ</div>
                            <div style={{ fontSize: '16px', fontWeight: '500', color: theme.text, marginBottom: '8px' }}>No Rewards Yet</div>
                            <div style={{ fontSize: '13px', color: theme.textMuted }}>Customers will appear here when they reach {loyaltySettings.rewardThreshold || 20} loyalty points</div>
                        </div>
                    )}
                </div>
            )}

            {/* Complaints/Conflict Resolution Tab */}
            {activeTab === 'complaints' && (
                <div>
                    {/* Header */}
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px', flexWrap: 'wrap', gap: '15px' }}>
                        <div>
                            <h3 style={{ margin: '0 0 8px 0', fontSize: '16px', fontWeight: '600', color: theme.text }}>‚ö†Ô∏è Conflict Resolution Center</h3>
                            <p style={{ margin: 0, fontSize: '13px', color: theme.textMuted }}>Manage and resolve customer complaints</p>
                        </div>
                        <div style={{ display: 'flex', gap: '10px' }}>
                            <button
                                onClick={() => {
                                    // Export to CSV
                                    const headers = ['Complaint #', 'Date', 'Customer', 'Phone', 'Car Plate', 'Type', 'Priority', 'Status', 'Description', 'Resolution'];
                                    const rows = complaints.map(c => {
                                        const date = c.createdAt?.toDate ? c.createdAt.toDate() : (c.createdAt ? new Date(c.createdAt) : null);
                                        return [
                                            c.complaintNumber || c.id.slice(0,8),
                                            date ? date.toLocaleString() : '',
                                            c.customerName || '',
                                            c.customerPhone || '',
                                            c.plateNumber || '',
                                            c.complaintType || '',
                                            c.priority || '',
                                            c.status || '',
                                            (c.description || '').replace(/,/g, ';').replace(/\n/g, ' '),
                                            (c.resolution || '').replace(/,/g, ';').replace(/\n/g, ' ')
                                        ];
                                    });
                                    const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
                                    const blob = new Blob([csv], { type: 'text/csv' });
                                    const url = URL.createObjectURL(blob);
                                    const a = document.createElement('a');
                                    a.href = url;
                                    a.download = `complaints_${new Date().toISOString().split('T')[0]}.csv`;
                                    a.click();
                                    URL.revokeObjectURL(url);
                                }}
                                style={{ padding: '10px 16px', backgroundColor: '#10b981', color: 'white', border: 'none', cursor: 'pointer', fontSize: '13px', fontWeight: '500', display: 'flex', alignItems: 'center', gap: '6px' }}
                            >
                                üìä Export CSV
                            </button>
                            <button
                                onClick={() => {
                                    // Export to PDF
                                    const printWindow = window.open('', '', 'width=900,height=700');
                                    const complaintsHtml = complaints.map(c => {
                                        const date = c.createdAt?.toDate ? c.createdAt.toDate() : (c.createdAt ? new Date(c.createdAt) : null);
                                        const statusColor = c.status === 'resolved' ? '#059669' : c.status === 'in-progress' ? '#d97706' : '#dc2626';
                                        const priorityColor = c.priority === 'urgent' ? '#dc2626' : c.priority === 'high' ? '#ea580c' : c.priority === 'medium' ? '#d97706' : '#15803d';
                                        return `
                                            <tr>
                                                <td style="padding: 8px; border: 1px solid #e5e7eb; font-family: monospace; font-weight: 600; color: #d97706;">${c.complaintNumber || c.id.slice(0,8)}</td>
                                                <td style="padding: 8px; border: 1px solid #e5e7eb;">${date ? date.toLocaleDateString() : '-'}</td>
                                                <td style="padding: 8px; border: 1px solid #e5e7eb;">${c.customerName || '-'}<br><small style="color: #6b7280;">${c.customerPhone || ''}</small></td>
                                                <td style="padding: 8px; border: 1px solid #e5e7eb; font-family: monospace;">${c.plateNumber || '-'}</td>
                                                <td style="padding: 8px; border: 1px solid #e5e7eb; text-transform: capitalize;">${c.complaintType || '-'}</td>
                                                <td style="padding: 8px; border: 1px solid #e5e7eb; font-size: 11px; max-width: 200px;">${(c.description || '-').substring(0, 100)}${(c.description || '').length > 100 ? '...' : ''}</td>
                                                <td style="padding: 8px; border: 1px solid #e5e7eb; text-transform: uppercase; color: ${priorityColor}; font-weight: 600;">${c.priority || '-'}</td>
                                                <td style="padding: 8px; border: 1px solid #e5e7eb; text-transform: capitalize; color: ${statusColor}; font-weight: 600;">${c.status || '-'}</td>
                                            </tr>
                                        `;
                                    }).join('');
                                    
                                    printWindow.document.write(`
                                        <html>
                                        <head>
                                            <title>Complaints Report - ${branding.companyName}</title>
                                            <style>
                                                body { font-family: Arial, sans-serif; margin: 20px; }
                                                h1 { color: #1f2937; font-size: 20px; margin-bottom: 5px; }
                                                .subtitle { color: #6b7280; font-size: 12px; margin-bottom: 20px; }
                                                table { width: 100%; border-collapse: collapse; font-size: 12px; }
                                                th { padding: 10px 8px; border: 1px solid #e5e7eb; background: #f9fafb; text-align: left; font-weight: 600; color: #374151; }
                                                .stats { display: flex; gap: 20px; margin-bottom: 20px; }
                                                .stat { padding: 10px 15px; background: #f9fafb; border: 1px solid #e5e7eb; }
                                                .stat-value { font-size: 20px; font-weight: 700; }
                                                .stat-label { font-size: 11px; color: #6b7280; }
                                                @media print { body { margin: 10px; } }
                                            </style>
                                        </head>
                                        <body>
                                            <h1>‚ö†Ô∏è Complaints Report</h1>
                                            <div class="subtitle">${branding.companyName} - Generated on ${new Date().toLocaleString()}</div>
                                            
                                            <div class="stats">
                                                <div class="stat">
                                                    <div class="stat-value" style="color: #dc2626;">${complaints.filter(c => c.status === 'open').length}</div>
                                                    <div class="stat-label">Open</div>
                                                </div>
                                                <div class="stat">
                                                    <div class="stat-value" style="color: #d97706;">${complaints.filter(c => c.status === 'in-progress').length}</div>
                                                    <div class="stat-label">In Progress</div>
                                                </div>
                                                <div class="stat">
                                                    <div class="stat-value" style="color: #059669;">${complaints.filter(c => c.status === 'resolved').length}</div>
                                                    <div class="stat-label">Resolved</div>
                                                </div>
                                                <div class="stat">
                                                    <div class="stat-value">${complaints.length}</div>
                                                    <div class="stat-label">Total</div>
                                                </div>
                                            </div>
                                            
                                            <table>
                                                <thead>
                                                    <tr>
                                                        <th>Complaint #</th>
                                                        <th>Date</th>
                                                        <th>Customer</th>
                                                        <th>Car Plate</th>
                                                        <th>Type</th>
                                                        <th>Complaint</th>
                                                        <th>Priority</th>
                                                        <th>Status</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${complaintsHtml}
                                                </tbody>
                                            </table>
                                            
                                            <div style="margin-top: 30px; text-align: center; color: #9ca3af; font-size: 10px;">
                                                ${branding.receiptFooter || 'Thank you for choosing us!'}<br>
                                                ${branding.website || ''}
                                            </div>
                                        </body>
                                        </html>
                                    `);
                                    printWindow.document.close();
                                    printWindow.focus();
                                    setTimeout(() => { printWindow.print(); }, 300);
                                }}
                                style={{ padding: '10px 16px', backgroundColor: '#ef4444', color: 'white', border: 'none', cursor: 'pointer', fontSize: '13px', fontWeight: '500', display: 'flex', alignItems: 'center', gap: '6px' }}
                            >
                                üìÑ Export PDF
                            </button>
                        </div>
                    </div>

                    {/* Stats */}
                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))', gap: '15px', marginBottom: '20px' }}>
                        <div style={{ backgroundColor: '#fee2e2', padding: '16px', border: '1px solid #fecaca' }}>
                            <div style={{ fontSize: '24px', fontWeight: '600', color: '#dc2626' }}>{complaints.filter(c => c.status === 'open').length}</div>
                            <div style={{ fontSize: '12px', color: '#991b1b' }}>Open Complaints</div>
                        </div>
                        <div style={{ backgroundColor: '#fef3c7', padding: '16px', border: '1px solid #fde68a' }}>
                            <div style={{ fontSize: '24px', fontWeight: '600', color: '#d97706' }}>{complaints.filter(c => c.status === 'in-progress').length}</div>
                            <div style={{ fontSize: '12px', color: '#92400e' }}>In Progress</div>
                        </div>
                        <div style={{ backgroundColor: '#d1fae5', padding: '16px', border: '1px solid #a7f3d0' }}>
                            <div style={{ fontSize: '24px', fontWeight: '600', color: '#059669' }}>{complaints.filter(c => c.status === 'resolved').length}</div>
                            <div style={{ fontSize: '12px', color: '#065f46' }}>Resolved</div>
                        </div>
                        <div style={{ backgroundColor: theme.bgTertiary, padding: '16px', border: `1px solid ${theme.border}` }}>
                            <div style={{ fontSize: '24px', fontWeight: '600', color: theme.text }}>{complaints.length}</div>
                            <div style={{ fontSize: '12px', color: theme.textMuted }}>Total</div>
                        </div>
                    </div>

                    {/* Add Complaint Form */}
                    <div style={{ backgroundColor: theme.bg, padding: '20px', marginBottom: '20px', border: `1px solid ${theme.border}` }}>
                        <h4 style={{ margin: '0 0 16px 0', fontSize: '14px', fontWeight: '600', color: theme.text }}>üìù Register New Complaint</h4>
                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '16px', marginBottom: '16px' }}>
                            <div>
                                <label style={labelStyle}>Customer Name *</label>
                                <input 
                                    type="text" 
                                    value={complaintFormData.customerName} 
                                    onChange={(e) => setComplaintFormData({...complaintFormData, customerName: e.target.value})} 
                                    style={inputStyle} 
                                    placeholder="Customer name" 
                                />
                            </div>
                            <div>
                                <label style={labelStyle}>Phone</label>
                                <input 
                                    type="tel" 
                                    value={complaintFormData.customerPhone} 
                                    onChange={(e) => setComplaintFormData({...complaintFormData, customerPhone: e.target.value})} 
                                    style={inputStyle} 
                                    placeholder="Phone number" 
                                />
                            </div>
                            <div>
                                <label style={labelStyle}>Car Plate Number</label>
                                <input 
                                    type="text" 
                                    value={complaintFormData.plateNumber} 
                                    onChange={(e) => setComplaintFormData({...complaintFormData, plateNumber: e.target.value.toUpperCase()})} 
                                    style={inputStyle} 
                                    placeholder="e.g., KAA 123A" 
                                />
                            </div>
                            <div>
                                <label style={labelStyle}>Complaint Type</label>
                                <select 
                                    value={complaintFormData.complaintType} 
                                    onChange={(e) => setComplaintFormData({...complaintFormData, complaintType: e.target.value})} 
                                    style={inputStyle}
                                >
                                    <option value="service">Service Quality</option>
                                    <option value="damage">Vehicle Damage</option>
                                    <option value="billing">Billing Issue</option>
                                    <option value="delay">Service Delay</option>
                                    <option value="staff">Staff Behavior</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div>
                                <label style={labelStyle}>Priority</label>
                                <select 
                                    value={complaintFormData.priority} 
                                    onChange={(e) => setComplaintFormData({...complaintFormData, priority: e.target.value})} 
                                    style={inputStyle}
                                >
                                    <option value="low">Low</option>
                                    <option value="medium">Medium</option>
                                    <option value="high">High</option>
                                    <option value="urgent">Urgent</option>
                                </select>
                            </div>
                            <div>
                                <label style={labelStyle}>Link to Customer</label>
                                <select 
                                    value={complaintFormData.customerId} 
                                    onChange={(e) => {
                                        const customer = customers.find(c => c.id === e.target.value);
                                        setComplaintFormData({
                                            ...complaintFormData, 
                                            customerId: e.target.value,
                                            customerName: customer?.name || complaintFormData.customerName,
                                            customerPhone: customer?.phone || complaintFormData.customerPhone,
                                            plateNumber: customer?.vehicles?.[0]?.plateNumber || complaintFormData.plateNumber
                                        });
                                    }} 
                                    style={inputStyle}
                                >
                                    <option value="">-- Optional: Link to existing customer --</option>
                                    {customers.map(c => (
                                        <option key={c.id} value={c.id}>{c.name} - {c.phone}</option>
                                    ))}
                                </select>
                            </div>
                        </div>
                        <div style={{ marginBottom: '16px' }}>
                            <label style={labelStyle}>Complaint Description *</label>
                            <textarea 
                                value={complaintFormData.description} 
                                onChange={(e) => setComplaintFormData({...complaintFormData, description: e.target.value})} 
                                style={{ ...inputStyle, minHeight: '100px', resize: 'vertical' }} 
                                placeholder="Describe the complaint in detail..." 
                            />
                        </div>
                        <div style={{ display: 'flex', justifyContent: 'flex-end', gap: '10px' }}>
                            <button 
                                onClick={resetComplaintForm} 
                                style={{ padding: '10px 20px', backgroundColor: theme.bgTertiary, color: theme.text, border: `1px solid ${theme.border}`, cursor: 'pointer', fontSize: '14px' }}
                            >
                                Clear
                            </button>
                            <button 
                                onClick={handleAddComplaint} 
                                disabled={actionLoading || !complaintFormData.customerName || !complaintFormData.description}
                                style={{ padding: '10px 20px', backgroundColor: '#ef4444', color: 'white', border: 'none', cursor: 'pointer', fontSize: '14px', fontWeight: '500', opacity: (actionLoading || !complaintFormData.customerName || !complaintFormData.description) ? 0.7 : 1 }}
                            >
                                {actionLoading ? 'Registering...' : '‚ö†Ô∏è Register Complaint'}
                            </button>
                        </div>
                    </div>

                    {/* Complaints Table */}
                    <div style={{ backgroundColor: theme.bg, border: `1px solid ${theme.border}`, overflow: 'hidden' }}>
                        <div style={{ padding: '16px 20px', borderBottom: `1px solid ${theme.border}` }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
                                <h4 style={{ margin: 0, fontSize: '14px', fontWeight: '600', color: theme.text }}>üìã Complaint Records</h4>
                                <span style={{ fontSize: '12px', color: theme.textMuted }}>{complaints.length} total</span>
                            </div>
                            
                            {/* Search and Filters */}
                            <div style={{ display: 'flex', flexWrap: 'wrap', gap: '12px', alignItems: 'center' }}>
                                {/* Search Input */}
                                <div style={{ flex: '1', minWidth: '200px', position: 'relative' }}>
                                    <input 
                                        type="text"
                                        value={complaintSearch}
                                        onChange={(e) => { setComplaintSearch(e.target.value); setComplaintPage(1); }}
                                        placeholder="Search by complaint #, customer name, or car plate..."
                                        style={{ 
                                            width: '100%',
                                            padding: '10px 12px 10px 36px',
                                            backgroundColor: theme.inputBg,
                                            border: `1px solid ${theme.border}`,
                                            color: theme.text,
                                            fontSize: '13px'
                                        }}
                                    />
                                    <span style={{ position: 'absolute', left: '12px', top: '50%', transform: 'translateY(-50%)', color: theme.textMuted }}>üîç</span>
                                </div>
                                
                                {/* Date Filter */}
                                <select 
                                    value={complaintDateFilter}
                                    onChange={(e) => { setComplaintDateFilter(e.target.value); setComplaintPage(1); }}
                                    style={{ 
                                        padding: '10px 12px',
                                        backgroundColor: theme.inputBg,
                                        border: `1px solid ${theme.border}`,
                                        color: theme.text,
                                        fontSize: '13px',
                                        minWidth: '140px'
                                    }}
                                >
                                    <option value="all">All Time</option>
                                    <option value="today">Today</option>
                                    <option value="yesterday">Yesterday</option>
                                    <option value="week">This Week</option>
                                    <option value="month">This Month</option>
                                </select>
                                
                                {/* Status Filter */}
                                <select 
                                    value={complaintStatusFilter}
                                    onChange={(e) => { setComplaintStatusFilter(e.target.value); setComplaintPage(1); }}
                                    style={{ 
                                        padding: '10px 12px',
                                        backgroundColor: theme.inputBg,
                                        border: `1px solid ${theme.border}`,
                                        color: theme.text,
                                        fontSize: '13px',
                                        minWidth: '130px'
                                    }}
                                >
                                    <option value="all">All Status</option>
                                    <option value="open">Open</option>
                                    <option value="in-progress">In Progress</option>
                                    <option value="resolved">Resolved</option>
                                </select>
                                
                                {/* Clear Filters */}
                                {(complaintSearch || complaintDateFilter !== 'all' || complaintStatusFilter !== 'all') && (
                                    <button 
                                        onClick={() => { setComplaintSearch(''); setComplaintDateFilter('all'); setComplaintStatusFilter('all'); setComplaintPage(1); }}
                                        style={{ 
                                            padding: '10px 14px',
                                            backgroundColor: theme.bgTertiary,
                                            border: `1px solid ${theme.border}`,
                                            color: theme.textSecondary,
                                            fontSize: '13px',
                                            cursor: 'pointer'
                                        }}
                                    >
                                        ‚úï Clear
                                    </button>
                                )}
                            </div>
                        </div>
                        
                        {(() => {
                            // Filter complaints
                            const now = new Date();
                            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                            const yesterday = new Date(today.getTime() - 24 * 60 * 60 * 1000);
                            const weekStart = new Date(today.getTime() - (today.getDay() * 24 * 60 * 60 * 1000));
                            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                            
                            const filteredComplaints = complaints.filter(complaint => {
                                // Search filter
                                if (complaintSearch) {
                                    const search = complaintSearch.toLowerCase();
                                    const matchesSearch = 
                                        (complaint.complaintNumber || '').toLowerCase().includes(search) ||
                                        (complaint.customerName || '').toLowerCase().includes(search) ||
                                        (complaint.plateNumber || '').toLowerCase().includes(search) ||
                                        (complaint.customerPhone || '').toLowerCase().includes(search);
                                    if (!matchesSearch) return false;
                                }
                                
                                // Status filter
                                if (complaintStatusFilter !== 'all' && complaint.status !== complaintStatusFilter) {
                                    return false;
                                }
                                
                                // Date filter
                                if (complaintDateFilter !== 'all') {
                                    const complaintDate = complaint.createdAt?.toDate ? complaint.createdAt.toDate() : (complaint.createdAt ? new Date(complaint.createdAt) : null);
                                    if (!complaintDate) return false;
                                    
                                    const complaintDay = new Date(complaintDate.getFullYear(), complaintDate.getMonth(), complaintDate.getDate());
                                    
                                    switch (complaintDateFilter) {
                                        case 'today':
                                            if (complaintDay.getTime() !== today.getTime()) return false;
                                            break;
                                        case 'yesterday':
                                            if (complaintDay.getTime() !== yesterday.getTime()) return false;
                                            break;
                                        case 'week':
                                            if (complaintDay < weekStart) return false;
                                            break;
                                        case 'month':
                                            if (complaintDay < monthStart) return false;
                                            break;
                                    }
                                }
                                
                                return true;
                            });
                            
                            // Pagination
                            const totalPages = Math.ceil(filteredComplaints.length / complaintsPerPage);
                            const startIndex = (complaintPage - 1) * complaintsPerPage;
                            const paginatedComplaints = filteredComplaints.slice(startIndex, startIndex + complaintsPerPage);
                            
                            if (filteredComplaints.length === 0) {
                                return (
                                    <div style={{ padding: '60px 20px', textAlign: 'center' }}>
                                        <div style={{ fontSize: '48px', marginBottom: '16px' }}>{complaintSearch || complaintDateFilter !== 'all' || complaintStatusFilter !== 'all' ? 'üîç' : '‚úÖ'}</div>
                                        <div style={{ fontSize: '16px', fontWeight: '500', color: theme.text, marginBottom: '8px' }}>
                                            {complaintSearch || complaintDateFilter !== 'all' || complaintStatusFilter !== 'all' ? 'No Matching Complaints' : 'No Complaints'}
                                        </div>
                                        <div style={{ fontSize: '13px', color: theme.textMuted }}>
                                            {complaintSearch || complaintDateFilter !== 'all' || complaintStatusFilter !== 'all' 
                                                ? 'Try adjusting your search or filters' 
                                                : 'Great! No customer complaints have been registered.'}
                                        </div>
                                    </div>
                                );
                            }
                            
                            return (
                                <>
                                    <div style={{ overflowX: 'auto' }}>
                                        <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                                            <thead>
                                                <tr style={{ backgroundColor: theme.bgTertiary }}>
                                                    <th style={{ padding: '12px 16px', textAlign: 'left', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase', borderBottom: `1px solid ${theme.border}` }}>Date</th>
                                                    <th style={{ padding: '12px 16px', textAlign: 'left', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase', borderBottom: `1px solid ${theme.border}` }}>Customer</th>
                                                    <th style={{ padding: '12px 16px', textAlign: 'left', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase', borderBottom: `1px solid ${theme.border}` }}>Car Plate</th>
                                                    <th style={{ padding: '12px 16px', textAlign: 'left', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase', borderBottom: `1px solid ${theme.border}` }}>Complaint #</th>
                                                    <th style={{ padding: '12px 16px', textAlign: 'left', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase', borderBottom: `1px solid ${theme.border}` }}>Type</th>
                                                    <th style={{ padding: '12px 16px', textAlign: 'center', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase', borderBottom: `1px solid ${theme.border}` }}>Priority</th>
                                                    <th style={{ padding: '12px 16px', textAlign: 'center', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase', borderBottom: `1px solid ${theme.border}` }}>Status</th>
                                                    <th style={{ padding: '12px 16px', textAlign: 'center', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase', borderBottom: `1px solid ${theme.border}` }}>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {paginatedComplaints.map(complaint => {
                                                    const createdDate = complaint.createdAt?.toDate ? complaint.createdAt.toDate() : (complaint.createdAt ? new Date(complaint.createdAt) : null);
                                                    return (
                                                    <tr key={complaint.id} style={{ borderBottom: `1px solid ${theme.border}` }}>
                                                        <td style={{ padding: '12px 16px' }}>
                                                            <div style={{ fontSize: '13px', color: theme.text }}>
                                                                {createdDate ? createdDate.toLocaleDateString() : 'N/A'}
                                                            </div>
                                                    <div style={{ fontSize: '11px', color: theme.textMuted }}>
                                                        {createdDate ? createdDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : ''}
                                                    </div>
                                                </td>
                                                <td style={{ padding: '12px 16px' }}>
                                                    <div style={{ fontWeight: '500', color: theme.text }}>{complaint.customerName || '-'}</div>
                                                    <div style={{ fontSize: '12px', color: theme.textMuted }}>{complaint.customerPhone || '-'}</div>
                                                </td>
                                                <td style={{ padding: '12px 16px' }}>
                                                    {complaint.plateNumber ? (
                                                        <span style={{ padding: '4px 8px', backgroundColor: theme.bgTertiary, fontSize: '12px', fontWeight: '500', color: theme.text, border: `1px solid ${theme.border}` }}>
                                                            {complaint.plateNumber}
                                                        </span>
                                                    ) : (
                                                        <span style={{ color: theme.textMuted, fontSize: '12px' }}>-</span>
                                                    )}
                                                </td>
                                                <td style={{ padding: '12px 16px' }}>
                                                    {complaint.complaintNumber ? (
                                                        <span style={{ padding: '4px 8px', backgroundColor: '#fef3c7', fontSize: '12px', fontWeight: '600', color: '#d97706', border: '1px solid #fde68a', fontFamily: 'monospace' }}>
                                                            {complaint.complaintNumber}
                                                        </span>
                                                    ) : complaint.serviceCode ? (
                                                        <span style={{ padding: '4px 8px', backgroundColor: '#dbeafe', fontSize: '12px', fontWeight: '500', color: '#2563eb', border: '1px solid #bfdbfe' }}>
                                                            {complaint.serviceCode}
                                                        </span>
                                                    ) : (
                                                        <span style={{ color: theme.textMuted, fontSize: '12px' }}>-</span>
                                                    )}
                                                </td>
                                                <td style={{ padding: '12px 16px', fontSize: '13px', color: theme.text, textTransform: 'capitalize' }}>
                                                    {complaint.complaintType === 'service' && 'üîß '}
                                                    {complaint.complaintType === 'damage' && 'üí• '}
                                                    {complaint.complaintType === 'billing' && 'üí≥ '}
                                                    {complaint.complaintType === 'delay' && '‚è∞ '}
                                                    {complaint.complaintType === 'staff' && 'üë§ '}
                                                    {complaint.complaintType || 'Other'}
                                                </td>
                                                <td style={{ padding: '12px 16px', textAlign: 'center' }}>
                                                    <span style={{ 
                                                        padding: '4px 10px', 
                                                        fontSize: '11px', 
                                                        fontWeight: '600',
                                                        backgroundColor: complaint.priority === 'urgent' ? '#fee2e2' : complaint.priority === 'high' ? '#ffedd5' : complaint.priority === 'medium' ? '#fef3c7' : '#f0fdf4',
                                                        color: complaint.priority === 'urgent' ? '#dc2626' : complaint.priority === 'high' ? '#ea580c' : complaint.priority === 'medium' ? '#d97706' : '#15803d',
                                                        textTransform: 'uppercase'
                                                    }}>
                                                        {complaint.priority}
                                                    </span>
                                                </td>
                                                <td style={{ padding: '12px 16px', textAlign: 'center' }}>
                                                    <span style={{ 
                                                        padding: '4px 10px', 
                                                        fontSize: '11px', 
                                                        fontWeight: '600',
                                                        backgroundColor: complaint.status === 'resolved' ? '#d1fae5' : complaint.status === 'in-progress' ? '#fef3c7' : '#fee2e2',
                                                        color: complaint.status === 'resolved' ? '#059669' : complaint.status === 'in-progress' ? '#d97706' : '#dc2626'
                                                    }}>
                                                        {complaint.status === 'resolved' ? '‚úÖ Resolved' : complaint.status === 'in-progress' ? 'üîÑ In Progress' : 'üî¥ Open'}
                                                    </span>
                                                </td>
                                                <td style={{ padding: '12px 16px', textAlign: 'center' }}>
                                                    <div style={{ display: 'flex', justifyContent: 'center', gap: '6px', flexWrap: 'wrap' }}>
                                                        <button 
                                                            onClick={() => { setSelectedComplaint(complaint); setShowViewComplaintModal(true); }}
                                                            style={{ padding: '6px 10px', backgroundColor: theme.btnViewBg, color: theme.btnViewText, border: `1px solid ${theme.btnViewBorder}`, cursor: 'pointer', fontSize: '11px', fontWeight: '500' }}
                                                        >
                                                            View
                                                        </button>
                                                        <button 
                                                            onClick={() => { setNoteComplaint(complaint); setResolutionNote(''); setShowAddNoteModal(true); }}
                                                            style={{ padding: '6px 10px', backgroundColor: '#fef3c7', color: '#d97706', border: '1px solid #fde68a', cursor: 'pointer', fontSize: '11px', fontWeight: '500' }}
                                                        >
                                                            üìù Note
                                                        </button>
                                                        {complaint.status !== 'resolved' && (
                                                            <button 
                                                                onClick={() => { setNoteComplaint(complaint); setResolutionNote(''); setShowAddNoteModal(true); }}
                                                                style={{ padding: '6px 10px', backgroundColor: '#d1fae5', color: '#059669', border: '1px solid #a7f3d0', cursor: 'pointer', fontSize: '11px', fontWeight: '500' }}
                                                                title="Add resolution note and mark as resolved"
                                                            >
                                                                ‚úì Resolve
                                                            </button>
                                                        )}
                                                        <button 
                                                            onClick={() => { setComplaintReceiptData(complaint); setShowComplaintReceiptModal(true); }}
                                                            style={{ padding: '6px 10px', backgroundColor: '#e0e7ff', color: '#4338ca', border: '1px solid #c7d2fe', cursor: 'pointer', fontSize: '11px', fontWeight: '500' }}
                                                            title="Print complaint receipt"
                                                        >
                                                            üñ®Ô∏è
                                                        </button>
                                                        <button 
                                                            onClick={() => handleDeleteComplaint(complaint.id)}
                                                            style={{ padding: '6px 10px', backgroundColor: theme.btnDeleteBg, color: theme.btnDeleteText, border: `1px solid ${theme.btnDeleteBorder}`, cursor: 'pointer', fontSize: '11px', fontWeight: '500' }}
                                                        >
                                                            üóëÔ∏è
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        )})}
                                    </tbody>
                                </table>
                            </div>
                            
                            {/* Pagination */}
                            {totalPages > 1 && (
                                <div style={{ 
                                    padding: '16px 20px', 
                                    borderTop: `1px solid ${theme.border}`,
                                    display: 'flex', 
                                    justifyContent: 'space-between', 
                                    alignItems: 'center',
                                    flexWrap: 'wrap',
                                    gap: '12px'
                                }}>
                                    <div style={{ fontSize: '13px', color: theme.textMuted }}>
                                        Showing {startIndex + 1} - {Math.min(startIndex + complaintsPerPage, filteredComplaints.length)} of {filteredComplaints.length} complaints
                                    </div>
                                    <div style={{ display: 'flex', gap: '6px', alignItems: 'center' }}>
                                        <button 
                                            onClick={() => setComplaintPage(1)}
                                            disabled={complaintPage === 1}
                                            style={{ 
                                                padding: '8px 12px', 
                                                backgroundColor: complaintPage === 1 ? theme.bgTertiary : theme.bg,
                                                border: `1px solid ${theme.border}`,
                                                color: complaintPage === 1 ? theme.textMuted : theme.text,
                                                cursor: complaintPage === 1 ? 'not-allowed' : 'pointer',
                                                fontSize: '12px'
                                            }}
                                        >
                                            ‚ü®‚ü® First
                                        </button>
                                        <button 
                                            onClick={() => setComplaintPage(p => Math.max(1, p - 1))}
                                            disabled={complaintPage === 1}
                                            style={{ 
                                                padding: '8px 12px', 
                                                backgroundColor: complaintPage === 1 ? theme.bgTertiary : theme.bg,
                                                border: `1px solid ${theme.border}`,
                                                color: complaintPage === 1 ? theme.textMuted : theme.text,
                                                cursor: complaintPage === 1 ? 'not-allowed' : 'pointer',
                                                fontSize: '12px'
                                            }}
                                        >
                                            ‚ü® Prev
                                        </button>
                                        
                                        {/* Page Numbers */}
                                        {(() => {
                                            const pages = [];
                                            let start = Math.max(1, complaintPage - 2);
                                            let end = Math.min(totalPages, start + 4);
                                            if (end - start < 4) start = Math.max(1, end - 4);
                                            
                                            for (let i = start; i <= end; i++) {
                                                pages.push(
                                                    <button 
                                                        key={i}
                                                        onClick={() => setComplaintPage(i)}
                                                        style={{ 
                                                            padding: '8px 12px', 
                                                            backgroundColor: complaintPage === i ? '#3b82f6' : theme.bg,
                                                            border: `1px solid ${complaintPage === i ? '#3b82f6' : theme.border}`,
                                                            color: complaintPage === i ? 'white' : theme.text,
                                                            cursor: 'pointer',
                                                            fontSize: '12px',
                                                            fontWeight: complaintPage === i ? '600' : '400'
                                                        }}
                                                    >
                                                        {i}
                                                    </button>
                                                );
                                            }
                                            return pages;
                                        })()}
                                        
                                        <button 
                                            onClick={() => setComplaintPage(p => Math.min(totalPages, p + 1))}
                                            disabled={complaintPage === totalPages}
                                            style={{ 
                                                padding: '8px 12px', 
                                                backgroundColor: complaintPage === totalPages ? theme.bgTertiary : theme.bg,
                                                border: `1px solid ${theme.border}`,
                                                color: complaintPage === totalPages ? theme.textMuted : theme.text,
                                                cursor: complaintPage === totalPages ? 'not-allowed' : 'pointer',
                                                fontSize: '12px'
                                            }}
                                        >
                                            Next ‚ü©
                                        </button>
                                        <button 
                                            onClick={() => setComplaintPage(totalPages)}
                                            disabled={complaintPage === totalPages}
                                            style={{ 
                                                padding: '8px 12px', 
                                                backgroundColor: complaintPage === totalPages ? theme.bgTertiary : theme.bg,
                                                border: `1px solid ${theme.border}`,
                                                color: complaintPage === totalPages ? theme.textMuted : theme.text,
                                                cursor: complaintPage === totalPages ? 'not-allowed' : 'pointer',
                                                fontSize: '12px'
                                            }}
                                        >
                                            Last ‚ü©‚ü©
                                        </button>
                                    </div>
                                </div>
                            )}
                        </>
                            );
                        })()}
                    </div>
                </div>
            )}

            {/* View Complaint Modal */}
            {showViewComplaintModal && selectedComplaint && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: theme.modalOverlay, display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000, padding: '20px' }}>
                    <div style={{ backgroundColor: theme.bg, width: '100%', maxWidth: '550px', maxHeight: '90vh', overflow: 'auto', boxShadow: '0 25px 50px -12px rgba(0,0,0,0.25)' }}>
                        <div style={{ padding: '20px', borderBottom: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <h2 style={{ margin: 0, fontSize: '18px', fontWeight: '600', color: theme.text }}>‚ö†Ô∏è Complaint Details</h2>
                            <button onClick={() => { setShowViewComplaintModal(false); setSelectedComplaint(null); }} style={{ background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer', color: theme.textMuted }}>√ó</button>
                        </div>
                        <div style={{ padding: '20px' }}>
                            {/* Complaint Number Banner */}
                            {(selectedComplaint.complaintNumber || selectedComplaint.serviceCode) && (
                                <div style={{ 
                                    padding: '14px', 
                                    marginBottom: '16px',
                                    backgroundColor: '#fef3c7',
                                    border: '2px solid #fbbf24',
                                    textAlign: 'center'
                                }}>
                                    <div style={{ fontSize: '11px', color: '#92400e', marginBottom: '4px', textTransform: 'uppercase' }}>Complaint Number</div>
                                    <div style={{ fontSize: '18px', fontWeight: '700', color: '#92400e', fontFamily: 'monospace', letterSpacing: '1px' }}>
                                        {selectedComplaint.complaintNumber || selectedComplaint.serviceCode}
                                    </div>
                                </div>
                            )}

                            {/* Status Banner */}
                            <div style={{ 
                                padding: '16px', 
                                marginBottom: '20px',
                                backgroundColor: selectedComplaint.status === 'resolved' ? '#d1fae5' : selectedComplaint.status === 'in-progress' ? '#fef3c7' : '#fee2e2',
                                border: `1px solid ${selectedComplaint.status === 'resolved' ? '#a7f3d0' : selectedComplaint.status === 'in-progress' ? '#fde68a' : '#fecaca'}`,
                                display: 'flex',
                                justifyContent: 'space-between',
                                alignItems: 'center'
                            }}>
                                <div>
                                    <div style={{ fontSize: '12px', color: selectedComplaint.status === 'resolved' ? '#065f46' : selectedComplaint.status === 'in-progress' ? '#92400e' : '#991b1b', fontWeight: '600', textTransform: 'uppercase' }}>Status</div>
                                    <div style={{ fontSize: '16px', fontWeight: '600', color: selectedComplaint.status === 'resolved' ? '#059669' : selectedComplaint.status === 'in-progress' ? '#d97706' : '#dc2626' }}>
                                        {selectedComplaint.status === 'resolved' ? '‚úÖ Resolved' : selectedComplaint.status === 'in-progress' ? 'üîÑ In Progress' : 'üî¥ Open'}
                                    </div>
                                </div>
                                <div style={{ 
                                    padding: '6px 12px', 
                                    backgroundColor: selectedComplaint.priority === 'urgent' ? '#dc2626' : selectedComplaint.priority === 'high' ? '#ea580c' : selectedComplaint.priority === 'medium' ? '#d97706' : '#15803d',
                                    color: 'white',
                                    fontSize: '11px',
                                    fontWeight: '600',
                                    textTransform: 'uppercase'
                                }}>
                                    {selectedComplaint.priority} Priority
                                </div>
                            </div>

                            {/* Details Grid */}
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px', marginBottom: '20px' }}>
                                <div>
                                    <div style={{ fontSize: '11px', color: theme.textMuted, marginBottom: '4px', textTransform: 'uppercase' }}>Customer</div>
                                    <div style={{ fontSize: '14px', fontWeight: '500', color: theme.text }}>{selectedComplaint.customerName || '-'}</div>
                                </div>
                                <div>
                                    <div style={{ fontSize: '11px', color: theme.textMuted, marginBottom: '4px', textTransform: 'uppercase' }}>Phone</div>
                                    <div style={{ fontSize: '14px', color: theme.text }}>{selectedComplaint.customerPhone || '-'}</div>
                                </div>
                                <div>
                                    <div style={{ fontSize: '11px', color: theme.textMuted, marginBottom: '4px', textTransform: 'uppercase' }}>Car Plate</div>
                                    <div style={{ fontSize: '14px', color: theme.text }}>
                                        {selectedComplaint.plateNumber ? (
                                            <span style={{ padding: '4px 8px', backgroundColor: theme.bgTertiary, fontSize: '13px', fontWeight: '500', border: `1px solid ${theme.border}` }}>
                                                {selectedComplaint.plateNumber}
                                            </span>
                                        ) : '-'}
                                    </div>
                                </div>
                                <div>
                                    <div style={{ fontSize: '11px', color: theme.textMuted, marginBottom: '4px', textTransform: 'uppercase' }}>Type</div>
                                    <div style={{ fontSize: '14px', color: theme.text, textTransform: 'capitalize' }}>{selectedComplaint.complaintType || '-'}</div>
                                </div>
                                <div>
                                    <div style={{ fontSize: '11px', color: theme.textMuted, marginBottom: '4px', textTransform: 'uppercase' }}>Created</div>
                                    <div style={{ fontSize: '14px', color: theme.text }}>
                                        {(() => {
                                            const d = selectedComplaint.createdAt?.toDate ? selectedComplaint.createdAt.toDate() : (selectedComplaint.createdAt ? new Date(selectedComplaint.createdAt) : null);
                                            return d ? d.toLocaleString() : '-';
                                        })()}
                                    </div>
                                </div>
                                {selectedComplaint.resolvedAt && (
                                    <div>
                                        <div style={{ fontSize: '11px', color: theme.textMuted, marginBottom: '4px', textTransform: 'uppercase' }}>Resolved</div>
                                        <div style={{ fontSize: '14px', color: theme.text }}>
                                            {(() => {
                                                const d = selectedComplaint.resolvedAt?.toDate ? selectedComplaint.resolvedAt.toDate() : (selectedComplaint.resolvedAt ? new Date(selectedComplaint.resolvedAt) : null);
                                                return d ? d.toLocaleString() : '-';
                                            })()}
                                        </div>
                                    </div>
                                )}
                            </div>

                            {/* Description */}
                            <div style={{ marginBottom: '20px' }}>
                                <div style={{ fontSize: '11px', color: theme.textMuted, marginBottom: '8px', textTransform: 'uppercase' }}>Description</div>
                                <div style={{ padding: '14px', backgroundColor: theme.bgTertiary, border: `1px solid ${theme.border}`, fontSize: '14px', color: theme.text, lineHeight: '1.6' }}>
                                    {selectedComplaint.description || 'No description provided'}
                                </div>
                            </div>

                            {/* Resolution */}
                            {selectedComplaint.resolution && (
                                <div style={{ marginBottom: '20px' }}>
                                    <div style={{ fontSize: '11px', color: theme.textMuted, marginBottom: '8px', textTransform: 'uppercase' }}>Resolution</div>
                                    <div style={{ padding: '14px', backgroundColor: '#d1fae5', border: '1px solid #a7f3d0', fontSize: '14px', color: '#065f46', lineHeight: '1.6' }}>
                                        {selectedComplaint.resolution}
                                    </div>
                                </div>
                            )}

                            {/* Notes History */}
                            {selectedComplaint.notes && selectedComplaint.notes.length > 0 && (
                                <div style={{ marginBottom: '20px' }}>
                                    <div style={{ fontSize: '11px', color: theme.textMuted, marginBottom: '8px', textTransform: 'uppercase' }}>Notes History ({selectedComplaint.notes.length})</div>
                                    <div style={{ maxHeight: '200px', overflowY: 'auto' }}>
                                        {selectedComplaint.notes.map((note, idx) => (
                                            <div key={idx} style={{ padding: '12px 14px', backgroundColor: theme.bgTertiary, border: `1px solid ${theme.border}`, marginBottom: '8px' }}>
                                                <div style={{ fontSize: '14px', color: theme.text, marginBottom: '6px', lineHeight: '1.5' }}>{note.text}</div>
                                                <div style={{ fontSize: '11px', color: theme.textMuted, display: 'flex', gap: '8px', alignItems: 'center' }}>
                                                    <span>üìÖ {(() => {
                                                        const d = note.timestamp?.toDate ? note.timestamp.toDate() : (note.timestamp ? new Date(note.timestamp) : null);
                                                        return d ? d.toLocaleString() : '-';
                                                    })()}</span>
                                                    {note.addedBy && <span>‚Ä¢ üë§ {note.addedBy}</span>}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                        <div style={{ padding: '20px', borderTop: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'space-between', gap: '10px' }}>
                            <div style={{ display: 'flex', gap: '10px' }}>
                                {selectedComplaint.customerPhone && (
                                    <button 
                                        onClick={() => { window.location.href = `tel:${selectedComplaint.customerPhone}`; }}
                                        style={{ padding: '10px 16px', backgroundColor: '#3b82f6', color: 'white', border: 'none', cursor: 'pointer', fontSize: '14px', fontWeight: '500' }}
                                    >
                                        üìû Call
                                    </button>
                                )}
                                <button 
                                    onClick={() => { setComplaintReceiptData(selectedComplaint); setShowComplaintReceiptModal(true); }}
                                    style={{ padding: '10px 16px', backgroundColor: '#4338ca', color: 'white', border: 'none', cursor: 'pointer', fontSize: '14px', fontWeight: '500' }}
                                >
                                    üñ®Ô∏è Print
                                </button>
                            </div>
                            <div style={{ display: 'flex', gap: '10px' }}>
                                <button onClick={() => { setShowViewComplaintModal(false); setSelectedComplaint(null); }} style={{ padding: '10px 20px', backgroundColor: theme.bgTertiary, color: theme.text, border: `1px solid ${theme.border}`, cursor: 'pointer', fontSize: '14px' }}>Close</button>
                                {selectedComplaint.status !== 'resolved' && (
                                    <button 
                                        onClick={() => handleResolveComplaint(selectedComplaint)}
                                        disabled={actionLoading}
                                        style={{ padding: '10px 20px', backgroundColor: '#10b981', color: 'white', border: 'none', cursor: 'pointer', fontSize: '14px', fontWeight: '500', opacity: actionLoading ? 0.7 : 1 }}
                                    >
                                        {actionLoading ? 'Processing...' : '‚úÖ Mark as Resolved'}
                                    </button>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* Add Note Modal */}
            {showAddNoteModal && noteComplaint && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: theme.modalOverlay, display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1001, padding: '20px' }}>
                    <div style={{ backgroundColor: theme.bg, width: '100%', maxWidth: '500px', maxHeight: '90vh', overflow: 'auto', boxShadow: '0 25px 50px -12px rgba(0,0,0,0.25)' }}>
                        <div style={{ padding: '20px', borderBottom: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <h2 style={{ margin: 0, fontSize: '18px', fontWeight: '600', color: theme.text }}>üìù Add Resolution Note</h2>
                            <button onClick={() => { setShowAddNoteModal(false); setNoteComplaint(null); setResolutionNote(''); }} style={{ background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer', color: theme.textMuted }}>√ó</button>
                        </div>
                        <div style={{ padding: '20px' }}>
                            {/* Complaint Info */}
                            <div style={{ padding: '14px', backgroundColor: theme.bgTertiary, border: `1px solid ${theme.border}`, marginBottom: '20px' }}>
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' }}>
                                    <div>
                                        <div style={{ fontSize: '11px', color: theme.textMuted, marginBottom: '2px' }}>Customer</div>
                                        <div style={{ fontSize: '14px', color: theme.text, fontWeight: '500' }}>{noteComplaint.customerName}</div>
                                    </div>
                                    <div>
                                        <div style={{ fontSize: '11px', color: theme.textMuted, marginBottom: '2px' }}>Car Plate</div>
                                        <div style={{ fontSize: '14px', color: theme.text, fontWeight: '500' }}>{noteComplaint.plateNumber || '-'}</div>
                                    </div>
                                    <div>
                                        <div style={{ fontSize: '11px', color: theme.textMuted, marginBottom: '2px' }}>Complaint #</div>
                                        <div style={{ fontSize: '14px', color: '#d97706', fontWeight: '600', fontFamily: 'monospace' }}>{noteComplaint.complaintNumber || noteComplaint.serviceCode || '-'}</div>
                                    </div>
                                    <div>
                                        <div style={{ fontSize: '11px', color: theme.textMuted, marginBottom: '2px' }}>Type</div>
                                        <div style={{ fontSize: '14px', color: theme.text, fontWeight: '500' }}>{noteComplaint.complaintType}</div>
                                    </div>
                                </div>
                            </div>

                            {/* Existing Notes */}
                            {noteComplaint.notes && noteComplaint.notes.length > 0 && (
                                <div style={{ marginBottom: '20px' }}>
                                    <div style={{ fontSize: '11px', color: theme.textMuted, marginBottom: '8px', textTransform: 'uppercase' }}>Previous Notes</div>
                                    <div style={{ maxHeight: '150px', overflowY: 'auto' }}>
                                        {noteComplaint.notes.map((note, idx) => (
                                            <div key={idx} style={{ padding: '10px 12px', backgroundColor: theme.bgSecondary, border: `1px solid ${theme.border}`, marginBottom: '8px', fontSize: '13px' }}>
                                                <div style={{ color: theme.text, marginBottom: '4px' }}>{note.text}</div>
                                                <div style={{ fontSize: '11px', color: theme.textMuted }}>
                                                    {(() => {
                                                        const d = note.timestamp?.toDate ? note.timestamp.toDate() : (note.timestamp ? new Date(note.timestamp) : null);
                                                        return d ? d.toLocaleString() : '-';
                                                    })()}
                                                    {note.addedBy && ` ‚Ä¢ ${note.addedBy}`}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {/* New Note Input */}
                            <div>
                                <label style={labelStyle}>Resolution Note *</label>
                                <textarea 
                                    value={resolutionNote}
                                    onChange={(e) => setResolutionNote(e.target.value)}
                                    style={{ ...inputStyle, minHeight: '120px', resize: 'vertical' }}
                                    placeholder="Enter details about how this complaint was resolved or any progress updates..."
                                />
                            </div>
                        </div>
                        <div style={{ padding: '20px', borderTop: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'space-between', gap: '10px' }}>
                            <button 
                                onClick={() => { setShowAddNoteModal(false); setNoteComplaint(null); setResolutionNote(''); }} 
                                style={{ padding: '10px 20px', backgroundColor: theme.bgTertiary, color: theme.text, border: `1px solid ${theme.border}`, cursor: 'pointer', fontSize: '14px' }}
                            >
                                Cancel
                            </button>
                            <div style={{ display: 'flex', gap: '10px' }}>
                                <button 
                                    onClick={() => handleAddNote(false)}
                                    disabled={actionLoading || !resolutionNote.trim()}
                                    style={{ padding: '10px 20px', backgroundColor: '#3b82f6', color: 'white', border: 'none', cursor: 'pointer', fontSize: '14px', fontWeight: '500', opacity: (actionLoading || !resolutionNote.trim()) ? 0.6 : 1 }}
                                >
                                    {actionLoading ? 'Saving...' : 'üíæ Save Note'}
                                </button>
                                {noteComplaint.status !== 'resolved' && (
                                    <button 
                                        onClick={() => handleAddNote(true)}
                                        disabled={actionLoading || !resolutionNote.trim()}
                                        style={{ padding: '10px 20px', backgroundColor: '#10b981', color: 'white', border: 'none', cursor: 'pointer', fontSize: '14px', fontWeight: '500', opacity: (actionLoading || !resolutionNote.trim()) ? 0.6 : 1 }}
                                    >
                                        {actionLoading ? 'Saving...' : '‚úÖ Save & Resolve'}
                                    </button>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* Complaint Receipt Modal */}
            {showComplaintReceiptModal && complaintReceiptData && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: theme.modalOverlay, display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1002, padding: '20px' }}>
                    <div style={{ backgroundColor: '#fff', width: '100%', maxWidth: '360px', boxShadow: '0 25px 50px -12px rgba(0,0,0,0.25)' }}>
                        <div style={{ padding: '16px', borderBottom: '1px solid #e5e7eb', display: 'flex', justifyContent: 'space-between', alignItems: 'center', backgroundColor: '#fef3c7' }}>
                            <h2 style={{ margin: 0, fontSize: '16px', fontWeight: '600', color: '#92400e' }}>‚ö†Ô∏è Complaint Receipt</h2>
                            <button onClick={() => { setShowComplaintReceiptModal(false); setComplaintReceiptData(null); }} style={{ background: 'none', border: 'none', fontSize: '20px', cursor: 'pointer', color: '#92400e' }}>√ó</button>
                        </div>
                        
                        {/* Receipt Content - Printable */}
                        <div id="complaint-receipt-content" style={{ padding: '20px', backgroundColor: '#fff' }}>
                            {/* Header with Branding */}
                            <div style={{ textAlign: 'center', marginBottom: '16px', paddingBottom: '16px', borderBottom: '2px dashed #d1d5db' }}>
                                {branding.logoUrl && (
                                    <img src={branding.logoUrl} alt="Logo" style={{ maxHeight: '50px', maxWidth: '150px', marginBottom: '8px', objectFit: 'contain' }} />
                                )}
                                <div style={{ fontSize: '18px', fontWeight: '700', color: branding.primaryColor || '#1f2937', marginBottom: '2px' }}>
                                    {branding.companyName} {branding.tagline ? '' : ''}
                                </div>
                                {branding.tagline && (
                                    <div style={{ fontSize: '11px', color: '#6b7280', marginBottom: '4px' }}>{branding.tagline}</div>
                                )}
                                <div style={{ fontSize: '12px', color: '#6b7280', fontWeight: '500' }}>Customer Complaint Receipt</div>
                                {(branding.address || branding.city) && (
                                    <div style={{ fontSize: '10px', color: '#9ca3af', marginTop: '4px' }}>
                                        {branding.address}{branding.address && branding.city ? ', ' : ''}{branding.city}
                                    </div>
                                )}
                                {branding.phone && (
                                    <div style={{ fontSize: '10px', color: '#9ca3af' }}>Tel: {branding.phone}</div>
                                )}
                            </div>
                            
                            {/* Complaint Number - Prominent */}
                            <div style={{ textAlign: 'center', marginBottom: '16px', padding: '12px', backgroundColor: '#fef3c7', border: '2px solid #fbbf24' }}>
                                <div style={{ fontSize: '11px', color: '#92400e', marginBottom: '4px', textTransform: 'uppercase' }}>Complaint Number</div>
                                <div style={{ fontSize: '20px', fontWeight: '700', color: '#92400e', fontFamily: 'monospace', letterSpacing: '1px' }}>
                                    {complaintReceiptData.complaintNumber || complaintReceiptData.serviceCode || 'N/A'}
                                </div>
                            </div>
                            
                            {/* Details */}
                            <div style={{ marginBottom: '16px' }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', padding: '8px 0', borderBottom: '1px solid #e5e7eb' }}>
                                    <span style={{ fontSize: '12px', color: '#6b7280' }}>Date:</span>
                                    <span style={{ fontSize: '12px', fontWeight: '500', color: '#1f2937' }}>
                                        {(() => {
                                            const d = complaintReceiptData.createdAt?.toDate ? complaintReceiptData.createdAt.toDate() : (complaintReceiptData.createdAt ? new Date(complaintReceiptData.createdAt) : new Date());
                                            return d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                                        })()}
                                    </span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', padding: '8px 0', borderBottom: '1px solid #e5e7eb' }}>
                                    <span style={{ fontSize: '12px', color: '#6b7280' }}>Customer:</span>
                                    <span style={{ fontSize: '12px', fontWeight: '500', color: '#1f2937' }}>{complaintReceiptData.customerName || '-'}</span>
                                </div>
                                {complaintReceiptData.customerPhone && (
                                    <div style={{ display: 'flex', justifyContent: 'space-between', padding: '8px 0', borderBottom: '1px solid #e5e7eb' }}>
                                        <span style={{ fontSize: '12px', color: '#6b7280' }}>Phone:</span>
                                        <span style={{ fontSize: '12px', fontWeight: '500', color: '#1f2937' }}>{complaintReceiptData.customerPhone}</span>
                                    </div>
                                )}
                                {complaintReceiptData.plateNumber && (
                                    <div style={{ display: 'flex', justifyContent: 'space-between', padding: '8px 0', borderBottom: '1px solid #e5e7eb' }}>
                                        <span style={{ fontSize: '12px', color: '#6b7280' }}>Car Plate:</span>
                                        <span style={{ fontSize: '12px', fontWeight: '600', color: '#1f2937', fontFamily: 'monospace' }}>{complaintReceiptData.plateNumber}</span>
                                    </div>
                                )}
                                <div style={{ display: 'flex', justifyContent: 'space-between', padding: '8px 0', borderBottom: '1px solid #e5e7eb' }}>
                                    <span style={{ fontSize: '12px', color: '#6b7280' }}>Type:</span>
                                    <span style={{ fontSize: '12px', fontWeight: '500', color: '#1f2937', textTransform: 'capitalize' }}>{complaintReceiptData.complaintType || 'Other'}</span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', padding: '8px 0', borderBottom: '1px solid #e5e7eb' }}>
                                    <span style={{ fontSize: '12px', color: '#6b7280' }}>Priority:</span>
                                    <span style={{ fontSize: '12px', fontWeight: '600', color: complaintReceiptData.priority === 'urgent' ? '#dc2626' : complaintReceiptData.priority === 'high' ? '#ea580c' : '#d97706', textTransform: 'uppercase' }}>{complaintReceiptData.priority || 'Medium'}</span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', padding: '8px 0', borderBottom: '1px solid #e5e7eb' }}>
                                    <span style={{ fontSize: '12px', color: '#6b7280' }}>Status:</span>
                                    <span style={{ fontSize: '12px', fontWeight: '600', color: '#dc2626' }}>OPEN</span>
                                </div>
                            </div>
                            
                            {/* Description */}
                            <div style={{ marginBottom: '16px' }}>
                                <div style={{ fontSize: '11px', color: '#6b7280', marginBottom: '6px', textTransform: 'uppercase' }}>Complaint Description:</div>
                                <div style={{ fontSize: '12px', color: '#1f2937', lineHeight: '1.5', padding: '10px', backgroundColor: '#f9fafb', border: '1px solid #e5e7eb' }}>
                                    {complaintReceiptData.description || 'No description provided'}
                                </div>
                            </div>
                            
                            {/* Footer */}
                            <div style={{ textAlign: 'center', paddingTop: '16px', borderTop: '2px dashed #d1d5db' }}>
                                <div style={{ fontSize: '11px', color: '#6b7280', marginBottom: '4px' }}>Please keep this receipt for your records.</div>
                                <div style={{ fontSize: '11px', color: '#6b7280', marginBottom: '8px' }}>Use the complaint number above for follow-up.</div>
                                {branding.receiptFooter && (
                                    <div style={{ fontSize: '10px', color: '#9ca3af', marginBottom: '4px' }}>{branding.receiptFooter}</div>
                                )}
                                {branding.website && (
                                    <div style={{ fontSize: '10px', color: '#9ca3af' }}>{branding.website}</div>
                                )}
                                {!branding.receiptFooter && !branding.website && (
                                    <div style={{ fontSize: '10px', color: '#9ca3af' }}>Thank you for bringing this to our attention.</div>
                                )}
                            </div>
                        </div>
                        
                        {/* Actions */}
                        <div style={{ padding: '16px', borderTop: '1px solid #e5e7eb', display: 'flex', justifyContent: 'space-between', gap: '10px', backgroundColor: '#f9fafb' }}>
                            <button 
                                onClick={() => { setShowComplaintReceiptModal(false); setComplaintReceiptData(null); }} 
                                style={{ padding: '10px 20px', backgroundColor: '#fff', color: '#374151', border: '1px solid #d1d5db', cursor: 'pointer', fontSize: '14px' }}
                            >
                                Close
                            </button>
                            <button 
                                onClick={() => {
                                    const printContent = document.getElementById('complaint-receipt-content');
                                    const printWindow = window.open('', '', 'width=400,height=600');
                                    printWindow.document.write(`
                                        <html>
                                        <head>
                                            <title>Complaint Receipt - ${complaintReceiptData.complaintNumber || 'N/A'}</title>
                                            <style>
                                                body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
                                                @media print { body { margin: 0; padding: 10px; } }
                                            </style>
                                        </head>
                                        <body>${printContent.innerHTML}</body>
                                        </html>
                                    `);
                                    printWindow.document.close();
                                    printWindow.focus();
                                    setTimeout(() => { printWindow.print(); printWindow.close(); }, 250);
                                }}
                                style={{ padding: '10px 20px', backgroundColor: '#4338ca', color: 'white', border: 'none', cursor: 'pointer', fontSize: '14px', fontWeight: '500' }}
                            >
                                üñ®Ô∏è Print Receipt
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* Add Customer Modal */}
            {showAddModal && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: theme.modalOverlay, display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000, padding: '20px' }}>
                    <div style={{ backgroundColor: theme.bg, width: '100%', maxWidth: '500px', maxHeight: '90vh', overflow: 'auto', boxShadow: '0 25px 50px -12px rgba(0,0,0,0.25)' }}>
                        <div style={{ padding: '20px', borderBottom: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <h2 style={{ margin: 0, fontSize: '18px', fontWeight: '600', color: theme.text }}>Add New Customer</h2>
                            <button onClick={() => setShowAddModal(false)} style={{ background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer', color: theme.textMuted }}>√ó</button>
                        </div>
                        <div style={{ padding: '20px' }}>
                            <div style={{ marginBottom: '16px' }}>
                                <label style={labelStyle}>Name *</label>
                                <input type="text" value={formData.name} onChange={(e) => setFormData({...formData, name: e.target.value})} style={inputStyle} placeholder="Customer name" />
                            </div>
                            <div style={{ marginBottom: '16px' }}>
                                <label style={labelStyle}>Phone *</label>
                                <input type="tel" value={formData.phone} onChange={(e) => setFormData({...formData, phone: e.target.value})} style={inputStyle} placeholder="Phone number" />
                            </div>
                            <div style={{ marginBottom: '16px' }}>
                                <label style={labelStyle}>Email</label>
                                <input type="email" value={formData.email} onChange={(e) => setFormData({...formData, email: e.target.value})} style={inputStyle} placeholder="Email address" />
                            </div>
                            <div style={{ marginBottom: '16px' }}>
                                <label style={labelStyle}>Address</label>
                                <input type="text" value={formData.address} onChange={(e) => setFormData({...formData, address: e.target.value})} style={inputStyle} placeholder="Address" />
                            </div>
                            <div style={{ marginBottom: '16px' }}>
                                <label style={labelStyle}>Notes</label>
                                <textarea value={formData.notes} onChange={(e) => setFormData({...formData, notes: e.target.value})} style={{ ...inputStyle, minHeight: '80px', resize: 'vertical' }} placeholder="Additional notes..." />
                            </div>
                        </div>
                        <div style={{ padding: '20px', borderTop: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'flex-end', gap: '10px' }}>
                            <button onClick={() => setShowAddModal(false)} style={{ padding: '10px 20px', backgroundColor: theme.bgTertiary, color: theme.text, border: `1px solid ${theme.border}`, cursor: 'pointer', fontSize: '14px' }}>Cancel</button>
                            <button onClick={handleAddCustomer} disabled={actionLoading} style={{ padding: '10px 20px', backgroundColor: '#3b82f6', color: 'white', border: 'none', cursor: 'pointer', fontSize: '14px', fontWeight: '500', opacity: actionLoading ? 0.7 : 1 }}>
                                {actionLoading ? 'Adding...' : 'Add Customer'}
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* Edit Customer Modal */}
            {showEditModal && selectedCustomer && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: theme.modalOverlay, display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000, padding: '20px' }}>
                    <div style={{ backgroundColor: theme.bg, width: '100%', maxWidth: '500px', maxHeight: '90vh', overflow: 'auto', boxShadow: '0 25px 50px -12px rgba(0,0,0,0.25)' }}>
                        <div style={{ padding: '20px', borderBottom: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <h2 style={{ margin: 0, fontSize: '18px', fontWeight: '600', color: theme.text }}>Edit Customer</h2>
                            <button onClick={() => setShowEditModal(false)} style={{ background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer', color: theme.textMuted }}>√ó</button>
                        </div>
                        <div style={{ padding: '20px' }}>
                            <div style={{ marginBottom: '16px' }}>
                                <label style={labelStyle}>Name *</label>
                                <input type="text" value={formData.name} onChange={(e) => setFormData({...formData, name: e.target.value})} style={inputStyle} placeholder="Customer name" />
                            </div>
                            <div style={{ marginBottom: '16px' }}>
                                <label style={labelStyle}>Phone *</label>
                                <input type="tel" value={formData.phone} onChange={(e) => setFormData({...formData, phone: e.target.value})} style={inputStyle} placeholder="Phone number" />
                            </div>
                            <div style={{ marginBottom: '16px' }}>
                                <label style={labelStyle}>Email</label>
                                <input type="email" value={formData.email} onChange={(e) => setFormData({...formData, email: e.target.value})} style={inputStyle} placeholder="Email address" />
                            </div>
                            <div style={{ marginBottom: '16px' }}>
                                <label style={labelStyle}>Address</label>
                                <input type="text" value={formData.address} onChange={(e) => setFormData({...formData, address: e.target.value})} style={inputStyle} placeholder="Address" />
                            </div>
                            <div style={{ marginBottom: '16px' }}>
                                <label style={labelStyle}>Notes</label>
                                <textarea value={formData.notes} onChange={(e) => setFormData({...formData, notes: e.target.value})} style={{ ...inputStyle, minHeight: '80px', resize: 'vertical' }} placeholder="Additional notes..." />
                            </div>
                        </div>
                        <div style={{ padding: '20px', borderTop: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'flex-end', gap: '10px' }}>
                            <button onClick={() => setShowEditModal(false)} style={{ padding: '10px 20px', backgroundColor: theme.bgTertiary, color: theme.text, border: `1px solid ${theme.border}`, cursor: 'pointer', fontSize: '14px' }}>Cancel</button>
                            <button onClick={handleEditCustomer} disabled={actionLoading} style={{ padding: '10px 20px', backgroundColor: '#3b82f6', color: 'white', border: 'none', cursor: 'pointer', fontSize: '14px', fontWeight: '500', opacity: actionLoading ? 0.7 : 1 }}>
                                {actionLoading ? 'Saving...' : 'Save Changes'}
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* View Customer Modal */}
            {showViewModal && selectedCustomer && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: theme.modalOverlay, display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000, padding: '20px' }}>
                    <div style={{ backgroundColor: theme.bg, width: '100%', maxWidth: '600px', maxHeight: '90vh', overflow: 'auto', boxShadow: '0 25px 50px -12px rgba(0,0,0,0.25)' }}>
                        <div style={{ padding: '20px', borderBottom: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <h2 style={{ margin: 0, fontSize: '18px', fontWeight: '600', color: theme.text }}>Customer Details</h2>
                            <button onClick={() => setShowViewModal(false)} style={{ background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer', color: theme.textMuted }}>√ó</button>
                        </div>
                        <div style={{ padding: '20px' }}>
                            {/* Customer Info */}
                            <div style={{ marginBottom: '24px' }}>
                                <h3 style={{ fontSize: '14px', fontWeight: '600', color: theme.textSecondary, marginBottom: '12px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Customer Information</h3>
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px' }}>
                                    <div>
                                        <div style={{ fontSize: '12px', color: theme.textMuted, marginBottom: '4px' }}>Name</div>
                                        <div style={{ fontSize: '14px', color: theme.text, fontWeight: '500' }}>{selectedCustomer.name}</div>
                                    </div>
                                    <div>
                                        <div style={{ fontSize: '12px', color: theme.textMuted, marginBottom: '4px' }}>Phone</div>
                                        <div style={{ fontSize: '14px', color: theme.text }}>{selectedCustomer.phone}</div>
                                    </div>
                                    <div>
                                        <div style={{ fontSize: '12px', color: theme.textMuted, marginBottom: '4px' }}>Email</div>
                                        <div style={{ fontSize: '14px', color: theme.text }}>{selectedCustomer.email || '-'}</div>
                                    </div>
                                    <div>
                                        <div style={{ fontSize: '12px', color: theme.textMuted, marginBottom: '4px' }}>Address</div>
                                        <div style={{ fontSize: '14px', color: theme.text }}>{selectedCustomer.address || '-'}</div>
                                    </div>
                                </div>
                                {selectedCustomer.notes && (
                                    <div style={{ marginTop: '16px' }}>
                                        <div style={{ fontSize: '12px', color: theme.textMuted, marginBottom: '4px' }}>Notes</div>
                                        <div style={{ fontSize: '14px', color: theme.text }}>{selectedCustomer.notes}</div>
                                    </div>
                                )}
                            </div>

                            {/* Loyalty Stats */}
                            <div style={{ marginBottom: '24px' }}>
                                <h3 style={{ fontSize: '14px', fontWeight: '600', color: theme.textSecondary, marginBottom: '12px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Loyalty & Visits</h3>
                                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '12px' }}>
                                    <div style={{ backgroundColor: theme.bgTertiary, padding: '16px', textAlign: 'center' }}>
                                        <div style={{ fontSize: '24px', fontWeight: '600', color: '#f59e0b' }}>{selectedCustomer.loyaltyPoints || 0}</div>
                                        <div style={{ fontSize: '12px', color: theme.textMuted }}>Loyalty Points</div>
                                    </div>
                                    <div style={{ backgroundColor: theme.bgTertiary, padding: '16px', textAlign: 'center' }}>
                                        <div style={{ fontSize: '24px', fontWeight: '600', color: theme.text }}>{selectedCustomer.totalVisits || 0}</div>
                                        <div style={{ fontSize: '12px', color: theme.textMuted }}>Total Visits</div>
                                    </div>
                                    <div style={{ backgroundColor: theme.bgTertiary, padding: '16px', textAlign: 'center' }}>
                                        <div style={{ fontSize: '24px', fontWeight: '600', color: '#10b981' }}>{getBrandingForReceipts().currencySymbol || 'KES'} {(selectedCustomer.totalSpent || 0).toFixed(2)}</div>
                                        <div style={{ fontSize: '12px', color: theme.textMuted }}>Total Spent</div>
                                    </div>
                                </div>
                            </div>

                            {/* Vehicles */}
                            <div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
                                    <h3 style={{ fontSize: '14px', fontWeight: '600', color: theme.textSecondary, margin: 0, textTransform: 'uppercase', letterSpacing: '0.5px' }}>Vehicles ({selectedCustomer.vehicles?.length || 0})</h3>
                                    <button onClick={() => { setShowViewModal(false); openAddVehicleModal(selectedCustomer); }} style={{ padding: '6px 12px', backgroundColor: '#3b82f6', color: 'white', border: 'none', cursor: 'pointer', fontSize: '12px' }}>+ Add Vehicle</button>
                                </div>
                                {selectedCustomer.vehicles?.length > 0 ? (
                                    <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
                                        {selectedCustomer.vehicles.map((vehicle, idx) => {
                                            const isServiceDue = vehicle.nextServiceDate && new Date(vehicle.nextServiceDate) <= new Date();
                                            return (
                                            <div key={idx} style={{ backgroundColor: theme.bgTertiary, padding: '14px', border: `1px solid ${isServiceDue ? '#fecaca' : theme.border}`, borderLeft: isServiceDue ? '4px solid #ef4444' : `1px solid ${theme.border}` }}>
                                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                                                    <div style={{ flex: 1 }}>
                                                        <div style={{ fontWeight: '600', fontSize: '15px', color: theme.text, marginBottom: '4px' }}>{vehicle.plateNumber}</div>
                                                        <div style={{ fontSize: '13px', color: theme.textSecondary, marginBottom: '6px' }}>
                                                            {[vehicle.make, vehicle.model, vehicle.year, vehicle.color].filter(Boolean).join(' ‚Ä¢ ') || 'No details'}
                                                        </div>
                                                        {vehicle.nextServiceDate && (
                                                            <div style={{ fontSize: '12px', color: isServiceDue ? '#dc2626' : theme.textMuted }}>
                                                                üîß Next service: {new Date(vehicle.nextServiceDate).toLocaleDateString()}
                                                                {isServiceDue && <span style={{ marginLeft: '8px', padding: '2px 6px', backgroundColor: '#fee2e2', color: '#dc2626', fontSize: '10px', fontWeight: '600' }}>DUE</span>}
                                                            </div>
                                                        )}
                                                    </div>
                                                    <div style={{ display: 'flex', gap: '6px' }}>
                                                        <button onClick={() => generateReceipt(selectedCustomer, vehicle, { name: 'Car Wash', price: 0 })} style={{ padding: '6px 10px', backgroundColor: theme.btnLoyaltyBg, color: theme.btnLoyaltyText, border: `1px solid ${theme.btnLoyaltyBorder}`, cursor: 'pointer', fontSize: '12px' }}>üßæ</button>
                                                        <button onClick={() => handleRemoveVehicle(vehicle.plateNumber)} style={{ padding: '6px 10px', backgroundColor: theme.btnDeleteBg, color: theme.btnDeleteText, border: `1px solid ${theme.btnDeleteBorder}`, cursor: 'pointer', fontSize: '12px' }}>Remove</button>
                                                    </div>
                                                </div>
                                            </div>
                                        )})}
                                    </div>
                                ) : (
                                    <div style={{ padding: '30px', textAlign: 'center', color: theme.textMuted, backgroundColor: theme.bgTertiary }}>No vehicles registered</div>
                                )}
                            </div>
                        </div>
                        <div style={{ padding: '20px', borderTop: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'flex-end' }}>
                            <button onClick={() => setShowViewModal(false)} style={{ padding: '10px 20px', backgroundColor: '#3b82f6', color: 'white', border: 'none', cursor: 'pointer', fontSize: '14px', fontWeight: '500' }}>Close</button>
                        </div>
                    </div>
                </div>
            )}

            {/* Add Vehicle Modal */}
            {showAddVehicleModal && selectedCustomer && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: theme.modalOverlay, display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000, padding: '20px' }}>
                    <div style={{ backgroundColor: theme.bg, width: '100%', maxWidth: '450px', maxHeight: '90vh', overflow: 'auto', boxShadow: '0 25px 50px -12px rgba(0,0,0,0.25)' }}>
                        <div style={{ padding: '20px', borderBottom: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <div>
                                <h2 style={{ margin: 0, fontSize: '18px', fontWeight: '600', color: theme.text }}>Add Vehicle</h2>
                                <div style={{ fontSize: '13px', color: theme.textMuted, marginTop: '4px' }}>For: {selectedCustomer.name}</div>
                            </div>
                            <button onClick={() => setShowAddVehicleModal(false)} style={{ background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer', color: theme.textMuted }}>√ó</button>
                        </div>
                        <div style={{ padding: '20px' }}>
                            <div style={{ marginBottom: '16px' }}>
                                <label style={labelStyle}>Plate Number *</label>
                                <input type="text" value={vehicleFormData.plateNumber} onChange={(e) => setVehicleFormData({...vehicleFormData, plateNumber: e.target.value.toUpperCase()})} style={inputStyle} placeholder="e.g., CA 123-456" />
                            </div>
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px' }}>
                                <div style={{ marginBottom: '16px' }}>
                                    <label style={labelStyle}>Make</label>
                                    <input type="text" value={vehicleFormData.make} onChange={(e) => setVehicleFormData({...vehicleFormData, make: e.target.value})} style={inputStyle} placeholder="e.g., Toyota" />
                                </div>
                                <div style={{ marginBottom: '16px' }}>
                                    <label style={labelStyle}>Model</label>
                                    <input type="text" value={vehicleFormData.model} onChange={(e) => setVehicleFormData({...vehicleFormData, model: e.target.value})} style={inputStyle} placeholder="e.g., Corolla" />
                                </div>
                            </div>
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px' }}>
                                <div style={{ marginBottom: '16px' }}>
                                    <label style={labelStyle}>Year</label>
                                    <input type="text" value={vehicleFormData.year} onChange={(e) => setVehicleFormData({...vehicleFormData, year: e.target.value})} style={inputStyle} placeholder="e.g., 2022" />
                                </div>
                                <div style={{ marginBottom: '16px' }}>
                                    <label style={labelStyle}>Color</label>
                                    <input type="text" value={vehicleFormData.color} onChange={(e) => setVehicleFormData({...vehicleFormData, color: e.target.value})} style={inputStyle} placeholder="e.g., White" />
                                </div>
                            </div>
                            <div style={{ marginBottom: '16px' }}>
                                <label style={labelStyle}>Next Service Date</label>
                                <input type="date" value={vehicleFormData.nextServiceDate} onChange={(e) => setVehicleFormData({...vehicleFormData, nextServiceDate: e.target.value})} style={inputStyle} />
                                <div style={{ fontSize: '11px', color: theme.textMuted, marginTop: '4px' }}>Set a reminder for the next service</div>
                            </div>
                        </div>
                        <div style={{ padding: '20px', borderTop: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'flex-end', gap: '10px' }}>
                            <button onClick={() => setShowAddVehicleModal(false)} style={{ padding: '10px 20px', backgroundColor: theme.bgTertiary, color: theme.text, border: `1px solid ${theme.border}`, cursor: 'pointer', fontSize: '14px' }}>Cancel</button>
                            <button onClick={handleAddVehicle} disabled={actionLoading} style={{ padding: '10px 20px', backgroundColor: '#3b82f6', color: 'white', border: 'none', cursor: 'pointer', fontSize: '14px', fontWeight: '500', opacity: actionLoading ? 0.7 : 1 }}>
                                {actionLoading ? 'Adding...' : 'Add Vehicle'}
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* Loyalty Settings Modal */}
            {showLoyaltySettingsModal && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: theme.modalOverlay, display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000, padding: '20px' }}>
                    <div style={{ backgroundColor: theme.bg, width: '100%', maxWidth: '550px', maxHeight: '90vh', overflow: 'auto', boxShadow: '0 25px 50px -12px rgba(0,0,0,0.25)' }}>
                        <div style={{ padding: '20px', borderBottom: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <h2 style={{ margin: 0, fontSize: '18px', fontWeight: '600', color: theme.text }}>‚öôÔ∏è Loyalty Settings</h2>
                            <button onClick={() => setShowLoyaltySettingsModal(false)} style={{ background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer', color: theme.textMuted }}>√ó</button>
                        </div>
                        <div style={{ padding: '20px' }}>
                            {/* General Settings */}
                            <div style={{ marginBottom: '20px', padding: '14px', backgroundColor: theme.bgTertiary, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                <div>
                                    <div style={{ fontWeight: '500', color: theme.text }}>Enable Loyalty Program</div>
                                    <div style={{ fontSize: '12px', color: theme.textMuted }}>Turn the loyalty system on or off</div>
                                </div>
                                <button
                                    onClick={() => setSettingsFormData({...settingsFormData, enabled: !settingsFormData.enabled})}
                                    style={{ width: '50px', height: '26px', backgroundColor: settingsFormData.enabled ? '#10b981' : theme.border, border: 'none', cursor: 'pointer', position: 'relative' }}
                                >
                                    <span style={{ position: 'absolute', width: '20px', height: '20px', backgroundColor: 'white', top: '3px', left: settingsFormData.enabled ? '27px' : '3px', transition: 'left 0.2s' }}></span>
                                </button>
                            </div>

                            {/* Points Earning Section */}
                            <div style={{ marginBottom: '20px' }}>
                                <div style={{ fontSize: '13px', fontWeight: '600', color: theme.textSecondary, marginBottom: '12px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>üìä Points Earning</div>
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' }}>
                                    <div>
                                        <label style={labelStyle}>Points Per Visit</label>
                                        <input type="number" min="0" step="1" value={settingsFormData.pointsPerVisit} onChange={(e) => setSettingsFormData({...settingsFormData, pointsPerVisit: Number(e.target.value)})} style={inputStyle} />
                                    </div>
                                    <div>
                                        <label style={labelStyle}>Points Per {getBrandingForReceipts().currencySymbol || 'KES'} Spent</label>
                                        <input type="number" min="0" step="0.01" value={settingsFormData.pointsPerRand} onChange={(e) => setSettingsFormData({...settingsFormData, pointsPerRand: Number(e.target.value)})} style={inputStyle} />
                                    </div>
                                </div>
                            </div>

                            {/* Bonuses Section */}
                            <div style={{ marginBottom: '20px' }}>
                                <div style={{ fontSize: '13px', fontWeight: '600', color: theme.textSecondary, marginBottom: '12px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>üéâ Bonuses</div>
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' }}>
                                    <div>
                                        <label style={labelStyle}>Welcome Bonus</label>
                                        <input type="number" min="0" step="1" value={settingsFormData.welcomeBonus} onChange={(e) => setSettingsFormData({...settingsFormData, welcomeBonus: Number(e.target.value)})} style={inputStyle} />
                                        <div style={{ fontSize: '10px', color: theme.textMuted, marginTop: '2px' }}>For new customers</div>
                                    </div>
                                    <div>
                                        <label style={labelStyle}>Birthday Bonus</label>
                                        <input type="number" min="0" step="1" value={settingsFormData.birthdayBonus} onChange={(e) => setSettingsFormData({...settingsFormData, birthdayBonus: Number(e.target.value)})} style={inputStyle} />
                                        <div style={{ fontSize: '10px', color: theme.textMuted, marginTop: '2px' }}>On customer's birthday</div>
                                    </div>
                                </div>
                            </div>

                            {/* Redemption */}
                            <div style={{ marginBottom: '20px' }}>
                                <div style={{ fontSize: '13px', fontWeight: '600', color: theme.textSecondary, marginBottom: '12px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>üí∞ Redemption</div>
                                <div>
                                    <label style={labelStyle}>Redeem Rate ({getBrandingForReceipts().currencySymbol || 'KES'} per Point)</label>
                                    <input type="number" min="0" step="0.01" value={settingsFormData.redeemRate} onChange={(e) => setSettingsFormData({...settingsFormData, redeemRate: Number(e.target.value)})} style={inputStyle} />
                                    <div style={{ fontSize: '10px', color: theme.textMuted, marginTop: '2px' }}>Value of each point when redeemed (e.g., 0.1 = {getBrandingForReceipts().currencySymbol || 'KES'} 0.10 per point)</div>
                                </div>
                            </div>

                            {/* Reward Settings Section */}
                            <div style={{ borderTop: `1px solid ${theme.border}`, paddingTop: '20px' }}>
                                <div style={{ marginBottom: '16px', padding: '14px', backgroundColor: '#fef3c7', border: '1px solid #fde68a', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                    <div>
                                        <div style={{ fontWeight: '500', color: '#92400e' }}>üéÅ Enable Reward System</div>
                                        <div style={{ fontSize: '12px', color: '#a16207' }}>Auto-reward customers at threshold</div>
                                    </div>
                                    <button
                                        onClick={() => setSettingsFormData({...settingsFormData, rewardEnabled: !settingsFormData.rewardEnabled})}
                                        style={{ width: '50px', height: '26px', backgroundColor: settingsFormData.rewardEnabled ? '#f59e0b' : theme.border, border: 'none', cursor: 'pointer', position: 'relative' }}
                                    >
                                        <span style={{ position: 'absolute', width: '20px', height: '20px', backgroundColor: 'white', top: '3px', left: settingsFormData.rewardEnabled ? '27px' : '3px', transition: 'left 0.2s' }}></span>
                                    </button>
                                </div>

                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px', marginBottom: '16px' }}>
                                    <div>
                                        <label style={labelStyle}>Reward Threshold (Points)</label>
                                        <input type="number" min="1" step="1" value={settingsFormData.rewardThreshold || 20} onChange={(e) => setSettingsFormData({...settingsFormData, rewardThreshold: Number(e.target.value)})} style={inputStyle} />
                                        <div style={{ fontSize: '10px', color: theme.textMuted, marginTop: '2px' }}>Points needed for reward</div>
                                    </div>
                                    <div>
                                        <label style={labelStyle}>Reward Type</label>
                                        <select 
                                            value={settingsFormData.rewardType || 'Free Basic Wash'} 
                                            onChange={(e) => setSettingsFormData({...settingsFormData, rewardType: e.target.value})} 
                                            style={inputStyle}
                                        >
                                            <option value="Free Basic Wash">Free Basic Wash</option>
                                            <option value="Free Premium Wash">Free Premium Wash</option>
                                            <option value="Free Interior Clean">Free Interior Clean</option>
                                            <option value="50% Off Next Wash">50% Off Next Wash</option>
                                            <option value="Free Wax Treatment">Free Wax Treatment</option>
                                            <option value="Free Air Freshener">Free Air Freshener</option>
                                            <option value={`${getBrandingForReceipts().currencySymbol || 'KES'} 500 Voucher`}>{getBrandingForReceipts().currencySymbol || 'KES'} 500 Voucher</option>
                                            <option value={`${getBrandingForReceipts().currencySymbol || 'KES'} 1000 Voucher`}>{getBrandingForReceipts().currencySymbol || 'KES'} 1000 Voucher</option>
                                            <option value="Custom Reward">Custom Reward</option>
                                        </select>
                                    </div>
                                </div>

                                <div style={{ marginBottom: '16px' }}>
                                    <label style={labelStyle}>Reward Message (SMS/Notification)</label>
                                    <textarea 
                                        value={settingsFormData.rewardMessage || ''} 
                                        onChange={(e) => setSettingsFormData({...settingsFormData, rewardMessage: e.target.value})} 
                                        style={{ ...inputStyle, minHeight: '80px', resize: 'vertical' }} 
                                        placeholder="Congratulations! You have earned {points} points..."
                                    />
                                    <div style={{ fontSize: '10px', color: theme.textMuted, marginTop: '4px' }}>
                                        Use <code style={{ backgroundColor: theme.bgTertiary, padding: '1px 4px' }}>{'{points}'}</code> for points, 
                                        <code style={{ backgroundColor: theme.bgTertiary, padding: '1px 4px', marginLeft: '4px' }}>{'{name}'}</code> for customer name,
                                        <code style={{ backgroundColor: theme.bgTertiary, padding: '1px 4px', marginLeft: '4px' }}>{'{reward}'}</code> for reward type
                                    </div>
                                </div>

                                <div style={{ padding: '12px', backgroundColor: theme.bgTertiary, fontSize: '12px', color: theme.textSecondary }}>
                                    <strong>How it works:</strong> When a customer reaches {settingsFormData.rewardThreshold || 20} points, they appear in the "Loyalty Rewards" tab. You can then issue a "{settingsFormData.rewardType || 'Free Basic Wash'}" and track when it's delivered. Points are deducted after delivery.
                                </div>
                            </div>
                        </div>
                        <div style={{ padding: '20px', borderTop: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'flex-end', gap: '10px' }}>
                            <button onClick={() => setShowLoyaltySettingsModal(false)} style={{ padding: '10px 20px', backgroundColor: theme.bgTertiary, color: theme.text, border: `1px solid ${theme.border}`, cursor: 'pointer', fontSize: '14px' }}>Cancel</button>
                            <button onClick={handleSaveLoyaltySettings} disabled={actionLoading} style={{ padding: '10px 20px', backgroundColor: '#3b82f6', color: 'white', border: 'none', cursor: 'pointer', fontSize: '14px', fontWeight: '500', opacity: actionLoading ? 0.7 : 1 }}>
                                {actionLoading ? 'Saving...' : 'Save Settings'}
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* Reward Issue/Deliver Modal */}
            {showRewardModal && rewardCustomer && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: theme.modalOverlay, display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000, padding: '20px' }}>
                    <div style={{ backgroundColor: theme.bg, width: '100%', maxWidth: '450px', maxHeight: '90vh', overflow: 'auto', boxShadow: '0 25px 50px -12px rgba(0,0,0,0.25)' }}>
                        <div style={{ padding: '20px', borderBottom: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <h2 style={{ margin: 0, fontSize: '18px', fontWeight: '600', color: theme.text }}>
                                {rewardCustomer.pendingReward ? '‚úÖ Deliver Reward' : 'üéÅ Issue Reward'}
                            </h2>
                            <button onClick={() => { setShowRewardModal(false); setRewardCustomer(null); }} style={{ background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer', color: theme.textMuted }}>√ó</button>
                        </div>
                        <div style={{ padding: '20px' }}>
                            {/* Customer Info */}
                            <div style={{ marginBottom: '20px', padding: '16px', backgroundColor: theme.bgTertiary, border: `1px solid ${theme.border}` }}>
                                <div style={{ fontWeight: '600', fontSize: '16px', color: theme.text, marginBottom: '4px' }}>{rewardCustomer.name}</div>
                                <div style={{ fontSize: '13px', color: theme.textMuted, marginBottom: '12px' }}>{rewardCustomer.phone}</div>
                                <div style={{ display: 'flex', gap: '12px' }}>
                                    <div style={{ flex: 1, textAlign: 'center', padding: '10px', backgroundColor: theme.bg, border: `1px solid ${theme.border}` }}>
                                        <div style={{ fontSize: '20px', fontWeight: '700', color: '#f59e0b' }}>{rewardCustomer.loyaltyPoints || 0}</div>
                                        <div style={{ fontSize: '10px', color: theme.textMuted }}>Current Points</div>
                                    </div>
                                    <div style={{ flex: 1, textAlign: 'center', padding: '10px', backgroundColor: theme.bg, border: `1px solid ${theme.border}` }}>
                                        <div style={{ fontSize: '20px', fontWeight: '700', color: theme.text }}>{rewardCustomer.totalVisits || 0}</div>
                                        <div style={{ fontSize: '10px', color: theme.textMuted }}>Total Visits</div>
                                    </div>
                                </div>
                            </div>

                            {/* Reward Details */}
                            <div style={{ marginBottom: '20px', padding: '16px', backgroundColor: '#fef3c7', border: '1px solid #fde68a' }}>
                                <div style={{ fontSize: '12px', color: '#92400e', marginBottom: '8px', fontWeight: '600' }}>REWARD</div>
                                <div style={{ fontSize: '18px', fontWeight: '600', color: '#78350f', marginBottom: '8px' }}>
                                    üéÅ {rewardCustomer.pendingReward?.type || loyaltySettings.rewardType}
                                </div>
                                {rewardCustomer.pendingReward && (
                                    <div style={{ fontSize: '12px', color: '#92400e' }}>
                                        Issued: {new Date(rewardCustomer.pendingReward.issuedAt).toLocaleDateString()}
                                    </div>
                                )}
                            </div>

                            {/* Message Preview */}
                            <div style={{ marginBottom: '20px' }}>
                                <div style={{ fontSize: '12px', color: theme.textMuted, marginBottom: '8px' }}>Message to Customer:</div>
                                <div style={{ padding: '12px', backgroundColor: theme.bgTertiary, border: `1px solid ${theme.border}`, fontSize: '13px', color: theme.text, lineHeight: '1.5' }}>
                                    {getRewardMessage(rewardCustomer)}
                                </div>
                            </div>

                            {!rewardCustomer.pendingReward && (
                                <div style={{ padding: '12px', backgroundColor: '#dbeafe', border: '1px solid #bfdbfe', fontSize: '12px', color: '#1e40af' }}>
                                    <strong>Note:</strong> Issuing this reward will mark it as pending. You can then send an SMS to notify the customer and mark it as delivered when they redeem it.
                                </div>
                            )}

                            {rewardCustomer.pendingReward && (
                                <div style={{ padding: '12px', backgroundColor: '#d1fae5', border: '1px solid #a7f3d0', fontSize: '12px', color: '#065f46' }}>
                                    <strong>Note:</strong> Marking as delivered will deduct <strong>{loyaltySettings.rewardThreshold || 20} points</strong> from the customer's balance and record this reward in their history.
                                </div>
                            )}
                        </div>
                        <div style={{ padding: '20px', borderTop: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'space-between', gap: '10px' }}>
                            <button onClick={() => { window.location.href = `sms:${rewardCustomer.phone}?body=${encodeURIComponent(getRewardMessage(rewardCustomer))}`; }} style={{ padding: '10px 16px', backgroundColor: '#3b82f6', color: 'white', border: 'none', cursor: 'pointer', fontSize: '14px', fontWeight: '500' }}>
                                üì± Send SMS
                            </button>
                            <div style={{ display: 'flex', gap: '10px' }}>
                                <button onClick={() => { setShowRewardModal(false); setRewardCustomer(null); }} style={{ padding: '10px 20px', backgroundColor: theme.bgTertiary, color: theme.text, border: `1px solid ${theme.border}`, cursor: 'pointer', fontSize: '14px' }}>Cancel</button>
                                {!rewardCustomer.pendingReward ? (
                                    <button onClick={() => handleIssueReward(rewardCustomer)} disabled={actionLoading} style={{ padding: '10px 20px', backgroundColor: '#f59e0b', color: 'white', border: 'none', cursor: 'pointer', fontSize: '14px', fontWeight: '500', opacity: actionLoading ? 0.7 : 1 }}>
                                        {actionLoading ? 'Issuing...' : 'üéÅ Issue Reward'}
                                    </button>
                                ) : (
                                    <button onClick={() => handleDeliverReward(rewardCustomer)} disabled={actionLoading} style={{ padding: '10px 20px', backgroundColor: '#10b981', color: 'white', border: 'none', cursor: 'pointer', fontSize: '14px', fontWeight: '500', opacity: actionLoading ? 0.7 : 1 }}>
                                        {actionLoading ? 'Processing...' : '‚úÖ Mark Delivered'}
                                    </button>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* Receipt Modal */}
            {showReceiptModal && receiptData && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: theme.modalOverlay, display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000, padding: '20px' }}>
                    <div style={{ backgroundColor: theme.bg, width: '100%', maxWidth: '400px', maxHeight: '90vh', overflow: 'auto', boxShadow: '0 25px 50px -12px rgba(0,0,0,0.25)' }}>
                        <div style={{ padding: '20px', borderBottom: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <h2 style={{ margin: 0, fontSize: '18px', fontWeight: '600', color: theme.text }}>üßæ Receipt</h2>
                            <button onClick={() => setShowReceiptModal(false)} style={{ background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer', color: theme.textMuted }}>√ó</button>
                        </div>
                        
                        {/* Receipt Content */}
                        <div id="receipt-content" style={{ padding: '20px' }}>
                            <div className="header" style={{ textAlign: 'center', borderBottom: '2px dashed #ccc', paddingBottom: '15px', marginBottom: '15px' }}>
                                <div className="company" style={{ fontSize: '22px', fontWeight: 'bold', color: theme.text }}>{getBrandingForReceipts().companyName}</div>
                                <div className="tagline" style={{ fontSize: '12px', color: theme.textMuted }}>{getBrandingForReceipts().tagline || 'Car Wash & Auto Services'}</div>
                                <div style={{ fontSize: '11px', color: theme.textMuted, marginTop: '8px' }}>Receipt #{receiptData.receiptNumber}</div>
                                <div style={{ fontSize: '11px', color: theme.textMuted }}>{new Date(receiptData.date).toLocaleString()}</div>
                            </div>
                            
                            <div className="section" style={{ marginBottom: '15px' }}>
                                <div style={{ fontSize: '11px', color: theme.textMuted, marginBottom: '8px', textTransform: 'uppercase', letterSpacing: '1px' }}>Customer Details</div>
                                <div style={{ fontSize: '14px', fontWeight: '500', color: theme.text }}>{receiptData.customer.name}</div>
                                <div style={{ fontSize: '13px', color: theme.textSecondary }}>{receiptData.customer.phone}</div>
                                {receiptData.customer.email && <div style={{ fontSize: '13px', color: theme.textSecondary }}>{receiptData.customer.email}</div>}
                            </div>
                            
                            <div className="section" style={{ marginBottom: '15px', paddingTop: '15px', borderTop: '1px dashed #ccc' }}>
                                <div style={{ fontSize: '11px', color: theme.textMuted, marginBottom: '8px', textTransform: 'uppercase', letterSpacing: '1px' }}>Vehicle</div>
                                <div style={{ fontSize: '16px', fontWeight: '600', color: theme.text }}>{receiptData.vehicle.plateNumber}</div>
                                <div style={{ fontSize: '13px', color: theme.textSecondary }}>
                                    {[receiptData.vehicle.make, receiptData.vehicle.model, receiptData.vehicle.color].filter(Boolean).join(' ‚Ä¢ ') || 'N/A'}
                                </div>
                            </div>
                            
                            <div className="section" style={{ marginBottom: '15px', paddingTop: '15px', borderTop: '1px dashed #ccc' }}>
                                <div style={{ fontSize: '11px', color: theme.textMuted, marginBottom: '8px', textTransform: 'uppercase', letterSpacing: '1px' }}>Service</div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                    <span style={{ fontSize: '14px', color: theme.text }}>{receiptData.service.name}</span>
                                    <span style={{ fontSize: '16px', fontWeight: '600', color: theme.text }}>{getBrandingForReceipts().currencySymbol || 'KES'} {(receiptData.service.price || 0).toFixed(2)}</span>
                                </div>
                            </div>
                            
                            <div className="divider" style={{ borderTop: '2px solid #333', margin: '15px 0' }}></div>
                            
                            <div className="total-row" style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', fontSize: '18px', fontWeight: 'bold' }}>
                                <span style={{ color: theme.text }}>TOTAL</span>
                                <span style={{ color: theme.text }}>{getBrandingForReceipts().currencySymbol || 'KES'} {(receiptData.service.price || 0).toFixed(2)}</span>
                            </div>
                            
                            {/* Loyalty Points Section */}
                            {receiptData.loyaltyEnabled && (
                                <div style={{ marginTop: '15px', borderTop: '2px dashed #ccc', paddingTop: '15px' }}>
                                    <div style={{ fontSize: '11px', color: theme.textMuted, marginBottom: '10px', textTransform: 'uppercase', letterSpacing: '1px', textAlign: 'center' }}>‚≠ê Loyalty Program</div>
                                    
                                    {/* Points Summary */}
                                    <div style={{ backgroundColor: theme.bgTertiary, padding: '12px', marginBottom: '10px' }}>
                                        <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '8px' }}>
                                            <span style={{ fontSize: '12px', color: theme.textSecondary }}>Current Balance:</span>
                                            <span style={{ fontSize: '14px', fontWeight: '600', color: theme.text }}>{receiptData.currentPoints} pts</span>
                                        </div>
                                        {receiptData.pointsEarned > 0 && (
                                            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '8px' }}>
                                                <span style={{ fontSize: '12px', color: theme.textSecondary }}>Points This Visit:</span>
                                                <span style={{ fontSize: '14px', fontWeight: '600', color: '#22c55e' }}>+{receiptData.pointsEarned} pts</span>
                                            </div>
                                        )}
                                        <div style={{ display: 'flex', justifyContent: 'space-between', borderTop: `1px solid ${theme.border}`, paddingTop: '8px' }}>
                                            <span style={{ fontSize: '12px', color: theme.textSecondary }}>New Balance:</span>
                                            <span style={{ fontSize: '16px', fontWeight: '700', color: '#f59e0b' }}>{receiptData.totalPoints} pts</span>
                                        </div>
                                    </div>
                                    
                                    {/* Total Visits */}
                                    <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: '12px', marginBottom: '8px', padding: '0 4px' }}>
                                        <span style={{ color: theme.textMuted }}>Total Visits:</span>
                                        <span style={{ color: theme.text, fontWeight: '500' }}>{receiptData.totalVisits + 1}</span>
                                    </div>
                                    
                                    {/* Progress to Reward */}
                                    {!receiptData.qualifiesForReward && receiptData.pointsToNextReward > 0 && (
                                        <div style={{ backgroundColor: '#fef3c7', padding: '10px', textAlign: 'center', marginTop: '10px' }}>
                                            <div style={{ fontSize: '11px', color: '#92400e' }}>
                                                üéØ {Math.max(0, receiptData.pointsToNextReward - receiptData.pointsEarned)} more point{Math.max(0, receiptData.pointsToNextReward - receiptData.pointsEarned) !== 1 ? 's' : ''} to earn a reward!
                                            </div>
                                            <div style={{ marginTop: '6px', backgroundColor: '#fde68a', height: '8px', overflow: 'hidden' }}>
                                                <div style={{ 
                                                    width: `${Math.min(100, (receiptData.totalPoints / receiptData.rewardThreshold) * 100)}%`, 
                                                    height: '100%', 
                                                    backgroundColor: '#f59e0b',
                                                    transition: 'width 0.3s'
                                                }}></div>
                                            </div>
                                            <div style={{ fontSize: '10px', color: '#92400e', marginTop: '4px' }}>{receiptData.totalPoints} / {receiptData.rewardThreshold} points</div>
                                        </div>
                                    )}
                                    
                                    {/* Qualifies for Reward */}
                                    {receiptData.qualifiesForReward && !receiptData.pendingReward && (
                                        <div style={{ backgroundColor: '#dcfce7', padding: '12px', textAlign: 'center', marginTop: '10px' }}>
                                            <div style={{ fontSize: '24px', marginBottom: '4px' }}>üéÅ</div>
                                            <div style={{ fontSize: '14px', fontWeight: '600', color: '#166534' }}>Congratulations!</div>
                                            <div style={{ fontSize: '12px', color: '#15803d' }}>You qualify for a <strong>{receiptData.rewardType}</strong>!</div>
                                            <div style={{ fontSize: '11px', color: '#166534', marginTop: '4px' }}>Please ask staff to redeem your reward.</div>
                                        </div>
                                    )}
                                    
                                    {/* Pending Reward Status */}
                                    {receiptData.pendingReward && (
                                        <div style={{ backgroundColor: '#dbeafe', padding: '12px', textAlign: 'center', marginTop: '10px' }}>
                                            <div style={{ fontSize: '24px', marginBottom: '4px' }}>üéâ</div>
                                            <div style={{ fontSize: '14px', fontWeight: '600', color: '#1e40af' }}>Reward Pending</div>
                                            <div style={{ fontSize: '12px', color: '#1d4ed8' }}>
                                                {receiptData.pendingReward.rewardType} - Issued {new Date(receiptData.pendingReward.issuedAt).toLocaleDateString()}
                                            </div>
                                            <div style={{ fontSize: '11px', color: '#1e40af', marginTop: '4px' }}>
                                                Status: {receiptData.pendingReward.delivered ? '‚úÖ Delivered' : '‚è≥ Awaiting Delivery'}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}
                            
                            <div className="footer" style={{ textAlign: 'center', marginTop: '20px', paddingTop: '15px', borderTop: '2px dashed #ccc', fontSize: '11px', color: theme.textMuted }}>
                                <div>Thank you for choosing {getBrandingForReceipts().companyName}!</div>
                                <div style={{ marginTop: '4px' }}>We appreciate your business</div>
                            </div>
                        </div>
                        
                        <div style={{ padding: '20px', borderTop: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'flex-end', gap: '10px' }}>
                            <button onClick={() => setShowReceiptModal(false)} style={{ padding: '10px 20px', backgroundColor: theme.bgTertiary, color: theme.text, border: `1px solid ${theme.border}`, cursor: 'pointer', fontSize: '14px' }}>Close</button>
                            <button onClick={handlePrintReceipt} style={{ padding: '10px 20px', backgroundColor: '#3b82f6', color: 'white', border: 'none', cursor: 'pointer', fontSize: '14px', fontWeight: '500', display: 'flex', alignItems: 'center', gap: '6px' }}>
                                üñ®Ô∏è Print Receipt
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* Import from Intake Modal */}
            {showImportModal && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: theme.modalOverlay, display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000, padding: '20px' }}>
                    <div style={{ backgroundColor: theme.bg, width: '100%', maxWidth: '550px', maxHeight: '90vh', overflow: 'auto', boxShadow: '0 25px 50px -12px rgba(0,0,0,0.25)' }}>
                        <div style={{ padding: '20px', borderBottom: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <div>
                                <h2 style={{ margin: 0, fontSize: '18px', fontWeight: '600', color: theme.text }}>üì• Import from Vehicle Intake</h2>
                                <div style={{ fontSize: '13px', color: theme.textMuted, marginTop: '4px' }}>Add clients from intake records as customers with loyalty points</div>
                            </div>
                            <button onClick={() => setShowImportModal(false)} style={{ background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer', color: theme.textMuted }}>√ó</button>
                        </div>
                        <div style={{ padding: '20px' }}>
                            {getAvailableIntakeClients().length === 0 ? (
                                <div style={{ padding: '40px 20px', textAlign: 'center', color: theme.textMuted }}>
                                    <div style={{ fontSize: '48px', marginBottom: '16px' }}>‚úÖ</div>
                                    <div style={{ fontSize: '16px', fontWeight: '500', color: theme.text, marginBottom: '8px' }}>All Caught Up!</div>
                                    <div style={{ fontSize: '13px' }}>All clients from vehicle intake have been imported as customers.</div>
                                </div>
                            ) : (
                                <>
                                    <div style={{ marginBottom: '16px' }}>
                                        <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: theme.textSecondary }}>Select Client to Import</label>
                                        <select
                                            value={selectedIntakeClient ? JSON.stringify(selectedIntakeClient) : ''}
                                            onChange={(e) => setSelectedIntakeClient(e.target.value ? JSON.parse(e.target.value) : null)}
                                            style={{ width: '100%', padding: '12px', border: `1px solid ${theme.border}`, fontSize: '14px', backgroundColor: theme.inputBg, color: theme.text, cursor: 'pointer' }}
                                        >
                                            <option value="">-- Select a client --</option>
                                            {getAvailableIntakeClients().map((client, idx) => (
                                                <option key={idx} value={JSON.stringify(client)}>
                                                    {client.name || 'Unknown'} - {client.phone || 'No phone'} ({client.totalVisits} visit{client.totalVisits !== 1 ? 's' : ''})
                                                </option>
                                            ))}
                                        </select>
                                    </div>

                                    {selectedIntakeClient && (
                                        <div style={{ backgroundColor: theme.bgTertiary, padding: '16px', marginBottom: '16px', border: `1px solid ${theme.border}` }}>
                                            <div style={{ fontSize: '14px', fontWeight: '600', color: theme.text, marginBottom: '12px' }}>Client Preview</div>
                                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px', marginBottom: '12px' }}>
                                                <div>
                                                    <div style={{ fontSize: '11px', color: theme.textMuted, marginBottom: '2px' }}>Name</div>
                                                    <div style={{ fontSize: '14px', color: theme.text, fontWeight: '500' }}>{selectedIntakeClient.name || '-'}</div>
                                                </div>
                                                <div>
                                                    <div style={{ fontSize: '11px', color: theme.textMuted, marginBottom: '2px' }}>Phone</div>
                                                    <div style={{ fontSize: '14px', color: theme.text }}>{selectedIntakeClient.phone || '-'}</div>
                                                </div>
                                            </div>
                                            
                                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px', marginBottom: '12px' }}>
                                                <div style={{ backgroundColor: theme.bg, padding: '12px', textAlign: 'center', border: `1px solid ${theme.border}` }}>
                                                    <div style={{ fontSize: '20px', fontWeight: '600', color: '#3b82f6' }}>{selectedIntakeClient.totalVisits}</div>
                                                    <div style={{ fontSize: '11px', color: theme.textMuted }}>Total Visits</div>
                                                </div>
                                                <div style={{ backgroundColor: theme.bg, padding: '12px', textAlign: 'center', border: `1px solid ${theme.border}` }}>
                                                    <div style={{ fontSize: '20px', fontWeight: '600', color: '#f59e0b' }}>
                                                        {loyaltySettings.enabled ? (selectedIntakeClient.totalVisits * loyaltySettings.pointsPerVisit) + loyaltySettings.welcomeBonus : 0}
                                                    </div>
                                                    <div style={{ fontSize: '11px', color: theme.textMuted }}>Points to Award</div>
                                                </div>
                                            </div>

                                            {selectedIntakeClient.vehicles?.length > 0 && (
                                                <div>
                                                    <div style={{ fontSize: '11px', color: theme.textMuted, marginBottom: '6px' }}>Vehicles ({selectedIntakeClient.vehicles.length})</div>
                                                    <div style={{ display: 'flex', flexWrap: 'wrap', gap: '6px' }}>
                                                        {selectedIntakeClient.vehicles.map((v, idx) => (
                                                            <span key={idx} style={{ padding: '4px 8px', backgroundColor: theme.bg, fontSize: '12px', fontWeight: '500', color: theme.text, border: `1px solid ${theme.border}` }}>
                                                                üöó {v.plateNumber}
                                                            </span>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}

                                            {loyaltySettings.enabled && (
                                                <div style={{ marginTop: '12px', padding: '10px', backgroundColor: '#fef3c7', fontSize: '12px', color: '#92400e' }}>
                                                    üí° <strong>Points calculation:</strong> {selectedIntakeClient.totalVisits} visits √ó {loyaltySettings.pointsPerVisit} pts/visit + {loyaltySettings.welcomeBonus} welcome bonus = <strong>{(selectedIntakeClient.totalVisits * loyaltySettings.pointsPerVisit) + loyaltySettings.welcomeBonus} points</strong>
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </>
                            )}
                        </div>
                        <div style={{ padding: '20px', borderTop: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'flex-end', gap: '10px' }}>
                            <button onClick={() => setShowImportModal(false)} style={{ padding: '10px 20px', backgroundColor: theme.bgTertiary, color: theme.text, border: `1px solid ${theme.border}`, cursor: 'pointer', fontSize: '14px' }}>Cancel</button>
                            {getAvailableIntakeClients().length > 0 && (
                                <button 
                                    onClick={handleImportFromIntake} 
                                    disabled={actionLoading || !selectedIntakeClient} 
                                    style={{ padding: '10px 20px', backgroundColor: selectedIntakeClient ? '#7c3aed' : theme.bgTertiary, color: selectedIntakeClient ? 'white' : theme.textMuted, border: 'none', cursor: selectedIntakeClient ? 'pointer' : 'not-allowed', fontSize: '14px', fontWeight: '500', opacity: actionLoading ? 0.7 : 1 }}
                                >
                                    {actionLoading ? 'Importing...' : 'üì• Import as Customer'}
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            )}

            {/* Alert Modal */}
            <AlertModal
                isOpen={alertModal.isOpen}
                onClose={closeAlert}
                title={alertModal.title}
                message={alertModal.message}
                type={alertModal.type}
                onConfirm={alertModal.onConfirm}
                showCancel={alertModal.showCancel}
            />
        </div>
    );
}

// ==================== GARAGE MANAGEMENT MODULE ====================
function GarageManagement() {
    const { canCreate, canEdit, canDelete } = usePermissions();
    // State management
    const [queue, setQueue] = useState([]);
    const [jobs, setJobs] = useState([]);
    const [garageServices, setGarageServices] = useState([]);
    const [intakeVehicles, setIntakeVehicles] = useState([]);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState(null);
    const [actionLoading, setActionLoading] = useState(false);
    const [searchQuery, setSearchQuery] = useState('');
    const [statusFilter, setStatusFilter] = useState('all');
    const [activeTab, setActiveTab] = useState('queue'); // queue, jobs, completed
    const [showAddModal, setShowAddModal] = useState(false);
    const [showJobModal, setShowJobModal] = useState(false);
    const [showViewModal, setShowViewModal] = useState(false);
    const [showReceiptModal, setShowReceiptModal] = useState(false);
    const [showHistoryModal, setShowHistoryModal] = useState(false);
    const [showNotesModal, setShowNotesModal] = useState(false);
    const [showServicesModal, setShowServicesModal] = useState(false);
    const [showServiceFormModal, setShowServiceFormModal] = useState(false);
    const [editingService, setEditingService] = useState(null);
    
    // Alert modal state
    const [alertModal, setAlertModal] = useState({
        isOpen: false,
        title: '',
        message: '',
        type: 'info',
        onConfirm: null,
        showCancel: false
    });
    
    const showAlert = (title, message, type = 'info', onConfirm = null, showCancel = false) => {
        setAlertModal({ isOpen: true, title, message, type, onConfirm, showCancel });
    };
    
    const closeAlert = () => {
        setAlertModal(prev => ({ ...prev, isOpen: false }));
    };
    const [serviceFormData, setServiceFormData] = useState({
        name: '',
        category: 'maintenance',
        price: '',
        duration: '',
        description: ''
    });
    const [selectedItem, setSelectedItem] = useState(null);
    const [selectedIntakeVehicle, setSelectedIntakeVehicle] = useState('');
    const [intakeRecords, setIntakeRecords] = useState([]); // Vehicles assigned to bays
    const [showTransferModal, setShowTransferModal] = useState(false);
    const [transferVehicle, setTransferVehicle] = useState(null);
    const [transferServices, setTransferServices] = useState([]);
    const [transferNotes, setTransferNotes] = useState('');
    const [transferPriority, setTransferPriority] = useState('normal');
    const [technicianNotes, setTechnicianNotes] = useState('');
    const [currentPage, setCurrentPage] = useState(1);
    const [itemsPerPage, setItemsPerPage] = useState(10);
    const [isDark, setIsDark] = useState(document.documentElement.getAttribute('data-theme') === 'dark');
    const [staffList, setStaffList] = useState([]); // Staff for technician assignment
    const [showAssignTechModal, setShowAssignTechModal] = useState(false);
    const [selectedQueueItem, setSelectedQueueItem] = useState(null);
    const [selectedTechnician, setSelectedTechnician] = useState('');
    
    // Edit services modal state
    const [showEditServicesModal, setShowEditServicesModal] = useState(false);
    const [editServicesItem, setEditServicesItem] = useState(null);
    const [editServices, setEditServices] = useState([]);

    // Form data for adding to queue
    const [formData, setFormData] = useState({
        plateNumber: '',
        vehicleType: 'Sedan',
        customerName: '',
        customerPhone: '',
        services: [],
        notes: '',
        priority: 'normal',
        assignedTo: ''
    });

    // Listen for theme changes
    useEffect(() => {
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.attributeName === 'data-theme') {
                    setIsDark(document.documentElement.getAttribute('data-theme') === 'dark');
                }
            });
        });
        observer.observe(document.documentElement, { attributes: true });
        return () => observer.disconnect();
    }, []);

    // Theme colors
    const theme = {
        bg: isDark ? '#1e293b' : 'white',
        bgSecondary: isDark ? '#0f172a' : '#f8fafc',
        bgTertiary: isDark ? '#334155' : '#f1f5f9',
        text: isDark ? '#f1f5f9' : '#1e293b',
        textSecondary: isDark ? '#94a3b8' : '#64748b',
        textMuted: isDark ? '#64748b' : '#94a3b8',
        border: isDark ? '#334155' : '#e2e8f0',
        borderLight: isDark ? '#475569' : '#cbd5e1',
        cardShadow: isDark ? '0 1px 3px rgba(0,0,0,0.3)' : '0 1px 3px rgba(0,0,0,0.1)',
        modalOverlay: isDark ? 'rgba(0,0,0,0.7)' : 'rgba(0,0,0,0.5)',
        inputBg: isDark ? '#1e293b' : 'white',
        rowHoverBg: isDark ? '#334155' : '#f8fafc',
    };

    const VEHICLE_TYPES = ['Sedan', 'SUV', 'Truck', 'Van', 'Motorcycle', 'Bus', 'Other'];
    const PRIORITY_OPTIONS = [
        { id: 'low', name: 'Low', color: '#6b7280' },
        { id: 'normal', name: 'Normal', color: '#3b82f6' },
        { id: 'high', name: 'High', color: '#f59e0b' },
        { id: 'urgent', name: 'Urgent', color: '#ef4444' }
    ];

    // Initialize Firebase subscriptions - OPTIMIZED
    useEffect(() => {
        let mounted = true;
        let unsubQueue, unsubJobs, unsubGarageServices, unsubIntakeQueue, unsubIntakeRecords, unsubStaff;

        const initializeData = async () => {
            // Fast service detection with exponential backoff
            let services = window.FirebaseServices;
            let attempts = 0;
            let delay = 25;
            
            while (!services && attempts < 12 && mounted) {
                await new Promise(resolve => setTimeout(resolve, delay));
                services = window.FirebaseServices;
                attempts++;
                delay = Math.min(delay * 1.5, 100);
            }

            if (!services || !mounted) {
                if (mounted) {
                    setLoading(false);
                    setError('Firebase services not available. Please refresh.');
                }
                return;
            }

            // Set loading false early to show UI faster
            setLoading(false);

            try {
                // Subscribe to critical data first - garage queue and jobs in parallel
                const criticalPromises = [];
                
                // Garage queue - CRITICAL
                if (services.garageQueueService) {
                    criticalPromises.push(new Promise(resolve => {
                        unsubQueue = services.garageQueueService.subscribeToQueue(
                            (data) => {
                                if (mounted) setQueue(data);
                                resolve();
                            },
                            () => resolve()
                        );
                    }));
                }

                // Garage jobs - CRITICAL
                if (services.garageJobsService) {
                    criticalPromises.push(new Promise(resolve => {
                        unsubJobs = services.garageJobsService.subscribeToJobs(
                            (data) => {
                                if (mounted) setJobs(data);
                                resolve();
                            },
                            () => resolve()
                        );
                    }));
                }
                
                // Wait for critical data (max 500ms)
                await Promise.race([
                    Promise.all(criticalPromises),
                    new Promise(resolve => setTimeout(resolve, 500))
                ]);
                
                if (!mounted) return;

                // Non-critical subscriptions - load async in background
                // Garage services catalog
                if (services.garageServicesService) {
                    unsubGarageServices = services.garageServicesService.subscribeToServices(
                        (data) => { if (mounted) setGarageServices(data.filter(s => s.isActive !== false)); }
                    );
                }

                // Intake queue (for pulling vehicles)
                if (services.intakeQueueService) {
                    unsubIntakeQueue = services.intakeQueueService.subscribeToQueue(
                        (data) => { if (mounted) setIntakeVehicles(data); }
                    );
                }

                // Intake records (vehicles in bays)
                if (services.intakeRecordsService) {
                    unsubIntakeRecords = services.intakeRecordsService.subscribeToRecords(
                        (data) => {
                            if (mounted) {
                                const activeRecords = data.filter(r => r.status === 'in-progress');
                                setIntakeRecords(activeRecords);
                            }
                        }
                    );
                }

                // Staff list for technician assignment
                if (services.staffService?.subscribeToStaff) {
                    unsubStaff = services.staffService.subscribeToStaff((data) => {
                        if (mounted) setStaffList(data.filter(s => s.status === 'active'));
                    });
                }

            } catch (err) {
                console.error('Failed to initialize garage:', err);
                if (mounted) setError('Failed to initialize. Please refresh.');
            }
        };

        initializeData();

        return () => {
            mounted = false;
            if (unsubQueue) try { unsubQueue(); } catch(e) {}
            if (unsubJobs) try { unsubJobs(); } catch(e) {}
            if (unsubGarageServices) try { unsubGarageServices(); } catch(e) {}
            if (unsubIntakeQueue) try { unsubIntakeQueue(); } catch(e) {}
            if (unsubIntakeRecords) try { unsubIntakeRecords(); } catch(e) {}
            if (unsubStaff) try { unsubStaff(); } catch(e) {}
        };
    }, []);

    // Calculate stats
    const stats = {
        waiting: queue.length,
        inProgress: jobs.filter(j => j.status === 'in-progress').length,
        completedToday: jobs.filter(j => {
            if (j.status !== 'completed' || !j.completedAt) return false;
            const today = new Date();
            const completed = new Date(j.completedAt);
            return completed.toDateString() === today.toDateString();
        }).length,
        totalRevenue: jobs.filter(j => {
            if (j.status !== 'completed' || !j.completedAt) return false;
            const today = new Date();
            const completed = new Date(j.completedAt);
            return completed.toDateString() === today.toDateString();
        }).reduce((sum, j) => sum + (j.totalCost || 0), 0)
    };

    // Filter queue/jobs based on search and status
    const getFilteredData = () => {
        let data = [];
        if (activeTab === 'queue') {
            data = queue;
        } else if (activeTab === 'jobs') {
            data = jobs.filter(j => j.status === 'in-progress');
        } else {
            data = jobs.filter(j => j.status === 'completed');
        }

        // Search filter
        if (searchQuery.trim()) {
            const query = searchQuery.toLowerCase();
            data = data.filter(item =>
                item.plateNumber?.toLowerCase().includes(query) ||
                item.customerName?.toLowerCase().includes(query) ||
                item.customerPhone?.includes(query) ||
                item.vehicleType?.toLowerCase().includes(query)
            );
        }

        // Status filter for queue
        if (activeTab === 'queue' && statusFilter !== 'all') {
            data = data.filter(item => item.priority === statusFilter);
        }

        return data;
    };

    const filteredData = getFilteredData();

    // Pagination logic
    const totalItems = filteredData.length;
    const totalPages = Math.ceil(totalItems / itemsPerPage);
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const paginatedData = filteredData.slice(startIndex, endIndex);

    // Reset page when tab or filter changes
    useEffect(() => {
        setCurrentPage(1);
    }, [activeTab, searchQuery, statusFilter]);

    // Handle adding vehicle from intake to garage queue
    const handleAddFromIntake = async () => {
        if (!selectedIntakeVehicle) return;

        const services = window.FirebaseServices;
        if (!services?.garageQueueService) {
            setError('Services not available');
            return;
        }

        // Parse the selected value to determine source type
        const [sourceType, sourceId] = selectedIntakeVehicle.split(':');
        let vehicle = null;
        let isFromQueue = sourceType === 'queue';

        if (isFromQueue) {
            vehicle = intakeVehicles.find(v => v.id === sourceId);
            if (!vehicle) {
                setError('Vehicle not found in intake queue');
                return;
            }
        } else {
            vehicle = intakeRecords.find(v => v.id === sourceId);
            if (!vehicle) {
                setError('Vehicle not found in intake records');
                return;
            }
        }

        // Open the transfer modal to select services
        setTransferVehicle({
            ...vehicle,
            isFromQueue,
            sourceType
        });
        setTransferServices([]);
        setTransferNotes('');
        setTransferPriority('normal');
        setShowTransferModal(true);
    };

    // Complete the transfer after selecting services
    const handleConfirmTransfer = async () => {
        if (!transferVehicle) return;

        const services = window.FirebaseServices;
        if (!services?.garageQueueService) {
            setError('Services not available');
            return;
        }

        // Calculate total cost from selected services
        const totalCost = transferServices.reduce((sum, sId) => {
            const service = garageServices.find(s => s.id === sId);
            return sum + (service?.price || 0);
        }, 0);

        setActionLoading(true);
        try {
            // Add to garage queue with selected services
            const result = await services.garageQueueService.addToQueue({
                plateNumber: transferVehicle.plateNumber,
                vehicleType: transferVehicle.vehicleType,
                customerName: transferVehicle.customerName || '',
                customerPhone: transferVehicle.customerPhone || '',
                services: transferServices,
                notes: transferNotes || `From Vehicle Intake - ${transferVehicle.service?.name || transferVehicle.assignedBay || 'N/A'}`,
                priority: transferPriority,
                sourceId: transferVehicle.id,
                source: transferVehicle.isFromQueue ? 'intake-queue' : 'intake-bay',
                totalCost: totalCost,
                intakeTimeIn: transferVehicle.timeIn || new Date().toISOString()
            });

            if (result.success) {
                if (transferVehicle.isFromQueue && services.intakeQueueService) {
                    // Remove from intake queue
                    await services.intakeQueueService.removeFromQueue(transferVehicle.id);
                    console.log('‚úÖ Vehicle transferred from queue to garage:', transferVehicle.plateNumber);
                } else if (!transferVehicle.isFromQueue && services.intakeRecordsService) {
                    // Update record status to 'garage'
                    await services.intakeRecordsService.updateRecord(transferVehicle.id, { status: 'garage' });
                    console.log('‚úÖ Vehicle sent from bay to garage:', transferVehicle.plateNumber);
                }
            }
            
            setSelectedIntakeVehicle('');
            setShowTransferModal(false);
            setTransferVehicle(null);
            setTransferServices([]);
            setTransferNotes('');
            setTransferPriority('normal');
        } catch (err) {
            console.error('Transfer error:', err);
            setError('Failed to add vehicle to garage queue: ' + err.message);
        } finally {
            setActionLoading(false);
        }
    };

    // Toggle service selection for transfer
    const toggleTransferService = (serviceId) => {
        setTransferServices(prev => 
            prev.includes(serviceId)
                ? prev.filter(id => id !== serviceId)
                : [...prev, serviceId]
        );
    };

    // Handle adding new vehicle directly to queue
    const handleAddToQueue = async () => {
        if (!formData.plateNumber.trim()) {
            setError('Plate number is required');
            return;
        }

        const services = window.FirebaseServices;
        if (!services?.garageQueueService) return;

        setActionLoading(true);
        try {
            await services.garageQueueService.addToQueue({
                ...formData,
                totalCost: formData.services.reduce((sum, sId) => {
                    const service = garageServices.find(s => s.id === sId);
                    return sum + (service?.price || 0);
                }, 0)
            });
            setFormData({
                plateNumber: '',
                vehicleType: 'Sedan',
                customerName: '',
                customerPhone: '',
                services: [],
                notes: '',
                priority: 'normal',
                assignedTo: ''
            });
            setShowAddModal(false);
        } catch (err) {
            setError('Failed to add vehicle to queue');
        } finally {
            setActionLoading(false);
        }
    };

    // Start job from queue - show technician selection first
    const handleStartJob = async (queueItem) => {
        setSelectedQueueItem(queueItem);
        setSelectedTechnician('');
        setShowAssignTechModal(true);
    };

    // Actually start the job with assigned technician
    const executeStartJob = async () => {
        if (!selectedQueueItem) return;
        
        const services = window.FirebaseServices;
        if (!services?.garageJobsService || !services?.garageQueueService) {
            setError('Services not available');
            return;
        }

        setActionLoading(true);
        try {
            // Create job in Firestore with assigned technician
            const result = await services.garageJobsService.createJob({
                plateNumber: selectedQueueItem.plateNumber,
                vehicleType: selectedQueueItem.vehicleType,
                customerName: selectedQueueItem.customerName || '',
                customerPhone: selectedQueueItem.customerPhone || '',
                services: selectedQueueItem.services || [],
                notes: selectedQueueItem.notes || '',
                priority: selectedQueueItem.priority || 'normal',
                totalCost: selectedQueueItem.totalCost || 0,
                source: selectedQueueItem.source || 'direct',
                assignedTo: selectedTechnician // Technician name for HR tracking
            });
            
            if (result.success) {
                console.log('‚úÖ Job created:', result.id, 'assigned to:', selectedTechnician);
                // Remove from queue after job is created
                await services.garageQueueService.removeFromQueue(selectedQueueItem.id);
                // Switch to jobs tab
                setActiveTab('jobs');
                setShowAssignTechModal(false);
                setSelectedQueueItem(null);
                setSelectedTechnician('');
            } else {
                setError('Failed to create job: ' + (result.error || 'Unknown error'));
            }
        } catch (err) {
            console.error('Start job error:', err);
            setError('Failed to start job: ' + err.message);
        } finally {
            setActionLoading(false);
        }
    };

    // Complete job
    const handleCompleteJob = async (job) => {
        const services = window.FirebaseServices;
        if (!services?.garageJobsService) {
            setError('Services not available');
            return;
        }

        if (!job.id) {
            setError('Invalid job - no ID found');
            return;
        }

        setActionLoading(true);
        try {
            // Calculate total cost from services - handle both service objects and IDs
            let totalCost = 0;
            let serviceDetails = [];
            
            if (job.services && job.services.length > 0) {
                serviceDetails = job.services.map(svc => {
                    // Handle both service objects (from intake) and service IDs
                    if (typeof svc === 'object') {
                        return { 
                            id: svc.id, 
                            name: svc.name || 'Service', 
                            price: parseFloat(svc.price) || 0 
                        };
                    }
                    const service = garageServices.find(s => s.id === svc);
                    return { 
                        id: svc, 
                        name: service?.name || 'Service', 
                        price: service?.price || 0 
                    };
                });
                totalCost = serviceDetails.reduce((sum, s) => sum + s.price, 0);
            }
            
            // Use job.totalCost if available and no services calculated
            if (totalCost === 0 && job.totalCost) {
                totalCost = parseFloat(job.totalCost) || 0;
            }

            console.log('Completing job:', job.id, 'with total:', totalCost);

            const result = await services.garageJobsService.completeJob(job.id, {
                totalCost: totalCost,
                completedServices: serviceDetails
            });
            
            console.log('Complete result:', result);

            if (result.success) {
                // Try to find and update the intake record for this vehicle
                let intakeRecordId = null;
                if (services.intakeRecordsService && job.plateNumber) {
                    try {
                        const recordsResult = await services.intakeRecordsService.getRecords();
                        if (recordsResult.success) {
                            // Find matching record by plate number that's in garage status
                            const matchingRecord = recordsResult.data.find(r => 
                                r.plateNumber === job.plateNumber && 
                                (r.status === 'garage' || r.status === 'in-progress')
                            );
                            if (matchingRecord) {
                                intakeRecordId = matchingRecord.id;
                                // Update the intake record status to completed
                                await services.intakeRecordsService.updateRecord(intakeRecordId, {
                                    status: 'completed',
                                    timeOut: new Date().toISOString(),
                                    garageCompletedAt: new Date().toISOString(),
                                    garageTotalCost: totalCost
                                });
                                console.log('Updated intake record:', intakeRecordId);
                            }
                        }
                    } catch (findErr) {
                        console.warn('Could not find/update intake record:', findErr);
                    }
                }
                
                // Create invoice for the completed job - sends to billing as pending
                if (services.billingService && totalCost > 0) {
                    await services.billingService.createInvoice({
                        source: 'garage',
                        jobId: job.id,
                        plateNumber: job.plateNumber,
                        vehicleType: job.vehicleType,
                        customerName: job.customerName || 'Walk-in',
                        customerPhone: job.customerPhone || '',
                        services: serviceDetails,
                        totalAmount: totalCost,
                        notes: job.notes || job.technicianNotes || '',
                        garageRecordId: intakeRecordId,
                        startTime: job.startedAt || job.addedAt || new Date().toISOString(),
                        completedAt: new Date().toISOString()
                    });
                    console.log('‚úÖ Invoice created for garage job:', job.id, 'Amount:', totalCost);
                }
                
                // Log activity
                if (services.activityService) {
                    const currentUser = window.currentUserProfile;
                    services.activityService.logActivity({
                        type: 'garage',
                        action: 'Garage Job Completed',
                        details: `${job.plateNumber} - ${serviceDetails.map(s => s.name).join(', ') || 'Garage Service'}`,
                        amount: totalCost,
                        status: 'success',
                        loggedBy: (currentUser && currentUser.displayName) || 'System',
                        loggedByEmail: (currentUser && currentUser.email) || null,
                        loggedByRole: (currentUser && currentUser.role) || null
                    });
                }
                
                showAlert(
                    '‚úÖ Job Completed',
                    `${job.plateNumber} garage job completed!\nTotal: ${getBrandingForReceipts().currencySymbol || 'KSh'} ${totalCost.toLocaleString()}\n\nInvoice sent to Billing for payment.`,
                    'success'
                );
                
                // Wait for Firebase to sync, then switch tab
                setTimeout(() => {
                    setActiveTab('completed');
                    setActionLoading(false);
                }, 500);
            } else {
                setError('Failed to complete job: ' + (result.error || 'Unknown error'));
                setActionLoading(false);
            }
        } catch (err) {
            console.error('Complete job error:', err);
            setError('Failed to complete job: ' + err.message);
            setActionLoading(false);
        }
    };

    // View item details
    const handleViewItem = (item) => {
        setSelectedItem(item);
        setShowViewModal(true);
    };

    // Show receipt for item
    const handleShowReceipt = (item) => {
        setSelectedItem(item);
        setShowReceiptModal(true);
    };

    // Show job history
    const handleShowHistory = (item) => {
        setSelectedItem(item);
        setShowHistoryModal(true);
    };

    // Show notes modal for technician
    const handleShowNotes = (item) => {
        setSelectedItem(item);
        setTechnicianNotes(item.technicianNotes || '');
        setShowNotesModal(true);
    };

    // Save technician notes
    const handleSaveNotes = async () => {
        const services = window.FirebaseServices;
        if (!services?.garageJobsService || !selectedItem) return;

        setActionLoading(true);
        try {
            await services.garageJobsService.updateJob(selectedItem.id, {
                technicianNotes: technicianNotes,
                lastUpdated: new Date().toISOString()
            });
            setShowNotesModal(false);
            setSelectedItem(null);
            setTechnicianNotes('');
        } catch (err) {
            setError('Failed to save notes: ' + err.message);
        } finally {
            setActionLoading(false);
        }
    };

    // Mark payment as cleared for a completed job
    const handleMarkPaid = async (job) => {
        const services = window.FirebaseServices;
        if (!services?.garageJobsService) {
            setError('Services not available');
            return;
        }

        setActionLoading(true);
        try {
            const currentUser = window.currentUserProfile;
            const result = await services.garageJobsService.updatePaymentStatus(job.id, 'cleared', {
                paymentMethod: 'cash',
                paidBy: currentUser?.displayName || 'System'
            });

            if (result.success) {
                // Also update the corresponding invoice if exists
                if (services.billingService) {
                    try {
                        const invoicesResult = await services.billingService.getInvoices();
                        if (invoicesResult.success) {
                            const matchingInvoice = invoicesResult.data.find(inv => 
                                inv.jobId === job.id || 
                                (inv.source === 'garage' && inv.plateNumber === job.plateNumber && inv.paymentStatus !== 'paid')
                            );
                            if (matchingInvoice) {
                                await services.billingService.markAsPaid(matchingInvoice.id, {
                                    paymentMethod: 'cash',
                                    paidAmount: matchingInvoice.totalAmount,
                                    paidBy: currentUser?.displayName || 'System'
                                });
                            }
                        }
                    } catch (invErr) {
                        console.warn('Could not update invoice:', invErr);
                    }
                }

                // Log activity
                if (services.activityService) {
                    services.activityService.logActivity({
                        type: 'garage',
                        action: 'Payment Cleared',
                        details: `${job.plateNumber} - Payment confirmed`,
                        amount: job.totalCost || 0,
                        status: 'success',
                        loggedBy: currentUser?.displayName || 'System',
                        loggedByEmail: currentUser?.email || null,
                        loggedByRole: currentUser?.role || null
                    });
                }

                showAlert('‚úÖ Payment Cleared', `Payment for ${job.plateNumber} has been confirmed.`, 'success');
            } else {
                setError('Failed to update payment: ' + (result.error || 'Unknown error'));
            }
        } catch (err) {
            console.error('Mark paid error:', err);
            setError('Failed to mark as paid: ' + err.message);
        } finally {
            setActionLoading(false);
        }
    };

    // Service Categories
    const SERVICE_CATEGORIES = [
        { id: 'maintenance', name: 'Maintenance', color: '#3b82f6' },
        { id: 'repair', name: 'Repair', color: '#ef4444' },
        { id: 'inspection', name: 'Inspection', color: '#10b981' },
        { id: 'electrical', name: 'Electrical', color: '#f59e0b' },
        { id: 'bodywork', name: 'Body Work', color: '#8b5cf6' },
        { id: 'other', name: 'Other', color: '#6b7280' }
    ];

    // Open add service form
    const handleAddService = () => {
        setEditingService(null);
        setServiceFormData({
            name: '',
            category: 'maintenance',
            price: '',
            duration: '',
            description: ''
        });
        setShowServiceFormModal(true);
    };

    // Open edit service form
    const handleEditService = (service) => {
        setEditingService(service);
        setServiceFormData({
            name: service.name || '',
            category: service.category || 'maintenance',
            price: service.price?.toString() || '',
            duration: service.duration?.toString() || '',
            description: service.description || ''
        });
        setShowServiceFormModal(true);
    };

    // Save service (add or update)
    const handleSaveService = async () => {
        const services = window.FirebaseServices;
        if (!services?.garageServicesService) return;

        if (!serviceFormData.name.trim()) {
            setError('Service name is required');
            return;
        }
        if (!serviceFormData.price || isNaN(Number(serviceFormData.price))) {
            setError('Valid price is required');
            return;
        }

        setActionLoading(true);
        try {
            const serviceData = {
                name: serviceFormData.name.trim(),
                category: serviceFormData.category,
                price: Number(serviceFormData.price),
                duration: Number(serviceFormData.duration) || 30,
                description: serviceFormData.description.trim(),
                isActive: true
            };

            if (editingService) {
                await services.garageServicesService.updateService(editingService.id, serviceData);
            } else {
                await services.garageServicesService.addService(serviceData);
            }

            setShowServiceFormModal(false);
            setEditingService(null);
            setServiceFormData({ name: '', category: 'maintenance', price: '', duration: '', description: '' });
        } catch (err) {
            setError('Failed to save service: ' + err.message);
        } finally {
            setActionLoading(false);
        }
    };

    // Delete service
    const handleDeleteService = async (serviceId) => {
        const services = window.FirebaseServices;
        if (!services?.garageServicesService) return;

        showAlert(
            'Delete Service',
            'Delete this service? This action cannot be undone.',
            'warning',
            async () => {
                setActionLoading(true);
                try {
                    await services.garageServicesService.deleteService(serviceId);
                } catch (err) {
                    setError('Failed to delete service: ' + err.message);
                } finally {
                    setActionLoading(false);
                }
            },
            true
        );
    };

    // Print receipt
    const handlePrintReceipt = () => {
        if (!selectedItem) return;
        
        const brand = getBrandingForReceipts();
        const servicesList = selectedItem.services?.map(sId => {
            const service = garageServices.find(s => s.id === sId);
            return service ? `<tr><td style="padding:8px;border-bottom:1px solid #eee;">${service.name}</td><td style="padding:8px;border-bottom:1px solid #eee;text-align:right;">${brand.currencySymbol || 'KSh'} ${(service.price || 0).toLocaleString()}</td></tr>` : '';
        }).join('') || '<tr><td colspan="2" style="padding:8px;">No services</td></tr>';

        const totalCost = selectedItem.services?.reduce((sum, sId) => {
            const service = garageServices.find(s => s.id === sId);
            return sum + (service?.price || 0);
        }, 0) || selectedItem.totalCost || 0;

        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>Garage Receipt - ${selectedItem.plateNumber}</title>
                <style>
                    body { font-family: Arial, sans-serif; padding: 20px; max-width: 400px; margin: 0 auto; }
                    .header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #333; padding-bottom: 15px; }
                    .logo { font-size: 24px; font-weight: bold; color: #333; }
                    .subtitle { color: #666; font-size: 12px; }
                    .section { margin: 15px 0; }
                    .label { color: #666; font-size: 12px; }
                    .value { font-weight: 500; font-size: 14px; }
                    table { width: 100%; border-collapse: collapse; margin: 15px 0; }
                    th { text-align: left; padding: 8px; background: #f5f5f5; border-bottom: 2px solid #333; }
                    .total { font-size: 18px; font-weight: bold; text-align: right; margin-top: 15px; padding-top: 15px; border-top: 2px solid #333; }
                    .footer { text-align: center; margin-top: 30px; padding-top: 15px; border-top: 1px dashed #ccc; color: #666; font-size: 11px; }
                    .status { display: inline-block; padding: 4px 12px; background: #d1fae5; color: #059669; font-weight: 500; }
                </style>
            </head>
            <body>
                <div class="header">
                    <div class="logo">üîß ${brand.companyName} GARAGE</div>
                    <div class="subtitle">Auto Service Receipt</div>
                    ${brand.address ? `<div class="subtitle">${brand.address}${brand.city ? ', ' + brand.city : ''}</div>` : ''}
                    ${brand.phone ? `<div class="subtitle">Tel: ${brand.phone}</div>` : ''}
                </div>
                
                <div class="section">
                    <div class="label">Receipt No.</div>
                    <div class="value">#GRG-${Date.now().toString().slice(-8)}</div>
                </div>
                
                <div class="section">
                    <div class="label">Date</div>
                    <div class="value">${new Date().toLocaleDateString('en-KE', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</div>
                </div>
                
                <div class="section">
                    <div class="label">Vehicle</div>
                    <div class="value">${selectedItem.plateNumber} - ${selectedItem.vehicleType || 'N/A'}</div>
                </div>
                
                <div class="section">
                    <div class="label">Customer</div>
                    <div class="value">${selectedItem.customerName || 'Walk-in Customer'}</div>
                    ${selectedItem.customerPhone ? `<div class="value">${selectedItem.customerPhone}</div>` : ''}
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th>Service</th>
                            <th style="text-align:right;">Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${servicesList}
                    </tbody>
                </table>
                
                <div class="total">
                    Total: ${brand.currencySymbol || 'KSh'} ${totalCost.toLocaleString()}
                </div>
                
                <div class="section" style="text-align:center;margin-top:20px;">
                    <span class="status">‚úÖ ${selectedItem.status === 'completed' ? 'COMPLETED' : 'IN PROGRESS'}</span>
                </div>
                
                ${selectedItem.notes ? `<div class="section"><div class="label">Notes</div><div class="value">${selectedItem.notes}</div></div>` : ''}
                
                <div class="footer">
                    <p>${brand.receiptFooter || 'Thank you for choosing us!'}</p>
                    <p>Your vehicle is in safe hands</p>
                </div>
            </body>
            </html>
        `);
        printWindow.document.close();
        printWindow.focus();
        setTimeout(() => {
            printWindow.print();
            printWindow.close();
        }, 250);
    };

    // Remove from queue
    const handleRemoveFromQueue = async (itemId) => {
        const services = window.FirebaseServices;
        if (!services?.garageQueueService) return;

        showAlert(
            'Remove from Queue',
            'Remove this vehicle from the garage queue?',
            'warning',
            async () => {
                setActionLoading(true);
                try {
                    await services.garageQueueService.removeFromQueue(itemId);
                } catch (err) {
                    setError('Failed to remove from queue');
                } finally {
                    setActionLoading(false);
                }
            },
            true
        );
    };

    // Delete job
    const handleDeleteJob = async (jobId) => {
        const services = window.FirebaseServices;
        if (!services?.garageJobsService) return;

        showAlert(
            'Delete Job',
            'Delete this job record? This action cannot be undone.',
            'warning',
            async () => {
                setActionLoading(true);
                try {
                    await services.garageJobsService.deleteJob(jobId);
                } catch (err) {
                    setError('Failed to delete job');
                } finally {
                    setActionLoading(false);
                }
            },
            true
        );
    };

    // Open edit services modal
    const handleOpenEditServices = (item) => {
        setEditServicesItem(item);
        // Handle both service objects (from intake) and service IDs
        const serviceIds = (item.services || []).map(svc => typeof svc === 'object' ? svc.id : svc);
        setEditServices(serviceIds);
        setShowEditServicesModal(true);
    };

    // Toggle service selection for edit modal
    const toggleEditService = (serviceId) => {
        setEditServices(prev => 
            prev.includes(serviceId)
                ? prev.filter(id => id !== serviceId)
                : [...prev, serviceId]
        );
    };

    // Save edited services
    const handleSaveEditServices = async () => {
        if (!editServicesItem) return;
        
        const services = window.FirebaseServices;
        
        setActionLoading(true);
        try {
            // Calculate new total cost
            const totalCost = editServices.reduce((sum, sId) => {
                const service = garageServices.find(s => s.id === sId);
                return sum + (service?.price || 0);
            }, 0);

            // Determine if it's a queue item or a job
            const isQueueItem = activeTab === 'queue';
            
            if (isQueueItem && services?.garageQueueService) {
                await services.garageQueueService.updateQueueItem(editServicesItem.id, {
                    services: editServices,
                    totalCost: totalCost
                });
            } else if (!isQueueItem && services?.garageJobsService) {
                await services.garageJobsService.updateJob(editServicesItem.id, {
                    services: editServices,
                    totalCost: totalCost
                });
            }

            showAlert('Success', 'Services updated successfully!', 'success');
            setShowEditServicesModal(false);
            setEditServicesItem(null);
            setEditServices([]);
        } catch (err) {
            console.error('Error updating services:', err);
            setError('Failed to update services: ' + err.message);
        } finally {
            setActionLoading(false);
        }
    };

    // Toggle service selection
    const toggleService = (serviceId) => {
        setFormData(prev => ({
            ...prev,
            services: prev.services.includes(serviceId)
                ? prev.services.filter(id => id !== serviceId)
                : [...prev.services, serviceId]
        }));
    };

    // Get priority color
    const getPriorityColor = (priority) => {
        const option = PRIORITY_OPTIONS.find(p => p.id === priority);
        return option?.color || '#6b7280';
    };

    // Format currency
    const formatCurrency = (amount) => `${getBrandingForReceipts().currencySymbol || 'KSh'} ${(amount || 0).toLocaleString()}`;

    // Format time ago
    const formatTimeAgo = (dateString) => {
        const date = new Date(dateString);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        if (diffMins < 60) return `${diffMins}m ago`;
        const diffHours = Math.floor(diffMins / 60);
        if (diffHours < 24) return `${diffHours}h ago`;
        return date.toLocaleDateString();
    };

    // Loading state
    if (loading) {
        return (
            <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', height: '400px', color: theme.textSecondary }}>
                <div style={{ textAlign: 'center' }}>
                    <div style={{ width: '40px', height: '40px', border: '3px solid #e2e8f0', borderTopColor: '#3b82f6', borderRadius: '50%', animation: 'spin 0.8s linear infinite', margin: '0 auto 16px' }}></div>
                    <p>Loading Garage...</p>
                </div>
            </div>
        );
    }

    return (
        <div style={{ padding: '24px', backgroundColor: theme.bgSecondary, minHeight: '100%' }}>
            {/* Error Banner */}
            {error && (
                <div style={{ marginBottom: '16px', padding: '12px 16px', backgroundColor: '#fef2f2', border: '1px solid #fecaca', borderRadius: '0', color: '#dc2626', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <span>{error}</span>
                    <button onClick={() => setError(null)} style={{ background: 'none', border: 'none', color: '#dc2626', cursor: 'pointer', fontSize: '18px' }}>√ó</button>
                </div>
            )}

            {/* Stats Cards */}
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '16px', marginBottom: '24px' }}>
                <div style={{ background: theme.bg, borderRadius: '0', padding: '20px', boxShadow: theme.cardShadow, border: `1px solid ${theme.border}` }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                        <div style={{ width: '48px', height: '48px', borderRadius: '0', backgroundColor: '#dbeafe', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                            <span style={{ fontSize: '24px' }}>üöó</span>
                        </div>
                        <div>
                            <p style={{ color: theme.textSecondary, fontSize: '14px', margin: 0 }}>Waiting in Queue</p>
                            <p style={{ color: theme.text, fontSize: '28px', fontWeight: '700', margin: 0 }}>{stats.waiting}</p>
                        </div>
                    </div>
                </div>

                <div style={{ background: theme.bg, borderRadius: '0', padding: '20px', boxShadow: theme.cardShadow, border: `1px solid ${theme.border}` }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                        <div style={{ width: '48px', height: '48px', borderRadius: '0', backgroundColor: '#fef3c7', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                            <span style={{ fontSize: '24px' }}>üîß</span>
                        </div>
                        <div>
                            <p style={{ color: theme.textSecondary, fontSize: '14px', margin: 0 }}>In Progress</p>
                            <p style={{ color: theme.text, fontSize: '28px', fontWeight: '700', margin: 0 }}>{stats.inProgress}</p>
                        </div>
                    </div>
                </div>

                <div style={{ background: theme.bg, borderRadius: '0', padding: '20px', boxShadow: theme.cardShadow, border: `1px solid ${theme.border}` }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                        <div style={{ width: '48px', height: '48px', borderRadius: '0', backgroundColor: '#d1fae5', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                            <span style={{ fontSize: '24px' }}>‚úÖ</span>
                        </div>
                        <div>
                            <p style={{ color: theme.textSecondary, fontSize: '14px', margin: 0 }}>Completed Today</p>
                            <p style={{ color: theme.text, fontSize: '28px', fontWeight: '700', margin: 0 }}>{stats.completedToday}</p>
                        </div>
                    </div>
                </div>

                <div style={{ background: theme.bg, borderRadius: '0', padding: '20px', boxShadow: theme.cardShadow, border: `1px solid ${theme.border}` }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                        <div style={{ width: '48px', height: '48px', borderRadius: '0', backgroundColor: '#ede9fe', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                            <span style={{ fontSize: '24px' }}>üí∞</span>
                        </div>
                        <div>
                            <p style={{ color: theme.textSecondary, fontSize: '14px', margin: 0 }}>Today's Revenue</p>
                            <p style={{ color: theme.text, fontSize: '24px', fontWeight: '700', margin: 0 }}>{formatCurrency(stats.totalRevenue)}</p>
                        </div>
                    </div>
                </div>
            </div>

            {/* Add from Intake Section */}
            <div style={{ background: theme.bg, borderRadius: '0', padding: '20px', marginBottom: '24px', boxShadow: theme.cardShadow, border: `1px solid ${theme.border}` }}>
                <h3 style={{ margin: '0 0 16px 0', color: theme.text, fontSize: '16px', fontWeight: '600' }}>Add Vehicle to Garage</h3>
                <div style={{ display: 'flex', gap: '12px', flexWrap: 'wrap', alignItems: 'flex-end' }}>
                    <div style={{ flex: '1', minWidth: '300px' }}>
                        <label style={{ display: 'block', fontSize: '13px', color: theme.textSecondary, marginBottom: '6px' }}>
                            Select from Vehicle Intake 
                            <span style={{ marginLeft: '8px', padding: '2px 8px', backgroundColor: intakeVehicles.length > 0 ? '#fef3c7' : theme.bgTertiary, color: intakeVehicles.length > 0 ? '#d97706' : theme.textMuted, fontSize: '12px', fontWeight: '600' }}>
                                {intakeVehicles.length} waiting
                            </span>
                            <span style={{ marginLeft: '4px', padding: '2px 8px', backgroundColor: intakeRecords.length > 0 ? '#dbeafe' : theme.bgTertiary, color: intakeRecords.length > 0 ? '#2563eb' : theme.textMuted, fontSize: '12px', fontWeight: '600' }}>
                                {intakeRecords.length} in-progress
                            </span>
                        </label>
                        <select
                            value={selectedIntakeVehicle}
                            onChange={(e) => setSelectedIntakeVehicle(e.target.value)}
                            style={{ width: '100%', padding: '10px 12px', border: `1px solid ${theme.border}`, borderRadius: '0', fontSize: '14px', backgroundColor: theme.inputBg, color: theme.text }}
                        >
                            <option value="">{(intakeVehicles.length + intakeRecords.length) === 0 ? '-- No vehicles in intake --' : '-- Select Vehicle --'}</option>
                            {intakeVehicles.length > 0 && (
                                <optgroup label="‚è≥ Waiting in Queue">
                                    {intakeVehicles.map(v => (
                                        <option key={`queue-${v.id}`} value={`queue:${v.id}`}>
                                            {v.plateNumber} - {v.vehicleType} ‚Ä¢ {v.customerName || 'Walk-in'} {v.service?.name ? `(${v.service.name})` : ''}
                                        </option>
                                    ))}
                                </optgroup>
                            )}
                            {intakeRecords.length > 0 && (
                                <optgroup label="üîß In Progress (Assigned to Bay)">
                                    {intakeRecords.map(v => (
                                        <option key={`record-${v.id}`} value={`record:${v.id}`}>
                                            {v.plateNumber} - {v.vehicleType} ‚Ä¢ {v.assignedBay || 'Bay'} ‚Ä¢ {v.customerName || 'Walk-in'}
                                        </option>
                                    ))}
                                </optgroup>
                            )}
                        </select>
                    </div>
                    <button
                        onClick={handleAddFromIntake}
                        disabled={!selectedIntakeVehicle || actionLoading}
                        style={{ padding: '10px 20px', backgroundColor: selectedIntakeVehicle ? '#3b82f6' : '#94a3b8', color: 'white', border: 'none', borderRadius: '0', cursor: selectedIntakeVehicle ? 'pointer' : 'not-allowed', fontSize: '14px', fontWeight: '500', display: 'flex', alignItems: 'center', gap: '6px' }}
                    >
                        {Icons.arrowRight} Send to Garage
                    </button>
                    <div style={{ borderLeft: `1px solid ${theme.border}`, height: '40px', margin: '0 8px' }}></div>
                    {canCreate('garage-management') && <button
                        onClick={() => setShowAddModal(true)}
                        style={{ padding: '10px 20px', backgroundColor: '#10b981', color: 'white', border: 'none', borderRadius: '0', cursor: 'pointer', fontSize: '14px', fontWeight: '500', display: 'flex', alignItems: 'center', gap: '6px' }}
                    >
                        {Icons.plus} Add New Vehicle
                    </button>}
                    <div style={{ borderLeft: `1px solid ${theme.border}`, height: '40px', margin: '0 8px' }}></div>
                    {canEdit('garage-management') && <button
                        onClick={() => setShowServicesModal(true)}
                        style={{ padding: '10px 20px', backgroundColor: '#8b5cf6', color: 'white', border: 'none', borderRadius: '0', cursor: 'pointer', fontSize: '14px', fontWeight: '500', display: 'flex', alignItems: 'center', gap: '6px' }}
                    >
                        ‚öôÔ∏è Manage Services
                    </button>}
                </div>
            </div>

            {/* Tabs */}
            <div style={{ display: 'flex', gap: '8px', marginBottom: '16px' }}>
                {[
                    { id: 'queue', label: 'Queue', count: stats.waiting },
                    { id: 'jobs', label: 'In Progress', count: stats.inProgress },
                    { id: 'completed', label: 'Completed', count: stats.completedToday }
                ].map(tab => (
                    <button
                        key={tab.id}
                        onClick={() => setActiveTab(tab.id)}
                        style={{
                            padding: '10px 20px',
                            backgroundColor: activeTab === tab.id ? '#3b82f6' : theme.bg,
                            color: activeTab === tab.id ? 'white' : theme.text,
                            border: `1px solid ${activeTab === tab.id ? '#3b82f6' : theme.border}`,
                            borderRadius: '0',
                            cursor: 'pointer',
                            fontSize: '14px',
                            fontWeight: '500',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '8px'
                        }}
                    >
                        {tab.label}
                        <span style={{
                            backgroundColor: activeTab === tab.id ? 'rgba(255,255,255,0.2)' : theme.bgTertiary,
                            padding: '2px 8px',
                            borderRadius: '0',
                            fontSize: '12px'
                        }}>{tab.count}</span>
                    </button>
                ))}
            </div>

            {/* Search and Filter Bar */}
            <div style={{ background: theme.bg, borderRadius: '0', padding: '16px', marginBottom: '16px', boxShadow: theme.cardShadow, border: `1px solid ${theme.border}`, display: 'flex', gap: '12px', flexWrap: 'wrap' }}>
                <div style={{ flex: '1', minWidth: '250px', position: 'relative' }}>
                    <span style={{ position: 'absolute', left: '12px', top: '50%', transform: 'translateY(-50%)', color: theme.textSecondary }}>üîç</span>
                    <input
                        type="text"
                        placeholder="Search by plate, name, phone..."
                        value={searchQuery}
                        onChange={(e) => setSearchQuery(e.target.value)}
                        style={{ width: '100%', padding: '10px 12px 10px 40px', border: `1px solid ${theme.border}`, borderRadius: '0', fontSize: '14px', backgroundColor: theme.inputBg, color: theme.text }}
                    />
                </div>
                {activeTab === 'queue' && (
                    <select
                        value={statusFilter}
                        onChange={(e) => setStatusFilter(e.target.value)}
                        style={{ padding: '10px 12px', border: `1px solid ${theme.border}`, borderRadius: '0', fontSize: '14px', backgroundColor: theme.inputBg, color: theme.text, minWidth: '150px' }}
                    >
                        <option value="all">All Priorities</option>
                        {PRIORITY_OPTIONS.map(p => (
                            <option key={p.id} value={p.id}>{p.name}</option>
                        ))}
                    </select>
                )}
            </div>

            {/* Data Table - Responsive */}
            <div style={{ background: theme.bg, borderRadius: '0', boxShadow: theme.cardShadow, border: `1px solid ${theme.border}`, overflow: 'hidden' }}>
                <div style={{ overflowX: 'auto', WebkitOverflowScrolling: 'touch' }}>
                    <table style={{ width: '100%', borderCollapse: 'collapse', minWidth: '1000px' }}>
                        <thead>
                            <tr style={{ backgroundColor: theme.bgTertiary }}>
                                <th style={{ padding: '14px 16px', textAlign: 'left', fontSize: '13px', fontWeight: '600', color: theme.textSecondary, borderBottom: `1px solid ${theme.border}`, whiteSpace: 'nowrap' }}>Vehicle</th>
                                <th style={{ padding: '14px 16px', textAlign: 'left', fontSize: '13px', fontWeight: '600', color: theme.textSecondary, borderBottom: `1px solid ${theme.border}`, whiteSpace: 'nowrap' }}>Customer</th>
                                <th style={{ padding: '14px 16px', textAlign: 'left', fontSize: '13px', fontWeight: '600', color: theme.textSecondary, borderBottom: `1px solid ${theme.border}`, whiteSpace: 'nowrap' }}>Services</th>
                                <th style={{ padding: '14px 16px', textAlign: 'left', fontSize: '13px', fontWeight: '600', color: theme.textSecondary, borderBottom: `1px solid ${theme.border}`, whiteSpace: 'nowrap' }}>Assigned To</th>
                                <th style={{ padding: '14px 16px', textAlign: 'left', fontSize: '13px', fontWeight: '600', color: theme.textSecondary, borderBottom: `1px solid ${theme.border}`, whiteSpace: 'nowrap' }}>
                                    {activeTab === 'queue' ? 'Priority' : 'Status'}
                                </th>
                                <th style={{ padding: '14px 16px', textAlign: 'right', fontSize: '13px', fontWeight: '600', color: theme.textSecondary, borderBottom: `1px solid ${theme.border}`, whiteSpace: 'nowrap' }}>Cost</th>
                                {activeTab === 'completed' && (
                                    <th style={{ padding: '14px 16px', textAlign: 'center', fontSize: '13px', fontWeight: '600', color: theme.textSecondary, borderBottom: `1px solid ${theme.border}`, whiteSpace: 'nowrap' }}>Payment</th>
                                )}
                                <th style={{ padding: '14px 16px', textAlign: 'left', fontSize: '13px', fontWeight: '600', color: theme.textSecondary, borderBottom: `1px solid ${theme.border}`, whiteSpace: 'nowrap' }}>Time</th>
                                <th style={{ padding: '14px 16px', textAlign: 'right', fontSize: '13px', fontWeight: '600', color: theme.textSecondary, borderBottom: `1px solid ${theme.border}`, whiteSpace: 'nowrap' }}>Actions</th>
                            </tr>
                    </thead>
                    <tbody>
                        {filteredData.length === 0 ? (
                            <tr>
                                <td colSpan={activeTab === 'completed' ? 9 : 8} style={{ padding: '48px', textAlign: 'center', color: theme.textSecondary }}>
                                    <div>
                                        <span style={{ fontSize: '48px', display: 'block', marginBottom: '12px' }}>
                                            {activeTab === 'queue' ? 'üìã' : activeTab === 'jobs' ? 'üîß' : '‚úÖ'}
                                        </span>
                                        <p style={{ margin: 0 }}>
                                            {activeTab === 'queue' ? 'No vehicles in queue' : activeTab === 'jobs' ? 'No jobs in progress' : 'No completed jobs today'}
                                        </p>
                                    </div>
                                </td>
                            </tr>
                        ) : (
                            paginatedData.map(item => (
                                <tr key={item.id} style={{ borderBottom: `1px solid ${theme.border}` }}>
                                    <td style={{ padding: '14px 16px' }}>
                                        <div style={{ fontWeight: '600', color: theme.text }}>{item.plateNumber}</div>
                                        <div style={{ fontSize: '13px', color: theme.textSecondary }}>{item.vehicleType}</div>
                                    </td>
                                    <td style={{ padding: '14px 16px' }}>
                                        <div style={{ color: theme.text }}>{item.customerName || '-'}</div>
                                        <div style={{ fontSize: '13px', color: theme.textSecondary }}>{item.customerPhone || '-'}</div>
                                    </td>
                                    <td style={{ padding: '14px 16px' }}>
                                        {item.services?.length > 0 ? (
                                            <div style={{ display: 'flex', gap: '4px', flexWrap: 'wrap' }}>
                                                {item.services.slice(0, 2).map((svc, idx) => {
                                                    // Handle both service objects (from intake) and service IDs
                                                    const serviceName = typeof svc === 'object' ? svc.name : garageServices.find(s => s.id === svc)?.name;
                                                    return serviceName ? (
                                                        <span key={idx} style={{ fontSize: '12px', padding: '2px 8px', backgroundColor: theme.bgTertiary, borderRadius: '0', color: theme.text }}>
                                                            {serviceName}
                                                        </span>
                                                    ) : null;
                                                })}
                                                {item.services.length > 2 && (
                                                    <span style={{ fontSize: '12px', padding: '2px 8px', backgroundColor: theme.bgTertiary, borderRadius: '0', color: theme.textSecondary }}>
                                                        +{item.services.length - 2} more
                                                    </span>
                                                )}
                                            </div>
                                        ) : (
                                            <span style={{ color: theme.textMuted, fontSize: '13px' }}>No services</span>
                                        )}
                                        {item.notes && (
                                            <div style={{ fontSize: '12px', color: theme.textSecondary, marginTop: '4px' }}>{item.notes}</div>
                                        )}
                                    </td>
                                    <td style={{ padding: '14px 16px' }}>
                                        {item.assignedTo ? (
                                            <span style={{
                                                display: 'inline-flex',
                                                alignItems: 'center',
                                                gap: '6px',
                                                padding: '4px 10px',
                                                borderRadius: '0',
                                                fontSize: '12px',
                                                fontWeight: '500',
                                                backgroundColor: '#dbeafe',
                                                color: '#2563eb'
                                            }}>
                                                üë§ {item.assignedTo}
                                            </span>
                                        ) : (
                                            <span style={{ color: theme.textMuted, fontSize: '13px' }}>Unassigned</span>
                                        )}
                                    </td>
                                    <td style={{ padding: '14px 16px' }}>
                                        {activeTab === 'queue' ? (
                                            <span style={{
                                                display: 'inline-flex',
                                                alignItems: 'center',
                                                gap: '6px',
                                                padding: '4px 10px',
                                                borderRadius: '0',
                                                fontSize: '12px',
                                                fontWeight: '500',
                                                backgroundColor: `${getPriorityColor(item.priority)}20`,
                                                color: getPriorityColor(item.priority)
                                            }}>
                                                <span style={{ width: '6px', height: '6px', borderRadius: '0', backgroundColor: getPriorityColor(item.priority) }}></span>
                                                {PRIORITY_OPTIONS.find(p => p.id === item.priority)?.name || 'Normal'}
                                            </span>
                                        ) : (
                                            <span style={{
                                                display: 'inline-flex',
                                                alignItems: 'center',
                                                gap: '6px',
                                                padding: '4px 10px',
                                                borderRadius: '0',
                                                fontSize: '12px',
                                                fontWeight: '500',
                                                backgroundColor: item.status === 'completed' ? '#d1fae520' : '#fef3c720',
                                                color: item.status === 'completed' ? '#10b981' : '#f59e0b'
                                            }}>
                                                {item.status === 'completed' ? '‚úÖ Completed' : 'üîß In Progress'}
                                            </span>
                                        )}
                                    </td>
                                    <td style={{ padding: '14px 16px', textAlign: 'right' }}>
                                        <span style={{ fontWeight: '600', color: '#10b981', fontSize: '14px' }}>
                                            {formatCurrency(
                                                item.totalCost || 
                                                item.services?.reduce((sum, svc) => {
                                                    // Handle both service objects (from intake) and service IDs
                                                    if (typeof svc === 'object') {
                                                        return sum + (parseFloat(svc.price) || 0);
                                                    }
                                                    const service = garageServices.find(s => s.id === svc);
                                                    return sum + (service?.price || 0);
                                                }, 0) || 0
                                            )}
                                        </span>
                                    </td>
                                    {activeTab === 'completed' && (
                                        <td style={{ padding: '14px 16px', textAlign: 'center' }}>
                                            <span style={{
                                                display: 'inline-flex',
                                                alignItems: 'center',
                                                gap: '6px',
                                                padding: '4px 12px',
                                                borderRadius: '0',
                                                fontSize: '12px',
                                                fontWeight: '600',
                                                backgroundColor: item.paymentStatus === 'cleared' ? '#d1fae5' : '#fef3c7',
                                                color: item.paymentStatus === 'cleared' ? '#059669' : '#d97706'
                                            }}>
                                                {item.paymentStatus === 'cleared' ? '‚úì Cleared' : '‚è≥ Awaiting'}
                                            </span>
                                        </td>
                                    )}
                                    <td style={{ padding: '14px 16px', color: theme.textSecondary, fontSize: '13px' }}>
                                        {formatTimeAgo(item.addedAt || item.startedAt || item.createdAt)}
                                    </td>
                                    <td style={{ padding: '14px 16px', textAlign: 'right' }}>
                                        <div style={{ display: 'flex', gap: '8px', justifyContent: 'flex-end' }}>
                                            {/* View button for all tabs */}
                                            <button
                                                onClick={() => handleViewItem(item)}
                                                style={{ padding: '6px 12px', backgroundColor: '#dbeafe', color: '#2563eb', border: 'none', borderRadius: '0', cursor: 'pointer', fontSize: '13px', fontWeight: '500' }}
                                            >
                                                View
                                            </button>
                                            
                                            {activeTab === 'queue' && (
                                                <>
                                                    <button
                                                        onClick={() => handleOpenEditServices(item)}
                                                        style={{ padding: '6px 12px', backgroundColor: '#e0e7ff', color: '#4338ca', border: 'none', borderRadius: '0', cursor: 'pointer', fontSize: '13px', fontWeight: '500' }}
                                                    >
                                                        ‚úèÔ∏è Edit
                                                    </button>
                                                    <button
                                                        onClick={() => handleStartJob(item)}
                                                        disabled={actionLoading}
                                                        style={{ padding: '6px 12px', backgroundColor: '#10b981', color: 'white', border: 'none', borderRadius: '0', cursor: 'pointer', fontSize: '13px', fontWeight: '500' }}
                                                    >
                                                        Start Job
                                                    </button>
                                                    <button
                                                        onClick={() => handleRemoveFromQueue(item.id)}
                                                        disabled={actionLoading}
                                                        style={{ padding: '6px 12px', backgroundColor: '#fee2e2', color: '#dc2626', border: 'none', borderRadius: '0', cursor: 'pointer', fontSize: '13px', fontWeight: '500' }}
                                                    >
                                                        Remove
                                                    </button>
                                                </>
                                            )}
                                            {activeTab === 'jobs' && (
                                                <>
                                                    <button
                                                        onClick={() => handleOpenEditServices(item)}
                                                        style={{ padding: '6px 12px', backgroundColor: '#e0e7ff', color: '#4338ca', border: 'none', borderRadius: '0', cursor: 'pointer', fontSize: '13px', fontWeight: '500' }}
                                                    >
                                                        ‚úèÔ∏è Edit
                                                    </button>
                                                    <button
                                                        onClick={() => handleShowNotes(item)}
                                                        style={{ padding: '6px 12px', backgroundColor: '#fef3c7', color: '#d97706', border: 'none', borderRadius: '0', cursor: 'pointer', fontSize: '13px', fontWeight: '500' }}
                                                    >
                                                        üìù Notes
                                                    </button>
                                                    <button
                                                        onClick={() => handleCompleteJob(item)}
                                                        disabled={actionLoading}
                                                        style={{ padding: '6px 12px', backgroundColor: '#10b981', color: 'white', border: 'none', borderRadius: '0', cursor: 'pointer', fontSize: '13px', fontWeight: '500' }}
                                                    >
                                                        {actionLoading ? 'Completing...' : 'Complete'}
                                                    </button>
                                                </>
                                            )}
                                            {activeTab === 'completed' && (
                                                <>
                                                    {item.paymentStatus !== 'cleared' && (
                                                        <button
                                                            onClick={() => handleMarkPaid(item)}
                                                            disabled={actionLoading}
                                                            style={{ padding: '6px 12px', backgroundColor: '#10b981', color: 'white', border: 'none', borderRadius: '0', cursor: 'pointer', fontSize: '13px', fontWeight: '500' }}
                                                        >
                                                            üí≥ Mark Paid
                                                        </button>
                                                    )}
                                                    <button
                                                        onClick={() => handleShowHistory(item)}
                                                        style={{ padding: '6px 12px', backgroundColor: '#e0e7ff', color: '#4338ca', border: 'none', borderRadius: '0', cursor: 'pointer', fontSize: '13px', fontWeight: '500' }}
                                                    >
                                                        üìú History
                                                    </button>
                                                    <button
                                                        onClick={() => handleShowReceipt(item)}
                                                        style={{ padding: '6px 12px', backgroundColor: '#f0fdf4', color: '#16a34a', border: 'none', borderRadius: '0', cursor: 'pointer', fontSize: '13px', fontWeight: '500' }}
                                                    >
                                                        Receipt
                                                    </button>
                                                    <button
                                                        onClick={() => handleDeleteJob(item.id)}
                                                        disabled={actionLoading}
                                                        style={{ padding: '6px 12px', backgroundColor: '#fee2e2', color: '#dc2626', border: 'none', borderRadius: '0', cursor: 'pointer', fontSize: '13px', fontWeight: '500' }}
                                                    >
                                                        Delete
                                                    </button>
                                                </>
                                            )}
                                        </div>
                                    </td>
                                </tr>
                            ))
                        )}
                    </tbody>
                </table>
                </div>
            </div>

            {/* Pagination Controls */}
            {totalItems > 0 && (
                <div style={{ 
                    display: 'flex', 
                    justifyContent: 'space-between', 
                    alignItems: 'center', 
                    padding: '16px 20px', 
                    backgroundColor: theme.bg, 
                    border: `1px solid ${theme.border}`, 
                    borderTop: 'none',
                    flexWrap: 'wrap',
                    gap: '12px'
                }}>
                    {/* Items per page selector */}
                    <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                        <span style={{ fontSize: '13px', color: theme.textSecondary }}>Show</span>
                        <select 
                            value={itemsPerPage} 
                            onChange={(e) => { setItemsPerPage(Number(e.target.value)); setCurrentPage(1); }}
                            style={{ padding: '6px 10px', border: `1px solid ${theme.border}`, borderRadius: '0', fontSize: '13px', backgroundColor: theme.inputBg, color: theme.text }}
                        >
                            <option value={10}>10</option>
                            <option value={25}>25</option>
                            <option value={50}>50</option>
                            <option value={100}>100</option>
                        </select>
                        <span style={{ fontSize: '13px', color: theme.textSecondary }}>entries</span>
                    </div>

                    {/* Info text */}
                    <div style={{ fontSize: '13px', color: theme.textSecondary }}>
                        Showing {startIndex + 1} to {Math.min(endIndex, totalItems)} of {totalItems} entries
                    </div>

                    {/* Page navigation */}
                    <div style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                        <button
                            onClick={() => setCurrentPage(1)}
                            disabled={currentPage === 1}
                            style={{ 
                                padding: '6px 10px', 
                                border: `1px solid ${theme.border}`, 
                                borderRadius: '0', 
                                backgroundColor: currentPage === 1 ? theme.bgTertiary : theme.bg, 
                                color: currentPage === 1 ? theme.textMuted : theme.text, 
                                cursor: currentPage === 1 ? 'not-allowed' : 'pointer',
                                fontSize: '13px'
                            }}
                        >
                            ‚ü™
                        </button>
                        <button
                            onClick={() => setCurrentPage(p => Math.max(1, p - 1))}
                            disabled={currentPage === 1}
                            style={{ 
                                padding: '6px 12px', 
                                border: `1px solid ${theme.border}`, 
                                borderRadius: '0', 
                                backgroundColor: currentPage === 1 ? theme.bgTertiary : theme.bg, 
                                color: currentPage === 1 ? theme.textMuted : theme.text, 
                                cursor: currentPage === 1 ? 'not-allowed' : 'pointer',
                                fontSize: '13px'
                            }}
                        >
                            ‚Äπ Prev
                        </button>
                        
                        {/* Page numbers */}
                        {(() => {
                            const pages = [];
                            const maxVisible = 5;
                            let start = Math.max(1, currentPage - Math.floor(maxVisible / 2));
                            let end = Math.min(totalPages, start + maxVisible - 1);
                            if (end - start + 1 < maxVisible) {
                                start = Math.max(1, end - maxVisible + 1);
                            }
                            
                            if (start > 1) {
                                pages.push(
                                    <button key={1} onClick={() => setCurrentPage(1)} style={{ padding: '6px 12px', border: `1px solid ${theme.border}`, borderRadius: '0', backgroundColor: theme.bg, color: theme.text, cursor: 'pointer', fontSize: '13px' }}>1</button>
                                );
                                if (start > 2) pages.push(<span key="dots1" style={{ padding: '0 4px', color: theme.textSecondary }}>...</span>);
                            }
                            
                            for (let i = start; i <= end; i++) {
                                pages.push(
                                    <button 
                                        key={i} 
                                        onClick={() => setCurrentPage(i)}
                                        style={{ 
                                            padding: '6px 12px', 
                                            border: `1px solid ${currentPage === i ? '#3b82f6' : theme.border}`, 
                                            borderRadius: '0', 
                                            backgroundColor: currentPage === i ? '#3b82f6' : theme.bg, 
                                            color: currentPage === i ? 'white' : theme.text, 
                                            cursor: 'pointer',
                                            fontSize: '13px',
                                            fontWeight: currentPage === i ? '600' : '400'
                                        }}
                                    >
                                        {i}
                                    </button>
                                );
                            }
                            
                            if (end < totalPages) {
                                if (end < totalPages - 1) pages.push(<span key="dots2" style={{ padding: '0 4px', color: theme.textSecondary }}>...</span>);
                                pages.push(
                                    <button key={totalPages} onClick={() => setCurrentPage(totalPages)} style={{ padding: '6px 12px', border: `1px solid ${theme.border}`, borderRadius: '0', backgroundColor: theme.bg, color: theme.text, cursor: 'pointer', fontSize: '13px' }}>{totalPages}</button>
                                );
                            }
                            
                            return pages;
                        })()}
                        
                        <button
                            onClick={() => setCurrentPage(p => Math.min(totalPages, p + 1))}
                            disabled={currentPage === totalPages}
                            style={{ 
                                padding: '6px 12px', 
                                border: `1px solid ${theme.border}`, 
                                borderRadius: '0', 
                                backgroundColor: currentPage === totalPages ? theme.bgTertiary : theme.bg, 
                                color: currentPage === totalPages ? theme.textMuted : theme.text, 
                                cursor: currentPage === totalPages ? 'not-allowed' : 'pointer',
                                fontSize: '13px'
                            }}
                        >
                            Next ‚Ä∫
                        </button>
                        <button
                            onClick={() => setCurrentPage(totalPages)}
                            disabled={currentPage === totalPages}
                            style={{ 
                                padding: '6px 10px', 
                                border: `1px solid ${theme.border}`, 
                                borderRadius: '0', 
                                backgroundColor: currentPage === totalPages ? theme.bgTertiary : theme.bg, 
                                color: currentPage === totalPages ? theme.textMuted : theme.text, 
                                cursor: currentPage === totalPages ? 'not-allowed' : 'pointer',
                                fontSize: '13px'
                            }}
                        >
                            ‚ü´
                        </button>
                    </div>
                </div>
            )}

            {/* Add Vehicle Modal */}
            {showAddModal && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: theme.modalOverlay, display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000, padding: '20px' }}>
                    <div style={{ backgroundColor: theme.bg, borderRadius: '0', width: '100%', maxWidth: '600px', maxHeight: '90vh', overflow: 'auto', boxShadow: '0 25px 50px -12px rgba(0,0,0,0.25)' }}>
                        <div style={{ padding: '20px 24px', borderBottom: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <h2 style={{ margin: 0, fontSize: '18px', fontWeight: '600', color: theme.text }}>Add Vehicle to Garage Queue</h2>
                            <button onClick={() => setShowAddModal(false)} style={{ background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer', color: theme.textSecondary }}>√ó</button>
                        </div>
                        <div style={{ padding: '24px' }}>
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px', marginBottom: '16px' }}>
                                <div>
                                    <label style={{ display: 'block', fontSize: '13px', color: theme.textSecondary, marginBottom: '6px' }}>Plate Number *</label>
                                    <input
                                        type="text"
                                        value={formData.plateNumber}
                                        onChange={(e) => setFormData(prev => ({ ...prev, plateNumber: e.target.value.toUpperCase() }))}
                                        placeholder="e.g., KAB 123A"
                                        style={{ width: '100%', padding: '10px 12px', border: `1px solid ${theme.border}`, borderRadius: '0', fontSize: '14px', backgroundColor: theme.inputBg, color: theme.text }}
                                    />
                                </div>
                                <div>
                                    <label style={{ display: 'block', fontSize: '13px', color: theme.textSecondary, marginBottom: '6px' }}>Vehicle Type</label>
                                    <select
                                        value={formData.vehicleType}
                                        onChange={(e) => setFormData(prev => ({ ...prev, vehicleType: e.target.value }))}
                                        style={{ width: '100%', padding: '10px 12px', border: `1px solid ${theme.border}`, borderRadius: '0', fontSize: '14px', backgroundColor: theme.inputBg, color: theme.text }}
                                    >
                                        {VEHICLE_TYPES.map(type => (
                                            <option key={type} value={type}>{type}</option>
                                        ))}
                                    </select>
                                </div>
                            </div>
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px', marginBottom: '16px' }}>
                                <div>
                                    <label style={{ display: 'block', fontSize: '13px', color: theme.textSecondary, marginBottom: '6px' }}>Customer Name</label>
                                    <input
                                        type="text"
                                        value={formData.customerName}
                                        onChange={(e) => setFormData(prev => ({ ...prev, customerName: e.target.value }))}
                                        placeholder="Customer name"
                                        style={{ width: '100%', padding: '10px 12px', border: `1px solid ${theme.border}`, borderRadius: '0', fontSize: '14px', backgroundColor: theme.inputBg, color: theme.text }}
                                    />
                                </div>
                                <div>
                                    <label style={{ display: 'block', fontSize: '13px', color: theme.textSecondary, marginBottom: '6px' }}>Phone Number</label>
                                    <input
                                        type="tel"
                                        value={formData.customerPhone}
                                        onChange={(e) => setFormData(prev => ({ ...prev, customerPhone: e.target.value }))}
                                        placeholder="0700 000 000"
                                        style={{ width: '100%', padding: '10px 12px', border: `1px solid ${theme.border}`, borderRadius: '0', fontSize: '14px', backgroundColor: theme.inputBg, color: theme.text }}
                                    />
                                </div>
                            </div>
                            <div style={{ marginBottom: '16px' }}>
                                <label style={{ display: 'block', fontSize: '13px', color: theme.textSecondary, marginBottom: '6px' }}>Priority</label>
                                <div style={{ display: 'flex', gap: '8px' }}>
                                    {PRIORITY_OPTIONS.map(p => (
                                        <button
                                            key={p.id}
                                            onClick={() => setFormData(prev => ({ ...prev, priority: p.id }))}
                                            style={{
                                                padding: '8px 16px',
                                                borderRadius: '0',
                                                border: formData.priority === p.id ? `2px solid ${p.color}` : `1px solid ${theme.border}`,
                                                backgroundColor: formData.priority === p.id ? `${p.color}15` : theme.bg,
                                                color: formData.priority === p.id ? p.color : theme.text,
                                                cursor: 'pointer',
                                                fontSize: '13px',
                                                fontWeight: '500'
                                            }}
                                        >
                                            {p.name}
                                        </button>
                                    ))}
                                </div>
                            </div>
                            <div style={{ marginBottom: '16px' }}>
                                <label style={{ display: 'block', fontSize: '13px', color: theme.textSecondary, marginBottom: '6px' }}>Assigned Technician</label>
                                {staffList.length === 0 ? (
                                    <div style={{
                                        padding: '12px',
                                        backgroundColor: theme.bgSecondary, 
                                        borderRadius: '0',
                                        border: `1px dashed ${theme.border}`,
                                        textAlign: 'center',
                                        color: theme.textSecondary,
                                        fontSize: '13px'
                                    }}>
                                        No technicians available. Add staff in Staff Management.
                                    </div>
                                ) : (
                                    <select
                                        value={formData.assignedTo}
                                        onChange={e => setFormData(prev => ({ ...prev, assignedTo: e.target.value }))}
                                        style={{
                                            width: '100%',
                                            padding: '10px 12px',
                                            borderRadius: '0',
                                            border: `1px solid ${theme.border}`,
                                            backgroundColor: theme.inputBg,
                                            color: theme.text,
                                            fontSize: '14px'
                                        }}
                                    >
                                        <option value="">-- Select Technician (Optional) --</option>
                                        {staffList.map(staff => (
                                            <option key={staff.id} value={staff.name}>
                                                {staff.name} ({staff.role})
                                            </option>
                                        ))}
                                    </select>
                                )}
                            </div>
                            <div style={{ marginBottom: '16px' }}>
                                <label style={{ display: 'block', fontSize: '13px', color: theme.textSecondary, marginBottom: '6px' }}>Services Required</label>
                                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '8px', maxHeight: '200px', overflowY: 'auto', padding: '4px' }}>
                                    {garageServices.map(service => (
                                        <div
                                            key={service.id}
                                            onClick={() => toggleService(service.id)}
                                            style={{
                                                padding: '12px',
                                                borderRadius: '0',
                                                border: formData.services.includes(service.id) ? '2px solid #3b82f6' : `1px solid ${theme.border}`,
                                                backgroundColor: formData.services.includes(service.id) ? '#dbeafe' : theme.bg,
                                                cursor: 'pointer',
                                                transition: 'all 0.2s'
                                            }}
                                        >
                                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                                                <div>
                                                    <div style={{ fontWeight: '500', color: theme.text, fontSize: '14px' }}>{service.name}</div>
                                                    <div style={{ fontSize: '12px', color: theme.textSecondary, marginTop: '2px' }}>{service.duration} mins</div>
                                                </div>
                                                <div style={{ fontWeight: '600', color: '#3b82f6', fontSize: '14px' }}>{formatCurrency(service.price)}</div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                {formData.services.length > 0 && (
                                    <div style={{ marginTop: '12px', padding: '12px', backgroundColor: theme.bgTertiary, borderRadius: '0', display: 'flex', justifyContent: 'space-between' }}>
                                        <span style={{ color: theme.textSecondary }}>{formData.services.length} service(s) selected</span>
                                        <span style={{ fontWeight: '600', color: theme.text }}>
                                            Total: {formatCurrency(formData.services.reduce((sum, sId) => {
                                                const service = garageServices.find(s => s.id === sId);
                                                return sum + (service?.price || 0);
                                            }, 0))}
                                        </span>
                                    </div>
                                )}
                            </div>
                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'block', fontSize: '13px', color: theme.textSecondary, marginBottom: '6px' }}>Notes</label>
                                <textarea
                                    value={formData.notes}
                                    onChange={(e) => setFormData(prev => ({ ...prev, notes: e.target.value }))}
                                    placeholder="Additional notes..."
                                    rows={3}
                                    style={{ width: '100%', padding: '10px 12px', border: `1px solid ${theme.border}`, borderRadius: '0', fontSize: '14px', backgroundColor: theme.inputBg, color: theme.text, resize: 'vertical' }}
                                />
                            </div>
                            <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end' }}>
                                <button
                                    onClick={() => setShowAddModal(false)}
                                    style={{ padding: '10px 20px', backgroundColor: theme.bgTertiary, color: theme.text, border: 'none', borderRadius: '0', cursor: 'pointer', fontSize: '14px' }}
                                >
                                    Cancel
                                </button>
                                <button
                                    onClick={handleAddToQueue}
                                    disabled={actionLoading || !formData.plateNumber.trim()}
                                    style={{ padding: '10px 20px', backgroundColor: '#3b82f6', color: 'white', border: 'none', borderRadius: '0', cursor: 'pointer', fontSize: '14px', fontWeight: '500' }}
                                >
                                    {actionLoading ? 'Adding...' : 'Add to Queue'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* View Modal */}
            {showViewModal && selectedItem && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: theme.modalOverlay, display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000, padding: '20px' }}>
                    <div style={{ backgroundColor: theme.bg, borderRadius: '0', width: '100%', maxWidth: '500px', maxHeight: '90vh', overflow: 'auto', boxShadow: '0 25px 50px -12px rgba(0,0,0,0.25)' }}>
                        <div style={{ padding: '20px 24px', borderBottom: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <h2 style={{ margin: 0, fontSize: '18px', fontWeight: '600', color: theme.text }}>Vehicle Details</h2>
                            <button onClick={() => setShowViewModal(false)} style={{ background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer', color: theme.textSecondary }}>√ó</button>
                        </div>
                        <div style={{ padding: '24px' }}>
                            {/* Vehicle Info */}
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px', marginBottom: '20px' }}>
                                <div>
                                    <div style={{ fontSize: '12px', color: theme.textSecondary, marginBottom: '4px' }}>Plate Number</div>
                                    <div style={{ fontSize: '18px', fontWeight: '600', color: theme.text }}>{selectedItem.plateNumber}</div>
                                </div>
                                <div>
                                    <div style={{ fontSize: '12px', color: theme.textSecondary, marginBottom: '4px' }}>Vehicle Type</div>
                                    <div style={{ fontSize: '16px', color: theme.text }}>{selectedItem.vehicleType || 'N/A'}</div>
                                </div>
                            </div>

                            {/* Customer Info */}
                            <div style={{ backgroundColor: theme.bgTertiary, padding: '16px', marginBottom: '20px' }}>
                                <div style={{ fontSize: '13px', fontWeight: '600', color: theme.text, marginBottom: '12px' }}>Customer Information</div>
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' }}>
                                    <div>
                                        <div style={{ fontSize: '12px', color: theme.textSecondary }}>Name</div>
                                        <div style={{ fontSize: '14px', color: theme.text }}>{selectedItem.customerName || 'Walk-in Customer'}</div>
                                    </div>
                                    <div>
                                        <div style={{ fontSize: '12px', color: theme.textSecondary }}>Phone</div>
                                        <div style={{ fontSize: '14px', color: theme.text }}>{selectedItem.customerPhone || 'N/A'}</div>
                                    </div>
                                </div>
                            </div>

                            {/* Status */}
                            <div style={{ marginBottom: '20px', display: 'flex', gap: '24px' }}>
                                <div>
                                    <div style={{ fontSize: '12px', color: theme.textSecondary, marginBottom: '8px' }}>Status</div>
                                    <span style={{
                                        display: 'inline-block',
                                        padding: '6px 14px',
                                        backgroundColor: selectedItem.status === 'completed' ? '#d1fae5' : selectedItem.status === 'in-progress' ? '#fef3c7' : '#dbeafe',
                                        color: selectedItem.status === 'completed' ? '#059669' : selectedItem.status === 'in-progress' ? '#d97706' : '#2563eb',
                                        fontWeight: '500',
                                        fontSize: '13px'
                                    }}>
                                        {selectedItem.status === 'completed' ? '‚úÖ Completed' : selectedItem.status === 'in-progress' ? 'üîß In Progress' : '‚è≥ Waiting'}
                                    </span>
                                </div>
                                <div>
                                    <div style={{ fontSize: '12px', color: theme.textSecondary, marginBottom: '8px' }}>Assigned Technician</div>
                                    <span style={{
                                        display: 'inline-block',
                                        padding: '6px 14px',
                                        backgroundColor: selectedItem.assignedTo ? '#dbeafe' : theme.bgTertiary,
                                        color: selectedItem.assignedTo ? '#2563eb' : theme.textSecondary,
                                        fontWeight: '500',
                                        fontSize: '13px'
                                    }}>
                                        {selectedItem.assignedTo ? `üë§ ${selectedItem.assignedTo}` : 'Unassigned'}
                                    </span>
                                </div>
                            </div>

                            {/* Services */}
                            <div style={{ marginBottom: '20px' }}>
                                <div style={{ fontSize: '13px', fontWeight: '600', color: theme.text, marginBottom: '12px' }}>Services</div>
                                {selectedItem.services?.length > 0 ? (
                                    <div style={{ border: `1px solid ${theme.border}` }}>
                                        {selectedItem.services.map((svc, idx) => {
                                            // Handle both service objects (from intake) and service IDs
                                            const service = typeof svc === 'object' ? svc : garageServices.find(s => s.id === svc);
                                            return service ? (
                                                <div key={idx} style={{ display: 'flex', justifyContent: 'space-between', padding: '12px', borderBottom: idx < selectedItem.services.length - 1 ? `1px solid ${theme.border}` : 'none' }}>
                                                    <div>
                                                        <div style={{ color: theme.text, fontWeight: '500' }}>{service.name}</div>
                                                        {service.duration && <div style={{ fontSize: '12px', color: theme.textSecondary }}>{service.duration} mins</div>}
                                                    </div>
                                                    <div style={{ fontWeight: '600', color: '#3b82f6' }}>{formatCurrency(parseFloat(service.price) || 0)}</div>
                                                </div>
                                            ) : null;
                                        })}
                                        <div style={{ display: 'flex', justifyContent: 'space-between', padding: '12px', backgroundColor: theme.bgTertiary, fontWeight: '600' }}>
                                            <span style={{ color: theme.text }}>Total</span>
                                            <span style={{ color: '#10b981', fontSize: '16px' }}>
                                                {formatCurrency(
                                                    selectedItem.totalCost || 
                                                    selectedItem.services.reduce((sum, svc) => {
                                                        if (typeof svc === 'object') {
                                                            return sum + (parseFloat(svc.price) || 0);
                                                        }
                                                        const service = garageServices.find(s => s.id === svc);
                                                        return sum + (service?.price || 0);
                                                    }, 0)
                                                )}
                                            </span>
                                        </div>
                                    </div>
                                ) : (
                                    <div style={{ padding: '16px', backgroundColor: theme.bgTertiary, color: theme.textSecondary, textAlign: 'center' }}>No services selected</div>
                                )}
                            </div>

                            {/* Notes */}
                            {selectedItem.notes && (
                                <div style={{ marginBottom: '20px' }}>
                                    <div style={{ fontSize: '12px', color: theme.textSecondary, marginBottom: '8px' }}>Notes</div>
                                    <div style={{ padding: '12px', backgroundColor: theme.bgTertiary, color: theme.text, fontSize: '14px' }}>{selectedItem.notes}</div>
                                </div>
                            )}

                            {/* Timestamps */}
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px', fontSize: '12px', color: theme.textSecondary }}>
                                <div>
                                    <span>Added: </span>
                                    <span style={{ color: theme.text }}>{new Date(selectedItem.addedAt || selectedItem.createdAt).toLocaleString()}</span>
                                </div>
                                {selectedItem.startedAt && (
                                    <div>
                                        <span>Started: </span>
                                        <span style={{ color: theme.text }}>{new Date(selectedItem.startedAt).toLocaleString()}</span>
                                    </div>
                                )}
                                {selectedItem.completedAt && (
                                    <div>
                                        <span>Completed: </span>
                                        <span style={{ color: theme.text }}>{new Date(selectedItem.completedAt).toLocaleString()}</span>
                                    </div>
                                )}
                            </div>
                        </div>
                        <div style={{ padding: '16px 24px', borderTop: `1px solid ${theme.border}`, display: 'flex', gap: '12px', justifyContent: 'flex-end' }}>
                            <button
                                onClick={() => { setShowViewModal(false); handleShowReceipt(selectedItem); }}
                                style={{ padding: '10px 20px', backgroundColor: '#f0fdf4', color: '#16a34a', border: 'none', borderRadius: '0', cursor: 'pointer', fontSize: '14px', fontWeight: '500' }}
                            >
                                üßæ View Receipt
                            </button>
                            <button
                                onClick={() => setShowViewModal(false)}
                                style={{ padding: '10px 20px', backgroundColor: theme.bgTertiary, color: theme.text, border: 'none', borderRadius: '0', cursor: 'pointer', fontSize: '14px' }}
                            >
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* Receipt Modal */}
            {showReceiptModal && selectedItem && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: theme.modalOverlay, display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000, padding: '20px' }}>
                    <div style={{ backgroundColor: 'white', borderRadius: '0', width: '100%', maxWidth: '420px', maxHeight: '90vh', overflow: 'auto', boxShadow: '0 25px 50px -12px rgba(0,0,0,0.25)' }}>
                        {/* Receipt Header */}
                        <div style={{ padding: '24px', textAlign: 'center', borderBottom: '2px solid #333' }}>
                            <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#333' }}>üîß {getBrandingForReceipts().companyName} GARAGE</div>
                            <div style={{ color: '#666', fontSize: '12px', marginTop: '4px' }}>Auto Service Receipt</div>
                            {getBrandingForReceipts().address && <div style={{ color: '#666', fontSize: '11px', marginTop: '2px' }}>{getBrandingForReceipts().address}{getBrandingForReceipts().city ? `, ${getBrandingForReceipts().city}` : ''}</div>}
                            {getBrandingForReceipts().phone && <div style={{ color: '#666', fontSize: '11px' }}>Tel: {getBrandingForReceipts().phone}</div>}
                        </div>

                        <div style={{ padding: '20px 24px' }}>
                            {/* Receipt Number & Date */}
                            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '16px', paddingBottom: '16px', borderBottom: '1px dashed #ddd' }}>
                                <div>
                                    <div style={{ fontSize: '11px', color: '#666' }}>Receipt No.</div>
                                    <div style={{ fontWeight: '600', color: '#333' }}>#GRG-{selectedItem.id?.slice(-8) || Date.now().toString().slice(-8)}</div>
                                </div>
                                <div style={{ textAlign: 'right' }}>
                                    <div style={{ fontSize: '11px', color: '#666' }}>Date</div>
                                    <div style={{ fontWeight: '500', color: '#333' }}>{new Date().toLocaleDateString()}</div>
                                </div>
                            </div>

                            {/* Vehicle & Customer */}
                            <div style={{ marginBottom: '16px', paddingBottom: '16px', borderBottom: '1px dashed #ddd' }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '8px' }}>
                                    <span style={{ color: '#666', fontSize: '13px' }}>Vehicle:</span>
                                    <span style={{ fontWeight: '600', color: '#333' }}>{selectedItem.plateNumber}</span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '8px' }}>
                                    <span style={{ color: '#666', fontSize: '13px' }}>Type:</span>
                                    <span style={{ color: '#333' }}>{selectedItem.vehicleType || 'N/A'}</span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '8px' }}>
                                    <span style={{ color: '#666', fontSize: '13px' }}>Customer:</span>
                                    <span style={{ color: '#333' }}>{selectedItem.customerName || 'Walk-in'}</span>
                                </div>
                                {selectedItem.customerPhone && (
                                    <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                                        <span style={{ color: '#666', fontSize: '13px' }}>Phone:</span>
                                        <span style={{ color: '#333' }}>{selectedItem.customerPhone}</span>
                                    </div>
                                )}
                            </div>

                            {/* Services List */}
                            <div style={{ marginBottom: '16px' }}>
                                <div style={{ fontWeight: '600', color: '#333', marginBottom: '12px', fontSize: '14px' }}>Services</div>
                                {selectedItem.services?.length > 0 ? (
                                    selectedItem.services.map((svc, idx) => {
                                        // Handle both service objects (from intake) and service IDs
                                        const service = typeof svc === 'object' ? svc : garageServices.find(s => s.id === svc);
                                        return service ? (
                                            <div key={idx} style={{ display: 'flex', justifyContent: 'space-between', padding: '8px 0', borderBottom: '1px solid #eee' }}>
                                                <span style={{ color: '#333' }}>{service.name}</span>
                                                <span style={{ fontWeight: '500', color: '#333' }}>{getBrandingForReceipts().currencySymbol || 'KSh'} {(parseFloat(service.price) || 0).toLocaleString()}</span>
                                            </div>
                                        ) : null;
                                    })
                                ) : (
                                    <div style={{ padding: '12px', backgroundColor: '#f5f5f5', color: '#666', textAlign: 'center' }}>No services</div>
                                )}
                            </div>

                            {/* Total */}
                            <div style={{ display: 'flex', justifyContent: 'space-between', padding: '16px 0', borderTop: '2px solid #333', marginTop: '8px' }}>
                                <span style={{ fontSize: '18px', fontWeight: 'bold', color: '#333' }}>TOTAL</span>
                                <span style={{ fontSize: '20px', fontWeight: 'bold', color: '#059669' }}>
                                    {getBrandingForReceipts().currencySymbol || 'KSh'} {(selectedItem.totalCost || selectedItem.services?.reduce((sum, svc) => {
                                        if (typeof svc === 'object') {
                                            return sum + (parseFloat(svc.price) || 0);
                                        }
                                        const service = garageServices.find(s => s.id === svc);
                                        return sum + (service?.price || 0);
                                    }, 0) || 0).toLocaleString()}
                                </span>
                            </div>

                            {/* Status Badge */}
                            <div style={{ textAlign: 'center', marginTop: '16px' }}>
                                <span style={{
                                    display: 'inline-block',
                                    padding: '8px 20px',
                                    backgroundColor: selectedItem.status === 'completed' ? '#d1fae5' : '#fef3c7',
                                    color: selectedItem.status === 'completed' ? '#059669' : '#d97706',
                                    fontWeight: '600',
                                    fontSize: '14px'
                                }}>
                                    {selectedItem.status === 'completed' ? '‚úÖ PAID & COMPLETED' : 'üîß IN PROGRESS'}
                                </span>
                            </div>

                            {/* Notes */}
                            {selectedItem.notes && (
                                <div style={{ marginTop: '16px', padding: '12px', backgroundColor: '#f5f5f5', fontSize: '13px', color: '#666' }}>
                                    <strong>Notes:</strong> {selectedItem.notes}
                                </div>
                            )}
                        </div>

                        {/* Footer */}
                        <div style={{ padding: '16px 24px', borderTop: '1px dashed #ddd', textAlign: 'center' }}>
                            <p style={{ margin: '0 0 8px 0', color: '#666', fontSize: '12px' }}>{getBrandingForReceipts().receiptFooter || 'Thank you for choosing us!'}</p>
                            <p style={{ margin: 0, color: '#999', fontSize: '11px' }}>Your vehicle is in safe hands üöó</p>
                        </div>

                        {/* Action Buttons */}
                        <div style={{ padding: '16px 24px', borderTop: `1px solid #eee`, display: 'flex', gap: '12px', justifyContent: 'center', backgroundColor: '#f9fafb' }}>
                            <button
                                onClick={handlePrintReceipt}
                                style={{ padding: '10px 24px', backgroundColor: '#3b82f6', color: 'white', border: 'none', borderRadius: '0', cursor: 'pointer', fontSize: '14px', fontWeight: '500', display: 'flex', alignItems: 'center', gap: '6px' }}
                            >
                                üñ®Ô∏è Print Receipt
                            </button>
                            <button
                                onClick={() => setShowReceiptModal(false)}
                                style={{ padding: '10px 24px', backgroundColor: '#e5e7eb', color: '#374151', border: 'none', borderRadius: '0', cursor: 'pointer', fontSize: '14px' }}
                            >
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* History Modal */}
            {showHistoryModal && selectedItem && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: theme.modalOverlay, display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000, padding: '20px' }}>
                    <div style={{ backgroundColor: theme.bg, borderRadius: '0', width: '100%', maxWidth: '500px', maxHeight: '90vh', overflow: 'auto', boxShadow: '0 25px 50px -12px rgba(0,0,0,0.25)' }}>
                        <div style={{ padding: '20px 24px', borderBottom: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <h2 style={{ margin: 0, fontSize: '18px', fontWeight: '600', color: theme.text }}>üìú Job History</h2>
                            <button onClick={() => setShowHistoryModal(false)} style={{ background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer', color: theme.textSecondary }}>√ó</button>
                        </div>
                        <div style={{ padding: '24px' }}>
                            {/* Vehicle Info Header */}
                            <div style={{ backgroundColor: theme.bgTertiary, padding: '16px', marginBottom: '24px' }}>
                                <div style={{ fontWeight: '600', color: theme.text, fontSize: '16px' }}>{selectedItem.plateNumber}</div>
                                <div style={{ color: theme.textSecondary, fontSize: '13px' }}>{selectedItem.vehicleType} ‚Ä¢ {selectedItem.customerName || 'Walk-in Customer'}</div>
                            </div>

                            {/* Timeline */}
                            <div style={{ position: 'relative', paddingLeft: '24px' }}>
                                {/* Timeline line */}
                                <div style={{ position: 'absolute', left: '8px', top: '8px', bottom: '8px', width: '2px', backgroundColor: theme.border }}></div>

                                {/* Added to Queue */}
                                <div style={{ position: 'relative', marginBottom: '24px' }}>
                                    <div style={{ position: 'absolute', left: '-20px', width: '16px', height: '16px', backgroundColor: '#3b82f6', borderRadius: '50%', border: `2px solid ${theme.bg}` }}></div>
                                    <div style={{ paddingLeft: '8px' }}>
                                        <div style={{ fontWeight: '600', color: theme.text, fontSize: '14px' }}>Added to Queue</div>
                                        <div style={{ color: theme.textSecondary, fontSize: '12px', marginTop: '4px' }}>
                                            {selectedItem.addedAt ? new Date(selectedItem.addedAt).toLocaleString() : 'N/A'}
                                        </div>
                                        <div style={{ color: theme.textSecondary, fontSize: '12px', marginTop: '2px' }}>
                                            Source: {selectedItem.source === 'intake' ? 'Vehicle Intake' : 'Direct Entry'}
                                        </div>
                                    </div>
                                </div>

                                {/* Job Started */}
                                <div style={{ position: 'relative', marginBottom: '24px' }}>
                                    <div style={{ position: 'absolute', left: '-20px', width: '16px', height: '16px', backgroundColor: '#f59e0b', borderRadius: '50%', border: `2px solid ${theme.bg}` }}></div>
                                    <div style={{ paddingLeft: '8px' }}>
                                        <div style={{ fontWeight: '600', color: theme.text, fontSize: '14px' }}>Job Started</div>
                                        <div style={{ color: theme.textSecondary, fontSize: '12px', marginTop: '4px' }}>
                                            {selectedItem.startedAt ? new Date(selectedItem.startedAt).toLocaleString() : 'N/A'}
                                        </div>
                                        <div style={{ color: theme.textSecondary, fontSize: '12px', marginTop: '2px' }}>
                                            Services: {selectedItem.services?.length || 0} selected
                                        </div>
                                    </div>
                                </div>

                                {/* Last Updated (if notes were added) */}
                                {selectedItem.lastUpdated && (
                                    <div style={{ position: 'relative', marginBottom: '24px' }}>
                                        <div style={{ position: 'absolute', left: '-20px', width: '16px', height: '16px', backgroundColor: '#8b5cf6', borderRadius: '50%', border: `2px solid ${theme.bg}` }}></div>
                                        <div style={{ paddingLeft: '8px' }}>
                                            <div style={{ fontWeight: '600', color: theme.text, fontSize: '14px' }}>Notes Updated</div>
                                            <div style={{ color: theme.textSecondary, fontSize: '12px', marginTop: '4px' }}>
                                                {new Date(selectedItem.lastUpdated).toLocaleString()}
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* Completed */}
                                {selectedItem.completedAt && (
                                    <div style={{ position: 'relative' }}>
                                        <div style={{ position: 'absolute', left: '-20px', width: '16px', height: '16px', backgroundColor: '#10b981', borderRadius: '50%', border: `2px solid ${theme.bg}` }}></div>
                                        <div style={{ paddingLeft: '8px' }}>
                                            <div style={{ fontWeight: '600', color: theme.text, fontSize: '14px' }}>‚úÖ Job Completed</div>
                                            <div style={{ color: theme.textSecondary, fontSize: '12px', marginTop: '4px' }}>
                                                {new Date(selectedItem.completedAt).toLocaleString()}
                                            </div>
                                            <div style={{ color: '#10b981', fontWeight: '600', fontSize: '14px', marginTop: '4px' }}>
                                                Total: {formatCurrency(selectedItem.totalCost || 0)}
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>

                            {/* Technician Notes Section */}
                            {selectedItem.technicianNotes && (
                                <div style={{ marginTop: '24px', padding: '16px', backgroundColor: '#fef3c7', border: '1px solid #fcd34d' }}>
                                    <div style={{ fontWeight: '600', color: '#92400e', fontSize: '13px', marginBottom: '8px' }}>üìù Technician Notes</div>
                                    <div style={{ color: '#78350f', fontSize: '14px', whiteSpace: 'pre-wrap' }}>{selectedItem.technicianNotes}</div>
                                </div>
                            )}

                            {/* Initial Notes */}
                            {selectedItem.notes && (
                                <div style={{ marginTop: '16px', padding: '16px', backgroundColor: theme.bgTertiary }}>
                                    <div style={{ fontWeight: '600', color: theme.textSecondary, fontSize: '13px', marginBottom: '8px' }}>Initial Notes</div>
                                    <div style={{ color: theme.text, fontSize: '14px' }}>{selectedItem.notes}</div>
                                </div>
                            )}
                        </div>
                        <div style={{ padding: '16px 24px', borderTop: `1px solid ${theme.border}`, display: 'flex', gap: '12px', justifyContent: 'flex-end' }}>
                            <button
                                onClick={() => setShowHistoryModal(false)}
                                style={{ padding: '10px 20px', backgroundColor: theme.bgTertiary, color: theme.text, border: 'none', borderRadius: '0', cursor: 'pointer', fontSize: '14px' }}
                            >
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* Technician Notes Modal */}
            {showNotesModal && selectedItem && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: theme.modalOverlay, display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000, padding: '20px' }}>
                    <div style={{ backgroundColor: theme.bg, borderRadius: '0', width: '100%', maxWidth: '500px', maxHeight: '90vh', overflow: 'auto', boxShadow: '0 25px 50px -12px rgba(0,0,0,0.25)' }}>
                        <div style={{ padding: '20px 24px', borderBottom: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <h2 style={{ margin: 0, fontSize: '18px', fontWeight: '600', color: theme.text }}>üìù Technician Notes</h2>
                            <button onClick={() => setShowNotesModal(false)} style={{ background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer', color: theme.textSecondary }}>√ó</button>
                        </div>
                        <div style={{ padding: '24px' }}>
                            {/* Vehicle Info */}
                            <div style={{ backgroundColor: theme.bgTertiary, padding: '16px', marginBottom: '20px' }}>
                                <div style={{ fontWeight: '600', color: theme.text, fontSize: '16px' }}>{selectedItem.plateNumber}</div>
                                <div style={{ color: theme.textSecondary, fontSize: '13px' }}>{selectedItem.vehicleType} ‚Ä¢ {selectedItem.customerName || 'Walk-in Customer'}</div>
                            </div>

                            {/* Services Being Worked On */}
                            <div style={{ marginBottom: '20px' }}>
                                <div style={{ fontSize: '13px', fontWeight: '600', color: theme.text, marginBottom: '8px' }}>Services In Progress</div>
                                <div style={{ display: 'flex', gap: '6px', flexWrap: 'wrap' }}>
                                    {selectedItem.services?.map((sId, idx) => {
                                        const service = garageServices.find(s => s.id === sId);
                                        return service ? (
                                            <span key={idx} style={{ fontSize: '12px', padding: '4px 10px', backgroundColor: '#dbeafe', color: '#2563eb' }}>
                                                {service.name}
                                            </span>
                                        ) : null;
                                    })}
                                    {(!selectedItem.services || selectedItem.services.length === 0) && (
                                        <span style={{ color: theme.textMuted, fontSize: '13px' }}>No services selected</span>
                                    )}
                                </div>
                            </div>

                            {/* Notes Input */}
                            <div>
                                <label style={{ display: 'block', fontSize: '13px', fontWeight: '600', color: theme.text, marginBottom: '8px' }}>
                                    Add your notes below:
                                </label>
                                <textarea
                                    value={technicianNotes}
                                    onChange={(e) => setTechnicianNotes(e.target.value)}
                                    placeholder="Describe what was done, parts replaced, issues found, recommendations for customer, etc."
                                    rows={6}
                                    style={{ 
                                        width: '100%', 
                                        padding: '12px', 
                                        border: `1px solid ${theme.border}`, 
                                        borderRadius: '0', 
                                        fontSize: '14px', 
                                        backgroundColor: theme.inputBg, 
                                        color: theme.text, 
                                        resize: 'vertical',
                                        fontFamily: 'inherit'
                                    }}
                                />
                                <div style={{ marginTop: '8px', fontSize: '12px', color: theme.textSecondary }}>
                                    üí° Tip: Include details like parts replaced, labor performed, and any recommendations for future service.
                                </div>
                            </div>
                        </div>
                        <div style={{ padding: '16px 24px', borderTop: `1px solid ${theme.border}`, display: 'flex', gap: '12px', justifyContent: 'flex-end' }}>
                            <button
                                onClick={() => setShowNotesModal(false)}
                                style={{ padding: '10px 20px', backgroundColor: theme.bgTertiary, color: theme.text, border: 'none', borderRadius: '0', cursor: 'pointer', fontSize: '14px' }}
                            >
                                Cancel
                            </button>
                            <button
                                onClick={handleSaveNotes}
                                disabled={actionLoading}
                                style={{ padding: '10px 20px', backgroundColor: '#3b82f6', color: 'white', border: 'none', borderRadius: '0', cursor: 'pointer', fontSize: '14px', fontWeight: '500' }}
                            >
                                {actionLoading ? 'Saving...' : 'üíæ Save Notes'}
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* Services Management Modal */}
            {showServicesModal && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: theme.modalOverlay, display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000, padding: '20px' }}>
                    <div style={{ backgroundColor: theme.bg, borderRadius: '0', width: '100%', maxWidth: '800px', maxHeight: '90vh', overflow: 'auto', boxShadow: '0 25px 50px -12px rgba(0,0,0,0.25)' }}>
                        <div style={{ padding: '20px 24px', borderBottom: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'space-between', alignItems: 'center', position: 'sticky', top: 0, backgroundColor: theme.bg, zIndex: 1 }}>
                            <h2 style={{ margin: 0, fontSize: '18px', fontWeight: '600', color: theme.text }}>‚öôÔ∏è Manage Garage Services</h2>
                            <div style={{ display: 'flex', gap: '12px', alignItems: 'center' }}>
                                <button
                                    onClick={handleAddService}
                                    style={{ padding: '8px 16px', backgroundColor: '#10b981', color: 'white', border: 'none', borderRadius: '0', cursor: 'pointer', fontSize: '13px', fontWeight: '500', display: 'flex', alignItems: 'center', gap: '6px' }}
                                >
                                    {Icons.plus} Add Service
                                </button>
                                <button onClick={() => setShowServicesModal(false)} style={{ background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer', color: theme.textSecondary }}>√ó</button>
                            </div>
                        </div>
                        <div style={{ padding: '24px' }}>
                            {garageServices.length === 0 ? (
                                <div style={{ textAlign: 'center', padding: '48px', color: theme.textSecondary }}>
                                    <span style={{ fontSize: '48px', display: 'block', marginBottom: '12px' }}>üîß</span>
                                    <p>No services yet. Click "Add Service" to create one.</p>
                                </div>
                            ) : (
                                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(350px, 1fr))', gap: '16px' }}>
                                    {garageServices.map(service => (
                                        <div key={service.id} style={{ 
                                            border: `1px solid ${theme.border}`, 
                                            padding: '16px',
                                            backgroundColor: theme.bgSecondary
                                        }}>
                                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '12px' }}>
                                                <div>
                                                    <div style={{ fontWeight: '600', color: theme.text, fontSize: '15px' }}>{service.name}</div>
                                                    <span style={{ 
                                                        display: 'inline-block',
                                                        fontSize: '11px', 
                                                        padding: '2px 8px', 
                                                        backgroundColor: (SERVICE_CATEGORIES.find(c => c.id === service.category)?.color || '#6b7280') + '20',
                                                        color: SERVICE_CATEGORIES.find(c => c.id === service.category)?.color || '#6b7280',
                                                        marginTop: '4px'
                                                    }}>
                                                        {SERVICE_CATEGORIES.find(c => c.id === service.category)?.name || 'Other'}
                                                    </span>
                                                </div>
                                                <div style={{ fontWeight: '700', color: '#10b981', fontSize: '16px' }}>
                                                    {getBrandingForReceipts().currencySymbol || 'KSh'} {(service.price || 0).toLocaleString()}
                                                </div>
                                            </div>
                                            <div style={{ fontSize: '13px', color: theme.textSecondary, marginBottom: '12px' }}>
                                                <span>‚è±Ô∏è {service.duration || 30} mins</span>
                                                {service.description && (
                                                    <div style={{ marginTop: '6px' }}>{service.description}</div>
                                                )}
                                            </div>
                                            <div style={{ display: 'flex', gap: '8px', justifyContent: 'flex-end' }}>
                                                <button
                                                    onClick={() => handleEditService(service)}
                                                    style={{ padding: '6px 12px', backgroundColor: '#dbeafe', color: '#2563eb', border: 'none', borderRadius: '0', cursor: 'pointer', fontSize: '12px', fontWeight: '500' }}
                                                >
                                                    ‚úèÔ∏è Edit
                                                </button>
                                                <button
                                                    onClick={() => handleDeleteService(service.id)}
                                                    disabled={actionLoading}
                                                    style={{ padding: '6px 12px', backgroundColor: '#fee2e2', color: '#dc2626', border: 'none', borderRadius: '0', cursor: 'pointer', fontSize: '12px', fontWeight: '500' }}
                                                >
                                                    üóëÔ∏è Delete
                                                </button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                        <div style={{ padding: '16px 24px', borderTop: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <span style={{ fontSize: '13px', color: theme.textSecondary }}>{garageServices.length} service(s) available</span>
                            <button
                                onClick={() => setShowServicesModal(false)}
                                style={{ padding: '10px 20px', backgroundColor: theme.bgTertiary, color: theme.text, border: 'none', borderRadius: '0', cursor: 'pointer', fontSize: '14px' }}
                            >
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* Service Add/Edit Form Modal */}
            {showServiceFormModal && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: theme.modalOverlay, display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1001, padding: '20px' }}>
                    <div style={{ backgroundColor: theme.bg, borderRadius: '0', width: '100%', maxWidth: '500px', maxHeight: '90vh', overflow: 'auto', boxShadow: '0 25px 50px -12px rgba(0,0,0,0.25)' }}>
                        <div style={{ padding: '20px 24px', borderBottom: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <h2 style={{ margin: 0, fontSize: '18px', fontWeight: '600', color: theme.text }}>
                                {editingService ? '‚úèÔ∏è Edit Service' : '‚ûï Add New Service'}
                            </h2>
                            <button onClick={() => setShowServiceFormModal(false)} style={{ background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer', color: theme.textSecondary }}>√ó</button>
                        </div>
                        <div style={{ padding: '24px' }}>
                            <div style={{ marginBottom: '16px' }}>
                                <label style={{ display: 'block', fontSize: '13px', fontWeight: '500', color: theme.text, marginBottom: '6px' }}>Service Name *</label>
                                <input
                                    type="text"
                                    value={serviceFormData.name}
                                    onChange={(e) => setServiceFormData(prev => ({ ...prev, name: e.target.value }))}
                                    placeholder="e.g., Oil Change, Brake Inspection"
                                    style={{ width: '100%', padding: '10px 12px', border: `1px solid ${theme.border}`, borderRadius: '0', fontSize: '14px', backgroundColor: theme.inputBg, color: theme.text }}
                                />
                            </div>
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px', marginBottom: '16px' }}>
                                <div>
                                    <label style={{ display: 'block', fontSize: '13px', fontWeight: '500', color: theme.text, marginBottom: '6px' }}>Price ({getBrandingForReceipts().currencySymbol || 'KSh'}) *</label>
                                    <input
                                        type="number"
                                        value={serviceFormData.price}
                                        onChange={(e) => setServiceFormData(prev => ({ ...prev, price: e.target.value }))}
                                        placeholder="0"
                                        min="0"
                                        style={{ width: '100%', padding: '10px 12px', border: `1px solid ${theme.border}`, borderRadius: '0', fontSize: '14px', backgroundColor: theme.inputBg, color: theme.text }}
                                    />
                                </div>
                                <div>
                                    <label style={{ display: 'block', fontSize: '13px', fontWeight: '500', color: theme.text, marginBottom: '6px' }}>Duration (mins)</label>
                                    <input
                                        type="number"
                                        value={serviceFormData.duration}
                                        onChange={(e) => setServiceFormData(prev => ({ ...prev, duration: e.target.value }))}
                                        placeholder="30"
                                        min="1"
                                        style={{ width: '100%', padding: '10px 12px', border: `1px solid ${theme.border}`, borderRadius: '0', fontSize: '14px', backgroundColor: theme.inputBg, color: theme.text }}
                                    />
                                </div>
                            </div>
                            <div style={{ marginBottom: '16px' }}>
                                <label style={{ display: 'block', fontSize: '13px', fontWeight: '500', color: theme.text, marginBottom: '6px' }}>Category</label>
                                <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                                    {SERVICE_CATEGORIES.map(cat => (
                                        <button
                                            key={cat.id}
                                            onClick={() => setServiceFormData(prev => ({ ...prev, category: cat.id }))}
                                            style={{
                                                padding: '8px 14px',
                                                border: serviceFormData.category === cat.id ? `2px solid ${cat.color}` : `1px solid ${theme.border}`,
                                                borderRadius: '0',
                                                backgroundColor: serviceFormData.category === cat.id ? `${cat.color}15` : theme.bg,
                                                color: serviceFormData.category === cat.id ? cat.color : theme.text,
                                                cursor: 'pointer',
                                                fontSize: '13px',
                                                fontWeight: '500'
                                            }}
                                        >
                                            {cat.name}
                                        </button>
                                    ))}
                                </div>
                            </div>
                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'block', fontSize: '13px', fontWeight: '500', color: theme.text, marginBottom: '6px' }}>Description</label>
                                <textarea
                                    value={serviceFormData.description}
                                    onChange={(e) => setServiceFormData(prev => ({ ...prev, description: e.target.value }))}
                                    placeholder="Brief description of what this service includes..."
                                    rows={3}
                                    style={{ width: '100%', padding: '10px 12px', border: `1px solid ${theme.border}`, borderRadius: '0', fontSize: '14px', backgroundColor: theme.inputBg, color: theme.text, resize: 'vertical' }}
                                />
                            </div>
                        </div>
                        <div style={{ padding: '16px 24px', borderTop: `1px solid ${theme.border}`, display: 'flex', gap: '12px', justifyContent: 'flex-end' }}>
                            <button
                                onClick={() => setShowServiceFormModal(false)}
                                style={{ padding: '10px 20px', backgroundColor: theme.bgTertiary, color: theme.text, border: 'none', borderRadius: '0', cursor: 'pointer', fontSize: '14px' }}
                            >
                                Cancel
                            </button>
                            <button
                                onClick={handleSaveService}
                                disabled={actionLoading || !serviceFormData.name.trim() || !serviceFormData.price}
                                style={{ 
                                    padding: '10px 20px', 
                                    backgroundColor: (!serviceFormData.name.trim() || !serviceFormData.price) ? '#94a3b8' : '#3b82f6', 
                                    color: 'white', 
                                    border: 'none', 
                                    borderRadius: '0', 
                                    cursor: (!serviceFormData.name.trim() || !serviceFormData.price) ? 'not-allowed' : 'pointer', 
                                    fontSize: '14px', 
                                    fontWeight: '500' 
                                }}
                            >
                                {actionLoading ? 'Saving...' : (editingService ? 'Update Service' : 'Add Service')}
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* Transfer to Garage Modal - Select Services */}
            {showTransferModal && transferVehicle && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: theme.modalOverlay, display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000, padding: '20px' }}>
                    <div style={{ backgroundColor: theme.bg, borderRadius: '0', width: '100%', maxWidth: '650px', maxHeight: '90vh', overflow: 'auto', boxShadow: '0 25px 50px -12px rgba(0,0,0,0.25)' }}>
                        <div style={{ padding: '20px 24px', borderBottom: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'space-between', alignItems: 'center', position: 'sticky', top: 0, backgroundColor: theme.bg, zIndex: 1 }}>
                            <h2 style={{ margin: 0, fontSize: '18px', fontWeight: '600', color: theme.text }}>üîß Send to Garage - Select Services</h2>
                            <button onClick={() => { setShowTransferModal(false); setTransferVehicle(null); }} style={{ background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer', color: theme.textSecondary }}>√ó</button>
                        </div>
                        <div style={{ padding: '24px' }}>
                            {/* Vehicle Info */}
                            <div style={{ backgroundColor: theme.bgTertiary, padding: '16px', marginBottom: '20px' }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                                    <div>
                                        <div style={{ fontWeight: '700', color: theme.text, fontSize: '18px' }}>{transferVehicle.plateNumber}</div>
                                        <div style={{ color: theme.textSecondary, fontSize: '14px', marginTop: '4px' }}>{transferVehicle.vehicleType}</div>
                                    </div>
                                    <div style={{ textAlign: 'right' }}>
                                        <div style={{ color: theme.text, fontSize: '14px' }}>{transferVehicle.customerName || 'Walk-in Customer'}</div>
                                        {transferVehicle.customerPhone && (
                                            <div style={{ color: theme.textSecondary, fontSize: '13px' }}>{transferVehicle.customerPhone}</div>
                                        )}
                                    </div>
                                </div>
                                <div style={{ marginTop: '12px', paddingTop: '12px', borderTop: `1px solid ${theme.border}` }}>
                                    <span style={{ 
                                        fontSize: '12px', 
                                        padding: '4px 10px', 
                                        backgroundColor: transferVehicle.isFromQueue ? '#fef3c7' : '#dbeafe',
                                        color: transferVehicle.isFromQueue ? '#d97706' : '#2563eb'
                                    }}>
                                        {transferVehicle.isFromQueue ? '‚è≥ From Queue' : `üîß From ${transferVehicle.assignedBay || 'Bay'}`}
                                    </span>
                                </div>
                            </div>

                            {/* Priority Selection */}
                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'block', fontSize: '13px', fontWeight: '600', color: theme.text, marginBottom: '8px' }}>Priority</label>
                                <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                                    {PRIORITY_OPTIONS.map(p => (
                                        <button
                                            key={p.id}
                                            onClick={() => setTransferPriority(p.id)}
                                            style={{
                                                padding: '8px 16px',
                                                borderRadius: '0',
                                                border: transferPriority === p.id ? `2px solid ${p.color}` : `1px solid ${theme.border}`,
                                                backgroundColor: transferPriority === p.id ? `${p.color}15` : theme.bg,
                                                color: transferPriority === p.id ? p.color : theme.text,
                                                cursor: 'pointer',
                                                fontSize: '13px',
                                                fontWeight: '500'
                                            }}
                                        >
                                            {p.name}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            {/* Services Selection */}
                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'block', fontSize: '13px', fontWeight: '600', color: theme.text, marginBottom: '8px' }}>
                                    Select Garage Services *
                                </label>
                                {garageServices.length === 0 ? (
                                    <div style={{ padding: '20px', backgroundColor: theme.bgTertiary, textAlign: 'center', color: theme.textSecondary }}>
                                        <p style={{ margin: '0 0 12px 0' }}>No services available.</p>
                                        <button
                                            onClick={() => { setShowTransferModal(false); setShowServicesModal(true); }}
                                            style={{ padding: '8px 16px', backgroundColor: '#8b5cf6', color: 'white', border: 'none', borderRadius: '0', cursor: 'pointer', fontSize: '13px' }}
                                        >
                                            ‚öôÔ∏è Add Services
                                        </button>
                                    </div>
                                ) : (
                                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(280px, 1fr))', gap: '10px', maxHeight: '300px', overflowY: 'auto', padding: '4px' }}>
                                        {garageServices.map(service => (
                                            <div
                                                key={service.id}
                                                onClick={() => toggleTransferService(service.id)}
                                                style={{
                                                    padding: '14px',
                                                    border: transferServices.includes(service.id) ? '2px solid #3b82f6' : `1px solid ${theme.border}`,
                                                    backgroundColor: transferServices.includes(service.id) ? '#dbeafe' : theme.bg,
                                                    cursor: 'pointer',
                                                    transition: 'all 0.15s'
                                                }}
                                            >
                                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                                                    <div style={{ flex: 1 }}>
                                                        <div style={{ fontWeight: '500', color: theme.text, fontSize: '14px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                                                            {transferServices.includes(service.id) && <span style={{ color: '#3b82f6' }}>‚úì</span>}
                                                            {service.name}
                                                        </div>
                                                        <div style={{ fontSize: '12px', color: theme.textSecondary, marginTop: '4px' }}>
                                                            ‚è±Ô∏è {service.duration || 30} mins
                                                        </div>
                                                    </div>
                                                    <div style={{ fontWeight: '700', color: '#10b981', fontSize: '15px' }}>
                                                        {getBrandingForReceipts().currencySymbol || 'KSh'} {(service.price || 0).toLocaleString()}
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                                
                                {/* Selected Summary */}
                                {transferServices.length > 0 && (
                                    <div style={{ marginTop: '12px', padding: '12px', backgroundColor: '#f0fdf4', border: '1px solid #bbf7d0', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                        <span style={{ color: '#166534', fontSize: '14px' }}>
                                            {transferServices.length} service(s) selected
                                        </span>
                                        <span style={{ fontWeight: '700', color: '#166534', fontSize: '16px' }}>
                                            Total: {getBrandingForReceipts().currencySymbol || 'KSh'} {transferServices.reduce((sum, sId) => {
                                                const service = garageServices.find(s => s.id === sId);
                                                return sum + (service?.price || 0);
                                            }, 0).toLocaleString()}
                                        </span>
                                    </div>
                                )}
                            </div>

                            {/* Notes */}
                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'block', fontSize: '13px', fontWeight: '600', color: theme.text, marginBottom: '8px' }}>Notes (Optional)</label>
                                <textarea
                                    value={transferNotes}
                                    onChange={(e) => setTransferNotes(e.target.value)}
                                    placeholder="Any special instructions or notes for the garage..."
                                    rows={3}
                                    style={{ width: '100%', padding: '10px 12px', border: `1px solid ${theme.border}`, borderRadius: '0', fontSize: '14px', backgroundColor: theme.inputBg, color: theme.text, resize: 'vertical' }}
                                />
                            </div>
                        </div>
                        <div style={{ padding: '16px 24px', borderTop: `1px solid ${theme.border}`, display: 'flex', gap: '12px', justifyContent: 'space-between', alignItems: 'center' }}>
                            <span style={{ fontSize: '13px', color: theme.textSecondary }}>
                                {transferServices.length === 0 ? '‚ö†Ô∏è Please select at least one service' : ''}
                            </span>
                            <div style={{ display: 'flex', gap: '12px' }}>
                                <button
                                    onClick={() => { setShowTransferModal(false); setTransferVehicle(null); }}
                                    style={{ padding: '10px 20px', backgroundColor: theme.bgTertiary, color: theme.text, border: 'none', borderRadius: '0', cursor: 'pointer', fontSize: '14px' }}
                                >
                                    Cancel
                                </button>
                                <button
                                    onClick={handleConfirmTransfer}
                                    disabled={actionLoading || transferServices.length === 0}
                                    style={{ 
                                        padding: '10px 24px', 
                                        backgroundColor: transferServices.length === 0 ? '#94a3b8' : '#10b981', 
                                        color: 'white', 
                                        border: 'none', 
                                        borderRadius: '0', 
                                        cursor: transferServices.length === 0 ? 'not-allowed' : 'pointer', 
                                        fontSize: '14px', 
                                        fontWeight: '600',
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '8px'
                                    }}
                                >
                                    {actionLoading ? 'Sending...' : 'üîß Send to Garage Queue'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* Assign Technician Modal */}
            {showAssignTechModal && selectedQueueItem && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: theme.modalOverlay, display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000, padding: '20px' }}>
                    <div style={{ backgroundColor: theme.bg, borderRadius: '0', width: '100%', maxWidth: '450px', maxHeight: '90vh', overflow: 'auto', boxShadow: '0 25px 50px -12px rgba(0,0,0,0.25)' }}>
                        <div style={{ padding: '20px 24px', borderBottom: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <h2 style={{ margin: 0, fontSize: '18px', fontWeight: '600', color: theme.text }}>üë∑ Assign Technician</h2>
                            <button onClick={() => { setShowAssignTechModal(false); setSelectedQueueItem(null); }} style={{ background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer', color: theme.textSecondary }}>√ó</button>
                        </div>
                        <div style={{ padding: '24px' }}>
                            {/* Vehicle Info */}
                            <div style={{ backgroundColor: theme.bgTertiary, padding: '16px', marginBottom: '20px' }}>
                                <div style={{ fontWeight: '600', color: theme.text, fontSize: '16px' }}>{selectedQueueItem.plateNumber}</div>
                                <div style={{ color: theme.textSecondary, fontSize: '13px' }}>{selectedQueueItem.vehicleType} ‚Ä¢ {selectedQueueItem.customerName || 'Walk-in'}</div>
                            </div>

                            {/* Services */}
                            <div style={{ marginBottom: '20px' }}>
                                <div style={{ fontSize: '13px', fontWeight: '600', color: theme.text, marginBottom: '8px' }}>Services Requested</div>
                                <div style={{ display: 'flex', gap: '6px', flexWrap: 'wrap' }}>
                                    {selectedQueueItem.services?.map((sId, idx) => {
                                        const service = garageServices.find(s => s.id === sId);
                                        return service ? (
                                            <span key={idx} style={{ fontSize: '12px', padding: '4px 10px', backgroundColor: '#fef3c7', color: '#92400e' }}>
                                                {service.name}
                                            </span>
                                        ) : null;
                                    })}
                                </div>
                            </div>

                            {/* Technician Selection */}
                            <div>
                                <label style={{ display: 'block', fontSize: '13px', fontWeight: '600', color: theme.text, marginBottom: '8px' }}>
                                    Select Technician *
                                </label>
                                <select
                                    value={selectedTechnician}
                                    onChange={(e) => setSelectedTechnician(e.target.value)}
                                    style={{ 
                                        width: '100%', 
                                        padding: '12px', 
                                        border: `1px solid ${theme.border}`, 
                                        borderRadius: '0', 
                                        fontSize: '14px', 
                                        backgroundColor: theme.inputBg, 
                                        color: theme.text,
                                        cursor: 'pointer'
                                    }}
                                >
                                    <option value="">-- Select Technician --</option>
                                    {staffList.map(staff => (
                                        <option key={staff.id} value={staff.name}>{staff.name} ({staff.role})</option>
                                    ))}
                                </select>
                                <div style={{ marginTop: '8px', fontSize: '12px', color: theme.textSecondary }}>
                                    üí° The assigned technician will be tracked in HR for commission/payment calculations
                                </div>
                            </div>
                        </div>
                        <div style={{ padding: '16px 24px', borderTop: `1px solid ${theme.border}`, display: 'flex', gap: '12px', justifyContent: 'flex-end' }}>
                            <button
                                onClick={() => { setShowAssignTechModal(false); setSelectedQueueItem(null); }}
                                style={{ padding: '10px 20px', backgroundColor: theme.bgTertiary, color: theme.text, border: 'none', borderRadius: '0', cursor: 'pointer', fontSize: '14px' }}
                            >
                                Cancel
                            </button>
                            <button
                                onClick={executeStartJob}
                                disabled={actionLoading || !selectedTechnician}
                                style={{ 
                                    padding: '10px 20px', 
                                    backgroundColor: selectedTechnician ? '#10b981' : '#94a3b8', 
                                    color: 'white', 
                                    border: 'none', 
                                    borderRadius: '0', 
                                    cursor: selectedTechnician ? 'pointer' : 'not-allowed', 
                                    fontSize: '14px', 
                                    fontWeight: '500' 
                                }}
                            >
                                {actionLoading ? 'Starting...' : 'üöÄ Start Job'}
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* Edit Services Modal */}
            {showEditServicesModal && editServicesItem && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: theme.modalOverlay, display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000, padding: '20px' }}>
                    <div style={{ backgroundColor: theme.bg, borderRadius: '0', width: '100%', maxWidth: '650px', maxHeight: '90vh', overflow: 'auto', boxShadow: '0 25px 50px -12px rgba(0,0,0,0.25)' }}>
                        <div style={{ padding: '20px 24px', borderBottom: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'space-between', alignItems: 'center', position: 'sticky', top: 0, backgroundColor: theme.bg, zIndex: 1 }}>
                            <h2 style={{ margin: 0, fontSize: '18px', fontWeight: '600', color: theme.text }}>‚úèÔ∏è Edit Services</h2>
                            <button onClick={() => { setShowEditServicesModal(false); setEditServicesItem(null); }} style={{ background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer', color: theme.textSecondary }}>√ó</button>
                        </div>
                        <div style={{ padding: '24px' }}>
                            {/* Vehicle Info */}
                            <div style={{ backgroundColor: theme.bgTertiary, padding: '16px', marginBottom: '20px' }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                                    <div>
                                        <div style={{ fontWeight: '700', color: theme.text, fontSize: '18px' }}>{editServicesItem.plateNumber}</div>
                                        <div style={{ color: theme.textSecondary, fontSize: '14px', marginTop: '4px' }}>{editServicesItem.vehicleType}</div>
                                    </div>
                                    <div style={{ textAlign: 'right' }}>
                                        <div style={{ color: theme.text, fontSize: '14px' }}>{editServicesItem.customerName || 'Walk-in Customer'}</div>
                                        {editServicesItem.customerPhone && (
                                            <div style={{ color: theme.textSecondary, fontSize: '13px' }}>{editServicesItem.customerPhone}</div>
                                        )}
                                    </div>
                                </div>
                            </div>

                            {/* Current Services */}
                            {editServicesItem.services?.length > 0 && (
                                <div style={{ marginBottom: '16px', padding: '12px', backgroundColor: '#fef3c7', border: '1px solid #fcd34d' }}>
                                    <div style={{ fontSize: '13px', fontWeight: '600', color: '#92400e', marginBottom: '8px' }}>Current Services:</div>
                                    <div style={{ display: 'flex', gap: '6px', flexWrap: 'wrap' }}>
                                        {editServicesItem.services.map((svc, idx) => {
                                            // Handle both service objects (from intake) and service IDs
                                            const serviceName = typeof svc === 'object' ? svc.name : garageServices.find(s => s.id === svc)?.name;
                                            return serviceName ? (
                                                <span key={idx} style={{ fontSize: '12px', padding: '4px 10px', backgroundColor: '#fde68a', borderRadius: '0', color: '#78350f' }}>
                                                    {serviceName}
                                                </span>
                                            ) : null;
                                        })}
                                    </div>
                                </div>
                            )}

                            {/* Services Selection */}
                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'block', fontSize: '13px', fontWeight: '600', color: theme.text, marginBottom: '8px' }}>
                                    Select Services
                                </label>
                                {garageServices.length === 0 ? (
                                    <div style={{ padding: '20px', backgroundColor: theme.bgTertiary, textAlign: 'center', color: theme.textSecondary }}>
                                        <p style={{ margin: '0 0 12px 0' }}>No services available.</p>
                                        <button
                                            onClick={() => { setShowEditServicesModal(false); setShowServicesModal(true); }}
                                            style={{ padding: '8px 16px', backgroundColor: '#8b5cf6', color: 'white', border: 'none', borderRadius: '0', cursor: 'pointer', fontSize: '13px' }}
                                        >
                                            ‚öôÔ∏è Add Services
                                        </button>
                                    </div>
                                ) : (
                                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(280px, 1fr))', gap: '10px', maxHeight: '300px', overflowY: 'auto', padding: '4px' }}>
                                        {garageServices.map(service => (
                                            <div
                                                key={service.id}
                                                onClick={() => toggleEditService(service.id)}
                                                style={{
                                                    padding: '14px',
                                                    border: editServices.includes(service.id) ? '2px solid #3b82f6' : `1px solid ${theme.border}`,
                                                    backgroundColor: editServices.includes(service.id) ? '#dbeafe' : theme.bg,
                                                    cursor: 'pointer',
                                                    transition: 'all 0.15s'
                                                }}
                                            >
                                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                                                    <div style={{ flex: 1 }}>
                                                        <div style={{ fontWeight: '500', color: theme.text, fontSize: '14px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                                                            {editServices.includes(service.id) && <span style={{ color: '#3b82f6' }}>‚úì</span>}
                                                            {service.name}
                                                        </div>
                                                        <div style={{ fontSize: '12px', color: theme.textSecondary, marginTop: '4px' }}>
                                                            ‚è±Ô∏è {service.duration || 30} mins
                                                        </div>
                                                    </div>
                                                    <div style={{ fontWeight: '700', color: '#10b981', fontSize: '15px' }}>
                                                        {getBrandingForReceipts().currencySymbol || 'KSh'} {(service.price || 0).toLocaleString()}
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                                
                                {/* Selected Summary */}
                                {editServices.length > 0 && (
                                    <div style={{ marginTop: '12px', padding: '12px', backgroundColor: '#f0fdf4', border: '1px solid #bbf7d0', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                        <span style={{ color: '#166534', fontSize: '14px' }}>
                                            {editServices.length} service(s) selected
                                        </span>
                                        <span style={{ fontWeight: '700', color: '#166534', fontSize: '16px' }}>
                                            Total: {getBrandingForReceipts().currencySymbol || 'KSh'} {editServices.reduce((sum, sId) => {
                                                const service = garageServices.find(s => s.id === sId);
                                                return sum + (service?.price || 0);
                                            }, 0).toLocaleString()}
                                        </span>
                                    </div>
                                )}
                            </div>
                        </div>
                        <div style={{ padding: '16px 24px', borderTop: `1px solid ${theme.border}`, display: 'flex', gap: '12px', justifyContent: 'flex-end' }}>
                            <button
                                onClick={() => { setShowEditServicesModal(false); setEditServicesItem(null); }}
                                style={{ padding: '10px 20px', backgroundColor: theme.bgTertiary, color: theme.text, border: 'none', borderRadius: '0', cursor: 'pointer', fontSize: '14px' }}
                            >
                                Cancel
                            </button>
                            <button
                                onClick={handleSaveEditServices}
                                disabled={actionLoading || editServices.length === 0}
                                style={{ 
                                    padding: '10px 24px', 
                                    backgroundColor: editServices.length === 0 ? '#94a3b8' : '#3b82f6', 
                                    color: 'white', 
                                    border: 'none', 
                                    borderRadius: '0', 
                                    cursor: editServices.length === 0 ? 'not-allowed' : 'pointer', 
                                    fontSize: '14px', 
                                    fontWeight: '600'
                                }}
                            >
                                {actionLoading ? 'Saving...' : 'üíæ Save Changes'}
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* Alert Modal */}
            <AlertModal
                isOpen={alertModal.isOpen}
                onClose={closeAlert}
                title={alertModal.title}
                message={alertModal.message}
                type={alertModal.type}
                onConfirm={alertModal.onConfirm}
                showCancel={alertModal.showCancel}
            />
        </div>
    );
}

// ==================== WASH BAYS MODULE ====================

// Error Boundary for WashBays
class WashBaysErrorBoundary extends React.Component {
    constructor(props) {
        super(props);
        this.state = { hasError: false, error: null };
    }
    
    static getDerivedStateFromError(error) {
        return { hasError: true, error: error.message };
    }
    
    componentDidCatch(error, errorInfo) {
        console.error('WashBays Error:', error, errorInfo);
    }
    
    render() {
        if (this.state.hasError) {
            return (
                <div style={{ padding: '40px', textAlign: 'center' }}>
                    <div style={{ fontSize: '48px', marginBottom: '16px' }}>‚ö†Ô∏è</div>
                    <h3 style={{ color: '#dc2626', marginBottom: '8px' }}>Something went wrong in Wash Bays</h3>
                    <p style={{ color: '#64748b', marginBottom: '16px' }}>{this.state.error}</p>
                    <button 
                        onClick={() => window.location.reload()}
                        style={{ padding: '10px 20px', backgroundColor: '#3b82f6', color: 'white', border: 'none', borderRadius: '4px', cursor: 'pointer' }}
                    >
                        Reload Page
                    </button>
                </div>
            );
        }
        return this.props.children;
    }
}

function WashBaysContent() {
    const [bays, setBays] = useState([]);
    const [history, setHistory] = useState([]);
    const [invoices, setInvoices] = useState([]); // Track invoices for payment status
    const [intakeQueue, setIntakeQueue] = useState([]);
    const [intakeRecords, setIntakeRecords] = useState([]); // All intake records including in-progress
    const [staffList, setStaffList] = useState([]);
    const [servicePackages, setServicePackages] = useState([]);
    const [loading, setLoading] = useState(true);
    const [showAddModal, setShowAddModal] = useState(false);
    const [showAssignModal, setShowAssignModal] = useState(false);
    const [showMaintenanceModal, setShowMaintenanceModal] = useState(false);
    const [showConfirmModal, setShowConfirmModal] = useState(false);
    const [showResetModal, setShowResetModal] = useState(false); // Reset bays confirmation
    const [showViewVehicleModal, setShowViewVehicleModal] = useState(false); // View vehicle details
    const [selectedViewVehicle, setSelectedViewVehicle] = useState(null); // Selected vehicle for viewing
    const [confirmAction, setConfirmAction] = useState(null);
    const [maintenanceNote, setMaintenanceNote] = useState('');
    const [selectedBay, setSelectedBay] = useState(null);
    const [actionLoading, setActionLoading] = useState(false);
    const [error, setError] = useState(null);
    const [successMessage, setSuccessMessage] = useState(null);
    const [activeTab, setActiveTab] = useState('bays');
    const [todayStats, setTodayStats] = useState({ completed: 0, avgTime: 0 });
    const [isDark, setIsDark] = useState(document.documentElement.getAttribute('data-theme') === 'dark');
    const [assignMode, setAssignMode] = useState('select'); // 'select' or 'new'
    const [selectedVehicleId, setSelectedVehicleId] = useState('');
    const [renderError, setRenderError] = useState(null);
    const [componentMounted, setComponentMounted] = useState(false);
    
    // History search, filter, and pagination states
    const [historySearch, setHistorySearch] = useState('');
    const [historyDateFilter, setHistoryDateFilter] = useState('all'); // 'today', 'week', 'month', 'custom', 'all'
    const [historyCustomDateFrom, setHistoryCustomDateFrom] = useState('');
    const [historyCustomDateTo, setHistoryCustomDateTo] = useState('');
    const [historyPaymentFilter, setHistoryPaymentFilter] = useState('all'); // 'all', 'paid', 'pending'
    const [historyBayFilter, setHistoryBayFilter] = useState('all');
    const [historyPage, setHistoryPage] = useState(1);
    const [historyPageSize, setHistoryPageSize] = useState(25);
    const [historyJumpPage, setHistoryJumpPage] = useState('');

    // Print Wash Bay Gate Pass function
    const printWashGatePass = (record) => {
        const branding = getBrandingForReceipts();
        const serviceName = record.vehicle?.service?.name || record.vehicle?.service || '-';
        const servicePrice = record.vehicle?.servicePrice || record.vehicle?.service?.price || 0;
        const currentUser = window.FirebaseServices?.auth?.currentUser;
        const releasedBy = currentUser?.displayName || currentUser?.email?.split('@')[0] || 'Staff';
        
        const receiptContent = `
            <html>
            <head>
                <title>Gate Pass - Wash Bay</title>
                <style>
                    @page { margin: 0; size: 80mm auto; }
                    body { 
                        font-family: 'Courier New', monospace; 
                        font-size: 12px; 
                        line-height: 1.4;
                        padding: 10px;
                        margin: 0;
                        width: 80mm;
                    }
                    .header { text-align: center; margin-bottom: 10px; border-bottom: 1px dashed #000; padding-bottom: 10px; }
                    .title { font-size: 16px; font-weight: bold; margin: 5px 0; }
                    .subtitle { font-size: 11px; color: #666; }
                    .section { margin: 10px 0; padding: 8px 0; border-bottom: 1px dashed #000; }
                    .row { display: flex; justify-content: space-between; margin: 4px 0; }
                    .label { color: #666; }
                    .value { font-weight: bold; text-align: right; }
                    .gate-pass-title { 
                        text-align: center; 
                        font-size: 18px; 
                        font-weight: bold; 
                        background: #000; 
                        color: white; 
                        padding: 8px; 
                        margin: 10px 0;
                        letter-spacing: 2px;
                    }
                    .plate-number {
                        text-align: center;
                        font-size: 24px;
                        font-weight: bold;
                        padding: 10px;
                        border: 2px solid #000;
                        margin: 10px 0;
                        letter-spacing: 3px;
                    }
                    .status-cleared {
                        text-align: center;
                        background: #d1fae5;
                        color: #059669;
                        padding: 8px;
                        font-weight: bold;
                        border-radius: 4px;
                        margin: 10px 0;
                    }
                    .footer { text-align: center; margin-top: 15px; font-size: 10px; color: #666; }
                    @media print {
                        body { width: 80mm; }
                    }
                </style>
            </head>
            <body>
                <div class="header">
                    <div class="title">${branding.companyName}</div>
                    <div class="subtitle">${branding.address || ''}</div>
                    <div class="subtitle">${branding.phone || ''}</div>
                </div>
                
                <div class="gate-pass-title">üöó GATE PASS</div>
                
                <div class="plate-number">${record.vehicle?.plateNumber || 'Unknown'}</div>
                
                <div class="status-cleared">‚úì VEHICLE CLEARED TO EXIT</div>
                
                <div class="section">
                    <div class="row">
                        <span class="label">Customer:</span>
                        <span class="value">${record.vehicle?.customerName || 'Walk-in'}</span>
                    </div>
                    <div class="row">
                        <span class="label">Phone:</span>
                        <span class="value">${record.vehicle?.phone || record.vehicle?.customerPhone || '-'}</span>
                    </div>
                    <div class="row">
                        <span class="label">Vehicle Type:</span>
                        <span class="value">${record.vehicle?.vehicleType || '-'}</span>
                    </div>
                </div>
                
                <div class="section">
                    <div class="row">
                        <span class="label">Service:</span>
                        <span class="value">${serviceName}</span>
                    </div>
                    <div class="row">
                        <span class="label">Bay:</span>
                        <span class="value">${record.bayName || record.bayId || '-'}</span>
                    </div>
                    <div class="row">
                        <span class="label">Amount:</span>
                        <span class="value">${branding.currencySymbol || 'KES'} ${Number(servicePrice).toLocaleString()}</span>
                    </div>
                    <div class="row">
                        <span class="label">Payment:</span>
                        <span class="value" style="color: #059669;">‚úì PAID</span>
                    </div>
                </div>
                
                <div class="section">
                    <div class="row">
                        <span class="label">Washed By:</span>
                        <span class="value">${record.vehicle?.washedBy || record.completedBy || '-'}</span>
                    </div>
                    <div class="row">
                        <span class="label">Completed:</span>
                        <span class="value">${record.endTime ? new Date(record.endTime).toLocaleString() : '-'}</span>
                    </div>
                    <div class="row">
                        <span class="label">Duration:</span>
                        <span class="value">${record.duration ? record.duration + ' min' : '-'}</span>
                    </div>
                </div>
                
                <div class="section">
                    <div class="row">
                        <span class="label">Released By:</span>
                        <span class="value">${releasedBy}</span>
                    </div>
                    <div class="row">
                        <span class="label">Release Time:</span>
                        <span class="value">${new Date().toLocaleString()}</span>
                    </div>
                </div>
                
                <div class="footer">
                    <p>Thank you for choosing ${branding.companyName}!</p>
                    <p>Present this pass at the gate to exit</p>
                    <p style="margin-top: 10px; font-size: 9px;">Receipt ID: WGP-${Date.now().toString(36).toUpperCase()}</p>
                </div>
            </body>
            </html>
        `;
        
        const printWindow = window.open('', '_blank', 'width=350,height=600');
        if (printWindow) {
            printWindow.document.write(receiptContent);
            printWindow.document.close();
            setTimeout(() => {
                printWindow.print();
            }, 250);
        }
    };
    
    // Debug logging on mount
    useEffect(() => {
        console.log('WashBaysContent: Component mounting...');
        setComponentMounted(true);
        return () => console.log('WashBaysContent: Component unmounted');
    }, []);

    // Form states
    const [bayForm, setBayForm] = useState({ name: '', type: 'standard' });
    const [assignForm, setAssignForm] = useState({ 
        plateNumber: '', 
        customerName: '', 
        vehicleType: 'sedan', 
        service: '',
        assignedTo: ''
    });

    // Auto-hide success message
    useEffect(() => {
        if (successMessage) {
            const timer = setTimeout(() => setSuccessMessage(null), 3000);
            return () => clearTimeout(timer);
        }
    }, [successMessage]);

    // Theme detection
    useEffect(() => {
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.attributeName === 'data-theme') {
                    setIsDark(document.documentElement.getAttribute('data-theme') === 'dark');
                }
            });
        });
        observer.observe(document.documentElement, { attributes: true });
        return () => observer.disconnect();
    }, []);

    const theme = {
        bg: isDark ? '#1e293b' : 'white',
        bgSecondary: isDark ? '#0f172a' : '#f8fafc',
        text: isDark ? '#f1f5f9' : '#1e293b',
        textSecondary: isDark ? '#94a3b8' : '#64748b',
        border: isDark ? '#334155' : '#e2e8f0',
        cardShadow: isDark ? '0 2px 8px rgba(0,0,0,0.3)' : '0 2px 8px rgba(0,0,0,0.08)',
        inputBg: isDark ? '#1e293b' : 'white',
    };

    const BAY_TYPES = [
        { id: 'standard', name: 'Standard', color: '#3b82f6' },
        { id: 'premium', name: 'Premium', color: '#8b5cf6' },
        { id: 'express', name: 'Express', color: '#10b981' }
    ];

    const VEHICLE_TYPES = ['Sedan', 'SUV', 'Truck', 'Van', 'Motorcycle', 'Bus'];

    const STATUS_CONFIG = {
        available: { label: 'Available', color: '#10b981', bg: '#d1fae5', cardBg: 'transparent', borderColor: '#10b981' },
        occupied: { label: 'In Progress', color: '#1e40af', bg: '#dbeafe', cardBg: 'linear-gradient(145deg, #f0f9ff 0%, #e0f2fe 50%, #dbeafe 100%)', borderColor: '#60a5fa' },
        maintenance: { label: 'Maintenance', color: '#f59e0b', bg: '#fef3c7', cardBg: 'linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)', borderColor: '#f59e0b' }
    };

    // Subscribe to real-time data - STABLE VERSION
    useEffect(() => {
        let mounted = true;
        let unsubBays = null;
        let unsubHistory = null;
        let unsubQueue = null;
        let unsubStaff = null;
        let unsubPackages = null;
        let unsubRecords = null;
        let unsubInvoices = null;

        const initializeData = async () => {
            try {
                const services = window.FirebaseServices;
                if (!services || !services.washBayService) {
                    if (mounted) {
                        setError('Wash bay service not available. Please refresh.');
                        setLoading(false);
                    }
                    return;
                }

                // Initialize bays if needed
                await services.washBayService.initializeBays();

                if (!mounted) return;

                // Subscribe to bays with error handling
                unsubBays = services.washBayService.subscribeToBays(
                    function(data) {
                        if (!mounted) return;
                        try {
                            var baysData = Array.isArray(data) ? data : [];
                            setBays(baysData);
                            setLoading(false);
                        } catch (err) {
                            console.error('Error processing bays:', err);
                            setBays([]);
                            setLoading(false);
                        }
                    },
                    function(err) {
                        if (!mounted) return;
                        console.error('Bays subscription error:', err);
                        setError('Failed to load wash bays.');
                        setLoading(false);
                    }
                );

                // Subscribe to history
                unsubHistory = services.washBayService.subscribeToHistory(function(data) {
                    if (mounted) setHistory(data || []);
                });

                // Subscribe to invoices for payment status
                if (services.billingService && services.billingService.subscribeToInvoices) {
                    unsubInvoices = services.billingService.subscribeToInvoices(function(data) {
                        if (!mounted) return;
                        try {
                            var washInvoices = (data || []).filter(function(inv) { return inv.source === 'wash'; });
                            setInvoices(washInvoices);
                        } catch (err) {
                            setInvoices([]);
                        }
                    });
                }

                // Subscribe to intake records
                if (services.intakeRecordsService && services.intakeRecordsService.subscribeToRecords) {
                    unsubRecords = services.intakeRecordsService.subscribeToRecords(function(data) {
                        if (mounted) setIntakeRecords(data || []);
                    });
                }

                // Subscribe to intake queue
                if (services.intakeQueueService && services.intakeQueueService.subscribeToQueue) {
                    unsubQueue = services.intakeQueueService.subscribeToQueue(function(data) {
                        if (!mounted) return;
                        try {
                            var waiting = (data || []).filter(function(v) { return v.status === 'waiting'; });
                            setIntakeQueue(waiting);
                        } catch (err) {
                            setIntakeQueue([]);
                        }
                    });
                }

                // Subscribe to staff list
                if (services.staffService && services.staffService.subscribeToStaff) {
                    unsubStaff = services.staffService.subscribeToStaff(function(data) {
                        if (mounted) setStaffList(data || []);
                    });
                }

                // Subscribe to service packages
                if (services.packagesService && services.packagesService.subscribeToPackages) {
                    unsubPackages = services.packagesService.subscribeToPackages(function(data) {
                        if (!mounted) return;
                        try {
                            var active = (data || []).filter(function(p) { return p.isActive !== false; });
                            setServicePackages(active);
                        } catch (err) {
                            setServicePackages([]);
                        }
                    });
                }

                // Get today's stats
                try {
                    var result = await services.washBayService.getTodayStats();
                    if (mounted && result && result.success) {
                        setTodayStats(result.data || { completed: 0, avgTime: 0 });
                    }
                } catch (statsErr) {
                    console.error('Stats error:', statsErr);
                }

            } catch (err) {
                console.error('WashBays initialization error:', err);
                if (mounted) {
                    setError('Failed to load wash bays. Please refresh.');
                    setLoading(false);
                }
            }
        };

        initializeData();

        // Cleanup
        return function() {
            mounted = false;
            if (unsubBays) try { unsubBays(); } catch(e) {}
            if (unsubHistory) try { unsubHistory(); } catch(e) {}
            if (unsubQueue) try { unsubQueue(); } catch(e) {}
            if (unsubStaff) try { unsubStaff(); } catch(e) {}
            if (unsubPackages) try { unsubPackages(); } catch(e) {}
            if (unsubRecords) try { unsubRecords(); } catch(e) {}
            if (unsubInvoices) try { unsubInvoices(); } catch(e) {}
        };
    }, []);

    // Timeout to prevent infinite loading
    useEffect(() => {
        if (loading) {
            const timeout = setTimeout(() => {
                if (loading) {
                    console.warn('WashBays: Loading timeout - forcing render');
                    setLoading(false);
                }
            }, 5000); // 5 second timeout
            return () => clearTimeout(timeout);
        }
    }, [loading]);

    // Calculate elapsed time for occupied bays
    const getElapsedTime = (startTime) => {
        if (!startTime) return '0:00';
        const elapsed = Math.floor((Date.now() - new Date(startTime).getTime()) / 1000);
        const mins = Math.floor(elapsed / 60);
        const secs = elapsed % 60;
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    };

    // Auto-update elapsed times
    const [, forceUpdate] = useState(0);
    useEffect(() => {
        const interval = setInterval(() => forceUpdate(n => n + 1), 1000);
        return () => clearInterval(interval);
    }, []);

    const handleAddBay = async (e) => {
        e.preventDefault();
        if (!bayForm.name.trim()) {
            setError('Bay name is required');
            return;
        }

        setActionLoading(true);
        setError(null);

        try {
            const services = window.FirebaseServices;
            const result = await services.washBayService.addBay(bayForm);
            if (result.success) {
                setShowAddModal(false);
                setBayForm({ name: '', type: 'standard' });
            } else {
                setError(result.error);
            }
        } catch (err) {
            setError('Failed to add bay');
        } finally {
            setActionLoading(false);
        }
    };

    const handleAssignVehicle = async (e) => {
        e.preventDefault();
        
        // Validate staff selection
        if (!assignForm.assignedTo) {
            setError('Please select a staff member');
            return;
        }
        
        // For new vehicles, validate service selection
        if (assignMode === 'new' && !assignForm.service) {
            setError('Please select a service');
            return;
        }
        
        // Get service info based on mode
        let serviceInfo;
        
        if (assignMode === 'select' && selectedVehicleId) {
            // Get service from queue vehicle
            const queueVehicle = intakeQueue.find(v => v.id === selectedVehicleId);
            if (queueVehicle?.service && typeof queueVehicle.service === 'object') {
                serviceInfo = queueVehicle.service;
            } else {
                // Fallback to form service or default
                const selectedPackage = servicePackages.find(p => p.id === assignForm.service);
                serviceInfo = selectedPackage 
                    ? { id: selectedPackage.id, name: selectedPackage.name, price: selectedPackage.price }
                    : { name: 'Car Wash', price: 0 };
            }
        } else if (assignMode === 'assigned' && selectedVehicleId) {
            // Get service from assigned vehicle
            const assignedVehicle = intakeRecords.find(v => v.id === selectedVehicleId);
            if (assignedVehicle?.service && typeof assignedVehicle.service === 'object') {
                serviceInfo = assignedVehicle.service;
            } else {
                const selectedPackage = servicePackages.find(p => p.id === assignForm.service);
                serviceInfo = selectedPackage 
                    ? { id: selectedPackage.id, name: selectedPackage.name, price: selectedPackage.price }
                    : { name: 'Car Wash', price: 0 };
            }
        } else {
            // New vehicle - use form selection
            const selectedPackage = servicePackages.find(p => p.id === assignForm.service);
            serviceInfo = selectedPackage 
                ? { id: selectedPackage.id, name: selectedPackage.name, price: selectedPackage.price }
                : { name: assignForm.service, price: 0 };
        }
        
        setActionLoading(true);
        setError(null);

        try {
            const services = window.FirebaseServices;
            let vehicleData;
            let queueVehicle = null;
            
            // Get the current logged-in user who is assigning the vehicle
            const currentUser = window.currentUserProfile;
            const assignedByName = (currentUser && currentUser.displayName) || (currentUser && currentUser.email) || 'System';

            if (assignMode === 'select' && selectedVehicleId) {
                // Use selected vehicle from queue
                queueVehicle = intakeQueue.find(v => v.id === selectedVehicleId);
                if (!queueVehicle) {
                    setError('Selected vehicle not found');
                    setActionLoading(false);
                    return;
                }
                vehicleData = {
                    plateNumber: queueVehicle.plateNumber,
                    customerName: queueVehicle.customerName || queueVehicle.ownerName || '',
                    vehicleType: queueVehicle.vehicleType || 'sedan',
                    service: serviceInfo,
                    assignedBy: assignedByName,
                    washedBy: assignForm.assignedTo,
                    queueId: queueVehicle.id
                };
            } else if (assignMode === 'assigned' && selectedVehicleId) {
                // Use selected vehicle from already assigned (intake records)
                const assignedVehicle = intakeRecords.find(v => v.id === selectedVehicleId);
                if (!assignedVehicle) {
                    setError('Selected vehicle not found');
                    setActionLoading(false);
                    return;
                }
                vehicleData = {
                    plateNumber: assignedVehicle.plateNumber,
                    customerName: assignedVehicle.customerName || '',
                    vehicleType: assignedVehicle.vehicleType || 'sedan',
                    service: serviceInfo,
                    assignedBy: assignedByName,
                    washedBy: assignForm.assignedTo,
                    recordId: assignedVehicle.id, // Keep the existing record ID
                    previousBay: assignedVehicle.assignedBay // Track where it was
                };
            } else {
                // Create new vehicle entry
                if (!assignForm.plateNumber.trim()) {
                    setError('Plate number is required');
                    setActionLoading(false);
                    return;
                }
                vehicleData = {
                    plateNumber: assignForm.plateNumber.toUpperCase(),
                    customerName: assignForm.customerName,
                    vehicleType: assignForm.vehicleType,
                    service: serviceInfo,
                    assignedBy: assignedByName,
                    washedBy: assignForm.assignedTo
                };
            }

            // 1. Create or update record in Vehicle Intake Records (Firestore) for tracking
            let recordId = vehicleData.recordId || null;
            
            if (assignMode === 'assigned' && recordId) {
                // Update existing record with new bay assignment - reset status to in-progress
                if (services.intakeRecordsService) {
                    await services.intakeRecordsService.updateRecord(recordId, {
                        status: 'in-progress', // Reset to in-progress when assigned to bay
                        assignedBay: selectedBay.name,
                        assignedBayId: selectedBay.id,
                        assignedTime: new Date().toISOString(),
                        timeIn: new Date().toISOString(), // Reset time in for new wash
                        timeOut: null, // Clear previous completion time
                        paymentStatus: 'pending', // Reset payment status to pending (shows 'Waiting')
                        service: vehicleData.service,
                        reassignedFrom: vehicleData.previousBay
                    });
                }
            } else if (!recordId && services.intakeRecordsService) {
                // Create or update record for queue or new vehicles
                // Use addOrUpdateRecord to properly handle returning vehicles
                const recordData = {
                    plateNumber: vehicleData.plateNumber,
                    customerName: vehicleData.customerName,
                    vehicleType: vehicleData.vehicleType,
                    service: vehicleData.service,
                    status: 'in-progress',
                    paymentStatus: 'pending', // Reset payment status for new visit
                    assignedBay: selectedBay.name,
                    assignedBayId: selectedBay.id,
                    assignedTime: new Date().toISOString(),
                    timeIn: new Date().toISOString(),
                    source: assignMode === 'select' ? 'queue' : 'wash-bay-direct',
                    queueId: vehicleData.queueId || null
                };
                // Use addOrUpdateRecord - handles returning vehicles automatically
                const recordResult = await services.intakeRecordsService.addOrUpdateRecord(
                    vehicleData.plateNumber,
                    recordData
                );
                if (recordResult.success) {
                    recordId = recordResult.id;
                    vehicleData.recordId = recordId;
                }
            }

            // 2. If from queue, update queue status to in-progress (or remove it)
            if (assignMode === 'select' && queueVehicle && services.intakeQueueService) {
                // Remove from queue since it's now in records
                await services.intakeQueueService.removeFromQueue(queueVehicle.id);
            } else if (assignMode === 'new' && services.intakeQueueService) {
                // For new vehicles, add to queue with in-progress status for tracking
                const queueResult = await services.intakeQueueService.addToQueue({
                    plateNumber: vehicleData.plateNumber,
                    customerName: vehicleData.customerName,
                    vehicleType: vehicleData.vehicleType,
                    service: vehicleData.service,
                    status: 'in-progress',
                    assignedBay: selectedBay.name,
                    assignedBayId: selectedBay.id,
                    washStartTime: new Date().toISOString(),
                    recordId: recordId,
                    source: 'wash-bay-direct'
                });
                if (queueResult.success) {
                    vehicleData.queueId = queueResult.id;
                }
            }
            // Note: 'assigned' mode doesn't need queue updates - vehicle is already tracked in records

            // 3. Assign to wash bay (Realtime DB) - this is the source of truth for bay status
            const result = await services.washBayService.assignVehicle(selectedBay.id, vehicleData);
            
            if (result.success) {
                setShowAssignModal(false);
                setSelectedBay(null);
                setSelectedVehicleId('');
                setAssignMode('select');
                setAssignForm({ plateNumber: '', customerName: '', vehicleType: 'sedan', service: '', assignedTo: '' });
            } else {
                setError(result.error);
            }
        } catch (err) {
            console.error('Error assigning vehicle:', err);
            setError('Failed to assign vehicle');
        } finally {
            setActionLoading(false);
        }
    };

    const openAssignModal = (bay) => {
        setSelectedBay(bay);
        setShowAssignModal(true);
        setError(null);
        setAssignMode(intakeQueue.length > 0 ? 'select' : 'new');
        setSelectedVehicleId('');
        setAssignForm({ plateNumber: '', customerName: '', vehicleType: 'sedan', service: 'Basic Wash', assignedTo: '' });
    };

    const handleCompleteWash = async (bay) => {
        setSelectedBay(bay);
        setConfirmAction({
            type: 'complete',
            title: 'Complete Wash',
            message: `Complete wash for ${bay.currentVehicle?.plateNumber}?`,
            confirmText: '‚úì Complete',
            confirmColor: '#10b981'
        });
        setShowConfirmModal(true);
    };

    const executeCompleteWash = async () => {
        const bay = selectedBay;
        setShowConfirmModal(false);
        setActionLoading(true);
        try {
            const services = window.FirebaseServices;
            const currentVehicle = bay.currentVehicle || {};
            
            // 1. Update the intake record in Firestore (main tracking)
            if (currentVehicle.recordId && services.intakeRecordsService) {
                await services.intakeRecordsService.updateRecord(currentVehicle.recordId, {
                    status: 'completed',
                    timeOut: new Date().toISOString()
                });
            }
            
            // 2. If vehicle has queue entry, remove it
            if (currentVehicle.queueId && services.intakeQueueService) {
                await services.intakeQueueService.removeFromQueue(currentVehicle.queueId);
            }
            
            // 3. Complete the wash bay - THIS LOGS TO WASH HISTORY
            const completeResult = await services.washBayService.completeWash(bay.id, {
                plateNumber: currentVehicle.plateNumber || 'Unknown',
                customerName: currentVehicle.customerName || 'Walk-in',
                vehicleType: currentVehicle.vehicleType || 'Vehicle',
                service: typeof currentVehicle.service === 'object' ? (currentVehicle.service.name || 'Car Wash') : (currentVehicle.service || 'Car Wash'),
                assignedBy: currentVehicle.assignedBy || ''
            });
            
            if (!completeResult.success) {
                throw new Error(completeResult.error || 'Failed to complete wash');
            }
            
            // Get the washHistoryId from completeResult for reliable invoice linking
            const washHistoryId = completeResult.washHistoryId || null;

            // 4. Create invoice for the completed wash
            const washPrice = typeof currentVehicle.service === 'object' 
                ? (currentVehicle.service.price || 500) 
                : 500;
            const serviceName = typeof currentVehicle.service === 'object' 
                ? (currentVehicle.service.name || 'Car Wash') 
                : (currentVehicle.service || 'Car Wash');
            
            if (services.billingService) {
                await services.billingService.createInvoice({
                    source: 'wash',
                    bayId: bay.id || 'unknown',
                    bayName: bay.name || 'Bay',
                    plateNumber: currentVehicle.plateNumber || 'Unknown',
                    vehicleType: currentVehicle.vehicleType || 'Vehicle',
                    customerName: currentVehicle.customerName || 'Walk-in',
                    customerPhone: currentVehicle.customerPhone || '',
                    services: [{ name: serviceName, price: washPrice }],
                    totalAmount: washPrice,
                    assignedTo: currentVehicle.assignedBy || '',
                    startTime: bay.startTime || new Date().toISOString(),
                    // Add recordId, visitNumber, and washHistoryId for reliable matching
                    washRecordId: currentVehicle.recordId || null,
                    visitNumber: currentVehicle.visitNumber || 1,
                    washHistoryId: washHistoryId
                });
            }
            
            // Refresh stats
            const result = await services.washBayService.getTodayStats();
            if (result.success) setTodayStats(result.data);
            
            // Log activity
            if (services.activityService) {
                const currentUser = window.currentUserProfile;
                services.activityService.logActivity({
                    type: 'wash',
                    action: 'Wash Completed',
                    details: (currentVehicle.plateNumber || 'Vehicle') + ' - ' + (bay.name || 'Bay'),
                    status: 'success',
                    loggedBy: (currentUser && currentUser.displayName) || 'System',
                    loggedByEmail: (currentUser && currentUser.email) || null,
                    loggedByRole: (currentUser && currentUser.role) || null
                });
            }
            
            setSuccessMessage((currentVehicle.plateNumber || 'Vehicle') + ' wash completed!');
        } catch (err) {
            console.error('Complete wash error:', err);
            setError('Failed to complete wash: ' + err.message);
        } finally {
            setActionLoading(false);
            setSelectedBay(null);
        }
    };

    const handleSetMaintenance = (bay) => {
        setSelectedBay(bay);
        setMaintenanceNote('');
        setShowMaintenanceModal(true);
    };

    const executeSetMaintenance = async () => {
        setShowMaintenanceModal(false);
        setActionLoading(true);
        try {
            const services = window.FirebaseServices;
            await services.washBayService.setMaintenance(selectedBay.id, { note: maintenanceNote });
            setSuccessMessage(`${selectedBay.name} set to maintenance`);
        } catch (err) {
            setError('Failed to set maintenance');
        } finally {
            setActionLoading(false);
            setSelectedBay(null);
            setMaintenanceNote('');
        }
    };

    const handleClearMaintenance = (bay) => {
        setSelectedBay(bay);
        setConfirmAction({
            type: 'clearMaintenance',
            title: 'Clear Maintenance',
            message: `Mark ${bay.name} as available again?`,
            confirmText: '‚úì Clear Maintenance',
            confirmColor: '#10b981'
        });
        setShowConfirmModal(true);
    };

    const executeClearMaintenance = async () => {
        setShowConfirmModal(false);
        setActionLoading(true);
        try {
            const services = window.FirebaseServices;
            await services.washBayService.updateBayStatus(selectedBay.id, 'available');
            setSuccessMessage(`${selectedBay.name} is now available`);
        } catch (err) {
            setError('Failed to clear maintenance');
        } finally {
            setActionLoading(false);
            setSelectedBay(null);
        }
    };

    const handleDeleteBay = (bay) => {
        setSelectedBay(bay);
        setConfirmAction({
            type: 'delete',
            title: 'Delete Bay',
            message: `Delete ${bay.name}? This cannot be undone.`,
            confirmText: 'üóëÔ∏è Delete',
            confirmColor: '#ef4444'
        });
        setShowConfirmModal(true);
    };

    const executeDeleteBay = async () => {
        setShowConfirmModal(false);
        setActionLoading(true);
        try {
            const services = window.FirebaseServices;
            await services.washBayService.deleteBay(selectedBay.id);
            setSuccessMessage(`${selectedBay.name} deleted`);
        } catch (err) {
            setError('Failed to delete bay');
        } finally {
            setActionLoading(false);
            setSelectedBay(null);
        }
    };

    // Handle confirm action
    const handleConfirmAction = async () => {
        if (!confirmAction) return;
        
        switch (confirmAction.type) {
            case 'complete':
                await executeCompleteWash();
                break;
            case 'clearMaintenance':
                await executeClearMaintenance();
                break;
            case 'delete':
                await executeDeleteBay();
                break;
            default:
                setShowConfirmModal(false);
        }
        setConfirmAction(null);
    };

    // Safe access helpers
    const safeBays = Array.isArray(bays) ? bays.filter(b => b && typeof b === 'object') : [];
    const safeQueue = Array.isArray(intakeQueue) ? intakeQueue : [];
    const safeStats = todayStats || { completed: 0, avgTime: 0 };
    
    // Calculate pending payments from history
    const completedRecords = Array.isArray(history) ? history.filter(r => r.action === 'completed') : [];
    const pendingPaymentCount = completedRecords.filter(record => {
        // Find matching invoice
        const matchingInvoice = invoices.find(inv => {
            if (inv.washRecordId && record.vehicle?.recordId) {
                return inv.washRecordId === record.vehicle.recordId;
            }
            return inv.plateNumber === record.vehicle?.plateNumber &&
                inv.source === 'wash' &&
                inv.bayId === record.bayId &&
                Math.abs(new Date(inv.createdAt) - new Date(record.endTime || record.timestamp)) < 300000;
        });
        return !matchingInvoice || matchingInvoice.paymentStatus !== 'paid';
    }).length;
    
    const paidCount = completedRecords.length - pendingPaymentCount;

    // Stats cards
    const statsCards = [
        { 
            label: 'In Queue', 
            value: safeQueue.length, 
            icon: '‚è≥',
            color: '#6366f1'
        },
        { 
            label: 'Available Bays', 
            value: safeBays.filter(b => b.status === 'available').length, 
            icon: '‚úÖ',
            color: '#10b981'
        },
        { 
            label: 'In Progress', 
            value: safeBays.filter(b => b.status === 'occupied').length, 
            icon: 'üöó',
            color: '#f59e0b'
        },
        { 
            label: 'Completed Today', 
            value: safeStats.completed || 0, 
            icon: 'üèÅ',
            color: '#8b5cf6',
            subLabel: pendingPaymentCount > 0 ? `${pendingPaymentCount} awaiting payment` : null
        }
    ];

    // Debug: Log render state
    console.log('WashBays render - loading:', loading, 'bays:', safeBays.length, 'error:', error);

    // Show render error if caught
    if (renderError) {
        return (
            <div style={{ padding: '24px', textAlign: 'center' }}>
                <div style={{ fontSize: '48px', marginBottom: '16px' }}>‚ö†Ô∏è</div>
                <h3 style={{ color: '#dc2626', marginBottom: '8px' }}>Render Error</h3>
                <p style={{ color: '#64748b', marginBottom: '16px' }}>{renderError}</p>
                <button 
                    onClick={() => { setRenderError(null); window.location.reload(); }}
                    style={{ padding: '10px 20px', backgroundColor: '#3b82f6', color: 'white', border: 'none', borderRadius: '4px', cursor: 'pointer' }}
                >
                    Reload Page
                </button>
            </div>
        );
    }

    if (loading) {
        return (
            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', height: '400px', backgroundColor: '#f8fafc' }}>
                <style>{`@keyframes spin { to { transform: rotate(360deg); } }`}</style>
                <div style={{ textAlign: 'center' }}>
                    <div style={{ width: '40px', height: '40px', border: '3px solid #e2e8f0', borderTopColor: '#3b82f6', borderRadius: '50%', animation: 'spin 0.8s linear infinite', margin: '0 auto 16px' }}></div>
                    <p style={{ color: '#64748b' }}>Loading wash bays...</p>
                    <p style={{ color: '#94a3b8', fontSize: '12px', marginTop: '8px' }}>Please wait while we fetch data...</p>
                </div>
            </div>
        );
    }

    return (
        <div style={{ padding: '24px' }}>
            {/* Error Banner */}
            {error && (
                <div style={{ 
                    padding: '12px 16px', 
                    backgroundColor: '#fee2e2', 
                    color: '#dc2626', 
                    borderRadius: '2px', 
                    marginBottom: '20px',
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center'
                }}>
                    <span>{error}</span>
                    <button onClick={() => setError(null)} style={{ background: 'none', border: 'none', cursor: 'pointer', fontSize: '18px' }}>√ó</button>
                </div>
            )}

            {/* Stats Cards */}
            <div style={{ 
                display: 'grid', 
                gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', 
                gap: '16px', 
                marginBottom: '24px' 
            }}>
                {statsCards.map((stat, i) => (
                    <div key={i} style={{
                        backgroundColor: theme.bg,
                        borderRadius: '2px',
                        padding: '20px',
                        boxShadow: theme.cardShadow,
                        border: `1px solid ${theme.border}`
                    }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                            <div style={{ 
                                width: '48px', 
                                height: '48px', 
                                borderRadius: '2px', 
                                backgroundColor: `${stat.color}15`,
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                fontSize: '24px'
                            }}>
                                {stat.icon}
                            </div>
                            <div>
                                <div style={{ fontSize: '28px', fontWeight: '700', color: theme.text }}>{stat.value}</div>
                                <div style={{ fontSize: '13px', color: theme.textSecondary }}>{stat.label}</div>
                                {stat.subLabel && (
                                    <div style={{ fontSize: '11px', color: '#f59e0b', marginTop: '2px', fontWeight: '500' }}>
                                        üí∞ {stat.subLabel}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                ))}
            </div>

            {/* Tabs & Add Button */}
            <div style={{ 
                display: 'flex', 
                justifyContent: 'space-between', 
                alignItems: 'center', 
                marginBottom: '20px' 
            }}>
                <div style={{ display: 'flex', gap: '8px' }}>
                    {['bays', 'history'].map(tab => (
                        <button
                            key={tab}
                            onClick={() => setActiveTab(tab)}
                            style={{
                                padding: '10px 20px',
                                borderRadius: '2px',
                                border: 'none',
                                backgroundColor: activeTab === tab ? '#3b82f6' : theme.bgSecondary,
                                color: activeTab === tab ? 'white' : theme.text,
                                fontWeight: '600',
                                cursor: 'pointer',
                                textTransform: 'capitalize'
                            }}
                        >
                            {tab === 'bays' ? 'üöø Wash Bays' : 'üìã History'}
                        </button>
                    ))}
                </div>
                {activeTab === 'bays' && (
                    <div style={{ display: 'flex', gap: '10px', alignItems: 'center' }}>
                        <button
                            onClick={() => setShowAddModal(true)}
                            style={{
                                padding: '10px 20px',
                                borderRadius: '2px',
                                border: 'none',
                                backgroundColor: '#10b981',
                                color: 'white',
                                fontWeight: '600',
                                cursor: 'pointer',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '8px'
                            }}
                        >
                            <span style={{ fontSize: '18px' }}>+</span> Add Bay
                        </button>
                        <button
                            onClick={() => setShowResetModal(true)}
                            disabled={actionLoading}
                            style={{
                                padding: '10px 16px',
                                borderRadius: '2px',
                                border: `1px solid ${theme.border}`,
                                backgroundColor: theme.bg,
                                color: theme.textSecondary,
                                fontWeight: '500',
                                cursor: actionLoading ? 'wait' : 'pointer',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '6px',
                                fontSize: '13px'
                            }}
                            title="Reset to 4 default wash bays"
                        >
                            üîÑ Reset Bays
                        </button>
                    </div>
                )}
            </div>

            {/* Bays Grid */}
            {activeTab === 'bays' && (
                <div style={{ 
                    display: 'grid', 
                    gridTemplateColumns: 'repeat(auto-fill, minmax(320px, 1fr))', 
                    gap: '20px' 
                }}>
                    {safeBays.length === 0 ? (
                        <div style={{ 
                            gridColumn: '1/-1', 
                            textAlign: 'center', 
                            padding: '60px 20px',
                            backgroundColor: theme.bg,
                            borderRadius: '2px',
                            border: `1px solid ${theme.border}`
                        }}>
                            <div style={{ fontSize: '48px', marginBottom: '16px' }}>üöø</div>
                            <h3 style={{ color: theme.text, marginBottom: '8px' }}>No Wash Bays</h3>
                            <p style={{ color: theme.textSecondary }}>Click "Add Bay" to create your first wash bay</p>
                        </div>
                    ) : (
                        safeBays.map(bay => {
                            if (!bay) return null;
                            const statusConfig = STATUS_CONFIG[bay.status] || STATUS_CONFIG.available;
                            const bayType = BAY_TYPES.find(t => t.id === bay.type) || BAY_TYPES[0];

                            return (
                                <div key={bay.id} style={{
                                    background: statusConfig.cardBg || theme.bg,
                                    backgroundColor: statusConfig.cardBg ? undefined : theme.bg,
                                    borderRadius: '2px',
                                    overflow: 'hidden',
                                    boxShadow: bay.status === 'occupied' ? '0 4px 16px rgba(96, 165, 250, 0.2)' : theme.cardShadow,
                                    border: `2px solid ${statusConfig.borderColor || theme.border}`,
                                    transition: 'transform 0.2s, box-shadow 0.2s',
                                    animation: bay.status === 'occupied' ? 'pulse 3s ease-in-out infinite' : 'none'
                                }}>
                                    {/* Bay Header */}
                                    <div style={{
                                        padding: '16px 20px',
                                        backgroundColor: bay.status === 'occupied' ? 'rgba(96, 165, 250, 0.08)' : `${bayType.color}10`,
                                        borderBottom: `1px solid ${bay.status === 'occupied' ? 'rgba(96, 165, 250, 0.2)' : theme.border}`,
                                        display: 'flex',
                                        justifyContent: 'space-between',
                                        alignItems: 'center'
                                    }}>
                                        <div>
                                            <h3 style={{ 
                                                margin: 0, 
                                                fontSize: '18px', 
                                                fontWeight: '700',
                                                color: bay.status === 'occupied' ? '#1e40af' : theme.text 
                                            }}>
                                                {bay.name}
                                            </h3>
                                            <span style={{
                                                display: 'inline-block',
                                                marginTop: '4px',
                                                padding: '2px 8px',
                                                borderRadius: '2px',
                                                fontSize: '11px',
                                                fontWeight: '600',
                                                backgroundColor: bayType.color,
                                                color: 'white'
                                            }}>
                                                {bayType.name}
                                            </span>
                                        </div>
                                        <div style={{
                                            padding: '6px 12px',
                                            borderRadius: '2px',
                                            backgroundColor: statusConfig.bg,
                                            color: statusConfig.color,
                                            fontSize: '12px',
                                            fontWeight: '600'
                                        }}>
                                            {statusConfig.label}
                                        </div>
                                    </div>

                                    {/* Bay Content */}
                                    <div style={{ padding: '20px' }}>
                                        {bay.status === 'occupied' && bay.currentVehicle ? (
                                            <div>
                                                <div style={{ 
                                                    display: 'flex', 
                                                    alignItems: 'center', 
                                                    gap: '12px',
                                                    marginBottom: '16px'
                                                }}>
                                                    <div style={{
                                                        width: '50px',
                                                        height: '50px',
                                                        borderRadius: '2px',
                                                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                                        display: 'flex',
                                                        alignItems: 'center',
                                                        justifyContent: 'center',
                                                        color: '#3b82f6',
                                                        fontSize: '24px'
                                                    }}>
                                                        üöó
                                                    </div>
                                                    <div>
                                                        <div style={{ 
                                                            fontWeight: '700', 
                                                            fontSize: '16px',
                                                            color: '#1e40af' 
                                                        }}>
                                                            {bay.currentVehicle.plateNumber}
                                                        </div>
                                                        <div style={{ 
                                                            fontSize: '13px', 
                                                            color: '#64748b' 
                                                        }}>
                                                            {bay.currentVehicle.customerName || 'Walk-in Customer'}
                                                        </div>
                                                    </div>
                                                </div>

                                                <div style={{ 
                                                    display: 'grid', 
                                                    gridTemplateColumns: '1fr 1fr', 
                                                    gap: '12px',
                                                    marginBottom: '16px'
                                                }}>
                                                    <div style={{
                                                        padding: '10px',
                                                        backgroundColor: 'rgba(59, 130, 246, 0.06)',
                                                        borderRadius: '2px',
                                                        border: '1px solid rgba(59, 130, 246, 0.1)'
                                                    }}>
                                                        <div style={{ fontSize: '11px', color: '#64748b', marginBottom: '2px' }}>Service</div>
                                                        <div style={{ fontSize: '13px', fontWeight: '600', color: '#1e40af' }}>{typeof bay.currentVehicle.service === 'object' ? bay.currentVehicle.service?.name : bay.currentVehicle.service || '-'}</div>
                                                    </div>
                                                    <div style={{
                                                        padding: '10px',
                                                        backgroundColor: 'rgba(59, 130, 246, 0.08)',
                                                        borderRadius: '2px',
                                                        border: '1px solid rgba(59, 130, 246, 0.12)'
                                                    }}>
                                                        <div style={{ fontSize: '11px', color: '#64748b', marginBottom: '2px' }}>Time Elapsed</div>
                                                        <div style={{ fontSize: '16px', fontWeight: '700', color: '#2563eb' }}>{getElapsedTime(bay.startTime)}</div>
                                                    </div>
                                                </div>

                                                <div style={{ display: 'flex', gap: '8px' }}>
                                                    <button
                                                        onClick={() => {
                                                            setSelectedViewVehicle(bay.currentVehicle);
                                                            setShowViewVehicleModal(true);
                                                        }}
                                                        style={{
                                                            flex: 1,
                                                            padding: '12px',
                                                            borderRadius: '2px',
                                                            border: `1px solid ${theme.border}`,
                                                            backgroundColor:theme.bgSecondary,
                                                            color: theme.text,
                                                            fontWeight: '600',
                                                            cursor: 'pointer',
                                                            fontSize: '14px'
                                                        }}
                                                    >
                                                        View Details
                                                    </button>
                                                    <button
                                                        onClick={() => handleCompleteWash(bay)}
                                                        disabled={actionLoading}
                                                        style={{
                                                            flex: 1,
                                                            padding: '12px',
                                                            borderRadius: '2px',
                                                            border: 'none',
                                                            backgroundColor: '#10b981',
                                                            color: 'white',
                                                            fontWeight: '600',
                                                            cursor: actionLoading ? 'not-allowed' : 'pointer',
                                                            fontSize: '14px'
                                                        }}
                                                    >
                                                        ‚úì Complete
                                                    </button>
                                                </div>
                                            </div>
                                        ) : bay.status === 'maintenance' ? (
                                            <div style={{ textAlign: 'center', padding: '20px 0' }}>
                                                <div style={{ fontSize: '40px', marginBottom: '12px' }}>üîß</div>
                                                <p style={{ color: theme.textSecondary, marginBottom: '16px' }}>
                                                    {bay.maintenanceNote || 'Under maintenance'}
                                                </p>
                                                <button
                                                    onClick={() => handleClearMaintenance(bay)}
                                                    disabled={actionLoading}
                                                    style={{
                                                        padding: '10px 24px',
                                                        borderRadius: '2px',
                                                        border: 'none',
                                                        backgroundColor: '#10b981',
                                                        color: 'white',
                                                        fontWeight: '600',
                                                        cursor: actionLoading ? 'not-allowed' : 'pointer'
                                                    }}
                                                >
                                                    Mark Available
                                                </button>
                                            </div>
                                        ) : (
                                            <div style={{ textAlign: 'center', padding: '20px 0' }}>
                                                <div style={{ fontSize: '40px', marginBottom: '12px' }}>‚ú®</div>
                                                <p style={{ color: theme.textSecondary, marginBottom: '16px' }}>Ready for next vehicle</p>
                                                <div style={{ display: 'flex', gap: '8px' }}>
                                                    <button
                                                        onClick={() => openAssignModal(bay)}
                                                        style={{
                                                            flex: 1,
                                                            padding: '10px',
                                                            borderRadius: '2px',
                                                            border: 'none',
                                                            backgroundColor: '#3b82f6',
                                                            color: 'white',
                                                            fontWeight: '600',
                                                            cursor: 'pointer'
                                                        }}
                                                    >
                                                        Assign Vehicle
                                                    </button>
                                                    <button
                                                        onClick={() => handleSetMaintenance(bay)}
                                                        style={{
                                                            padding: '10px 16px',
                                                            borderRadius: '2px',
                                                            border: `1px solid ${theme.border}`,
                                                            backgroundColor: 'transparent',
                                                            color: theme.textSecondary,
                                                            cursor: 'pointer'
                                                        }}
                                                        title="Set Maintenance"
                                                    >
                                                        üîß
                                                    </button>
                                                </div>
                                            </div>
                                        )}
                                    </div>

                                    {/* Bay Footer - Delete */}
                                    {bay.status === 'available' && (
                                        <div style={{
                                            padding: '12px 20px',
                                            borderTop: `1px solid ${theme.border}`,
                                            display: 'flex',
                                            justifyContent: 'flex-end'
                                        }}>
                                            <button
                                                onClick={() => handleDeleteBay(bay)}
                                                style={{
                                                    padding: '6px 12px',
                                                    borderRadius: '2px',
                                                    border: 'none',
                                                    backgroundColor: '#fee2e2',
                                                    color: '#dc2626',
                                                    fontSize: '12px',
                                                    cursor: 'pointer'
                                                }}
                                            >
                                                Delete Bay
                                            </button>
                                        </div>
                                    )}
                                </div>
                            );
                        })
                    )}
                </div>
            )}

            {/* History Tab */}
            {activeTab === 'history' && (
                <div>
                    {/* Search & Filters Bar */}
                    <div style={{
                        backgroundColor: theme.bg,
                        borderRadius: '2px',
                        border: `1px solid ${theme.border}`,
                        padding: '16px',
                        marginBottom: '16px',
                        display: 'flex',
                        flexDirection: 'column',
                        gap: '12px'
                    }}>
                        {/* Search Row */}
                        <div style={{ display: 'flex', gap: '12px', flexWrap: 'wrap', alignItems: 'center' }}>
                            <div style={{ flex: '1', minWidth: '200px', maxWidth: '350px', position: 'relative' }}>
                                <input
                                    type="text"
                                    placeholder="Search plate, customer, or staff..."
                                    value={historySearch}
                                    onChange={(e) => { setHistorySearch(e.target.value); setHistoryPage(1); }}
                                    style={{
                                        width: '100%',
                                        padding: '10px 12px 10px 36px',
                                        borderRadius: '2px',
                                        border: `1px solid ${theme.border}`,
                                        backgroundColor: theme.inputBg,
                                        color: theme.text,
                                        fontSize: '14px',
                                        outline: 'none'
                                    }}
                                />
                                <span style={{ position: 'absolute', left: '12px', top: '50%', transform: 'translateY(-50%)', color: theme.textSecondary }}>üîç</span>
                            </div>
                            
                            {/* Date Filter */}
                            <select
                                value={historyDateFilter}
                                onChange={(e) => { setHistoryDateFilter(e.target.value); setHistoryPage(1); }}
                                style={{
                                    padding: '10px 12px',
                                    borderRadius: '2px',
                                    border: `1px solid ${theme.border}`,
                                    backgroundColor: theme.inputBg,
                                    color: theme.text,
                                    fontSize: '14px',
                                    cursor: 'pointer',
                                    minWidth: '130px'
                                }}
                            >
                                <option value="all">All Time</option>
                                <option value="today">Today</option>
                                <option value="yesterday">Yesterday</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                                <option value="custom">Custom Range</option>
                            </select>
                            
                            {/* Custom Date Range */}
                            {historyDateFilter === 'custom' && (
                                <>
                                    <input
                                        type="date"
                                        value={historyCustomDateFrom}
                                        onChange={(e) => { setHistoryCustomDateFrom(e.target.value); setHistoryPage(1); }}
                                        style={{
                                            padding: '9px 12px',
                                            borderRadius: '2px',
                                            border: `1px solid ${theme.border}`,
                                            backgroundColor: theme.inputBg,
                                            color: theme.text,
                                            fontSize: '14px'
                                        }}
                                    />
                                    <span style={{ color: theme.textSecondary }}>to</span>
                                    <input
                                        type="date"
                                        value={historyCustomDateTo}
                                        onChange={(e) => { setHistoryCustomDateTo(e.target.value); setHistoryPage(1); }}
                                        style={{
                                            padding: '9px 12px',
                                            borderRadius: '2px',
                                            border: `1px solid ${theme.border}`,
                                            backgroundColor: theme.inputBg,
                                            color: theme.text,
                                            fontSize: '14px'
                                        }}
                                    />
                                </>
                            )}
                            
                            {/* Payment Filter */}
                            <select
                                value={historyPaymentFilter}
                                onChange={(e) => { setHistoryPaymentFilter(e.target.value); setHistoryPage(1); }}
                                style={{
                                    padding: '10px 12px',
                                    borderRadius: '2px',
                                    border: `1px solid ${theme.border}`,
                                    backgroundColor: theme.inputBg,
                                    color: theme.text,
                                    fontSize: '14px',
                                    cursor: 'pointer',
                                    minWidth: '120px'
                                }}
                            >
                                <option value="all">All Payments</option>
                                <option value="paid">‚úì Paid</option>
                                <option value="pending">‚è≥ Pending</option>
                            </select>
                            
                            {/* Bay Filter */}
                            <select
                                value={historyBayFilter}
                                onChange={(e) => { setHistoryBayFilter(e.target.value); setHistoryPage(1); }}
                                style={{
                                    padding: '10px 12px',
                                    borderRadius: '2px',
                                    border: `1px solid ${theme.border}`,
                                    backgroundColor: theme.inputBg,
                                    color: theme.text,
                                    fontSize: '14px',
                                    cursor: 'pointer',
                                    minWidth: '120px'
                                }}
                            >
                                <option value="all">All Bays</option>
                                {safeBays.map(bay => (
                                    <option key={bay.id} value={bay.id}>{bay.name}</option>
                                ))}
                            </select>
                            
                            {/* Clear Filters */}
                            {(historySearch || historyDateFilter !== 'all' || historyPaymentFilter !== 'all' || historyBayFilter !== 'all') && (
                                <button
                                    onClick={() => {
                                        setHistorySearch('');
                                        setHistoryDateFilter('all');
                                        setHistoryPaymentFilter('all');
                                        setHistoryBayFilter('all');
                                        setHistoryCustomDateFrom('');
                                        setHistoryCustomDateTo('');
                                        setHistoryPage(1);
                                    }}
                                    style={{
                                        padding: '10px 16px',
                                        borderRadius: '2px',
                                        border: 'none',
                                        backgroundColor: '#fee2e2',
                                        color: '#dc2626',
                                        fontSize: '14px',
                                        cursor: 'pointer',
                                        fontWeight: '500'
                                    }}
                                >
                                    Clear
                                </button>
                            )}
                        </div>
                    </div>
                    
                    {/* History Table */}
                    <div style={{
                        backgroundColor: theme.bg,
                        borderRadius: '2px',
                        border: `1px solid ${theme.border}`,
                        overflow: 'hidden'
                    }}>
                    <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                        <thead>
                            <tr style={{ backgroundColor: theme.bgSecondary }}>
                                <th style={{ padding: '14px 16px', textAlign: 'left', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase' }}>Bay</th>
                                <th style={{ padding: '14px 16px', textAlign: 'left', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase' }}>Vehicle</th>
                                <th style={{ padding: '14px 16px', textAlign: 'left', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase' }}>Service</th>
                                <th style={{ padding: '14px 16px', textAlign: 'right', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase' }}>Price</th>
                                <th style={{ padding: '14px 16px', textAlign: 'left', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase' }}>Washed By</th>
                                <th style={{ padding: '14px 16px', textAlign: 'center', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase' }}>Started</th>
                                <th style={{ padding: '14px 16px', textAlign: 'center', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase' }}>Completed</th>
                                <th style={{ padding: '14px 16px', textAlign: 'center', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase' }}>Duration</th>
                                <th style={{ padding: '14px 16px', textAlign: 'center', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase' }}>Status</th>
                                <th style={{ padding: '14px 16px', textAlign: 'center', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase' }}>Payment</th>
                                <th style={{ padding: '14px 16px', textAlign: 'center', fontSize: '12px', fontWeight: '600', color: theme.textSecondary, textTransform: 'uppercase' }}>Gate Pass</th>
                            </tr>
                        </thead>
                        <tbody>
                            {(() => {
                                // Get all completed records and apply filters
                                let completedRecords = history.filter(r => r.action === 'completed');
                                
                                // Search filter
                                if (historySearch.trim()) {
                                    const searchLower = historySearch.toLowerCase();
                                    completedRecords = completedRecords.filter(r => 
                                        (r.vehicle?.plateNumber || '').toLowerCase().includes(searchLower) ||
                                        (r.vehicle?.customerName || '').toLowerCase().includes(searchLower) ||
                                        (r.vehicle?.assignedBy || '').toLowerCase().includes(searchLower) ||
                                        (r.completedBy || '').toLowerCase().includes(searchLower) ||
                                        (r.bayName || '').toLowerCase().includes(searchLower)
                                    );
                                }
                                
                                // Date filter
                                const now = new Date();
                                const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                                const yesterdayStart = new Date(todayStart); yesterdayStart.setDate(yesterdayStart.getDate() - 1);
                                const weekStart = new Date(todayStart); weekStart.setDate(weekStart.getDate() - weekStart.getDay());
                                const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                                
                                if (historyDateFilter === 'today') {
                                    completedRecords = completedRecords.filter(r => new Date(r.timestamp || r.endTime) >= todayStart);
                                } else if (historyDateFilter === 'yesterday') {
                                    completedRecords = completedRecords.filter(r => {
                                        const d = new Date(r.timestamp || r.endTime);
                                        return d >= yesterdayStart && d < todayStart;
                                    });
                                } else if (historyDateFilter === 'week') {
                                    completedRecords = completedRecords.filter(r => new Date(r.timestamp || r.endTime) >= weekStart);
                                } else if (historyDateFilter === 'month') {
                                    completedRecords = completedRecords.filter(r => new Date(r.timestamp || r.endTime) >= monthStart);
                                } else if (historyDateFilter === 'custom' && historyCustomDateFrom && historyCustomDateTo) {
                                    const fromDate = new Date(historyCustomDateFrom); fromDate.setHours(0, 0, 0, 0);
                                    const toDate = new Date(historyCustomDateTo); toDate.setHours(23, 59, 59, 999);
                                    completedRecords = completedRecords.filter(r => {
                                        const d = new Date(r.timestamp || r.endTime);
                                        return d >= fromDate && d <= toDate;
                                    });
                                }
                                
                                // Bay filter
                                if (historyBayFilter !== 'all') {
                                    completedRecords = completedRecords.filter(r => r.bayId === historyBayFilter);
                                }
                                
                                // Payment filter - FIRST check record's own paymentStatus, then fallback to invoice matching
                                if (historyPaymentFilter !== 'all') {
                                    completedRecords = completedRecords.filter(record => {
                                        // First check record's own paymentStatus (most reliable)
                                        if (record.paymentStatus === 'paid') {
                                            return historyPaymentFilter === 'paid';
                                        }
                                        if (record.paymentStatus === 'pending') {
                                            return historyPaymentFilter === 'pending';
                                        }
                                        // Fallback to invoice matching for older records without paymentStatus
                                        const matchingInvoice = invoices.find(inv => {
                                            if (inv.washHistoryId && (record.washHistoryId || record.id)) {
                                                return inv.washHistoryId === record.washHistoryId || inv.washHistoryId === record.id;
                                            }
                                            if (inv.washRecordId && record.vehicle?.recordId) {
                                                return inv.washRecordId === record.vehicle.recordId;
                                            }
                                            return inv.plateNumber === record.vehicle?.plateNumber &&
                                                inv.source === 'wash' &&
                                                inv.bayId === record.bayId &&
                                                Math.abs(new Date(inv.createdAt) - new Date(record.endTime || record.timestamp)) < 300000;
                                        });
                                        const isPaid = matchingInvoice?.paymentStatus === 'paid';
                                        return historyPaymentFilter === 'paid' ? isPaid : !isPaid;
                                    });
                                }
                                
                                // Store total for pagination
                                const totalFiltered = completedRecords.length;
                                const totalPages = Math.ceil(totalFiltered / historyPageSize) || 1;
                                
                                // Paginate
                                const startIndex = (historyPage - 1) * historyPageSize;
                                const paginatedRecords = completedRecords.slice(startIndex, startIndex + historyPageSize);
                                
                                if (completedRecords.length === 0) {
                                    // Show in-progress items (started but not completed)
                                    const startedRecords = history.filter(r => r.action === 'started');
                                    if (startedRecords.length === 0) {
                                        return (
                                            <tr>
                                                <td colSpan="9" style={{ padding: '40px', textAlign: 'center', color: theme.textSecondary }}>
                                                    No wash history yet
                                                </td>
                                            </tr>
                                        );
                                    }
                                    return startedRecords.map(record => {
                                        // Use same helper functions for service
                                        const svcName = (() => {
                                            const v = record.vehicle;
                                            if (!v) return '-';
                                            const svc = v.service;
                                            if (typeof svc === 'string') return svc || '-';
                                            if (typeof svc === 'object' && svc !== null) return svc.name || '-';
                                            return '-';
                                        })();
                                        const svcPrice = (() => {
                                            const v = record.vehicle;
                                            if (!v) return 0;
                                            if (typeof v.servicePrice === 'number') return v.servicePrice;
                                            const svc = v.service;
                                            if (typeof svc === 'object' && svc !== null && typeof svc.price === 'number') return svc.price;
                                            if (v.servicePrice) return Number(v.servicePrice) || 0;
                                            return 0;
                                        })();
                                        return (
                                        <tr key={record.id} style={{ borderTop: `1px solid ${theme.border}` }}>
                                            <td style={{ padding: '14px 16px', fontSize: '13px', color: theme.text, fontWeight: '500' }}>
                                                {record.bayName || record.bayId || '-'}
                                            </td>
                                            <td style={{ padding: '14px 16px' }}>
                                                <div style={{ fontWeight: '600', color: theme.text }}>{record.vehicle?.plateNumber || 'Unknown'}</div>
                                                <div style={{ fontSize: '12px', color: theme.textSecondary }}>{record.vehicle?.customerName || 'Walk-in'}</div>
                                            </td>
                                            <td style={{ padding: '14px 16px', fontSize: '13px', color: theme.text }}>
                                                {svcName}
                                            </td>
                                            <td style={{ padding: '14px 16px', textAlign: 'right', fontSize: '13px', fontWeight: '600', color: '#10b981' }}>
                                                {getBrandingForReceipts().currencySymbol || 'KES'} {svcPrice.toLocaleString()}
                                            </td>
                                            <td style={{ padding: '14px 16px', fontSize: '13px', color: theme.text }}>
                                                {record.vehicle?.washedBy || record.vehicle?.assignedBy || '-'}
                                            </td>
                                            <td style={{ padding: '14px 16px', textAlign: 'center', fontSize: '12px', color: theme.text }}>
                                                {record.timestamp ? new Date(record.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '-'}
                                            </td>
                                            <td style={{ padding: '14px 16px', textAlign: 'center', fontSize: '12px', color: theme.textSecondary }}>
                                                -
                                            </td>
                                            <td style={{ padding: '14px 16px', textAlign: 'center', fontSize: '13px', color: theme.textSecondary }}>
                                                -
                                            </td>
                                            <td style={{ padding: '14px 16px', textAlign: 'center' }}>
                                                <span style={{
                                                    padding: '4px 10px',
                                                    borderRadius: '12px',
                                                    fontSize: '11px',
                                                    fontWeight: '600',
                                                    backgroundColor: '#dbeafe',
                                                    color: '#1d4ed8'
                                                }}>
                                                    üöø Washing
                                                </span>
                                            </td>
                                            <td style={{ padding: '14px 16px', textAlign: 'center' }}>
                                                <span style={{
                                                    padding: '4px 10px',
                                                    borderRadius: '12px',
                                                    fontSize: '12px',
                                                    fontWeight: '500',
                                                    backgroundColor: '#fef3c7',
                                                    color: '#d97706'
                                                }}>
                                                    In Progress
                                                </span>
                                            </td>
                                            <td style={{ padding: '14px 16px', textAlign: 'center' }}>
                                                <span style={{
                                                    fontSize: '11px',
                                                    color: theme.textSecondary,
                                                    fontStyle: 'italic'
                                                }}>
                                                    -
                                                </span>
                                            </td>
                                        </tr>
                                    )});
                                }
                                
                                // Helper to safely get service name
                                const getServiceName = (vehicle) => {
                                    if (!vehicle) return '-';
                                    const svc = vehicle.service;
                                    if (typeof svc === 'string') return svc || '-';
                                    if (typeof svc === 'object' && svc !== null) return svc.name || '-';
                                    return '-';
                                };
                                
                                // Helper to safely get service price
                                const getServicePrice = (vehicle) => {
                                    if (!vehicle) return 0;
                                    // First check servicePrice (direct field)
                                    if (typeof vehicle.servicePrice === 'number') return vehicle.servicePrice;
                                    // Then check service object
                                    const svc = vehicle.service;
                                    if (typeof svc === 'object' && svc !== null && typeof svc.price === 'number') return svc.price;
                                    // Try parsing servicePrice as number
                                    if (vehicle.servicePrice) return Number(vehicle.servicePrice) || 0;
                                    return 0;
                                };
                                
                                // Show paginated completed records
                                const rows = paginatedRecords.map(record => {
                                    const serviceName = getServiceName(record.vehicle);
                                    const servicePrice = getServicePrice(record.vehicle);
                                    
                                    // Check payment status - FIRST check the record's own paymentStatus field (most reliable)
                                    let isPaid = record.paymentStatus === 'paid';
                                    
                                    // Fallback: Find matching invoice if record doesn't have paymentStatus
                                    if (!isPaid && record.paymentStatus !== 'paid') {
                                        const matchingInvoice = invoices.find(inv => {
                                            // Match by washHistoryId if available (most reliable)
                                            if (inv.washHistoryId && (record.washHistoryId || record.id)) {
                                                return inv.washHistoryId === record.washHistoryId || inv.washHistoryId === record.id;
                                            }
                                            // Match by washRecordId if available
                                            if (inv.washRecordId && record.vehicle?.recordId) {
                                                return inv.washRecordId === record.vehicle.recordId;
                                            }
                                            // Match by plate number + bay + time window
                                            return inv.plateNumber === record.vehicle?.plateNumber &&
                                                inv.source === 'wash' &&
                                                inv.bayId === record.bayId &&
                                                // Match within 5 minutes of the wash completion
                                                Math.abs(new Date(inv.createdAt) - new Date(record.endTime || record.timestamp)) < 300000;
                                        });
                                        isPaid = matchingInvoice?.paymentStatus === 'paid';
                                    }
                                    
                                    return (
                                    <tr key={record.id} style={{ borderTop: `1px solid ${theme.border}` }}>
                                        <td style={{ padding: '14px 16px', fontSize: '13px', color: theme.text, fontWeight: '500' }}>
                                            {record.bayName || record.bayId}
                                        </td>
                                        <td style={{ padding: '14px 16px' }}>
                                            <div style={{ fontWeight: '600', color: theme.text }}>{record.vehicle?.plateNumber || 'Unknown'}</div>
                                            <div style={{ fontSize: '12px', color: theme.textSecondary }}>{record.vehicle?.customerName || 'Walk-in'}</div>
                                        </td>
                                        <td style={{ padding: '14px 16px', fontSize: '13px', color: theme.text }}>
                                            {serviceName}
                                        </td>
                                        <td style={{ padding: '14px 16px', textAlign: 'right', fontSize: '13px', fontWeight: '600', color: '#10b981' }}>
                                            {getBrandingForReceipts().currencySymbol || 'KES'} {servicePrice.toLocaleString()}
                                        </td>
                                        <td style={{ padding: '14px 16px', fontSize: '13px', color: theme.text }}>
                                            {record.vehicle?.washedBy || record.completedBy || '-'}
                                        </td>
                                        <td style={{ padding: '14px 16px', textAlign: 'center', fontSize: '12px', color: theme.text }}>
                                            {record.startTime ? new Date(record.startTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '-'}
                                        </td>
                                        <td style={{ padding: '14px 16px', textAlign: 'center', fontSize: '12px', color: theme.text }}>
                                            {record.endTime ? new Date(record.endTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '-'}
                                        </td>
                                        <td style={{ padding: '14px 16px', textAlign: 'center', fontSize: '13px', fontWeight: '600', color: '#3b82f6' }}>
                                            {record.duration ? `${record.duration} min` : '-'}
                                        </td>
                                        <td style={{ padding: '14px 16px', textAlign: 'center' }}>
                                            {isPaid ? (
                                                <span style={{
                                                    padding: '4px 12px',
                                                    borderRadius: '12px',
                                                    fontSize: '11px',
                                                    fontWeight: '600',
                                                    backgroundColor: '#d1fae5',
                                                    color: '#059669'
                                                }}>
                                                    ‚úì Cleared
                                                </span>
                                            ) : (
                                                <span style={{
                                                    padding: '4px 12px',
                                                    borderRadius: '12px',
                                                    fontSize: '11px',
                                                    fontWeight: '600',
                                                    backgroundColor: '#fef3c7',
                                                    color: '#d97706'
                                                }}>
                                                    {(record.vehicle?.vehicleType?.toLowerCase() === 'carpet' || 
                                                      record.vehicle?.category?.toLowerCase() === 'carpet' ||
                                                      serviceName?.toLowerCase().includes('carpet')) 
                                                        ? 'üì¶ Storage' 
                                                        : 'üí∞ Billing'}
                                                </span>
                                            )}
                                        </td>
                                        <td style={{ padding: '14px 16px', textAlign: 'center' }}>
                                            {isPaid ? (
                                                <span style={{
                                                    padding: '4px 10px',
                                                    borderRadius: '12px',
                                                    fontSize: '11px',
                                                    fontWeight: '600',
                                                    backgroundColor: '#d1fae5',
                                                    color: '#059669'
                                                }}>
                                                    ‚úì {getBrandingForReceipts().currencySymbol || 'KES'} {servicePrice.toLocaleString()} Paid
                                                </span>
                                            ) : (
                                                <span style={{
                                                    padding: '4px 10px',
                                                    borderRadius: '12px',
                                                    fontSize: '11px',
                                                    fontWeight: '600',
                                                    backgroundColor: '#fef3c7',
                                                    color: '#d97706'
                                                }}>
                                                    üí∞ {getBrandingForReceipts().currencySymbol || 'KES'} {servicePrice.toLocaleString()} Pending
                                                </span>
                                            )}
                                        </td>
                                        <td style={{ padding: '14px 16px', textAlign: 'center' }}>
                                            {isPaid ? (
                                                <button
                                                    onClick={() => printWashGatePass(record)}
                                                    style={{
                                                        padding: '6px 12px',
                                                        backgroundColor: '#10b981',
                                                        color: 'white',
                                                        border: 'none',
                                                        borderRadius: '6px',
                                                        fontSize: '11px',
                                                        fontWeight: '600',
                                                        cursor: 'pointer',
                                                        display: 'flex',
                                                        alignItems: 'center',
                                                        gap: '4px',
                                                        margin: '0 auto'
                                                    }}
                                                    title="Print gate pass for cleared vehicle"
                                                >
                                                    üé´ Gate Pass
                                                </button>
                                            ) : (
                                                <span style={{
                                                    fontSize: '11px',
                                                    color: theme.textSecondary,
                                                    fontStyle: 'italic'
                                                }}>
                                                    Pay first
                                                </span>
                                            )}
                                        </td>
                                    </tr>
                                )});
                                
                                // Store pagination info for footer
                                window._historyPaginationInfo = { totalFiltered, totalPages, startIndex };
                                return rows;
                            })()}
                        </tbody>
                    </table>
                    
                    {/* Pagination Controls */}
                    {(() => {
                        const info = window._historyPaginationInfo || { totalFiltered: 0, totalPages: 1, startIndex: 0 };
                        const { totalFiltered, totalPages } = info;
                        
                        // Generate page numbers to show
                        const getPageNumbers = () => {
                            const pages = [];
                            const maxVisible = 7;
                            
                            if (totalPages <= maxVisible) {
                                for (let i = 1; i <= totalPages; i++) pages.push(i);
                            } else {
                                pages.push(1);
                                
                                if (historyPage > 3) pages.push('...');
                                
                                const start = Math.max(2, historyPage - 1);
                                const end = Math.min(totalPages - 1, historyPage + 1);
                                
                                for (let i = start; i <= end; i++) {
                                    if (!pages.includes(i)) pages.push(i);
                                }
                                
                                if (historyPage < totalPages - 2) pages.push('...');
                                
                                if (!pages.includes(totalPages)) pages.push(totalPages);
                            }
                            return pages;
                        };
                        
                        return (
                            <div style={{
                                padding: '16px 20px',
                                borderTop: `1px solid ${theme.border}`,
                                backgroundColor: theme.bgSecondary,
                                display: 'flex',
                                flexWrap: 'wrap',
                                justifyContent: 'space-between',
                                alignItems: 'center',
                                gap: '16px'
                            }}>
                                {/* Left: Results info & page size */}
                                <div style={{ display: 'flex', alignItems: 'center', gap: '16px', flexWrap: 'wrap' }}>
                                    <span style={{ fontSize: '13px', color: theme.textSecondary }}>
                                        Showing <strong style={{ color: theme.text }}>{Math.min((historyPage - 1) * historyPageSize + 1, totalFiltered)}-{Math.min(historyPage * historyPageSize, totalFiltered)}</strong> of <strong style={{ color: theme.text }}>{totalFiltered.toLocaleString()}</strong> records
                                    </span>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                        <span style={{ fontSize: '13px', color: theme.textSecondary }}>Show:</span>
                                        <select
                                            value={historyPageSize}
                                            onChange={(e) => { setHistoryPageSize(Number(e.target.value)); setHistoryPage(1); }}
                                            style={{
                                                padding: '6px 10px',
                                                borderRadius: '2px',
                                                border: `1px solid ${theme.border}`,
                                                backgroundColor: theme.inputBg,
                                                color: theme.text,
                                                fontSize: '13px',
                                                cursor: 'pointer'
                                            }}
                                        >
                                            <option value={10}>10</option>
                                            <option value={25}>25</option>
                                            <option value={50}>50</option>
                                            <option value={100}>100</option>
                                            <option value={250}>250</option>
                                            <option value={500}>500</option>
                                        </select>
                                    </div>
                                </div>
                                
                                {/* Center: Page numbers */}
                                <div style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                                    {/* First & Prev */}
                                    <button
                                        onClick={() => setHistoryPage(1)}
                                        disabled={historyPage === 1}
                                        style={{
                                            padding: '8px 10px',
                                            borderRadius: '2px',
                                            border: `1px solid ${theme.border}`,
                                            backgroundColor: historyPage === 1 ? theme.bgSecondary : theme.bg,
                                            color: historyPage === 1 ? theme.textSecondary : theme.text,
                                            cursor: historyPage === 1 ? 'not-allowed' : 'pointer',
                                            fontSize: '12px',
                                            opacity: historyPage === 1 ? 0.5 : 1
                                        }}
                                        title="First page"
                                    >
                                        ‚ü™
                                    </button>
                                    <button
                                        onClick={() => setHistoryPage(p => Math.max(1, p - 1))}
                                        disabled={historyPage === 1}
                                        style={{
                                            padding: '8px 12px',
                                            borderRadius: '2px',
                                            border: `1px solid ${theme.border}`,
                                            backgroundColor: historyPage === 1 ? theme.bgSecondary : theme.bg,
                                            color: historyPage === 1 ? theme.textSecondary : theme.text,
                                            cursor: historyPage === 1 ? 'not-allowed' : 'pointer',
                                            fontSize: '12px',
                                            opacity: historyPage === 1 ? 0.5 : 1
                                        }}
                                    >
                                        ‚Üê Prev
                                    </button>
                                    
                                    {/* Page Numbers */}
                                    {getPageNumbers().map((page, idx) => (
                                        page === '...' ? (
                                            <span key={`ellipsis-${idx}`} style={{ padding: '8px 4px', color: theme.textSecondary }}>...</span>
                                        ) : (
                                            <button
                                                key={page}
                                                onClick={() => setHistoryPage(page)}
                                                style={{
                                                    padding: '8px 12px',
                                                    borderRadius: '2px',
                                                    border: historyPage === page ? 'none' : `1px solid ${theme.border}`,
                                                    backgroundColor: historyPage === page ? '#3b82f6' : theme.bg,
                                                    color: historyPage === page ? 'white' : theme.text,
                                                    cursor: 'pointer',
                                                    fontSize: '13px',
                                                    fontWeight: historyPage === page ? '600' : '400',
                                                    minWidth: '40px'
                                                }}
                                            >
                                                {page.toLocaleString()}
                                            </button>
                                        )
                                    ))}
                                    
                                    {/* Next & Last */}
                                    <button
                                        onClick={() => setHistoryPage(p => Math.min(totalPages, p + 1))}
                                        disabled={historyPage === totalPages}
                                        style={{
                                            padding: '8px 12px',
                                            borderRadius: '2px',
                                            border: `1px solid ${theme.border}`,
                                            backgroundColor: historyPage === totalPages ? theme.bgSecondary : theme.bg,
                                            color: historyPage === totalPages ? theme.textSecondary : theme.text,
                                            cursor: historyPage === totalPages ? 'not-allowed' : 'pointer',
                                            fontSize: '12px',
                                            opacity: historyPage === totalPages ? 0.5 : 1
                                        }}
                                    >
                                        Next ‚Üí
                                    </button>
                                    <button
                                        onClick={() => setHistoryPage(totalPages)}
                                        disabled={historyPage === totalPages}
                                        style={{
                                            padding: '8px 10px',
                                            borderRadius: '2px',
                                            border: `1px solid ${theme.border}`,
                                            backgroundColor: historyPage === totalPages ? theme.bgSecondary : theme.bg,
                                            color: historyPage === totalPages ? theme.textSecondary : theme.text,
                                            cursor: historyPage === totalPages ? 'not-allowed' : 'pointer',
                                            fontSize: '12px',
                                            opacity: historyPage === totalPages ? 0.5 : 1
                                        }}
                                        title="Last page"
                                    >
                                        ‚ü´
                                    </button>
                                </div>
                                
                                {/* Right: Jump to page */}
                                <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                    <span style={{ fontSize: '13px', color: theme.textSecondary }}>Go to:</span>
                                    <input
                                        type="number"
                                        min="1"
                                        max={totalPages}
                                        value={historyJumpPage}
                                        onChange={(e) => setHistoryJumpPage(e.target.value)}
                                        onKeyDown={(e) => {
                                            if (e.key === 'Enter') {
                                                const page = parseInt(historyJumpPage);
                                                if (page >= 1 && page <= totalPages) {
                                                    setHistoryPage(page);
                                                    setHistoryJumpPage('');
                                                }
                                            }
                                        }}
                                        placeholder={historyPage.toString()}
                                        style={{
                                            width: '70px',
                                            padding: '6px 10px',
                                            borderRadius: '2px',
                                            border: `1px solid ${theme.border}`,
                                            backgroundColor: theme.inputBg,
                                            color: theme.text,
                                            fontSize: '13px',
                                            textAlign: 'center'
                                        }}
                                    />
                                    <button
                                        onClick={() => {
                                            const page = parseInt(historyJumpPage);
                                            if (page >= 1 && page <= totalPages) {
                                                setHistoryPage(page);
                                                setHistoryJumpPage('');
                                            }
                                        }}
                                        style={{
                                            padding: '6px 12px',
                                            borderRadius: '2px',
                                            border: 'none',
                                            backgroundColor: '#3b82f6',
                                            color: 'white',
                                            fontSize: '13px',
                                            cursor: 'pointer',
                                            fontWeight: '500'
                                        }}
                                    >
                                        Go
                                    </button>
                                </div>
                            </div>
                        );
                    })()}
                </div>
                </div>
            )}

            {/* View Vehicle Modal */}
            {showViewVehicleModal && selectedViewVehicle && (
                <div style={{
                    position: 'fixed',
                    top: 0,
                    left: 0,
                    right: 0,
                    bottom: 0,
                    backgroundColor: 'rgba(0,0,0,0.5)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    zIndex: 1000
                }} onClick={() => setShowViewVehicleModal(false)}>
                    <div style={{
                        backgroundColor: theme.bg,
                        borderRadius: '2px',
                        width: '100%',
                        maxWidth: '500px',
                        margin: '20px',
                        maxHeight: '90vh',
                        overflow: 'auto',
                        boxShadow: theme.cardShadow
                    }} onClick={e => e.stopPropagation()}>
                        <div style={{ 
                            padding: '20px', 
                            borderBottom: `1px solid ${theme.border}`,
                            display: 'flex', 
                            justifyContent: 'space-between', 
                            alignItems: 'center' 
                        }}>
                            <h2 style={{ margin: 0, color: theme.text }}>Vehicle Details</h2>
                            <button 
                                onClick={() => setShowViewVehicleModal(false)}
                                style={{ background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer', color: theme.textSecondary }}
                            >
                                √ó
                            </button>
                        </div>
                        
                        <div style={{ padding: '20px' }}>
                            {(() => {
                                const fullRecord = intakeRecords.find(r => r.id === selectedViewVehicle.recordId) || selectedViewVehicle;
                                return (
                                    <div style={{ display: 'flex', flexDirection: 'column', gap: '20px' }}>
                                        <div style={{ textAlign: 'center', padding: '20px', backgroundColor: theme.bgSecondary, borderRadius: '4px' }}>
                                            <div style={{ fontSize: '32px', fontWeight: 'bold', color: theme.text, letterSpacing: '2px' }}>{fullRecord.plateNumber}</div>
                                            <div style={{ color: theme.textSecondary, marginTop: '4px' }}>{fullRecord.vehicleType || 'Vehicle'}</div>
                                        </div>

                                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px' }}>
                                            <div>
                                                <div style={{ fontSize: '12px', color: theme.textSecondary, textTransform: 'uppercase', marginBottom: '4px' }}>Customer</div>
                                                <div style={{ fontWeight: '600', color: theme.text, fontSize: '15px' }}>{fullRecord.customerName || 'Walk-in'}</div>
                                            </div>
                                            <div>
                                                <div style={{ fontSize: '12px', color: theme.textSecondary, textTransform: 'uppercase', marginBottom: '4px' }}>Service</div>
                                                <div style={{ fontWeight: '600', color: theme.text, fontSize: '15px' }}>
                                                    {typeof fullRecord.service === 'object' ? fullRecord.service.name : fullRecord.service}
                                                </div>
                                            </div>
                                            <div>
                                                <div style={{ fontSize: '12px', color: theme.textSecondary, textTransform: 'uppercase', marginBottom: '4px' }}>Assigned By</div>
                                                <div style={{ fontWeight: '600', color: theme.text, fontSize: '15px' }}>{fullRecord.assignedBy || '-'}</div>
                                            </div>
                                            <div>
                                                <div style={{ fontSize: '12px', color: theme.textSecondary, textTransform: 'uppercase', marginBottom: '4px' }}>Time In</div>
                                                <div style={{ fontWeight: '600', color: theme.text, fontSize: '15px' }}>
                                                    {fullRecord.timeIn ? new Date(fullRecord.timeIn).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '-'}
                                                </div>
                                            </div>
                                        </div>

                                        {fullRecord.notes && (
                                           <div style={{ padding: '16px', backgroundColor: '#fff7ed', borderRadius: '4px', border: '1px solid #ffedd5' }}>
                                               <div style={{ fontSize: '12px', fontWeight: 'bold', color: '#c2410c', marginBottom: '8px', textTransform: 'uppercase' }}>Notes</div>
                                               <div style={{ fontSize: '14px', color: '#9a3412', lineHeight: '1.5' }}>{fullRecord.notes}</div>
                                           </div>
                                        )}
                                        
                                        <div style={{ padding: '16px', backgroundColor: '#eff6ff', borderRadius: '4px', border: '1px solid #dbeafe', display: 'flex', alignItems: 'center', gap: '12px' }}>
                                            <div style={{ fontSize: '24px' }}>üìç</div>
                                            <div>
                                                <div style={{ fontSize: '12px', color: '#1e40af', fontWeight: 'bold' }}>Current Location</div>
                                                <div style={{ fontSize: '14px', color: '#1e3a8a' }}>Assigned to {fullRecord.assignedBay || 'Wash Bay'}</div>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })()}
                        </div>
                        
                        <div style={{ padding: '20px', borderTop: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'flex-end', gap: '12px' }}>
                             <button
                                onClick={() => setShowViewVehicleModal(false)}
                                style={{
                                    padding: '10px 24px',
                                    borderRadius: '2px',
                                    border: 'none',
                                    background: '#3b82f6',
                                    color: 'white',
                                    fontWeight: '600',
                                    cursor: 'pointer'
                                }}
                            >
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* Add Bay Modal */}
            {showAddModal && (
                <div style={{
                    position: 'fixed',
                    top: 0,
                    left: 0,
                    right: 0,
                    bottom: 0,
                    backgroundColor: 'rgba(0,0,0,0.5)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    zIndex: 1000
                }} onClick={() => setShowAddModal(false)}>
                    <div style={{
                        backgroundColor: theme.bg,
                        borderRadius: '2px',
                        width: '100%',
                        maxWidth: '400px',
                        margin: '20px'
                    }} onClick={e => e.stopPropagation()}>
                        <div style={{ padding: '20px', borderBottom: `1px solid ${theme.border}` }}>
                            <h2 style={{ margin: 0, color: theme.text }}>Add New Bay</h2>
                        </div>
                        <form onSubmit={handleAddBay} style={{ padding: '20px' }}>
                            <div style={{ marginBottom: '16px' }}>
                                <label style={{ display: 'block', marginBottom: '6px', fontWeight: '500', color: theme.text }}>Bay Name *</label>
                                <input
                                    type="text"
                                    value={bayForm.name}
                                    onChange={e => setBayForm({ ...bayForm, name: e.target.value })}
                                    placeholder="e.g., Bay 5"
                                    style={{
                                        width: '100%',
                                        padding: '12px',
                                        borderRadius: '2px',
                                        border: `1px solid ${theme.border}`,
                                        backgroundColor: theme.inputBg,
                                        color: theme.text,
                                        fontSize: '14px'
                                    }}
                                />
                            </div>
                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'block', marginBottom: '6px', fontWeight: '500', color: theme.text }}>Bay Type</label>
                                <select
                                    value={bayForm.type}
                                    onChange={e => setBayForm({ ...bayForm, type: e.target.value })}
                                    style={{
                                        width: '100%',
                                        padding: '12px',
                                        borderRadius: '2px',
                                        border: `1px solid ${theme.border}`,
                                        backgroundColor: theme.inputBg,
                                        color: theme.text,
                                        fontSize: '14px'
                                    }}
                                >
                                    {BAY_TYPES.map(t => (
                                        <option key={t.id} value={t.id}>{t.name}</option>
                                    ))}
                                </select>
                            </div>
                            <div style={{ display: 'flex', gap: '12px' }}>
                                <button
                                    type="button"
                                    onClick={() => setShowAddModal(false)}
                                    style={{
                                        flex: 1,
                                        padding: '12px',
                                        borderRadius: '2px',
                                        border: `1px solid ${theme.border}`,
                                        backgroundColor: 'transparent',
                                        color: theme.text,
                                        fontWeight: '600',
                                        cursor: 'pointer'
                                    }}
                                >
                                    Cancel
                                </button>
                                <button
                                    type="submit"
                                    disabled={actionLoading}
                                    style={{
                                        flex: 1,
                                        padding: '12px',
                                        borderRadius: '2px',
                                        border: 'none',
                                        backgroundColor: '#10b981',
                                        color: 'white',
                                        fontWeight: '600',
                                        cursor: actionLoading ? 'not-allowed' : 'pointer'
                                    }}
                                >
                                    {actionLoading ? 'Adding...' : 'Add Bay'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            )}

            {/* Assign Vehicle Modal */}
            {showAssignModal && selectedBay && (
                <div style={{
                    position: 'fixed',
                    top: 0,
                    left: 0,
                    right: 0,
                    bottom: 0,
                    backgroundColor: 'rgba(0,0,0,0.5)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    zIndex: 1000
                }} onClick={() => setShowAssignModal(false)}>
                    <div style={{
                        backgroundColor: theme.bg,
                        borderRadius: '2px',
                        width: '100%',
                        maxWidth: '500px',
                        margin: '20px',
                        maxHeight: '90vh',
                        overflow: 'auto'
                    }} onClick={e => e.stopPropagation()}>
                        <div style={{ padding: '20px', borderBottom: `1px solid ${theme.border}` }}>
                            <h2 style={{ margin: 0, color: theme.text }}>Assign Vehicle to {selectedBay.name}</h2>
                        </div>
                        
                        <form onSubmit={handleAssignVehicle} style={{ padding: '20px' }}>
                            {/* Mode Toggle - 3 options */}
                            <div style={{ 
                                display: 'flex', 
                                gap: '4px', 
                                marginBottom: '20px',
                                padding: '4px',
                                backgroundColor: theme.bgSecondary,
                                borderRadius: '2px'
                            }}>
                                <button
                                    type="button"
                                    onClick={() => { setAssignMode('select'); setSelectedVehicleId(''); }}
                                    style={{
                                        flex: 1,
                                        padding: '10px 12px',
                                        borderRadius: '2px',
                                        border: 'none',
                                        backgroundColor: assignMode === 'select' ? '#3b82f6' : 'transparent',
                                        color: assignMode === 'select' ? 'white' : theme.textSecondary,
                                        fontWeight: '600',
                                        cursor: 'pointer',
                                        fontSize: '12px'
                                    }}
                                >
                                    ‚è≥ Queue ({intakeQueue.length})
                                </button>
                                <button
                                    type="button"
                                    onClick={() => { setAssignMode('assigned'); setSelectedVehicleId(''); }}
                                    style={{
                                        flex: 1,
                                        padding: '10px 12px',
                                        borderRadius: '2px',
                                        border: 'none',
                                        backgroundColor: assignMode === 'assigned' ? '#10b981' : 'transparent',
                                        color: assignMode === 'assigned' ? 'white' : theme.textSecondary,
                                        fontWeight: '600',
                                        cursor: 'pointer',
                                        fontSize: '12px'
                                    }}
                                >
                                    üöó Assigned ({intakeRecords.filter(r => r.status === 'in-progress' && r.assignedBayId).length})
                                </button>
                                <button
                                    type="button"
                                    onClick={() => setAssignMode('new')}
                                    style={{
                                        flex: 1,
                                        padding: '10px 12px',
                                        borderRadius: '2px',
                                        border: 'none',
                                        backgroundColor: assignMode === 'new' ? '#8b5cf6' : 'transparent',
                                        color: assignMode === 'new' ? 'white' : theme.textSecondary,
                                        fontWeight: '600',
                                        cursor: 'pointer',
                                        fontSize: '12px'
                                    }}
                                >
                                    ‚ûï New
                                </button>
                            </div>

                            {/* Select from Queue */}
                            {assignMode === 'select' && (
                                <div style={{ marginBottom: '16px' }}>
                                    {intakeQueue.length === 0 ? (
                                        <div style={{ 
                                            textAlign: 'center', 
                                            padding: '30px 20px',
                                            backgroundColor: theme.bgSecondary,
                                            borderRadius: '2px',
                                            border: `1px dashed ${theme.border}`
                                        }}>
                                            <div style={{ fontSize: '36px', marginBottom: '12px' }}>‚è≥</div>
                                            <p style={{ color: theme.textSecondary, marginBottom: '12px' }}>No vehicles waiting in queue</p>
                                            <button
                                                type="button"
                                                onClick={() => setAssignMode('assigned')}
                                                style={{
                                                    padding: '8px 16px',
                                                    borderRadius: '2px',
                                                    border: 'none',
                                                    backgroundColor: '#10b981',
                                                    color: 'white',
                                                    fontWeight: '500',
                                                    cursor: 'pointer',
                                                    fontSize: '13px',
                                                    marginRight: '8px'
                                                }}
                                            >
                                                View Assigned
                                            </button>
                                            <button
                                                type="button"
                                                onClick={() => setAssignMode('new')}
                                                style={{
                                                    padding: '8px 16px',
                                                    borderRadius: '2px',
                                                    border: 'none',
                                                    backgroundColor: '#3b82f6',
                                                    color: 'white',
                                                    fontWeight: '500',
                                                    cursor: 'pointer',
                                                    fontSize: '13px'
                                                }}
                                            >
                                                Add New Vehicle
                                            </button>
                                        </div>
                                    ) : (
                                        <div>
                                            <label style={{ display: 'block', marginBottom: '8px', fontWeight: '500', color: theme.text }}>
                                                Select Vehicle from Queue
                                            </label>
                                            <div style={{ maxHeight: '200px', overflowY: 'auto', border: `1px solid ${theme.border}`, borderRadius: '2px' }}>
                                                {intakeQueue.map(vehicle => {
                                                    const vehicleService = typeof vehicle.service === 'object' ? vehicle.service : null;
                                                    return (
                                                    <div
                                                        key={vehicle.id}
                                                        onClick={() => setSelectedVehicleId(vehicle.id)}
                                                        style={{
                                                            padding: '12px 16px',
                                                            borderBottom: `1px solid ${theme.border}`,
                                                            cursor: 'pointer',
                                                            backgroundColor: selectedVehicleId === vehicle.id ? '#dbeafe' : 'transparent',
                                                            display: 'flex',
                                                            alignItems: 'center',
                                                            gap: '12px',
                                                            transition: 'background-color 0.15s'
                                                        }}
                                                    >
                                                        <div style={{
                                                            width: '20px',
                                                            height: '20px',
                                                            borderRadius: '50%',
                                                            border: `2px solid ${selectedVehicleId === vehicle.id ? '#3b82f6' : theme.border}`,
                                                            backgroundColor: selectedVehicleId === vehicle.id ? '#3b82f6' : 'transparent',
                                                            display: 'flex',
                                                            alignItems: 'center',
                                                            justifyContent: 'center'
                                                        }}>
                                                            {selectedVehicleId === vehicle.id && (
                                                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="3">
                                                                    <polyline points="20 6 9 17 4 12"/>
                                                                </svg>
                                                            )}
                                                        </div>
                                                        <div style={{ flex: 1 }}>
                                                            <div style={{ fontWeight: '600', color: theme.text, fontSize: '15px' }}>
                                                                {vehicle.plateNumber}
                                                            </div>
                                                            <div style={{ fontSize: '12px', color: theme.textSecondary }}>
                                                                {vehicle.customerName || vehicle.ownerName || 'Walk-in'} ‚Ä¢ {vehicle.vehicleType || 'Vehicle'}
                                                            </div>
                                                            {vehicleService && (
                                                                <div style={{ 
                                                                    fontSize: '12px', 
                                                                    color: '#059669', 
                                                                    fontWeight: '600',
                                                                    marginTop: '4px',
                                                                    display: 'flex',
                                                                    alignItems: 'center',
                                                                    gap: '6px'
                                                                }}>
                                                                    <span>üöø {vehicleService.name}</span>
                                                                    <span style={{ 
                                                                        backgroundColor: '#d1fae5', 
                                                                        padding: '2px 6px', 
                                                                        borderRadius: '4px',
                                                                        fontSize: '11px'
                                                                    }}>
                                                                        {getBrandingForReceipts().currencySymbol || 'KES'} {vehicleService.price?.toLocaleString()}
                                                                    </span>
                                                                </div>
                                                            )}
                                                        </div>
                                                        <div style={{ 
                                                            fontSize: '11px', 
                                                            color: theme.textSecondary,
                                                            textAlign: 'right'
                                                        }}>
                                                            {new Date(vehicle.timeIn).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                                                        </div>
                                                    </div>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}

                            {/* Select from Assigned Vehicles (from Intake) */}
                            {assignMode === 'assigned' && (
                                <div style={{ marginBottom: '16px' }}>
                                    {(() => {
                                        const assignedVehicles = intakeRecords.filter(r => r.status === 'in-progress' && r.assignedBayId);
                                        if (assignedVehicles.length === 0) {
                                            return (
                                                <div style={{ 
                                                    textAlign: 'center', 
                                                    padding: '30px 20px',
                                                    backgroundColor: theme.bgSecondary,
                                                    borderRadius: '2px',
                                                    border: `1px dashed ${theme.border}`
                                                }}>
                                                    <div style={{ fontSize: '36px', marginBottom: '12px' }}>üöó</div>
                                                    <p style={{ color: theme.textSecondary, marginBottom: '12px' }}>No vehicles assigned from intake</p>
                                                    <button
                                                        type="button"
                                                        onClick={() => setAssignMode('select')}
                                                        style={{
                                                            padding: '8px 16px',
                                                            borderRadius: '2px',
                                                            border: 'none',
                                                            backgroundColor: '#3b82f6',
                                                            color: 'white',
                                                            fontWeight: '500',
                                                            cursor: 'pointer',
                                                            fontSize: '13px'
                                                        }}
                                                    >
                                                        View Queue Instead
                                                    </button>
                                                </div>
                                            );
                                        }
                                        return (
                                            <div>
                                                <label style={{ display: 'block', marginBottom: '8px', fontWeight: '500', color: theme.text }}>
                                                    Vehicles Already Assigned to Bays (from Intake)
                                                </label>
                                                <div style={{ maxHeight: '220px', overflowY: 'auto', border: `1px solid ${theme.border}`, borderRadius: '2px' }}>
                                                    {assignedVehicles.map(vehicle => (
                                                        <div
                                                            key={vehicle.id}
                                                            onClick={() => setSelectedVehicleId(vehicle.id)}
                                                            style={{
                                                                padding: '12px 16px',
                                                                borderBottom: `1px solid ${theme.border}`,
                                                                cursor: 'pointer',
                                                                backgroundColor: selectedVehicleId === vehicle.id ? '#d1fae5' : 'transparent',
                                                                display: 'flex',
                                                                alignItems: 'center',
                                                                gap: '12px',
                                                                transition: 'background-color 0.15s'
                                                            }}
                                                        >
                                                            <div style={{
                                                                width: '20px',
                                                                height: '20px',
                                                                borderRadius: '50%',
                                                                border: `2px solid ${selectedVehicleId === vehicle.id ? '#10b981' : theme.border}`,
                                                                backgroundColor: selectedVehicleId === vehicle.id ? '#10b981' : 'transparent',
                                                                display: 'flex',
                                                                alignItems: 'center',
                                                                justifyContent: 'center'
                                                            }}>
                                                                {selectedVehicleId === vehicle.id && (
                                                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="3">
                                                                        <polyline points="20 6 9 17 4 12"/>
                                                                    </svg>
                                                                )}
                                                            </div>
                                                            <div style={{ flex: 1 }}>
                                                                <div style={{ fontWeight: '600', color: theme.text, fontSize: '15px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                                                                    {vehicle.plateNumber}
                                                                    <span style={{
                                                                        padding: '2px 8px',
                                                                        backgroundColor: '#dbeafe',
                                                                        color: '#1d4ed8',
                                                                        borderRadius: '10px',
                                                                        fontSize: '10px',
                                                                        fontWeight: '600'
                                                                    }}>
                                                                        {vehicle.assignedBay || 'Bay'}
                                                                    </span>
                                                                </div>
                                                                <div style={{ fontSize: '12px', color: theme.textSecondary }}>
                                                                    {vehicle.customerName || 'Walk-in'} ‚Ä¢ {typeof vehicle.service === 'object' ? vehicle.service.name : vehicle.service || 'Service'}
                                                                </div>
                                                            </div>
                                                            <div style={{ 
                                                                fontSize: '11px', 
                                                                color: theme.textSecondary,
                                                                textAlign: 'right'
                                                            }}>
                                                                {vehicle.timeIn ? new Date(vehicle.timeIn).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '-'}
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                                <div style={{ marginTop: '8px', fontSize: '12px', color: theme.textSecondary, padding: '8px', backgroundColor: '#eff6ff', borderRadius: '4px' }}>
                                                    üí° These vehicles were sent from Vehicle Intake and already have a bay assigned. Select one to view or reassign.
                                                </div>
                                            </div>
                                        );
                                    })()}
                                </div>
                            )}

                            {/* New Vehicle Form */}
                            {assignMode === 'new' && (
                                <>
                                    <div style={{ marginBottom: '16px' }}>
                                        <label style={{ display: 'block', marginBottom: '6px', fontWeight: '500', color: theme.text }}>Plate Number *</label>
                                        <input
                                            type="text"
                                            value={assignForm.plateNumber}
                                            onChange={e => setAssignForm({ ...assignForm, plateNumber: e.target.value.toUpperCase() })}
                                            placeholder="e.g., KBZ 123A"
                                            style={{
                                                width: '100%',
                                                padding: '12px',
                                                borderRadius: '2px',
                                                border: `1px solid ${theme.border}`,
                                                backgroundColor: theme.inputBg,
                                                color: theme.text,
                                                fontSize: '14px',
                                                textTransform: 'uppercase'
                                            }}
                                        />
                                    </div>
                                    <div style={{ marginBottom: '16px' }}>
                                        <label style={{ display: 'block', marginBottom: '6px', fontWeight: '500', color: theme.text }}>Customer Name</label>
                                        <input
                                            type="text"
                                            value={assignForm.customerName}
                                            onChange={e => setAssignForm({ ...assignForm, customerName: e.target.value })}
                                            placeholder="Optional"
                                            style={{
                                                width: '100%',
                                                padding: '12px',
                                                borderRadius: '2px',
                                                border: `1px solid ${theme.border}`,
                                                backgroundColor: theme.inputBg,
                                                color: theme.text,
                                                fontSize: '14px'
                                            }}
                                        />
                                    </div>
                                    <div style={{ marginBottom: '16px' }}>
                                        <label style={{ display: 'block', marginBottom: '6px', fontWeight: '500', color: theme.text }}>Vehicle Type</label>
                                        <select
                                            value={assignForm.vehicleType}
                                            onChange={e => setAssignForm({ ...assignForm, vehicleType: e.target.value })}
                                            style={{
                                                width: '100%',
                                                padding: '12px',
                                                borderRadius: '2px',
                                                border: `1px solid ${theme.border}`,
                                                backgroundColor: theme.inputBg,
                                                color: theme.text,
                                                fontSize: '14px'
                                            }}
                                        >
                                            {VEHICLE_TYPES.map(t => (
                                                <option key={t} value={t.toLowerCase()}>{t}</option>
                                            ))}
                                        </select>
                                    </div>
                                </>
                            )}

                            {/* Service Selection - only for new vehicles */}
                            {assignMode === 'new' && (
                            <div style={{ marginBottom: '16px' }}>
                                <label style={{ display: 'block', marginBottom: '6px', fontWeight: '500', color: theme.text }}>Service</label>
                                <select
                                    value={assignForm.service}
                                    onChange={e => setAssignForm({ ...assignForm, service: e.target.value })}
                                    style={{
                                        width: '100%',
                                        padding: '12px',
                                        borderRadius: '2px',
                                        border: `1px solid ${theme.border}`,
                                        backgroundColor: theme.inputBg,
                                        color: theme.text,
                                        fontSize: '14px'
                                    }}
                                >
                                    <option value="">Select a service...</option>
                                    {servicePackages.map(pkg => (
                                        <option key={pkg.id} value={pkg.id}>{pkg.name} - {getBrandingForReceipts().currencySymbol || 'KES'} {pkg.price?.toLocaleString()}</option>
                                    ))}
                                </select>
                            </div>
                            )}
                            
                            {/* Service Info Display - for queue/assigned vehicles */}
                            {(assignMode === 'select' || assignMode === 'assigned') && selectedVehicleId && (() => {
                                const selectedVehicle = assignMode === 'select' 
                                    ? intakeQueue.find(v => v.id === selectedVehicleId)
                                    : intakeRecords.find(v => v.id === selectedVehicleId);
                                const vehicleService = typeof selectedVehicle?.service === 'object' ? selectedVehicle?.service : null;
                                
                                if (!vehicleService) return null;
                                
                                return (
                                    <div style={{ 
                                        marginBottom: '16px', 
                                        padding: '16px', 
                                        backgroundColor: '#f0fdf4', 
                                        borderRadius: '4px',
                                        border: '1px solid #bbf7d0'
                                    }}>
                                        <div style={{ fontSize: '11px', color: '#166534', textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: '8px', fontWeight: '600' }}>
                                            Service from Intake
                                        </div>
                                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                            <div>
                                                <div style={{ fontSize: '16px', fontWeight: '600', color: '#166534' }}>
                                                    üöø {vehicleService.name}
                                                </div>
                                            </div>
                                            <div style={{ 
                                                fontSize: '18px', 
                                                fontWeight: '700', 
                                                color: '#166534',
                                                backgroundColor: '#dcfce7',
                                                padding: '8px 16px',
                                                borderRadius: '4px'
                                            }}>
                                                {getBrandingForReceipts().currencySymbol || 'KES'} {vehicleService.price?.toLocaleString()}
                                            </div>
                                        </div>
                                        <div style={{ fontSize: '11px', color: '#15803d', marginTop: '8px' }}>
                                            ‚úì This service will be applied automatically
                                        </div>
                                    </div>
                                );
                            })()}

                            {/* Staff Assignment (always shown) */}
                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'block', marginBottom: '6px', fontWeight: '500', color: theme.text }}>
                                    Assign to Staff <span style={{ color: '#ef4444' }}>*</span>
                                </label>
                                {staffList.length === 0 ? (
                                    <div style={{ 
                                        padding: '12px', 
                                        backgroundColor: theme.bgSecondary, 
                                        borderRadius: '2px',
                                        border: `1px dashed ${theme.border}`,
                                        textAlign: 'center',
                                        color: theme.textSecondary,
                                        fontSize: '13px'
                                    }}>
                                        No staff members available. Add staff in Staff Management.
                                    </div>
                                ) : (
                                    <select
                                        value={assignForm.assignedTo}
                                        onChange={e => setAssignForm({ ...assignForm, assignedTo: e.target.value })}
                                        required
                                        style={{
                                            width: '100%',
                                            padding: '12px',
                                            borderRadius: '2px',
                                            border: `1px solid ${assignForm.assignedTo ? theme.border : '#f59e0b'}`,
                                            backgroundColor: theme.inputBg,
                                            color: theme.text,
                                            fontSize: '14px'
                                        }}
                                    >
                                        <option value="">-- Select Staff Member --</option>
                                        {staffList.map(staff => (
                                            <option key={staff.id} value={staff.name}>
                                                {staff.name} ({staff.role})
                                            </option>
                                        ))}
                                    </select>
                                )}
                            </div>

                            {/* Action Buttons */}
                            <div style={{ display: 'flex', gap: '12px' }}>
                                <button
                                    type="button"
                                    onClick={() => setShowAssignModal(false)}
                                    style={{
                                        flex: 1,
                                        padding: '12px',
                                        borderRadius: '2px',
                                        border: `1px solid ${theme.border}`,
                                        backgroundColor: 'transparent',
                                        color: theme.text,
                                        fontWeight: '600',
                                        cursor: 'pointer'
                                    }}
                                >
                                    Cancel
                                </button>
                                <button
                                    type="submit"
                                    disabled={actionLoading || ((assignMode === 'select' || assignMode === 'assigned') && !selectedVehicleId)}
                                    style={{
                                        flex: 1,
                                        padding: '12px',
                                        borderRadius: '2px',
                                        border: 'none',
                                        backgroundColor: ((assignMode === 'select' || assignMode === 'assigned') && !selectedVehicleId) ? '#94a3b8' : '#3b82f6',
                                        color: 'white',
                                        fontWeight: '600',
                                        cursor: (actionLoading || ((assignMode === 'select' || assignMode === 'assigned') && !selectedVehicleId)) ? 'not-allowed' : 'pointer'
                                    }}
                                >
                                    {actionLoading ? 'Assigning...' : 'üöø Start Wash'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            )}

            {/* Reset Bays Modal */}
            {showResetModal && (
                <div style={{
                    position: 'fixed',
                    top: 0,
                    left: 0,
                    right: 0,
                    bottom: 0,
                    backgroundColor: 'rgba(0,0,0,0.5)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    zIndex: 1100
                }} onClick={() => setShowResetModal(false)}>
                    <div style={{
                        backgroundColor: theme.bg,
                        borderRadius: '2px',
                        width: '100%',
                        maxWidth: '420px',
                        margin: '20px',
                        boxShadow: '0 20px 40px rgba(0,0,0,0.3)'
                    }} onClick={e => e.stopPropagation()}>
                        <div style={{ padding: '24px', textAlign: 'center' }}>
                            <div style={{ 
                                fontSize: '48px', 
                                marginBottom: '16px'
                            }}>
                                üîÑ
                            </div>
                            <h3 style={{ 
                                margin: '0 0 8px 0', 
                                color: theme.text,
                                fontSize: '18px',
                                fontWeight: '600'
                            }}>
                                Reset Wash Bays
                            </h3>
                            <p style={{ 
                                margin: '0 0 24px 0', 
                                color: theme.textSecondary,
                                fontSize: '14px',
                                lineHeight: '1.6'
                            }}>
                                This will remove all existing wash bays and create 4 default bays. Any vehicles currently assigned to bays will be cleared.
                            </p>
                            <div style={{ display: 'flex', gap: '12px' }}>
                                <button
                                    onClick={() => setShowResetModal(false)}
                                    style={{
                                        flex: 1,
                                        padding: '12px 20px',
                                        borderRadius: '2px',
                                        border: `1px solid ${theme.border}`,
                                        backgroundColor: 'transparent',
                                        color: theme.text,
                                        fontWeight: '600',
                                        cursor: 'pointer',
                                        fontSize: '14px'
                                    }}
                                >
                                    Cancel
                                </button>
                                <button
                                    onClick={async () => {
                                        setShowResetModal(false);
                                        setActionLoading(true);
                                        try {
                                            const services = window.FirebaseServices;
                                            const result = await services.washBayService.resetToDefaultBays();
                                            if (result.success) {
                                                setSuccessMessage('Reset to ' + result.baysCount + ' default bays!');
                                            } else {
                                                setError('Failed to reset bays: ' + result.error);
                                            }
                                        } catch (err) {
                                            setError('Failed to reset bays');
                                        } finally {
                                            setActionLoading(false);
                                        }
                                    }}
                                    disabled={actionLoading}
                                    style={{
                                        flex: 1,
                                        padding: '12px 20px',
                                        borderRadius: '2px',
                                        border: 'none',
                                        backgroundColor: '#f59e0b',
                                        color: 'white',
                                        fontWeight: '600',
                                        cursor: actionLoading ? 'not-allowed' : 'pointer',
                                        fontSize: '14px'
                                    }}
                                >
                                    {actionLoading ? 'Resetting...' : 'Reset Bays'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* Confirmation Modal */}
            {showConfirmModal && confirmAction && (
                <div style={{
                    position: 'fixed',
                    top: 0,
                    left: 0,
                    right: 0,
                    bottom: 0,
                    backgroundColor: 'rgba(0,0,0,0.5)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    zIndex: 1100
                }} onClick={() => { setShowConfirmModal(false); setConfirmAction(null); }}>
                    <div style={{
                        backgroundColor: theme.bg,
                        borderRadius: '2px',
                        width: '100%',
                        maxWidth: '400px',
                        margin: '20px',
                        boxShadow: '0 20px 40px rgba(0,0,0,0.3)'
                    }} onClick={e => e.stopPropagation()}>
                        <div style={{ padding: '24px', textAlign: 'center' }}>
                            <div style={{ 
                                fontSize: '48px', 
                                marginBottom: '16px'
                            }}>
                                {confirmAction.type === 'delete' ? 'üóëÔ∏è' : confirmAction.type === 'complete' ? '‚úÖ' : 'üîß'}
                            </div>
                            <h3 style={{ 
                                margin: '0 0 8px 0', 
                                color: theme.text,
                                fontSize: '18px',
                                fontWeight: '600'
                            }}>
                                {confirmAction.title}
                            </h3>
                            <p style={{ 
                                margin: '0 0 24px 0', 
                                color: theme.textSecondary,
                                fontSize: '14px',
                                lineHeight: '1.5'
                            }}>
                                {confirmAction.message}
                            </p>
                            <div style={{ display: 'flex', gap: '12px' }}>
                                <button
                                    onClick={() => { setShowConfirmModal(false); setConfirmAction(null); }}
                                    style={{
                                        flex: 1,
                                        padding: '12px 20px',
                                        borderRadius: '2px',
                                        border: `1px solid ${theme.border}`,
                                        backgroundColor: 'transparent',
                                        color: theme.text,
                                        fontWeight: '600',
                                        cursor: 'pointer',
                                        fontSize: '14px'
                                    }}
                                >
                                    Cancel
                                </button>
                                <button
                                    onClick={handleConfirmAction}
                                    disabled={actionLoading}
                                    style={{
                                        flex: 1,
                                        padding: '12px 20px',
                                        borderRadius: '2px',
                                        border: 'none',
                                        backgroundColor: confirmAction.confirmColor || '#3b82f6',
                                        color: 'white',
                                        fontWeight: '600',
                                        cursor: actionLoading ? 'not-allowed' : 'pointer',
                                        fontSize: '14px'
                                    }}
                                >
                                    {actionLoading ? 'Please wait...' : confirmAction.confirmText}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* Maintenance Modal */}
            {showMaintenanceModal && selectedBay && (
                <div style={{
                    position: 'fixed',
                    top: 0,
                    left: 0,
                    right: 0,
                    bottom: 0,
                    backgroundColor: 'rgba(0,0,0,0.5)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    zIndex: 1100
                }} onClick={() => setShowMaintenanceModal(false)}>
                    <div style={{
                        backgroundColor: theme.bg,
                        borderRadius: '2px',
                        width: '100%',
                        maxWidth: '450px',
                        margin: '20px',
                        boxShadow: '0 20px 40px rgba(0,0,0,0.3)'
                    }} onClick={e => e.stopPropagation()}>
                        <div style={{ 
                            padding: '20px', 
                            borderBottom: `1px solid ${theme.border}`,
                            display: 'flex',
                            alignItems: 'center',
                            gap: '12px'
                        }}>
                            <div style={{ 
                                width: '40px', 
                                height: '40px', 
                                borderRadius: '2px',
                                backgroundColor: '#fef3c7',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                fontSize: '20px'
                            }}>
                                üîß
                            </div>
                            <div>
                                <h3 style={{ margin: 0, color: theme.text, fontSize: '16px' }}>
                                    Set Maintenance Mode
                                </h3>
                                <p style={{ margin: 0, color: theme.textSecondary, fontSize: '13px' }}>
                                    {selectedBay.name}
                                </p>
                            </div>
                        </div>
                        <div style={{ padding: '20px' }}>
                            <label style={{ 
                                display: 'block', 
                                marginBottom: '8px', 
                                fontWeight: '500', 
                                color: theme.text,
                                fontSize: '14px'
                            }}>
                                Maintenance Note (optional)
                            </label>
                            <textarea
                                value={maintenanceNote}
                                onChange={e => setMaintenanceNote(e.target.value)}
                                placeholder="e.g., Water pump repair, Floor cleaning..."
                                rows={3}
                                style={{
                                    width: '100%',
                                    padding: '12px',
                                    borderRadius: '2px',
                                    border: `1px solid ${theme.border}`,
                                    backgroundColor: theme.inputBg,
                                    color: theme.text,
                                    fontSize: '14px',
                                    resize: 'vertical',
                                    fontFamily: 'inherit'
                                }}
                            />
                            <div style={{ display: 'flex', gap: '12px', marginTop: '20px' }}>
                                <button
                                    onClick={() => setShowMaintenanceModal(false)}
                                    style={{
                                        flex: 1,
                                        padding: '12px 20px',
                                        borderRadius: '2px',
                                        border: `1px solid ${theme.border}`,
                                        backgroundColor: 'transparent',
                                        color: theme.text,
                                        fontWeight: '600',
                                        cursor: 'pointer',
                                        fontSize: '14px'
                                    }}
                                >
                                    Cancel
                                </button>
                                <button
                                    onClick={executeSetMaintenance}
                                    disabled={actionLoading}
                                    style={{
                                        flex: 1,
                                        padding: '12px 20px',
                                        borderRadius: '2px',
                                        border: 'none',
                                        backgroundColor: '#f59e0b',
                                        color: 'white',
                                        fontWeight: '600',
                                        cursor: actionLoading ? 'not-allowed' : 'pointer',
                                        fontSize: '14px'
                                    }}
                                >
                                    {actionLoading ? 'Saving...' : 'üîß Set Maintenance'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* Success Toast */}
            {successMessage && (
                <div style={{
                    position: 'fixed',
                    bottom: '24px',
                    right: '24px',
                    backgroundColor: '#10b981',
                    color: 'white',
                    padding: '16px 24px',
                    borderRadius: '2px',
                    boxShadow: '0 4px 20px rgba(16, 185, 129, 0.3)',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '12px',
                    zIndex: 1200,
                    animation: 'slideInRight 0.3s ease'
                }}>
                    <span style={{ fontSize: '20px' }}>‚úì</span>
                    <span style={{ fontWeight: '500' }}>{successMessage}</span>
                </div>
            )}

            {/* Error Toast */}
            {error && (
                <div style={{
                    position: 'fixed',
                    bottom: '24px',
                    right: '24px',
                    backgroundColor: '#ef4444',
                    color: 'white',
                    padding: '16px 24px',
                    borderRadius: '2px',
                    boxShadow: '0 4px 20px rgba(239, 68, 68, 0.3)',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '12px',
                    zIndex: 1200,
                    cursor: 'pointer'
                }} onClick={() => setError(null)}>
                    <span style={{ fontSize: '20px' }}>‚ö†Ô∏è</span>
                    <span style={{ fontWeight: '500' }}>{error}</span>
                    <span style={{ marginLeft: '8px', opacity: 0.7 }}>‚úï</span>
                </div>
            )}
        </div>
    );
}

// Wrapper component with Error Boundary
function WashBays() {
    try {
        return (
            <WashBaysErrorBoundary>
                <WashBaysContent />
            </WashBaysErrorBoundary>
        );
    } catch (err) {
        console.error('WashBays wrapper error:', err);
        return (
            <div style={{ padding: '40px', textAlign: 'center', backgroundColor: '#fee2e2' }}>
                <h3 style={{ color: '#dc2626' }}>Failed to load Wash Bays</h3>
                <p style={{ color: '#64748b' }}>{err.message}</p>
                <button onClick={() => window.location.reload()} style={{ marginTop: '16px', padding: '10px 20px', background: '#3b82f6', color: 'white', border: 'none', borderRadius: '4px', cursor: 'pointer' }}>Reload</button>
            </div>
        );
    }
}

// Dashboard Component - Real-time Firebase Integration
function Dashboard({ onModuleClick }) {
    const [searchQuery, setSearchQuery] = useState('');
    const [showSearchResults, setShowSearchResults] = useState(false);
    const [refreshKey, setRefreshKey] = useState(0);
    const [vehicles, setVehicles] = useState([]);
    const [queue, setQueue] = useState([]);
    const [bays, setBays] = useState([]);
    const [garageJobs, setGarageJobs] = useState([]);
    const [invoices, setInvoices] = useState([]);
    const [customers, setCustomers] = useState([]);
    const [inventory, setInventory] = useState([]);
    const [fleet, setFleet] = useState([]);
    const [expenses, setExpenses] = useState([]);
    const [equipment, setEquipment] = useState([]);
    const [staff, setStaff] = useState([]);
    const [washHistory, setWashHistory] = useState([]);
    const [activities, setActivities] = useState([]);
    const [loading, setLoading] = useState(true);

    // Subscribe to Firebase data for real-time stats
    useEffect(() => {
        let cancelled = false;
        
        const waitForServices = async () => {
            let services = window.FirebaseServices;
            let attempts = 0;
            while (!services && attempts < 20 && !cancelled) {
                await new Promise(resolve => setTimeout(resolve, 50));
                services = window.FirebaseServices;
                attempts++;
            }
            if (services && !cancelled) initializeSubscriptions();
        };
        
        if (window.FirebaseServices) {
            initializeSubscriptions();
        } else {
            waitForServices();
        }
        
        function initializeSubscriptions() {
            const svc = window.FirebaseServices;
            let unsubRecords, unsubQueue, unsubBays, unsubGarage, unsubInvoices, unsubCustomers, unsubInventory, unsubFleet, unsubExpenses, unsubEquipment, unsubStaff;
            
            // Subscribe to vehicle records (Firestore)
            if (svc.intakeRecordsService) {
                unsubRecords = svc.intakeRecordsService.subscribeToRecords(
                    (records) => {
                        console.log('Dashboard: Records updated', records.length);
                        setVehicles(records);
                        setLoading(false);
                    },
                    (err) => console.error('Dashboard records error:', err)
                );
            }
            
            // Subscribe to queue (Realtime DB)
            if (svc.intakeQueueService) {
                unsubQueue = svc.intakeQueueService.subscribeToQueue(
                    (queueData) => {
                        console.log('Dashboard: Queue updated', queueData.length);
                        setQueue(queueData);
                    },
                    (err) => console.error('Dashboard queue error:', err)
                );
            }
            
            // Subscribe to bays (Realtime DB - from Wash Bay module)
            if (svc.washBayService?.subscribeToBays) {
                unsubBays = svc.washBayService.subscribeToBays(
                    (baysData) => {
                        console.log('Dashboard: Wash Bays updated', baysData.length);
                        setBays(baysData);
                    }
                );
            }

            // Subscribe to wash history
            let unsubWashHistory = null;
            if (svc.washBayService?.subscribeToHistory) {
                unsubWashHistory = svc.washBayService.subscribeToHistory(
                    (historyData) => {
                        console.log('Dashboard: Wash History updated', historyData.length);
                        setWashHistory(historyData);
                    }
                );
            }
            
            // Subscribe to garage jobs (Firestore)
            if (svc.garageJobsService) {
                unsubGarage = svc.garageJobsService.subscribeToJobs(
                    (jobs) => {
                        console.log('Dashboard: Garage jobs updated', jobs.length);
                        setGarageJobs(jobs);
                    },
                    (err) => console.error('Dashboard garage error:', err)
                );
            }

            // Subscribe to billing/invoices for revenue
            if (svc.billingService?.subscribeToInvoices) {
                unsubInvoices = svc.billingService.subscribeToInvoices((invoiceData) => {
                    console.log('Dashboard: Invoices updated', invoiceData.length);
                    setInvoices(invoiceData);
                });
            }

            // Subscribe to customers
            if (svc.customerService?.subscribeToCustomers) {
                unsubCustomers = svc.customerService.subscribeToCustomers((customerData) => {
                    console.log('Dashboard: Customers updated', customerData.length);
                    setCustomers(customerData);
                });
            }

            // Subscribe to inventory
            if (svc.inventoryService?.subscribeToItems) {
                unsubInventory = svc.inventoryService.subscribeToItems((items) => {
                    console.log('Dashboard: Inventory updated', items.length);
                    setInventory(items);
                });
            }

            // Subscribe to fleet
            if (svc.fleetService?.subscribeToAccounts) {
                unsubFleet = svc.fleetService.subscribeToAccounts((accounts) => {
                    console.log('Dashboard: Fleet updated', accounts.length);
                    setFleet(accounts);
                });
            }

            // Subscribe to expenses
            if (svc.expensesService?.subscribeToExpenses) {
                unsubExpenses = svc.expensesService.subscribeToExpenses((expenseData) => {
                    console.log('Dashboard: Expenses updated', expenseData.length);
                    setExpenses(expenseData);
                });
            }

            // Subscribe to equipment
            if (svc.equipmentService?.subscribeToEquipment) {
                unsubEquipment = svc.equipmentService.subscribeToEquipment((equipmentData) => {
                    console.log('Dashboard: Equipment updated', equipmentData.length);
                    setEquipment(equipmentData);
                });
            }

            // Subscribe to staff
            if (svc.staffService?.subscribeToStaff) {
                unsubStaff = svc.staffService.subscribeToStaff((staffData) => {
                    console.log('Dashboard: Staff updated', staffData.length);
                    setStaff(staffData);
                });
            }

            // Subscribe to activities for recent activity feed
            let unsubActivities = null;
            if (svc.activityService?.subscribeToActivities) {
                unsubActivities = svc.activityService.subscribeToActivities(
                    (activityData) => {
                        console.log('Dashboard: Activities updated', activityData.length);
                        setActivities(activityData);
                    },
                    50 // Get more activities to filter for today
                );
            }
            
            return () => {
                if (unsubRecords) unsubRecords();
                if (unsubQueue) unsubQueue();
                if (unsubBays) unsubBays();
                if (unsubGarage) unsubGarage();
                if (unsubInvoices) unsubInvoices();
                if (unsubCustomers) unsubCustomers();
                if (unsubInventory) unsubInventory();
                if (unsubFleet) unsubFleet();
                if (unsubExpenses) unsubExpenses();
                if (unsubEquipment) unsubEquipment();
                if (unsubStaff) unsubStaff();
                if (unsubWashHistory) unsubWashHistory();
                if (unsubActivities) unsubActivities();
            };
        }
    }, [refreshKey]);

    // Calculate real-time stats
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    const todayVehicles = vehicles.filter(v => {
        const vDate = new Date(v.timeIn || v.createdAt);
        vDate.setHours(0, 0, 0, 0);
        return vDate.getTime() === today.getTime();
    });
    
    const completedToday = todayVehicles.filter(v => v.status === 'completed');
    
    // Today's wash breakdown by category
    const todayCars = todayVehicles.filter(v => v.category === 'vehicle' || (!v.category && !['carpet', 'motorbike', 'bicycle', 'other'].includes(v.category))).length;
    const todayCarpets = todayVehicles.filter(v => v.category === 'carpet').length;
    const todayMotorbikes = todayVehicles.filter(v => v.category === 'motorbike').length;
    const todayOther = todayVehicles.filter(v => v.category === 'bicycle' || v.category === 'other').length;
    
    // First-time washes (items with plate numbers that only appear once in all vehicles)
    const todayFirstTime = todayVehicles.filter(v => {
        if (!v.plateNumber) return true; // Non-vehicle items (carpets, etc.) count as first time
        const normalizedPlate = v.plateNumber.toUpperCase().replace(/\s+/g, ' ').trim();
        // Count how many times this plate appears in all vehicles
        const visitCount = vehicles.filter(veh => 
            veh.plateNumber && veh.plateNumber.toUpperCase().replace(/\s+/g, ' ').trim() === normalizedPlate
        ).length;
        return visitCount <= 1; // First time if only appears once (today's entry)
    }).length;
    
    // Calculate revenue from BILLING MODULE only
    const todayInvoices = invoices.filter(inv => {
        const invDate = new Date(inv.createdAt || inv.date);
        invDate.setHours(0, 0, 0, 0);
        return invDate.getTime() === today.getTime();
    });
    
    const totalRevenueToday = todayInvoices.reduce((sum, inv) => sum + (inv.totalAmount || inv.total || inv.amount || 0), 0);
    const paidRevenueToday = todayInvoices.filter(inv => inv.paymentStatus === 'paid').reduce((sum, inv) => sum + (inv.totalAmount || inv.total || inv.amount || 0), 0);
    const pendingRevenueToday = totalRevenueToday - paidRevenueToday;
    
    // Separate wash and garage revenue
    const washRevenueToday = todayInvoices.filter(inv => inv.source === 'wash').reduce((sum, inv) => sum + (inv.totalAmount || inv.total || inv.amount || 0), 0);
    const garageRevenueToday = todayInvoices.filter(inv => inv.source === 'garage').reduce((sum, inv) => sum + (inv.totalAmount || inv.total || inv.amount || 0), 0);
    const parkingRevenueToday = todayInvoices.filter(inv => inv.source === 'parking').reduce((sum, inv) => sum + (inv.totalAmount || inv.total || inv.amount || 0), 0);
    
    const inProgressCount = vehicles.filter(v => v.status === 'in-progress').length;
    
    // Real-time wash bays stats
    const totalBays = bays.length;
    const occupiedBays = bays.filter(b => b.status === 'occupied').length;
    const availableBays = bays.filter(b => b.status === 'available').length;
    const maintenanceBays = bays.filter(b => b.status === 'maintenance').length;
    
    // Today's date string for comparisons
    const todayStr = today.toISOString().split('T')[0];
    
    // Wash history stats - count completed washes today from real-time wash bay history
    const completedWashesToday = React.useMemo(() => {
        const todayStart = new Date();
        todayStart.setHours(0, 0, 0, 0);
        const todayEnd = new Date();
        todayEnd.setHours(23, 59, 59, 999);
        
        return washHistory.filter(h => {
            // Only count completed actions
            if (h.action !== 'completed') return false;
            
            // Use endTime (completion time) or timestamp
            const completionTime = h.endTime || h.timestamp;
            if (!completionTime) return false;
            
            const completionDate = new Date(completionTime);
            return completionDate >= todayStart && completionDate <= todayEnd;
        }).length;
    }, [washHistory]);
    const totalWashHistory = washHistory.filter(h => h.action === 'completed').length;
    
    // Real-time inventory stats
    const lowStockItems = inventory.filter(i => (i.quantity || 0) <= (i.minStock || i.reorderLevel || 5)).length;
    const inventoryValue = inventory.reduce((s, i) => s + ((i.quantity || 0) * (i.unitCost || i.cost || 0)), 0);
    
    // Real-time fleet stats
    const totalFleetBalance = fleet.reduce((s, f) => s + (f.balance || 0), 0);
    const fleetVehicles = fleet.reduce((s, f) => s + (f.vehicles?.length || 0), 0);
    
    // Garage jobs stats - detailed breakdown
    const garageJobsQueue = garageJobs.filter(j => j.status === 'pending' || j.status === 'queued').length;
    const garageJobsInProgress = garageJobs.filter(j => j.status === 'in-progress').length;
    const garageJobsCompleted = garageJobs.filter(j => j.status === 'completed').length;
    const activeGarageJobs = garageJobsQueue + garageJobsInProgress;

    // Real-time expenses stats
    const expensesToday = expenses.filter(e => e.date === todayStr).reduce((sum, e) => sum + (e.amount || 0), 0);
    const totalExpenses = expenses.reduce((sum, e) => sum + (e.amount || 0), 0);

    // Real-time equipment stats
    const totalEquipment = equipment.length;
    const operationalEquipment = equipment.filter(e => e.status === 'operational').length;
    const maintenanceEquipment = equipment.filter(e => e.status === 'maintenance' || e.status === 'repair').length;

    // Real-time staff stats
    const totalStaff = staff.length;
    const activeStaff = staff.filter(s => s.status === 'active' || s.isActive === true || !s.status).length;
    
    const handleRefresh = () => {
        console.log('Refreshing dashboard data...');
        setLoading(true);
        setRefreshKey(prev => prev + 1); // Trigger re-subscription
    };
    
    const handleSearch = (e) => {
        const query = e.target.value;
        setSearchQuery(query);
        setShowSearchResults(query.trim().length > 0);
    };

    // Global search function
    const getSearchResults = () => {
        if (!searchQuery.trim()) return { vehicles: [], customers: [], invoices: [], staff: [], activities: [] };
        const q = searchQuery.toLowerCase();
        
        const matchedVehicles = vehicles.filter(v => 
            (v.plateNumber || v.registrationNumber || '').toLowerCase().includes(q) ||
            (v.ownerName || v.customerName || '').toLowerCase().includes(q) ||
            (v.vehicleType || v.type || '').toLowerCase().includes(q) ||
            (v.itemType || '').toLowerCase().includes(q) ||
            (v.category || '').toLowerCase().includes(q)
        ).slice(0, 5);
        
        const matchedCustomers = customers.filter(c => 
            (c.name || '').toLowerCase().includes(q) ||
            (c.phone || '').toLowerCase().includes(q) ||
            (c.email || '').toLowerCase().includes(q) ||
            (c.company || '').toLowerCase().includes(q)
        ).slice(0, 5);
        
        const matchedInvoices = invoices.filter(i => 
            (i.invoiceNumber || i.id || '').toLowerCase().includes(q) ||
            (i.customerName || '').toLowerCase().includes(q) ||
            (i.plateNumber || '').toLowerCase().includes(q)
        ).slice(0, 5);

        const matchedStaff = staff.filter(s => 
            (s.name || '').toLowerCase().includes(q) ||
            (s.role || '').toLowerCase().includes(q) ||
            (s.phone || '').toLowerCase().includes(q)
        ).slice(0, 5);

        const matchedActivities = activities.filter(a => 
            (a.description || '').toLowerCase().includes(q) ||
            (a.type || '').toLowerCase().includes(q) ||
            (a.user || '').toLowerCase().includes(q)
        ).slice(0, 5);
        
        return { 
            vehicles: matchedVehicles, 
            customers: matchedCustomers, 
            invoices: matchedInvoices,
            staff: matchedStaff,
            activities: matchedActivities
        };
    };

    const searchResults = getSearchResults();
    const hasResults = Object.values(searchResults).some(arr => arr.length > 0);
    const totalResults = Object.values(searchResults).reduce((sum, arr) => sum + arr.length, 0);
    
    const stats = [
        {
            title: 'Today\'s Wash',
            value: todayVehicles.length.toString(),
            subValues: [
                { label: 'üöó Cars', value: todayCars, color: '#3b82f6' },
                { label: 'üßπ Carpets', value: todayCarpets, color: '#8b5cf6' },
                { label: 'üèçÔ∏è Bikes', value: todayMotorbikes, color: '#f59e0b' },
                { label: 'üÜï First Time', value: todayFirstTime, color: '#10b981' }
            ],
            icon: <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 16H9m10 0h3l-3.5-7a2 2 0 0 0-1.9-1.3H7.4a2 2 0 0 0-1.9 1.3L2 16h3m0 0a2 2 0 1 0 4 0m4 0a2 2 0 1 0 4 0"/></svg>,
            color: '#3b82f6'
        },
        {
            title: 'Wash Count',
            value: vehicles.length.toString(),
            icon: <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#6366f1" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>,
            color: '#6366f1'
        },
        {
            title: 'Wash Bays',
            value: totalBays.toString(),
            subValues: [
                { label: 'In Use', value: occupiedBays, color: '#3b82f6' },
                { label: 'Active', value: availableBays, color: '#10b981' },
                { label: 'Maintenance', value: maintenanceBays, color: '#f59e0b' },
                { label: 'Completed Today', value: completedWashesToday, color: '#6366f1' }
            ],
            icon: <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#10b981" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/></svg>,
            color: '#10b981'
        },
        {
            title: 'In Queue',
            value: queue.length.toString(),
            icon: <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
            color: '#f59e0b'
        },
        {
            title: 'Revenue Today',
            value: `${getBrandingForReceipts().currencySymbol || 'KES'} ${totalRevenueToday.toLocaleString()}`,
            subValues: [
                { label: 'Paid', value: paidRevenueToday, color: '#10b981' },
                { label: 'Pending', value: pendingRevenueToday, color: '#f59e0b' },
                { label: 'Wash', value: washRevenueToday, color: '#3b82f6' },
                { label: 'Garage', value: garageRevenueToday, color: '#8b5cf6' },
                { label: 'Parking', value: parkingRevenueToday, color: '#f97316' }
            ],
            icon: <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#10b981" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>,
            color: '#10b981'
        },
        {
            title: 'Expenses Today',
            value: `${getBrandingForReceipts().currencySymbol || 'KES'} ${expensesToday.toLocaleString()}`,
            icon: <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#ef4444" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>,
            color: '#ef4444'
        },
        {
            title: 'Customers',
            value: customers.length.toString(),
            icon: <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#8b5cf6" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
            color: '#8b5cf6'
        },
        {
            title: 'Garage Jobs',
            value: garageJobs.length.toString(),
            subValues: [
                { label: 'Queue', value: garageJobsQueue, color: '#f59e0b' },
                { label: 'In Progress', value: garageJobsInProgress, color: '#3b82f6' },
                { label: 'Completed', value: garageJobsCompleted, color: '#10b981' }
            ],
            icon: <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#f97316" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>,
            color: '#f97316'
        },
        {
            title: 'Equipment',
            value: `${operationalEquipment}/${totalEquipment}`,
            icon: <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#0ea5e9" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>,
            color: '#0ea5e9'
        },
        {
            title: 'Active Staff',
            value: `${activeStaff}/${totalStaff}`,
            icon: <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#14b8a6" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
            color: '#14b8a6'
        },
        {
            title: 'Low Stock',
            value: lowStockItems.toString(),
            icon: <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke={lowStockItems > 0 ? "#ef4444" : "#10b981"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/></svg>,
            color: lowStockItems > 0 ? '#ef4444' : '#10b981'
        },
        {
            title: 'Fleet Balance',
            value: `${getBrandingForReceipts().currencySymbol || 'KES'} ${totalFleetBalance.toLocaleString()}`,
            icon: <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#06b6d4" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="1" y="3" width="15" height="13"/><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg>,
            color: '#06b6d4'
        }
    ];

    const quickAccess = [
        { 
            id: 'vehicle-intake', 
            label: 'Vehicle Intake', 
            icon: Icons.car,
            color: '#3b82f6'
        },
        { 
            id: 'wash-bays', 
            label: 'Wash Bays', 
            icon: Icons.droplet,
            color: '#10b981'
        },
        { 
            id: 'billing', 
            label: 'Billing', 
            icon: Icons.creditCard,
            color: '#8b5cf6'
        },
        { 
            id: 'customers', 
            label: 'Customers', 
            icon: Icons.users,
            color: '#f59e0b'
        },
        { 
            id: 'reports', 
            label: 'Reports', 
            icon: Icons.trendingUp,
            color: '#ec4899'
        },
        { 
            id: 'settings', 
            label: 'Settings', 
            icon: Icons.settings,
            color: '#6366f1'
        }
    ];

    return (
        <div className="dashboard">
            <div className="dashboard-toolbar">
                <div className="search-bar-container" style={{ position: 'relative' }}>
                    <svg className="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="m21 21-4.35-4.35"/>
                    </svg>
                    <input 
                        type="text" 
                        className="search-bar" 
                        placeholder="Search vehicles, customers, invoices, staff..."
                        value={searchQuery}
                        onChange={handleSearch}
                        onFocus={() => searchQuery && setShowSearchResults(true)}
                    />
                    {searchQuery && (
                        <button className="search-clear" onClick={() => { setSearchQuery(''); setShowSearchResults(false); }}>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                <line x1="18" y1="6" x2="6" y2="18"/>
                                <line x1="6" y1="6" x2="18" y2="18"/>
                            </svg>
                        </button>
                    )}
                    
                    {/* Global Search Results Dropdown */}
                    {showSearchResults && searchQuery && (
                        <div style={{
                            position: 'absolute',
                            top: '100%',
                            left: 0,
                            right: 0,
                            marginTop: '8px',
                            background: 'var(--bg-primary, #fff)',
                            border: '1px solid var(--border-color, #e2e8f0)',
                            borderRadius: '0',
                            boxShadow: '0 10px 40px rgba(0,0,0,0.15)',
                            zIndex: 1000,
                            maxHeight: '450px',
                            overflowY: 'auto'
                        }}>
                            {/* Header */}
                            <div style={{ 
                                padding: '12px 16px', 
                                borderBottom: '1px solid var(--border-color, #e2e8f0)',
                                display: 'flex',
                                justifyContent: 'space-between',
                                alignItems: 'center',
                                background: 'var(--bg-secondary, #f8fafc)'
                            }}>
                                <span style={{ fontSize: '13px', fontWeight: '600', color: 'var(--text-primary)' }}>
                                    {hasResults ? `${totalResults} results found` : 'No results'}
                                </span>
                                <button 
                                    onClick={() => setShowSearchResults(false)}
                                    style={{ background: 'none', border: 'none', cursor: 'pointer', padding: '4px', color: 'var(--text-secondary)' }}
                                >
                                    ‚úï
                                </button>
                            </div>
                            
                            {!hasResults ? (
                                <div style={{ padding: '24px', textAlign: 'center', color: 'var(--text-secondary)' }}>
                                    <div style={{ fontSize: '32px', marginBottom: '8px' }}>üîç</div>
                                    <div>No matches found for "{searchQuery}"</div>
                                </div>
                            ) : (
                                <>
                                    {/* Vehicles */}
                                    {searchResults.vehicles.length > 0 && (
                                        <div style={{ borderBottom: '1px solid var(--border-color, #e2e8f0)' }}>
                                            <div style={{ padding: '10px 16px', fontSize: '11px', fontWeight: '600', color: 'var(--text-secondary)', textTransform: 'uppercase', background: 'var(--bg-secondary, #f8fafc)' }}>
                                                üöó Vehicles ({searchResults.vehicles.length})
                                            </div>
                                            {searchResults.vehicles.map((v, i) => (
                                                <div key={i} onClick={() => { onModuleClick('vehicle-intake'); setShowSearchResults(false); }} style={{ 
                                                    padding: '12px 16px', 
                                                    cursor: 'pointer',
                                                    borderBottom: i < searchResults.vehicles.length - 1 ? '1px solid var(--border-color, #e2e8f0)' : 'none',
                                                    display: 'flex',
                                                    justifyContent: 'space-between',
                                                    alignItems: 'center'
                                                }} className="search-result-item">
                                                    <div>
                                                        <div style={{ fontWeight: '600', fontSize: '14px' }}>{v.plateNumber || v.registrationNumber || v.itemType || 'N/A'}</div>
                                                        <div style={{ fontSize: '12px', color: 'var(--text-secondary)' }}>{v.ownerName || v.customerName || 'Unknown'} ‚Ä¢ {v.category || v.vehicleType || 'Vehicle'}</div>
                                                    </div>
                                                    <span style={{ 
                                                        padding: '4px 8px', 
                                                        fontSize: '11px', 
                                                        borderRadius: '0', 
                                                        background: v.status === 'completed' ? '#d1fae5' : v.status === 'in-progress' ? '#dbeafe' : '#fef3c7',
                                                        color: v.status === 'completed' ? '#065f46' : v.status === 'in-progress' ? '#1e40af' : '#92400e'
                                                    }}>
                                                        {v.status || 'queued'}
                                                    </span>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                    
                                    {/* Customers */}
                                    {searchResults.customers.length > 0 && (
                                        <div style={{ borderBottom: '1px solid var(--border-color, #e2e8f0)' }}>
                                            <div style={{ padding: '10px 16px', fontSize: '11px', fontWeight: '600', color: 'var(--text-secondary)', textTransform: 'uppercase', background: 'var(--bg-secondary, #f8fafc)' }}>
                                                üë§ Customers ({searchResults.customers.length})
                                            </div>
                                            {searchResults.customers.map((c, i) => (
                                                <div key={i} onClick={() => { onModuleClick('customers'); setShowSearchResults(false); }} style={{ 
                                                    padding: '12px 16px', 
                                                    cursor: 'pointer',
                                                    borderBottom: i < searchResults.customers.length - 1 ? '1px solid var(--border-color, #e2e8f0)' : 'none',
                                                    display: 'flex',
                                                    justifyContent: 'space-between',
                                                    alignItems: 'center'
                                                }} className="search-result-item">
                                                    <div>
                                                        <div style={{ fontWeight: '600', fontSize: '14px' }}>{c.name}</div>
                                                        <div style={{ fontSize: '12px', color: 'var(--text-secondary)' }}>{c.phone || c.email || 'No contact'}</div>
                                                    </div>
                                                    {c.company && <span style={{ fontSize: '12px', color: 'var(--text-secondary)' }}>{c.company}</span>}
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                    
                                    {/* Invoices */}
                                    {searchResults.invoices.length > 0 && (
                                        <div style={{ borderBottom: '1px solid var(--border-color, #e2e8f0)' }}>
                                            <div style={{ padding: '10px 16px', fontSize: '11px', fontWeight: '600', color: 'var(--text-secondary)', textTransform: 'uppercase', background: 'var(--bg-secondary, #f8fafc)' }}>
                                                üí≥ Invoices ({searchResults.invoices.length})
                                            </div>
                                            {searchResults.invoices.map((inv, i) => (
                                                <div key={i} onClick={() => { onModuleClick('billing'); setShowSearchResults(false); }} style={{ 
                                                    padding: '12px 16px', 
                                                    cursor: 'pointer',
                                                    borderBottom: i < searchResults.invoices.length - 1 ? '1px solid var(--border-color, #e2e8f0)' : 'none',
                                                    display: 'flex',
                                                    justifyContent: 'space-between',
                                                    alignItems: 'center'
                                                }} className="search-result-item">
                                                    <div>
                                                        <div style={{ fontWeight: '600', fontSize: '14px' }}>{inv.invoiceNumber || inv.id}</div>
                                                        <div style={{ fontSize: '12px', color: 'var(--text-secondary)' }}>{inv.customerName || inv.plateNumber || 'N/A'}</div>
                                                    </div>
                                                    <div style={{ textAlign: 'right' }}>
                                                        <div style={{ fontWeight: '600', color: '#10b981' }}>{getBrandingForReceipts().currencySymbol || 'KES'} {(inv.totalAmount || inv.total || 0).toLocaleString()}</div>
                                                        <span style={{ 
                                                            padding: '2px 6px', 
                                                            fontSize: '10px', 
                                                            borderRadius: '0', 
                                                            background: inv.paymentStatus === 'paid' ? '#d1fae5' : '#fef3c7',
                                                            color: inv.paymentStatus === 'paid' ? '#065f46' : '#92400e'
                                                        }}>
                                                            {inv.paymentStatus || 'pending'}
                                                        </span>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                    
                                    {/* Staff */}
                                    {searchResults.staff.length > 0 && (
                                        <div style={{ borderBottom: '1px solid var(--border-color, #e2e8f0)' }}>
                                            <div style={{ padding: '10px 16px', fontSize: '11px', fontWeight: '600', color: 'var(--text-secondary)', textTransform: 'uppercase', background: 'var(--bg-secondary, #f8fafc)' }}>
                                                üë• Staff ({searchResults.staff.length})
                                            </div>
                                            {searchResults.staff.map((s, i) => (
                                                <div key={i} onClick={() => { onModuleClick('staff'); setShowSearchResults(false); }} style={{ 
                                                    padding: '12px 16px', 
                                                    cursor: 'pointer',
                                                    borderBottom: i < searchResults.staff.length - 1 ? '1px solid var(--border-color, #e2e8f0)' : 'none',
                                                    display: 'flex',
                                                    justifyContent: 'space-between',
                                                    alignItems: 'center'
                                                }} className="search-result-item">
                                                    <div>
                                                        <div style={{ fontWeight: '600', fontSize: '14px' }}>{s.name}</div>
                                                        <div style={{ fontSize: '12px', color: 'var(--text-secondary)' }}>{s.role || 'Staff'} ‚Ä¢ {s.phone || 'No phone'}</div>
                                                    </div>
                                                    <span style={{ 
                                                        padding: '4px 8px', 
                                                        fontSize: '11px', 
                                                        borderRadius: '0', 
                                                        background: s.status === 'active' || !s.status ? '#d1fae5' : '#fee2e2',
                                                        color: s.status === 'active' || !s.status ? '#065f46' : '#991b1b'
                                                    }}>
                                                        {s.status || 'active'}
                                                    </span>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                    
                                    {/* Activities */}
                                    {searchResults.activities.length > 0 && (
                                        <div>
                                            <div style={{ padding: '10px 16px', fontSize: '11px', fontWeight: '600', color: 'var(--text-secondary)', textTransform: 'uppercase', background: 'var(--bg-secondary, #f8fafc)' }}>
                                                üìã Activities ({searchResults.activities.length})
                                            </div>
                                            {searchResults.activities.map((a, i) => (
                                                <div key={i} onClick={() => { onModuleClick('activities'); setShowSearchResults(false); }} style={{ 
                                                    padding: '12px 16px', 
                                                    cursor: 'pointer',
                                                    borderBottom: i < searchResults.activities.length - 1 ? '1px solid var(--border-color, #e2e8f0)' : 'none',
                                                    display: 'flex',
                                                    justifyContent: 'space-between',
                                                    alignItems: 'center'
                                                }} className="search-result-item">
                                                    <div>
                                                        <div style={{ fontWeight: '600', fontSize: '14px' }}>{a.description}</div>
                                                        <div style={{ fontSize: '12px', color: 'var(--text-secondary)' }}>{a.type} ‚Ä¢ {a.user || 'System'}</div>
                                                    </div>
                                                    <span style={{ fontSize: '11px', color: 'var(--text-secondary)' }}>
                                                        {new Date(a.timestamp).toLocaleDateString()}
                                                    </span>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </>
                            )}
                        </div>
                    )}
                </div>
                <button className="refresh-button" onClick={handleRefresh} title="Refresh Dashboard" style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" style={{ animation: loading ? 'spin 1s linear infinite' : 'none' }}>
                        <path d="M21 2v6h-6"/>
                        <path d="M3 12a9 9 0 0 1 15-6.7L21 8"/>
                        <path d="M3 22v-6h6"/>
                        <path d="M21 12a9 9 0 0 1-15 6.7L3 16"/>
                    </svg>
                    <span>Refresh</span>
                </button>
            </div>
            
            <div className="stats-grid">
                {stats.map((stat, index) => (
                    <div key={index} className="stat-card">
                        <div className="stat-card-header">
                            <div className="stat-card-icon">
                                {stat.icon}
                            </div>
                        </div>
                        <div className="stat-card-body">
                            <div className="stat-card-value">{stat.value}</div>
                            <div className="stat-card-title">{stat.title}</div>
                            {/* Revenue breakdown */}
                            {stat.subValues && (
                                <div style={{ 
                                    display: 'grid', 
                                    gridTemplateColumns: 'repeat(2, 1fr)',
                                    gap: '6px', 
                                    marginTop: '10px'
                                }}>
                                    {stat.subValues.map((sub, idx) => (
                                        <div key={idx} style={{ 
                                            display: 'flex', 
                                            alignItems: 'center',
                                            gap: '4px',
                                            fontSize: '11px'
                                        }}>
                                            <span style={{ 
                                                width: '6px', 
                                                height: '6px', 
                                                borderRadius: '50%',
                                                background: sub.color,
                                                flexShrink: 0
                                            }}></span>
                                            <span style={{ color: 'var(--text-secondary, #64748b)' }}>{sub.label}:</span>
                                            <span style={{ fontWeight: '600', color: 'var(--text-primary, #1e293b)' }}>
                                                {sub.value.toLocaleString()}
                                            </span>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                ))}
            </div>
            
            <div className="quick-access-section">
                <h2 className="section-title">Quick Access</h2>
                <div className="quick-access-grid">
                    {quickAccess.map((item) => (
                        <button 
                            key={item.id} 
                            className="quick-access-btn"
                            style={{ backgroundColor: item.color }}
                            onClick={() => onModuleClick(item.id)}
                        >
                            <span className="quick-access-icon">{item.icon}</span>
                            <span className="quick-access-label">{item.label}</span>
                        </button>
                    ))}
                </div>
            </div>
            
            <div className="recent-activities-section">
                <div className="section-header">
                    <h2 className="section-title">Today's Activities</h2>
                    <div className="section-actions">
                        <span style={{ fontSize: '12px', color: 'var(--text-secondary)', marginRight: '8px' }}>
                            {activities.filter(a => {
                                const aDate = new Date(a.timestamp);
                                aDate.setHours(0, 0, 0, 0);
                                return aDate.getTime() === today.getTime();
                            }).length} today
                        </span>
                        <button className="view-all-btn" onClick={() => onModuleClick('activities')}>View All</button>
                    </div>
                </div>
                <div className="table-container">
                    <table className="activities-table">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Activity</th>
                                <th>Details</th>
                                <th>Logged By</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {(() => {
                                const todayActivities = activities.filter(a => {
                                    const aDate = new Date(a.timestamp);
                                    aDate.setHours(0, 0, 0, 0);
                                    return aDate.getTime() === today.getTime();
                                }).slice(0, 10);
                                
                                if (todayActivities.length === 0) {
                                    return (
                                        <tr>
                                            <td colSpan="5" className="empty-table">No activities today</td>
                                        </tr>
                                    );
                                }
                                
                                return todayActivities.map((activity, idx) => (
                                    <tr key={activity.id || idx}>
                                        <td style={{ whiteSpace: 'nowrap', fontSize: '13px' }}>
                                            {new Date(activity.timestamp).toLocaleTimeString('en-US', { 
                                                hour: '2-digit', 
                                                minute: '2-digit'
                                            })}
                                        </td>
                                        <td>
                                            <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                                <span style={{ 
                                                    fontSize: '16px',
                                                    width: '28px',
                                                    height: '28px',
                                                    borderRadius: '6px',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    justifyContent: 'center',
                                                    background: activity.type === 'intake' ? '#dbeafe' :
                                                               activity.type === 'billing' ? '#d1fae5' :
                                                               activity.type === 'wash' ? '#e0e7ff' :
                                                               activity.type === 'garage' ? '#fef3c7' :
                                                               '#f1f5f9'
                                                }}>
                                                    {activity.type === 'intake' ? 'üöó' :
                                                     activity.type === 'billing' ? 'üí≥' :
                                                     activity.type === 'wash' ? 'üöø' :
                                                     activity.type === 'garage' ? 'üîß' :
                                                     activity.type === 'inventory' ? 'üì¶' :
                                                     activity.type === 'staff' ? 'üë§' :
                                                     'üìã'}
                                                </span>
                                                <span style={{ fontWeight: '500', color: 'var(--text-primary)' }}>
                                                    {activity.action || activity.description || 'Activity'}
                                                </span>
                                            </div>
                                        </td>
                                        <td style={{ color: 'var(--text-secondary)', fontSize: '13px' }}>
                                            {activity.details || activity.user || '-'}
                                        </td>
                                        <td>
                                            <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                                                <span style={{
                                                    width: '22px',
                                                    height: '22px',
                                                    borderRadius: '0',
                                                    background: '#3b82f6',
                                                    color: 'white',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    justifyContent: 'center',
                                                    fontSize: '10px',
                                                    fontWeight: '600'
                                                }}>
                                                    {(activity.loggedBy || 'S').charAt(0).toUpperCase()}
                                                </span>
                                                <div style={{ fontSize: '12px' }}>
                                                    <div style={{ fontWeight: '500', color: 'var(--text-primary)' }}>{activity.loggedBy || 'System'}</div>
                                                    {activity.loggedByRole && (
                                                        <div style={{ fontSize: '10px', color: 'var(--text-secondary)', textTransform: 'capitalize' }}>
                                                            {activity.loggedByRole}
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <span style={{
                                                padding: '4px 10px',
                                                borderRadius: '12px',
                                                fontSize: '11px',
                                                fontWeight: '600',
                                                textTransform: 'uppercase',
                                                background: activity.status === 'success' ? '#d1fae5' :
                                                           activity.status === 'pending' ? '#fef3c7' :
                                                           activity.status === 'error' ? '#fee2e2' :
                                                           '#f1f5f9',
                                                color: activity.status === 'success' ? '#059669' :
                                                       activity.status === 'pending' ? '#d97706' :
                                                       activity.status === 'error' ? '#dc2626' :
                                                       '#64748b'
                                            }}>
                                                {activity.status || 'done'}
                                            </span>
                                        </td>
                                    </tr>
                                ));
                            })()}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    );
}

// ==================== HR MODULE COMPONENT ====================
function HRModule() {
    const [isDark, setIsDark] = useState(document.documentElement.getAttribute('data-theme') === 'dark');
    const [activeTab, setActiveTab] = useState('overview');
    const [staffList, setStaffList] = useState([]);
    const [usersList, setUsersList] = useState([]);
    const [assignments, setAssignments] = useState([]);
    const [washHistory, setWashHistory] = useState([]);
    const [garageJobs, setGarageJobs] = useState([]);
    const [payments, setPayments] = useState([]);
    const [loading, setLoading] = useState(true);
    const [selectedStaff, setSelectedStaff] = useState(null);
    const [showPaymentModal, setShowPaymentModal] = useState(false);
    const [showViewPaymentModal, setShowViewPaymentModal] = useState(false);
    const [viewingPayment, setViewingPayment] = useState(null);
    const [showHistoryModal, setShowHistoryModal] = useState(false);
    const [showCommissionModal, setShowCommissionModal] = useState(false);
    const [showAddWorkModal, setShowAddWorkModal] = useState(false);
    const [showConfirmModal, setShowConfirmModal] = useState(false);
    const [confirmAction, setConfirmAction] = useState({ title: '', message: '', onConfirm: null });
    const [actionLoading, setActionLoading] = useState(false);
    const [successMessage, setSuccessMessage] = useState(null);
    const [error, setError] = useState(null);
    const [searchTerm, setSearchTerm] = useState('');
    const [workHistorySearch, setWorkHistorySearch] = useState('');
    const [filterPaymentType, setFilterPaymentType] = useState('all');
    const [dateRange, setDateRange] = useState({ start: '', end: '' });
    const [showPaymentHistoryModal, setShowPaymentHistoryModal] = useState(false);
    const [paymentHistoryStaff, setPaymentHistoryStaff] = useState(null);

    // Payment form
    const [paymentForm, setPaymentForm] = useState({
        amount: '',
        periodStart: '',
        periodEnd: '',
        deductions: '',
        paye: '',
        nhif: '',
        nssf: '',
        otherDeductions: '',
        notes: ''
    });

    // Commission settings form
    const [commissionForm, setCommissionForm] = useState({
        paymentType: 'monthly',
        salary: '',
        commissionRate: ''
    });

    // Work entry form
    const [workForm, setWorkForm] = useState({
        staffId: '',
        jobType: 'wash',
        vehiclePlate: '',
        customerName: '',
        serviceName: '',
        servicePrice: ''
    });

    const PAYMENT_TYPES = [
        { id: 'monthly', label: 'Monthly Salary', icon: 'üìÖ' },
        { id: 'weekly', label: 'Weekly Salary', icon: 'üìÜ' },
        { id: 'daily', label: 'Daily Rate', icon: 'üåÖ' },
        { id: 'commission', label: 'Commission Based', icon: 'üí∞' }
    ];

    const JOB_TYPES = [
        { id: 'wash', label: 'Car Wash', icon: 'üöó' },
        { id: 'detail', label: 'Detailing', icon: '‚ú®' },
        { id: 'garage', label: 'Garage Work', icon: 'üîß' },
        { id: 'other', label: 'Other', icon: 'üìã' }
    ];

    // Theme observer
    useEffect(() => {
        const observer = new MutationObserver(() => {
            setIsDark(document.documentElement.getAttribute('data-theme') === 'dark');
        });
        observer.observe(document.documentElement, { attributes: true, attributeFilter: ['data-theme'] });
        return () => observer.disconnect();
    }, []);

    // Load data
    useEffect(() => {
        const services = window.FirebaseServices;
        if (!services) return;

        let unsubStaff, unsubUsers, unsubAssignments, unsubPayments, unsubWashHistory, unsubGarageJobs;

        // Subscribe to staff
        if (services.staffService?.subscribeToAllStaff) {
            unsubStaff = services.staffService.subscribeToAllStaff((data) => {
                setStaffList(data.filter(s => s.status === 'active'));
            });
        }

        // Subscribe to users
        if (services.userService?.subscribeToUsers) {
            unsubUsers = services.userService.subscribeToUsers((data) => {
                setUsersList(data.filter(u => u.isActive));
            });
        }

        // Subscribe to manual HR assignments
        if (services.hrService?.subscribeToAssignments) {
            unsubAssignments = services.hrService.subscribeToAssignments((data) => {
                setAssignments(data);
            });
        }

        // Subscribe to wash history (completed washes from wash bays)
        if (services.washBayService?.subscribeToHistory) {
            unsubWashHistory = services.washBayService.subscribeToHistory((data) => {
                // Filter only completed washes with assigned staff (washedBy = staff who washed the car)
                const completedWashes = data.filter(w => w.action === 'completed' && (w.vehicle?.washedBy || w.vehicle?.assignedBy));
                setWashHistory(completedWashes);
            });
        }

        // Subscribe to garage jobs (completed ones)
        if (services.garageJobsService?.subscribeToJobs) {
            unsubGarageJobs = services.garageJobsService.subscribeToJobs((data) => {
                // Filter only completed jobs with assigned technician
                const completedJobs = data.filter(j => j.status === 'completed' && j.assignedTo);
                setGarageJobs(completedJobs);
            });
        }

        // Subscribe to payments
        if (services.hrService?.subscribeToPayments) {
            unsubPayments = services.hrService.subscribeToPayments((data) => {
                setPayments(data);
                setLoading(false);
            });
        } else {
            setLoading(false);
        }

        return () => {
            if (unsubStaff) unsubStaff();
            if (unsubUsers) unsubUsers();
            if (unsubAssignments) unsubAssignments();
            if (unsubPayments) unsubPayments();
            if (unsubWashHistory) unsubWashHistory();
            if (unsubGarageJobs) unsubGarageJobs();
        };
    }, []);

    // Combine all work history: manual assignments + wash history + garage jobs
    const getAllWorkHistory = useCallback(() => {
        const allWork = [];

        // Add manual HR assignments
        assignments.forEach(a => {
            allWork.push({
                id: a.id,
                type: 'manual',
                jobType: a.jobType || 'other',
                staffId: a.staffId,
                staffName: a.staffName,
                vehiclePlate: a.vehiclePlate || '',
                customerName: a.customerName || '',
                serviceName: a.serviceName || '',
                servicePrice: parseFloat(a.servicePrice) || 0,
                commissionRate: parseFloat(a.commissionRate) || 0,
                commissionAmount: parseFloat(a.commissionAmount) || 0,
                completedAt: a.completedAt || a.createdAt,
                source: 'manual'
            });
        });

        // Add wash history - match by staff name (washedBy = staff who washed the car)
        washHistory.forEach(w => {
            const staffName = w.vehicle?.washedBy || w.vehicle?.assignedBy || '';
            const staff = staffList.find(s => s.name?.toLowerCase() === staffName.toLowerCase());
            const servicePrice = parseFloat(w.vehicle?.servicePrice) || parseFloat(w.vehicle?.service?.price) || 0;
            const commissionRate = staff?.commissionRate || 0;
            const commissionAmount = (servicePrice * commissionRate) / 100;

            allWork.push({
                id: w.id || `wash-${w.timestamp}`,
                type: 'wash',
                jobType: 'wash',
                staffId: staff?.id || '',
                staffName: staffName,
                vehiclePlate: w.vehicle?.plateNumber || '',
                customerName: w.vehicle?.customerName || '',
                serviceName: w.vehicle?.service?.name || w.vehicle?.service || 'Car Wash',
                servicePrice: servicePrice,
                commissionRate: commissionRate,
                commissionAmount: commissionAmount,
                completedAt: w.endTime || w.timestamp,
                bayName: w.bayName || '',
                duration: w.duration || 0,
                source: 'washbay'
            });
        });

        // Add garage jobs - match by assigned technician name
        garageJobs.forEach(j => {
            const staffName = j.assignedTo || '';
            const staff = staffList.find(s => s.name?.toLowerCase() === staffName.toLowerCase());
            const servicePrice = parseFloat(j.totalCost) || 0;
            const commissionRate = staff?.commissionRate || 0;
            const commissionAmount = (servicePrice * commissionRate) / 100;

            allWork.push({
                id: j.id,
                type: 'garage',
                jobType: 'garage',
                staffId: staff?.id || '',
                staffName: staffName,
                vehiclePlate: j.plateNumber || '',
                customerName: j.customerName || '',
                serviceName: j.services?.map(sId => typeof sId === 'object' ? sId.name : sId).join(', ') || 'Garage Work',
                servicePrice: servicePrice,
                commissionRate: commissionRate,
                commissionAmount: commissionAmount,
                completedAt: j.completedAt,
                source: 'garage'
            });
        });

        // Sort by completion date descending
        allWork.sort((a, b) => new Date(b.completedAt) - new Date(a.completedAt));

        return allWork;
    }, [assignments, washHistory, garageJobs, staffList]);

    // Get all work history
    const allWorkHistory = getAllWorkHistory();

    // Helper to calculate salary earnings based on payment type and period
    const calculateSalaryEarnings = (staff, periodStart, periodEnd) => {
        if (!staff || staff.paymentType === 'commission') return 0;
        const salary = parseFloat(staff.salary) || 0;
        if (!salary) return 0;
        
        const start = periodStart ? new Date(periodStart) : new Date();
        const end = periodEnd ? new Date(periodEnd) : new Date();
        const diffTime = Math.abs(end - start);
        const diffDays = Math.max(1, Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1);
        
        switch (staff.paymentType) {
            case 'daily':
                return salary * diffDays;
            case 'weekly':
                const weeks = Math.ceil(diffDays / 7);
                return salary * weeks;
            case 'monthly':
            default:
                const months = Math.max(1, Math.ceil(diffDays / 30));
                return salary * months;
        }
    };

    // Calculate staff stats from all sources
    const getStaffStats = (staffId, staffName, staff = null) => {
        // Get work by staff ID or name match
        const staffWork = allWorkHistory.filter(w => 
            w.staffId === staffId || 
            w.staffName?.toLowerCase() === staffName?.toLowerCase()
        );
        const staffPayments = payments.filter(p => p.staffId === staffId && p.status !== 'cancelled');
        
        const totalJobs = staffWork.length;
        
        // Find staff data if not provided
        const staffData = staff || staffList.find(s => s.id === staffId);
        
        // Calculate earnings based on payment type
        let totalEarnings = 0;
        if (staffData?.paymentType === 'commission') {
            // Commission-based: sum up commission from jobs
            totalEarnings = staffWork.reduce((sum, w) => sum + (parseFloat(w.commissionAmount) || 0), 0);
        } else {
            // Salary-based (daily/weekly/monthly): use the set salary rate
            // For pending earnings, calculate based on current month
            const now = new Date();
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            const monthEnd = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            totalEarnings = calculateSalaryEarnings(staffData, monthStart, monthEnd);
        }
        
        const totalPaid = staffPayments.reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
        
        return { 
            totalJobs, 
            totalCommission: totalEarnings,
            totalEarnings,
            totalPaid, 
            pendingCommission: Math.max(0, totalEarnings - totalPaid),
            paymentType: staffData?.paymentType || 'monthly',
            salary: staffData?.salary || 0,
            workHistory: staffWork
        };
    };

    // Filter staff
    const filteredStaff = staffList.filter(staff => {
        const matchesSearch = !searchTerm || 
            staff.name?.toLowerCase().includes(searchTerm.toLowerCase()) ||
            staff.role?.toLowerCase().includes(searchTerm.toLowerCase());
        const matchesPaymentType = filterPaymentType === 'all' || staff.paymentType === filterPaymentType;
        return matchesSearch && matchesPaymentType;
    });

    // Handle commission settings update
    const handleUpdateCommission = async () => {
        if (!selectedStaff) return;
        setActionLoading(true);
        try {
            const services = window.FirebaseServices;
            await services.staffService.updateStaff(selectedStaff.id, {
                paymentType: commissionForm.paymentType,
                salary: parseFloat(commissionForm.salary) || 0,
                commissionRate: parseFloat(commissionForm.commissionRate) || 0
            });
            setSuccessMessage('Payment settings updated successfully');
            setShowCommissionModal(false);
            setTimeout(() => setSuccessMessage(null), 3000);
        } catch (err) {
            setError(err.message);
        } finally {
            setActionLoading(false);
        }
    };

    // Handle record payment
    const handleRecordPayment = async () => {
        if (!selectedStaff || !paymentForm.amount) return;
        setActionLoading(true);
        try {
            const services = window.FirebaseServices;
            const stats = getStaffStats(selectedStaff.id, selectedStaff.name);
            const currentUser = window.currentUserProfile;
            const firebaseUser = services?.authService?.getCurrentUser ? services.authService.getCurrentUser() : null;
            
            // Debug log to see what's available
            console.log('Current User Profile:', currentUser);
            console.log('Firebase User:', firebaseUser);
            
            // Get the processor name - try multiple sources
            let processorName = 'System';
            if (currentUser?.displayName) {
                processorName = currentUser.displayName;
            } else if (currentUser?.name) {
                processorName = currentUser.name;
            } else if (currentUser?.email) {
                processorName = currentUser.email.split('@')[0];
            } else if (firebaseUser?.displayName) {
                processorName = firebaseUser.displayName;
            } else if (firebaseUser?.email) {
                processorName = firebaseUser.email.split('@')[0];
            }
            
            const processorId = currentUser?.id || currentUser?.uid || firebaseUser?.uid || 'unknown';
            
            console.log('Processor Name:', processorName);
            console.log('Processor ID:', processorId);
            
            const grossAmount = parseFloat(paymentForm.amount) || 0;
            const paye = parseFloat(paymentForm.paye) || 0;
            const nhif = parseFloat(paymentForm.nhif) || 0;
            const nssf = parseFloat(paymentForm.nssf) || 0;
            const otherDeductions = parseFloat(paymentForm.otherDeductions) || 0;
            const totalDeductions = paye + nhif + nssf + otherDeductions;
            const netPay = grossAmount - totalDeductions;

            await services.hrService.recordPayment({
                staffId: selectedStaff.id,
                staffName: selectedStaff.name,
                paymentType: selectedStaff.paymentType || 'monthly',
                grossAmount: grossAmount,
                amount: netPay,
                periodStart: paymentForm.periodStart,
                periodEnd: paymentForm.periodEnd,
                jobsCount: stats.totalJobs,
                totalCommission: stats.totalCommission,
                baseSalary: selectedStaff.salary || 0,
                paye: paye,
                nhif: nhif,
                nssf: nssf,
                otherDeductions: otherDeductions,
                totalDeductions: totalDeductions,
                deductions: totalDeductions,
                notes: paymentForm.notes,
                processedBy: processorId,
                processedByName: processorName
            });
            
            setSuccessMessage('Payment recorded successfully');
            setShowPaymentModal(false);
            setPaymentForm({ amount: '', periodStart: '', periodEnd: '', deductions: '', paye: '', nhif: '', nssf: '', otherDeductions: '', notes: '' });
            setTimeout(() => setSuccessMessage(null), 3000);
        } catch (err) {
            setError(err.message);
        } finally {
            setActionLoading(false);
        }
    };

    // Show confirm modal
    const showConfirm = (title, message, onConfirm) => {
        setConfirmAction({ title, message, onConfirm });
        setShowConfirmModal(true);
    };

    // Execute confirmed action
    const executeConfirmedAction = async () => {
        if (confirmAction.onConfirm) {
            await confirmAction.onConfirm();
        }
        setShowConfirmModal(false);
        setConfirmAction({ title: '', message: '', onConfirm: null });
    };

    // Handle cancel/reverse payment
    const handleCancelPayment = (payment) => {
        showConfirm(
            'Cancel Payment',
            `Are you sure you want to cancel this payment of ${getBrandingForReceipts().currencySymbol || 'KES'} ${(payment.amount || 0).toLocaleString()} to ${payment.staffName}? This action cannot be undone.`,
            async () => {
                setActionLoading(true);
                try {
                    const services = window.FirebaseServices;
                    await services.hrService.updatePayment(payment.id, {
                        status: 'cancelled',
                        cancelledAt: new Date().toISOString(),
                        cancelledBy: 'Admin'
                    });
                    setSuccessMessage('Payment cancelled successfully');
                    setTimeout(() => setSuccessMessage(null), 3000);
                } catch (err) {
                    setError(err.message || 'Failed to cancel payment');
                } finally {
                    setActionLoading(false);
                }
            }
        );
    };

    // Handle mark payment as paid (for pending payments)
    const handleMarkAsPaid = async (payment) => {
        setActionLoading(true);
        try {
            const services = window.FirebaseServices;
            await services.hrService.updatePayment(payment.id, {
                status: 'paid',
                paidAt: new Date().toISOString()
            });
            setSuccessMessage('Payment marked as paid');
            setTimeout(() => setSuccessMessage(null), 3000);
        } catch (err) {
            setError(err.message || 'Failed to update payment');
        } finally {
            setActionLoading(false);
        }
    };

    // Handle add work entry
    const handleAddWork = async () => {
        if (!workForm.staffId || !workForm.serviceName) return;
        setActionLoading(true);
        try {
            const services = window.FirebaseServices;
            const staff = staffList.find(s => s.id === workForm.staffId);
            const servicePrice = parseFloat(workForm.servicePrice) || 0;
            const commissionRate = staff?.commissionRate || 0;
            const commissionAmount = (servicePrice * commissionRate) / 100;

            await services.hrService.assignStaffToJob({
                staffId: workForm.staffId,
                staffName: staff?.name || '',
                jobType: workForm.jobType,
                vehiclePlate: workForm.vehiclePlate,
                customerName: workForm.customerName,
                serviceName: workForm.serviceName,
                servicePrice: servicePrice,
                commissionRate: commissionRate,
                commissionAmount: commissionAmount
            });
            
            setSuccessMessage('Work entry added successfully');
            setShowAddWorkModal(false);
            setWorkForm({ staffId: '', jobType: 'wash', vehiclePlate: '', customerName: '', serviceName: '', servicePrice: '' });
            setTimeout(() => setSuccessMessage(null), 3000);
        } catch (err) {
            setError(err.message);
        } finally {
            setActionLoading(false);
        }
    };

    // Print payment receipt (Payslip)
    const handlePrintReceipt = (payment) => {
        const brand = getBrandingForReceipts();
        const grossAmount = parseFloat(payment.grossAmount) || parseFloat(payment.amount) || 0;
        const paye = parseFloat(payment.paye) || 0;
        const nhif = parseFloat(payment.nhif) || 0;
        const nssf = parseFloat(payment.nssf) || 0;
        const otherDeductions = parseFloat(payment.otherDeductions) || 0;
        const totalDeductions = paye + nhif + nssf + otherDeductions;
        const netPay = parseFloat(payment.amount) || (grossAmount - totalDeductions);

        const receiptContent = `
            <html>
            <head>
                <title>Payslip - ${payment.staffName}</title>
                <style>
                    * { margin: 0; padding: 0; box-sizing: border-box; }
                    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; padding: 40px; max-width: 420px; margin: 0 auto; color: #1e293b; font-size: 13px; }
                    .payslip { border: 1px solid #e2e8f0; }
                    .header { padding: 24px; text-align: center; border-bottom: 1px solid #e2e8f0; }
                    .company-name { font-size: 18px; font-weight: 700; color: #1e293b; margin-bottom: 2px; }
                    .company-details { font-size: 11px; color: #64748b; }
                    .title { padding: 12px 24px; background: #f8fafc; text-align: center; font-size: 12px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid #e2e8f0; }
                    .section { padding: 20px 24px; border-bottom: 1px solid #e2e8f0; }
                    .section:last-child { border-bottom: none; }
                    .section-title { font-size: 10px; text-transform: uppercase; color: #94a3b8; font-weight: 600; margin-bottom: 12px; letter-spacing: 0.5px; }
                    .row { display: flex; justify-content: space-between; padding: 6px 0; }
                    .row .label { color: #64748b; }
                    .row .value { font-weight: 500; color: #1e293b; }
                    .divider { border-top: 1px dashed #e2e8f0; margin: 12px 0; }
                    .total-row { display: flex; justify-content: space-between; padding: 8px 0; font-weight: 600; }
                    .total-row.deduction .value { color: #ef4444; }
                    .net-section { padding: 20px 24px; background: #f8fafc; }
                    .net-row { display: flex; justify-content: space-between; align-items: center; }
                    .net-label { font-size: 12px; font-weight: 600; color: #64748b; text-transform: uppercase; }
                    .net-amount { font-size: 22px; font-weight: 700; color: #10b981; }
                    .footer { padding: 16px 24px; text-align: center; font-size: 10px; color: #94a3b8; border-top: 1px solid #e2e8f0; }
                    @media print { body { padding: 20px; } }
                </style>
            </head>
            <body>
                <div class="payslip">
                    <div class="header">
                        <div class="company-name">${brand.companyName || 'Company Name'}</div>
                        <div class="company-details">${brand.address ? brand.address + (brand.city ? ', ' + brand.city : '') : ''}${brand.phone ? ' ‚Ä¢ ' + brand.phone : ''}</div>
                    </div>
                    
                    <div class="title">Payslip</div>
                    
                    <div class="section">
                        <div class="section-title">Details</div>
                        <div class="row"><span class="label">Employee</span><span class="value">${payment.staffName || 'N/A'}</span></div>
                        <div class="row"><span class="label">Payslip No.</span><span class="value">#${payment.id?.slice(-6).toUpperCase() || 'N/A'}</span></div>
                        <div class="row"><span class="label">Payment Date</span><span class="value">${new Date(payment.paidAt || payment.createdAt).toLocaleDateString()}</span></div>
                        <div class="row"><span class="label">Period</span><span class="value">${payment.periodStart && payment.periodEnd ? new Date(payment.periodStart).toLocaleDateString() + ' - ' + new Date(payment.periodEnd).toLocaleDateString() : '-'}</span></div>
                        <div class="row"><span class="label">Processed By</span><span class="value">${payment.processedByName || 'System'}</span></div>
                    </div>
                    
                    <div class="section">
                        <div class="section-title">Earnings</div>
                        <div class="row"><span class="label">Gross Amount</span><span class="value">${brand.currencySymbol || 'KES'} ${grossAmount.toLocaleString()}</span></div>
                    </div>
                    
                    ${totalDeductions > 0 ? `
                    <div class="section">
                        <div class="section-title">Deductions</div>
                        ${paye > 0 ? `<div class="row"><span class="label">P.A.Y.E</span><span class="value" style="color:#ef4444">-${brand.currencySymbol || 'KES'} ${paye.toLocaleString()}</span></div>` : ''}
                        ${nhif > 0 ? `<div class="row"><span class="label">NHIF</span><span class="value" style="color:#ef4444">-${brand.currencySymbol || 'KES'} ${nhif.toLocaleString()}</span></div>` : ''}
                        ${nssf > 0 ? `<div class="row"><span class="label">NSSF</span><span class="value" style="color:#ef4444">-${brand.currencySymbol || 'KES'} ${nssf.toLocaleString()}</span></div>` : ''}
                        ${otherDeductions > 0 ? `<div class="row"><span class="label">Other</span><span class="value" style="color:#ef4444">-${brand.currencySymbol || 'KES'} ${otherDeductions.toLocaleString()}</span></div>` : ''}
                        <div class="divider"></div>
                        <div class="total-row deduction"><span class="label">Total Deductions</span><span class="value">-${brand.currencySymbol || 'KES'} ${totalDeductions.toLocaleString()}</span></div>
                    </div>
                    ` : ''}
                    
                    <div class="net-section">
                        <div class="net-row">
                            <span class="net-label">Net Pay</span>
                            <span class="net-amount">${brand.currencySymbol || 'KES'} ${netPay.toLocaleString()}</span>
                        </div>
                    </div>
                    
                    <div class="footer">
                        This is a computer-generated payslip
                    </div>
                </div>
            </body>
            </html>
        `;
        const printWindow = window.open('', '_blank');
        printWindow.document.write(receiptContent);
        printWindow.document.close();
        printWindow.print();
    };

    // Styles - Sharp edges for clean look
    const cardStyle = { background: isDark ? '#1e293b' : 'white', border: `1px solid ${isDark ? '#334155' : '#e2e8f0'}`, borderRadius: '0', padding: '20px' };
    const headerStyle = { fontSize: '14px', fontWeight: '600', color: isDark ? '#94a3b8' : '#64748b', marginBottom: '16px', textTransform: 'uppercase', letterSpacing: '0.5px' };
    const statCardStyle = { ...cardStyle, textAlign: 'center', padding: '24px' };
    const statValueStyle = { fontSize: '28px', fontWeight: '700', color: isDark ? '#f1f5f9' : '#1e293b' };
    const statLabelStyle = { fontSize: '13px', color: isDark ? '#94a3b8' : '#64748b', marginTop: '4px' };
    const btnPrimary = { background: '#3b82f6', color: 'white', border: 'none', padding: '10px 20px', borderRadius: '0', cursor: 'pointer', fontSize: '14px', fontWeight: '500' };
    const btnSecondary = { background: isDark ? '#334155' : '#e2e8f0', color: isDark ? '#f1f5f9' : '#1e293b', border: 'none', padding: '8px 16px', borderRadius: '0', cursor: 'pointer', fontSize: '13px' };
    const inputStyle = { width: '100%', padding: '10px 12px', border: `1px solid ${isDark ? '#334155' : '#e2e8f0'}`, borderRadius: '0', background: isDark ? '#0f172a' : 'white', color: isDark ? '#f1f5f9' : '#1e293b', fontSize: '14px', boxSizing: 'border-box' };
    const selectStyle = { ...inputStyle, cursor: 'pointer' };
    const labelStyle = { display: 'block', fontSize: '13px', fontWeight: '500', color: isDark ? '#94a3b8' : '#64748b', marginBottom: '6px' };
    const tableStyle = { width: '100%', borderCollapse: 'collapse' };
    const thStyle = { textAlign: 'left', padding: '12px', borderBottom: `2px solid ${isDark ? '#334155' : '#e2e8f0'}`, fontSize: '13px', fontWeight: '600', color: isDark ? '#94a3b8' : '#64748b' };
    const tdStyle = { padding: '12px', borderBottom: `1px solid ${isDark ? '#334155' : '#e2e8f0'}`, fontSize: '14px', color: isDark ? '#f1f5f9' : '#1e293b' };
    const modalOverlay = { position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.6)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 };
    const modalContent = { background: isDark ? '#1e293b' : 'white', borderRadius: '0', padding: '24px', width: '90%', maxWidth: '500px', maxHeight: '90vh', overflow: 'auto', boxShadow: '0 25px 50px -12px rgba(0,0,0,0.25)' };
    const tabStyle = (isActive) => ({ padding: '10px 20px', border: 'none', background: isActive ? (isDark ? '#3b82f6' : '#3b82f6') : 'transparent', color: isActive ? 'white' : (isDark ? '#94a3b8' : '#64748b'), cursor: 'pointer', borderRadius: '0', fontSize: '14px', fontWeight: '500' });

    // Stats calculations
    const totalStaff = staffList.length;
    const commissionStaff = staffList.filter(s => s.paymentType === 'commission').length;
    const totalJobsThisMonth = allWorkHistory.filter(w => new Date(w.completedAt).getMonth() === new Date().getMonth()).length;
    const totalPaymentsThisMonth = payments.filter(p => new Date(p.createdAt).getMonth() === new Date().getMonth()).reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
    const totalEarningsThisMonth = allWorkHistory.filter(w => new Date(w.completedAt).getMonth() === new Date().getMonth()).reduce((sum, w) => sum + (parseFloat(w.commissionAmount) || 0), 0);

    if (loading) {
        return (
            <div style={{ padding: '24px', textAlign: 'center' }}>
                <div style={{ fontSize: '24px', marginBottom: '16px' }}>‚è≥</div>
                <p style={{ color: isDark ? '#94a3b8' : '#64748b' }}>Loading HR data...</p>
            </div>
        );
    }

    return (
        <div style={{ padding: '24px' }}>
            {/* Success/Error Messages */}
            {successMessage && (
                <div style={{ background: '#10b981', color: 'white', padding: '12px 20px', borderRadius: '0', marginBottom: '20px', display: 'flex', alignItems: 'center', gap: '10px' }}>
                    <span>‚úì</span> {successMessage}
                </div>
            )}
            {error && (
                <div style={{ background: '#ef4444', color: 'white', padding: '12px 20px', borderRadius: '0', marginBottom: '20px', display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
                    <span>‚ö† {error}</span>
                    <button onClick={() => setError(null)} style={{ background: 'transparent', border: 'none', color: 'white', cursor: 'pointer' }}>‚úï</button>
                </div>
            )}

            {/* Tabs */}
            <div style={{ display: 'flex', gap: '8px', marginBottom: '24px', flexWrap: 'wrap' }}>
                <button style={tabStyle(activeTab === 'overview')} onClick={() => setActiveTab('overview')}>üìä Overview</button>
                <button style={tabStyle(activeTab === 'staff')} onClick={() => setActiveTab('staff')}>üë• Staff List</button>
                <button style={tabStyle(activeTab === 'work')} onClick={() => setActiveTab('work')}>üìã Work History</button>
                <button style={tabStyle(activeTab === 'payments')} onClick={() => setActiveTab('payments')}>üí∞ Payments</button>
            </div>

            {/* Overview Tab */}
            {activeTab === 'overview' && (
                <div>
                    {/* Stats Cards */}
                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '20px', marginBottom: '24px' }}>
                        <div style={statCardStyle}>
                            <div style={{ fontSize: '32px', marginBottom: '8px' }}>üë•</div>
                            <div style={statValueStyle}>{totalStaff}</div>
                            <div style={statLabelStyle}>Total Staff</div>
                        </div>
                        <div style={statCardStyle}>
                            <div style={{ fontSize: '32px', marginBottom: '8px' }}>üí∞</div>
                            <div style={statValueStyle}>{commissionStaff}</div>
                            <div style={statLabelStyle}>Commission Based</div>
                        </div>
                        <div style={statCardStyle}>
                            <div style={{ fontSize: '32px', marginBottom: '8px' }}>üöó</div>
                            <div style={statValueStyle}>{totalJobsThisMonth}</div>
                            <div style={statLabelStyle}>Jobs This Month</div>
                        </div>
                        <div style={statCardStyle}>
                            <div style={{ fontSize: '32px', marginBottom: '8px' }}>üíµ</div>
                            <div style={statValueStyle}>{getBrandingForReceipts().currencySymbol || 'KES'} {totalPaymentsThisMonth.toLocaleString()}</div>
                            <div style={statLabelStyle}>Paid This Month</div>
                        </div>
                    </div>

                    {/* Quick Actions */}
                    <div style={cardStyle}>
                        <h3 style={headerStyle}>Quick Actions</h3>
                        <div style={{ display: 'flex', gap: '12px', flexWrap: 'wrap' }}>
                            <button style={btnPrimary} onClick={() => setShowAddWorkModal(true)}>‚ûï Add Work Entry</button>
                            <button style={btnSecondary} onClick={() => setActiveTab('staff')}>üë• View Staff</button>
                            <button style={btnSecondary} onClick={() => setActiveTab('payments')}>üí∞ View Payments</button>
                        </div>
                    </div>
                </div>
            )}

            {/* Staff List Tab */}
            {activeTab === 'staff' && (
                <div>
                    {/* Filters */}
                    <div style={{ ...cardStyle, marginBottom: '20px' }}>
                        <div style={{ display: 'flex', gap: '16px', flexWrap: 'wrap', alignItems: 'flex-end' }}>
                            <div style={{ flex: '1', minWidth: '200px' }}>
                                <label style={labelStyle}>Search Staff</label>
                                <input
                                    type="text"
                                    placeholder="Search by name or role..."
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                    style={inputStyle}
                                />
                            </div>
                            <div style={{ minWidth: '180px' }}>
                                <label style={labelStyle}>Payment Type</label>
                                <select value={filterPaymentType} onChange={(e) => setFilterPaymentType(e.target.value)} style={selectStyle}>
                                    <option value="all">All Types</option>
                                    {PAYMENT_TYPES.map(pt => (
                                        <option key={pt.id} value={pt.id}>{pt.label}</option>
                                    ))}
                                </select>
                            </div>
                        </div>
                    </div>

                    {/* Staff Table */}
                    <div style={cardStyle}>
                        <div style={{ overflowX: 'auto' }}>
                            <table style={tableStyle}>
                                <thead>
                                    <tr>
                                        <th style={thStyle}>Staff Name</th>
                                        <th style={thStyle}>Role</th>
                                        <th style={thStyle}>Payment Type</th>
                                        <th style={thStyle}>Rate/Salary</th>
                                        <th style={thStyle}>Jobs Done</th>
                                        <th style={thStyle}>Earnings</th>
                                        <th style={thStyle}>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {filteredStaff.length === 0 ? (
                                        <tr>
                                            <td colSpan="7" style={{ ...tdStyle, textAlign: 'center', padding: '40px' }}>
                                                <div style={{ fontSize: '24px', marginBottom: '8px' }}>üë•</div>
                                                <p style={{ color: isDark ? '#64748b' : '#94a3b8' }}>No staff found</p>
                                            </td>
                                        </tr>
                                    ) : filteredStaff.map(staff => {
                                        const stats = getStaffStats(staff.id, staff.name);
                                        const paymentType = PAYMENT_TYPES.find(pt => pt.id === staff.paymentType);
                                        return (
                                            <tr key={staff.id}>
                                                <td style={tdStyle}>
                                                    <div style={{ fontWeight: '600' }}>{staff.name}</div>
                                                    <div style={{ fontSize: '12px', color: isDark ? '#64748b' : '#94a3b8' }}>{staff.phone}</div>
                                                </td>
                                                <td style={tdStyle}>{staff.role}</td>
                                                <td style={tdStyle}>
                                                    <span style={{ display: 'inline-flex', alignItems: 'center', gap: '6px', background: isDark ? '#334155' : '#f1f5f9', padding: '4px 10px', borderRadius: '0', fontSize: '12px' }}>
                                                        {paymentType?.icon} {paymentType?.label || 'Not Set'}
                                                    </span>
                                                </td>
                                                <td style={tdStyle}>
                                                    {staff.paymentType === 'commission' 
                                                        ? `${staff.commissionRate || 0}%`
                                                        : `${getBrandingForReceipts().currencySymbol || 'KES'} ${(staff.salary || 0).toLocaleString()}`
                                                    }
                                                </td>
                                                <td style={tdStyle}>{stats.totalJobs}</td>
                                                <td style={tdStyle}>
                                                    <div>
                                                        {staff.paymentType !== 'commission' ? (
                                                            <span style={{ color: '#3b82f6' }}>{getBrandingForReceipts().currencySymbol || 'KES'} {(staff.salary || 0).toLocaleString()}<span style={{ fontSize: '10px', color: isDark ? '#64748b' : '#94a3b8' }}>/{staff.paymentType === 'daily' ? 'day' : staff.paymentType === 'weekly' ? 'week' : 'month'}</span></span>
                                                        ) : (
                                                            <span>{getBrandingForReceipts().currencySymbol || 'KES'} {stats.totalCommission.toLocaleString()}</span>
                                                        )}
                                                    </div>
                                                    {staff.paymentType === 'commission' && stats.pendingCommission > 0 && (
                                                        <div style={{ fontSize: '11px', color: '#f59e0b' }}>Pending: {getBrandingForReceipts().currencySymbol || 'KES'} {stats.pendingCommission.toLocaleString()}</div>
                                                    )}
                                                    {stats.totalPaid > 0 && (
                                                        <div style={{ fontSize: '11px', color: '#10b981' }}>Paid: {getBrandingForReceipts().currencySymbol || 'KES'} {stats.totalPaid.toLocaleString()}</div>
                                                    )}
                                                </td>
                                                <td style={tdStyle}>
                                                    <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                                                        <button
                                                            style={{ ...btnSecondary, padding: '6px 12px', fontSize: '12px' }}
                                                            onClick={() => { setSelectedStaff(staff); setCommissionForm({ paymentType: staff.paymentType || 'monthly', salary: staff.salary || '', commissionRate: staff.commissionRate || '' }); setShowCommissionModal(true); }}
                                                        >‚öôÔ∏è Settings</button>
                                                        <button
                                                            style={{ ...btnSecondary, padding: '6px 12px', fontSize: '12px' }}
                                                            onClick={() => { setSelectedStaff(staff); setShowHistoryModal(true); }}
                                                        >üìã History</button>
                                                        <button
                                                            style={{ ...btnPrimary, padding: '6px 12px', fontSize: '12px' }}
                                                            onClick={() => { setSelectedStaff(staff); setPaymentForm({ amount: '', periodStart: '', periodEnd: '', deductions: '', paye: '', nhif: '', nssf: '', otherDeductions: '', notes: '' }); setShowPaymentModal(true); }}
                                                        >üíµ Pay</button>
                                                    </div>
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            )}

            {/* Work History Tab */}
            {activeTab === 'work' && (
                <div>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px', flexWrap: 'wrap', gap: '12px' }}>
                        <h3 style={{ ...headerStyle, margin: 0 }}>Work History <span style={{ fontSize: '12px', fontWeight: '400', color: isDark ? '#64748b' : '#94a3b8' }}>({allWorkHistory.filter(w => !workHistorySearch || w.staffName?.toLowerCase().includes(workHistorySearch.toLowerCase())).length} jobs)</span></h3>
                        <div style={{ display: 'flex', gap: '10px', alignItems: 'center', flexWrap: 'wrap' }}>
                            <div style={{ position: 'relative' }}>
                                <input
                                    type="text"
                                    placeholder="Search by staff name..."
                                    value={workHistorySearch}
                                    onChange={(e) => setWorkHistorySearch(e.target.value)}
                                    style={{
                                        padding: '8px 12px 8px 36px',
                                        border: `1px solid ${isDark ? '#334155' : '#e2e8f0'}`,
                                        background: isDark ? '#1e293b' : '#fff',
                                        color: isDark ? '#f1f5f9' : '#1e293b',
                                        fontSize: '13px',
                                        minWidth: '220px',
                                        borderRadius: '0'
                                    }}
                                />
                                <span style={{ position: 'absolute', left: '12px', top: '50%', transform: 'translateY(-50%)', fontSize: '14px', opacity: 0.5 }}>üîç</span>
                            </div>
                            <button style={btnPrimary} onClick={() => setShowAddWorkModal(true)}>‚ûï Add Manual Entry</button>
                        </div>
                    </div>
                    <div style={cardStyle}>
                        <div style={{ overflowX: 'auto' }}>
                            <table style={tableStyle}>
                                <thead>
                                    <tr>
                                        <th style={thStyle}>Date</th>
                                        <th style={thStyle}>Staff</th>
                                        <th style={thStyle}>Source</th>
                                        <th style={thStyle}>Vehicle/Service</th>
                                        <th style={thStyle}>Customer</th>
                                        <th style={thStyle}>Price</th>
                                        <th style={thStyle}>Commission</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {allWorkHistory.filter(w => !workHistorySearch || w.staffName?.toLowerCase().includes(workHistorySearch.toLowerCase())).length === 0 ? (
                                        <tr>
                                            <td colSpan="7" style={{ ...tdStyle, textAlign: 'center', padding: '40px' }}>
                                                <div style={{ fontSize: '24px', marginBottom: '8px' }}>üìã</div>
                                                <p style={{ color: isDark ? '#64748b' : '#94a3b8' }}>{workHistorySearch ? 'No results found' : 'No work entries yet'}</p>
                                                <p style={{ fontSize: '12px', color: isDark ? '#64748b' : '#94a3b8', marginTop: '8px' }}>{workHistorySearch ? `No staff matching "${workHistorySearch}"` : 'Complete jobs in Wash Bays or Garage to see them here'}</p>
                                            </td>
                                        </tr>
                                    ) : allWorkHistory.filter(w => !workHistorySearch || w.staffName?.toLowerCase().includes(workHistorySearch.toLowerCase())).slice(0, 100).map(work => {
                                        const jobType = JOB_TYPES.find(jt => jt.id === work.jobType);
                                        const sourceLabel = work.source === 'washbay' ? 'üöø Wash Bay' : work.source === 'garage' ? 'üîß Garage' : 'üìù Manual';
                                        const sourceColor = work.source === 'washbay' ? '#3b82f6' : work.source === 'garage' ? '#f59e0b' : '#8b5cf6';
                                        return (
                                            <tr key={work.id}>
                                                <td style={tdStyle}>{new Date(work.completedAt).toLocaleDateString()}</td>
                                                <td style={tdStyle}>
                                                    <div style={{ fontWeight: '500' }}>{work.staffName || 'Unassigned'}</div>
                                                </td>
                                                <td style={tdStyle}>
                                                    <span style={{ display: 'inline-flex', alignItems: 'center', gap: '4px', background: isDark ? '#1e293b' : '#f8fafc', padding: '4px 8px', borderRadius: '0', fontSize: '11px', color: sourceColor, border: `1px solid ${sourceColor}30` }}>
                                                        {sourceLabel}
                                                    </span>
                                                </td>
                                                <td style={tdStyle}>
                                                    <div style={{ fontWeight: '500' }}>{work.vehiclePlate || '-'}</div>
                                                    <div style={{ fontSize: '12px', color: isDark ? '#64748b' : '#94a3b8' }}>{work.serviceName}</div>
                                                    {work.bayName && <div style={{ fontSize: '11px', color: isDark ? '#64748b' : '#94a3b8' }}>Bay: {work.bayName}</div>}
                                                </td>
                                                <td style={tdStyle}>{work.customerName || '-'}</td>
                                                <td style={tdStyle}>{getBrandingForReceipts().currencySymbol || 'KES'} {(work.servicePrice || 0).toLocaleString()}</td>
                                                <td style={tdStyle}>
                                                    <span style={{ color: '#10b981', fontWeight: '600' }}>
                                                        {getBrandingForReceipts().currencySymbol || 'KES'} {(work.commissionAmount || 0).toLocaleString()}
                                                    </span>
                                                    {work.commissionRate > 0 && (
                                                        <span style={{ fontSize: '11px', color: isDark ? '#64748b' : '#94a3b8', marginLeft: '4px' }}>
                                                            ({work.commissionRate}%)
                                                        </span>
                                                    )}
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            )}

            {/* Payments Tab */}
            {activeTab === 'payments' && (
                <div>
                    <h3 style={{ ...headerStyle, marginBottom: '20px' }}>Latest Payments</h3>
                    <p style={{ fontSize: '13px', color: isDark ? '#64748b' : '#94a3b8', marginBottom: '16px' }}>Showing the most recent payment for each staff member. Click "History" to view all payments.</p>
                    <div style={cardStyle}>
                        <div style={{ overflowX: 'auto' }}>
                            <table style={tableStyle}>
                                <thead>
                                    <tr>
                                        <th style={thStyle}>Date</th>
                                        <th style={thStyle}>Staff</th>
                                        <th style={thStyle}>Type</th>
                                        <th style={thStyle}>Period</th>
                                        <th style={thStyle}>Jobs</th>
                                        <th style={thStyle}>Amount</th>
                                        <th style={thStyle}>Processed By</th>
                                        <th style={thStyle}>Status</th>
                                        <th style={thStyle}>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {(() => {
                                        // Get only the latest payment per staff
                                        const latestPaymentsMap = {};
                                        payments.forEach(payment => {
                                            if (!latestPaymentsMap[payment.staffId] || new Date(payment.paidAt) > new Date(latestPaymentsMap[payment.staffId].paidAt)) {
                                                latestPaymentsMap[payment.staffId] = payment;
                                            }
                                        });
                                        const latestPayments = Object.values(latestPaymentsMap).sort((a, b) => new Date(b.paidAt) - new Date(a.paidAt));
                                        
                                        if (latestPayments.length === 0) {
                                            return (
                                                <tr>
                                                    <td colSpan="8" style={{ ...tdStyle, textAlign: 'center', padding: '40px' }}>
                                                        <div style={{ fontSize: '24px', marginBottom: '8px' }}>üí∞</div>
                                                        <p style={{ color: isDark ? '#64748b' : '#94a3b8' }}>No payments recorded yet</p>
                                                    </td>
                                                </tr>
                                            );
                                        }
                                        
                                        return latestPayments.map(payment => {
                                            const staffMember = staffList.find(s => s.id === payment.staffId);
                                            const totalPaymentsCount = payments.filter(p => p.staffId === payment.staffId).length;
                                            return (
                                                <tr key={payment.id}>
                                                    <td style={tdStyle}>{new Date(payment.paidAt).toLocaleDateString()}</td>
                                                    <td style={tdStyle}>
                                                        <div>{payment.staffName}</div>
                                                        {totalPaymentsCount > 1 && (
                                                            <div style={{ fontSize: '10px', color: isDark ? '#64748b' : '#94a3b8', marginTop: '2px' }}>{totalPaymentsCount} total payments</div>
                                                        )}
                                                    </td>
                                                    <td style={tdStyle}>
                                                        <span style={{ textTransform: 'capitalize' }}>{payment.paymentType}</span>
                                                    </td>
                                                    <td style={tdStyle}>
                                                        {payment.periodStart && payment.periodEnd 
                                                            ? `${new Date(payment.periodStart).toLocaleDateString()} - ${new Date(payment.periodEnd).toLocaleDateString()}`
                                                            : '-'
                                                        }
                                                    </td>
                                                    <td style={tdStyle}>{payment.jobsCount || 0}</td>
                                                    <td style={tdStyle}>
                                                        <span style={{ fontWeight: '700', color: payment.status === 'cancelled' ? '#94a3b8' : '#10b981', textDecoration: payment.status === 'cancelled' ? 'line-through' : 'none' }}>{getBrandingForReceipts().currencySymbol || 'KES'} {(payment.amount || 0).toLocaleString()}</span>
                                                    </td>
                                                    <td style={tdStyle}>
                                                        <div style={{ fontSize: '13px', color: isDark ? '#f1f5f9' : '#1e293b' }}>{payment.processedByName || 'System'}</div>
                                                    </td>
                                                    <td style={tdStyle}>
                                                        <span style={{
                                                            display: 'inline-block',
                                                            padding: '4px 10px',
                                                            borderRadius: '0',
                                                            fontSize: '11px',
                                                            fontWeight: '600',
                                                            backgroundColor: payment.status === 'cancelled' ? '#fee2e2' : payment.status === 'pending' ? '#fef3c7' : '#dcfce7',
                                                            color: payment.status === 'cancelled' ? '#dc2626' : payment.status === 'pending' ? '#d97706' : '#16a34a'
                                                        }}>
                                                            {payment.status === 'cancelled' ? '‚ùå Cancelled' : payment.status === 'pending' ? '‚è≥ Pending' : '‚úÖ Paid'}
                                                        </span>
                                                    </td>
                                                    <td style={tdStyle}>
                                                        <div style={{ display: 'flex', gap: '6px', flexWrap: 'wrap' }}>
                                                            {totalPaymentsCount > 1 && (
                                                                <button
                                                                    style={{ ...btnSecondary, padding: '5px 10px', fontSize: '11px', background: '#dbeafe', color: '#2563eb' }}
                                                                    onClick={() => { setPaymentHistoryStaff(staffMember || { id: payment.staffId, name: payment.staffName }); setShowPaymentHistoryModal(true); }}
                                                                >üìú History</button>
                                                            )}
                                                            <button
                                                                style={{ ...btnSecondary, padding: '5px 10px', fontSize: '11px' }}
                                                                onClick={() => { setViewingPayment(payment); setShowViewPaymentModal(true); }}
                                                            >üëÅÔ∏è View</button>
                                                            {payment.status !== 'cancelled' && (
                                                                <button
                                                                    style={{ ...btnSecondary, padding: '5px 10px', fontSize: '11px' }}
                                                                    onClick={() => handlePrintReceipt(payment)}
                                                                >üñ®Ô∏è Print</button>
                                                            )}
                                                            {payment.status === 'pending' && (
                                                                <button
                                                                    style={{ ...btnSecondary, padding: '5px 10px', fontSize: '11px', background: '#dcfce7', color: '#16a34a' }}
                                                                    onClick={() => handleMarkAsPaid(payment)}
                                                                    disabled={actionLoading}
                                                                >‚úì Mark Paid</button>
                                                            )}
                                                            {payment.status !== 'cancelled' && (
                                                                <button
                                                                    style={{ ...btnSecondary, padding: '5px 10px', fontSize: '11px', background: '#fee2e2', color: '#dc2626' }}
                                                                    onClick={() => handleCancelPayment(payment)}
                                                                    disabled={actionLoading}
                                                                >‚úï Cancel</button>
                                                            )}
                                                        </div>
                                                    </td>
                                                </tr>
                                            );
                                        });
                                    })()}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            )}

            {/* Commission Settings Modal */}
            {showCommissionModal && selectedStaff && (
                <div style={modalOverlay} onClick={() => setShowCommissionModal(false)}>
                    <div style={modalContent} onClick={e => e.stopPropagation()}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px' }}>
                            <h2 style={{ margin: 0, fontSize: '18px', color: isDark ? '#f1f5f9' : '#1e293b' }}>‚öôÔ∏è Payment Settings - {selectedStaff.name}</h2>
                            <button onClick={() => setShowCommissionModal(false)} style={{ background: 'transparent', border: 'none', fontSize: '20px', cursor: 'pointer', color: isDark ? '#94a3b8' : '#64748b' }}>‚úï</button>
                        </div>
                        
                        <div style={{ marginBottom: '20px' }}>
                            <label style={labelStyle}>Payment Type</label>
                            <select value={commissionForm.paymentType} onChange={(e) => setCommissionForm({...commissionForm, paymentType: e.target.value})} style={selectStyle}>
                                {PAYMENT_TYPES.map(pt => (
                                    <option key={pt.id} value={pt.id}>{pt.icon} {pt.label}</option>
                                ))}
                            </select>
                        </div>

                        {commissionForm.paymentType !== 'commission' && (
                            <div style={{ marginBottom: '20px' }}>
                                <label style={labelStyle}>Salary Amount ({getBrandingForReceipts().currencySymbol || 'KES'})</label>
                                <input
                                    type="number"
                                    value={commissionForm.salary}
                                    onChange={(e) => setCommissionForm({...commissionForm, salary: e.target.value})}
                                    placeholder="Enter salary amount"
                                    style={inputStyle}
                                />
                            </div>
                        )}

                        {commissionForm.paymentType === 'commission' && (
                            <div style={{ marginBottom: '20px' }}>
                                <label style={labelStyle}>Commission Rate (%)</label>
                                <input
                                    type="number"
                                    value={commissionForm.commissionRate}
                                    onChange={(e) => setCommissionForm({...commissionForm, commissionRate: e.target.value})}
                                    placeholder="e.g. 10 for 10%"
                                    style={inputStyle}
                                    min="0"
                                    max="100"
                                />
                                <p style={{ fontSize: '12px', color: isDark ? '#64748b' : '#94a3b8', marginTop: '6px' }}>
                                    This percentage will be calculated from each job's service price.
                                </p>
                            </div>
                        )}

                        <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end' }}>
                            <button style={btnSecondary} onClick={() => setShowCommissionModal(false)}>Cancel</button>
                            <button style={btnPrimary} onClick={handleUpdateCommission} disabled={actionLoading}>
                                {actionLoading ? 'Saving...' : 'Save Settings'}
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* Record Payment Modal */}
            {showPaymentModal && selectedStaff && (
                <div style={modalOverlay} onClick={() => setShowPaymentModal(false)}>
                    <div style={modalContent} onClick={e => e.stopPropagation()}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px' }}>
                            <h2 style={{ margin: 0, fontSize: '18px', color: isDark ? '#f1f5f9' : '#1e293b' }}>üíµ Record Payment - {selectedStaff.name}</h2>
                            <button onClick={() => setShowPaymentModal(false)} style={{ background: 'transparent', border: 'none', fontSize: '20px', cursor: 'pointer', color: isDark ? '#94a3b8' : '#64748b' }}>‚úï</button>
                        </div>

                        {/* Staff Summary */}
                        {(() => {
                            const stats = getStaffStats(selectedStaff.id, selectedStaff.name, selectedStaff);
                            const isSalaryBased = selectedStaff.paymentType && selectedStaff.paymentType !== 'commission';
                            const paymentTypeLabels = { daily: 'Daily Rate', weekly: 'Weekly Rate', monthly: 'Monthly Salary', commission: 'Commission' };
                            
                            // Calculate salary for selected period
                            const periodEarnings = paymentForm.periodStart && paymentForm.periodEnd 
                                ? calculateSalaryEarnings(selectedStaff, paymentForm.periodStart, paymentForm.periodEnd)
                                : (isSalaryBased ? (selectedStaff.salary || 0) : stats.totalCommission);
                            
                            return (
                                <div style={{ background: isDark ? '#0f172a' : '#f8fafc', padding: '16px', borderRadius: '0', marginBottom: '20px' }}>
                                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px', fontSize: '13px' }}>
                                        <div><span style={{ color: isDark ? '#64748b' : '#94a3b8' }}>Payment Type:</span> <strong style={{ textTransform: 'capitalize' }}>{paymentTypeLabels[selectedStaff.paymentType] || 'Not Set'}</strong></div>
                                        {isSalaryBased ? (
                                            <div><span style={{ color: isDark ? '#64748b' : '#94a3b8' }}>{paymentTypeLabels[selectedStaff.paymentType]}:</span> <strong style={{ color: '#3b82f6' }}>{getBrandingForReceipts().currencySymbol || 'KES'} {(selectedStaff.salary || 0).toLocaleString()}</strong></div>
                                        ) : (
                                            <div><span style={{ color: isDark ? '#64748b' : '#94a3b8' }}>Jobs Done:</span> <strong>{stats.totalJobs}</strong></div>
                                        )}
                                        <div><span style={{ color: isDark ? '#64748b' : '#94a3b8' }}>{isSalaryBased ? 'Period Earnings:' : 'Total Commission:'}</span> <strong style={{ color: '#10b981' }}>{getBrandingForReceipts().currencySymbol || 'KES'} {periodEarnings.toLocaleString()}</strong></div>
                                        <div><span style={{ color: isDark ? '#64748b' : '#94a3b8' }}>Total Paid:</span> <strong>{getBrandingForReceipts().currencySymbol || 'KES'} {stats.totalPaid.toLocaleString()}</strong></div>
                                    </div>
                                    {isSalaryBased && paymentForm.periodStart && paymentForm.periodEnd && (
                                        <div style={{ marginTop: '12px', padding: '10px', background: isDark ? '#1e3a5f30' : '#dbeafe', borderRadius: '0' }}>
                                            <div style={{ fontSize: '12px', color: isDark ? '#93c5fd' : '#1e40af' }}>
                                                üí° <strong>Suggested Amount:</strong> {getBrandingForReceipts().currencySymbol || 'KES'} {periodEarnings.toLocaleString()} for selected period
                                                <button 
                                                    style={{ marginLeft: '10px', background: '#3b82f6', color: 'white', border: 'none', padding: '4px 10px', cursor: 'pointer', fontSize: '11px' }}
                                                    onClick={() => setPaymentForm({...paymentForm, amount: periodEarnings.toString()})}
                                                >Use This Amount</button>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            );
                        })()}

                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px', marginBottom: '20px' }}>
                            <div>
                                <label style={labelStyle}>Period Start</label>
                                <input type="date" value={paymentForm.periodStart} onChange={(e) => setPaymentForm({...paymentForm, periodStart: e.target.value})} style={inputStyle} />
                            </div>
                            <div>
                                <label style={labelStyle}>Period End</label>
                                <input type="date" value={paymentForm.periodEnd} onChange={(e) => setPaymentForm({...paymentForm, periodEnd: e.target.value})} style={inputStyle} />
                            </div>
                        </div>

                        <div style={{ marginBottom: '20px' }}>
                            <label style={labelStyle}>Gross Payment Amount ({getBrandingForReceipts().currencySymbol || 'KES'}) *</label>
                            <input
                                type="number"
                                value={paymentForm.amount}
                                onChange={(e) => setPaymentForm({...paymentForm, amount: e.target.value})}
                                placeholder="Enter gross amount"
                                style={inputStyle}
                                required
                            />
                        </div>

                        {/* Statutory Deductions Section */}
                        <div style={{ background: isDark ? '#0f172a' : '#fef2f2', padding: '16px', borderRadius: '0', marginBottom: '20px' }}>
                            <div style={{ fontSize: '13px', fontWeight: '600', color: '#dc2626', marginBottom: '12px' }}>üìâ Statutory Deductions</div>
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' }}>
                                <div>
                                    <label style={{ ...labelStyle, fontSize: '12px' }}>P.A.Y.E (Tax)</label>
                                    <input
                                        type="number"
                                        value={paymentForm.paye}
                                        onChange={(e) => setPaymentForm({...paymentForm, paye: e.target.value})}
                                        placeholder="0"
                                        style={{ ...inputStyle, padding: '8px 10px' }}
                                    />
                                </div>
                                <div>
                                    <label style={{ ...labelStyle, fontSize: '12px' }}>NHIF</label>
                                    <input
                                        type="number"
                                        value={paymentForm.nhif}
                                        onChange={(e) => setPaymentForm({...paymentForm, nhif: e.target.value})}
                                        placeholder="0"
                                        style={{ ...inputStyle, padding: '8px 10px' }}
                                    />
                                </div>
                                <div>
                                    <label style={{ ...labelStyle, fontSize: '12px' }}>NSSF</label>
                                    <input
                                        type="number"
                                        value={paymentForm.nssf}
                                        onChange={(e) => setPaymentForm({...paymentForm, nssf: e.target.value})}
                                        placeholder="0"
                                        style={{ ...inputStyle, padding: '8px 10px' }}
                                    />
                                </div>
                                <div>
                                    <label style={{ ...labelStyle, fontSize: '12px' }}>Other Deductions</label>
                                    <input
                                        type="number"
                                        value={paymentForm.otherDeductions}
                                        onChange={(e) => setPaymentForm({...paymentForm, otherDeductions: e.target.value})}
                                        placeholder="0"
                                        style={{ ...inputStyle, padding: '8px 10px' }}
                                    />
                                </div>
                            </div>
                        </div>

                        {/* Net Pay Calculation Display */}
                        {paymentForm.amount && (
                            <div style={{ background: isDark ? '#0f172a' : '#f0fdf4', padding: '16px', borderRadius: '0', marginBottom: '20px' }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '8px', fontSize: '13px' }}>
                                    <span style={{ color: isDark ? '#94a3b8' : '#64748b' }}>Gross Amount:</span>
                                    <span style={{ fontWeight: '600', color: '#16a34a' }}>{getBrandingForReceipts().currencySymbol || 'KES'} {parseFloat(paymentForm.amount || 0).toLocaleString()}</span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '8px', fontSize: '13px' }}>
                                    <span style={{ color: isDark ? '#94a3b8' : '#64748b' }}>Total Deductions:</span>
                                    <span style={{ fontWeight: '600', color: '#dc2626' }}>- {getBrandingForReceipts().currencySymbol || 'KES'} {(
                                        (parseFloat(paymentForm.paye) || 0) + 
                                        (parseFloat(paymentForm.nhif) || 0) + 
                                        (parseFloat(paymentForm.nssf) || 0) + 
                                        (parseFloat(paymentForm.otherDeductions) || 0)
                                    ).toLocaleString()}</span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', paddingTop: '8px', borderTop: `2px solid ${isDark ? '#334155' : '#d1fae5'}`, fontSize: '15px' }}>
                                    <span style={{ fontWeight: '700', color: isDark ? '#f1f5f9' : '#1e293b' }}>NET PAY:</span>
                                    <span style={{ fontWeight: '700', color: '#059669', fontSize: '18px' }}>{getBrandingForReceipts().currencySymbol || 'KES'} {(
                                        (parseFloat(paymentForm.amount) || 0) - 
                                        (parseFloat(paymentForm.paye) || 0) - 
                                        (parseFloat(paymentForm.nhif) || 0) - 
                                        (parseFloat(paymentForm.nssf) || 0) - 
                                        (parseFloat(paymentForm.otherDeductions) || 0)
                                    ).toLocaleString()}</span>
                                </div>
                            </div>
                        )}

                        <div style={{ marginBottom: '20px' }}>
                            <label style={labelStyle}>Notes</label>
                            <textarea
                                value={paymentForm.notes}
                                onChange={(e) => setPaymentForm({...paymentForm, notes: e.target.value})}
                                placeholder="Payment notes..."
                                style={{ ...inputStyle, minHeight: '80px', resize: 'vertical' }}
                            />
                        </div>

                        <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end' }}>
                            <button style={btnSecondary} onClick={() => setShowPaymentModal(false)}>Cancel</button>
                            <button style={btnPrimary} onClick={handleRecordPayment} disabled={actionLoading || !paymentForm.amount}>
                                {actionLoading ? 'Processing...' : 'Record Payment'}
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* View Payment Details Modal */}
            {showViewPaymentModal && viewingPayment && (
                <div style={modalOverlay} onClick={() => setShowViewPaymentModal(false)}>
                    <div style={{ ...modalContent, maxWidth: '480px', padding: '0' }} onClick={e => e.stopPropagation()}>
                        {/* Header */}
                        <div style={{ padding: '20px 24px', borderBottom: `1px solid ${isDark ? '#334155' : '#e2e8f0'}`, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <div>
                                <h2 style={{ margin: 0, fontSize: '16px', fontWeight: '600', color: isDark ? '#f1f5f9' : '#1e293b' }}>Payment Details</h2>
                                <div style={{ fontSize: '12px', color: isDark ? '#64748b' : '#94a3b8', marginTop: '2px' }}>#{viewingPayment.id?.slice(-6).toUpperCase() || 'N/A'}</div>
                            </div>
                            <button onClick={() => setShowViewPaymentModal(false)} style={{ background: 'transparent', border: 'none', fontSize: '18px', cursor: 'pointer', color: isDark ? '#94a3b8' : '#64748b', padding: '4px' }}>‚úï</button>
                        </div>

                        {/* Content */}
                        <div style={{ padding: '20px 24px' }}>
                            {/* Staff & Status */}
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
                                <div>
                                    <div style={{ fontSize: '11px', color: isDark ? '#64748b' : '#94a3b8', textTransform: 'uppercase', marginBottom: '2px' }}>Employee</div>
                                    <div style={{ fontSize: '15px', fontWeight: '600', color: isDark ? '#f1f5f9' : '#1e293b' }}>{viewingPayment.staffName}</div>
                                </div>
                                <span style={{
                                    padding: '4px 10px',
                                    fontSize: '11px',
                                    fontWeight: '600',
                                    backgroundColor: viewingPayment.status === 'cancelled' ? '#fee2e2' : viewingPayment.status === 'pending' ? '#fef3c7' : '#dcfce7',
                                    color: viewingPayment.status === 'cancelled' ? '#dc2626' : viewingPayment.status === 'pending' ? '#d97706' : '#16a34a'
                                }}>
                                    {viewingPayment.status === 'cancelled' ? 'Cancelled' : viewingPayment.status === 'pending' ? 'Pending' : 'Paid'}
                                </span>
                            </div>

                            {/* Details Grid */}
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px', marginBottom: '20px' }}>
                                <div>
                                    <div style={{ fontSize: '11px', color: isDark ? '#64748b' : '#94a3b8', textTransform: 'uppercase', marginBottom: '2px' }}>Payment Type</div>
                                    <div style={{ fontSize: '13px', fontWeight: '500', color: isDark ? '#f1f5f9' : '#1e293b', textTransform: 'capitalize' }}>{viewingPayment.paymentType || 'Salary'}</div>
                                </div>
                                <div>
                                    <div style={{ fontSize: '11px', color: isDark ? '#64748b' : '#94a3b8', textTransform: 'uppercase', marginBottom: '2px' }}>Payment Date</div>
                                    <div style={{ fontSize: '13px', fontWeight: '500', color: isDark ? '#f1f5f9' : '#1e293b' }}>{new Date(viewingPayment.paidAt || viewingPayment.createdAt).toLocaleDateString()}</div>
                                </div>
                                <div>
                                    <div style={{ fontSize: '11px', color: isDark ? '#64748b' : '#94a3b8', textTransform: 'uppercase', marginBottom: '2px' }}>Pay Period</div>
                                    <div style={{ fontSize: '13px', fontWeight: '500', color: isDark ? '#f1f5f9' : '#1e293b' }}>
                                        {viewingPayment.periodStart && viewingPayment.periodEnd 
                                            ? `${new Date(viewingPayment.periodStart).toLocaleDateString()} - ${new Date(viewingPayment.periodEnd).toLocaleDateString()}`
                                            : '-'
                                        }
                                    </div>
                                </div>
                                <div>
                                    <div style={{ fontSize: '11px', color: isDark ? '#64748b' : '#94a3b8', textTransform: 'uppercase', marginBottom: '2px' }}>Processed By</div>
                                    <div style={{ fontSize: '13px', fontWeight: '500', color: isDark ? '#f1f5f9' : '#1e293b' }}>{viewingPayment.processedByName || 'System'}</div>
                                </div>
                            </div>

                            {/* Amounts */}
                            <div style={{ borderTop: `1px solid ${isDark ? '#334155' : '#e2e8f0'}`, paddingTop: '16px' }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '8px' }}>
                                    <span style={{ fontSize: '13px', color: isDark ? '#94a3b8' : '#64748b' }}>Gross Amount</span>
                                    <span style={{ fontSize: '13px', fontWeight: '500', color: isDark ? '#f1f5f9' : '#1e293b' }}>{getBrandingForReceipts().currencySymbol || 'KES'} {(viewingPayment.grossAmount || viewingPayment.amount || 0).toLocaleString()}</span>
                                </div>
                                {(parseFloat(viewingPayment.paye) > 0 || parseFloat(viewingPayment.nhif) > 0 || parseFloat(viewingPayment.nssf) > 0 || parseFloat(viewingPayment.otherDeductions) > 0) && (
                                    <>
                                        {parseFloat(viewingPayment.paye) > 0 && (
                                            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '6px' }}>
                                                <span style={{ fontSize: '12px', color: isDark ? '#64748b' : '#94a3b8' }}>P.A.Y.E</span>
                                                <span style={{ fontSize: '12px', color: '#ef4444' }}>-{getBrandingForReceipts().currencySymbol || 'KES'} {parseFloat(viewingPayment.paye).toLocaleString()}</span>
                                            </div>
                                        )}
                                        {parseFloat(viewingPayment.nhif) > 0 && (
                                            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '6px' }}>
                                                <span style={{ fontSize: '12px', color: isDark ? '#64748b' : '#94a3b8' }}>NHIF</span>
                                                <span style={{ fontSize: '12px', color: '#ef4444' }}>-{getBrandingForReceipts().currencySymbol || 'KES'} {parseFloat(viewingPayment.nhif).toLocaleString()}</span>
                                            </div>
                                        )}
                                        {parseFloat(viewingPayment.nssf) > 0 && (
                                            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '6px' }}>
                                                <span style={{ fontSize: '12px', color: isDark ? '#64748b' : '#94a3b8' }}>NSSF</span>
                                                <span style={{ fontSize: '12px', color: '#ef4444' }}>-{getBrandingForReceipts().currencySymbol || 'KES'} {parseFloat(viewingPayment.nssf).toLocaleString()}</span>
                                            </div>
                                        )}
                                        {parseFloat(viewingPayment.otherDeductions) > 0 && (
                                            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '6px' }}>
                                                <span style={{ fontSize: '12px', color: isDark ? '#64748b' : '#94a3b8' }}>Other Deductions</span>
                                                <span style={{ fontSize: '12px', color: '#ef4444' }}>-{getBrandingForReceipts().currencySymbol || 'KES'} {parseFloat(viewingPayment.otherDeductions).toLocaleString()}</span>
                                            </div>
                                        )}
                                    </>
                                )}
                                <div style={{ display: 'flex', justifyContent: 'space-between', marginTop: '12px', paddingTop: '12px', borderTop: `1px solid ${isDark ? '#334155' : '#e2e8f0'}` }}>
                                    <span style={{ fontSize: '14px', fontWeight: '600', color: isDark ? '#f1f5f9' : '#1e293b' }}>Net Pay</span>
                                    <span style={{ fontSize: '18px', fontWeight: '700', color: '#10b981' }}>{getBrandingForReceipts().currencySymbol || 'KES'} {(viewingPayment.amount || 0).toLocaleString()}</span>
                                </div>
                            </div>

                            {/* Notes */}
                            {viewingPayment.notes && (
                                <div style={{ marginTop: '16px', paddingTop: '16px', borderTop: `1px solid ${isDark ? '#334155' : '#e2e8f0'}` }}>
                                    <div style={{ fontSize: '11px', color: isDark ? '#64748b' : '#94a3b8', textTransform: 'uppercase', marginBottom: '4px' }}>Notes</div>
                                    <div style={{ fontSize: '13px', color: isDark ? '#f1f5f9' : '#1e293b' }}>{viewingPayment.notes}</div>
                                </div>
                            )}
                        </div>

                        {/* Footer Actions */}
                        <div style={{ padding: '16px 24px', borderTop: `1px solid ${isDark ? '#334155' : '#e2e8f0'}`, display: 'flex', gap: '10px', justifyContent: 'flex-end' }}>
                            <button style={{ ...btnSecondary, padding: '8px 16px', fontSize: '13px' }} onClick={() => setShowViewPaymentModal(false)}>Close</button>
                            {viewingPayment.status !== 'cancelled' && (
                                <button style={{ ...btnPrimary, padding: '8px 16px', fontSize: '13px' }} onClick={() => handlePrintReceipt(viewingPayment)}>üñ®Ô∏è Print</button>
                            )}
                        </div>
                    </div>
                </div>
            )}

            {/* Staff History Modal */}
            {showHistoryModal && selectedStaff && (
                <div style={modalOverlay} onClick={() => setShowHistoryModal(false)}>
                    <div style={{ ...modalContent, maxWidth: '700px' }} onClick={e => e.stopPropagation()}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px' }}>
                            <h2 style={{ margin: 0, fontSize: '18px', color: isDark ? '#f1f5f9' : '#1e293b' }}>üìã Work History - {selectedStaff.name}</h2>
                            <button onClick={() => setShowHistoryModal(false)} style={{ background: 'transparent', border: 'none', fontSize: '20px', cursor: 'pointer', color: isDark ? '#94a3b8' : '#64748b' }}>‚úï</button>
                        </div>

                        {/* Stats Summary */}
                        {(() => {
                            const stats = getStaffStats(selectedStaff.id, selectedStaff.name, selectedStaff);
                            const isSalaryBased = selectedStaff.paymentType && selectedStaff.paymentType !== 'commission';
                            const rateLabel = selectedStaff.paymentType === 'daily' ? '/day' : selectedStaff.paymentType === 'weekly' ? '/week' : '/month';
                            return (
                                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '12px', marginBottom: '20px' }}>
                                    <div style={{ background: isDark ? '#0f172a' : '#f0f9ff', padding: '16px', borderRadius: '0', textAlign: 'center' }}>
                                        <div style={{ fontSize: '24px', fontWeight: '700', color: '#3b82f6' }}>{stats.totalJobs}</div>
                                        <div style={{ fontSize: '12px', color: isDark ? '#64748b' : '#94a3b8' }}>Total Jobs</div>
                                    </div>
                                    <div style={{ background: isDark ? '#0f172a' : '#f0fdf4', padding: '16px', borderRadius: '0', textAlign: 'center' }}>
                                        {isSalaryBased ? (
                                            <>
                                                <div style={{ fontSize: '24px', fontWeight: '700', color: '#10b981' }}>{getBrandingForReceipts().currencySymbol || 'KES'} {(selectedStaff.salary || 0).toLocaleString()}</div>
                                                <div style={{ fontSize: '12px', color: isDark ? '#64748b' : '#94a3b8' }}>Rate {rateLabel}</div>
                                            </>
                                        ) : (
                                            <>
                                                <div style={{ fontSize: '24px', fontWeight: '700', color: '#10b981' }}>{getBrandingForReceipts().currencySymbol || 'KES'} {stats.totalCommission.toLocaleString()}</div>
                                                <div style={{ fontSize: '12px', color: isDark ? '#64748b' : '#94a3b8' }}>Total Earnings</div>
                                            </>
                                        )}
                                    </div>
                                    <div style={{ background: isDark ? '#0f172a' : '#fffbeb', padding: '16px', borderRadius: '0', textAlign: 'center' }}>
                                        <div style={{ fontSize: '24px', fontWeight: '700', color: '#f59e0b' }}>{getBrandingForReceipts().currencySymbol || 'KES'} {stats.totalPaid.toLocaleString()}</div>
                                        <div style={{ fontSize: '12px', color: isDark ? '#64748b' : '#94a3b8' }}>Total Paid</div>
                                    </div>
                                </div>
                            );
                        })()}

                        {/* Work List */}
                        <div style={{ maxHeight: '400px', overflowY: 'auto' }}>
                            <table style={tableStyle}>
                                <thead>
                                    <tr>
                                        <th style={thStyle}>Date</th>
                                        <th style={thStyle}>Source</th>
                                        <th style={thStyle}>Service</th>
                                        <th style={thStyle}>Vehicle</th>
                                        <th style={thStyle}>Price</th>
                                        <th style={thStyle}>Commission</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {getStaffStats(selectedStaff.id, selectedStaff.name).workHistory.length === 0 ? (
                                        <tr>
                                            <td colSpan="6" style={{ ...tdStyle, textAlign: 'center', padding: '30px' }}>
                                                <p>No work history found</p>
                                                <p style={{ fontSize: '12px', color: isDark ? '#64748b' : '#94a3b8' }}>Jobs will appear here when {selectedStaff.name} completes work in Wash Bays or Garage</p>
                                            </td>
                                        </tr>
                                    ) : getStaffStats(selectedStaff.id, selectedStaff.name).workHistory.map(w => {
                                        const sourceLabel = w.source === 'washbay' ? 'üöø Wash' : w.source === 'garage' ? 'üîß Garage' : 'üìù Manual';
                                        return (
                                            <tr key={w.id}>
                                                <td style={tdStyle}>{new Date(w.completedAt).toLocaleDateString()}</td>
                                                <td style={tdStyle}><span style={{ fontSize: '12px' }}>{sourceLabel}</span></td>
                                                <td style={tdStyle}>{w.serviceName}</td>
                                                <td style={tdStyle}>
                                                    <span style={{ fontWeight: '600', color: isDark ? '#f1f5f9' : '#1e293b', background: isDark ? '#334155' : '#f1f5f9', padding: '2px 8px', fontSize: '12px' }}>
                                                        {w.vehiclePlate || '-'}
                                                    </span>
                                                </td>
                                                <td style={tdStyle}>{getBrandingForReceipts().currencySymbol || 'KES'} {(w.servicePrice || 0).toLocaleString()}</td>
                                                <td style={tdStyle}>
                                                    <span style={{ color: '#10b981', fontWeight: '600' }}>{getBrandingForReceipts().currencySymbol || 'KES'} {(w.commissionAmount || 0).toLocaleString()}</span>
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>

                        <div style={{ display: 'flex', justifyContent: 'flex-end', marginTop: '20px' }}>
                            <button style={btnSecondary} onClick={() => setShowHistoryModal(false)}>Close</button>
                        </div>
                    </div>
                </div>
            )}

            {/* Add Work Entry Modal */}
            {showAddWorkModal && (
                <div style={modalOverlay} onClick={() => setShowAddWorkModal(false)}>
                    <div style={modalContent} onClick={e => e.stopPropagation()}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px' }}>
                            <h2 style={{ margin: 0, fontSize: '18px', color: isDark ? '#f1f5f9' : '#1e293b' }}>‚ûï Add Work Entry</h2>
                            <button onClick={() => setShowAddWorkModal(false)} style={{ background: 'transparent', border: 'none', fontSize: '20px', cursor: 'pointer', color: isDark ? '#94a3b8' : '#64748b' }}>‚úï</button>
                        </div>

                        <div style={{ marginBottom: '20px' }}>
                            <label style={labelStyle}>Staff Member *</label>
                            <select value={workForm.staffId} onChange={(e) => setWorkForm({...workForm, staffId: e.target.value})} style={selectStyle} required>
                                <option value="">Select staff...</option>
                                {staffList.map(staff => (
                                    <option key={staff.id} value={staff.id}>{staff.name} ({staff.role})</option>
                                ))}
                            </select>
                        </div>

                        <div style={{ marginBottom: '20px' }}>
                            <label style={labelStyle}>Job Type</label>
                            <select value={workForm.jobType} onChange={(e) => setWorkForm({...workForm, jobType: e.target.value})} style={selectStyle}>
                                {JOB_TYPES.map(jt => (
                                    <option key={jt.id} value={jt.id}>{jt.icon} {jt.label}</option>
                                ))}
                            </select>
                        </div>

                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px', marginBottom: '20px' }}>
                            <div>
                                <label style={labelStyle}>Vehicle Plate</label>
                                <input
                                    type="text"
                                    value={workForm.vehiclePlate}
                                    onChange={(e) => setWorkForm({...workForm, vehiclePlate: e.target.value.toUpperCase()})}
                                    placeholder="e.g. KAA 123X"
                                    style={inputStyle}
                                />
                            </div>
                            <div>
                                <label style={labelStyle}>Customer Name</label>
                                <input
                                    type="text"
                                    value={workForm.customerName}
                                    onChange={(e) => setWorkForm({...workForm, customerName: e.target.value})}
                                    placeholder="Customer name"
                                    style={inputStyle}
                                />
                            </div>
                        </div>

                        <div style={{ marginBottom: '20px' }}>
                            <label style={labelStyle}>Service/Work Description *</label>
                            <input
                                type="text"
                                value={workForm.serviceName}
                                onChange={(e) => setWorkForm({...workForm, serviceName: e.target.value})}
                                placeholder="e.g. Full Wash, Interior Cleaning"
                                style={inputStyle}
                                required
                            />
                        </div>

                        <div style={{ marginBottom: '20px' }}>
                            <label style={labelStyle}>Service Price ({getBrandingForReceipts().currencySymbol || 'KES'}) *</label>
                            <input
                                type="number"
                                value={workForm.servicePrice}
                                onChange={(e) => setWorkForm({...workForm, servicePrice: e.target.value})}
                                placeholder="Service price"
                                style={inputStyle}
                                required
                            />
                            {workForm.staffId && (
                                <p style={{ fontSize: '12px', color: '#10b981', marginTop: '6px' }}>
                                    Commission: {getBrandingForReceipts().currencySymbol || 'KES'} {(((parseFloat(workForm.servicePrice) || 0) * (staffList.find(s => s.id === workForm.staffId)?.commissionRate || 0)) / 100).toLocaleString()} 
                                    ({staffList.find(s => s.id === workForm.staffId)?.commissionRate || 0}%)
                                </p>
                            )}
                        </div>

                        <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end' }}>
                            <button style={btnSecondary} onClick={() => setShowAddWorkModal(false)}>Cancel</button>
                            <button style={btnPrimary} onClick={handleAddWork} disabled={actionLoading || !workForm.staffId || !workForm.serviceName || !workForm.servicePrice}>
                                {actionLoading ? 'Adding...' : 'Add Work Entry'}
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* Payment History Modal */}
            {showPaymentHistoryModal && paymentHistoryStaff && (
                <div style={modalOverlay} onClick={() => setShowPaymentHistoryModal(false)}>
                    <div style={{ ...modalContent, width: '95%', maxWidth: '900px', maxHeight: '85vh', display: 'flex', flexDirection: 'column', padding: '24px' }} onClick={e => e.stopPropagation()}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px', flexShrink: 0 }}>
                            <h2 style={{ margin: 0, fontSize: '18px', color: isDark ? '#f1f5f9' : '#1e293b' }}>üìú Payment History - {paymentHistoryStaff.name}</h2>
                            <button onClick={() => setShowPaymentHistoryModal(false)} style={{ background: 'transparent', border: 'none', fontSize: '20px', cursor: 'pointer', color: isDark ? '#94a3b8' : '#64748b' }}>‚úï</button>
                        </div>
                        
                        {/* Summary */}
                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '12px', marginBottom: '20px', flexShrink: 0 }}>
                            {(() => {
                                const staffPayments = payments.filter(p => p.staffId === paymentHistoryStaff.id);
                                const totalPaid = staffPayments.filter(p => p.status === 'paid').reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
                                // Get total jobs from actual work history (same as Staff List tab)
                                const totalJobs = allWorkHistory.filter(w => 
                                    w.staffId === paymentHistoryStaff.id || 
                                    w.staffName?.toLowerCase() === paymentHistoryStaff.name?.toLowerCase()
                                ).length;
                                return (
                                    <>
                                        <div style={{ background: isDark ? '#1e293b' : '#f0fdf4', padding: '14px', border: `1px solid ${isDark ? '#334155' : '#bbf7d0'}` }}>
                                            <div style={{ fontSize: '11px', color: isDark ? '#64748b' : '#16a34a', fontWeight: '600', marginBottom: '4px' }}>TOTAL PAID</div>
                                            <div style={{ fontSize: '18px', fontWeight: '700', color: '#10b981' }}>{getBrandingForReceipts().currencySymbol || 'KES'} {totalPaid.toLocaleString()}</div>
                                        </div>
                                        <div style={{ background: isDark ? '#1e293b' : '#eff6ff', padding: '14px', border: `1px solid ${isDark ? '#334155' : '#bfdbfe'}` }}>
                                            <div style={{ fontSize: '11px', color: isDark ? '#64748b' : '#3b82f6', fontWeight: '600', marginBottom: '4px' }}>TOTAL JOBS</div>
                                            <div style={{ fontSize: '18px', fontWeight: '700', color: '#3b82f6' }}>{totalJobs}</div>
                                        </div>
                                        <div style={{ background: isDark ? '#1e293b' : '#f8fafc', padding: '14px', border: `1px solid ${isDark ? '#334155' : '#e2e8f0'}` }}>
                                            <div style={{ fontSize: '11px', color: isDark ? '#64748b' : '#64748b', fontWeight: '600', marginBottom: '4px' }}>PAYMENTS</div>
                                            <div style={{ fontSize: '18px', fontWeight: '700', color: isDark ? '#f1f5f9' : '#1e293b' }}>{staffPayments.length}</div>
                                        </div>
                                    </>
                                );
                            })()}
                        </div>

                        {/* Payment History Table */}
                        <div style={{ overflowY: 'auto', flex: 1 }}>
                            <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                                <thead style={{ position: 'sticky', top: 0, background: isDark ? '#0f172a' : '#f8fafc', zIndex: 1 }}>
                                    <tr>
                                        <th style={{ ...thStyle, padding: '12px' }}>Date</th>
                                        <th style={{ ...thStyle, padding: '12px' }}>Type</th>
                                        <th style={{ ...thStyle, padding: '12px' }}>Period</th>
                                        <th style={{ ...thStyle, padding: '12px', textAlign: 'right' }}>Amount</th>
                                        <th style={{ ...thStyle, padding: '12px' }}>Processed By</th>
                                        <th style={{ ...thStyle, padding: '12px', textAlign: 'center' }}>Status</th>
                                        <th style={{ ...thStyle, padding: '12px', textAlign: 'center' }}>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {payments.filter(p => p.staffId === paymentHistoryStaff.id).sort((a, b) => new Date(b.paidAt) - new Date(a.paidAt)).map((payment, index) => (
                                        <tr key={payment.id} style={{ background: index === 0 ? (isDark ? '#1e3a5f20' : '#dbeafe30') : 'transparent' }}>
                                            <td style={{ ...tdStyle, padding: '12px' }}>
                                                <div style={{ fontWeight: index === 0 ? '600' : '400' }}>{new Date(payment.paidAt).toLocaleDateString()}</div>
                                                {index === 0 && <div style={{ fontSize: '10px', color: '#3b82f6', fontWeight: '600', marginTop: '2px' }}>LATEST</div>}
                                            </td>
                                            <td style={{ ...tdStyle, padding: '12px', textTransform: 'capitalize' }}>{payment.paymentType}</td>
                                            <td style={{ ...tdStyle, padding: '12px', fontSize: '12px', color: isDark ? '#94a3b8' : '#64748b' }}>
                                                {payment.periodStart && payment.periodEnd 
                                                    ? `${new Date(payment.periodStart).toLocaleDateString()} - ${new Date(payment.periodEnd).toLocaleDateString()}`
                                                    : '-'
                                                }
                                            </td>
                                            <td style={{ ...tdStyle, padding: '12px', textAlign: 'right', fontFamily: 'monospace', fontWeight: '600', color: payment.status === 'cancelled' ? '#94a3b8' : '#10b981', textDecoration: payment.status === 'cancelled' ? 'line-through' : 'none' }}>{getBrandingForReceipts().currencySymbol || 'KES'} {(payment.amount || 0).toLocaleString()}</td>
                                            <td style={{ ...tdStyle, padding: '12px', fontSize: '12px' }}>{payment.processedByName || 'System'}</td>
                                            <td style={{ ...tdStyle, padding: '12px', textAlign: 'center' }}>
                                                <span style={{
                                                    display: 'inline-block',
                                                    padding: '3px 8px',
                                                    fontSize: '10px',
                                                    fontWeight: '600',
                                                    backgroundColor: payment.status === 'cancelled' ? '#fee2e2' : payment.status === 'pending' ? '#fef3c7' : '#dcfce7',
                                                    color: payment.status === 'cancelled' ? '#dc2626' : payment.status === 'pending' ? '#d97706' : '#16a34a'
                                                }}>
                                                    {payment.status === 'cancelled' ? 'Cancelled' : payment.status === 'pending' ? 'Pending' : 'Paid'}
                                                </span>
                                            </td>
                                            <td style={{ ...tdStyle, padding: '12px', textAlign: 'center' }}>
                                                <div style={{ display: 'inline-flex', gap: '6px' }}>
                                                    <button
                                                        style={{ ...btnSecondary, padding: '4px 8px', fontSize: '10px' }}
                                                        onClick={() => { setShowPaymentHistoryModal(false); setViewingPayment(payment); setShowViewPaymentModal(true); }}
                                                    >üëÅÔ∏è</button>
                                                    {payment.status !== 'cancelled' && (
                                                        <button
                                                            style={{ ...btnSecondary, padding: '4px 8px', fontSize: '10px' }}
                                                            onClick={() => handlePrintReceipt(payment)}
                                                        >üñ®Ô∏è</button>
                                                    )}
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>

                        <div style={{ display: 'flex', justifyContent: 'flex-end', paddingTop: '16px', borderTop: `1px solid ${isDark ? '#334155' : '#e2e8f0'}`, marginTop: '16px', flexShrink: 0 }}>
                            <button style={{ ...btnSecondary, padding: '10px 20px' }} onClick={() => setShowPaymentHistoryModal(false)}>Close</button>
                        </div>
                    </div>
                </div>
            )}

            {/* Confirm Action Modal */}
            {showConfirmModal && (
                <div style={modalOverlay} onClick={() => setShowConfirmModal(false)}>
                    <div style={{ ...modalContent, maxWidth: '400px', textAlign: 'center' }} onClick={e => e.stopPropagation()}>
                        <div style={{ fontSize: '48px', marginBottom: '16px' }}>‚ö†Ô∏è</div>
                        <h2 style={{ margin: '0 0 12px 0', fontSize: '18px', fontWeight: '600', color: isDark ? '#f1f5f9' : '#1e293b' }}>
                            {confirmAction.title}
                        </h2>
                        <p style={{ margin: '0 0 24px 0', fontSize: '14px', color: isDark ? '#94a3b8' : '#64748b', lineHeight: '1.5' }}>
                            {confirmAction.message}
                        </p>
                        <div style={{ display: 'flex', gap: '12px', justifyContent: 'center' }}>
                            <button 
                                style={{ ...btnSecondary, padding: '12px 24px' }} 
                                onClick={() => setShowConfirmModal(false)}
                            >
                                Cancel
                            </button>
                            <button 
                                style={{ ...btnPrimary, padding: '12px 24px', background: '#dc2626' }} 
                                onClick={executeConfirmedAction}
                                disabled={actionLoading}
                            >
                                {actionLoading ? 'Processing...' : 'Confirm'}
                            </button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}

// ==================== BILLING MODULE COMPONENT ====================
function BillingModule() {
    const { canCreate, canEdit, canDelete } = usePermissions();
    const [activeTab, setActiveTab] = useState('paid');
    const [invoices, setInvoices] = useState([]);
    const [pendingInvoices, setPendingInvoices] = useState([]);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState(null);
    const [successMessage, setSuccessMessage] = useState(null);
    const [actionLoading, setActionLoading] = useState(false);
    const [searchQuery, setSearchQuery] = useState('');
    const [dateFilter, setDateFilter] = useState('all');
    const [customDateFrom, setCustomDateFrom] = useState('');
    const [customDateTo, setCustomDateTo] = useState('');
    const [sourceFilter, setSourceFilter] = useState('all');
    const [paymentMethodFilter, setPaymentMethodFilter] = useState('all');
    
    // Hide cash payment option - stored in localStorage for persistence (hidden by default)
    const [hideCashPayment, setHideCashPayment] = useState(() => {
        const saved = localStorage.getItem('ecospark_hideCashPayment');
        return saved === null ? true : saved === 'true'; // Default to hidden
    });
    
    // Toggle cash payment visibility
    const toggleCashVisibility = () => {
        const newValue = !hideCashPayment;
        setHideCashPayment(newValue);
        localStorage.setItem('ecospark_hideCashPayment', newValue.toString());
    };
    
    // Pagination state
    const [currentPage, setCurrentPage] = useState(1);
    const [itemsPerPage, setItemsPerPage] = useState(25);
    
    // Alert modal state
    const [alertModal, setAlertModal] = useState({
        isOpen: false,
        title: '',
        message: '',
        type: 'info',
        onConfirm: null,
        showCancel: false
    });
    
    const showAlert = (title, message, type = 'info', onConfirm = null, showCancel = false) => {
        setAlertModal({ isOpen: true, title, message, type, onConfirm, showCancel });
    };
    
    const closeAlert = () => {
        setAlertModal(prev => ({ ...prev, isOpen: false }));
    };
    const [billingStats, setBillingStats] = useState({
        totalInvoices: 0,
        pendingPayments: 0,
        paidToday: 0,
        totalPending: 0,
        totalCollected: 0,
        todayInvoiceCount: 0,
        mpesaPayments: 0,
        cashPayments: 0,
        cardPayments: 0
    });
    
    // Payment modal states
    const [showPaymentModal, setShowPaymentModal] = useState(false);
    const [showMpesaModal, setShowMpesaModal] = useState(false);
    const [showCardModal, setShowCardModal] = useState(false);
    const [showInvoiceDetailModal, setShowInvoiceDetailModal] = useState(false);
    const [selectedInvoice, setSelectedInvoice] = useState(null);
    const [mpesaPhone, setMpesaPhone] = useState('');
    const [mpesaLoading, setMpesaLoading] = useState(false);
    const [mpesaPaymentId, setMpesaPaymentId] = useState(null);
    const [mpesaStatus, setMpesaStatus] = useState(null);
    const [mpesaMode, setMpesaMode] = useState('stk'); // 'stk' or 'manual'
    const [manualMpesaCode, setManualMpesaCode] = useState('');
    const [cardDetails, setCardDetails] = useState({ lastFourDigits: '', transactionRef: '' });
    
    // Manual billing modal states
    const [showManualBillingModal, setShowManualBillingModal] = useState(false);
    const [manualBillingData, setManualBillingData] = useState({
        customerName: '',
        customerPhone: '',
        plateNumber: '',
        vehicleType: 'Sedan',
        source: 'wash',
        selectedServices: [], // Array of service IDs
        notes: '',
        paymentStatus: 'unpaid',
        paymentMethod: 'cash',
        mpesaCode: '',
        mpesaMode: 'manual', // 'stk' or 'manual'
        cardReference: ''
    });
    const [manualMpesaStkLoading, setManualMpesaStkLoading] = useState(false);
    const [manualMpesaStkStatus, setManualMpesaStkStatus] = useState(null);
    
    // Plate search states for manual billing
    const [billingPlateSearchResults, setBillingPlateSearchResults] = useState([]);
    const [showBillingPlateSearch, setShowBillingPlateSearch] = useState(false);
    const [selectedIntakeRecord, setSelectedIntakeRecord] = useState(null);
    const billingPlateSearchTimeout = React.useRef(null);
    
    // Existing pending invoice detection for manual billing
    const [existingPendingInvoice, setExistingPendingInvoice] = useState(null);
    const [applyToExisting, setApplyToExisting] = useState(true); // Default to apply to existing
    
    // Delete confirmation modal with reason (Anti-theft feature)
    const [showDeleteModal, setShowDeleteModal] = useState(false);
    const [deleteTarget, setDeleteTarget] = useState(null);
    const [deleteReason, setDeleteReason] = useState('');
    const [deleteLoading, setDeleteLoading] = useState(false);
    
    // Activity logs for billing audit trail
    const [billingActivityLogs, setBillingActivityLogs] = useState([]);
    const [activityLogsLoading, setActivityLogsLoading] = useState(false);
    
    // Service packages for billing (car wash services)
    const [servicePackages, setServicePackages] = useState([]);
    
    // Garage services for billing
    const [garageServices, setGarageServices] = useState([]);
    
    // Revenue tracking
    const [revenueToday, setRevenueToday] = useState({ total: 0, wash: 0, garage: 0, parking: 0, other: 0 });
    
    // Total collected by source (all time)
    const [totalBySource, setTotalBySource] = useState({ wash: 0, garage: 0, parking: 0, other: 0 });
    
    // Expenses integration
    const [expenses, setExpenses] = useState([]);
    const [expensesSummary, setExpensesSummary] = useState({ total: 0, today: 0, thisWeek: 0, thisMonth: 0, count: 0 });
    
    // Export state
    const [showExportMenu, setShowExportMenu] = useState(false);

    // Theme detection
    const [isDark, setIsDark] = useState(document.documentElement.getAttribute('data-theme') === 'dark');

    useEffect(() => {
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.attributeName === 'data-theme') {
                    setIsDark(document.documentElement.getAttribute('data-theme') === 'dark');
                }
            });
        });
        observer.observe(document.documentElement, { attributes: true });
        return () => observer.disconnect();
    }, []);

    const theme = {
        bg: isDark ? '#1e293b' : 'white',
        bgSecondary: isDark ? '#0f172a' : '#f8fafc',
        bgTertiary: isDark ? '#334155' : '#f1f5f9',
        text: isDark ? '#f1f5f9' : '#1e293b',
        textSecondary: isDark ? '#94a3b8' : '#64748b',
        textMuted: isDark ? '#64748b' : '#94a3b8',
        border: isDark ? '#334155' : '#e2e8f0',
        borderLight: isDark ? '#475569' : '#cbd5e1',
        cardShadow: isDark ? '0 2px 8px rgba(0,0,0,0.3)' : '0 2px 8px rgba(0,0,0,0.08)',
        modalOverlay: isDark ? 'rgba(0,0,0,0.7)' : 'rgba(0,0,0,0.5)',
        inputBg: isDark ? '#1e293b' : 'white',
        rowHoverBg: isDark ? '#334155' : '#f8fafc',
    };

    // Auto-hide success message
    useEffect(() => {
        if (successMessage) {
            const timer = setTimeout(() => setSuccessMessage(null), 3000);
            return () => clearTimeout(timer);
        }
    }, [successMessage]);

    // Initialize Firebase subscriptions
    useEffect(() => {
        let unsubInvoices, unsubPending, unsubExpenses;
        
        const initializeData = async () => {
            let services = window.FirebaseServices;
            let attempts = 0;
            while (!services && attempts < 50) {
                await new Promise(resolve => setTimeout(resolve, 100));
                services = window.FirebaseServices;
                attempts++;
            }

            if (!services || !services.billingService) {
                console.error('Billing service not available');
                setLoading(false);
                setError('Billing service not available. Please refresh.');
                return;
            }

            try {
                // Subscribe to all invoices with error handling
                unsubInvoices = services.billingService.subscribeToInvoices(
                    (data) => {
                        console.log('Invoices loaded:', data.length);
                        setInvoices(data);
                        // Also update pending invoices from the same data (fallback)
                        const pending = data.filter(inv => inv.paymentStatus === 'unpaid' || !inv.paymentStatus);
                        setPendingInvoices(pending);
                        setLoading(false);
                        setError(null);
                    },
                    (err) => {
                        console.error('Invoice subscription error:', err);
                        setError('Failed to load invoices: ' + err.message);
                        setLoading(false);
                    }
                );

                // Try to subscribe to pending invoices (requires Firestore index)
                try {
                    unsubPending = services.billingService.subscribeToPendingInvoices(
                        (data) => {
                            console.log('Pending invoices loaded:', data.length);
                            setPendingInvoices(data);
                        },
                        (err) => {
                            // Silently fallback to client-side filtering (already handled above)
                            console.warn('Pending invoice subscription failed, using fallback:', err.message);
                        }
                    );
                } catch (pendingErr) {
                    console.warn('Could not subscribe to pending invoices:', pendingErr);
                }
                
                // Subscribe to expenses for integration
                if (services.expensesService) {
                    unsubExpenses = services.expensesService.subscribeToExpenses((data) => {
                        setExpenses(data);
                        const summary = services.expensesService.getSummary(data);
                        setExpensesSummary(summary);
                    });
                }

                // Get billing stats
                const statsResult = await services.billingService.getBillingStats();
                if (statsResult.success) {
                    setBillingStats(statsResult.data);
                }
                
                // Load service packages (car wash)
                if (services.packagesService) {
                    const packagesResult = await services.packagesService.getPackages();
                    if (packagesResult.success) {
                        setServicePackages(packagesResult.data.filter(p => p.isActive !== false));
                    }
                }
                
                // Load garage services
                if (services.garageServicesService) {
                    services.garageServicesService.subscribeToServices(
                        (servicesData) => {
                            setGarageServices(servicesData.filter(s => s.isActive !== false));
                        },
                        (err) => console.warn('Could not load garage services:', err)
                    );
                }
            } catch (err) {
                console.error('Error initializing billing:', err);
                setError('Failed to load billing data: ' + err.message);
                setLoading(false);
            }
        };

        initializeData();

        return () => {
            if (unsubInvoices) unsubInvoices();
            if (unsubPending) unsubPending();
            if (unsubExpenses) unsubExpenses();
        };
    }, []);

    // Refresh stats when invoices change
    useEffect(() => {
        const refreshStats = async () => {
            const services = window.FirebaseServices;
            if (services?.billingService) {
                const result = await services.billingService.getBillingStats();
                if (result.success) setBillingStats(result.data);
            }
        };
        refreshStats();
        
        // Calculate revenue breakdown from invoices
        const today = new Date().toISOString().split('T')[0];
        const todayPaidInvoices = invoices.filter(inv => 
            inv.paymentStatus === 'paid' && inv.createdAt?.startsWith(today)
        );
        
        const washRevenue = todayPaidInvoices
            .filter(inv => inv.source === 'wash')
            .reduce((sum, inv) => sum + (inv.totalAmount || inv.paidAmount || 0), 0);
        
        const garageRevenue = todayPaidInvoices
            .filter(inv => inv.source === 'garage')
            .reduce((sum, inv) => sum + (inv.totalAmount || inv.paidAmount || 0), 0);
        
        const parkingRevenue = todayPaidInvoices
            .filter(inv => inv.source === 'parking')
            .reduce((sum, inv) => sum + (inv.totalAmount || inv.paidAmount || 0), 0);
        
        const otherRevenue = todayPaidInvoices
            .filter(inv => inv.source !== 'wash' && inv.source !== 'garage' && inv.source !== 'parking')
            .reduce((sum, inv) => sum + (inv.totalAmount || inv.paidAmount || 0), 0);
        
        setRevenueToday({
            total: washRevenue + garageRevenue + parkingRevenue + otherRevenue,
            wash: washRevenue,
            garage: garageRevenue,
            parking: parkingRevenue,
            other: otherRevenue
        });
        
        // Calculate total collected by source (all time - paid invoices only)
        const paidInvoices = invoices.filter(inv => inv.paymentStatus === 'paid');
        const totalWash = paidInvoices
            .filter(inv => inv.source === 'wash')
            .reduce((sum, inv) => sum + (inv.totalAmount || inv.paidAmount || 0), 0);
        const totalGarage = paidInvoices
            .filter(inv => inv.source === 'garage')
            .reduce((sum, inv) => sum + (inv.totalAmount || inv.paidAmount || 0), 0);
        const totalParking = paidInvoices
            .filter(inv => inv.source === 'parking')
            .reduce((sum, inv) => sum + (inv.totalAmount || inv.paidAmount || 0), 0);
        const totalOther = paidInvoices
            .filter(inv => inv.source !== 'wash' && inv.source !== 'garage' && inv.source !== 'parking')
            .reduce((sum, inv) => sum + (inv.totalAmount || inv.paidAmount || 0), 0);
        
        setTotalBySource({
            wash: totalWash,
            garage: totalGarage,
            parking: totalParking,
            other: totalOther
        });
    }, [invoices]);

    // Filter invoices
    const getFilteredInvoices = () => {
        let filtered = activeTab === 'pending' ? pendingInvoices : 
                       activeTab === 'paid' ? invoices.filter(inv => inv.paymentStatus === 'paid') :
                       invoices;

        if (searchQuery) {
            const query = searchQuery.toLowerCase();
            filtered = filtered.filter(inv => 
                inv.invoiceNumber?.toLowerCase().includes(query) ||
                inv.customerName?.toLowerCase().includes(query) ||
                inv.plateNumber?.toLowerCase().includes(query) ||
                inv.mpesaCode?.toLowerCase().includes(query)
            );
        }

        if (sourceFilter !== 'all') {
            filtered = filtered.filter(inv => inv.source === sourceFilter);
        }

        if (dateFilter !== 'all') {
            const today = new Date().toISOString().split('T')[0];
            const yesterday = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            const monthAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            
            if (dateFilter === 'today') {
                filtered = filtered.filter(inv => inv.createdAt?.startsWith(today));
            } else if (dateFilter === 'yesterday') {
                filtered = filtered.filter(inv => inv.createdAt?.startsWith(yesterday));
            } else if (dateFilter === 'week') {
                filtered = filtered.filter(inv => inv.createdAt >= weekAgo);
            } else if (dateFilter === 'month') {
                filtered = filtered.filter(inv => inv.createdAt >= monthAgo);
            } else if (dateFilter === 'custom' && customDateFrom && customDateTo) {
                filtered = filtered.filter(inv => {
                    const invDate = inv.createdAt?.split('T')[0];
                    return invDate >= customDateFrom && invDate <= customDateTo;
                });
            }
        }

        // Filter by payment method
        if (paymentMethodFilter !== 'all') {
            filtered = filtered.filter(inv => {
                const method = inv.paymentMethod?.toLowerCase();
                if (paymentMethodFilter === 'cash') return method === 'cash';
                if (paymentMethodFilter === 'mpesa') return method === 'mpesa' || method === 'm-pesa';
                if (paymentMethodFilter === 'card') return method === 'card';
                if (paymentMethodFilter === 'unpaid') return !inv.paymentMethod || inv.paymentStatus !== 'paid';
                return true;
            });
        }

        return filtered;
    };

    // Get paginated invoices
    const getPaginatedInvoices = () => {
        const filtered = getFilteredInvoices();
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        return filtered.slice(startIndex, endIndex);
    };

    // Get total pages
    const getTotalPages = () => {
        const filtered = getFilteredInvoices();
        return Math.ceil(filtered.length / itemsPerPage);
    };

    // Reset page when filters change
    useEffect(() => {
        setCurrentPage(1);
    }, [searchQuery, dateFilter, sourceFilter, paymentMethodFilter, activeTab]);
    
    // Export functions
    const exportCSV = () => {
        const dataToExport = activeTab === 'expenses' ? expenses : getFilteredInvoices();
        if (activeTab === 'expenses') {
            let csv = 'Date,Category,Description,Vendor,Amount,Payment Method\n';
            dataToExport.forEach(exp => {
                csv += `"${exp.date || ''}","${exp.category || ''}","${(exp.description || '').replace(/"/g, '""')}","${exp.vendor || ''}",${exp.amount || 0},"${exp.paymentMethod || 'Cash'}"\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `expenses_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        } else {
            let csv = 'Invoice #,Customer,Phone,Vehicle,Source,Amount,Status,Payment Method,M-Pesa Code,Date\n';
            dataToExport.forEach(inv => {
                csv += `"${inv.invoiceNumber || inv.id?.slice(0,8) || ''}","${inv.customerName || 'Walk-in'}","${inv.customerPhone || ''}","${inv.plateNumber || ''}","${inv.source || ''}",${inv.totalAmount || 0},"${inv.paymentStatus || 'unpaid'}","${inv.paymentMethod || ''}","${inv.mpesaCode || ''}","${inv.createdAt?.split('T')[0] || ''}"\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `billing_${activeTab}_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }
        setShowExportMenu(false);
    };
    
    const exportPDF = () => {
        const printWindow = window.open('', '_blank');
        const dataToExport = activeTab === 'expenses' ? expenses : getFilteredInvoices();
        const reportDate = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        
        let html = `<!DOCTYPE html><html><head>
        <title>Billing Report</title>
        <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
        <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body { font-family: 'Montserrat', sans-serif; padding: 24px; background: #fff; color: #1f2937; font-size: 10px; line-height: 1.4; }
            .header { text-align: center; margin-bottom: 20px; padding-bottom: 12px; border-bottom: 2px solid #e5e7eb; }
            .header h1 { font-size: 16px; font-weight: 700; color: #111827; margin-bottom: 2px; letter-spacing: 0.5px; }
            .header .subtitle { font-size: 11px; color: #6b7280; font-weight: 500; }
            .header .generated { font-size: 8px; color: #9ca3af; margin-top: 4px; }
            
            .summary-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 16px; }
            .summary-box { background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%); border: 1px solid #e5e7eb; padding: 10px; text-align: center; }
            .summary-box.green { background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); border-color: #10b981; }
            .summary-box.blue { background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-color: #3b82f6; }
            .summary-box.orange { background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%); border-color: #f59e0b; }
            .summary-box.red { background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%); border-color: #f87171; }
            .summary-box .label { font-size: 8px; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
            .summary-box .value { font-size: 14px; font-weight: 700; color: #111827; }
            .summary-box.green .value { color: #059669; }
            .summary-box.blue .value { color: #2563eb; }
            .summary-box.orange .value { color: #d97706; }
            .summary-box.red .value { color: #dc2626; }
            
            table { width: 100%; border-collapse: collapse; font-size: 9px; margin-top: 12px; }
            th { background: #f3f4f6; font-size: 8px; font-weight: 600; color: #374151; text-transform: uppercase; letter-spacing: 0.3px; padding: 8px 6px; text-align: left; border-bottom: 2px solid #d1d5db; }
            td { padding: 6px; border-bottom: 1px solid #e5e7eb; color: #4b5563; }
            tr:nth-child(even) { background: #f9fafb; }
            .text-right { text-align: right; }
            .text-center { text-align: center; }
            .font-semibold { font-weight: 600; }
            .text-green { color: #059669; }
            .text-red { color: #dc2626; }
            .text-blue { color: #2563eb; }
            
            .status-badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 8px; font-weight: 600; text-transform: uppercase; }
            .status-paid { background: #dcfce7; color: #166534; }
            .status-pending { background: #fef3c7; color: #92400e; }
            
            .total-row { background: #f3f4f6 !important; font-weight: 600; }
            .total-row td { border-top: 2px solid #d1d5db; color: #111827; padding: 10px 6px; }
            
            .footer { margin-top: 20px; padding-top: 12px; border-top: 1px solid #e5e7eb; text-align: center; font-size: 8px; color: #9ca3af; }
            
            @media print { body { padding: 12px; } }
        </style>
        </head><body>`;
        
        if (activeTab === 'expenses') {
            const total = dataToExport.reduce((sum, e) => sum + (e.amount || 0), 0);
            const categoryTotals = {};
            dataToExport.forEach(exp => {
                const cat = exp.category || 'Other';
                categoryTotals[cat] = (categoryTotals[cat] || 0) + (exp.amount || 0);
            });
            const topCategories = Object.entries(categoryTotals).sort((a, b) => b[1] - a[1]).slice(0, 3);
            
            html += `
            <div class="header">
                <h1>üìã EXPENSES REPORT</h1>
                <div class="subtitle">${reportDate}</div>
                <div class="generated">Generated: ${new Date().toLocaleString()}</div>
            </div>
            
            <div class="summary-grid">
                <div class="summary-box red">
                    <div class="label">Total Expenses</div>
                    <div class="value">${getBrandingForReceipts().currencySymbol || 'KES'} ${total.toLocaleString()}</div>
                </div>
                <div class="summary-box">
                    <div class="label">Total Records</div>
                    <div class="value">${dataToExport.length}</div>
                </div>
                ${topCategories[0] ? `<div class="summary-box orange"><div class="label">${topCategories[0][0]}</div><div class="value">${getBrandingForReceipts().currencySymbol || 'KES'} ${topCategories[0][1].toLocaleString()}</div></div>` : '<div class="summary-box"><div class="label">-</div><div class="value">-</div></div>'}
                ${topCategories[1] ? `<div class="summary-box"><div class="label">${topCategories[1][0]}</div><div class="value">${getBrandingForReceipts().currencySymbol || 'KES'} ${topCategories[1][1].toLocaleString()}</div></div>` : '<div class="summary-box"><div class="label">-</div><div class="value">-</div></div>'}
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Category</th>
                        <th>Description</th>
                        <th>Vendor</th>
                        <th class="text-right">Amount</th>
                        <th class="text-center">Payment</th>
                    </tr>
                </thead>
                <tbody>`;
            
            dataToExport.forEach(exp => {
                html += `<tr>
                    <td class="font-semibold">${exp.date || '-'}</td>
                    <td>${exp.category || '-'}</td>
                    <td>${exp.description || '-'}</td>
                    <td>${exp.vendor || '-'}</td>
                    <td class="text-right text-red font-semibold">-${getBrandingForReceipts().currencySymbol || 'KES'} ${(exp.amount || 0).toLocaleString()}</td>
                    <td class="text-center">${exp.paymentMethod || 'Cash'}</td>
                </tr>`;
            });
            
            html += `<tr class="total-row">
                <td colspan="4" class="text-right">Grand Total:</td>
                <td class="text-right text-red">-${getBrandingForReceipts().currencySymbol || 'KES'} ${total.toLocaleString()}</td>
                <td></td>
            </tr></tbody></table>`;
        } else {
            const tabLabel = activeTab === 'paid' ? 'Paid Invoices' : activeTab === 'pending' ? 'Pending Invoices' : 'All Invoices';
            const totalAmount = dataToExport.reduce((sum, inv) => sum + (inv.totalAmount || 0), 0);
            const paidCount = dataToExport.filter(inv => inv.paymentStatus === 'paid').length;
            const paidAmount = dataToExport.filter(inv => inv.paymentStatus === 'paid').reduce((sum, inv) => sum + (inv.totalAmount || 0), 0);
            const pendingAmount = totalAmount - paidAmount;
            
            html += `
            <div class="header">
                <h1>üí≥ BILLING REPORT</h1>
                <div class="subtitle">${tabLabel} ‚Ä¢ ${reportDate}</div>
                <div class="generated">Generated: ${new Date().toLocaleString()}</div>
            </div>
            
            <div class="summary-grid">
                <div class="summary-box blue">
                    <div class="label">Total Amount</div>
                    <div class="value">${getBrandingForReceipts().currencySymbol || 'KES'} ${totalAmount.toLocaleString()}</div>
                </div>
                <div class="summary-box green">
                    <div class="label">Paid (${paidCount})</div>
                    <div class="value">${getBrandingForReceipts().currencySymbol || 'KES'} ${paidAmount.toLocaleString()}</div>
                </div>
                <div class="summary-box orange">
                    <div class="label">Pending (${dataToExport.length - paidCount})</div>
                    <div class="value">${getBrandingForReceipts().currencySymbol || 'KES'} ${pendingAmount.toLocaleString()}</div>
                </div>
                <div class="summary-box">
                    <div class="label">Total Invoices</div>
                    <div class="value">${dataToExport.length}</div>
                </div>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>Invoice #</th>
                        <th>Customer</th>
                        <th>Phone</th>
                        <th>Vehicle</th>
                        <th>Source</th>
                        <th class="text-right">Amount</th>
                        <th class="text-center">Status</th>
                        <th class="text-center">Payment</th>
                        <th>M-Pesa</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody>`;
            
            dataToExport.forEach(inv => {
                const statusClass = inv.paymentStatus === 'paid' ? 'status-paid' : 'status-pending';
                html += `<tr>
                    <td class="font-semibold text-blue">${inv.invoiceNumber || inv.id?.slice(0,8)?.toUpperCase() || '-'}</td>
                    <td>${inv.customerName || 'Walk-in'}</td>
                    <td>${inv.customerPhone || '-'}</td>
                    <td>${inv.plateNumber || '-'}</td>
                    <td>${inv.source || '-'}</td>
                    <td class="text-right font-semibold">${getBrandingForReceipts().currencySymbol || 'KES'} ${(inv.totalAmount || 0).toLocaleString()}</td>
                    <td class="text-center"><span class="status-badge ${statusClass}">${inv.paymentStatus || 'Pending'}</span></td>
                    <td class="text-center">${inv.paymentMethod || '-'}</td>
                    <td>${inv.mpesaCode || '-'}</td>
                    <td>${inv.createdAt?.split('T')[0] || '-'}</td>
                </tr>`;
            });
            
            html += `<tr class="total-row">
                <td colspan="5" class="text-right">Grand Total:</td>
                <td class="text-right">${getBrandingForReceipts().currencySymbol || 'KES'} ${totalAmount.toLocaleString()}</td>
                <td colspan="4"></td>
            </tr></tbody></table>`;
        }
        
        html += `
        <div class="footer">
            <strong>${getBrandingForReceipts().companyName } Car Wash & Garage</strong> ‚Ä¢ Billing Report ‚Ä¢ ${reportDate}
        </div>
        </body></html>`;
        
        printWindow.document.write(html);
        printWindow.document.close();
        printWindow.onload = () => { printWindow.print(); };
        setShowExportMenu(false);
    };

    // Daily Sales Report - Clean, detailed with Montserrat font
    const exportDailySalesReport = () => {
        const printWindow = window.open('', '_blank');
        const today = new Date().toISOString().split('T')[0];
        const todayFormatted = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        
        // Filter today's data
        const todaysInvoices = invoices.filter(inv => inv.createdAt?.startsWith(today));
        const todaysExpenses = expenses.filter(exp => exp.date === today);
        
        // Calculate revenue by source
        const washRevenue = todaysInvoices.filter(inv => inv.source === 'car-wash' || inv.source === 'wash').reduce((sum, inv) => sum + (inv.totalAmount || 0), 0);
        const garageRevenue = todaysInvoices.filter(inv => inv.source === 'garage').reduce((sum, inv) => sum + (inv.totalAmount || 0), 0);
        const otherRevenue = todaysInvoices.filter(inv => !['car-wash', 'wash', 'garage'].includes(inv.source)).reduce((sum, inv) => sum + (inv.totalAmount || 0), 0);
        
        // Calculate by payment status
        const paidInvoices = todaysInvoices.filter(inv => inv.paymentStatus === 'paid');
        const pendingInvoices = todaysInvoices.filter(inv => inv.paymentStatus !== 'paid');
        const totalPaid = paidInvoices.reduce((sum, inv) => sum + (inv.totalAmount || 0), 0);
        const totalPending = pendingInvoices.reduce((sum, inv) => sum + (inv.totalAmount || 0), 0);
        
        // Calculate by payment method
        const cashPayments = paidInvoices.filter(inv => inv.paymentMethod?.toLowerCase() === 'cash').reduce((sum, inv) => sum + (inv.totalAmount || 0), 0);
        const mpesaPayments = paidInvoices.filter(inv => inv.paymentMethod?.toLowerCase() === 'm-pesa' || inv.paymentMethod?.toLowerCase() === 'mpesa').reduce((sum, inv) => sum + (inv.totalAmount || 0), 0);
        
        // Calculate expenses
        const totalExpenses = todaysExpenses.reduce((sum, exp) => sum + (exp.amount || 0), 0);
        const expensesByCategory = {};
        todaysExpenses.forEach(exp => {
            const cat = exp.category || 'Other';
            expensesByCategory[cat] = (expensesByCategory[cat] || 0) + (exp.amount || 0);
        });
        
        // Net Profit
        const grossRevenue = washRevenue + garageRevenue + otherRevenue;
        const netProfit = totalPaid - totalExpenses;
        
        let html = `<!DOCTYPE html><html><head>
        <title>Daily Sales Report - ${today}</title>
        <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
        <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body { font-family: 'Montserrat', sans-serif; padding: 24px; background: #fff; color: #1f2937; font-size: 10px; line-height: 1.4; }
            .header { text-align: center; margin-bottom: 20px; padding-bottom: 12px; border-bottom: 2px solid #e5e7eb; }
            .header h1 { font-size: 16px; font-weight: 700; color: #111827; margin-bottom: 2px; letter-spacing: 0.5px; }
            .header .date { font-size: 11px; color: #6b7280; font-weight: 500; }
            .header .generated { font-size: 8px; color: #9ca3af; margin-top: 4px; }
            
            .summary-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 16px; }
            .summary-box { background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%); border: 1px solid #e5e7eb; padding: 10px; text-align: center; }
            .summary-box.highlight { background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); border-color: #10b981; }
            .summary-box.expense { background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%); border-color: #f87171; }
            .summary-box.net { background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-color: #3b82f6; }
            .summary-box .label { font-size: 8px; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
            .summary-box .value { font-size: 14px; font-weight: 700; color: #111827; }
            .summary-box.highlight .value { color: #059669; }
            .summary-box.expense .value { color: #dc2626; }
            .summary-box.net .value { color: #2563eb; }
            
            .section { margin-bottom: 16px; }
            .section-title { font-size: 10px; font-weight: 700; color: #374151; margin-bottom: 8px; padding-bottom: 4px; border-bottom: 1px solid #e5e7eb; text-transform: uppercase; letter-spacing: 0.5px; }
            
            .breakdown-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 16px; }
            .breakdown-box { background: #f9fafb; border: 1px solid #e5e7eb; padding: 8px 10px; }
            .breakdown-box .label { font-size: 8px; color: #6b7280; font-weight: 500; }
            .breakdown-box .value { font-size: 12px; font-weight: 600; color: #1f2937; }
            
            .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
            
            table { width: 100%; border-collapse: collapse; font-size: 9px; }
            th { background: #f3f4f6; font-size: 8px; font-weight: 600; color: #374151; text-transform: uppercase; letter-spacing: 0.3px; padding: 6px 8px; text-align: left; border-bottom: 1px solid #d1d5db; }
            td { padding: 5px 8px; border-bottom: 1px solid #e5e7eb; color: #4b5563; }
            tr:nth-child(even) { background: #f9fafb; }
            .text-right { text-align: right; }
            .font-semibold { font-weight: 600; }
            .text-green { color: #059669; }
            .text-red { color: #dc2626; }
            .text-orange { color: #d97706; }
            
            .total-row { background: #f3f4f6 !important; font-weight: 600; }
            .total-row td { border-top: 2px solid #d1d5db; color: #111827; }
            
            .footer { margin-top: 20px; padding-top: 12px; border-top: 1px solid #e5e7eb; text-align: center; font-size: 8px; color: #9ca3af; }
            
            @media print {
                body { padding: 12px; }
                .summary-grid { grid-template-columns: repeat(4, 1fr); }
            }
        </style>
        </head><body>
        
        <div class="header">
            <h1>üìä DAILY SALES REPORT</h1>
            <div class="date">${todayFormatted}</div>
            <div class="generated">Generated: ${new Date().toLocaleString()}</div>
        </div>
        
        <div class="summary-grid">
            <div class="summary-box highlight">
                <div class="label">Total Revenue</div>
                <div class="value">${getBrandingForReceipts().currencySymbol || 'KES'} ${grossRevenue.toLocaleString()}</div>
            </div>
            <div class="summary-box">
                <div class="label">Collected</div>
                <div class="value">${getBrandingForReceipts().currencySymbol || 'KES'} ${totalPaid.toLocaleString()}</div>
            </div>
            <div class="summary-box expense">
                <div class="label">Expenses</div>
                <div class="value">-${getBrandingForReceipts().currencySymbol || 'KES'} ${totalExpenses.toLocaleString()}</div>
            </div>
            <div class="summary-box net">
                <div class="label">Net Profit</div>
                <div class="value">${netProfit >= 0 ? '' : '-'}${getBrandingForReceipts().currencySymbol || 'KES'} ${Math.abs(netProfit).toLocaleString()}</div>
            </div>
        </div>
        
        <div class="section">
            <div class="section-title">üí∞ Revenue Breakdown</div>
            <div class="breakdown-grid">
                <div class="breakdown-box">
                    <div class="label">üöó Car Wash</div>
                    <div class="value">${getBrandingForReceipts().currencySymbol || 'KES'} ${washRevenue.toLocaleString()}</div>
                </div>
                <div class="breakdown-box">
                    <div class="label">üîß Garage</div>
                    <div class="value">${getBrandingForReceipts().currencySymbol || 'KES'} ${garageRevenue.toLocaleString()}</div>
                </div>
                <div class="breakdown-box">
                    <div class="label">üì¶ Other</div>
                    <div class="value">${getBrandingForReceipts().currencySymbol || 'KES'} ${otherRevenue.toLocaleString()}</div>
                </div>
            </div>
        </div>
        
        <div class="section">
            <div class="section-title">üí≥ Payment Methods</div>
            <div class="breakdown-grid">
                <div class="breakdown-box">
                    <div class="label">üíµ Cash</div>
                    <div class="value">${getBrandingForReceipts().currencySymbol || 'KES'} ${cashPayments.toLocaleString()}</div>
                </div>
                <div class="breakdown-box">
                    <div class="label">üì± M-Pesa</div>
                    <div class="value">${getBrandingForReceipts().currencySymbol || 'KES'} ${mpesaPayments.toLocaleString()}</div>
                </div>
                <div class="breakdown-box">
                    <div class="label">‚è≥ Pending</div>
                    <div class="value text-orange">${getBrandingForReceipts().currencySymbol || 'KES'} ${totalPending.toLocaleString()}</div>
                </div>
            </div>
        </div>
        
        <div class="two-col">
            <div class="section">
                <div class="section-title">üìã Today's Transactions (${todaysInvoices.length})</div>
                <table>
                    <thead>
                        <tr>
                            <th>Invoice</th>
                            <th>Customer</th>
                            <th>Source</th>
                            <th class="text-right">Amount</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>`;
        
        if (todaysInvoices.length === 0) {
            html += `<tr><td colspan="5" style="text-align:center;color:#9ca3af;padding:16px;">No transactions today</td></tr>`;
        } else {
            todaysInvoices.forEach(inv => {
                const statusClass = inv.paymentStatus === 'paid' ? 'text-green' : 'text-orange';
                html += `<tr>
                    <td class="font-semibold">${inv.invoiceNumber || inv.id?.slice(0,6)?.toUpperCase() || '-'}</td>
                    <td>${inv.customerName || 'Walk-in'}</td>
                    <td>${inv.source || '-'}</td>
                    <td class="text-right font-semibold">${getBrandingForReceipts().currencySymbol || 'KES'} ${(inv.totalAmount || 0).toLocaleString()}</td>
                    <td class="${statusClass}">${inv.paymentStatus || 'Pending'}</td>
                </tr>`;
            });
            html += `<tr class="total-row">
                <td colspan="3" class="text-right">Total:</td>
                <td class="text-right">${getBrandingForReceipts().currencySymbol || 'KES'} ${grossRevenue.toLocaleString()}</td>
                <td></td>
            </tr>`;
        }
        
        html += `</tbody></table>
            </div>
            
            <div class="section">
                <div class="section-title">üìâ Today's Expenses (${todaysExpenses.length})</div>
                <table>
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th>Description</th>
                            <th class="text-right">Amount</th>
                        </tr>
                    </thead>
                    <tbody>`;
        
        if (todaysExpenses.length === 0) {
            html += `<tr><td colspan="3" style="text-align:center;color:#9ca3af;padding:16px;">No expenses recorded today</td></tr>`;
        } else {
            todaysExpenses.forEach(exp => {
                html += `<tr>
                    <td class="font-semibold">${exp.category || 'Other'}</td>
                    <td>${exp.description || '-'}</td>
                    <td class="text-right text-red font-semibold">-${getBrandingForReceipts().currencySymbol || 'KES'} ${(exp.amount || 0).toLocaleString()}</td>
                </tr>`;
            });
            html += `<tr class="total-row">
                <td colspan="2" class="text-right">Total Expenses:</td>
                <td class="text-right text-red">-${getBrandingForReceipts().currencySymbol || 'KES'} ${totalExpenses.toLocaleString()}</td>
            </tr>`;
        }
        
        html += `</tbody></table>
            </div>
        </div>
        
        <div class="footer">
            <strong>${getBrandingForReceipts().companyName } Car Wash & Garage</strong> ‚Ä¢ Daily Sales Report ‚Ä¢ ${todayFormatted}
        </div>
        
        </body></html>`;
        
        printWindow.document.write(html);
        printWindow.document.close();
        printWindow.onload = () => { printWindow.print(); };
        setShowExportMenu(false);
    };

    // Handle cash payment
    const handleCashPayment = async () => {
        if (!selectedInvoice) return;
        
        setActionLoading(true);
        try {
            const services = window.FirebaseServices;
            const result = await services.billingService.markAsPaid(selectedInvoice.id, {
                method: 'cash',
                amount: selectedInvoice.totalAmount
            });
            
            if (result.success) {
                // Log strictly to billing activity log
                await logBillingActivity('PAYMENT_RECEIVED', selectedInvoice, { 
                    paymentMethod: 'cash',
                    amount: selectedInvoice.totalAmount
                });
                
                // Award loyalty points if customer has phone number
                if (selectedInvoice.customerPhone) {
                    try {
                        const customerResult = await services.customerService.findCustomerByPhone(selectedInvoice.customerPhone);
                        if (customerResult.success && customerResult.data) {
                            // Award 1 point per 100 KES spent
                            const pointsToAward = Math.floor((selectedInvoice.totalAmount || 0) / 100);
                            if (pointsToAward > 0) {
                                await services.customerService.addLoyaltyPoints(
                                    customerResult.data.id, 
                                    pointsToAward, 
                                    `Invoice ${selectedInvoice.invoiceNumber} payment`
                                );
                                await services.billingService.updateInvoice(selectedInvoice.id, {
                                    customerId: customerResult.data.id,
                                    pointsEarned: pointsToAward
                                });
                            }
                        }
                    } catch (loyaltyErr) {
                        console.log('Loyalty points error (non-critical):', loyaltyErr);
                    }
                }
                setSuccessMessage('Payment recorded successfully!');
                setShowPaymentModal(false);
                setSelectedInvoice(null);
            } else {
                setError(result.error || 'Failed to record payment');
            }
        } catch (err) {
            setError('Failed to record payment');
        } finally {
            setActionLoading(false);
        }
    };

    // Handle M-Pesa payment initiation
    const handleMpesaPayment = async () => {
        if (!selectedInvoice || !mpesaPhone) return;
        
        const phoneRegex = /^(?:254|\+254|0)?([17]\d{8})$/;
        if (!phoneRegex.test(mpesaPhone.replace(/\s/g, ''))) {
            setError('Please enter a valid Kenyan phone number');
            return;
        }

        setMpesaLoading(true);
        setMpesaStatus({ status: 'initiating', message: 'Initiating M-Pesa payment...' });
        
        try {
            const services = window.FirebaseServices;
            const formattedPhone = mpesaPhone.replace(/\s/g, '').replace(/^0/, '254').replace(/^\+/, '');
            
            const result = await services.billingService.initiateMpesaPayment(
                selectedInvoice.id,
                formattedPhone,
                selectedInvoice.totalAmount
            );
            
            if (result.success) {
                setMpesaPaymentId(result.paymentId);
                setMpesaStatus({ 
                    status: 'pending', 
                    message: 'STK Push sent! Please check your phone and enter your M-Pesa PIN.'
                });
                
                const unsubPayment = services.billingService.subscribeToMpesaPayment(result.paymentId, (payment) => {
                    if (payment.status === 'completed') {
                        setMpesaStatus({ 
                            status: 'success', 
                            message: `Payment successful! Receipt: ${payment.mpesaReceiptNumber}` 
                        });
                        
                        // Log success
                        logBillingActivity('PAYMENT_RECEIVED', selectedInvoice, {
                            paymentMethod: 'm-pesa',
                            mpesaCode: payment.mpesaReceiptNumber,
                            mpesaPhone: formattedPhone
                        });

                        setSuccessMessage('M-Pesa payment received!');
                        setTimeout(() => {
                            setShowMpesaModal(false);
                            setSelectedInvoice(null);
                            setMpesaPhone('');
                            setMpesaStatus(null);
                            setMpesaPaymentId(null);
                        }, 2000);
                        unsubPayment();
                    } else if (payment.status === 'failed') {
                        setMpesaStatus({ status: 'failed', message: payment.resultDesc || 'Payment failed' });
                    }
                });
            } else {
                setMpesaStatus({ status: 'failed', message: result.error || 'Failed to initiate payment' });
            }
        } catch (err) {
            setMpesaStatus({ status: 'failed', message: 'Failed to initiate M-Pesa payment' });
        } finally {
            setMpesaLoading(false);
        }
    };

    // Simulate M-Pesa callback (for testing)
    const handleSimulateMpesaSuccess = async () => {
        if (!mpesaPaymentId) return;
        
        setMpesaStatus({ status: 'processing', message: 'Processing payment...' });
        const services = window.FirebaseServices;
        await services.billingService.simulateMpesaCallback(mpesaPaymentId, true);
    };

    // Open payment modal
    const openPaymentModal = (invoice) => {
        setSelectedInvoice(invoice);
        setShowPaymentModal(true);
    };

    // Open M-Pesa modal
    const openMpesaModal = () => {
        setShowPaymentModal(false);
        setMpesaPhone(selectedInvoice?.customerPhone || '');
        setMpesaStatus(null);
        setMpesaPaymentId(null);
        setMpesaMode('stk');
        setManualMpesaCode('');
        setShowMpesaModal(true);
    };

    // Open Card Payment modal
    const openCardModal = () => {
        setShowPaymentModal(false);
        setCardDetails({ lastFourDigits: '', transactionRef: '' });
        setShowCardModal(true);
    };

    // Handle manual M-Pesa code entry
    const handleManualMpesaPayment = async () => {
        if (!selectedInvoice || !manualMpesaCode.trim()) return;
        
        // Validate M-Pesa code format (typically 10 alphanumeric characters)
        const codeRegex = /^[A-Z0-9]{10,}$/i;
        if (!codeRegex.test(manualMpesaCode.trim())) {
            setError('Please enter a valid M-Pesa transaction code (e.g., QJK3L5M7N9)');
            return;
        }

        setMpesaLoading(true);
        try {
            const services = window.FirebaseServices;
            const result = await services.billingService.markAsPaid(selectedInvoice.id, {
                method: 'm-pesa',
                amount: selectedInvoice.totalAmount,
                mpesaCode: manualMpesaCode.trim().toUpperCase(),
                mpesaPhone: mpesaPhone || null
            });
            
            if (result.success) {
                // Log billing activity
                await logBillingActivity('PAYMENT_RECEIVED', selectedInvoice, { 
                    paymentMethod: 'm-pesa',
                    mpesaCode: manualMpesaCode.trim().toUpperCase(),
                    mpesaPhone: mpesaPhone || null
                });
                
                setSuccessMessage('M-Pesa payment recorded successfully!');
                setShowMpesaModal(false);
                setSelectedInvoice(null);
                setManualMpesaCode('');
                setMpesaPhone('');
            } else {
                setError(result.error || 'Failed to record payment');
            }
        } catch (err) {
            setError('Failed to record M-Pesa payment');
        } finally {
            setMpesaLoading(false);
        }
    };

    // Handle card payment
    const handleCardPayment = async () => {
        if (!selectedInvoice) return;
        
        if (!cardDetails.transactionRef.trim()) {
            setError('Please enter the transaction reference');
            return;
        }

        setActionLoading(true);
        try {
            const services = window.FirebaseServices;
            const result = await services.billingService.markAsPaid(selectedInvoice.id, {
                method: 'card',
                amount: selectedInvoice.totalAmount,
                cardLastFour: cardDetails.lastFourDigits || null,
                transactionRef: cardDetails.transactionRef.trim()
            });
            
            if (result.success) {
                // Log billing activity
                await logBillingActivity('PAYMENT_RECEIVED', selectedInvoice, { 
                    paymentMethod: 'card',
                    cardLastFour: cardDetails.lastFourDigits || null,
                    transactionRef: cardDetails.transactionRef.trim()
                });
                
                setSuccessMessage('Card payment recorded successfully!');
                setShowCardModal(false);
                setSelectedInvoice(null);
                setCardDetails({ lastFourDigits: '', transactionRef: '' });
            } else {
                setError(result.error || 'Failed to record payment');
            }
        } catch (err) {
            setError('Failed to record card payment');
        } finally {
            setActionLoading(false);
        }
    };

    // View invoice details
    const viewInvoiceDetails = (invoice) => {
        setSelectedInvoice(invoice);
        setShowInvoiceDetailModal(true);
    };

    // Delete invoice
    // Open delete confirmation modal (Anti-theft: requires reason)
    const handleDeleteInvoice = (invoice) => {
        setDeleteTarget(invoice);
        setDeleteReason('');
        setShowDeleteModal(true);
    };
    
    // Confirm delete with reason and log activity
    const confirmDeleteInvoice = async () => {
        if (!deleteTarget || !deleteReason.trim()) {
            setError('Please provide a reason for deletion');
            return;
        }
        
        if (deleteReason.trim().length < 10) {
            setError('Reason must be at least 10 characters');
            return;
        }
        
        setDeleteLoading(true);
        try {
            const services = window.FirebaseServices;

            // Log activity first (Anti-Theft intent)
            // We pass the reason and special action 'DELETE_INVOICE'
            await logBillingActivity('DELETE_INVOICE', deleteTarget, {
                reason: deleteReason.trim()
            });
            
            // Now delete the invoice
            const result = await services.billingService.deleteInvoice(deleteTarget.id);
            if (result.success) {
                setSuccessMessage('Invoice deleted. Activity logged for audit.');
                setShowDeleteModal(false);
                setDeleteTarget(null);
                setDeleteReason('');
                // Refresh activity logs if on activity tab
                if (activeTab === 'activity') {
                    loadBillingActivityLogs();
                }
            } else {
                setError(result.error || 'Failed to delete invoice');
            }
        } catch (err) {
            console.error('Delete error:', err);
            setError('Failed to delete invoice: ' + err.message);
        } finally {
            setDeleteLoading(false);
        }
    };
    
    // Load billing activity logs
    const loadBillingActivityLogs = async () => {
        setActivityLogsLoading(true);
        try {
            const services = window.FirebaseServices;
            const { db, collection, getDocs, query, orderBy, limit } = services.firestore;
            const logsQuery = query(
                collection(db, 'billing_activity_logs'),
                orderBy('timestamp', 'desc'),
                limit(100)
            );
            const snapshot = await getDocs(logsQuery);
            const logs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setBillingActivityLogs(logs);
        } catch (err) {
            console.error('Failed to load activity logs:', err);
        } finally {
            setActivityLogsLoading(false);
        }
    };
    
    // Load activity logs when switching to activity tab
    useEffect(() => {
        if (activeTab === 'activity') {
            loadBillingActivityLogs();
        }
    }, [activeTab]);
    
    // Helper function to log billing activity (payments, deletions, etc.)
    const logBillingActivity = async (action, invoice, extraData = {}) => {
        try {
            const services = window.FirebaseServices;
            const authUser = services.auth?.currentUser;
            const userProfile = window.currentUserProfile;
            
            // Robust user identification
            const userEmail = authUser?.email || userProfile?.email || 'No email';
            // Try to get a real name, fallback to email prefix, then 'User'
            const userName = userProfile?.name || authUser?.displayName || (userEmail.indexOf('@') > 0 ? userEmail.split('@')[0] : 'User');
            const userId = authUser?.uid || userProfile?.id || 'unknown';
            
            const activityLog = {
                action: action, // 'PAYMENT_RECEIVED', 'DELETE_INVOICE', 'PAYMENT_REVERTED'
                invoiceId: invoice.id,
                invoiceNumber: invoice.invoiceNumber || invoice.id?.slice(0, 8).toUpperCase(),
                invoiceData: {
                    customerName: invoice.customerName || 'Walk-in',
                    customerPhone: invoice.customerPhone || '',
                    plateNumber: invoice.plateNumber || '',
                    totalAmount: invoice.totalAmount || 0,
                    paymentStatus: invoice.paymentStatus || 'unpaid',
                    // Prioritize passed payment method, else invoice's current method
                    paymentMethod: extraData.paymentMethod || invoice.paymentMethod || '',
                    source: invoice.source || 'wash',
                    // Store strict values if provided
                    mpesaCode: extraData.mpesaCode || invoice.mpesaCode || '',
                    transactionRef: extraData.transactionRef || invoice.transactionRef || ''
                },
                ...extraData, // Spread extra data like reason, codes etc.
                // Unified user identity field
                processedBy: {
                    uid: userId,
                    email: userEmail,
                    displayName: userName
                },
                // Backward compatibility for deletion logs if needed by other tools
                deletedBy: action === 'DELETE_INVOICE' ? {
                    uid: userId,
                    email: userEmail,
                    displayName: userName
                } : null,
                
                timestamp: new Date().toISOString(),
                date: new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }),
                time: new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' })
            };
            
            const { db, collection, addDoc } = services.firestore;
            await addDoc(collection(db, 'billing_activity_logs'), activityLog);
            console.log('Activity logged:', action);
        } catch (err) {
            console.error('Failed to log billing activity:', err);
        }
    };

    // Cancel/Revert payment to unpaid
    const handleCancelPayment = async (invoice) => {
        showAlert(
            'Revert Payment',
            `Revert payment for ${invoice.invoiceNumber}? This will set the invoice back to unpaid.`,
            'warning',
            async () => {
                setActionLoading(true);
                try {
                    const services = window.FirebaseServices;
                    const result = await services.billingService.revertToUnpaid(invoice.id);
                    if (result.success) {
                        // Log the reversion
                        await logBillingActivity('PAYMENT_REVERTED', invoice);
                        
                        setSuccessMessage('Payment cancelled - invoice set to unpaid');
                        // Refresh if needed
                        if (activeTab === 'activity') loadBillingActivityLogs();
                    } else {
                        setError(result.error || 'Failed to cancel payment');
                    }
                } catch (err) {
                    setError('Failed to cancel payment');
                } finally {
                    setActionLoading(false);
                }
            },
            true
        );
    };

    // Print invoice receipt
    const handlePrintReceipt = async (invoice) => {
        const receiptWindow = window.open('', '_blank', 'width=400,height=600');
        const servicesList = invoice.services?.map(s => 
            `<tr><td style="padding:8px 0;border-bottom:1px dashed #ddd;">${s.name}</td><td style="padding:8px 0;border-bottom:1px dashed #ddd;text-align:right;">${getBrandingForReceipts().currencySymbol || 'KES'} ${parseFloat(s.price).toLocaleString()}</td></tr>`
        ).join('') || '<tr><td colspan="2">-</td></tr>';
        
        // Fetch customer loyalty data - try multiple methods to find customer
        let loyaltyData = null;
        let customer = null;
        let customerPhone = invoice.customerPhone || '';
        const services = window.FirebaseServices;
        
        try {
            // Method 1: Try by customerId if stored on invoice
            if (invoice.customerId) {
                const allCustomersResult = await services.customerService.getCustomers();
                if (allCustomersResult.success && allCustomersResult.data) {
                    customer = allCustomersResult.data.find(c => c.id === invoice.customerId);
                }
            }
            
            // Method 2: Try by phone number
            if (!customer && invoice.customerPhone) {
                const customerResult = await services.customerService.findCustomerByPhone(invoice.customerPhone);
                if (customerResult.success && customerResult.data) {
                    customer = customerResult.data;
                }
            }
            
            // Method 3: Try by customer name (get all customers once and search)
            if (!customer && invoice.customerName && invoice.customerName !== 'Walk-in' && invoice.customerName !== 'Walk-in Customer') {
                const allCustomersResult = await services.customerService.getCustomers();
                if (allCustomersResult.success && allCustomersResult.data) {
                    customer = allCustomersResult.data.find(c => 
                        c.name?.toLowerCase() === invoice.customerName?.toLowerCase()
                    );
                }
            }
            
            // Method 4: Try to get phone from vehicle intake record
            if (!customerPhone && invoice.plateNumber) {
                try {
                    // Try to find the intake record by plate number
                    const intakeResult = await services.intakeRecordsService?.findByPlateNumber?.(invoice.plateNumber);
                    if (intakeResult?.success && intakeResult?.data?.customerPhone) {
                        customerPhone = intakeResult.data.customerPhone;
                    }
                } catch (e) { 
                    console.log('Could not fetch intake record'); 
                }
            }
            
            // If customer found, get their phone and build loyalty data
            if (customer) {
                // Use customer's phone if we don't have one yet
                if (!customerPhone && customer.phone) {
                    customerPhone = customer.phone;
                }
                
                // Fetch loyalty settings
                let loyaltySettings = { enabled: true, pointsPerVisit: 1, rewardThreshold: 20 };
                try {
                    const settingsResult = await services.loyaltySettingsService.getSettings();
                    if (settingsResult.success && settingsResult.data) {
                        loyaltySettings = settingsResult.data;
                    }
                } catch (e) { console.log('Using default loyalty settings'); }
                
                const currentPoints = customer.loyaltyPoints || 0;
                const totalVisits = customer.totalVisits || 0;
                const rewardThreshold = loyaltySettings.rewardThreshold || 20;
                const pointsToReward = Math.max(0, rewardThreshold - currentPoints);
                
                loyaltyData = {
                    enabled: loyaltySettings.enabled !== false,
                    currentPoints,
                    totalVisits,
                    rewardThreshold,
                    pointsToReward,
                    qualifiesForReward: currentPoints >= rewardThreshold,
                    pendingReward: customer.pendingReward || null,
                    customerName: customer.name || invoice.customerName
                };
            }
        } catch (e) {
            console.log('Could not fetch loyalty data:', e);
        }
        
        // Build loyalty section HTML
        let loyaltySection = '';
        if (loyaltyData && loyaltyData.enabled) {
            const progressPercent = Math.min(100, (loyaltyData.currentPoints / loyaltyData.rewardThreshold) * 100);
            
            loyaltySection = `
                <div style="border-top:2px dashed #ccc; margin-top:15px; padding-top:15px;">
                    <div style="font-size:11px; color:#666; text-align:center; text-transform:uppercase; letter-spacing:1px; margin-bottom:12px;">‚≠ê Loyalty Program ‚≠ê</div>
                    
                    <!-- Points Earned Highlight Box -->
                    <div style="background:linear-gradient(135deg, #fef3c7, #fde68a); padding:15px; text-align:center; margin-bottom:12px; border-radius:8px; border:2px solid #f59e0b;">
                        <div style="font-size:10px; color:#92400e; text-transform:uppercase; letter-spacing:1px; margin-bottom:4px;">Points Earned</div>
                        <div style="font-size:28px; font-weight:800; color:#d97706;">üèÜ ${loyaltyData.currentPoints}</div>
                        <div style="font-size:10px; color:#92400e; margin-top:2px;">Total Loyalty Points</div>
                    </div>
                    
                    <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:8px; padding:0 4px;">
                        <span style="color:#666;">Total Visits:</span>
                        <span style="font-weight:600;">${loyaltyData.totalVisits}</span>
                    </div>
                    
                    ${!loyaltyData.qualifiesForReward && loyaltyData.pointsToReward > 0 ? `
                    <div style="background:#f5f5f5; padding:10px; text-align:center; margin-top:10px; border-radius:6px;">
                        <div style="font-size:11px; color:#666; margin-bottom:6px;">üéØ ${loyaltyData.pointsToReward} more point${loyaltyData.pointsToReward !== 1 ? 's' : ''} to earn a reward!</div>
                        <div style="background:#e5e5e5; height:10px; border-radius:5px; overflow:hidden;">
                            <div style="width:${progressPercent}%; height:100%; background:#f59e0b; border-radius:5px;"></div>
                        </div>
                        <div style="font-size:10px; color:#666; margin-top:4px;">${loyaltyData.currentPoints} / ${loyaltyData.rewardThreshold} points</div>
                    </div>
                    ` : ''}
                    
                    ${loyaltyData.qualifiesForReward && !loyaltyData.pendingReward ? `
                    <div style="background:#dcfce7; padding:12px; text-align:center; margin-top:10px; border-radius:6px; border:1px solid #22c55e;">
                        <div style="font-size:20px; margin-bottom:4px;">üéÅ</div>
                        <div style="font-size:13px; font-weight:600; color:#166534;">Congratulations!</div>
                        <div style="font-size:11px; color:#15803d;">You qualify for a reward!</div>
                        <div style="font-size:10px; color:#166534; margin-top:4px;">Please ask staff to redeem.</div>
                    </div>
                    ` : ''}
                    
                    ${loyaltyData.pendingReward ? `
                    <div style="background:#dbeafe; padding:12px; text-align:center; margin-top:10px; border-radius:6px; border:1px solid #3b82f6;">
                        <div style="font-size:20px; margin-bottom:4px;">üéâ</div>
                        <div style="font-size:13px; font-weight:600; color:#1e40af;">Reward Pending</div>
                        <div style="font-size:11px; color:#1d4ed8;">${loyaltyData.pendingReward.rewardType || 'Reward'}</div>
                        <div style="font-size:10px; color:#1e40af; margin-top:4px;">Status: ${loyaltyData.pendingReward.delivered ? '‚úÖ Delivered' : '‚è≥ Awaiting Delivery'}</div>
                    </div>
                    ` : ''}
                </div>
            `;
        }
        
        // Get current logged in user for "Served by"
        const currentUser = window.currentUserProfile;
        const servedBy = currentUser?.displayName || currentUser?.email?.split('@')[0] || 'Staff';
        
        receiptWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>Receipt - ${invoice.invoiceNumber}</title>
                <style>
                    body { font-family: 'Courier New', monospace; padding: 20px; max-width: 350px; margin: 0 auto; }
                    .header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 15px; margin-bottom: 15px; }
                    .logo { font-size: 24px; font-weight: bold; }
                    .tagline { font-size: 12px; color: #666; }
                    .info-row { display: flex; justify-content: space-between; margin: 8px 0; font-size: 13px; }
                    .services { width: 100%; border-collapse: collapse; margin: 15px 0; }
                    .total-row { font-size: 18px; font-weight: bold; border-top: 2px solid #000; padding-top: 10px; margin-top: 10px; }
                    .footer { text-align: center; margin-top: 20px; font-size: 11px; color: #666; }
                    .paid-stamp { text-align: center; padding: 10px; background: #d1fae5; color: #059669; font-weight: bold; margin: 15px 0; }
                    @media print { body { padding: 0; } }
                </style>
            </head>
            <body>
                <div class="header">
                    <div class="logo">${getBrandingForReceipts().companyName?.toUpperCase() }</div>
                    <div class="tagline">${getBrandingForReceipts().tagline || 'Car Wash & Auto Services'}</div>
                </div>
                
                <div class="info-row"><span>Receipt #:</span><span>${invoice.invoiceNumber}</span></div>
                <div class="info-row"><span>Date:</span><span>${new Date(invoice.createdAt).toLocaleDateString()}</span></div>
                <div class="info-row"><span>Customer:</span><span>${invoice.customerName || 'Walk-in'}</span></div>
                <div class="info-row"><span>Phone:</span><span>${customerPhone || '-'}</span></div>
                <div class="info-row"><span>Vehicle:</span><span>${invoice.plateNumber || '-'}</span></div>
                <div class="info-row"><span>Source:</span><span>${(invoice.source || 'wash').toUpperCase()}</span></div>
                <div class="info-row"><span>Served by:</span><span>${servedBy}</span></div>
                
                <table class="services">
                    <thead><tr><th style="text-align:left;padding:8px 0;border-bottom:2px solid #000;">Service</th><th style="text-align:right;padding:8px 0;border-bottom:2px solid #000;">Amount</th></tr></thead>
                    <tbody>${servicesList}</tbody>
                </table>
                
                <div class="total-row info-row"><span>TOTAL:</span><span>${getBrandingForReceipts().currencySymbol || 'KES'} ${parseFloat(invoice.totalAmount).toLocaleString()}</span></div>
                
                <div class="paid-stamp">‚úì PAID - ${(invoice.paymentMethod || 'CASH').toUpperCase()}</div>
                ${invoice.mpesaCode ? `<div class="info-row"><span>M-Pesa Code:</span><span>${invoice.mpesaCode}</span></div>` : ''}
                <div class="info-row"><span>Paid At:</span><span>${invoice.paidAt ? new Date(invoice.paidAt).toLocaleString() : '-'}</span></div>
                
                ${loyaltySection}
                
                <div class="footer">
                    <p>Thank you for your business!</p>
                    <p>Visit us again at ${getBrandingForReceipts().companyName }</p>
                </div>
                
                <script>setTimeout(() => window.print(), 500);</script>
            </body>
            </html>
        `);
        receiptWindow.document.close();
    };

    // Handle manual billing form change
    const handleManualBillingChange = (field, value) => {
        setManualBillingData(prev => ({ ...prev, [field]: value }));
    };

    // Search intake records for plate number (for manual billing)
    const handleBillingPlateSearch = async (searchTerm) => {
        if (!searchTerm || searchTerm.length < 2) {
            setBillingPlateSearchResults([]);
            setShowBillingPlateSearch(false);
            setExistingPendingInvoice(null);
            return;
        }
        
        const services = window.FirebaseServices;
        if (!services?.intakeRecordsService) return;
        
        try {
            const result = await services.intakeRecordsService.searchByPlate(searchTerm);
            if (result.success) {
                setBillingPlateSearchResults(result.data);
                setShowBillingPlateSearch(result.data.length > 0);
            }
            
            // Also search for existing pending invoices for this plate
            const plateUpper = searchTerm.toUpperCase();
            const existingPending = pendingInvoices.find(inv => 
                inv.plateNumber?.toUpperCase() === plateUpper && 
                (inv.paymentStatus === 'unpaid' || inv.paymentStatus === 'pending' || !inv.paymentStatus)
            );
            setExistingPendingInvoice(existingPending || null);
            if (existingPending) {
                setApplyToExisting(true); // Default to applying to existing
                // Auto-set payment status to 'paid' since we're applying to existing
                setManualBillingData(prev => ({ ...prev, paymentStatus: 'paid', paymentMethod: 'cash' }));
            }
        } catch (err) {
            console.error('Error searching vehicles for billing:', err);
        }
    };

    // Handle plate input change with debounced search
    const handleBillingPlateInputChange = (value) => {
        setManualBillingData(prev => ({ ...prev, plateNumber: value }));
        setSelectedIntakeRecord(null);
        setExistingPendingInvoice(null);
        
        // Clear previous timeout
        if (billingPlateSearchTimeout.current) {
            clearTimeout(billingPlateSearchTimeout.current);
        }
        
        // Debounce the search
        billingPlateSearchTimeout.current = setTimeout(() => {
            handleBillingPlateSearch(value);
        }, 300);
    };

    // Select an existing vehicle/carpet from search results for billing
    const selectIntakeRecordForBilling = (record) => {
        setSelectedIntakeRecord(record);
        setManualBillingData(prev => ({
            ...prev,
            plateNumber: record.plateNumber,
            customerName: record.customerName || prev.customerName,
            customerPhone: record.customerPhone || prev.customerPhone,
            vehicleType: record.itemType || record.vehicleType || prev.vehicleType,
            source: record.category === 'carpet' ? 'wash' : (record.source || prev.source)
        }));
        setShowBillingPlateSearch(false);
        
        // Check for existing pending invoice for this plate
        const plateUpper = record.plateNumber?.toUpperCase();
        const existingPending = pendingInvoices.find(inv => 
            inv.plateNumber?.toUpperCase() === plateUpper && 
            (inv.paymentStatus === 'unpaid' || inv.paymentStatus === 'pending' || !inv.paymentStatus)
        );
        setExistingPendingInvoice(existingPending || null);
        if (existingPending) {
            setApplyToExisting(true);
            // Auto-set payment status to 'paid' since we're applying to existing
            setManualBillingData(prev => ({ ...prev, paymentStatus: 'paid', paymentMethod: 'cash' }));
        }
    };

    // Clear selected intake record
    const clearSelectedIntakeRecord = () => {
        setSelectedIntakeRecord(null);
        setExistingPendingInvoice(null);
        setApplyToExisting(true);
        setManualBillingData(prev => ({
            ...prev,
            customerName: '',
            customerPhone: '',
            vehicleType: 'Sedan',
            paymentStatus: 'unpaid' // Reset to default unpaid state
        }));
    };

    // Add service line to manual billing
    // Toggle service selection
    const toggleServiceSelection = (serviceId) => {
        setManualBillingData(prev => {
            const isSelected = prev.selectedServices.includes(serviceId);
            return {
                ...prev,
                selectedServices: isSelected 
                    ? prev.selectedServices.filter(id => id !== serviceId)
                    : [...prev.selectedServices, serviceId]
            };
        });
    };

    // Get selected services with details (from either wash or garage services based on source)
    const getSelectedServicesDetails = () => {
        const allServices = [...servicePackages, ...garageServices];
        return manualBillingData.selectedServices
            .map(id => allServices.find(s => s.id === id))
            .filter(Boolean);
    };

    // Calculate total for manual billing
    const getManualBillingTotal = () => {
        return getSelectedServicesDetails().reduce((sum, s) => sum + (parseFloat(s.price) || 0), 0);
    };

    // Submit manual billing
    const handleSubmitManualBilling = async () => {
        if (!manualBillingData.plateNumber?.trim()) {
            setError('Please enter a plate number');
            return;
        }
        
        // If applying to existing invoice, we don't need services selected
        if (!applyToExisting || !existingPendingInvoice) {
            const selectedServices = getSelectedServicesDetails();
            if (selectedServices.length === 0) {
                setError('Please select at least one service');
                return;
            }
        }

        setActionLoading(true);
        try {
            const services = window.FirebaseServices;
            const currentUser = window.currentUserProfile;
            
            // If there's an existing pending invoice and user wants to apply payment to it
            if (existingPendingInvoice && applyToExisting && manualBillingData.paymentStatus === 'paid') {
                // Apply payment to the existing invoice instead of creating a new one
                const paymentData = {
                    method: manualBillingData.paymentMethod || 'cash',
                    amount: existingPendingInvoice.totalAmount
                };
                
                // Add M-Pesa code if applicable
                if (manualBillingData.paymentMethod === 'mpesa' && manualBillingData.mpesaCode) {
                    paymentData.mpesaCode = manualBillingData.mpesaCode.toUpperCase();
                    paymentData.mpesaPhone = manualBillingData.customerPhone || null;
                }
                
                // Add card reference if applicable
                if (manualBillingData.paymentMethod === 'card' && manualBillingData.cardReference) {
                    paymentData.transactionRef = manualBillingData.cardReference.toUpperCase();
                }
                
                const result = await services.billingService.markAsPaid(existingPendingInvoice.id, paymentData);
                
                if (result.success) {
                    // Log activity
                    if (services.activityService) {
                        services.activityService.logActivity({
                            type: 'billing',
                            action: 'Payment Received',
                            details: `Invoice ${existingPendingInvoice.invoiceNumber}: ${getBrandingForReceipts().currencySymbol || 'KES'} ${existingPendingInvoice.totalAmount?.toLocaleString()} (${manualBillingData.paymentMethod?.toUpperCase() || 'Cash'}) - Applied to existing invoice`,
                            status: 'success',
                            loggedBy: currentUser?.displayName || currentUser?.email?.split('@')[0] || 'System',
                            loggedByEmail: currentUser?.email || null,
                            loggedByRole: currentUser?.role || null
                        });
                    }
                    
                    // Award loyalty points if customer has phone number
                    if (existingPendingInvoice.customerPhone || manualBillingData.customerPhone) {
                        try {
                            const phone = existingPendingInvoice.customerPhone || manualBillingData.customerPhone;
                            const customerResult = await services.customerService.findCustomerByPhone(phone);
                            if (customerResult.success && customerResult.data) {
                                const pointsToAward = Math.floor((existingPendingInvoice.totalAmount || 0) / 100);
                                if (pointsToAward > 0) {
                                    await services.customerService.addLoyaltyPoints(
                                        customerResult.data.id, 
                                        pointsToAward, 
                                        `Invoice ${existingPendingInvoice.invoiceNumber} payment`
                                    );
                                    await services.billingService.updateInvoice(existingPendingInvoice.id, {
                                        customerId: customerResult.data.id,
                                        pointsEarned: pointsToAward
                                    });
                                }
                            }
                        } catch (loyaltyErr) {
                            console.log('Loyalty points error (non-critical):', loyaltyErr);
                        }
                    }
                    
                    setSuccessMessage(`Payment applied to invoice ${existingPendingInvoice.invoiceNumber}!`);
                    setShowManualBillingModal(false);
                    // Reset form
                    setManualBillingData({
                        customerName: '',
                        customerPhone: '',
                        plateNumber: '',
                        vehicleType: 'Sedan',
                        source: 'wash',
                        selectedServices: [],
                        notes: '',
                        paymentStatus: 'unpaid',
                        paymentMethod: 'cash',
                        mpesaCode: '',
                        cardReference: ''
                    });
                    setBillingPlateSearchResults([]);
                    setShowBillingPlateSearch(false);
                    setSelectedIntakeRecord(null);
                    setExistingPendingInvoice(null);
                    setApplyToExisting(true);
                } else {
                    setError(result.error || 'Failed to apply payment');
                }
            } else {
                // Create a new invoice (original behavior)
                const selectedServices = getSelectedServicesDetails();
                const totalAmount = selectedServices.reduce((sum, s) => sum + parseFloat(s.price), 0);
                const servicesList = selectedServices.map(s => ({ name: s.name, price: s.price }));

                const result = await services.billingService.createInvoice({
                    source: manualBillingData.source || 'wash',
                    customerName: manualBillingData.customerName || 'Walk-in',
                    customerPhone: manualBillingData.customerPhone || '',
                    plateNumber: manualBillingData.plateNumber.toUpperCase(),
                    vehicleType: manualBillingData.vehicleType || 'Vehicle',
                    services: servicesList,
                    totalAmount: totalAmount,
                    notes: manualBillingData.notes || '',
                    createdBy: 'manual',
                    // Payment info
                    paymentStatus: manualBillingData.paymentStatus,
                    paymentMethod: manualBillingData.paymentStatus === 'paid' ? manualBillingData.paymentMethod : null,
                    paidAmount: manualBillingData.paymentStatus === 'paid' ? totalAmount : 0,
                    paidAt: manualBillingData.paymentStatus === 'paid' ? new Date().toISOString() : null,
                    mpesaCode: manualBillingData.paymentMethod === 'mpesa' && manualBillingData.paymentStatus === 'paid' ? manualBillingData.mpesaCode : null,
                    cardReference: manualBillingData.paymentMethod === 'card' && manualBillingData.paymentStatus === 'paid' ? manualBillingData.cardReference : null
                });

                if (result.success) {
                    // Log activity
                    if (services.activityService) {
                        services.activityService.logActivity({
                            type: 'billing',
                            action: 'Invoice Created',
                            details: `${manualBillingData.plateNumber.toUpperCase()} - ${getBrandingForReceipts().currencySymbol || 'KES'} ${totalAmount.toLocaleString()} - ${manualBillingData.paymentStatus === 'paid' ? 'Paid' : 'Pending'}`,
                            status: 'success',
                            loggedBy: currentUser?.displayName || currentUser?.email?.split('@')[0] || 'System',
                            loggedByEmail: currentUser?.email || null,
                            loggedByRole: currentUser?.role || null
                        });
                    }
                    
                    // Award loyalty points if invoice is paid and has customer phone
                    if (manualBillingData.paymentStatus === 'paid' && manualBillingData.customerPhone) {
                        try {
                            const customerResult = await services.customerService.findCustomerByPhone(manualBillingData.customerPhone);
                            if (customerResult.success && customerResult.data) {
                                // Award 1 point per 100 KES spent
                                const pointsToAward = Math.floor(totalAmount / 100);
                                if (pointsToAward > 0) {
                                    await services.customerService.addLoyaltyPoints(
                                        customerResult.data.id, 
                                        pointsToAward, 
                                        `Invoice ${result.invoiceNumber} payment`
                                    );
                                    // Update invoice with points earned and customer ID
                                    await services.billingService.updateInvoice(result.id, {
                                        customerId: customerResult.data.id,
                                        pointsEarned: pointsToAward
                                    });
                                }
                            }
                        } catch (loyaltyErr) {
                            console.log('Loyalty points error (non-critical):', loyaltyErr);
                        }
                    }
                    setSuccessMessage(`Invoice ${result.invoiceNumber} created successfully!`);
                    setShowManualBillingModal(false);
                    // Reset form and search states
                    setManualBillingData({
                        customerName: '',
                        customerPhone: '',
                        plateNumber: '',
                        vehicleType: 'Sedan',
                        source: 'wash',
                        selectedServices: [],
                        notes: '',
                        paymentStatus: 'unpaid',
                        paymentMethod: 'cash',
                        mpesaCode: '',
                        cardReference: ''
                    });
                    setBillingPlateSearchResults([]);
                    setShowBillingPlateSearch(false);
                    setSelectedIntakeRecord(null);
                    setExistingPendingInvoice(null);
                    setApplyToExisting(true);
                } else {
                    setError(result.error || 'Failed to create invoice');
                }
            }
        } catch (err) {
            console.error('Manual billing error:', err);
            setError('Failed to process: ' + err.message);
        } finally {
            setActionLoading(false);
        }
    };

    // Format currency
    const formatCurrency = (amount) => {
        const currencySymbol = getBrandingForReceipts().currencySymbol || 'KES';
        return `${currencySymbol} ${(amount || 0).toLocaleString()}`;
    };

    // Format date
    const formatDate = (dateStr) => {
        if (!dateStr) return '-';
        return new Date(dateStr).toLocaleDateString('en-KE', { 
            day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' 
        });
    };

    // Get source badge
    const getSourceBadge = (source) => {
        const config = {
            garage: { label: 'GARAGE', color: '#f59e0b', bg: '#fef3c7' },
            wash: { label: 'WASH', color: '#3b82f6', bg: '#dbeafe' },
            other: { label: 'OTHER', color: '#6b7280', bg: '#f3f4f6' }
        };
        const c = config[source] || config.other;
        return (
            <span style={{ 
                padding: '3px 10px', 
                borderRadius: '0', 
                fontSize: '10px', 
                fontWeight: '700',
                letterSpacing: '0.5px',
                background: isDark ? c.color + '20' : c.bg,
                color: c.color
            }}>{c.label}</span>
        );
    };

    // Get payment status badge
    const getPaymentBadge = (status, method) => {
        if (status === 'paid') {
            const methodLabel = method === 'mpesa' ? 'M-PESA' : method === 'cash' ? 'CASH' : 'PAID';
            return (
                <span style={{ 
                    padding: '4px 12px', 
                    borderRadius: '0', 
                    fontSize: '10px', 
                    fontWeight: '700',
                    letterSpacing: '0.5px',
                    background: isDark ? '#10b98130' : '#d1fae5',
                    color: '#10b981',
                    borderLeft: '3px solid #10b981'
                }}>‚úì {methodLabel}</span>
            );
        }
        return (
            <span style={{ 
                padding: '4px 12px', 
                borderRadius: '0', 
                fontSize: '10px', 
                fontWeight: '700',
                letterSpacing: '0.5px',
                background: isDark ? '#ef444430' : '#fee2e2',
                color: '#ef4444',
                borderLeft: '3px solid #ef4444'
            }}>UNPAID</span>
        );
    };

    // Styles - Sharp edges throughout
    const cardStyle = {
        background: theme.bg,
        borderRadius: '0',
        border: `1px solid ${theme.border}`,
        padding: '24px',
        boxShadow: theme.cardShadow
    };

    const statCardStyle = {
        background: theme.bg,
        borderRadius: '0',
        border: `1px solid ${theme.border}`,
        padding: '20px 24px',
        display: 'flex',
        alignItems: 'center',
        gap: '20px'
    };

    const buttonStyle = {
        padding: '10px 20px',
        borderRadius: '0',
        border: 'none',
        cursor: 'pointer',
        fontWeight: '700',
        fontSize: '12px',
        letterSpacing: '0.5px',
        textTransform: 'uppercase',
        transition: 'all 0.2s'
    };

    const inputStyle = {
        width: '100%',
        padding: '12px 16px',
        borderRadius: '0',
        border: `1px solid ${theme.border}`,
        background: theme.inputBg,
        color: theme.text,
        fontSize: '14px',
        outline: 'none'
    };

    const tabStyle = (isActive) => ({
        padding: '12px 28px',
        border: 'none',
        background: isActive ? '#3b82f6' : 'transparent',
        color: isActive ? 'white' : theme.textSecondary,
        fontWeight: '700',
        fontSize: '12px',
        letterSpacing: '0.5px',
        textTransform: 'uppercase',
        cursor: 'pointer',
        borderRadius: '0',
        borderBottom: isActive ? '3px solid #1d4ed8' : '3px solid transparent',
        transition: 'all 0.2s'
    });

    const filteredInvoices = getFilteredInvoices();

    if (loading) {
        return (
            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', height: '400px', color: theme.textSecondary }}>
                <div style={{ textAlign: 'center' }}>
                    <div style={{ fontSize: '32px', marginBottom: '12px' }}>üí≥</div>
                    <div>Loading billing data...</div>
                </div>
            </div>
        );
    }

    return (
        <div style={{ padding: '0', width: '100%' }}>
            {/* Success/Error Messages */}
            {successMessage && (
                <div style={{ 
                    position: 'fixed', top: '20px', right: '20px', zIndex: 1000,
                    background: '#10b981', color: 'white', padding: '14px 24px',
                    borderRadius: '0', boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
                    display: 'flex', alignItems: 'center', gap: '10px',
                    fontWeight: '600', letterSpacing: '0.3px'
                }}>
                    ‚úì {successMessage}
                </div>
            )}
            {error && (
                <div style={{ 
                    position: 'fixed', top: '20px', right: '20px', zIndex: 1000,
                    background: '#ef4444', color: 'white', padding: '14px 24px',
                    borderRadius: '0', boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
                    display: 'flex', alignItems: 'center', gap: '10px', cursor: 'pointer',
                    fontWeight: '600', letterSpacing: '0.3px'
                }} onClick={() => setError(null)}>
                    ‚úï {error}
                </div>
            )}

            {/* Stats Cards - Full Width Grid */}
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '0', marginBottom: '0', borderBottom: `1px solid ${theme.border}` }}>
                <div style={{ ...statCardStyle, borderRight: `1px solid ${theme.border}` }}>
                    <div style={{ fontSize: '28px' }}>üìã</div>
                    <div style={{ flex: 1 }}>
                        <div style={{ fontSize: '28px', fontWeight: '800', color: theme.text, letterSpacing: '-1px' }}>{billingStats.todayInvoiceCount}</div>
                        <div style={{ fontSize: '11px', color: theme.textSecondary, textTransform: 'uppercase', letterSpacing: '0.5px', fontWeight: '600' }}>Today's Invoices</div>
                    </div>
                </div>
                <div style={{ ...statCardStyle, borderRight: `1px solid ${theme.border}` }}>
                    <div style={{ fontSize: '28px' }}>‚è≥</div>
                    <div style={{ flex: 1 }}>
                        <div style={{ fontSize: '28px', fontWeight: '800', color: '#ef4444', letterSpacing: '-1px' }}>{billingStats.pendingPayments}</div>
                        <div style={{ fontSize: '11px', color: theme.textSecondary, textTransform: 'uppercase', letterSpacing: '0.5px', fontWeight: '600' }}>Pending</div>
                    </div>
                </div>
                <div style={{ ...statCardStyle, borderRight: `1px solid ${theme.border}` }}>
                    <div style={{ fontSize: '28px' }}>üí∞</div>
                    <div style={{ flex: 1 }}>
                        <div style={{ fontSize: '24px', fontWeight: '800', color: '#10b981', letterSpacing: '-0.5px' }}>{formatCurrency(billingStats.paidToday)}</div>
                        <div style={{ fontSize: '11px', color: theme.textSecondary, textTransform: 'uppercase', letterSpacing: '0.5px', fontWeight: '600' }}>Collected Today</div>
                    </div>
                </div>
                <div style={{ ...statCardStyle }}>
                    <div style={{ fontSize: '28px' }}>üìä</div>
                    <div style={{ flex: 1 }}>
                        <div style={{ fontSize: '24px', fontWeight: '800', color: '#f59e0b', letterSpacing: '-0.5px' }}>{formatCurrency(billingStats.totalPending)}</div>
                        <div style={{ fontSize: '11px', color: theme.textSecondary, textTransform: 'uppercase', letterSpacing: '0.5px', fontWeight: '600' }}>Outstanding</div>
                    </div>
                </div>
            </div>

            {/* Revenue Today & Payment Methods Stats Row */}
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '0', borderBottom: `1px solid ${theme.border}` }}>
                <div style={{ ...statCardStyle, borderRight: `1px solid ${theme.border}` }}>
                    <div style={{ fontSize: '28px' }}>üí≥</div>
                    <div style={{ flex: 1 }}>
                        <div style={{ fontSize: '28px', fontWeight: '800', color: '#10b981', letterSpacing: '-0.5px' }}>{formatCurrency(revenueToday.total)}</div>
                        <div style={{ fontSize: '11px', color: theme.textSecondary, textTransform: 'uppercase', letterSpacing: '0.5px', fontWeight: '600', marginBottom: '8px' }}>Revenue Today</div>
                        <div style={{ display: 'flex', gap: '12px', flexWrap: 'wrap' }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                                <span style={{ width: '6px', height: '6px', borderRadius: '50%', background: '#3b82f6' }}></span>
                                <span style={{ fontSize: '11px', color: theme.textSecondary }}>Wash:</span>
                                <span style={{ fontSize: '12px', fontWeight: '700', color: '#3b82f6' }}>{formatCurrency(revenueToday.wash)}</span>
                            </div>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                                <span style={{ width: '6px', height: '6px', borderRadius: '50%', background: '#8b5cf6' }}></span>
                                <span style={{ fontSize: '11px', color: theme.textSecondary }}>Garage:</span>
                                <span style={{ fontSize: '12px', fontWeight: '700', color: '#8b5cf6' }}>{formatCurrency(revenueToday.garage)}</span>
                            </div>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                                <span style={{ width: '6px', height: '6px', borderRadius: '50%', background: '#f59e0b' }}></span>
                                <span style={{ fontSize: '11px', color: theme.textSecondary }}>Parking:</span>
                                <span style={{ fontSize: '12px', fontWeight: '700', color: '#f59e0b' }}>{formatCurrency(revenueToday.parking)}</span>
                            </div>
                            {revenueToday.other > 0 && (
                                <div style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                                    <span style={{ width: '6px', height: '6px', borderRadius: '50%', background: '#6b7280' }}></span>
                                    <span style={{ fontSize: '11px', color: theme.textSecondary }}>Other:</span>
                                    <span style={{ fontSize: '12px', fontWeight: '700', color: '#6b7280' }}>{formatCurrency(revenueToday.other)}</span>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
                <div style={{ ...statCardStyle, borderRight: `1px solid ${theme.border}` }}>
                    <div style={{ fontSize: '28px' }}>üì±</div>
                    <div style={{ flex: 1 }}>
                        <div style={{ fontSize: '24px', fontWeight: '800', color: '#3b82f6' }}>{billingStats.mpesaPayments}</div>
                        <div style={{ fontSize: '11px', color: theme.textSecondary, textTransform: 'uppercase', letterSpacing: '0.5px', fontWeight: '600' }}>M-Pesa Payments</div>
                    </div>
                </div>
                <div style={{ ...statCardStyle, borderRight: `1px solid ${theme.border}` }}>
                    <div style={{ fontSize: '28px' }}>üíµ</div>
                    <div style={{ flex: 1 }}>
                        <div style={{ fontSize: '24px', fontWeight: '800', color: '#10b981' }}>{billingStats.cashPayments}</div>
                        <div style={{ fontSize: '11px', color: theme.textSecondary, textTransform: 'uppercase', letterSpacing: '0.5px', fontWeight: '600' }}>Cash Payments</div>
                    </div>
                </div>
                <div style={{ ...statCardStyle }}>
                    <div style={{ fontSize: '28px' }}>üè¶</div>
                    <div style={{ flex: 1 }}>
                        <div style={{ fontSize: '24px', fontWeight: '800', color: theme.text }}>{formatCurrency(billingStats.totalCollected)}</div>
                        <div style={{ fontSize: '11px', color: theme.textSecondary, textTransform: 'uppercase', letterSpacing: '0.5px', fontWeight: '600', marginBottom: '8px' }}>Total Collected</div>
                        <div style={{ display: 'flex', gap: '10px', flexWrap: 'wrap' }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '3px' }}>
                                <span style={{ width: '5px', height: '5px', borderRadius: '50%', background: '#3b82f6' }}></span>
                                <span style={{ fontSize: '10px', color: theme.textSecondary }}>Wash:</span>
                                <span style={{ fontSize: '11px', fontWeight: '700', color: '#3b82f6' }}>{formatCurrency(totalBySource.wash)}</span>
                            </div>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '3px' }}>
                                <span style={{ width: '5px', height: '5px', borderRadius: '50%', background: '#8b5cf6' }}></span>
                                <span style={{ fontSize: '10px', color: theme.textSecondary }}>Garage:</span>
                                <span style={{ fontSize: '11px', fontWeight: '700', color: '#8b5cf6' }}>{formatCurrency(totalBySource.garage)}</span>
                            </div>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '3px' }}>
                                <span style={{ width: '5px', height: '5px', borderRadius: '50%', background: '#f59e0b' }}></span>
                                <span style={{ fontSize: '10px', color: theme.textSecondary }}>Parking:</span>
                                <span style={{ fontSize: '11px', fontWeight: '700', color: '#f59e0b' }}>{formatCurrency(totalBySource.parking)}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            {/* Expenses & Profit Row */}
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '0', borderBottom: `1px solid ${theme.border}` }}>
                <div style={{ ...statCardStyle, borderRight: `1px solid ${theme.border}` }}>
                    <div style={{ fontSize: '28px' }}>üìâ</div>
                    <div style={{ flex: 1 }}>
                        <div style={{ fontSize: '24px', fontWeight: '800', color: '#ef4444', letterSpacing: '-0.5px' }}>{formatCurrency(expensesSummary.today)}</div>
                        <div style={{ fontSize: '11px', color: theme.textSecondary, textTransform: 'uppercase', letterSpacing: '0.5px', fontWeight: '600' }}>Expenses Today</div>
                    </div>
                </div>
                <div style={{ ...statCardStyle, borderRight: `1px solid ${theme.border}` }}>
                    <div style={{ fontSize: '28px' }}>üìã</div>
                    <div style={{ flex: 1 }}>
                        <div style={{ fontSize: '24px', fontWeight: '800', color: '#f59e0b' }}>{formatCurrency(expensesSummary.thisMonth)}</div>
                        <div style={{ fontSize: '11px', color: theme.textSecondary, textTransform: 'uppercase', letterSpacing: '0.5px', fontWeight: '600' }}>Expenses This Month</div>
                    </div>
                </div>
                <div style={{ ...statCardStyle, borderRight: `1px solid ${theme.border}` }}>
                    <div style={{ fontSize: '28px' }}>{(revenueToday.total - expensesSummary.today) >= 0 ? 'üìà' : 'üìâ'}</div>
                    <div style={{ flex: 1 }}>
                        <div style={{ fontSize: '28px', fontWeight: '800', color: (revenueToday.total - expensesSummary.today) >= 0 ? '#10b981' : '#ef4444', letterSpacing: '-0.5px' }}>{formatCurrency(revenueToday.total - expensesSummary.today)}</div>
                        <div style={{ fontSize: '11px', color: theme.textSecondary, textTransform: 'uppercase', letterSpacing: '0.5px', fontWeight: '600' }}>Net Profit Today</div>
                        <div style={{ display: 'flex', gap: '8px', marginTop: '4px' }}>
                            <span style={{ fontSize: '10px', color: '#10b981' }}>+{formatCurrency(revenueToday.total)}</span>
                            <span style={{ fontSize: '10px', color: '#ef4444' }}>-{formatCurrency(expensesSummary.today)}</span>
                        </div>
                    </div>
                </div>
                <div style={{ ...statCardStyle }}>
                    <div style={{ fontSize: '28px' }}>üßæ</div>
                    <div style={{ flex: 1 }}>
                        <div style={{ fontSize: '24px', fontWeight: '800', color: theme.text }}>{expensesSummary.count}</div>
                        <div style={{ fontSize: '11px', color: theme.textSecondary, textTransform: 'uppercase', letterSpacing: '0.5px', fontWeight: '600' }}>Total Expenses</div>
                    </div>
                </div>
            </div>

            {/* Tabs & Filters Bar */}
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: '16px', padding: '0', background: theme.bgSecondary, borderBottom: `2px solid ${theme.border}` }}>
                <div style={{ display: 'flex', gap: '0', alignItems: 'center' }}>
                    <button style={{ ...tabStyle(activeTab === 'paid'), position: 'relative', display: 'flex', alignItems: 'center', gap: '8px' }} onClick={() => setActiveTab('paid')}>
                        Paid
                        {(() => {
                            const today = new Date().toISOString().split('T')[0];
                            const todaysPaid = invoices.filter(inv => inv.paymentStatus === 'paid' && inv.createdAt?.startsWith(today));
                            return todaysPaid.length > 0 && (
                                <span style={{
                                    background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)',
                                    color: 'white',
                                    fontSize: '11px',
                                    fontWeight: '700',
                                    minWidth: '20px',
                                    height: '20px',
                                    borderRadius: '10px',
                                    display: 'inline-flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    padding: '0 6px',
                                    boxShadow: '0 2px 8px rgba(16, 185, 129, 0.4)'
                                }}>
                                    {todaysPaid.length > 99 ? '99+' : todaysPaid.length}
                                </span>
                            );
                        })()}
                    </button>
                    <button style={{ ...tabStyle(activeTab === 'pending'), position: 'relative', display: 'flex', alignItems: 'center', gap: '8px' }} onClick={() => setActiveTab('pending')}>
                        Pending
                        {(() => {
                            const today = new Date().toISOString().split('T')[0];
                            const todaysPending = pendingInvoices.filter(inv => inv.createdAt?.startsWith(today));
                            return todaysPending.length > 0 && (
                                <span style={{
                                    background: 'linear-gradient(135deg, #ef4444 0%, #f97316 100%)',
                                    color: 'white',
                                    fontSize: '11px',
                                    fontWeight: '700',
                                    minWidth: '20px',
                                    height: '20px',
                                    borderRadius: '10px',
                                    display: 'inline-flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    padding: '0 6px',
                                    boxShadow: '0 2px 8px rgba(239, 68, 68, 0.5)',
                                    animation: 'pulse 2s infinite'
                                }}>
                                    {todaysPending.length > 99 ? '99+' : todaysPending.length}
                                </span>
                            );
                        })()}
                    </button>
                    <button style={tabStyle(activeTab === 'all')} onClick={() => setActiveTab('all')}>
                        All Invoices
                    </button>
                    <button style={tabStyle(activeTab === 'expenses')} onClick={() => setActiveTab('expenses')}>
                        Expenses ({expenses.length})
                    </button>
                    <button style={{ ...tabStyle(activeTab === 'activity'), display: 'flex', alignItems: 'center', gap: '6px' }} onClick={() => setActiveTab('activity')}>
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                        Activity
                    </button>
                    {canCreate('billing') && <button
                        onClick={() => setShowManualBillingModal(true)}
                        style={{
                            ...buttonStyle,
                            background: '#10b981',
                            color: 'white',
                            marginLeft: '16px',
                            padding: '10px 20px',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '8px'
                        }}
                    >
                        <span style={{ fontSize: '16px' }}>+</span> NEW INVOICE
                    </button>}
                </div>

                <div style={{ display: 'flex', gap: '0', padding: '0' }}>
                    <input
                        type="text"
                        placeholder="Search invoices..."
                        value={searchQuery}
                        onChange={(e) => setSearchQuery(e.target.value)}
                        style={{ ...inputStyle, width: '220px', borderRight: 'none' }}
                    />
                    <select
                        value={sourceFilter}
                        onChange={(e) => setSourceFilter(e.target.value)}
                        style={{ ...inputStyle, width: '140px', borderRight: 'none' }}
                    >
                        <option value="all">All Sources</option>
                        <option value="garage">Garage</option>
                        <option value="wash">Car Wash</option>
                        <option value="parking">Parking</option>
                        <option value="other">Other</option>
                    </select>
                    <select
                        value={dateFilter}
                        onChange={(e) => setDateFilter(e.target.value)}
                        style={{ ...inputStyle, width: '140px' }}
                    >
                        <option value="all">All Time</option>
                        <option value="today">Today</option>
                        <option value="yesterday">Yesterday</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                        <option value="custom">Custom Range</option>
                    </select>
                    {dateFilter === 'custom' && (
                        <>
                            <input
                                type="date"
                                value={customDateFrom}
                                onChange={(e) => setCustomDateFrom(e.target.value)}
                                style={{ ...inputStyle, width: '140px', marginLeft: '8px' }}
                                placeholder="From"
                            />
                            <input
                                type="date"
                                value={customDateTo}
                                onChange={(e) => setCustomDateTo(e.target.value)}
                                style={{ ...inputStyle, width: '140px' }}
                                placeholder="To"
                            />
                        </>
                    )}
                    {/* Payment Method Filter */}
                    <select
                        value={paymentMethodFilter}
                        onChange={(e) => setPaymentMethodFilter(e.target.value)}
                        style={{ ...inputStyle, width: '130px', marginLeft: '8px' }}
                    >
                        <option value="all">All Methods</option>
                        <option value="cash">üíµ Cash</option>
                        <option value="mpesa">üì± M-Pesa</option>
                        <option value="card">üí≥ Card</option>
                        <option value="unpaid">‚è≥ Unpaid</option>
                    </select>
                    {/* Items per page */}
                    <select
                        value={itemsPerPage}
                        onChange={(e) => { setItemsPerPage(Number(e.target.value)); setCurrentPage(1); }}
                        style={{ ...inputStyle, width: '90px', marginLeft: '8px' }}
                    >
                        <option value={10}>10</option>
                        <option value={25}>25</option>
                        <option value={50}>50</option>
                        <option value={100}>100</option>
                        <option value={250}>250</option>
                    </select>
                    {/* Export Button */}
                    <div style={{ position: 'relative', marginLeft: '8px' }}>
                        <button
                            onClick={() => setShowExportMenu(!showExportMenu)}
                            style={{
                                ...buttonStyle,
                                background: theme.bgTertiary,
                                color: theme.text,
                                padding: '10px 16px',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '6px'
                            }}
                        >
                            üì• Export ‚ñæ
                        </button>
                        {showExportMenu && (
                            <div style={{
                                position: 'absolute',
                                top: '100%',
                                right: 0,
                                background: 'white',
                                border: '1px solid #e5e7eb',
                                boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
                                zIndex: 100,
                                minWidth: '160px'
                            }}>
                                <button
                                    onClick={exportCSV}
                                    style={{ display: 'block', width: '100%', padding: '12px 16px', border: 'none', background: 'none', textAlign: 'left', cursor: 'pointer', fontSize: '14px', color: '#374151' }}
                                    onMouseOver={(e) => e.target.style.background='#f3f4f6'}
                                    onMouseOut={(e) => e.target.style.background='none'}
                                >
                                    üìä Export CSV
                                </button>
                                <button
                                    onClick={exportPDF}
                                    style={{ display: 'block', width: '100%', padding: '12px 16px', border: 'none', background: 'none', textAlign: 'left', cursor: 'pointer', fontSize: '14px', color: '#374151' }}
                                    onMouseOver={(e) => e.target.style.background='#f3f4f6'}
                                    onMouseOut={(e) => e.target.style.background='none'}
                                >
                                    üìÑ Export PDF
                                </button>
                                <button
                                    onClick={exportDailySalesReport}
                                    style={{ display: 'block', width: '100%', padding: '12px 16px', border: 'none', background: 'none', textAlign: 'left', cursor: 'pointer', fontSize: '14px', color: '#374151', borderTop: '1px solid #e5e7eb' }}
                                    onMouseOver={(e) => e.target.style.background='#f3f4f6'}
                                    onMouseOut={(e) => e.target.style.background='none'}
                                >
                                    üìà Daily Sales Report
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            </div>

            {/* Invoices Table - Only show when not on expenses tab */}
            {activeTab !== 'expenses' ? (
            <div style={{ 
                background: isDark ? '#1e293b' : '#ffffff', 
                borderRadius: '0', 
                overflow: 'hidden',
                boxShadow: isDark ? '0 4px 24px rgba(0,0,0,0.4)' : '0 4px 24px rgba(0,0,0,0.08)',
                border: `1px solid ${isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.05)'}`
            }}>
                <table style={{ width: '100%', borderCollapse: 'separate', borderSpacing: '0', fontFamily: "'Montserrat', sans-serif" }}>
                    <thead>
                        <tr style={{ 
                            background: isDark ? '#1e40af' : '#3b82f6'
                        }}>
                            <th style={{ padding: '14px 16px', textAlign: 'left', fontSize: '11px', fontWeight: '700', color: 'white', textTransform: 'uppercase', letterSpacing: '1px' }}>Invoice</th>
                            <th style={{ padding: '14px 16px', textAlign: 'left', fontSize: '11px', fontWeight: '700', color: 'white', textTransform: 'uppercase', letterSpacing: '1px' }}>Customer</th>
                            <th style={{ padding: '14px 16px', textAlign: 'center', fontSize: '11px', fontWeight: '700', color: 'white', textTransform: 'uppercase', letterSpacing: '1px' }}>Vehicle</th>
                            <th style={{ padding: '14px 16px', textAlign: 'right', fontSize: '11px', fontWeight: '700', color: 'white', textTransform: 'uppercase', letterSpacing: '1px' }}>Amount</th>
                            <th style={{ padding: '14px 16px', textAlign: 'center', fontSize: '11px', fontWeight: '700', color: 'white', textTransform: 'uppercase', letterSpacing: '1px' }}>Payment</th>
                            <th style={{ padding: '14px 16px', textAlign: 'center', fontSize: '11px', fontWeight: '700', color: 'white', textTransform: 'uppercase', letterSpacing: '1px' }}>Ref Code</th>
                            <th style={{ padding: '14px 16px', textAlign: 'center', fontSize: '11px', fontWeight: '700', color: 'white', textTransform: 'uppercase', letterSpacing: '1px' }}>Date</th>
                            <th style={{ padding: '14px 16px', textAlign: 'center', fontSize: '11px', fontWeight: '700', color: 'white', textTransform: 'uppercase', letterSpacing: '1px', width: '120px' }}>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {getFilteredInvoices().length === 0 ? (
                            <tr>
                                <td colSpan="8" style={{ padding: '60px 20px', textAlign: 'center' }}>
                                    <div style={{ 
                                        width: '80px', height: '80px', margin: '0 auto 16px', 
                                        background: isDark ? 'rgba(99,102,241,0.2)' : 'rgba(99,102,241,0.1)', 
                                        borderRadius: '50%', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '32px' 
                                    }}>üì≠</div>
                                    <div style={{ fontSize: '16px', fontWeight: '600', color: theme.text, marginBottom: '4px' }}>No Transactions Found</div>
                                    <div style={{ fontSize: '13px', color: theme.textSecondary }}>Invoices will appear here when jobs are completed</div>
                                </td>
                            </tr>
                        ) : (
                            getPaginatedInvoices().map((invoice, idx) => (
                                <tr 
                                    key={invoice.id} 
                                    style={{ 
                                        background: isDark 
                                            ? idx % 2 === 0 ? 'rgba(30,41,59,0.5)' : 'rgba(15,23,42,0.5)'
                                            : idx % 2 === 0 ? '#ffffff' : '#f8fafc',
                                        transition: 'all 0.2s ease',
                                        borderBottom: `1px solid ${isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)'}`
                                    }}
                                    onMouseOver={(e) => e.currentTarget.style.background = isDark ? 'rgba(59,130,246,0.15)' : 'rgba(59,130,246,0.08)'}
                                    onMouseOut={(e) => e.currentTarget.style.background = isDark 
                                        ? idx % 2 === 0 ? 'rgba(30,41,59,0.5)' : 'rgba(15,23,42,0.5)'
                                        : idx % 2 === 0 ? '#ffffff' : '#f8fafc'}
                                >
                                    <td style={{ padding: '12px 16px' }}>
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                                            <div style={{ 
                                                width: '36px', height: '36px', borderRadius: '10px', 
                                                background: invoice.source === 'wash' ? '#06b6d4' : 
                                                           invoice.source === 'garage' ? '#f59e0b' : '#8b5cf6',
                                                display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '16px', color: 'white',
                                                boxShadow: '0 2px 8px rgba(0,0,0,0.15)'
                                            }}>
                                                {invoice.source === 'wash' ? 'üöó' : invoice.source === 'garage' ? 'üîß' : 'üì¶'}
                                            </div>
                                            <div>
                                                <div 
                                                    style={{ fontWeight: '700', color: '#3b82f6', cursor: 'pointer', fontSize: '13px', letterSpacing: '0.3px' }} 
                                                    onClick={() => viewInvoiceDetails(invoice)}
                                                >
                                                    {invoice.invoiceNumber || invoice.id.slice(0, 8).toUpperCase()}
                                                </div>
                                                <div style={{ fontSize: '10px', color: theme.textSecondary, marginTop: '2px', textTransform: 'capitalize' }}>
                                                    {invoice.source || 'Service'}
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                    <td style={{ padding: '12px 16px' }}>
                                        <div style={{ fontWeight: '600', color: theme.text, fontSize: '13px' }}>{invoice.customerName || 'Walk-in Customer'}</div>
                                        {invoice.customerPhone && (
                                            <div style={{ fontSize: '11px', color: theme.textSecondary, marginTop: '2px', display: 'flex', alignItems: 'center', gap: '4px' }}>
                                                <span style={{ opacity: 0.7 }}>üìû</span> {invoice.customerPhone}
                                            </div>
                                        )}
                                    </td>
                                    <td style={{ padding: '12px 16px', textAlign: 'center' }}>
                                        <span style={{ 
                                            fontWeight: '700', 
                                            color: isDark ? '#f1f5f9' : '#1e293b', 
                                            fontSize: '12px', 
                                            background: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.06)', 
                                            padding: '6px 12px', 
                                            borderRadius: '6px',
                                            letterSpacing: '0.5px'
                                        }}>
                                            {invoice.plateNumber || '‚Äî'}
                                        </span>
                                    </td>
                                    <td style={{ padding: '12px 16px', textAlign: 'right' }}>
                                        <div style={{ fontWeight: '800', color: '#10b981', fontSize: '15px', letterSpacing: '-0.3px' }}>
                                            {formatCurrency(invoice.totalAmount)}
                                        </div>
                                    </td>
                                    <td style={{ padding: '12px 16px', textAlign: 'center' }}>
                                        {invoice.paymentStatus === 'paid' ? (
                                            <span style={{ 
                                                fontSize: '10px', 
                                                fontWeight: '700', 
                                                padding: '6px 12px',
                                                borderRadius: '20px',
                                                background: invoice.paymentMethod === 'cash' ? '#f59e0b' : 
                                                           (invoice.paymentMethod === 'mpesa' || invoice.paymentMethod === 'm-pesa') ? '#10b981' : 
                                                           invoice.paymentMethod === 'card' ? '#3b82f6' : '#10b981',
                                                color: 'white',
                                                textTransform: 'uppercase',
                                                letterSpacing: '0.5px',
                                                boxShadow: '0 2px 6px rgba(0,0,0,0.15)'
                                            }}>
                                                {invoice.paymentMethod === 'cash' ? 'üíµ Cash' : 
                                                 (invoice.paymentMethod === 'mpesa' || invoice.paymentMethod === 'm-pesa') ? 'üì± M-Pesa' : 
                                                 invoice.paymentMethod === 'card' ? 'üí≥ Card' : '‚úì Paid'}
                                            </span>
                                        ) : (
                                            <span style={{ 
                                                fontSize: '10px', fontWeight: '700', padding: '6px 12px', borderRadius: '20px',
                                                background: '#fbbf24', color: '#78350f',
                                                textTransform: 'uppercase', letterSpacing: '0.5px'
                                            }}>‚è≥ Pending</span>
                                        )}
                                    </td>
                                    <td style={{ padding: '12px 16px', textAlign: 'center' }}>
                                        {(invoice.paymentMethod === 'mpesa' || invoice.paymentMethod === 'm-pesa') && invoice.mpesaCode ? (
                                            <span style={{ 
                                                fontSize: '11px', fontWeight: '700', color: '#10b981', 
                                                fontFamily: "'Montserrat', monospace", 
                                                background: isDark ? 'rgba(16,185,129,0.15)' : 'rgba(16,185,129,0.1)',
                                                padding: '4px 8px', borderRadius: '4px'
                                            }}>{invoice.mpesaCode}</span>
                                        ) : invoice.paymentMethod === 'card' && (invoice.transactionRef || invoice.cardLastFour) ? (
                                            <span style={{ 
                                                fontSize: '11px', fontWeight: '700', color: '#3b82f6', 
                                                fontFamily: "'Montserrat', monospace",
                                                background: isDark ? 'rgba(59,130,246,0.15)' : 'rgba(59,130,246,0.1)',
                                                padding: '4px 8px', borderRadius: '4px'
                                            }}>{invoice.transactionRef || `****${invoice.cardLastFour}`}</span>
                                        ) : (
                                            <span style={{ color: theme.textMuted, fontSize: '12px' }}>‚Äî</span>
                                        )}
                                    </td>
                                    <td style={{ padding: '12px 16px', textAlign: 'center', color: theme.textSecondary, fontSize: '12px', fontWeight: '500' }}>
                                        {formatDate(invoice.createdAt)}
                                    </td>
                                    <td style={{ padding: '12px 16px', textAlign: 'center' }}>
                                        <div style={{ display: 'flex', gap: '6px', justifyContent: 'center' }}>
                                            {invoice.paymentStatus === 'paid' ? (
                                                <>
                                                    <button onClick={() => viewInvoiceDetails(invoice)} style={{ 
                                                        ...buttonStyle, padding: '8px 10px', 
                                                        background: isDark ? 'rgba(139,92,246,0.2)' : 'rgba(139,92,246,0.1)', 
                                                        color: '#8b5cf6', fontSize: '12px', border: 'none', borderRadius: '8px',
                                                        transition: 'all 0.2s', display: 'flex', alignItems: 'center', justifyContent: 'center'
                                                    }} title="View Details"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>
                                                    <button onClick={() => handlePrintReceipt(invoice)} style={{ 
                                                        ...buttonStyle, padding: '8px 10px', 
                                                        background: isDark ? 'rgba(59,130,246,0.2)' : 'rgba(59,130,246,0.1)', 
                                                        color: '#3b82f6', fontSize: '12px', border: 'none', borderRadius: '8px',
                                                        transition: 'all 0.2s'
                                                    }} title="Print Receipt">üßæ</button>
                                                    {canEdit('billing') && <button onClick={() => handleCancelPayment(invoice)} style={{ 
                                                        ...buttonStyle, padding: '8px 10px', 
                                                        background: isDark ? 'rgba(245,158,11,0.2)' : 'rgba(245,158,11,0.1)', 
                                                        color: '#f59e0b', fontSize: '12px', border: 'none', borderRadius: '8px',
                                                        transition: 'all 0.2s'
                                                    }} title="Revert Payment">‚Ü©</button>}
                                                    {canDelete('billing') && <button onClick={() => handleDeleteInvoice(invoice)} style={{ 
                                                        ...buttonStyle, padding: '8px 10px', 
                                                        background: isDark ? 'rgba(239,68,68,0.2)' : 'rgba(239,68,68,0.1)', 
                                                        color: '#ef4444', fontSize: '12px', border: 'none', borderRadius: '8px',
                                                        transition: 'all 0.2s'
                                                    }} title="Delete">√ó</button>}
                                                </>
                                            ) : (
                                                <>
                                                    <button onClick={() => viewInvoiceDetails(invoice)} style={{ 
                                                        ...buttonStyle, padding: '8px 10px', 
                                                        background: isDark ? 'rgba(139,92,246,0.2)' : 'rgba(139,92,246,0.1)', 
                                                        color: '#8b5cf6', fontSize: '12px', border: 'none', borderRadius: '8px',
                                                        transition: 'all 0.2s', display: 'flex', alignItems: 'center', justifyContent: 'center'
                                                    }} title="View Details"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>
                                                    {canEdit('billing') && <button onClick={() => openPaymentModal(invoice)} style={{ 
                                                        ...buttonStyle, padding: '8px 14px', 
                                                        background: '#10b981', 
                                                        color: 'white', fontSize: '11px', fontWeight: '700', border: 'none', borderRadius: '8px',
                                                        boxShadow: '0 2px 8px rgba(16,185,129,0.3)',
                                                        transition: 'all 0.2s', letterSpacing: '0.5px'
                                                    }} title="Record Payment">PAY NOW</button>}
                                                    {canDelete('billing') && <button onClick={() => handleDeleteInvoice(invoice)} style={{ 
                                                        ...buttonStyle, padding: '8px 10px', 
                                                        background: isDark ? 'rgba(239,68,68,0.2)' : 'rgba(239,68,68,0.1)', 
                                                        color: '#ef4444', fontSize: '12px', border: 'none', borderRadius: '8px',
                                                        transition: 'all 0.2s'
                                                    }} title="Delete">√ó</button>}
                                                </>
                                            )}
                                        </div>
                                    </td>
                                </tr>
                            ))
                        )}
                    </tbody>
                </table>
                
                {/* Pagination Controls */}
                {getFilteredInvoices().length > 0 && (
                    <div style={{ 
                        display: 'flex', 
                        justifyContent: 'space-between', 
                        alignItems: 'center', 
                        padding: '16px 20px', 
                        background: isDark ? 'rgba(30,41,59,0.8)' : 'rgba(248,250,252,0.9)', 
                        borderTop: `1px solid ${isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.05)'}`,
                        flexWrap: 'wrap',
                        gap: '12px'
                    }}>
                        {/* Results info */}
                        <div style={{ color: theme.textSecondary, fontSize: '13px', fontWeight: '500' }}>
                            Showing <span style={{ color: '#3b82f6', fontWeight: '700' }}>{((currentPage - 1) * itemsPerPage) + 1}</span> - <span style={{ color: '#3b82f6', fontWeight: '700' }}>{Math.min(currentPage * itemsPerPage, getFilteredInvoices().length)}</span> of <span style={{ color: theme.text, fontWeight: '700' }}>{getFilteredInvoices().length.toLocaleString()}</span> transactions
                        </div>
                        
                        {/* Pagination buttons */}
                        <div style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                            <button onClick={() => setCurrentPage(1)} disabled={currentPage === 1} style={{ 
                                ...buttonStyle, padding: '8px 12px', 
                                background: currentPage === 1 ? (isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.03)') : (isDark ? 'rgba(255,255,255,0.1)' : 'white'),
                                color: currentPage === 1 ? theme.textMuted : theme.text, 
                                border: `1px solid ${isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)'}`, 
                                borderRadius: '8px', fontSize: '12px', fontWeight: '600',
                                opacity: currentPage === 1 ? 0.5 : 1, cursor: currentPage === 1 ? 'not-allowed' : 'pointer'
                            }}>‚ü™</button>
                            <button onClick={() => setCurrentPage(p => Math.max(1, p - 1))} disabled={currentPage === 1} style={{ 
                                ...buttonStyle, padding: '8px 14px', 
                                background: currentPage === 1 ? (isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.03)') : (isDark ? 'rgba(255,255,255,0.1)' : 'white'),
                                color: currentPage === 1 ? theme.textMuted : theme.text, 
                                border: `1px solid ${isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)'}`, 
                                borderRadius: '8px', fontSize: '12px', fontWeight: '500',
                                opacity: currentPage === 1 ? 0.5 : 1, cursor: currentPage === 1 ? 'not-allowed' : 'pointer'
                            }}>‚Üê Prev</button>
                            
                            <div style={{ display: 'flex', alignItems: 'center', gap: '4px', margin: '0 8px' }}>
                                {(() => {
                                    const totalPages = getTotalPages();
                                    const pages = [];
                                    let startPage = Math.max(1, currentPage - 2);
                                    let endPage = Math.min(totalPages, currentPage + 2);
                                    if (currentPage <= 3) endPage = Math.min(5, totalPages);
                                    if (currentPage >= totalPages - 2) startPage = Math.max(1, totalPages - 4);
                                    
                                    if (startPage > 1) {
                                        pages.push(<button key={1} onClick={() => setCurrentPage(1)} style={{ ...buttonStyle, padding: '8px 12px', background: isDark ? 'rgba(255,255,255,0.1)' : 'white', color: theme.text, border: `1px solid ${isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)'}`, borderRadius: '8px', minWidth: '36px', fontSize: '12px', fontWeight: '500' }}>1</button>);
                                        if (startPage > 2) pages.push(<span key="s" style={{ padding: '0 6px', color: theme.textSecondary, fontWeight: '500' }}>‚Ä¶</span>);
                                    }
                                    for (let i = startPage; i <= endPage; i++) {
                                        pages.push(<button key={i} onClick={() => setCurrentPage(i)} style={{ 
                                            ...buttonStyle, padding: '8px 12px', 
                                            background: currentPage === i ? '#3b82f6' : (isDark ? 'rgba(255,255,255,0.1)' : 'white'), 
                                            color: currentPage === i ? 'white' : theme.text, 
                                            border: currentPage === i ? 'none' : `1px solid ${isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)'}`, 
                                            borderRadius: '8px', fontWeight: currentPage === i ? '700' : '500', minWidth: '36px', fontSize: '12px',
                                            boxShadow: currentPage === i ? '0 2px 8px rgba(59,130,246,0.4)' : 'none'
                                        }}>{i}</button>);
                                    }
                                    if (endPage < totalPages) {
                                        if (endPage < totalPages - 1) pages.push(<span key="e" style={{ padding: '0 6px', color: theme.textSecondary, fontWeight: '500' }}>‚Ä¶</span>);
                                        pages.push(<button key={totalPages} onClick={() => setCurrentPage(totalPages)} style={{ ...buttonStyle, padding: '8px 12px', background: isDark ? 'rgba(255,255,255,0.1)' : 'white', color: theme.text, border: `1px solid ${isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)'}`, borderRadius: '8px', minWidth: '36px', fontSize: '12px', fontWeight: '500' }}>{totalPages}</button>);
                                    }
                                    return pages;
                                })()}
                            </div>
                            
                            <button onClick={() => setCurrentPage(p => Math.min(getTotalPages(), p + 1))} disabled={currentPage === getTotalPages()} style={{ 
                                ...buttonStyle, padding: '8px 14px', 
                                background: currentPage === getTotalPages() ? (isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.03)') : (isDark ? 'rgba(255,255,255,0.1)' : 'white'),
                                color: currentPage === getTotalPages() ? theme.textMuted : theme.text, 
                                border: `1px solid ${isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)'}`, 
                                borderRadius: '8px', fontSize: '12px', fontWeight: '500',
                                opacity: currentPage === getTotalPages() ? 0.5 : 1, cursor: currentPage === getTotalPages() ? 'not-allowed' : 'pointer'
                            }}>Next ‚Üí</button>
                            <button onClick={() => setCurrentPage(getTotalPages())} disabled={currentPage === getTotalPages()} style={{ 
                                ...buttonStyle, padding: '8px 12px', 
                                background: currentPage === getTotalPages() ? (isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.03)') : (isDark ? 'rgba(255,255,255,0.1)' : 'white'),
                                color: currentPage === getTotalPages() ? theme.textMuted : theme.text, 
                                border: `1px solid ${isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)'}`, 
                                borderRadius: '8px', fontSize: '12px', fontWeight: '600',
                                opacity: currentPage === getTotalPages() ? 0.5 : 1, cursor: currentPage === getTotalPages() ? 'not-allowed' : 'pointer'
                            }}>‚ü´</button>
                            
                            <div style={{ marginLeft: '12px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                                <span style={{ color: theme.textSecondary, fontSize: '12px', fontWeight: '500' }}>Go to</span>
                                <input type="number" min={1} max={getTotalPages()} value={currentPage} onChange={(e) => { const p = parseInt(e.target.value); if (p >= 1 && p <= getTotalPages()) setCurrentPage(p); }} style={{ 
                                    ...inputStyle, width: '50px', padding: '6px 10px', textAlign: 'center', fontSize: '12px', fontWeight: '600',
                                    borderRadius: '8px', border: `1px solid ${isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)'}`,
                                    background: isDark ? 'rgba(255,255,255,0.1)' : 'white'
                                }} />
                            </div>
                        </div>
                    </div>
                )}
            </div>
            ) : (
            /* Expenses Table - Show when on expenses tab */
            <div style={{ overflowX: 'auto', background: theme.bg }}>
                <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                    <thead>
                        <tr style={{ background: theme.bgTertiary, borderBottom: `2px solid ${theme.border}` }}>
                            <th style={{ padding: '16px 20px', textAlign: 'left', fontSize: '11px', fontWeight: '700', color: theme.textSecondary, textTransform: 'uppercase', letterSpacing: '0.5px' }}>Date</th>
                            <th style={{ padding: '16px 20px', textAlign: 'left', fontSize: '11px', fontWeight: '700', color: theme.textSecondary, textTransform: 'uppercase', letterSpacing: '0.5px' }}>Category</th>
                            <th style={{ padding: '16px 20px', textAlign: 'left', fontSize: '11px', fontWeight: '700', color: theme.textSecondary, textTransform: 'uppercase', letterSpacing: '0.5px' }}>Description</th>
                            <th style={{ padding: '16px 20px', textAlign: 'left', fontSize: '11px', fontWeight: '700', color: theme.textSecondary, textTransform: 'uppercase', letterSpacing: '0.5px' }}>Vendor</th>
                            <th style={{ padding: '16px 20px', textAlign: 'right', fontSize: '11px', fontWeight: '700', color: theme.textSecondary, textTransform: 'uppercase', letterSpacing: '0.5px' }}>Amount</th>
                            <th style={{ padding: '16px 20px', textAlign: 'center', fontSize: '11px', fontWeight: '700', color: theme.textSecondary, textTransform: 'uppercase', letterSpacing: '0.5px' }}>Payment Method</th>
                        </tr>
                    </thead>
                    <tbody>
                        {expenses.length === 0 ? (
                            <tr>
                                <td colSpan="6" style={{ padding: '60px 20px', textAlign: 'center', color: theme.textSecondary }}>
                                    <div style={{ fontSize: '48px', marginBottom: '16px', opacity: 0.5 }}>üìã</div>
                                    <div style={{ fontSize: '14px', fontWeight: '600' }}>No expenses recorded</div>
                                    <div style={{ fontSize: '12px', marginTop: '4px' }}>Add expenses from the Expenses module</div>
                                </td>
                            </tr>
                        ) : (
                            expenses.slice(0, 20).map((expense, idx) => {
                                const categoryColors = {
                                    'Utilities': '#3b82f6',
                                    'Supplies': '#10b981',
                                    'Salaries': '#8b5cf6',
                                    'Maintenance': '#f59e0b',
                                    'Rent': '#ef4444',
                                    'Marketing': '#ec4899',
                                    'Insurance': '#6366f1',
                                    'Taxes': '#f97316',
                                    'Other': '#6b7280'
                                };
                                return (
                                    <tr key={expense.id} style={{ borderBottom: `1px solid ${theme.border}`, background: idx % 2 === 0 ? theme.bg : theme.bgSecondary }}>
                                        <td style={{ padding: '16px 20px', color: theme.text, fontSize: '13px' }}>
                                            {expense.date}
                                        </td>
                                        <td style={{ padding: '16px 20px' }}>
                                            <span style={{ 
                                                background: `${categoryColors[expense.category] || '#6b7280'}20`,
                                                color: categoryColors[expense.category] || '#6b7280',
                                                padding: '4px 12px',
                                                fontSize: '11px',
                                                fontWeight: '700',
                                                textTransform: 'uppercase',
                                                letterSpacing: '0.3px'
                                            }}>
                                                {expense.category}
                                            </span>
                                        </td>
                                        <td style={{ padding: '16px 20px', color: theme.text, fontWeight: '500' }}>
                                            {expense.description}
                                        </td>
                                        <td style={{ padding: '16px 20px', color: theme.textSecondary, fontSize: '13px' }}>
                                            {expense.vendor || '-'}
                                        </td>
                                        <td style={{ padding: '16px 20px', textAlign: 'right', fontWeight: '800', color: '#ef4444', fontSize: '15px' }}>
                                            -{formatCurrency(expense.amount)}
                                        </td>
                                        <td style={{ padding: '16px 20px', textAlign: 'center' }}>
                                            <span style={{ 
                                                background: expense.paymentMethod === 'mpesa' ? '#d1fae5' : (expense.paymentMethod === 'bank' ? '#dbeafe' : theme.bgTertiary),
                                                color: expense.paymentMethod === 'mpesa' ? '#047857' : (expense.paymentMethod === 'bank' ? '#1d4ed8' : theme.text),
                                                padding: '4px 10px',
                                                fontSize: '11px',
                                                fontWeight: '600',
                                                textTransform: 'uppercase'
                                            }}>
                                                {expense.paymentMethod || 'Cash'}
                                            </span>
                                        </td>
                                    </tr>
                                );
                            })
                        )}
                    </tbody>
                </table>
                {expenses.length > 20 && (
                    <div style={{ padding: '16px', textAlign: 'center', background: theme.bgSecondary, borderTop: `1px solid ${theme.border}` }}>
                        <span style={{ color: theme.textSecondary, fontSize: '13px' }}>
                            Showing 20 of {expenses.length} expenses. Go to Expenses module to see all.
                        </span>
                    </div>
                )}
            </div>
            )}

            {/* Activity Log Tab - Simple & Clean */}
            {activeTab === 'activity' && (
            <div style={{ ...cardStyle, marginTop: '20px', padding: 0, overflow: 'hidden' }}>
                {/* Simple Header */}
                <div style={{ 
                    padding: '16px 20px', 
                    background: theme.bgSecondary,
                    borderBottom: `1px solid ${theme.border}`,
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center'
                }}>
                    <div style={{ fontSize: '15px', fontWeight: '600', color: theme.text }}>Activity Log</div>
                    <button 
                        onClick={loadBillingActivityLogs} 
                        style={{ 
                            background: 'none', 
                            border: `1px solid ${theme.border}`, 
                            padding: '6px 12px', 
                            borderRadius: '6px', 
                            color: theme.textSecondary, 
                            cursor: 'pointer',
                            fontSize: '12px'
                        }}
                    >
                        Refresh
                    </button>
                </div>
                
                {/* Content */}
                {activityLogsLoading ? (
                    <div style={{ padding: '40px 20px', textAlign: 'center', color: theme.textSecondary }}>
                        Loading...
                    </div>
                ) : billingActivityLogs.length === 0 ? (
                    <div style={{ padding: '40px 20px', textAlign: 'center' }}>
                        <div style={{ fontSize: '14px', color: theme.textSecondary }}>No deletions recorded</div>
                    </div>
                ) : (
                    <div style={{ maxHeight: '500px', overflowY: 'auto' }}>
                        {billingActivityLogs.map((log, idx) => {
                            // Determine styles and icons based on action type
                            const isDelete = log.action === 'DELETE_INVOICE';
                            const isPayment = log.action === 'PAYMENT_RECEIVED';
                            const isRevert = log.action === 'PAYMENT_REVERTED';
                            
                            let icon = 'üìã';
                            let actionColor = theme.text;
                            let actionText = 'processed';
                            
                            if (isDelete) {
                                icon = 'üóëÔ∏è';
                                actionColor = '#ef4444';
                                actionText = 'deleted';
                            } else if (isPayment) {
                                icon = 'üí∞';
                                actionColor = '#10b981';
                                actionText = 'paid';
                            } else if (isRevert) {
                                icon = '‚Ü©Ô∏è';
                                actionColor = '#f59e0b';
                                actionText = 'reverted';
                            }

                            // Get user info (support both field names for backward compatibility)
                            const user = log.processedBy || log.deletedBy || {};
                            const userName = user.displayName || user.email || 'Unknown User';

                            return (
                                <div key={log.id} style={{ 
                                    padding: '16px 20px', 
                                    borderBottom: `1px solid ${theme.border}`,
                                    background: idx % 2 === 0 ? theme.bg : theme.bgSecondary
                                }}>
                                    {/* Row 1: Action & Time */}
                                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '10px' }}>
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                            <span style={{ fontSize: '14px' }}>{icon}</span>
                                            <span style={{ fontWeight: '600', color: theme.text, fontSize: '14px' }}>{log.invoiceNumber}</span>
                                            <span style={{ color: actionColor, fontSize: '12px', fontWeight: '500', textTransform: 'uppercase' }}>{actionText}</span>
                                        </div>
                                        <div style={{ fontSize: '12px', color: theme.textSecondary }}>{log.date} ‚Ä¢ {log.time}</div>
                                    </div>
                                    
                                    {/* Row 2: By whom */}
                                    <div style={{ fontSize: '13px', color: theme.text, marginBottom: '8px' }}>
                                        <span style={{ color: theme.textSecondary }}>By:</span> {userName}
                                    </div>
                                    
                                    {/* Row 3: Details (Reason or Payment Info) */}
                                    {log.reason && (
                                        <div style={{ 
                                            background: isDark ? 'rgba(239,68,68,0.1)' : '#fef2f2', 
                                            padding: '10px 12px', 
                                            borderRadius: '6px',
                                            fontSize: '13px',
                                            marginBottom: '10px'
                                        }}>
                                            <span style={{ color: theme.textSecondary, fontSize: '11px' }}>Reason:</span>
                                            <div style={{ color: theme.text, marginTop: '4px' }}>"{log.reason}"</div>
                                        </div>
                                    )}

                                    {/* Payment specific details */}
                                    {isPayment && (
                                        <div style={{ 
                                            background: isDark ? 'rgba(16, 185, 129, 0.1)' : '#ecfdf5', 
                                            padding: '8px 12px', 
                                            borderRadius: '6px', 
                                            marginBottom: '10px',
                                            fontSize: '12px'
                                        }}>
                                            <div style={{ display: 'flex', gap: '15px' }}>
                                                <span>Method: <strong>{log.invoiceData?.paymentMethod || log.paymentMethod || 'Cash'}</strong></span>
                                                {log.invoiceData?.mpesaCode && <span>Code: <strong>{log.invoiceData.mpesaCode}</strong></span>}
                                                {log.invoiceData?.transactionRef && <span>Ref: <strong>{log.invoiceData.transactionRef}</strong></span>}
                                            </div>
                                        </div>
                                    )}
                                    
                                    {/* Row 4: Invoice details */}
                                    {log.invoiceData && (
                                        <div style={{ display: 'flex', flexWrap: 'wrap', gap: '16px', fontSize: '12px', color: theme.textSecondary }}>
                                            <span><strong style={{ color: theme.text }}>{log.invoiceData.customerName || 'Walk-in'}</strong></span>
                                            <span>Plate: <strong style={{ color: theme.text }}>{log.invoiceData.plateNumber || '-'}</strong></span>
                                            <span>Amount: <strong style={{ color: isDelete ? '#ef4444' : isPayment ? '#10b981' : theme.text }}>{formatCurrency(log.invoiceData.totalAmount)}</strong></span>
                                        </div>
                                    )}
                                </div>
                            );
                        })}
                    </div>
                )}
            </div>
            )}

            {/* Delete Confirmation Modal - Simple & Clean */}
            {showDeleteModal && deleteTarget && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: theme.modalOverlay, display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 }} onClick={() => { setShowDeleteModal(false); setDeleteTarget(null); setDeleteReason(''); }}>
                    <div style={{ background: theme.bg, width: '400px', maxWidth: '90vw', borderRadius: '12px', boxShadow: '0 20px 60px rgba(0,0,0,0.3)' }} onClick={(e) => e.stopPropagation()}>
                        {/* Header */}
                        <div style={{ padding: '20px', borderBottom: `1px solid ${theme.border}` }}>
                            <div style={{ fontSize: '16px', fontWeight: '600', color: theme.text }}>Delete Invoice</div>
                            <div style={{ fontSize: '13px', color: theme.textSecondary, marginTop: '4px' }}>
                                {deleteTarget.invoiceNumber || deleteTarget.id?.slice(0,8).toUpperCase()} ‚Ä¢ {deleteTarget.customerName || 'Walk-in'} ‚Ä¢ {formatCurrency(deleteTarget.totalAmount)}
                            </div>
                        </div>
                        
                        {/* Body */}
                        <div style={{ padding: '20px' }}>
                            <label style={{ display: 'block', marginBottom: '8px', fontSize: '13px', fontWeight: '500', color: theme.text }}>
                                Reason for deletion <span style={{ color: '#ef4444' }}>*</span>
                            </label>
                            <textarea
                                value={deleteReason}
                                onChange={(e) => setDeleteReason(e.target.value)}
                                placeholder="Why is this invoice being deleted? (min 10 characters)"
                                style={{ 
                                    ...inputStyle, 
                                    width: '100%', 
                                    minHeight: '80px', 
                                    resize: 'vertical',
                                    fontFamily: 'inherit',
                                    borderRadius: '8px'
                                }}
                            />
                            <div style={{ marginTop: '6px', fontSize: '11px', color: deleteReason.length >= 10 ? '#10b981' : theme.textSecondary }}>
                                {deleteReason.length >= 10 ? '‚úì Ready' : `${deleteReason.length}/10 characters`}
                            </div>
                            
                            <div style={{ 
                                marginTop: '16px',
                                padding: '10px 12px', 
                                background: isDark ? 'rgba(245,158,11,0.1)' : '#fffbeb',
                                borderRadius: '6px',
                                fontSize: '12px',
                                color: '#92400e'
                            }}>
                                This action will be logged with your name and timestamp.
                            </div>
                        </div>
                        
                        {/* Footer */}
                        <div style={{ padding: '16px 20px', borderTop: `1px solid ${theme.border}`, display: 'flex', gap: '10px' }}>
                            <button
                                onClick={() => { setShowDeleteModal(false); setDeleteTarget(null); setDeleteReason(''); }}
                                style={{ 
                                    flex: 1, 
                                    padding: '12px', 
                                    background: theme.bgSecondary, 
                                    color: theme.text, 
                                    border: 'none',
                                    borderRadius: '8px',
                                    fontSize: '14px',
                                    fontWeight: '500',
                                    cursor: 'pointer'
                                }}
                            >
                                Cancel
                            </button>
                            <button
                                onClick={confirmDeleteInvoice}
                                disabled={deleteLoading || deleteReason.trim().length < 10}
                                style={{ 
                                    flex: 1, 
                                    padding: '12px', 
                                    background: deleteReason.trim().length >= 10 ? '#ef4444' : '#d1d5db', 
                                    color: 'white', 
                                    border: 'none',
                                    borderRadius: '8px',
                                    fontSize: '14px',
                                    fontWeight: '500',
                                    cursor: deleteReason.trim().length >= 10 ? 'pointer' : 'not-allowed',
                                    opacity: deleteLoading ? 0.6 : 1
                                }}
                            >
                                {deleteLoading ? 'Deleting...' : 'Delete'}
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* Payment Method Modal */}
            {showPaymentModal && selectedInvoice && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: theme.modalOverlay, display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 }} onClick={() => setShowPaymentModal(false)}>
                    <div style={{ ...cardStyle, width: '420px', maxWidth: '90vw' }} onClick={(e) => e.stopPropagation()}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px', paddingBottom: '16px', borderBottom: `2px solid ${theme.border}` }}>
                            <h3 style={{ margin: 0, color: theme.text, fontSize: '18px', fontWeight: '700', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Record Payment</h3>
                            <button onClick={() => setShowPaymentModal(false)} style={{ background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer', color: theme.textSecondary }}>‚úï</button>
                        </div>

                        <div style={{ background: theme.bgSecondary, padding: '20px', borderRadius: '0', marginBottom: '24px', borderLeft: '4px solid #3b82f6' }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '10px' }}>
                                <span style={{ color: theme.textSecondary, fontSize: '12px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Invoice:</span>
                                <span style={{ fontWeight: '700', color: theme.text }}>{selectedInvoice.invoiceNumber}</span>
                            </div>
                            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '10px' }}>
                                <span style={{ color: theme.textSecondary, fontSize: '12px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Customer:</span>
                                <span style={{ color: theme.text, fontWeight: '500' }}>{selectedInvoice.customerName || 'Walk-in'}</span>
                            </div>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', paddingTop: '12px', borderTop: `1px solid ${theme.border}` }}>
                                <span style={{ color: theme.textSecondary, fontSize: '12px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Amount Due:</span>
                                <span style={{ fontWeight: '800', fontSize: '24px', color: '#10b981' }}>{formatCurrency(selectedInvoice.totalAmount)}</span>
                            </div>
                        </div>

                        <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '16px' }}>
                            <div style={{ fontWeight: '700', color: theme.text, fontSize: '12px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Select Payment Method:</div>
                            {/* Cash visibility toggle */}
                            <button
                                type="button"
                                onClick={toggleCashVisibility}
                                title={hideCashPayment ? 'Show Cash option' : 'Hide Cash option'}
                                style={{
                                    background: 'transparent',
                                    border: 'none',
                                    cursor: 'pointer',
                                    fontSize: '14px',
                                    padding: '2px 6px',
                                    borderRadius: '4px',
                                    color: theme.textSecondary,
                                    opacity: 0.6
                                }}
                            >
                                {hideCashPayment ? 'üëÅÔ∏è‚Äçüó®Ô∏è' : 'üëÅÔ∏è'}
                            </button>
                        </div>

                        <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                            {/* Cash Payment - Hidden when hideCashPayment is true */}
                            {!hideCashPayment && (
                                <button
                                    onClick={handleCashPayment}
                                    disabled={actionLoading}
                                    style={{ 
                                        ...buttonStyle, 
                                        padding: '18px', 
                                        background: '#10b981', 
                                        color: 'white',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        gap: '12px',
                                        fontSize: '14px'
                                    }}
                                >
                                    <span style={{ fontSize: '24px' }}>üíµ</span>
                                    {actionLoading ? 'PROCESSING...' : 'CASH PAYMENT'}
                                </button>
                            )}

                            <button
                                onClick={openMpesaModal}
                                style={{ 
                                    ...buttonStyle, 
                                    padding: '18px', 
                                    background: 'linear-gradient(135deg, #00a651 0%, #007a3d 100%)', 
                                    color: 'white',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    gap: '12px',
                                    fontSize: '14px'
                                }}
                            >
                                <span style={{ fontSize: '24px' }}>üì±</span>
                                M-PESA PAYMENT
                            </button>

                            <button
                                onClick={openCardModal}
                                style={{ 
                                    ...buttonStyle, 
                                    padding: '18px', 
                                    background: 'linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%)', 
                                    color: 'white',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    gap: '12px',
                                    fontSize: '14px'
                                }}
                            >
                                <span style={{ fontSize: '24px' }}>üí≥</span>
                                CARD PAYMENT
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* M-Pesa Payment Modal */}
            {showMpesaModal && selectedInvoice && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: theme.modalOverlay, display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 }} onClick={() => !mpesaLoading && setShowMpesaModal(false)}>
                    <div style={{ ...cardStyle, width: '440px', maxWidth: '90vw' }} onClick={(e) => e.stopPropagation()}>
                        <div style={{ textAlign: 'center', marginBottom: '28px', paddingBottom: '20px', borderBottom: `2px solid ${theme.border}` }}>
                            <div style={{ 
                                width: '80px', 
                                height: '80px', 
                                margin: '0 auto 16px', 
                                background: 'linear-gradient(135deg, #00a651 0%, #007a3d 100%)', 
                                borderRadius: '0',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                fontSize: '36px',
                                color: 'white'
                            }}>üì±</div>
                            <h3 style={{ margin: '0 0 8px', color: theme.text, fontSize: '18px', fontWeight: '700', textTransform: 'uppercase', letterSpacing: '0.5px' }}>M-Pesa Payment</h3>
                            <p style={{ margin: 0, color: theme.textSecondary, fontSize: '14px', fontWeight: '500' }}>
                                {selectedInvoice.invoiceNumber} ‚Ä¢ {formatCurrency(selectedInvoice.totalAmount)}
                            </p>
                        </div>

                        {/* Status Display */}
                        {mpesaStatus && (
                            <div style={{ 
                                padding: '20px', 
                                borderRadius: '0', 
                                marginBottom: '24px',
                                textAlign: 'center',
                                background: mpesaStatus.status === 'success' ? '#d1fae520' : 
                                            mpesaStatus.status === 'failed' ? '#fee2e220' : 
                                            '#dbeafe20',
                                borderLeft: `4px solid ${
                                    mpesaStatus.status === 'success' ? '#10b981' : 
                                    mpesaStatus.status === 'failed' ? '#ef4444' : 
                                    '#3b82f6'
                                }`
                            }}>
                                <div style={{ 
                                    fontSize: '36px', 
                                    marginBottom: '12px' 
                                }}>
                                    {mpesaStatus.status === 'success' ? '‚úÖ' : 
                                     mpesaStatus.status === 'failed' ? '‚ùå' : 
                                     mpesaStatus.status === 'pending' ? 'üì≤' : '‚è≥'}
                                </div>
                                <div style={{ 
                                    color: mpesaStatus.status === 'success' ? '#10b981' : 
                                           mpesaStatus.status === 'failed' ? '#ef4444' : 
                                           '#3b82f6',
                                    fontWeight: '600',
                                    fontSize: '14px'
                                }}>
                                    {mpesaStatus.message}
                                </div>

                                {/* Simulate button for testing */}
                                {mpesaStatus.status === 'pending' && mpesaPaymentId && (
                                    <button
                                        onClick={handleSimulateMpesaSuccess}
                                        style={{ 
                                            ...buttonStyle, 
                                            marginTop: '16px',
                                            background: '#f59e0b', 
                                            color: 'white',
                                            fontSize: '11px',
                                            padding: '10px 16px'
                                        }}
                                    >
                                        üß™ SIMULATE SUCCESS (TESTING)
                                    </button>
                                )}
                            </div>
                        )}

                        {/* Mode Toggle */}
                        {(!mpesaStatus || mpesaStatus.status === 'failed') && (
                            <div style={{ display: 'flex', marginBottom: '20px', borderRadius: '0', overflow: 'hidden', border: `1px solid ${theme.border}` }}>
                                <button
                                    onClick={() => setMpesaMode('stk')}
                                    style={{
                                        flex: 1,
                                        padding: '12px',
                                        border: 'none',
                                        background: mpesaMode === 'stk' ? 'linear-gradient(135deg, #00a651 0%, #007a3d 100%)' : theme.bgSecondary,
                                        color: mpesaMode === 'stk' ? 'white' : theme.textSecondary,
                                        fontWeight: '600',
                                        fontSize: '12px',
                                        cursor: 'pointer',
                                        textTransform: 'uppercase',
                                        letterSpacing: '0.5px'
                                    }}
                                >
                                    üì≤ STK Push
                                </button>
                                <button
                                    onClick={() => setMpesaMode('manual')}
                                    style={{
                                        flex: 1,
                                        padding: '12px',
                                        border: 'none',
                                        borderLeft: `1px solid ${theme.border}`,
                                        background: mpesaMode === 'manual' ? 'linear-gradient(135deg, #00a651 0%, #007a3d 100%)' : theme.bgSecondary,
                                        color: mpesaMode === 'manual' ? 'white' : theme.textSecondary,
                                        fontWeight: '600',
                                        fontSize: '12px',
                                        cursor: 'pointer',
                                        textTransform: 'uppercase',
                                        letterSpacing: '0.5px'
                                    }}
                                >
                                    ‚úèÔ∏è Enter Code
                                </button>
                            </div>
                        )}

                        {/* STK Push Mode */}
                        {mpesaMode === 'stk' && (!mpesaStatus || mpesaStatus.status === 'failed') && (
                            <>
                                <div style={{ marginBottom: '24px' }}>
                                    <label style={{ display: 'block', marginBottom: '10px', fontWeight: '700', color: theme.text, fontSize: '12px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>
                                        Phone Number
                                    </label>
                                    <input
                                        type="tel"
                                        value={mpesaPhone}
                                        onChange={(e) => setMpesaPhone(e.target.value)}
                                        placeholder="e.g., 0712345678 or 254712345678"
                                        style={{ ...inputStyle, padding: '14px 16px', fontSize: '16px' }}
                                    />
                                    <p style={{ margin: '10px 0 0', fontSize: '11px', color: theme.textSecondary, textTransform: 'uppercase', letterSpacing: '0.3px' }}>
                                        Enter the M-Pesa registered phone number
                                    </p>
                                </div>

                                <div style={{ display: 'flex', gap: '0' }}>
                                    <button
                                        onClick={() => setShowMpesaModal(false)}
                                        style={{ ...buttonStyle, flex: 1, background: theme.bgSecondary, color: theme.text, padding: '16px' }}
                                    >
                                        CANCEL
                                    </button>
                                    <button
                                        onClick={handleMpesaPayment}
                                        disabled={mpesaLoading || !mpesaPhone}
                                        style={{ 
                                            ...buttonStyle, 
                                            flex: 2, 
                                            background: 'linear-gradient(135deg, #00a651 0%, #007a3d 100%)', 
                                            color: 'white',
                                            opacity: mpesaLoading || !mpesaPhone ? 0.6 : 1,
                                            padding: '16px'
                                        }}
                                    >
                                        {mpesaLoading ? 'SENDING...' : 'SEND STK PUSH'}
                                    </button>
                                </div>
                            </>
                        )}

                        {/* Manual Code Entry Mode */}
                        {mpesaMode === 'manual' && (!mpesaStatus || mpesaStatus.status === 'failed') && (
                            <>
                                <div style={{ marginBottom: '16px' }}>
                                    <label style={{ display: 'block', marginBottom: '10px', fontWeight: '700', color: theme.text, fontSize: '12px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>
                                        M-Pesa Transaction Code *
                                    </label>
                                    <input
                                        type="text"
                                        value={manualMpesaCode}
                                        onChange={(e) => setManualMpesaCode(e.target.value.toUpperCase())}
                                        placeholder="e.g., QJK3L5M7N9"
                                        style={{ ...inputStyle, padding: '14px 16px', fontSize: '16px', fontFamily: 'monospace', letterSpacing: '2px' }}
                                        maxLength={12}
                                    />
                                    <p style={{ margin: '10px 0 0', fontSize: '11px', color: theme.textSecondary, textTransform: 'uppercase', letterSpacing: '0.3px' }}>
                                        Enter the M-Pesa confirmation code from SMS
                                    </p>
                                </div>

                                <div style={{ marginBottom: '24px' }}>
                                    <label style={{ display: 'block', marginBottom: '10px', fontWeight: '700', color: theme.text, fontSize: '12px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>
                                        Phone Number (Optional)
                                    </label>
                                    <input
                                        type="tel"
                                        value={mpesaPhone}
                                        onChange={(e) => setMpesaPhone(e.target.value)}
                                        placeholder="e.g., 0712345678"
                                        style={{ ...inputStyle, padding: '14px 16px', fontSize: '16px' }}
                                    />
                                </div>

                                <div style={{ display: 'flex', gap: '0' }}>
                                    <button
                                        onClick={() => setShowMpesaModal(false)}
                                        style={{ ...buttonStyle, flex: 1, background: theme.bgSecondary, color: theme.text, padding: '16px' }}
                                    >
                                        CANCEL
                                    </button>
                                    <button
                                        onClick={handleManualMpesaPayment}
                                        disabled={mpesaLoading || !manualMpesaCode.trim()}
                                        style={{ 
                                            ...buttonStyle, 
                                            flex: 2, 
                                            background: 'linear-gradient(135deg, #00a651 0%, #007a3d 100%)', 
                                            color: 'white',
                                            opacity: mpesaLoading || !manualMpesaCode.trim() ? 0.6 : 1,
                                            padding: '16px'
                                        }}
                                    >
                                        {mpesaLoading ? 'RECORDING...' : 'CONFIRM PAYMENT'}
                                    </button>
                                </div>
                            </>
                        )}

                        {mpesaStatus?.status === 'success' && (
                            <button
                                onClick={() => {
                                    setShowMpesaModal(false);
                                    setSelectedInvoice(null);
                                    setMpesaStatus(null);
                                }}
                                style={{ ...buttonStyle, width: '100%', background: '#10b981', color: 'white', padding: '16px' }}
                            >
                                Done
                            </button>
                        )}
                    </div>
                </div>
            )}

            {/* Card Payment Modal */}
            {showCardModal && selectedInvoice && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: theme.modalOverlay, display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 }} onClick={() => !actionLoading && setShowCardModal(false)}>
                    <div style={{ ...cardStyle, width: '440px', maxWidth: '90vw' }} onClick={(e) => e.stopPropagation()}>
                        <div style={{ textAlign: 'center', marginBottom: '28px', paddingBottom: '20px', borderBottom: `2px solid ${theme.border}` }}>
                            <div style={{ 
                                width: '80px', 
                                height: '80px', 
                                margin: '0 auto 16px', 
                                background: 'linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%)', 
                                borderRadius: '0',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                fontSize: '36px',
                                color: 'white'
                            }}>üí≥</div>
                            <h3 style={{ margin: '0 0 8px', color: theme.text, fontSize: '18px', fontWeight: '700', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Card Payment</h3>
                            <p style={{ margin: 0, color: theme.textSecondary, fontSize: '14px', fontWeight: '500' }}>
                                {selectedInvoice.invoiceNumber} ‚Ä¢ {formatCurrency(selectedInvoice.totalAmount)}
                            </p>
                        </div>

                        <div style={{ marginBottom: '16px' }}>
                            <label style={{ display: 'block', marginBottom: '10px', fontWeight: '700', color: theme.text, fontSize: '12px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>
                                Transaction Reference / Approval Code *
                            </label>
                            <input
                                type="text"
                                value={cardDetails.transactionRef}
                                onChange={(e) => setCardDetails(prev => ({ ...prev, transactionRef: e.target.value }))}
                                placeholder="e.g., TXN123456789"
                                style={{ ...inputStyle, padding: '14px 16px', fontSize: '16px' }}
                            />
                            <p style={{ margin: '10px 0 0', fontSize: '11px', color: theme.textSecondary, textTransform: 'uppercase', letterSpacing: '0.3px' }}>
                                Enter the transaction reference from POS receipt
                            </p>
                        </div>

                        <div style={{ marginBottom: '24px' }}>
                            <label style={{ display: 'block', marginBottom: '10px', fontWeight: '700', color: theme.text, fontSize: '12px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>
                                Last 4 Digits of Card (Optional)
                            </label>
                            <input
                                type="text"
                                value={cardDetails.lastFourDigits}
                                onChange={(e) => {
                                    const val = e.target.value.replace(/\D/g, '').slice(0, 4);
                                    setCardDetails(prev => ({ ...prev, lastFourDigits: val }));
                                }}
                                placeholder="e.g., 1234"
                                style={{ ...inputStyle, padding: '14px 16px', fontSize: '16px', fontFamily: 'monospace', letterSpacing: '4px' }}
                                maxLength={4}
                            />
                        </div>

                        <div style={{ display: 'flex', gap: '0' }}>
                            <button
                                onClick={() => setShowCardModal(false)}
                                style={{ ...buttonStyle, flex: 1, background: theme.bgSecondary, color: theme.text, padding: '16px' }}
                            >
                                CANCEL
                            </button>
                            <button
                                onClick={handleCardPayment}
                                disabled={actionLoading || !cardDetails.transactionRef.trim()}
                                style={{ 
                                    ...buttonStyle, 
                                    flex: 2, 
                                    background: 'linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%)', 
                                    color: 'white',
                                    opacity: actionLoading || !cardDetails.transactionRef.trim() ? 0.6 : 1,
                                    padding: '16px'
                                }}
                            >
                                {actionLoading ? 'RECORDING...' : 'CONFIRM PAYMENT'}
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* Invoice Detail Modal - Clean & Simple */}
            {showInvoiceDetailModal && selectedInvoice && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: theme.modalOverlay, display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 }} onClick={() => setShowInvoiceDetailModal(false)}>
                    <div style={{ background: theme.bg, width: '480px', maxWidth: '90vw', maxHeight: '85vh', overflowY: 'auto', borderRadius: '12px', boxShadow: '0 20px 60px rgba(0,0,0,0.3)' }} onClick={(e) => e.stopPropagation()}>
                        
                        {/* Header */}
                        <div style={{ padding: '24px 24px 20px', borderBottom: `1px solid ${theme.border}` }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                                <div>
                                    <div style={{ fontSize: '11px', color: theme.textSecondary, textTransform: 'uppercase', letterSpacing: '1px', marginBottom: '4px' }}>Invoice</div>
                                    <div style={{ fontSize: '20px', fontWeight: '700', color: theme.text }}>{selectedInvoice.invoiceNumber || selectedInvoice.id?.slice(0,8).toUpperCase()}</div>
                                </div>
                                <button onClick={() => setShowInvoiceDetailModal(false)} style={{ background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer', color: theme.textSecondary, padding: '0', lineHeight: '1' }}>√ó</button>
                            </div>
                        </div>

                        {/* Content */}
                        <div style={{ padding: '24px' }}>
                            
                            {/* Customer & Vehicle Row */}
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px', marginBottom: '24px' }}>
                                <div>
                                    <div style={{ fontSize: '11px', color: theme.textSecondary, marginBottom: '6px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Customer</div>
                                    <div style={{ fontSize: '15px', fontWeight: '600', color: theme.text }}>{selectedInvoice.customerName || 'Walk-in'}</div>
                                    {selectedInvoice.customerPhone && (
                                        <div style={{ fontSize: '13px', color: theme.textSecondary, marginTop: '2px' }}>{selectedInvoice.customerPhone}</div>
                                    )}
                                </div>
                                <div>
                                    <div style={{ fontSize: '11px', color: theme.textSecondary, marginBottom: '6px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Vehicle</div>
                                    <div style={{ fontSize: '15px', fontWeight: '700', color: theme.text, letterSpacing: '0.5px' }}>{selectedInvoice.plateNumber || '-'}</div>
                                    <div style={{ fontSize: '13px', color: theme.textSecondary, marginTop: '2px', textTransform: 'capitalize' }}>{selectedInvoice.source || 'Wash'}</div>
                                </div>
                            </div>

                            {/* Date & Status Row */}
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px', marginBottom: '24px' }}>
                                <div>
                                    <div style={{ fontSize: '11px', color: theme.textSecondary, marginBottom: '6px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Date</div>
                                    <div style={{ fontSize: '14px', color: theme.text }}>{formatDate(selectedInvoice.createdAt)}</div>
                                </div>
                                <div>
                                    <div style={{ fontSize: '11px', color: theme.textSecondary, marginBottom: '6px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Status</div>
                                    <div style={{ 
                                        display: 'inline-block',
                                        padding: '4px 12px', 
                                        borderRadius: '20px',
                                        fontSize: '11px', 
                                        fontWeight: '600',
                                        background: selectedInvoice.paymentStatus === 'paid' ? '#dcfce7' : '#fef3c7',
                                        color: selectedInvoice.paymentStatus === 'paid' ? '#166534' : '#92400e'
                                    }}>
                                        {selectedInvoice.paymentStatus === 'paid' ? '‚úì Paid' : 'Pending'}
                                    </div>
                                </div>
                            </div>

                            {/* Services */}
                            {selectedInvoice.services && selectedInvoice.services.length > 0 && (
                                <div style={{ marginBottom: '24px' }}>
                                    <div style={{ fontSize: '11px', color: theme.textSecondary, marginBottom: '12px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Services</div>
                                    <div style={{ background: theme.bgSecondary, borderRadius: '8px', overflow: 'hidden' }}>
                                        {selectedInvoice.services.map((service, idx) => (
                                            <div key={idx} style={{ 
                                                padding: '12px 16px', 
                                                borderBottom: idx < selectedInvoice.services.length - 1 ? `1px solid ${theme.border}` : 'none', 
                                                display: 'flex', 
                                                justifyContent: 'space-between',
                                                alignItems: 'center'
                                            }}>
                                                <span style={{ color: theme.text, fontSize: '14px' }}>{service.name || service}</span>
                                                <span style={{ fontWeight: '600', color: theme.text, fontSize: '14px' }}>{formatCurrency(service.price || 0)}</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {/* Total */}
                            <div style={{ 
                                background: theme.bgSecondary, 
                                padding: '16px 20px', 
                                borderRadius: '8px', 
                                marginBottom: '24px',
                                display: 'flex',
                                justifyContent: 'space-between',
                                alignItems: 'center'
                            }}>
                                <span style={{ fontSize: '14px', fontWeight: '600', color: theme.textSecondary }}>Total Amount</span>
                                <span style={{ fontSize: '24px', fontWeight: '700', color: '#10b981' }}>{formatCurrency(selectedInvoice.totalAmount)}</span>
                            </div>

                            {/* Payment Info - Only for paid invoices */}
                            {selectedInvoice.paymentStatus === 'paid' && (
                                <div style={{ 
                                    background: isDark ? 'rgba(16, 185, 129, 0.1)' : '#f0fdf4', 
                                    padding: '16px 20px', 
                                    borderRadius: '8px', 
                                    marginBottom: '24px'
                                }}>
                                    <div style={{ fontSize: '11px', color: '#10b981', marginBottom: '12px', textTransform: 'uppercase', letterSpacing: '0.5px', fontWeight: '600' }}>Payment Details</div>
                                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' }}>
                                        <div>
                                            <div style={{ fontSize: '11px', color: theme.textSecondary, marginBottom: '2px' }}>Method</div>
                                            <div style={{ fontSize: '14px', fontWeight: '600', color: theme.text }}>
                                                {selectedInvoice.paymentMethod === 'mpesa' || selectedInvoice.paymentMethod === 'm-pesa' ? 'M-Pesa' : 
                                                 selectedInvoice.paymentMethod === 'card' ? 'Card' : 'Cash'}
                                            </div>
                                        </div>
                                        <div>
                                            <div style={{ fontSize: '11px', color: theme.textSecondary, marginBottom: '2px' }}>Amount Paid</div>
                                            <div style={{ fontSize: '14px', fontWeight: '600', color: theme.text }}>{formatCurrency(selectedInvoice.paidAmount || selectedInvoice.totalAmount)}</div>
                                        </div>
                                        {(selectedInvoice.mpesaCode || selectedInvoice.transactionRef) && (
                                            <div style={{ gridColumn: '1 / -1' }}>
                                                <div style={{ fontSize: '11px', color: theme.textSecondary, marginBottom: '2px' }}>Reference</div>
                                                <div style={{ fontSize: '14px', fontWeight: '700', color: '#10b981', fontFamily: 'monospace' }}>
                                                    {selectedInvoice.mpesaCode || selectedInvoice.transactionRef}
                                                </div>
                                            </div>
                                        )}
                                        {selectedInvoice.paidAt && (
                                            <div style={{ gridColumn: '1 / -1' }}>
                                                <div style={{ fontSize: '11px', color: theme.textSecondary, marginBottom: '2px' }}>Paid At</div>
                                                <div style={{ fontSize: '13px', color: theme.text }}>{formatDate(selectedInvoice.paidAt)}</div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* Footer Actions */}
                        <div style={{ padding: '16px 24px 24px', display: 'flex', gap: '12px' }}>
                            <button
                                onClick={() => setShowInvoiceDetailModal(false)}
                                style={{ 
                                    flex: 1, 
                                    padding: '14px', 
                                    background: theme.bgSecondary, 
                                    color: theme.text, 
                                    border: 'none',
                                    borderRadius: '8px',
                                    fontSize: '14px',
                                    fontWeight: '600',
                                    cursor: 'pointer'
                                }}
                            >
                                Close
                            </button>
                            {selectedInvoice.paymentStatus === 'paid' ? (
                                <button
                                    onClick={() => { setShowInvoiceDetailModal(false); handlePrintReceipt(selectedInvoice); }}
                                    style={{ 
                                        flex: 1, 
                                        padding: '14px', 
                                        background: '#3b82f6', 
                                        color: 'white', 
                                        border: 'none',
                                        borderRadius: '8px',
                                        fontSize: '14px',
                                        fontWeight: '600',
                                        cursor: 'pointer'
                                    }}
                                >
                                    üßæ Print Receipt
                                </button>
                            ) : (
                                <button
                                    onClick={() => { setShowInvoiceDetailModal(false); openPaymentModal(selectedInvoice); }}
                                    style={{ 
                                        flex: 1, 
                                        padding: '14px', 
                                        background: '#10b981', 
                                        color: 'white', 
                                        border: 'none',
                                        borderRadius: '8px',
                                        fontSize: '14px',
                                        fontWeight: '600',
                                        cursor: 'pointer'
                                    }}
                                >
                                    üí≥ Record Payment
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            )}

            {/* Manual Billing Modal - Simple & Clean */}
            {showManualBillingModal && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: theme.modalOverlay, display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 }} onClick={() => { setShowManualBillingModal(false); setShowBillingPlateSearch(false); setExistingPendingInvoice(null); setApplyToExisting(true); }}>
                    <div style={{ ...cardStyle, width: '500px', maxWidth: '95vw', maxHeight: '90vh', overflowY: 'auto' }} onClick={(e) => e.stopPropagation()}>
                        {/* Header */}
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
                            <h3 style={{ margin: 0, color: theme.text, fontSize: '16px', fontWeight: '700' }}>
                                {existingPendingInvoice && applyToExisting ? 'üí≥ Apply Payment' : '‚ûï New Invoice'}
                            </h3>
                            <button onClick={() => { setShowManualBillingModal(false); setShowBillingPlateSearch(false); setExistingPendingInvoice(null); setApplyToExisting(true); }} style={{ background: 'none', border: 'none', fontSize: '20px', cursor: 'pointer', color: theme.textSecondary }}>‚úï</button>
                        </div>

                        {/* Customer & Vehicle Info */}
                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px', marginBottom: '16px' }}>
                            {/* Plate Number with Search */}
                            <div style={{ gridColumn: '1 / -1', position: 'relative' }}>
                                <div style={{ position: 'relative' }}>
                                    <input 
                                        type="text" 
                                        value={manualBillingData.plateNumber} 
                                        onChange={(e) => handleBillingPlateInputChange(e.target.value.toUpperCase())} 
                                        placeholder="üîç Search Plate Number / Carpet ID *" 
                                        autoFocus
                                        style={{ 
                                            ...inputStyle, 
                                            fontWeight: '700', 
                                            textTransform: 'uppercase', 
                                            fontSize: '15px', 
                                            padding: '12px',
                                            paddingRight: selectedIntakeRecord ? '100px' : '12px',
                                            borderColor: selectedIntakeRecord ? '#10b981' : undefined,
                                            background: selectedIntakeRecord ? (isDark ? '#10b98115' : '#f0fdf4') : undefined
                                        }} 
                                    />
                                    {selectedIntakeRecord && (
                                        <div style={{
                                            position: 'absolute',
                                            right: '10px',
                                            top: '50%',
                                            transform: 'translateY(-50%)',
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '4px',
                                            fontSize: '11px',
                                            color: '#10b981',
                                            fontWeight: '600'
                                        }}>
                                            ‚úì Found
                                        </div>
                                    )}
                                </div>
                                
                                {/* Search Results Dropdown */}
                                {showBillingPlateSearch && billingPlateSearchResults.length > 0 && (
                                    <div style={{
                                        position: 'absolute',
                                        top: '100%',
                                        left: 0,
                                        right: 0,
                                        background: theme.bg,
                                        border: `1px solid ${theme.border}`,
                                        boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
                                        zIndex: 100,
                                        maxHeight: '200px',
                                        overflowY: 'auto',
                                        marginTop: '4px'
                                    }}>
                                        <div style={{ padding: '8px 12px', background: theme.bgSecondary, borderBottom: `1px solid ${theme.border}`, fontSize: '11px', color: theme.textSecondary, fontWeight: '600' }}>
                                            üìã EXISTING RECORDS ({billingPlateSearchResults.length})
                                        </div>
                                        {billingPlateSearchResults.map(record => (
                                            <div
                                                key={record.id}
                                                onClick={() => selectIntakeRecordForBilling(record)}
                                                style={{
                                                    padding: '10px 12px',
                                                    cursor: 'pointer',
                                                    borderBottom: `1px solid ${theme.border}`,
                                                    display: 'flex',
                                                    justifyContent: 'space-between',
                                                    alignItems: 'center',
                                                    background: theme.bg,
                                                    transition: 'background 0.15s'
                                                }}
                                                onMouseOver={e => e.currentTarget.style.background = theme.bgSecondary}
                                                onMouseOut={e => e.currentTarget.style.background = theme.bg}
                                            >
                                                <div>
                                                    <div style={{ fontWeight: '700', color: theme.text, letterSpacing: '0.5px' }}>
                                                        {record.category === 'carpet' ? 'üßπ' : 'üöó'} {record.plateNumber}
                                                    </div>
                                                    <div style={{ fontSize: '11px', color: theme.textSecondary }}>
                                                        {record.itemType || record.vehicleType || 'Unknown'} ‚Ä¢ {record.customerName || 'No name'} {record.customerPhone ? `‚Ä¢ ${record.customerPhone}` : ''}
                                                    </div>
                                                </div>
                                                <div style={{ textAlign: 'right' }}>
                                                    <div style={{ fontSize: '12px', fontWeight: '600', color: record.visitNumber >= 1 ? '#10b981' : '#3b82f6' }}>
                                                        Visit #{record.visitNumber || 1}
                                                    </div>
                                                    <div style={{ fontSize: '10px', color: theme.textSecondary }}>
                                                        {record.service?.name || record.lastService || '-'}
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                                
                                {/* Selected Record Info Card */}
                                {selectedIntakeRecord && (
                                    <div style={{
                                        marginTop: '10px',
                                        padding: '12px',
                                        background: isDark ? '#10b98115' : '#f0fdf4',
                                        border: `1px solid ${isDark ? '#10b98140' : '#bbf7d0'}`
                                    }}>
                                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' }}>
                                            <span style={{ fontSize: '12px', fontWeight: '700', color: '#10b981' }}>
                                                {selectedIntakeRecord.category === 'carpet' ? 'üßπ CARPET' : 'üöó VEHICLE'} FOUND
                                            </span>
                                            <button 
                                                onClick={clearSelectedIntakeRecord}
                                                style={{ background: 'none', border: 'none', cursor: 'pointer', color: theme.textSecondary, fontSize: '11px', padding: '4px 8px' }}
                                            >
                                                ‚úï Clear
                                            </button>
                                        </div>
                                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '6px', fontSize: '12px', color: theme.text }}>
                                            <div><span style={{ color: theme.textSecondary }}>Type:</span> <strong>{selectedIntakeRecord.itemType || selectedIntakeRecord.vehicleType || '-'}</strong></div>
                                            <div><span style={{ color: theme.textSecondary }}>Visits:</span> <strong>{selectedIntakeRecord.visitNumber || 1}</strong></div>
                                            <div><span style={{ color: theme.textSecondary }}>Customer:</span> <strong>{selectedIntakeRecord.customerName || '-'}</strong></div>
                                            <div><span style={{ color: theme.textSecondary }}>Phone:</span> <strong>{selectedIntakeRecord.customerPhone || '-'}</strong></div>
                                        </div>
                                    </div>
                                )}
                                
                                {/* Existing Pending Invoice Alert */}
                                {existingPendingInvoice && (
                                    <div style={{
                                        marginTop: '10px',
                                        padding: '14px',
                                        background: isDark ? '#f59e0b15' : '#fef3c7',
                                        border: `2px solid ${isDark ? '#f59e0b60' : '#fcd34d'}`,
                                        borderLeft: '4px solid #f59e0b'
                                    }}>
                                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '10px' }}>
                                            <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                                <span style={{ fontSize: '20px' }}>‚ö†Ô∏è</span>
                                                <span style={{ fontSize: '13px', fontWeight: '700', color: '#d97706' }}>PENDING INVOICE FOUND</span>
                                            </div>
                                            <span style={{ 
                                                fontSize: '18px', 
                                                fontWeight: '800', 
                                                color: '#f59e0b',
                                                background: isDark ? '#f59e0b25' : '#fef9c3',
                                                padding: '4px 12px'
                                            }}>
                                                {formatCurrency(existingPendingInvoice.totalAmount)}
                                            </span>
                                        </div>
                                        
                                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px', fontSize: '12px', color: theme.text, marginBottom: '12px' }}>
                                            <div><span style={{ color: theme.textSecondary }}>Invoice:</span> <strong style={{ color: '#d97706' }}>{existingPendingInvoice.invoiceNumber || existingPendingInvoice.id?.slice(0,8).toUpperCase()}</strong></div>
                                            <div><span style={{ color: theme.textSecondary }}>Date:</span> <strong>{existingPendingInvoice.createdAt?.split('T')[0] || '-'}</strong></div>
                                            <div><span style={{ color: theme.textSecondary }}>Customer:</span> <strong>{existingPendingInvoice.customerName || 'Walk-in'}</strong></div>
                                            <div><span style={{ color: theme.textSecondary }}>Source:</span> <strong>{existingPendingInvoice.source?.toUpperCase() || 'WASH'}</strong></div>
                                        </div>
                                        
                                        {existingPendingInvoice.services && existingPendingInvoice.services.length > 0 && (
                                            <div style={{ fontSize: '11px', color: theme.textSecondary, marginBottom: '12px', padding: '8px', background: isDark ? '#00000020' : '#ffffff80' }}>
                                                <strong>Services:</strong> {existingPendingInvoice.services.map(s => s.name || s).join(', ')}
                                            </div>
                                        )}
                                        
                                        {/* Option to apply payment to existing */}
                                        <div style={{ 
                                            display: 'flex', 
                                            gap: '8px',
                                            padding: '10px',
                                            background: isDark ? '#00000020' : '#ffffff80',
                                            borderTop: `1px dashed ${theme.border}`
                                        }}>
                                            <button
                                                type="button"
                                                onClick={() => setApplyToExisting(true)}
                                                style={{
                                                    flex: 1,
                                                    padding: '10px',
                                                    border: `2px solid ${applyToExisting ? '#10b981' : theme.border}`,
                                                    background: applyToExisting ? '#10b981' : theme.bg,
                                                    color: applyToExisting ? 'white' : theme.text,
                                                    fontSize: '11px',
                                                    fontWeight: '700',
                                                    cursor: 'pointer',
                                                    borderRadius: '0',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    justifyContent: 'center',
                                                    gap: '6px'
                                                }}
                                            >
                                                <span>‚úì</span> CLEAR THIS INVOICE
                                            </button>
                                            <button
                                                type="button"
                                                onClick={() => setApplyToExisting(false)}
                                                style={{
                                                    flex: 1,
                                                    padding: '10px',
                                                    border: `2px solid ${!applyToExisting ? '#3b82f6' : theme.border}`,
                                                    background: !applyToExisting ? '#3b82f6' : theme.bg,
                                                    color: !applyToExisting ? 'white' : theme.text,
                                                    fontSize: '11px',
                                                    fontWeight: '700',
                                                    cursor: 'pointer',
                                                    borderRadius: '0',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    justifyContent: 'center',
                                                    gap: '6px'
                                                }}
                                            >
                                                <span>+</span> CREATE NEW
                                            </button>
                                        </div>
                                        
                                        {applyToExisting && (
                                            <div style={{ 
                                                marginTop: '8px', 
                                                padding: '8px 10px', 
                                                background: '#10b98120', 
                                                color: '#10b981', 
                                                fontSize: '11px', 
                                                fontWeight: '600',
                                                display: 'flex',
                                                alignItems: 'center',
                                                gap: '6px'
                                            }}>
                                                <span>üí°</span> Payment will be applied to existing invoice #{existingPendingInvoice.invoiceNumber || existingPendingInvoice.id?.slice(0,8).toUpperCase()}
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                            <input type="text" value={manualBillingData.customerName} onChange={(e) => handleManualBillingChange('customerName', e.target.value)} placeholder="Customer Name" style={inputStyle} />
                            <input type="tel" value={manualBillingData.customerPhone} onChange={(e) => handleManualBillingChange('customerPhone', e.target.value)} placeholder="Phone" style={inputStyle} />
                        </div>

                        {/* Source Selection & Services - Only show when NOT applying to existing invoice */}
                        {!(existingPendingInvoice && applyToExisting) && (
                        <>
                        {/* Source Selection - Garage or Wash */}
                        <div style={{ marginBottom: '16px' }}>
                            <div style={{ fontSize: '11px', color: theme.textSecondary, marginBottom: '8px', textTransform: 'uppercase', letterSpacing: '0.5px', fontWeight: '600' }}>Service Type</div>
                            <div style={{ display: 'flex', gap: '0' }}>
                                <button
                                    type="button"
                                    onClick={() => { handleManualBillingChange('source', 'wash'); handleManualBillingChange('selectedServices', []); }}
                                    style={{
                                        flex: 1,
                                        padding: '14px',
                                        border: `2px solid ${manualBillingData.source === 'wash' ? '#3b82f6' : theme.border}`,
                                        background: manualBillingData.source === 'wash' ? '#3b82f6' : theme.bg,
                                        color: manualBillingData.source === 'wash' ? 'white' : theme.text,
                                        fontWeight: '700',
                                        fontSize: '13px',
                                        cursor: 'pointer',
                                        borderRadius: '0',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        gap: '8px'
                                    }}
                                >
                                    <span style={{ fontSize: '18px' }}>üöø</span> CAR WASH
                                </button>
                                <button
                                    type="button"
                                    onClick={() => { handleManualBillingChange('source', 'garage'); handleManualBillingChange('selectedServices', []); }}
                                    style={{
                                        flex: 1,
                                        padding: '14px',
                                        border: `2px solid ${manualBillingData.source === 'garage' ? '#f59e0b' : theme.border}`,
                                        borderLeft: 'none',
                                        background: manualBillingData.source === 'garage' ? '#f59e0b' : theme.bg,
                                        color: manualBillingData.source === 'garage' ? 'white' : theme.text,
                                        fontWeight: '700',
                                        fontSize: '13px',
                                        cursor: 'pointer',
                                        borderRadius: '0',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        gap: '8px'
                                    }}
                                >
                                    <span style={{ fontSize: '18px' }}>üîß</span> GARAGE
                                </button>
                            </div>
                        </div>

                        {/* Services Selection */}
                        <div style={{ marginBottom: '16px' }}>
                            <div style={{ fontSize: '11px', color: theme.textSecondary, marginBottom: '8px', textTransform: 'uppercase', letterSpacing: '0.5px', fontWeight: '600' }}>
                                {manualBillingData.source === 'garage' ? 'üîß Garage Services' : 'üöø Car Wash Services'}
                            </div>
                            {(() => {
                                const displayServices = manualBillingData.source === 'garage' ? garageServices : servicePackages;
                                const emptyMessage = manualBillingData.source === 'garage' 
                                    ? 'No garage services available. Add services in Garage ‚Üí Manage Services.'
                                    : 'No car wash services available. Add services in Service Packages.';
                                
                                if (displayServices.length === 0) {
                                    return (
                                        <div style={{ padding: '20px', background: theme.bgSecondary, textAlign: 'center', color: theme.textSecondary, fontSize: '13px' }}>
                                            {emptyMessage}
                                        </div>
                                    );
                                }
                                
                                return (
                                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '8px', maxHeight: '200px', overflowY: 'auto', padding: '4px' }}>
                                        {displayServices.map(service => {
                                            const isSelected = manualBillingData.selectedServices.includes(service.id);
                                            return (
                                                <button
                                                    key={service.id}
                                                    type="button"
                                                    onClick={() => toggleServiceSelection(service.id)}
                                                    style={{
                                                        padding: '12px',
                                                        border: `2px solid ${isSelected ? '#10b981' : theme.border}`,
                                                        background: isSelected ? (isDark ? '#10b98120' : '#d1fae5') : theme.bg,
                                                        cursor: 'pointer',
                                                        textAlign: 'left',
                                                        borderRadius: '0',
                                                        transition: 'all 0.15s'
                                                    }}
                                                >
                                                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                                                        <div style={{ flex: 1 }}>
                                                            <div style={{ fontWeight: '600', color: theme.text, fontSize: '13px', marginBottom: '2px' }}>
                                                                {isSelected && <span style={{ color: '#10b981', marginRight: '4px' }}>‚úì</span>}
                                                                {service.name}
                                                            </div>
                                                            {service.description && (
                                                                <div style={{ fontSize: '10px', color: theme.textSecondary }}>{service.description}</div>
                                                            )}
                                                        </div>
                                                        <div style={{ fontWeight: '800', color: isSelected ? '#10b981' : (manualBillingData.source === 'garage' ? '#f59e0b' : '#3b82f6'), fontSize: '14px', whiteSpace: 'nowrap' }}>
                                                            {formatCurrency(service.price)}
                                                        </div>
                                                    </div>
                                                </button>
                                            );
                                        })}
                                    </div>
                                );
                            })()}
                            {/* Selected services summary */}
                            {manualBillingData.selectedServices.length > 0 && (
                                <div style={{ marginTop: '8px', padding: '8px 12px', background: isDark ? '#10b98115' : '#ecfdf5', borderLeft: '3px solid #10b981' }}>
                                    <div style={{ fontSize: '11px', color: theme.textSecondary }}>
                                        {manualBillingData.selectedServices.length} service(s): {getSelectedServicesDetails().map(s => s.name).join(', ')}
                                    </div>
                                </div>
                            )}
                        </div>
                        </>
                        )}

                        {/* Payment Method */}
                        <div style={{ marginBottom: '16px' }}>
                            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '8px' }}>
                                <div style={{ fontSize: '11px', color: theme.textSecondary, textTransform: 'uppercase', letterSpacing: '0.5px' }}>Payment {existingPendingInvoice && applyToExisting ? '(Apply to Existing Invoice)' : ''}</div>
                                {/* Cash visibility toggle */}
                                <button
                                    type="button"
                                    onClick={toggleCashVisibility}
                                    title={hideCashPayment ? 'Show Cash option' : 'Hide Cash option'}
                                    style={{
                                        background: 'transparent',
                                        border: 'none',
                                        cursor: 'pointer',
                                        fontSize: '14px',
                                        padding: '2px 6px',
                                        borderRadius: '4px',
                                        color: theme.textSecondary,
                                        opacity: 0.6,
                                        transition: 'all 0.2s'
                                    }}
                                >
                                    {hideCashPayment ? 'üëÅÔ∏è‚Äçüó®Ô∏è' : 'üëÅÔ∏è'}
                                </button>
                            </div>
                            <div style={{ display: 'flex', gap: '8px' }}>
                                {[
                                    // Only show "Unpaid" option when NOT applying to existing invoice
                                    ...(!(existingPendingInvoice && applyToExisting) ? [{ id: 'unpaid', label: '‚è≥ Unpaid', color: '#ef4444' }] : []),
                                    { id: 'cash', label: 'üíµ Cash', color: '#10b981', hideable: true },
                                    { id: 'card', label: 'üí≥ Card', color: '#3b82f6' },
                                    { id: 'mpesa', label: 'üì± M-Pesa', color: '#00a651' }
                                ].filter(opt => !opt.hideable || !hideCashPayment).map(opt => {
                                    const isSelected = opt.id === 'unpaid' 
                                        ? manualBillingData.paymentStatus === 'unpaid' 
                                        : manualBillingData.paymentStatus === 'paid' && manualBillingData.paymentMethod === opt.id;
                                    return (
                                        <button
                                            key={opt.id}
                                            type="button"
                                            onClick={() => {
                                                if (opt.id === 'unpaid') {
                                                    handleManualBillingChange('paymentStatus', 'unpaid');
                                                } else {
                                                    handleManualBillingChange('paymentStatus', 'paid');
                                                    handleManualBillingChange('paymentMethod', opt.id);
                                                }
                                            }}
                                            style={{
                                                flex: 1,
                                                padding: '10px 8px',
                                                border: `2px solid ${isSelected ? opt.color : theme.border}`,
                                                background: isSelected ? opt.color : theme.bg,
                                                color: isSelected ? 'white' : theme.text,
                                                fontSize: '11px',
                                                fontWeight: '700',
                                                cursor: 'pointer',
                                                borderRadius: '0'
                                            }}
                                        >
                                            {opt.label}
                                        </button>
                                    );
                                })}
                            </div>
                        </div>

                        {/* Card Reference */}
                        {manualBillingData.paymentStatus === 'paid' && manualBillingData.paymentMethod === 'card' && (
                            <div style={{ marginBottom: '16px', padding: '12px', background: isDark ? '#3b82f615' : '#eff6ff', border: `1px solid ${isDark ? '#3b82f640' : '#bfdbfe'}` }}>
                                <div style={{ fontSize: '11px', color: '#3b82f6', fontWeight: '600', marginBottom: '8px', textTransform: 'uppercase' }}>üí≥ Card Payment Details</div>
                                <input 
                                    type="text" 
                                    value={manualBillingData.cardReference} 
                                    onChange={(e) => handleManualBillingChange('cardReference', e.target.value.toUpperCase())} 
                                    placeholder="Card Reference / Transaction ID" 
                                    style={{ ...inputStyle, textTransform: 'uppercase', fontWeight: '600' }} 
                                />
                            </div>
                        )}

                        {/* M-Pesa Payment Options */}
                        {manualBillingData.paymentStatus === 'paid' && manualBillingData.paymentMethod === 'mpesa' && (
                            <div style={{ marginBottom: '16px', padding: '12px', background: isDark ? '#00a65115' : '#f0fdf4', border: `1px solid ${isDark ? '#00a65140' : '#bbf7d0'}` }}>
                                <div style={{ fontSize: '11px', color: '#00a651', fontWeight: '600', marginBottom: '10px', textTransform: 'uppercase' }}>üì± M-Pesa Payment</div>
                                
                                {/* Mode Selection */}
                                <div style={{ display: 'flex', gap: '8px', marginBottom: '12px' }}>
                                    <button
                                        type="button"
                                        onClick={() => { handleManualBillingChange('mpesaMode', 'stk'); setManualMpesaStkStatus(null); }}
                                        style={{
                                            flex: 1,
                                            padding: '10px',
                                            border: `2px solid ${manualBillingData.mpesaMode === 'stk' ? '#00a651' : theme.border}`,
                                            background: manualBillingData.mpesaMode === 'stk' ? '#00a651' : theme.bg,
                                            color: manualBillingData.mpesaMode === 'stk' ? 'white' : theme.text,
                                            fontSize: '11px',
                                            fontWeight: '700',
                                            cursor: 'pointer',
                                            borderRadius: '0'
                                        }}
                                    >
                                        üì≤ STK Push
                                    </button>
                                    <button
                                        type="button"
                                        onClick={() => { handleManualBillingChange('mpesaMode', 'manual'); setManualMpesaStkStatus(null); }}
                                        style={{
                                            flex: 1,
                                            padding: '10px',
                                            border: `2px solid ${manualBillingData.mpesaMode === 'manual' ? '#00a651' : theme.border}`,
                                            background: manualBillingData.mpesaMode === 'manual' ? '#00a651' : theme.bg,
                                            color: manualBillingData.mpesaMode === 'manual' ? 'white' : theme.text,
                                            fontSize: '11px',
                                            fontWeight: '700',
                                            cursor: 'pointer',
                                            borderRadius: '0'
                                        }}
                                    >
                                        ‚úèÔ∏è Manual Code
                                    </button>
                                </div>

                                {/* STK Push Option */}
                                {manualBillingData.mpesaMode === 'stk' && (
                                    <div>
                                        <div style={{ display: 'flex', gap: '8px', marginBottom: '8px' }}>
                                            <input 
                                                type="tel" 
                                                value={manualBillingData.customerPhone} 
                                                onChange={(e) => handleManualBillingChange('customerPhone', e.target.value)} 
                                                placeholder="Phone Number (07XX...)" 
                                                style={{ ...inputStyle, flex: 1 }} 
                                            />
                                            <button
                                                type="button"
                                                onClick={async () => {
                                                    if (!manualBillingData.customerPhone) {
                                                        showAlert('Error', 'Please enter a phone number', 'error');
                                                        return;
                                                    }
                                                    const total = getManualBillingTotal();
                                                    if (total <= 0) {
                                                        showAlert('Error', 'Please select services first', 'error');
                                                        return;
                                                    }
                                                    setManualMpesaStkLoading(true);
                                                    setManualMpesaStkStatus('sending');
                                                    try {
                                                        const services = window.FirebaseServices;
                                                        if (services?.mpesaService?.initiateSTKPush) {
                                                            const result = await services.mpesaService.initiateSTKPush(manualBillingData.customerPhone, total, `INV-${Date.now()}`);
                                                            if (result.success) {
                                                                setManualMpesaStkStatus('sent');
                                                                showAlert('STK Push Sent', 'Please check the phone for M-Pesa prompt and enter PIN', 'success');
                                                            } else {
                                                                setManualMpesaStkStatus('failed');
                                                                showAlert('Error', result.error || 'Failed to send STK push', 'error');
                                                            }
                                                        } else {
                                                            setManualMpesaStkStatus('failed');
                                                            showAlert('Error', 'M-Pesa service not available', 'error');
                                                        }
                                                    } catch (err) {
                                                        setManualMpesaStkStatus('failed');
                                                        showAlert('Error', err.message || 'Failed to send STK push', 'error');
                                                    } finally {
                                                        setManualMpesaStkLoading(false);
                                                    }
                                                }}
                                                disabled={manualMpesaStkLoading}
                                                style={{
                                                    padding: '10px 16px',
                                                    background: manualMpesaStkLoading ? '#6b7280' : '#00a651',
                                                    color: 'white',
                                                    border: 'none',
                                                    fontWeight: '700',
                                                    fontSize: '11px',
                                                    cursor: manualMpesaStkLoading ? 'wait' : 'pointer',
                                                    whiteSpace: 'nowrap'
                                                }}
                                            >
                                                {manualMpesaStkLoading ? '‚è≥ SENDING...' : 'üì≤ SEND PROMPT'}
                                            </button>
                                        </div>
                                        {manualMpesaStkStatus === 'sent' && (
                                            <div style={{ padding: '8px', background: '#10b98120', color: '#10b981', fontSize: '11px', fontWeight: '600', textAlign: 'center' }}>
                                                ‚úì STK Push sent! Enter the M-Pesa code after payment completes
                                            </div>
                                        )}
                                        {manualMpesaStkStatus === 'sent' && (
                                            <input 
                                                type="text" 
                                                value={manualBillingData.mpesaCode} 
                                                onChange={(e) => handleManualBillingChange('mpesaCode', e.target.value.toUpperCase())} 
                                                placeholder="M-Pesa Code (e.g., SBK7XXX)" 
                                                style={{ ...inputStyle, marginTop: '8px', textTransform: 'uppercase', fontWeight: '700' }} 
                                            />
                                        )}
                                    </div>
                                )}

                                {/* Manual Code Entry */}
                                {manualBillingData.mpesaMode === 'manual' && (
                                    <input 
                                        type="text" 
                                        value={manualBillingData.mpesaCode} 
                                        onChange={(e) => handleManualBillingChange('mpesaCode', e.target.value.toUpperCase())} 
                                        placeholder="M-Pesa Transaction Code (e.g., SBK7XXX)" 
                                        style={{ ...inputStyle, textTransform: 'uppercase', fontWeight: '700' }} 
                                    />
                                )}
                            </div>
                        )}

                        {/* Total & Submit */}
                        <div style={{ display: 'flex', alignItems: 'center', gap: '16px', padding: '16px', background: existingPendingInvoice && applyToExisting ? (isDark ? '#f59e0b15' : '#fef3c7') : theme.bgSecondary, marginBottom: '16px', borderLeft: existingPendingInvoice && applyToExisting ? '4px solid #f59e0b' : 'none' }}>
                            <div style={{ flex: 1 }}>
                                <div style={{ fontSize: '11px', color: existingPendingInvoice && applyToExisting ? '#d97706' : theme.textSecondary, textTransform: 'uppercase' }}>
                                    {existingPendingInvoice && applyToExisting ? 'Amount to Clear' : 'Total'}
                                </div>
                                <div style={{ fontSize: '24px', fontWeight: '800', color: existingPendingInvoice && applyToExisting ? '#f59e0b' : '#10b981' }}>
                                    {formatCurrency(existingPendingInvoice && applyToExisting ? existingPendingInvoice.totalAmount : getManualBillingTotal())}
                                </div>
                                {existingPendingInvoice && applyToExisting && (
                                    <div style={{ fontSize: '10px', color: theme.textSecondary, marginTop: '2px' }}>
                                        Invoice #{existingPendingInvoice.invoiceNumber || existingPendingInvoice.id?.slice(0,8).toUpperCase()}
                                    </div>
                                )}
                            </div>
                            <button
                                onClick={handleSubmitManualBilling}
                                disabled={actionLoading || (existingPendingInvoice && applyToExisting && manualBillingData.paymentStatus !== 'paid')}
                                style={{ 
                                    padding: '14px 28px', 
                                    background: existingPendingInvoice && applyToExisting ? '#f59e0b' : '#10b981', 
                                    color: 'white', 
                                    border: 'none', 
                                    fontWeight: '700', 
                                    fontSize: '13px', 
                                    cursor: actionLoading ? 'wait' : 'pointer', 
                                    opacity: actionLoading || (existingPendingInvoice && applyToExisting && manualBillingData.paymentStatus !== 'paid') ? 0.7 : 1 
                                }}
                            >
                                {actionLoading ? 'PROCESSING...' : (existingPendingInvoice && applyToExisting ? '‚úì CLEAR PAYMENT' : 'CREATE')}
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* Alert Modal */}
            <AlertModal
                isOpen={alertModal.isOpen}
                onClose={closeAlert}
                title={alertModal.title}
                message={alertModal.message}
                type={alertModal.type}
                onConfirm={alertModal.onConfirm}
                showCancel={alertModal.showCancel}
            />
        </div>
    );
}

// ==================== FACTORY RESET TAB COMPONENT ====================
function FactoryResetTab({ theme }) {
    const [showConfirmModal, setShowConfirmModal] = useState(false);
    const [confirmText, setConfirmText] = useState('');
    const [resetting, setResetting] = useState(false);
    const [progress, setProgress] = useState(null);
    const [results, setResults] = useState(null);
    const [error, setError] = useState(null);
    
    // Backup states
    const [backupTab, setBackupTab] = useState('backup'); // 'backup', 'restore', 'reset'
    const [creatingBackup, setCreatingBackup] = useState(false);
    const [backupProgress, setBackupProgress] = useState(null);
    const [backupSuccess, setBackupSuccess] = useState(null);
    const [restoring, setRestoring] = useState(false);
    const [restoreProgress, setRestoreProgress] = useState(null);
    const [restoreSuccess, setRestoreSuccess] = useState(null);
    const [selectedFile, setSelectedFile] = useState(null);
    const [backupPreview, setBackupPreview] = useState(null);
    const [showRestoreConfirm, setShowRestoreConfirm] = useState(false);
    const [preResetBackupDone, setPreResetBackupDone] = useState(false);
    const [backupHistory, setBackupHistory] = useState([]);
    
    const fileInputRef = React.useRef(null);

    const CONFIRM_PHRASE = 'DELETE ALL DATA';

    // Firestore collections to backup/delete
    const FIRESTORE_COLLECTIONS = ['vehicles', 'customers', 'settings', 'invoices', 'vehicleIntake', 'vehicleProfiles', 'mpesa_payments', 'activities', 'servicePackages', 'equipment', 'garageJobs', 'garageServices', 'inventory', 'fleetAccounts', 'expenses', 'users', 'complaints', 'branding', 'notifications'];
    
    // Realtime Database paths to backup/delete
    const REALTIME_PATHS = ['stats', 'washBays', 'washHistory', 'staff', 'vehicleIntake', 'garage', 'audit_logs'];
    
    // Storage folders to delete (can't backup files easily without Blaze)
    const STORAGE_FOLDERS = ['uploads', 'images', 'documents', 'receipts', 'vehicle-images'];
    
    // Load backup history from localStorage on mount
    useEffect(() => {
        try {
            const history = localStorage.getItem('ecospark_backup_history');
            if (history) {
                setBackupHistory(JSON.parse(history));
            }
        } catch (e) {
            console.error('Failed to load backup history:', e);
        }
    }, []);
    
    // Save backup record to history
    const saveBackupToHistory = (backupInfo) => {
        const newHistory = [backupInfo, ...backupHistory].slice(0, 20); // Keep last 20 records
        setBackupHistory(newHistory);
        localStorage.setItem('ecospark_backup_history', JSON.stringify(newHistory));
    };
    
    // Create backup - fetches all data and downloads as JSON
    const handleCreateBackup = async (isPreReset = false) => {
        setCreatingBackup(true);
        setBackupProgress({ phase: 'Starting...', current: 0, total: FIRESTORE_COLLECTIONS.length + REALTIME_PATHS.length });
        setError(null);
        setBackupSuccess(null);
        
        const backupData = {
            metadata: {
                version: '1.0',
                createdAt: new Date().toISOString(),
                type: isPreReset ? 'pre-reset' : 'manual',
                appName: 'EcoSpark Car Wash Management',
                collections: FIRESTORE_COLLECTIONS,
                realtimePaths: REALTIME_PATHS
            },
            firestore: {},
            realtime: {}
        };
        
        try {
            const services = window.FirebaseServices;
            let currentStep = 0;
            
            // Backup Firestore collections
            for (const collName of FIRESTORE_COLLECTIONS) {
                currentStep++;
                setBackupProgress({ phase: `Backing up ${collName}...`, current: currentStep, total: FIRESTORE_COLLECTIONS.length + REALTIME_PATHS.length });
                
                try {
                    const snapshot = await services.db.collection(collName).get();
                    backupData.firestore[collName] = [];
                    snapshot.forEach(doc => {
                        backupData.firestore[collName].push({
                            id: doc.id,
                            data: doc.data()
                        });
                    });
                } catch (e) {
                    console.warn(`Could not backup ${collName}:`, e.message);
                    backupData.firestore[collName] = { error: e.message };
                }
            }
            
            // Backup Realtime Database paths
            for (const path of REALTIME_PATHS) {
                currentStep++;
                setBackupProgress({ phase: `Backing up ${path}...`, current: currentStep, total: FIRESTORE_COLLECTIONS.length + REALTIME_PATHS.length });
                
                try {
                    const snapshot = await services.rtdb.ref(path).once('value');
                    backupData.realtime[path] = snapshot.val();
                } catch (e) {
                    console.warn(`Could not backup ${path}:`, e.message);
                    backupData.realtime[path] = { error: e.message };
                }
            }
            
            // Also backup localStorage branding
            try {
                const branding = localStorage.getItem('ecospark_branding');
                if (branding) {
                    backupData.localStorage = { branding: JSON.parse(branding) };
                }
            } catch (e) {
                console.warn('Could not backup localStorage:', e);
            }
            
            // Calculate stats
            const stats = {
                firestoreDocs: Object.values(backupData.firestore).reduce((sum, arr) => sum + (Array.isArray(arr) ? arr.length : 0), 0),
                realtimePaths: Object.keys(backupData.realtime).filter(k => backupData.realtime[k] !== null).length,
                totalSize: new Blob([JSON.stringify(backupData)]).size
            };
            backupData.metadata.stats = stats;
            
            // Generate filename
            const now = new Date();
            const dateStr = now.toISOString().slice(0, 10).replace(/-/g, '');
            const timeStr = now.toTimeString().slice(0, 5).replace(':', '');
            const filename = `ecospark_backup_${isPreReset ? 'prereset_' : ''}${dateStr}_${timeStr}.json`;
            
            // Download the file
            const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // Save to history
            saveBackupToHistory({
                filename,
                createdAt: now.toISOString(),
                type: isPreReset ? 'pre-reset' : 'manual',
                stats
            });
            
            setBackupSuccess({
                filename,
                stats,
                isPreReset
            });
            
            if (isPreReset) {
                setPreResetBackupDone(true);
            }
            
        } catch (err) {
            console.error('Backup error:', err);
            setError('Backup failed: ' + err.message);
        } finally {
            setCreatingBackup(false);
            setBackupProgress(null);
        }
    };
    
    // Handle file selection for restore
    const handleFileSelect = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        setSelectedFile(file);
        setBackupPreview(null);
        setError(null);
        
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const data = JSON.parse(event.target.result);
                
                // Validate backup structure
                if (!data.metadata || !data.firestore) {
                    setError('Invalid backup file: Missing required structure');
                    setSelectedFile(null);
                    return;
                }
                
                // Create preview
                setBackupPreview({
                    metadata: data.metadata,
                    collections: Object.keys(data.firestore || {}),
                    realtimePaths: Object.keys(data.realtime || {}),
                    firestoreDocs: Object.values(data.firestore || {}).reduce((sum, arr) => sum + (Array.isArray(arr) ? arr.length : 0), 0),
                    hasLocalStorage: !!data.localStorage,
                    rawData: data
                });
            } catch (err) {
                setError('Failed to parse backup file: ' + err.message);
                setSelectedFile(null);
            }
        };
        reader.readAsText(file);
    };
    
    // Restore from backup
    const handleRestore = async () => {
        if (!backupPreview || !backupPreview.rawData) {
            setError('No valid backup file selected');
            return;
        }
        
        setRestoring(true);
        setRestoreProgress({ phase: 'Starting restore...', current: 0, total: 100 });
        setError(null);
        setRestoreSuccess(null);
        
        const data = backupPreview.rawData;
        const results = { firestore: { restored: 0, errors: [] }, realtime: { restored: 0, errors: [] } };
        
        try {
            const services = window.FirebaseServices;
            const collections = Object.keys(data.firestore || {});
            const paths = Object.keys(data.realtime || {});
            const totalSteps = collections.length + paths.length;
            let currentStep = 0;
            
            // Restore Firestore collections
            for (const collName of collections) {
                currentStep++;
                setRestoreProgress({ phase: `Restoring ${collName}...`, current: Math.round((currentStep / totalSteps) * 100), total: 100 });
                
                const docs = data.firestore[collName];
                if (!Array.isArray(docs)) continue;
                
                for (const doc of docs) {
                    try {
                        // Convert timestamps back if needed
                        const docData = convertTimestamps(doc.data);
                        await services.db.collection(collName).doc(doc.id).set(docData, { merge: true });
                        results.firestore.restored++;
                    } catch (e) {
                        results.firestore.errors.push({ collection: collName, doc: doc.id, error: e.message });
                    }
                }
            }
            
            // Restore Realtime Database paths
            for (const path of paths) {
                currentStep++;
                setRestoreProgress({ phase: `Restoring ${path}...`, current: Math.round((currentStep / totalSteps) * 100), total: 100 });
                
                const pathData = data.realtime[path];
                if (pathData === null || pathData?.error) continue;
                
                try {
                    await services.rtdb.ref(path).set(pathData);
                    results.realtime.restored++;
                } catch (e) {
                    results.realtime.errors.push({ path, error: e.message });
                }
            }
            
            // Restore localStorage if present
            if (data.localStorage?.branding) {
                try {
                    localStorage.setItem('ecospark_branding', JSON.stringify(data.localStorage.branding));
                } catch (e) {
                    console.warn('Could not restore localStorage branding:', e);
                }
            }
            
            setRestoreSuccess(results);
            setShowRestoreConfirm(false);
            setSelectedFile(null);
            setBackupPreview(null);
            
        } catch (err) {
            console.error('Restore error:', err);
            setError('Restore failed: ' + err.message);
        } finally {
            setRestoring(false);
            setRestoreProgress(null);
        }
    };
    
    // Helper to convert date strings back to Firestore timestamps
    const convertTimestamps = (obj) => {
        if (!obj || typeof obj !== 'object') return obj;
        
        const result = Array.isArray(obj) ? [] : {};
        
        for (const key in obj) {
            const value = obj[key];
            
            if (value && typeof value === 'object') {
                // Check if it's a Firestore timestamp object
                if (value.seconds !== undefined && value.nanoseconds !== undefined) {
                    result[key] = new Date(value.seconds * 1000);
                } else if (value._seconds !== undefined && value._nanoseconds !== undefined) {
                    result[key] = new Date(value._seconds * 1000);
                } else {
                    result[key] = convertTimestamps(value);
                }
            } else if (typeof value === 'string' && /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/.test(value)) {
                // Check if it's an ISO date string
                const date = new Date(value);
                if (!isNaN(date.getTime())) {
                    result[key] = date;
                } else {
                    result[key] = value;
                }
            } else {
                result[key] = value;
            }
        }
        
        return result;
    };
    
    // Format file size
    const formatSize = (bytes) => {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
    };

    const handleFactoryReset = async () => {
        if (confirmText !== CONFIRM_PHRASE) {
            setError(`Please type "${CONFIRM_PHRASE}" to confirm`);
            return;
        }

        setResetting(true);
        setProgress({ phase: 'firestore', current: 0, total: FIRESTORE_COLLECTIONS.length, item: 'Starting...' });
        setError(null);

        const resetResults = { firestore: { deleted: 0, errors: [] }, realtime: { deleted: 0, errors: [] }, storage: { deleted: 0, errors: [] } };

        try {
            const services = window.FirebaseServices;
            
            // Delete Firestore collections
            for (let i = 0; i < FIRESTORE_COLLECTIONS.length; i++) {
                const collName = FIRESTORE_COLLECTIONS[i];
                setProgress({ phase: 'firestore', current: i + 1, total: FIRESTORE_COLLECTIONS.length, item: collName });
                try {
                    const result = await services.factoryResetService.deleteFirestoreCollection(collName);
                    if (result.success) resetResults.firestore.deleted += result.deleted || 0;
                    else resetResults.firestore.errors.push({ collection: collName, error: result.error });
                } catch (e) { resetResults.firestore.errors.push({ collection: collName, error: e.message }); }
            }

            // Delete Realtime Database paths
            for (let i = 0; i < REALTIME_PATHS.length; i++) {
                const path = REALTIME_PATHS[i];
                setProgress({ phase: 'realtime', current: i + 1, total: REALTIME_PATHS.length, item: path });
                try {
                    const result = await services.factoryResetService.deleteRealtimePath(path);
                    if (result.success) resetResults.realtime.deleted++;
                    else resetResults.realtime.errors.push({ path, error: result.error });
                } catch (e) { resetResults.realtime.errors.push({ path, error: e.message }); }
            }

            // Delete Storage folders
            for (let i = 0; i < STORAGE_FOLDERS.length; i++) {
                const folder = STORAGE_FOLDERS[i];
                setProgress({ phase: 'storage', current: i + 1, total: STORAGE_FOLDERS.length, item: folder });
                try {
                    const result = await services.factoryResetService.deleteStorageFolder(folder);
                    if (result.success) resetResults.storage.deleted += result.deleted || 0;
                    else resetResults.storage.errors.push({ folder, error: result.error });
                } catch (e) { resetResults.storage.errors.push({ folder, error: e.message }); }
            }

            setResults(resetResults);
            setShowConfirmModal(false);
            setConfirmText('');
        } catch (err) {
            console.error('Factory reset error:', err);
            setError('Factory reset failed: ' + err.message);
        }
        setResetting(false);
        setProgress(null);
    };

    return (
        <div>
            {/* Tab Navigation */}
            <div style={{ display: 'flex', gap: '0', marginBottom: '20px', borderBottom: `2px solid ${theme.border}` }}>
                <button 
                    onClick={() => setBackupTab('backup')} 
                    style={{ 
                        padding: '14px 24px', 
                        border: 'none', 
                        background: backupTab === 'backup' ? '#10b981' : 'transparent', 
                        color: backupTab === 'backup' ? 'white' : theme.textSecondary, 
                        fontWeight: '600', 
                        cursor: 'pointer',
                        fontSize: '14px',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '8px'
                    }}
                >
                    üíæ Create Backup
                </button>
                <button 
                    onClick={() => setBackupTab('restore')} 
                    style={{ 
                        padding: '14px 24px', 
                        border: 'none', 
                        background: backupTab === 'restore' ? '#3b82f6' : 'transparent', 
                        color: backupTab === 'restore' ? 'white' : theme.textSecondary, 
                        fontWeight: '600', 
                        cursor: 'pointer',
                        fontSize: '14px',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '8px'
                    }}
                >
                    üì• Restore Backup
                </button>
                <button 
                    onClick={() => setBackupTab('reset')} 
                    style={{ 
                        padding: '14px 24px', 
                        border: 'none', 
                        background: backupTab === 'reset' ? '#dc2626' : 'transparent', 
                        color: backupTab === 'reset' ? 'white' : theme.textSecondary, 
                        fontWeight: '600', 
                        cursor: 'pointer',
                        fontSize: '14px',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '8px'
                    }}
                >
                    üîÑ Factory Reset
                </button>
            </div>
            
            {/* Error Banner */}
            {error && (
                <div style={{ background: '#fef2f2', border: '1px solid #fecaca', color: '#dc2626', padding: '12px', marginBottom: '16px', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <span>‚ö†Ô∏è {error}</span>
                    <button onClick={() => setError(null)} style={{ background: 'none', border: 'none', cursor: 'pointer', fontSize: '18px', color: '#dc2626' }}>√ó</button>
                </div>
            )}

            {/* ==================== BACKUP TAB ==================== */}
            {backupTab === 'backup' && (
                <div>
                    {/* Backup Header */}
                    <div style={{ background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)', padding: '24px', marginBottom: '20px', color: 'white', borderRadius: '8px' }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
                            <div style={{ fontSize: '48px' }}>üíæ</div>
                            <div>
                                <h2 style={{ margin: '0 0 6px', fontSize: '22px', fontWeight: '700' }}>Data Backup</h2>
                                <p style={{ margin: 0, opacity: 0.9, fontSize: '14px' }}>
                                    Create a complete backup of all your data. Downloads as a JSON file to your device.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    {/* Backup Success */}
                    {backupSuccess && (
                        <div style={{ background: '#dcfce7', border: '1px solid #86efac', padding: '20px', marginBottom: '20px', borderRadius: '8px' }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '12px' }}>
                                <span style={{ fontSize: '28px' }}>‚úÖ</span>
                                <div>
                                    <strong style={{ color: '#166534', fontSize: '16px' }}>Backup Created Successfully!</strong>
                                    <p style={{ margin: '4px 0 0', color: '#166534', fontSize: '13px' }}>File: {backupSuccess.filename}</p>
                                </div>
                            </div>
                            <div style={{ display: 'flex', gap: '20px', flexWrap: 'wrap', fontSize: '14px', color: '#166534', background: '#bbf7d0', padding: '12px', borderRadius: '6px' }}>
                                <span>üìÑ {backupSuccess.stats?.firestoreDocs || 0} documents</span>
                                <span>‚ö° {backupSuccess.stats?.realtimePaths || 0} database paths</span>
                                <span>üì¶ {formatSize(backupSuccess.stats?.totalSize || 0)}</span>
                            </div>
                            <button onClick={() => setBackupSuccess(null)} style={{ marginTop: '12px', padding: '8px 16px', background: '#166534', border: 'none', color: 'white', cursor: 'pointer', fontSize: '13px', borderRadius: '4px' }}>Dismiss</button>
                        </div>
                    )}
                    
                    {/* Backup Progress */}
                    {creatingBackup && backupProgress && (
                        <div style={{ background: theme.bg, border: `1px solid ${theme.border}`, padding: '24px', marginBottom: '20px', borderRadius: '8px', textAlign: 'center' }}>
                            <div style={{ width: '60px', height: '60px', border: '4px solid #e5e7eb', borderTopColor: '#10b981', borderRadius: '50%', animation: 'spin 0.8s linear infinite', margin: '0 auto 16px' }}></div>
                            <h3 style={{ margin: '0 0 8px', color: theme.text, fontSize: '16px' }}>Creating Backup...</h3>
                            <p style={{ color: theme.textSecondary, fontSize: '14px', margin: '8px 0' }}>{backupProgress.phase}</p>
                            <div style={{ background: theme.border, height: '8px', borderRadius: '4px', overflow: 'hidden', marginTop: '12px' }}>
                                <div style={{ background: '#10b981', height: '100%', width: `${(backupProgress.current / backupProgress.total) * 100}%`, transition: 'width 0.3s' }}></div>
                            </div>
                            <p style={{ color: theme.textSecondary, fontSize: '12px', marginTop: '8px' }}>{backupProgress.current} / {backupProgress.total}</p>
                        </div>
                    )}
                    
                    {/* What's Included */}
                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))', gap: '16px', marginBottom: '24px' }}>
                        <div style={{ background: theme.bg, border: `1px solid ${theme.border}`, padding: '20px', borderRadius: '8px' }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '12px' }}>
                                <span style={{ fontSize: '24px' }}>üóÑÔ∏è</span>
                                <strong style={{ color: theme.text }}>Firestore Data</strong>
                            </div>
                            <p style={{ color: theme.textSecondary, fontSize: '13px', margin: '0 0 10px' }}>All business data including:</p>
                            <div style={{ display: 'flex', flexWrap: 'wrap', gap: '6px' }}>
                                {['customers', 'vehicles', 'invoices', 'inventory', 'complaints', 'staff'].map(item => (
                                    <span key={item} style={{ background: '#10b98115', color: '#10b981', padding: '4px 10px', fontSize: '11px', borderRadius: '12px' }}>{item}</span>
                                ))}
                                <span style={{ background: theme.bgSecondary, color: theme.textSecondary, padding: '4px 10px', fontSize: '11px', borderRadius: '12px' }}>+{FIRESTORE_COLLECTIONS.length - 6} more</span>
                            </div>
                        </div>
                        
                        <div style={{ background: theme.bg, border: `1px solid ${theme.border}`, padding: '20px', borderRadius: '8px' }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '12px' }}>
                                <span style={{ fontSize: '24px' }}>‚ö°</span>
                                <strong style={{ color: theme.text }}>Realtime Database</strong>
                            </div>
                            <p style={{ color: theme.textSecondary, fontSize: '13px', margin: '0 0 10px' }}>Live data including:</p>
                            <div style={{ display: 'flex', flexWrap: 'wrap', gap: '6px' }}>
                                {REALTIME_PATHS.map(item => (
                                    <span key={item} style={{ background: '#f59e0b15', color: '#f59e0b', padding: '4px 10px', fontSize: '11px', borderRadius: '12px' }}>{item}</span>
                                ))}
                            </div>
                        </div>
                        
                        <div style={{ background: theme.bg, border: `1px solid ${theme.border}`, padding: '20px', borderRadius: '8px' }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '12px' }}>
                                <span style={{ fontSize: '24px' }}>üé®</span>
                                <strong style={{ color: theme.text }}>Settings & Branding</strong>
                            </div>
                            <p style={{ color: theme.textSecondary, fontSize: '13px', margin: '0 0 10px' }}>Configurations including:</p>
                            <div style={{ display: 'flex', flexWrap: 'wrap', gap: '6px' }}>
                                {['branding', 'logo', 'colors', 'receipts'].map(item => (
                                    <span key={item} style={{ background: '#3b82f615', color: '#3b82f6', padding: '4px 10px', fontSize: '11px', borderRadius: '12px' }}>{item}</span>
                                ))}
                            </div>
                        </div>
                    </div>
                    
                    {/* Create Backup Button */}
                    <div style={{ textAlign: 'center', padding: '20px', background: theme.bgSecondary, borderRadius: '8px' }}>
                        <button
                            onClick={() => handleCreateBackup(false)}
                            disabled={creatingBackup}
                            style={{ 
                                padding: '16px 48px', 
                                background: creatingBackup ? theme.border : 'linear-gradient(135deg, #10b981 0%, #059669 100%)', 
                                color: 'white', 
                                border: 'none', 
                                fontSize: '16px', 
                                fontWeight: '700', 
                                cursor: creatingBackup ? 'not-allowed' : 'pointer',
                                borderRadius: '8px',
                                boxShadow: '0 4px 12px rgba(16, 185, 129, 0.3)'
                            }}
                        >
                            {creatingBackup ? '‚è≥ Creating Backup...' : 'üíæ Create Backup Now'}
                        </button>
                        <p style={{ color: theme.textSecondary, fontSize: '13px', marginTop: '12px' }}>
                            A JSON file will be downloaded to your device
                        </p>
                    </div>
                    
                    {/* Backup History */}
                    {backupHistory.length > 0 && (
                        <div style={{ marginTop: '24px' }}>
                            <h3 style={{ color: theme.text, fontSize: '16px', marginBottom: '12px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                                <span>üìã</span> Recent Backup History
                            </h3>
                            <div style={{ background: theme.bg, border: `1px solid ${theme.border}`, borderRadius: '8px', overflow: 'hidden' }}>
                                {backupHistory.slice(0, 5).map((backup, idx) => (
                                    <div key={idx} style={{ padding: '12px 16px', borderBottom: idx < 4 ? `1px solid ${theme.border}` : 'none', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                        <div>
                                            <span style={{ fontFamily: 'monospace', fontSize: '13px', color: theme.text }}>{backup.filename}</span>
                                            <div style={{ fontSize: '12px', color: theme.textSecondary, marginTop: '2px' }}>
                                                {new Date(backup.createdAt).toLocaleString()} ‚Ä¢ {backup.stats?.firestoreDocs || 0} docs ‚Ä¢ {formatSize(backup.stats?.totalSize || 0)}
                                            </div>
                                        </div>
                                        <span style={{ 
                                            background: backup.type === 'pre-reset' ? '#fef3c7' : '#dcfce7', 
                                            color: backup.type === 'pre-reset' ? '#92400e' : '#166534', 
                                            padding: '4px 10px', 
                                            fontSize: '11px', 
                                            borderRadius: '12px',
                                            fontWeight: '600'
                                        }}>
                                            {backup.type === 'pre-reset' ? 'Pre-Reset' : 'Manual'}
                                        </span>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            )}

            {/* ==================== RESTORE TAB ==================== */}
            {backupTab === 'restore' && (
                <div>
                    {/* Restore Header */}
                    <div style={{ background: 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)', padding: '24px', marginBottom: '20px', color: 'white', borderRadius: '8px' }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
                            <div style={{ fontSize: '48px' }}>üì•</div>
                            <div>
                                <h2 style={{ margin: '0 0 6px', fontSize: '22px', fontWeight: '700' }}>Restore from Backup</h2>
                                <p style={{ margin: 0, opacity: 0.9, fontSize: '14px' }}>
                                    Upload a previously downloaded backup file to restore your data.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    {/* Restore Success */}
                    {restoreSuccess && (
                        <div style={{ background: '#dcfce7', border: '1px solid #86efac', padding: '20px', marginBottom: '20px', borderRadius: '8px' }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '12px' }}>
                                <span style={{ fontSize: '28px' }}>‚úÖ</span>
                                <strong style={{ color: '#166534', fontSize: '16px' }}>Data Restored Successfully!</strong>
                            </div>
                            <div style={{ display: 'flex', gap: '20px', flexWrap: 'wrap', fontSize: '14px', color: '#166534', background: '#bbf7d0', padding: '12px', borderRadius: '6px' }}>
                                <span>üìÑ {restoreSuccess.firestore?.restored || 0} documents restored</span>
                                <span>‚ö° {restoreSuccess.realtime?.restored || 0} database paths restored</span>
                            </div>
                            {(restoreSuccess.firestore?.errors?.length > 0 || restoreSuccess.realtime?.errors?.length > 0) && (
                                <p style={{ color: '#92400e', fontSize: '13px', marginTop: '10px' }}>
                                    ‚ö†Ô∏è Some items had errors: {(restoreSuccess.firestore?.errors?.length || 0) + (restoreSuccess.realtime?.errors?.length || 0)} failed
                                </p>
                            )}
                            <button onClick={() => setRestoreSuccess(null)} style={{ marginTop: '12px', padding: '8px 16px', background: '#166534', border: 'none', color: 'white', cursor: 'pointer', fontSize: '13px', borderRadius: '4px' }}>Dismiss</button>
                        </div>
                    )}
                    
                    {/* Restore Progress */}
                    {restoring && restoreProgress && (
                        <div style={{ background: theme.bg, border: `1px solid ${theme.border}`, padding: '24px', marginBottom: '20px', borderRadius: '8px', textAlign: 'center' }}>
                            <div style={{ width: '60px', height: '60px', border: '4px solid #e5e7eb', borderTopColor: '#3b82f6', borderRadius: '50%', animation: 'spin 0.8s linear infinite', margin: '0 auto 16px' }}></div>
                            <h3 style={{ margin: '0 0 8px', color: theme.text, fontSize: '16px' }}>Restoring Data...</h3>
                            <p style={{ color: theme.textSecondary, fontSize: '14px', margin: '8px 0' }}>{restoreProgress.phase}</p>
                            <div style={{ background: theme.border, height: '8px', borderRadius: '4px', overflow: 'hidden', marginTop: '12px' }}>
                                <div style={{ background: '#3b82f6', height: '100%', width: `${restoreProgress.current}%`, transition: 'width 0.3s' }}></div>
                            </div>
                            <p style={{ color: theme.textSecondary, fontSize: '12px', marginTop: '8px' }}>{restoreProgress.current}%</p>
                        </div>
                    )}
                    
                    {/* File Upload Area */}
                    <input 
                        type="file" 
                        ref={fileInputRef} 
                        accept=".json" 
                        style={{ display: 'none' }} 
                        onChange={handleFileSelect}
                    />
                    
                    {!backupPreview && !restoring && (
                        <div 
                            onClick={() => fileInputRef.current?.click()}
                            style={{ 
                                background: theme.bg, 
                                border: `2px dashed ${theme.border}`, 
                                padding: '60px 40px', 
                                textAlign: 'center', 
                                borderRadius: '12px',
                                cursor: 'pointer',
                                transition: 'all 0.2s'
                            }}
                            onMouseOver={e => { e.currentTarget.style.borderColor = '#3b82f6'; e.currentTarget.style.background = '#3b82f608'; }}
                            onMouseOut={e => { e.currentTarget.style.borderColor = theme.border; e.currentTarget.style.background = theme.bg; }}
                        >
                            <div style={{ fontSize: '64px', marginBottom: '16px' }}>üìÇ</div>
                            <h3 style={{ color: theme.text, margin: '0 0 8px', fontSize: '18px' }}>Select Backup File</h3>
                            <p style={{ color: theme.textSecondary, fontSize: '14px', margin: 0 }}>Click to browse or drag and drop a .json backup file</p>
                        </div>
                    )}
                    
                    {/* Backup Preview */}
                    {backupPreview && !restoring && (
                        <div style={{ background: theme.bg, border: `1px solid ${theme.border}`, borderRadius: '8px', overflow: 'hidden' }}>
                            <div style={{ background: '#3b82f615', padding: '16px 20px', borderBottom: `1px solid ${theme.border}` }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                                        <span style={{ fontSize: '24px' }}>üìÑ</span>
                                        <div>
                                            <strong style={{ color: theme.text }}>{selectedFile?.name}</strong>
                                            <p style={{ margin: '2px 0 0', fontSize: '12px', color: theme.textSecondary }}>
                                                Created: {new Date(backupPreview.metadata?.createdAt).toLocaleString()}
                                            </p>
                                        </div>
                                    </div>
                                    <button 
                                        onClick={() => { setSelectedFile(null); setBackupPreview(null); }}
                                        style={{ background: 'transparent', border: 'none', color: theme.textSecondary, cursor: 'pointer', fontSize: '20px' }}
                                    >√ó</button>
                                </div>
                            </div>
                            
                            <div style={{ padding: '20px' }}>
                                <h4 style={{ color: theme.text, margin: '0 0 16px', fontSize: '14px' }}>Backup Contents:</h4>
                                
                                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '12px', marginBottom: '20px' }}>
                                    <div style={{ background: theme.bgSecondary, padding: '16px', borderRadius: '8px', textAlign: 'center' }}>
                                        <div style={{ fontSize: '28px', fontWeight: '700', color: '#10b981' }}>{backupPreview.firestoreDocs}</div>
                                        <div style={{ fontSize: '12px', color: theme.textSecondary }}>Firestore Documents</div>
                                    </div>
                                    <div style={{ background: theme.bgSecondary, padding: '16px', borderRadius: '8px', textAlign: 'center' }}>
                                        <div style={{ fontSize: '28px', fontWeight: '700', color: '#f59e0b' }}>{backupPreview.realtimePaths.length}</div>
                                        <div style={{ fontSize: '12px', color: theme.textSecondary }}>Realtime DB Paths</div>
                                    </div>
                                    <div style={{ background: theme.bgSecondary, padding: '16px', borderRadius: '8px', textAlign: 'center' }}>
                                        <div style={{ fontSize: '28px', fontWeight: '700', color: '#3b82f6' }}>{backupPreview.collections.length}</div>
                                        <div style={{ fontSize: '12px', color: theme.textSecondary }}>Collections</div>
                                    </div>
                                </div>
                                
                                <div style={{ marginBottom: '16px' }}>
                                    <strong style={{ color: theme.text, fontSize: '13px' }}>Collections to restore:</strong>
                                    <div style={{ display: 'flex', flexWrap: 'wrap', gap: '6px', marginTop: '8px' }}>
                                        {backupPreview.collections.map(coll => (
                                            <span key={coll} style={{ background: '#10b98115', color: '#10b981', padding: '4px 10px', fontSize: '11px', borderRadius: '12px' }}>{coll}</span>
                                        ))}
                                    </div>
                                </div>
                                
                                <div style={{ background: '#fef3c7', border: '1px solid #fde047', padding: '12px', borderRadius: '6px', marginBottom: '20px' }}>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '8px', color: '#92400e', fontSize: '13px' }}>
                                        <span>‚ö†Ô∏è</span>
                                        <span><strong>Warning:</strong> Restoring will merge data with existing records. Existing documents with same IDs will be overwritten.</span>
                                    </div>
                                </div>
                                
                                <div style={{ display: 'flex', gap: '12px' }}>
                                    <button 
                                        onClick={() => { setSelectedFile(null); setBackupPreview(null); }}
                                        style={{ flex: 1, padding: '14px', background: 'transparent', border: `1px solid ${theme.border}`, color: theme.text, fontWeight: '600', cursor: 'pointer', borderRadius: '6px' }}
                                    >
                                        Cancel
                                    </button>
                                    <button 
                                        onClick={() => setShowRestoreConfirm(true)}
                                        style={{ flex: 2, padding: '14px', background: 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)', border: 'none', color: 'white', fontWeight: '700', cursor: 'pointer', borderRadius: '6px' }}
                                    >
                                        üì• Restore This Backup
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Restore Confirmation Modal */}
                    {showRestoreConfirm && (
                        <div style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.7)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 }} onClick={() => setShowRestoreConfirm(false)}>
                            <div style={{ background: theme.bg, width: '100%', maxWidth: '450px', margin: '20px', borderRadius: '12px', overflow: 'hidden' }} onClick={e => e.stopPropagation()}>
                                <div style={{ background: '#3b82f6', padding: '24px', color: 'white', textAlign: 'center' }}>
                                    <div style={{ fontSize: '48px', marginBottom: '8px' }}>üì•</div>
                                    <h2 style={{ margin: '0 0 4px', fontSize: '18px' }}>Confirm Restore</h2>
                                </div>
                                <div style={{ padding: '24px' }}>
                                    <p style={{ color: theme.text, fontSize: '14px', marginBottom: '20px' }}>
                                        You are about to restore <strong>{backupPreview?.firestoreDocs} documents</strong> from backup file <strong>{selectedFile?.name}</strong>.
                                    </p>
                                    <p style={{ color: theme.textSecondary, fontSize: '13px', marginBottom: '20px' }}>
                                        This will merge data with existing records. Documents with matching IDs will be overwritten.
                                    </p>
                                    <div style={{ display: 'flex', gap: '12px' }}>
                                        <button 
                                            onClick={() => setShowRestoreConfirm(false)}
                                            style={{ flex: 1, padding: '12px', background: 'transparent', border: `1px solid ${theme.border}`, color: theme.text, fontWeight: '600', cursor: 'pointer', borderRadius: '6px' }}
                                        >
                                            Cancel
                                        </button>
                                        <button 
                                            onClick={handleRestore}
                                            style={{ flex: 1, padding: '12px', background: '#3b82f6', border: 'none', color: 'white', fontWeight: '700', cursor: 'pointer', borderRadius: '6px' }}
                                        >
                                            ‚úÖ Confirm Restore
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            )}

            {/* ==================== FACTORY RESET TAB ==================== */}
            {backupTab === 'reset' && (
                <div>
                    {/* Header Warning */}
                    <div style={{ background: '#dc2626', padding: '24px', marginBottom: '20px', color: 'white', borderRadius: '8px' }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
                            <div style={{ fontSize: '48px' }}>‚ö†Ô∏è</div>
                            <div>
                                <h2 style={{ margin: '0 0 6px', fontSize: '22px', fontWeight: '700' }}>Factory Reset - Danger Zone</h2>
                                <p style={{ margin: 0, opacity: 0.9, fontSize: '14px' }}>
                                    Permanently delete ALL data. <strong>Authentication will be preserved.</strong>
                                </p>
                            </div>
                        </div>
                    </div>

                    {/* Results Banner */}
                    {results && (
                        <div style={{ background: '#dcfce7', border: '1px solid #86efac', padding: '16px', marginBottom: '20px', borderRadius: '8px' }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '8px' }}>
                                <span style={{ fontSize: '20px' }}>‚úÖ</span>
                                <strong style={{ color: '#166534' }}>Factory Reset Completed</strong>
                            </div>
                            <div style={{ display: 'flex', gap: '20px', flexWrap: 'wrap', fontSize: '14px', color: '#166534' }}>
                                <span>Firestore: {results.firestore.deleted} docs</span>
                                <span>Realtime: {results.realtime.deleted} paths</span>
                                <span>Storage: {results.storage.deleted} files</span>
                            </div>
                            <button onClick={() => setResults(null)} style={{ marginTop: '10px', padding: '6px 12px', background: 'transparent', border: '1px solid #166534', color: '#166534', cursor: 'pointer', fontSize: '12px', borderRadius: '4px' }}>Dismiss</button>
                        </div>
                    )}
                    
                    {/* Pre-Reset Backup Requirement */}
                    <div style={{ background: '#fef3c7', border: '2px solid #fde047', padding: '20px', marginBottom: '20px', borderRadius: '8px' }}>
                        <div style={{ display: 'flex', alignItems: 'flex-start', gap: '12px' }}>
                            <span style={{ fontSize: '24px' }}>üíæ</span>
                            <div style={{ flex: 1 }}>
                                <h3 style={{ margin: '0 0 8px', color: '#92400e', fontSize: '16px' }}>Backup Required Before Reset</h3>
                                <p style={{ margin: '0 0 12px', color: '#92400e', fontSize: '13px' }}>
                                    You must create a backup before performing a factory reset. This ensures you can restore your data if needed.
                                </p>
                                {preResetBackupDone ? (
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '8px', color: '#166534' }}>
                                        <span style={{ fontSize: '20px' }}>‚úÖ</span>
                                        <strong>Pre-reset backup completed!</strong>
                                    </div>
                                ) : (
                                    <button
                                        onClick={() => handleCreateBackup(true)}
                                        disabled={creatingBackup}
                                        style={{ 
                                            padding: '12px 24px', 
                                            background: creatingBackup ? '#d4d4d4' : '#f59e0b', 
                                            color: 'white', 
                                            border: 'none', 
                                            fontWeight: '700', 
                                            cursor: creatingBackup ? 'not-allowed' : 'pointer',
                                            borderRadius: '6px',
                                            fontSize: '14px'
                                        }}
                                    >
                                        {creatingBackup ? '‚è≥ Creating Pre-Reset Backup...' : 'üíæ Create Pre-Reset Backup'}
                                    </button>
                                )}
                            </div>
                        </div>
                    </div>

                    {/* Data Categories */}
                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(280px, 1fr))', gap: '16px', marginBottom: '20px' }}>
                        {/* Firestore */}
                        <div style={{ background: theme.bg, border: `1px solid ${theme.border}`, padding: '16px', borderRadius: '8px' }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '12px' }}>
                                <span style={{ fontSize: '20px' }}>üóÑÔ∏è</span>
                                <strong style={{ color: theme.text }}>Firestore Collections</strong>
                                <span style={{ marginLeft: 'auto', background: '#dc262620', color: '#dc2626', padding: '2px 8px', fontSize: '12px', fontWeight: '700', borderRadius: '4px' }}>{FIRESTORE_COLLECTIONS.length}</span>
                            </div>
                            <div style={{ maxHeight: '150px', overflow: 'auto' }}>
                                {FIRESTORE_COLLECTIONS.map(c => (
                                    <div key={c} style={{ padding: '6px 10px', background: theme.bgSecondary, marginBottom: '4px', fontSize: '12px', fontFamily: 'monospace', color: theme.text, borderRadius: '4px' }}>{c}</div>
                                ))}
                            </div>
                        </div>

                        {/* Realtime DB */}
                        <div style={{ background: theme.bg, border: `1px solid ${theme.border}`, padding: '16px', borderRadius: '8px' }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '12px' }}>
                                <span style={{ fontSize: '20px' }}>‚ö°</span>
                                <strong style={{ color: theme.text }}>Realtime Database</strong>
                                <span style={{ marginLeft: 'auto', background: '#dc262620', color: '#dc2626', padding: '2px 8px', fontSize: '12px', fontWeight: '700', borderRadius: '4px' }}>{REALTIME_PATHS.length}</span>
                            </div>
                            <div style={{ maxHeight: '150px', overflow: 'auto' }}>
                                {REALTIME_PATHS.map(p => (
                                    <div key={p} style={{ padding: '6px 10px', background: theme.bgSecondary, marginBottom: '4px', fontSize: '12px', fontFamily: 'monospace', color: theme.text, borderRadius: '4px' }}>{p}</div>
                                ))}
                            </div>
                        </div>

                        {/* Storage */}
                        <div style={{ background: theme.bg, border: `1px solid ${theme.border}`, padding: '16px', borderRadius: '8px' }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '12px' }}>
                                <span style={{ fontSize: '20px' }}>üìÅ</span>
                                <strong style={{ color: theme.text }}>Cloud Storage</strong>
                                <span style={{ marginLeft: 'auto', background: '#dc262620', color: '#dc2626', padding: '2px 8px', fontSize: '12px', fontWeight: '700', borderRadius: '4px' }}>{STORAGE_FOLDERS.length}</span>
                            </div>
                            <div style={{ maxHeight: '150px', overflow: 'auto' }}>
                                {STORAGE_FOLDERS.map(f => (
                                    <div key={f} style={{ padding: '6px 10px', background: theme.bgSecondary, marginBottom: '4px', fontSize: '12px', fontFamily: 'monospace', color: theme.text, borderRadius: '4px' }}>{f}/</div>
                                ))}
                            </div>
                        </div>
                    </div>

                    {/* Preserved Data Notice */}
                    <div style={{ background: '#dbeafe', border: '1px solid #93c5fd', padding: '14px', marginBottom: '20px', borderRadius: '8px' }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                            <span style={{ fontSize: '18px' }}>üîí</span>
                            <span style={{ color: '#1e40af', fontSize: '14px' }}><strong>Preserved:</strong> User authentication accounts will NOT be deleted</span>
                        </div>
                    </div>

                    {/* Reset Button */}
                    <div style={{ textAlign: 'center', padding: '20px', background: theme.bgSecondary, borderRadius: '8px' }}>
                        <button
                            onClick={() => {
                                if (!preResetBackupDone) {
                                    setError('You must create a pre-reset backup before performing a factory reset');
                                    return;
                                }
                                setShowConfirmModal(true);
                            }}
                            disabled={!preResetBackupDone}
                            style={{ 
                                padding: '16px 48px', 
                                background: preResetBackupDone ? '#dc2626' : theme.border, 
                                color: 'white', 
                                border: 'none', 
                                fontSize: '16px', 
                                fontWeight: '700', 
                                cursor: preResetBackupDone ? 'pointer' : 'not-allowed',
                                borderRadius: '8px',
                                opacity: preResetBackupDone ? 1 : 0.6
                            }}
                        >
                            üîÑ Perform Factory Reset
                        </button>
                        {!preResetBackupDone && (
                            <p style={{ color: '#dc2626', fontSize: '13px', marginTop: '12px' }}>
                                ‚ö†Ô∏è Create a pre-reset backup first to enable this button
                            </p>
                        )}
                    </div>
                </div>
            )}

            {/* Confirmation Modal */}
            {showConfirmModal && (
                <div style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.7)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 }} onClick={() => !resetting && setShowConfirmModal(false)}>
                    <div style={{ background: theme.bg, width: '100%', maxWidth: '450px', margin: '20px', borderRadius: '12px', overflow: 'hidden' }} onClick={e => e.stopPropagation()}>
                        <div style={{ background: '#dc2626', padding: '24px', color: 'white', textAlign: 'center' }}>
                            <div style={{ fontSize: '48px', marginBottom: '8px' }}>‚ö†Ô∏è</div>
                            <h2 style={{ margin: '0 0 4px', fontSize: '18px' }}>Confirm Factory Reset</h2>
                            <p style={{ margin: 0, opacity: 0.9, fontSize: '13px' }}>This action cannot be undone!</p>
                        </div>

                        <div style={{ padding: '24px' }}>
                            {resetting ? (
                                <div style={{ textAlign: 'center', padding: '20px' }}>
                                    <div style={{ width: '50px', height: '50px', border: '4px solid #e5e7eb', borderTopColor: '#dc2626', borderRadius: '50%', animation: 'spin 0.8s linear infinite', margin: '0 auto 16px' }}></div>
                                    <h3 style={{ margin: '0 0 8px', color: theme.text, fontSize: '16px' }}>Resetting System...</h3>
                                    {progress && (
                                        <div style={{ color: theme.textSecondary, fontSize: '13px' }}>
                                            <p style={{ margin: '6px 0' }}>
                                                {progress.phase === 'firestore' && 'üóÑÔ∏è Clearing Firestore...'}
                                                {progress.phase === 'realtime' && '‚ö° Clearing Realtime DB...'}
                                                {progress.phase === 'storage' && 'üìÅ Clearing Storage...'}
                                            </p>
                                            <p style={{ margin: '4px 0', fontFamily: 'monospace' }}>{progress.item} ({progress.current}/{progress.total})</p>
                                            <div style={{ background: theme.border, height: '6px', marginTop: '10px', overflow: 'hidden', borderRadius: '3px' }}>
                                                <div style={{ background: '#dc2626', height: '100%', width: `${(progress.current / progress.total) * 100}%`, transition: 'width 0.2s' }}></div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            ) : (
                                <>
                                    <div style={{ background: '#fef3c7', border: '1px solid #fde047', padding: '12px', marginBottom: '16px', fontSize: '13px', color: '#92400e', borderRadius: '6px' }}>
                                        <strong>You are about to delete:</strong>
                                        <ul style={{ margin: '6px 0 0', paddingLeft: '18px' }}>
                                            <li>{FIRESTORE_COLLECTIONS.length} Firestore collections</li>
                                            <li>{REALTIME_PATHS.length} Realtime Database paths</li>
                                            <li>{STORAGE_FOLDERS.length} Storage folders</li>
                                        </ul>
                                    </div>

                                    <div style={{ marginBottom: '16px' }}>
                                        <label style={{ display: 'block', marginBottom: '6px', color: theme.text, fontWeight: '600', fontSize: '13px' }}>
                                            Type <span style={{ color: '#dc2626', fontFamily: 'monospace' }}>{CONFIRM_PHRASE}</span> to confirm:
                                        </label>
                                        <input
                                            type="text"
                                            value={confirmText}
                                            onChange={(e) => setConfirmText(e.target.value)}
                                            placeholder={CONFIRM_PHRASE}
                                            style={{ width: '100%', padding: '10px 12px', border: `2px solid ${confirmText === CONFIRM_PHRASE ? '#dc2626' : theme.border}`, fontSize: '14px', fontFamily: 'monospace', background: theme.inputBg, color: theme.text, boxSizing: 'border-box', borderRadius: '6px' }}
                                        />
                                    </div>

                                    <div style={{ display: 'flex', gap: '10px' }}>
                                        <button onClick={() => { setShowConfirmModal(false); setConfirmText(''); }} style={{ flex: 1, padding: '12px', background: 'transparent', border: `1px solid ${theme.border}`, color: theme.text, fontWeight: '600', cursor: 'pointer', borderRadius: '6px' }}>Cancel</button>
                                        <button onClick={handleFactoryReset} disabled={confirmText !== CONFIRM_PHRASE} style={{ flex: 1, padding: '12px', background: confirmText === CONFIRM_PHRASE ? '#dc2626' : theme.border, border: 'none', color: 'white', fontWeight: '700', cursor: confirmText === CONFIRM_PHRASE ? 'pointer' : 'not-allowed', borderRadius: '6px' }}>üóëÔ∏è Delete All</button>
                                    </div>
                                </>
                            )}
                        </div>
                    </div>
                </div>
            )}
            <style>{`@keyframes spin { to { transform: rotate(360deg); } }`}</style>
        </div>
    );
}

// ==================== STAFF MANAGEMENT COMPONENT ====================
function StaffManagement() {
    const { canCreate, canEdit, canDelete, isSuperAdmin, userProfile } = usePermissions();
    const [activeTab, setActiveTab] = useState('staff');
    const [staffList, setStaffList] = useState([]);
    const [usersList, setUsersList] = useState([]);
    const [auditLogs, setAuditLogs] = useState([]);
    const [activeSessions, setActiveSessions] = useState([]); // Track who's currently logged in
    const [loading, setLoading] = useState(true);
    const [showAddStaffModal, setShowAddStaffModal] = useState(false);
    const [showAddUserModal, setShowAddUserModal] = useState(false);
    const [showEditModal, setShowEditModal] = useState(false);
    const [showEditUserModal, setShowEditUserModal] = useState(false);
    const [showConfirmModal, setShowConfirmModal] = useState(false);
    const [confirmAction, setConfirmAction] = useState(null);
    const [selectedItem, setSelectedItem] = useState(null);
    const [selectedUser, setSelectedUser] = useState(null);
    const [actionLoading, setActionLoading] = useState(false);
    const [error, setError] = useState(null);
    const [successMessage, setSuccessMessage] = useState(null);
    const [searchTerm, setSearchTerm] = useState('');
    const [filterStatus, setFilterStatus] = useState('active');
    const [auditFilter, setAuditFilter] = useState({ action: '', module: '' });
    const [isDark, setIsDark] = useState(document.documentElement.getAttribute('data-theme') === 'dark');
    const [showSuperAdmin, setShowSuperAdmin] = useState(false); // Hidden super admin visibility toggle

    // Super admin email constant
    const SUPER_ADMIN_EMAIL = 'admin@ecospark.com';

    // Check if an email is super admin
    const isSuperAdminEmail = (email) => email?.toLowerCase() === SUPER_ADMIN_EMAIL.toLowerCase();

    const [staffForm, setStaffForm] = useState({ staffId: '', name: '', role: 'Washer', phone: '', email: '', department: 'Operations', hireDate: new Date().toISOString().split('T')[0], hourlyRate: '', emergencyContact: '', notes: '' });
    const [userForm, setUserForm] = useState({ userId: '', email: '', password: '', displayName: '', role: 'staff', phone: '', permissions: {} });
    const [editUserForm, setEditUserForm] = useState({ displayName: '', role: 'staff', phone: '', permissions: {} });
    const [userStep, setUserStep] = useState(1);

    // Generate Staff ID in format SXX-YYYY (e.g., S01-2026)
    const generateStaffId = () => {
        const currentYear = new Date().getFullYear();
        // Find the highest staff number from current year
        const currentYearStaff = staffList.filter(s => {
            if (!s.staffId) return false;
            const match = s.staffId.match(/^S(\d+)-(\d{4})$/);
            return match && match[2] === String(currentYear);
        });
        let nextNumber = 1;
        if (currentYearStaff.length > 0) {
            const maxNumber = Math.max(...currentYearStaff.map(s => {
                const match = s.staffId?.match(/^S(\d+)-/);
                const num = match ? parseInt(match[1], 10) : 0;
                return isNaN(num) ? 0 : num;
            }));
            nextNumber = maxNumber + 1;
        }
        return `S${String(nextNumber).padStart(2, '0')}-${currentYear}`;
    };

    // Generate User ID in format UXX-YYYY (e.g., U01-2026)
    const generateUserId = () => {
        const currentYear = new Date().getFullYear();
        // Find the highest user number from current year
        const currentYearUsers = usersList.filter(u => {
            if (!u.userId) return false;
            const match = u.userId.match(/^U(\d+)-(\d{4})$/);
            return match && match[2] === String(currentYear);
        });
        let nextNumber = 1;
        if (currentYearUsers.length > 0) {
            const maxNumber = Math.max(...currentYearUsers.map(u => {
                const match = u.userId?.match(/^U(\d+)-/);
                const num = match ? parseInt(match[1], 10) : 0;
                return isNaN(num) ? 0 : num;
            }));
            nextNumber = maxNumber + 1;
        }
        return `U${String(nextNumber).padStart(2, '0')}-${currentYear}`;
    };

    // Auto-generate User ID when opening add user modal
    const openAddUserModal = () => {
        const newId = generateUserId();
        setUserForm({ userId: newId, email: '', password: '', displayName: '', role: 'staff', phone: '', permissions: {} });
        setUserStep(1);
        setShowAddUserModal(true);
    };

    const STAFF_ROLES = ['Washer', 'Detailer', 'Supervisor', 'Technician', 'Cleaner', 'Attendant'];
    const DEPARTMENTS = ['Operations', 'Garage', 'Administration', 'Customer Service'];
    
    // All system modules with their permissions
    const ALL_MODULES = [
        { id: 'dashboard', label: 'Dashboard', icon: 'üìä', category: 'Core' },
        { id: 'vehicle-intake', label: 'Vehicle Intake', icon: 'üöó', category: 'Core' },
        { id: 'service-packages', label: 'Service Packages', icon: 'üì¶', category: 'Services' },
        { id: 'garage-management', label: 'Garage Management', icon: 'üè¢', category: 'Operations' },
        { id: 'wash-bays', label: 'Wash Bays', icon: 'üíß', category: 'Operations' },
        { id: 'parking', label: 'Parking Management', icon: 'üÖøÔ∏è', category: 'Operations' },
        { id: 'equipment', label: 'Equipment Management', icon: 'üîß', category: 'Operations' },
        { id: 'customers', label: 'Customer Management', icon: 'üë•', category: 'Customer Relations' },
        { id: 'fleet', label: 'Fleet Accounts', icon: 'üöõ', category: 'Customer Relations' },
        { id: 'staff', label: 'Staff Management', icon: 'üë∑', category: 'Staff' },
        { id: 'hr', label: 'HR Statistics', icon: 'üë•', category: 'Human Resources' },
        { id: 'billing', label: 'Billing & Payments', icon: 'üí≥', category: 'Financial' },
        { id: 'expenses', label: 'Expenses', icon: 'üìâ', category: 'Financial' },
        { id: 'inventory', label: 'Inventory Management', icon: 'üìã', category: 'Financial' },
        { id: 'reports', label: 'Reports & Analytics', icon: 'üìà', category: 'Analytics & Marketing' },
        { id: 'marketing', label: 'Marketing & CRM', icon: 'üì£', category: 'Analytics & Marketing' },
        { id: 'settings', label: 'System Settings', icon: '‚öôÔ∏è', category: 'System' },
        { id: 'audit-logs', label: 'Audit Logs', icon: 'üìú', category: 'System' }
    ];

    const PERMISSION_ACTIONS = [
        { id: 'view', label: 'View', icon: 'üëÅÔ∏è' },
        { id: 'create', label: 'Create', icon: '‚ûï' },
        { id: 'edit', label: 'Edit', icon: '‚úèÔ∏è' },
        { id: 'delete', label: 'Delete', icon: 'üóëÔ∏è' },
        { id: 'change-status', label: 'Status', icon: 'üîÑ' }
    ];

    const USER_ROLES = [
        { id: 'admin', label: 'Admin', desc: 'Full system access' },
        { id: 'manager', label: 'Manager', desc: 'Manage operations & staff' },
        { id: 'supervisor', label: 'Supervisor', desc: 'Oversee daily operations' },
        { id: 'receptionist', label: 'Receptionist', desc: 'Customer intake & billing' },
        { id: 'technician', label: 'Technician', desc: 'Garage operations only' },
        { id: 'staff', label: 'Staff', desc: 'Basic access only' }
    ];

    // Generate default permissions based on role
    const getDefaultPermissions = (role) => {
        const permissions = {};
        ALL_MODULES.forEach(mod => {
            if (role === 'admin') {
                permissions[mod.id] = { view: true, create: true, edit: true, delete: true, 'change-status': true };
            } else if (role === 'manager') {
                permissions[mod.id] = { view: true, create: true, edit: true, delete: mod.category !== 'System', 'change-status': true };
            } else if (role === 'supervisor') {
                const canManage = ['Core', 'Operations', 'Services'].includes(mod.category);
                permissions[mod.id] = { view: true, create: canManage, edit: canManage, delete: false, 'change-status': canManage };
            } else if (role === 'receptionist') {
                const canAccess = ['Core', 'Customer Relations', 'Financial'].includes(mod.category);
                permissions[mod.id] = { view: canAccess, create: canAccess && mod.id !== 'billing', edit: canAccess && mod.id !== 'billing', delete: false, 'change-status': false };
            } else if (role === 'technician') {
                const canAccess = mod.category === 'Operations' || mod.id === 'dashboard';
                permissions[mod.id] = { view: canAccess, create: false, edit: canAccess, delete: false, 'change-status': false };
            } else {
                permissions[mod.id] = { view: mod.id === 'dashboard', create: false, edit: false, delete: false, 'change-status': false };
            }
        });
        return permissions;
    };

    const toggleModulePermission = (moduleId, action) => {
        setUserForm(prev => ({
            ...prev,
            permissions: {
                ...prev.permissions,
                [moduleId]: {
                    ...prev.permissions[moduleId],
                    [action]: !prev.permissions[moduleId]?.[action]
                }
            }
        }));
    };

    const toggleAllModulePermissions = (moduleId, enabled) => {
        setUserForm(prev => ({
            ...prev,
            permissions: {
                ...prev.permissions,
                [moduleId]: { view: enabled, create: enabled, edit: enabled, delete: enabled, 'change-status': enabled }
            }
        }));
    };

    const applyRolePreset = (role) => {
        setUserForm(prev => ({ ...prev, role, permissions: getDefaultPermissions(role) }));
    };

    useEffect(() => {
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.attributeName === 'data-theme') setIsDark(document.documentElement.getAttribute('data-theme') === 'dark');
            });
        });
        observer.observe(document.documentElement, { attributes: true });
        return () => observer.disconnect();
    }, []);

    const theme = { bg: isDark ? '#1e293b' : 'white', bgSecondary: isDark ? '#0f172a' : '#f8fafc', text: isDark ? '#f1f5f9' : '#1e293b', textSecondary: isDark ? '#94a3b8' : '#64748b', border: isDark ? '#334155' : '#e2e8f0', inputBg: isDark ? '#1e293b' : 'white' };

    useEffect(() => {
        if (successMessage) { const timer = setTimeout(() => setSuccessMessage(null), 3000); return () => clearTimeout(timer); }
    }, [successMessage]);

    useEffect(() => {
        const services = window.FirebaseServices;
        if (!services) { setLoading(false); return; }
        let unsubStaff = services.staffService?.subscribeToAllStaff((data) => { setStaffList(data); setLoading(false); });
        let unsubUsers = services.userService?.subscribeToUsers((data) => { setUsersList(data); });
        let unsubAudit = services.auditService?.subscribeToAuditLogs((data) => { setAuditLogs(data); }, 200);
        let unsubSessions = services.auditService?.subscribeToActiveSessions((data) => { setActiveSessions(data); });
        return () => { 
            if (unsubStaff) unsubStaff(); 
            if (unsubUsers) unsubUsers(); 
            if (unsubAudit) unsubAudit(); 
            if (unsubSessions) unsubSessions();
        };
    }, []);

    // Helper to check if user is currently online
    const isUserOnline = (userId) => {
        const session = activeSessions.find(s => s.odId === userId);
        if (!session) return false;
        // Check if last activity was within 5 minutes
        const lastActivity = new Date(session.lastActivity);
        const now = new Date();
        return (now - lastActivity) < 300000; // 5 minutes
    };

    // Get session info for a user
    const getUserSession = (userId) => {
        return activeSessions.find(s => s.odId === userId);
    };

    const filteredAuditLogs = auditLogs.filter(log => {
        // Hide super admin's logs unless showSuperAdmin is true
        if (!showSuperAdmin && isSuperAdminEmail(log.userEmail)) return false;
        const matchesSearch = log.userName?.toLowerCase().includes(searchTerm.toLowerCase()) || log.userEmail?.toLowerCase().includes(searchTerm.toLowerCase()) || log.details?.toLowerCase().includes(searchTerm.toLowerCase());
        const matchesAction = !auditFilter.action || log.action === auditFilter.action;
        const matchesModule = !auditFilter.module || log.module === auditFilter.module;
        return matchesSearch && matchesAction && matchesModule;
    });

    const getActionColor = (action) => {
        const colors = { login: '#10b981', logout: '#6b7280', create: '#3b82f6', update: '#f59e0b', delete: '#ef4444', view: '#8b5cf6' };
        return colors[action] || '#6b7280';
    };

    const getActionIcon = (action) => {
        const icons = { login: 'üîì', logout: 'üîí', create: '‚ûï', update: '‚úèÔ∏è', delete: 'üóëÔ∏è', view: 'üëÅÔ∏è' };
        return icons[action] || 'üìã';
    };

    const formatTimeAgo = (timestamp) => {
        const now = new Date();
        const date = new Date(timestamp);
        const seconds = Math.floor((now - date) / 1000);
        if (seconds < 60) return 'Just now';
        if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
        if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
        if (seconds < 604800) return `${Math.floor(seconds / 86400)}d ago`;
        return date.toLocaleDateString();
    };

    const filteredStaff = staffList.filter(s => {
        const matchesSearch = s.name?.toLowerCase().includes(searchTerm.toLowerCase()) || s.role?.toLowerCase().includes(searchTerm.toLowerCase()) || s.staffId?.toLowerCase().includes(searchTerm.toLowerCase());
        const matchesStatus = filterStatus === 'all' || s.status === filterStatus;
        return matchesSearch && matchesStatus;
    });

    const filteredUsers = usersList.filter(u => {
        // Hide super admin unless showSuperAdmin is true
        if (!showSuperAdmin && isSuperAdminEmail(u.email)) return false;
        const matchesSearch = u.displayName?.toLowerCase().includes(searchTerm.toLowerCase()) || u.email?.toLowerCase().includes(searchTerm.toLowerCase());
        const matchesStatus = filterStatus === 'all' || (filterStatus === 'active' ? u.isActive : !u.isActive);
        return matchesSearch && matchesStatus;
    });

    const handleAddStaff = async (e) => {
        e.preventDefault();
        if (!staffForm.name.trim()) { setError('Staff name is required'); return; }
        setActionLoading(true); setError(null);
        try {
            const services = window.FirebaseServices;
            const result = await services.staffService.addStaff(staffForm);
            if (result.success) {
                // Log the staff creation
                await services.auditService?.logCRUD(
                    window.currentUser || { email: 'admin' },
                    'create',
                    'staff',
                    'staff-member',
                    result.id || 'new',
                    staffForm.name,
                    `Created new staff member: ${staffForm.name} (${staffForm.role} - ${staffForm.department})`,
                    null,
                    null
                );
                setSuccessMessage('Staff added successfully');
                setShowAddStaffModal(false);
                setStaffForm({ staffId: '', name: '', role: 'Washer', phone: '', email: '', department: 'Operations', hireDate: new Date().toISOString().split('T')[0], hourlyRate: '', emergencyContact: '', notes: '' });
            } else { setError(result.error); }
        } catch (err) { setError(err.message); }
        finally { setActionLoading(false); }
    };

    const handleAddUser = async (e) => {
        e.preventDefault();
        if (!userForm.email.trim() || !userForm.password.trim()) { setError('Email and password required'); return; }
        if (userForm.password.length < 6) { setError('Password must be at least 6 characters'); return; }
        setActionLoading(true); setError(null);
        try {
            const services = window.FirebaseServices;
            const authResult = await services.authService.signUp(userForm.email, userForm.password);
            if (authResult.success) {
                await services.userService.createUserProfile(authResult.user.uid, { 
                    userId: userForm.userId,
                    email: userForm.email, 
                    displayName: userForm.displayName || userForm.email.split('@')[0], 
                    role: userForm.role, 
                    phone: userForm.phone, 
                    permissions: userForm.permissions,
                    isActive: true 
                });
                // Log user creation in audit trail
                await services.auditService?.logCRUD(
                    window.currentUser || { email: 'admin' },
                    'create',
                    'users',
                    'user',
                    authResult.user.uid,
                    userForm.displayName || userForm.email,
                    `Created user with role: ${userForm.role}`
                );
                setSuccessMessage('User created successfully');
                setShowAddUserModal(false);
                setUserStep(1);
                setUserForm({ userId: '', email: '', password: '', displayName: '', role: 'staff', phone: '', permissions: {} });
            } else { setError(authResult.error); }
        } catch (err) { setError(err.message); }
        finally { setActionLoading(false); }
    };

    const handleUpdateStaff = async (e) => {
        e.preventDefault();
        if (!selectedItem) return;
        setActionLoading(true); setError(null);
        try {
            const services = window.FirebaseServices;
            
            // Track changes
            const changes = {};
            if (selectedItem.name !== staffForm.name) changes.name = { old: selectedItem.name || '', new: staffForm.name };
            if (selectedItem.role !== staffForm.role) changes.role = { old: selectedItem.role || '', new: staffForm.role };
            if (selectedItem.phone !== staffForm.phone) changes.phone = { old: selectedItem.phone || '', new: staffForm.phone };
            if (selectedItem.email !== staffForm.email) changes.email = { old: selectedItem.email || '', new: staffForm.email };
            if (selectedItem.department !== staffForm.department) changes.department = { old: selectedItem.department || '', new: staffForm.department };
            
            const result = await services.staffService.updateStaff(selectedItem.id, staffForm);
            if (result.success) {
                // Log the update with changes
                await services.auditService?.logCRUD(
                    window.currentUser || { email: 'admin' },
                    'update',
                    'staff',
                    'staff-member',
                    selectedItem.id,
                    selectedItem.name,
                    `Updated staff member details`,
                    Object.keys(changes).length > 0 ? changes : null,
                    null
                );
                setSuccessMessage('Staff updated'); 
                setShowEditModal(false); 
                setSelectedItem(null); 
            }
            else { setError(result.error); }
        } catch (err) { setError(err.message); }
        finally { setActionLoading(false); }
    };

    const handleUpdateUser = async (userId, updates) => {
        // Find the user to check if they're super admin
        const targetUser = usersList.find(u => u.id === userId);
        if (targetUser && isSuperAdminEmail(targetUser.email)) {
            setError('This account cannot be modified');
            return;
        }
        try {
            const result = await window.FirebaseServices.userService.updateUserProfile(userId, updates);
            if (result.success) setSuccessMessage('User updated');
            else setError(result.error);
        } catch (err) { setError(err.message); }
    };

    // Delete user state
    const [showDeleteUserModal, setShowDeleteUserModal] = useState(false);
    const [userToDelete, setUserToDelete] = useState(null);

    // Open delete confirmation modal
    const handleDeleteUserClick = (user) => {
        // Prevent deletion of super admin
        if (isSuperAdminEmail(user.email)) {
            setError('This account cannot be deleted');
            return;
        }
        setUserToDelete(user);
        setShowDeleteUserModal(true);
    };

    // Confirm delete user
    const handleConfirmDeleteUser = async () => {
        if (!userToDelete) return;
        setActionLoading(true);
        setError(null);
        try {
            const services = window.FirebaseServices;
            // Log the delete action with previous data
            await services.auditService?.logCRUD(
                window.currentUser || { email: 'admin' },
                'delete',
                'users',
                'user',
                userToDelete.id,
                userToDelete.displayName || userToDelete.email,
                `Permanently deleted user account`,
                null,
                { email: userToDelete.email, displayName: userToDelete.displayName, role: userToDelete.role }
            );
            
            const result = await services.userService.deleteUserProfile(userToDelete.id);
            if (result.success) {
                setSuccessMessage(`User ${userToDelete.displayName || userToDelete.email} deleted successfully`);
                setShowDeleteUserModal(false);
                setUserToDelete(null);
            } else {
                setError(result.error);
            }
        } catch (err) {
            setError(err.message);
        } finally {
            setActionLoading(false);
        }
    };

    // Open edit user modal
    const handleEditUser = (user) => {
        // Prevent editing super admin
        if (isSuperAdminEmail(user.email)) {
            setError('This account cannot be modified');
            return;
        }
        setSelectedUser(user);
        setEditUserForm({
            displayName: user.displayName || '',
            role: user.role || 'staff',
            phone: user.phone || '',
            permissions: user.permissions || getDefaultPermissions(user.role || 'staff')
        });
        setShowEditUserModal(true);
    };

    // Save edited user
    const handleSaveEditUser = async () => {
        if (!selectedUser) return;
        setActionLoading(true);
        setError(null);
        try {
            const services = window.FirebaseServices;
            
            // Track changes
            const changes = {};
            if (selectedUser.displayName !== editUserForm.displayName) {
                changes.displayName = { old: selectedUser.displayName || '', new: editUserForm.displayName };
            }
            if (selectedUser.role !== editUserForm.role) {
                changes.role = { old: selectedUser.role || '', new: editUserForm.role };
            }
            if (selectedUser.phone !== editUserForm.phone) {
                changes.phone = { old: selectedUser.phone || '', new: editUserForm.phone };
            }
            
            const result = await services.userService.updateUserProfile(selectedUser.id, {
                displayName: editUserForm.displayName,
                role: editUserForm.role,
                phone: editUserForm.phone,
                permissions: editUserForm.permissions
            });
            
            if (result.success) {
                // Log the update with changes
                await services.auditService?.logCRUD(
                    window.currentUser || { email: 'admin' },
                    'update',
                    'users',
                    'user',
                    selectedUser.id,
                    selectedUser.displayName || selectedUser.email,
                    `Updated user profile and permissions`,
                    Object.keys(changes).length > 0 ? changes : null,
                    null
                );
                
                setSuccessMessage('User permissions updated successfully');
                setShowEditUserModal(false);
                setSelectedUser(null);
            } else {
                setError(result.error);
            }
        } catch (err) {
            setError(err.message);
        } finally {
            setActionLoading(false);
        }
    };

    // Toggle permission for edit user form
    const toggleEditUserPermission = (moduleId, action) => {
        setEditUserForm(prev => ({
            ...prev,
            permissions: {
                ...prev.permissions,
                [moduleId]: {
                    ...prev.permissions[moduleId],
                    [action]: !prev.permissions[moduleId]?.[action]
                }
            }
        }));
    };

    // Toggle all permissions for a module
    const toggleEditUserAllModulePermissions = (moduleId, enabled) => {
        setEditUserForm(prev => ({
            ...prev,
            permissions: {
                ...prev.permissions,
                [moduleId]: { view: enabled, create: enabled, edit: enabled, delete: enabled, 'change-status': enabled }
            }
        }));
    };

    // Apply role preset to edit form
    const applyEditRolePreset = (role) => {
        setEditUserForm(prev => ({ ...prev, role, permissions: getDefaultPermissions(role) }));
    };

    const handleToggleStaffStatus = (staff) => {
        setSelectedItem(staff);
        setConfirmAction({
            type: 'toggle',
            title: staff.status === 'active' ? 'Deactivate Staff' : 'Activate Staff',
            message: staff.status === 'active' ? `Are you sure you want to deactivate ${staff.name}? They will no longer appear in staff assignments.` : `Are you sure you want to reactivate ${staff.name}?`,
            confirmText: staff.status === 'active' ? 'Deactivate' : 'Activate',
            confirmColor: staff.status === 'active' ? '#ef4444' : '#10b981'
        });
        setShowConfirmModal(true);
    };

    const handleDeleteStaff = (staff) => {
        setSelectedItem(staff);
        setConfirmAction({
            type: 'delete',
            title: 'Delete Staff Permanently',
            message: `Are you sure you want to permanently delete ${staff.name}? This action cannot be undone.`,
            confirmText: 'Delete Permanently',
            confirmColor: '#dc2626'
        });
        setShowConfirmModal(true);
    };

    const executeConfirmAction = async () => {
        if (!confirmAction || !selectedItem) return;
        setActionLoading(true);
        try {
            const services = window.FirebaseServices;
            if (confirmAction.type === 'toggle') {
                const newStatus = selectedItem.status === 'active' ? 'inactive' : 'active';
                if (selectedItem.status === 'active') await services.staffService.deleteStaff(selectedItem.id);
                else await services.staffService.reactivateStaff(selectedItem.id);
                
                // Log the status change
                await services.auditService?.logCRUD(
                    window.currentUser || { email: 'admin' },
                    'update',
                    'staff',
                    'staff-member',
                    selectedItem.id,
                    selectedItem.name,
                    `Changed staff status from ${selectedItem.status} to ${newStatus}`,
                    { status: { old: selectedItem.status, new: newStatus } },
                    null
                );
                
                setSuccessMessage(selectedItem.status === 'active' ? 'Staff deactivated' : 'Staff activated');
            } else if (confirmAction.type === 'delete') {
                // Log before deletion with full staff data
                await services.auditService?.logCRUD(
                    window.currentUser || { email: 'admin' },
                    'delete',
                    'staff',
                    'staff-member',
                    selectedItem.id,
                    selectedItem.name,
                    `Permanently deleted staff member`,
                    null,
                    { name: selectedItem.name, role: selectedItem.role, department: selectedItem.department, phone: selectedItem.phone, email: selectedItem.email }
                );
                
                await services.staffService.permanentDeleteStaff(selectedItem.id);
                setSuccessMessage('Staff permanently deleted');
            }
        } catch (err) { setError(err.message); }
        finally { setActionLoading(false); setShowConfirmModal(false); setConfirmAction(null); setSelectedItem(null); }
    };

    const openEditStaff = (staff) => {
        setSelectedItem(staff);
        setStaffForm({ staffId: staff.staffId || '', name: staff.name || '', role: staff.role || 'Washer', phone: staff.phone || '', email: staff.email || '', department: staff.department || 'Operations', hireDate: staff.hireDate || '', hourlyRate: staff.hourlyRate || '', emergencyContact: staff.emergencyContact || '', notes: staff.notes || '' });
        setShowEditModal(true);
    };

    // Auto-generate Staff ID when opening add modal
    const openAddStaffModal = () => {
        const newId = generateStaffId();
        setStaffForm({ staffId: newId, name: '', role: 'Washer', phone: '', email: '', department: 'Operations', hireDate: new Date().toISOString().split('T')[0], hourlyRate: '', emergencyContact: '', notes: '' });
        setShowAddStaffModal(true);
    };

    const inputStyle = { width: '100%', padding: '10px 12px', border: `1px solid ${theme.border}`, fontSize: '14px', backgroundColor: theme.inputBg, color: theme.text, boxSizing: 'border-box' };
    const labelStyle = { display: 'block', fontSize: '13px', fontWeight: '500', color: theme.text, marginBottom: '6px' };

    return (
        <div style={{ padding: '20px' }}>
            {error && <div style={{ background: '#fef2f2', border: '1px solid #fecaca', color: '#dc2626', padding: '12px 16px', marginBottom: '16px', display: 'flex', justifyContent: 'space-between' }}><span>{error}</span><button onClick={() => setError(null)} style={{ background: 'none', border: 'none', cursor: 'pointer', fontSize: '18px' }}>√ó</button></div>}
            {successMessage && <div style={{ background: '#f0fdf4', border: '1px solid #bbf7d0', color: '#16a34a', padding: '12px 16px', marginBottom: '16px' }}>{successMessage}</div>}

            <div style={{ display: 'flex', gap: '0', marginBottom: '20px', borderBottom: `2px solid ${theme.border}` }}>
                <button onClick={() => setActiveTab('staff')} style={{ padding: '12px 24px', border: 'none', background: activeTab === 'staff' ? '#3b82f6' : 'transparent', color: activeTab === 'staff' ? 'white' : theme.textSecondary, fontWeight: '600', cursor: 'pointer', borderRadius: '8px 8px 0 0' }}>üë∑ Staff ({staffList.filter(s => s.status === 'active').length})</button>
                <button onClick={() => setActiveTab('users')} style={{ padding: '12px 24px', border: 'none', background: activeTab === 'users' ? '#3b82f6' : 'transparent', color: activeTab === 'users' ? 'white' : theme.textSecondary, fontWeight: '600', cursor: 'pointer', borderRadius: '8px 8px 0 0' }}>üîê Users ({usersList.filter(u => u.isActive).length})</button>
                <button onClick={() => setActiveTab('audit')} style={{ padding: '12px 24px', border: 'none', background: activeTab === 'audit' ? '#3b82f6' : 'transparent', color: activeTab === 'audit' ? 'white' : theme.textSecondary, fontWeight: '600', cursor: 'pointer', borderRadius: '8px 8px 0 0' }}>üìú Audit Logs</button>
                {/* Factory Reset tab - Only visible to super admin (admin@ecospark.com) */}
                {isSuperAdmin && isSuperAdminEmail(userProfile?.email) && (
                    <button onClick={() => setActiveTab('factory-reset')} style={{ padding: '12px 24px', border: 'none', background: activeTab === 'factory-reset' ? '#dc2626' : 'transparent', color: activeTab === 'factory-reset' ? 'white' : theme.textSecondary, fontWeight: '600', cursor: 'pointer', borderRadius: '8px 8px 0 0' }}>üîÑ Factory Reset</button>
                )}
            </div>

            <div style={{ display: 'flex', gap: '12px', marginBottom: '20px', flexWrap: 'wrap', alignItems: 'center' }}>
                <input type="text" placeholder={`Search ${activeTab}...`} value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} style={{ ...inputStyle, maxWidth: '300px' }} />
                <select value={filterStatus} onChange={(e) => setFilterStatus(e.target.value)} style={{ ...inputStyle, maxWidth: '150px' }}>
                    <option value="active">Active</option><option value="inactive">Inactive</option><option value="all">All</option>
                </select>
                <div style={{ flex: 1 }}></div>
                {/* Hidden Super Admin Toggle - Only visible to super admin on users tab */}
                {activeTab === 'users' && isSuperAdmin && (
                    <button 
                        onClick={() => setShowSuperAdmin(!showSuperAdmin)}
                        title={showSuperAdmin ? 'Hide system account' : 'Show system account'}
                        style={{ 
                            padding: '8px 12px', 
                            background: showSuperAdmin ? '#7c3aed' : 'transparent', 
                            color: showSuperAdmin ? 'white' : theme.textSecondary,
                            border: `1px dashed ${showSuperAdmin ? '#7c3aed' : theme.border}`, 
                            borderRadius: '6px',
                            fontSize: '12px',
                            cursor: 'pointer',
                            opacity: 0.7,
                            transition: 'all 0.2s'
                        }}
                    >
                        {showSuperAdmin ? 'üëÅÔ∏è Visible' : 'üëÅÔ∏è‚Äçüó®Ô∏è'}
                    </button>
                )}
                {activeTab === 'staff' && canCreate('staff') && <button onClick={openAddStaffModal} style={{ padding: '10px 20px', background: '#3b82f6', color: 'white', border: 'none', fontWeight: '600', cursor: 'pointer' }}>+ Add Staff</button>}
                {activeTab === 'users' && canCreate('staff') && <button onClick={openAddUserModal} style={{ padding: '10px 20px', background: '#8b5cf6', color: 'white', border: 'none', fontWeight: '600', cursor: 'pointer' }}>+ Add User</button>}
            </div>

            {activeTab === 'staff' && (
                <div style={{ background: theme.bg, border: `1px solid ${theme.border}` }}>
                    {loading ? <div style={{ padding: '40px', textAlign: 'center', color: theme.textSecondary }}>Loading...</div> : filteredStaff.length === 0 ? (
                        <div style={{ padding: '60px', textAlign: 'center' }}><div style={{ fontSize: '48px', marginBottom: '16px' }}>üë∑</div><p style={{ color: theme.textSecondary }}>No staff found</p>{canCreate('staff') && <button onClick={openAddStaffModal} style={{ padding: '10px 20px', background: '#3b82f6', color: 'white', border: 'none', fontWeight: '600', cursor: 'pointer', marginTop: '12px' }}>Add Staff</button>}</div>
                    ) : (
                        <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                            <thead><tr style={{ background: theme.bgSecondary }}><th style={{ padding: '12px 16px', textAlign: 'left', fontWeight: '600', color: theme.text, borderBottom: `1px solid ${theme.border}` }}>Staff ID</th><th style={{ padding: '12px 16px', textAlign: 'left', fontWeight: '600', color: theme.text, borderBottom: `1px solid ${theme.border}` }}>Name</th><th style={{ padding: '12px 16px', textAlign: 'left', fontWeight: '600', color: theme.text, borderBottom: `1px solid ${theme.border}` }}>Role</th><th style={{ padding: '12px 16px', textAlign: 'left', fontWeight: '600', color: theme.text, borderBottom: `1px solid ${theme.border}` }}>Department</th><th style={{ padding: '12px 16px', textAlign: 'left', fontWeight: '600', color: theme.text, borderBottom: `1px solid ${theme.border}` }}>Phone</th><th style={{ padding: '12px 16px', textAlign: 'left', fontWeight: '600', color: theme.text, borderBottom: `1px solid ${theme.border}` }}>Status</th><th style={{ padding: '12px 16px', textAlign: 'center', fontWeight: '600', color: theme.text, borderBottom: `1px solid ${theme.border}` }}>Actions</th></tr></thead>
                            <tbody>
                                {filteredStaff.map(staff => (
                                    <tr key={staff.id} style={{ borderBottom: `1px solid ${theme.border}` }}>
                                        <td style={{ padding: '12px 16px', color: theme.text }}><span style={{ fontFamily: 'monospace', fontWeight: '600', padding: '4px 8px', background: '#3b82f620', color: '#3b82f6', borderRadius: '4px', fontSize: '13px' }}>{staff.staffId || '-'}</span></td>
                                        <td style={{ padding: '12px 16px', color: theme.text }}><div style={{ fontWeight: '600' }}>{staff.name}</div>{staff.email && <div style={{ fontSize: '12px', color: theme.textSecondary }}>{staff.email}</div>}</td>
                                        <td style={{ padding: '12px 16px', color: theme.text }}>{staff.role}</td>
                                        <td style={{ padding: '12px 16px', color: theme.textSecondary }}>{staff.department || '-'}</td>
                                        <td style={{ padding: '12px 16px', color: theme.textSecondary }}>{staff.phone || '-'}</td>
                                        <td style={{ padding: '12px 16px' }}><span style={{ padding: '4px 12px', fontSize: '12px', fontWeight: '600', background: staff.status === 'active' ? '#d1fae5' : '#fee2e2', color: staff.status === 'active' ? '#059669' : '#dc2626' }}>{staff.status === 'active' ? 'Active' : 'Inactive'}</span></td>
                                        <td style={{ padding: '12px 16px', textAlign: 'center' }}>
                                            {canEdit('staff') && <button onClick={() => openEditStaff(staff)} style={{ padding: '6px 12px', background: '#3b82f6', color: 'white', border: 'none', cursor: 'pointer', marginRight: '8px', fontSize: '12px' }}>Edit</button>}
                                            {canEdit('staff') && <button onClick={() => handleToggleStaffStatus(staff)} style={{ padding: '6px 12px', background: staff.status === 'active' ? '#f59e0b' : '#10b981', color: 'white', border: 'none', cursor: 'pointer', marginRight: '8px', fontSize: '12px' }}>{staff.status === 'active' ? 'Deactivate' : 'Activate'}</button>}
                                            {canDelete('staff') && <button onClick={() => handleDeleteStaff(staff)} style={{ padding: '6px 12px', background: '#dc2626', color: 'white', border: 'none', cursor: 'pointer', fontSize: '12px' }}>Delete</button>}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    )}
                </div>
            )}

            {activeTab === 'users' && (
                <div style={{ background: theme.bg, border: `1px solid ${theme.border}` }}>
                    {filteredUsers.length === 0 ? (
                        <div style={{ padding: '60px', textAlign: 'center' }}><div style={{ fontSize: '48px', marginBottom: '16px' }}>üîê</div><p style={{ color: theme.textSecondary }}>No users found</p>{canCreate('staff') && <button onClick={openAddUserModal} style={{ padding: '10px 20px', background: '#8b5cf6', color: 'white', border: 'none', fontWeight: '600', cursor: 'pointer', marginTop: '12px' }}>Add User</button>}</div>
                    ) : (
                        <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                            <thead><tr style={{ background: theme.bgSecondary }}><th style={{ padding: '12px 16px', textAlign: 'left', fontWeight: '600', color: theme.text, borderBottom: `1px solid ${theme.border}` }}>User ID</th><th style={{ padding: '12px 16px', textAlign: 'left', fontWeight: '600', color: theme.text, borderBottom: `1px solid ${theme.border}` }}>User</th><th style={{ padding: '12px 16px', textAlign: 'left', fontWeight: '600', color: theme.text, borderBottom: `1px solid ${theme.border}` }}>Role</th><th style={{ padding: '12px 16px', textAlign: 'left', fontWeight: '600', color: theme.text, borderBottom: `1px solid ${theme.border}` }}>Description</th><th style={{ padding: '12px 16px', textAlign: 'left', fontWeight: '600', color: theme.text, borderBottom: `1px solid ${theme.border}` }}>Status</th><th style={{ padding: '12px 16px', textAlign: 'center', fontWeight: '600', color: theme.text, borderBottom: `1px solid ${theme.border}` }}>Actions</th></tr></thead>
                            <tbody>
                                {filteredUsers.map(user => {
                                    const roleInfo = USER_ROLES.find(r => r.id === user.role) || { label: user.role, desc: '' };
                                    return (
                                        <tr key={user.id} style={{ borderBottom: `1px solid ${theme.border}` }}>
                                            <td style={{ padding: '12px 16px', color: theme.text }}><span style={{ fontFamily: 'monospace', fontWeight: '600', padding: '4px 8px', background: '#8b5cf620', color: '#8b5cf6', borderRadius: '4px', fontSize: '13px' }}>{user.userId || '-'}</span></td>
                                            <td style={{ padding: '12px 16px', color: theme.text }}><div style={{ fontWeight: '600' }}>{user.displayName || user.email?.split('@')[0]}</div><div style={{ fontSize: '12px', color: theme.textSecondary }}>{user.email}</div></td>
                                            <td style={{ padding: '12px 16px' }}><span style={{ padding: '4px 10px', background: user.role === 'admin' ? '#8b5cf620' : '#3b82f620', color: user.role === 'admin' ? '#8b5cf6' : '#3b82f6', fontWeight: '600', fontSize: '12px' }}>{roleInfo.label}</span></td>
                                            <td style={{ padding: '12px 16px', color: theme.textSecondary, fontSize: '13px' }}>{roleInfo.desc}</td>
                                            <td style={{ padding: '12px 16px' }}><span style={{ padding: '4px 12px', fontSize: '12px', fontWeight: '600', background: user.isActive ? '#d1fae5' : '#fee2e2', color: user.isActive ? '#059669' : '#dc2626' }}>{user.isActive ? 'Active' : 'Inactive'}</span></td>
                                            <td style={{ padding: '12px 16px', textAlign: 'center', display: 'flex', gap: '8px', justifyContent: 'center' }}>
                                                {canEdit('staff') && <button onClick={() => handleEditUser(user)} style={{ padding: '6px 12px', background: '#3b82f6', color: 'white', border: 'none', cursor: 'pointer', fontSize: '12px', borderRadius: '4px' }}>‚úèÔ∏è Edit</button>}
                                                {canEdit('staff') && <button onClick={() => handleUpdateUser(user.id, { isActive: !user.isActive })} style={{ padding: '6px 12px', background: user.isActive ? '#f59e0b' : '#10b981', color: 'white', border: 'none', cursor: 'pointer', fontSize: '12px', borderRadius: '4px' }}>{user.isActive ? '‚è∏Ô∏è Deactivate' : '‚úÖ Activate'}</button>}
                                                {canDelete('staff') && <button onClick={() => handleDeleteUserClick(user)} style={{ padding: '6px 12px', background: '#ef4444', color: 'white', border: 'none', cursor: 'pointer', fontSize: '12px', borderRadius: '4px' }}>üóëÔ∏è Delete</button>}
                                            </td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    )}
                </div>
            )}

            {activeTab === 'audit' && (
                <div>
                    {/* Active Sessions Panel */}
                    <div style={{ marginBottom: '20px', background: theme.bg, border: `1px solid ${theme.border}`, borderRadius: '10px', padding: '16px' }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '12px' }}>
                            <span style={{ fontSize: '20px' }}>üü¢</span>
                            <h3 style={{ margin: 0, color: theme.text, fontSize: '16px', fontWeight: '600' }}>Currently Active Users ({activeSessions.length})</h3>
                        </div>
                        {activeSessions.length === 0 ? (
                            <p style={{ color: theme.textSecondary, fontSize: '13px', margin: 0 }}>No users currently logged in</p>
                        ) : (
                            <div style={{ display: 'flex', flexWrap: 'wrap', gap: '12px' }}>
                                {activeSessions.filter(session => showSuperAdmin || !isSuperAdminEmail(session.email)).map(session => {
                                    const isActive = isUserOnline(session.odId);
                                    return (
                                        <div key={session.odId} style={{ 
                                            padding: '12px 16px', 
                                            background: isActive ? '#d1fae520' : '#fef3c720', 
                                            border: `1px solid ${isActive ? '#10b981' : '#f59e0b'}`,
                                            borderRadius: '10px',
                                            minWidth: '280px'
                                        }}>
                                            <div style={{ display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '8px' }}>
                                                <div style={{ 
                                                    width: '10px', 
                                                    height: '10px', 
                                                    borderRadius: '50%', 
                                                    background: isActive ? '#10b981' : '#f59e0b',
                                                    animation: isActive ? 'pulse 2s infinite' : 'none'
                                                }}></div>
                                                <div style={{ fontWeight: '600', color: theme.text, fontSize: '14px' }}>{session.displayName}</div>
                                            </div>
                                            <div style={{ fontSize: '12px', color: theme.textSecondary, marginBottom: '4px' }}>üìß {session.email}</div>
                                            <div style={{ fontSize: '11px', color: theme.textSecondary, marginBottom: '4px' }}>üïê Since {new Date(session.loginTime).toLocaleTimeString()}</div>
                                            <div style={{ fontSize: '11px', color: theme.textSecondary, display: 'flex', gap: '12px', flexWrap: 'wrap' }}>
                                                {session.browser && <span>üåê {session.browser}</span>}
                                                {session.operatingSystem && <span>üíª {session.operatingSystem}</span>}
                                                {session.deviceType && <span>üì± {session.deviceType}</span>}
                                            </div>
                                            {session.latitude && session.longitude && (
                                                <div style={{ fontSize: '11px', color: '#3b82f6', marginTop: '6px', display: 'flex', alignItems: 'center', gap: '4px' }}>
                                                    <span>üìç</span>
                                                    <a href={`https://www.google.com/maps?q=${session.latitude},${session.longitude}`} target="_blank" rel="noopener noreferrer" style={{ color: '#3b82f6', textDecoration: 'none' }}>
                                                        {session.latitude.toFixed(6)}, {session.longitude.toFixed(6)}
                                                    </a>
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </div>
                    <style>{`@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }`}</style>

                    <div style={{ display: 'flex', gap: '12px', marginBottom: '16px', flexWrap: 'wrap', alignItems: 'center' }}>
                        <input type="text" placeholder={'Search logs...'} value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} style={{ ...inputStyle, maxWidth: '250px', borderRadius: '8px' }} />
                        <select value={auditFilter.action} onChange={(e) => setAuditFilter(prev => ({ ...prev, action: e.target.value }))} style={{ ...inputStyle, maxWidth: '150px', borderRadius: '8px' }}>
                            <option value="">All Actions</option>
                            <option value="login">Login</option>
                            <option value="logout">Logout</option>
                            <option value="create">Create</option>
                            <option value="update">Update</option>
                            <option value="delete">Delete</option>
                            <option value="view">View</option>
                        </select>
                        <select value={auditFilter.module} onChange={(e) => setAuditFilter(prev => ({ ...prev, module: e.target.value }))} style={{ ...inputStyle, maxWidth: '180px', borderRadius: '8px' }}>
                            <option value="">All Modules</option>
                            <option value="auth">Authentication</option>
                            <option value="vehicle-intake">Vehicle Intake</option>
                            <option value="wash-bays">Wash Bays</option>
                            <option value="garage">Garage</option>
                            <option value="staff">Staff</option>
                            <option value="users">Users</option>
                            <option value="customers">Customers</option>
                            <option value="billing">Billing</option>
                            <option value="inventory">Inventory</option>
                            <option value="expenses">Expenses</option>
                            <option value="settings">Settings</option>
                        </select>
                        <div style={{ flex: 1 }}></div>
                        <div style={{ color: theme.textSecondary, fontSize: '13px' }}>
                            <span style={{ marginRight: '16px' }}>üü¢ {activeSessions.length} online</span>
                            Showing {filteredAuditLogs.length} of {auditLogs.length} logs
                        </div>
                    </div>

                    <div style={{ background: theme.bg, border: `1px solid ${theme.border}`, borderRadius: '10px', overflow: 'hidden' }}>
                        {filteredAuditLogs.length === 0 ? (
                            <div style={{ padding: '60px', textAlign: 'center' }}>
                                <div style={{ fontSize: '48px', marginBottom: '16px' }}>üìã</div>
                                <p style={{ color: theme.textSecondary }}>No audit logs found</p>
                                <p style={{ color: theme.textSecondary, fontSize: '13px' }}>System activity will appear here once users start interacting</p>
                            </div>
                        ) : (
                            <div style={{ maxHeight: '600px', overflow: 'auto' }}>
                                {filteredAuditLogs.map((log, idx) => {
                                    const userOnline = isUserOnline(log.userId);
                                    return (
                                    <div key={log.id || idx} style={{ padding: '16px 20px', borderBottom: `1px solid ${theme.border}`, background: idx % 2 === 0 ? 'transparent' : theme.bgSecondary }}>
                                        <div style={{ display: 'flex', gap: '16px', alignItems: 'flex-start' }}>
                                            <div style={{ position: 'relative' }}>
                                                <div style={{ width: '44px', height: '44px', borderRadius: '50%', background: `${getActionColor(log.action)}20`, display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '20px', flexShrink: 0 }}>
                                                    {getActionIcon(log.action)}
                                                </div>
                                                <div style={{ 
                                                    position: 'absolute', 
                                                    bottom: '0', 
                                                    right: '0', 
                                                    width: '14px', 
                                                    height: '14px', 
                                                    borderRadius: '50%', 
                                                    background: userOnline ? '#10b981' : '#6b7280',
                                                    border: `2px solid ${theme.bg}`
                                                }} title={userOnline ? 'Currently online' : 'Offline'}></div>
                                            </div>
                                            <div style={{ flex: 1, minWidth: 0 }}>
                                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', gap: '12px', flexWrap: 'wrap' }}>
                                                    <div>
                                                        <span style={{ fontWeight: '600', color: theme.text }}>{log.userName || 'Unknown'}</span>
                                                        {userOnline && <span style={{ marginLeft: '6px', fontSize: '10px', padding: '2px 6px', background: '#d1fae5', color: '#059669', borderRadius: '4px', fontWeight: '600' }}>ONLINE</span>}
                                                        <span style={{ color: theme.textSecondary }}> performed </span>
                                                        <span style={{ padding: '3px 10px', borderRadius: '6px', fontSize: '11px', fontWeight: '700', background: `${getActionColor(log.action)}20`, color: getActionColor(log.action), textTransform: 'uppercase' }}>{log.action}</span>
                                                        <span style={{ color: theme.textSecondary }}> on </span>
                                                        <span style={{ fontWeight: '500', color: theme.text }}>{log.module}</span>
                                                        {log.targetName && <span style={{ color: theme.textSecondary }}> ‚Üí <strong style={{ color: theme.text }}>{log.targetName}</strong></span>}
                                                    </div>
                                                    <div style={{ fontSize: '12px', color: theme.textSecondary, whiteSpace: 'nowrap' }}>{formatTimeAgo(log.timestamp)}</div>
                                                </div>
                                                
                                                {log.details && <div style={{ marginTop: '8px', fontSize: '13px', color: theme.textSecondary, padding: '8px 12px', background: theme.bgSecondary, borderRadius: '6px', borderLeft: `3px solid ${getActionColor(log.action)}` }}>{log.details}</div>}
                                                
                                                {/* Show changes for edit/update operations */}
                                                {log.changes && Object.keys(log.changes).length > 0 && (
                                                    <div style={{ marginTop: '8px', padding: '10px 12px', background: '#fef3c710', border: '1px solid #fbbf2440', borderRadius: '6px' }}>
                                                        <div style={{ fontSize: '11px', fontWeight: '600', color: '#92400e', marginBottom: '6px', textTransform: 'uppercase' }}>Changes Made:</div>
                                                        {Object.entries(log.changes).map(([field, change]) => (
                                                            <div key={field} style={{ fontSize: '12px', color: theme.text, marginBottom: '4px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                                                                <span style={{ fontWeight: '500', color: theme.textSecondary }}>{field}:</span>
                                                                <span style={{ color: '#ef4444', textDecoration: 'line-through' }}>{change.old || '(empty)'}</span>
                                                                <span style={{ color: theme.textSecondary }}>‚Üí</span>
                                                                <span style={{ color: '#10b981', fontWeight: '500' }}>{change.new || '(empty)'}</span>
                                                            </div>
                                                        ))}
                                                    </div>
                                                )}
                                                
                                                {/* Show deleted item info */}
                                                {log.action === 'delete' && log.previousValue && (
                                                    <div style={{ marginTop: '8px', padding: '10px 12px', background: '#fef2f210', border: '1px solid #ef444440', borderRadius: '6px' }}>
                                                        <div style={{ fontSize: '11px', fontWeight: '600', color: '#dc2626', marginBottom: '6px', textTransform: 'uppercase' }}>Deleted Item Data:</div>
                                                        <div style={{ fontSize: '12px', color: theme.textSecondary, fontFamily: 'monospace', whiteSpace: 'pre-wrap', maxHeight: '100px', overflow: 'auto' }}>
                                                            {typeof log.previousValue === 'string' ? log.previousValue : JSON.stringify(log.previousValue, null, 2)}
                                                        </div>
                                                    </div>
                                                )}
                                                
                                                {/* Metadata row */}
                                                <div style={{ marginTop: '10px', fontSize: '11px', color: theme.textSecondary, display: 'flex', alignItems: 'center', gap: '12px', flexWrap: 'wrap' }}>
                                                    <span>üìß {log.userEmail}</span>
                                                    <span>üïê {new Date(log.timestamp).toLocaleString()}</span>
                                                    {log.browser && <span>üåê {log.browser}</span>}
                                                    {log.operatingSystem && <span>üíª {log.operatingSystem}</span>}
                                                    {log.deviceType && <span>üì± {log.deviceType}</span>}
                                                </div>
                                                
                                                {/* Geolocation */}
                                                {log.latitude && log.longitude && (
                                                    <div style={{ marginTop: '6px', fontSize: '11px', display: 'flex', alignItems: 'center', gap: '6px' }}>
                                                        <span style={{ color: '#3b82f6' }}>üìç</span>
                                                        <a href={`https://www.google.com/maps?q=${log.latitude},${log.longitude}`} target="_blank" rel="noopener noreferrer" style={{ color: '#3b82f6', textDecoration: 'none', fontSize: '11px' }}>
                                                            View Location ({log.latitude.toFixed(4)}, {log.longitude.toFixed(4)})
                                                        </a>
                                                        {log.locationAccuracy && <span style={{ color: theme.textSecondary }}>(¬±{Math.round(log.locationAccuracy)}m)</span>}
                                                    </div>
                                                )}
                                                
                                                {/* Session status for login actions */}
                                                {log.action === 'login' && (
                                                    <div style={{ marginTop: '6px' }}>
                                                        {userOnline ? (
                                                            <span style={{ fontSize: '11px', color: '#10b981', fontWeight: '500' }}>‚úì Currently active in system</span>
                                                        ) : (
                                                            <span style={{ fontSize: '11px', color: '#f59e0b' }}>‚óã Session ended</span>
                                                        )}
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                )})}
                            </div>
                        )}
                    </div>
                </div>
            )}

            {activeTab === 'factory-reset' && isSuperAdmin && isSuperAdminEmail(userProfile?.email) && <FactoryResetTab theme={theme} />}

            {showAddStaffModal && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 }} onClick={() => setShowAddStaffModal(false)}>
                    <div style={{ background: theme.bg, width: '100%', maxWidth: '500px', maxHeight: '90vh', overflow: 'auto', margin: '20px', boxShadow: '0 25px 50px -12px rgba(0,0,0,0.25)' }} onClick={e => e.stopPropagation()}>
                        <div style={{ padding: '20px', borderBottom: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'space-between' }}><h2 style={{ margin: 0, color: theme.text }}>Add Staff Member</h2><button onClick={() => setShowAddStaffModal(false)} style={{ background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer', color: theme.textSecondary }}>√ó</button></div>
                        <form onSubmit={handleAddStaff} style={{ padding: '20px' }}>
                            <div style={{ display: 'grid', gap: '16px' }}>
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 2fr', gap: '12px' }}>
                                    <div><label style={labelStyle}>Staff ID</label><input type="text" value={staffForm.staffId} readOnly style={{...inputStyle, background: '#3b82f620', color: '#3b82f6', fontWeight: '600', fontFamily: 'monospace', cursor: 'not-allowed'}} /></div>
                                    <div><label style={labelStyle}>Name *</label><input type="text" value={staffForm.name} onChange={e => setStaffForm({...staffForm, name: e.target.value})} style={inputStyle} required /></div>
                                </div>
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' }}><div><label style={labelStyle}>Role</label><select value={staffForm.role} onChange={e => setStaffForm({...staffForm, role: e.target.value})} style={inputStyle}>{STAFF_ROLES.map(r => <option key={r} value={r}>{r}</option>)}</select></div><div><label style={labelStyle}>Department</label><select value={staffForm.department} onChange={e => setStaffForm({...staffForm, department: e.target.value})} style={inputStyle}>{DEPARTMENTS.map(d => <option key={d} value={d}>{d}</option>)}</select></div></div>
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' }}><div><label style={labelStyle}>Phone</label><input type="tel" value={staffForm.phone} onChange={e => setStaffForm({...staffForm, phone: e.target.value})} style={inputStyle} /></div><div><label style={labelStyle}>Email</label><input type="email" value={staffForm.email} onChange={e => setStaffForm({...staffForm, email: e.target.value})} style={inputStyle} /></div></div>
                            </div>
                            <div style={{ display: 'flex', gap: '12px', marginTop: '24px' }}><button type="button" onClick={() => setShowAddStaffModal(false)} style={{ flex: 1, padding: '12px', border: `1px solid ${theme.border}`, background: 'transparent', color: theme.text, cursor: 'pointer' }}>Cancel</button><button type="submit" disabled={actionLoading} style={{ flex: 1, padding: '12px', border: 'none', background: '#3b82f6', color: 'white', fontWeight: '600', cursor: actionLoading ? 'wait' : 'pointer' }}>{actionLoading ? 'Adding...' : 'Add Staff'}</button></div>
                        </form>
                    </div>
                </div>
            )}

            {showAddUserModal && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.6)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 }} onClick={() => { setShowAddUserModal(false); setUserStep(1); }}>
                    <div style={{ background: theme.bg, width: '100%', maxWidth: '800px', maxHeight: '90vh', overflow: 'auto', margin: '20px', boxShadow: '0 25px 50px -12px rgba(0,0,0,0.25)' }} onClick={e => e.stopPropagation()}>
                        <div style={{ padding: '20px 24px', borderBottom: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <div>
                                <h2 style={{ margin: 0, color: theme.text, fontSize: '20px' }}>Add System User</h2>
                                <p style={{ margin: '4px 0 0', color: theme.textSecondary, fontSize: '13px' }}>Step {userStep} of 2: {userStep === 1 ? 'User Details' : 'Module Permissions'}</p>
                            </div>
                            <button onClick={() => { setShowAddUserModal(false); setUserStep(1); }} style={{ background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer', color: theme.textSecondary }}>√ó</button>
                        </div>

                        <div style={{ display: 'flex', padding: '0 24px', borderBottom: `1px solid ${theme.border}` }}>
                            <button onClick={() => setUserStep(1)} style={{ padding: '16px 24px', border: 'none', background: 'transparent', color: userStep === 1 ? '#8b5cf6' : theme.textSecondary, fontWeight: '600', cursor: 'pointer', borderBottom: userStep === 1 ? '2px solid #8b5cf6' : '2px solid transparent', marginBottom: '-1px' }}>1. User Details</button>
                            <button onClick={() => userStep === 1 && userForm.email && userForm.password ? setUserStep(2) : null} style={{ padding: '16px 24px', border: 'none', background: 'transparent', color: userStep === 2 ? '#8b5cf6' : theme.textSecondary, fontWeight: '600', cursor: userForm.email && userForm.password ? 'pointer' : 'not-allowed', borderBottom: userStep === 2 ? '2px solid #8b5cf6' : '2px solid transparent', marginBottom: '-1px', opacity: userForm.email && userForm.password ? 1 : 0.5 }}>2. Permissions</button>
                        </div>

                        {userStep === 1 && (
                            <div style={{ padding: '24px' }}>
                                <div style={{ background: '#fef3c7', border: '1px solid #fbbf24', padding: '12px 16px', marginBottom: '24px', fontSize: '13px', color: '#92400e', display: 'flex', alignItems: 'center', gap: '10px' }}>
                                    <span style={{ fontSize: '18px' }}>üí°</span>
                                    <span><strong>Note:</strong> System users can log into the application with assigned role-based permissions.</span>
                                </div>
                                <div style={{ display: 'grid', gap: '20px' }}>
                                    <div style={{ display: 'grid', gridTemplateColumns: '120px 1fr 1fr', gap: '16px' }}>
                                        <div><label style={labelStyle}>User ID</label><input type="text" value={userForm.userId} readOnly style={{...inputStyle, background: '#8b5cf620', color: '#8b5cf6', fontWeight: '600', fontFamily: 'monospace', cursor: 'not-allowed'}} /></div>
                                        <div><label style={labelStyle}>Email Address *</label><input type="email" value={userForm.email} onChange={e => setUserForm({...userForm, email: e.target.value})} style={inputStyle} placeholder="user@example.com" required /></div>
                                        <div><label style={labelStyle}>Password *</label><input type="password" value={userForm.password} onChange={e => setUserForm({...userForm, password: e.target.value})} style={inputStyle} placeholder="Min 6 characters" required /></div>
                                    </div>
                                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px' }}>
                                        <div><label style={labelStyle}>Display Name</label><input type="text" value={userForm.displayName} onChange={e => setUserForm({...userForm, displayName: e.target.value})} style={inputStyle} placeholder="Full name" /></div>
                                        <div><label style={labelStyle}>Phone Number</label><input type="tel" value={userForm.phone} onChange={e => setUserForm({...userForm, phone: e.target.value})} style={inputStyle} placeholder="+1234567890" /></div>
                                    </div>
                                    <div>
                                        <label style={labelStyle}>Role Preset</label>
                                        <p style={{ margin: '0 0 12px', color: theme.textSecondary, fontSize: '12px' }}>Select a role to apply default permissions (can be customized in next step)</p>
                                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '10px' }}>
                                            {USER_ROLES.map(r => (
                                                <button key={r.id} type="button" onClick={() => applyRolePreset(r.id)} style={{ padding: '12px', border: `2px solid ${userForm.role === r.id ? '#8b5cf6' : theme.border}`, background: userForm.role === r.id ? '#f3e8ff' : 'transparent', cursor: 'pointer', textAlign: 'left' }}>
                                                    <div style={{ fontWeight: '600', color: userForm.role === r.id ? '#8b5cf6' : theme.text, fontSize: '14px' }}>{r.label}</div>
                                                    <div style={{ fontSize: '11px', color: theme.textSecondary, marginTop: '2px' }}>{r.desc}</div>
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                                <div style={{ display: 'flex', gap: '12px', marginTop: '24px' }}>
                                    <button type="button" onClick={() => { setShowAddUserModal(false); setUserStep(1); }} style={{ flex: 1, padding: '14px', border: `1px solid ${theme.border}`, background: 'transparent', color: theme.text, cursor: 'pointer', fontWeight: '500' }}>Cancel</button>
                                    <button type="button" onClick={() => { if (userForm.email && userForm.password && userForm.password.length >= 6) { if (Object.keys(userForm.permissions).length === 0) applyRolePreset(userForm.role); setUserStep(2); } else { setError('Email and password (min 6 chars) required'); } }} style={{ flex: 1, padding: '14px', border: 'none', background: '#8b5cf6', color: 'white', fontWeight: '600', cursor: 'pointer' }}>Next: Set Permissions ‚Üí</button>
                                </div>
                            </div>
                        )}

                        {userStep === 2 && (
                            <div style={{ padding: '24px' }}>
                                <div style={{ marginBottom: '20px', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                    <div>
                                        <h3 style={{ margin: 0, color: theme.text, fontSize: '16px' }}>Module Permissions for {userForm.displayName || userForm.email}</h3>
                                        <p style={{ margin: '4px 0 0', color: theme.textSecondary, fontSize: '13px' }}>Configure which modules this user can access and what actions they can perform</p>
                                    </div>
                                    <div style={{ display: 'flex', gap: '8px' }}>
                                        <button type="button" onClick={() => { const perms = {}; ALL_MODULES.forEach(m => perms[m.id] = { view: true, create: true, edit: true, delete: true, 'change-status': true }); setUserForm(prev => ({ ...prev, permissions: perms })); }} style={{ padding: '8px 12px', fontSize: '12px', border: `1px solid ${theme.border}`, background: 'transparent', color: theme.text, cursor: 'pointer' }}>Select All</button>
                                        <button type="button" onClick={() => { const perms = {}; ALL_MODULES.forEach(m => perms[m.id] = { view: false, create: false, edit: false, delete: false, 'change-status': false }); setUserForm(prev => ({ ...prev, permissions: perms })); }} style={{ padding: '8px 12px', fontSize: '12px', border: `1px solid ${theme.border}`, background: 'transparent', color: theme.text, cursor: 'pointer' }}>Clear All</button>
                                    </div>
                                </div>

                                <div style={{ maxHeight: '400px', overflow: 'auto', border: `1px solid ${theme.border}` }}>
                                    <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                                        <thead style={{ position: 'sticky', top: 0, background: theme.bgSecondary, zIndex: 1 }}>
                                            <tr>
                                                <th style={{ padding: '12px 16px', textAlign: 'left', fontWeight: '600', color: theme.text, borderBottom: `1px solid ${theme.border}`, width: '35%' }}>Module</th>
                                                {PERMISSION_ACTIONS.map(a => <th key={a.id} style={{ padding: '12px 8px', textAlign: 'center', fontWeight: '600', color: theme.text, borderBottom: `1px solid ${theme.border}`, width: '13%' }}><span title={a.label}>{a.icon} {a.label}</span></th>)}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {ALL_MODULES.map((mod, idx) => {
                                                const perms = userForm.permissions[mod.id] || {};
                                                const allChecked = perms.view && perms.create && perms.edit && perms.delete && perms['change-status'];
                                                return (
                                                    <tr key={mod.id} style={{ background: idx % 2 === 0 ? 'transparent' : theme.bgSecondary }}>
                                                        <td style={{ padding: '10px 16px', borderBottom: `1px solid ${theme.border}` }}>
                                                            <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                                                                <span style={{ fontSize: '18px' }}>{mod.icon}</span>
                                                                <div>
                                                                    <div style={{ fontWeight: '500', color: theme.text, fontSize: '13px' }}>{mod.label}</div>
                                                                    <div style={{ fontSize: '11px', color: theme.textSecondary }}>{mod.category}</div>
                                                                </div>
                                                            </div>
                                                        </td>
                                                        {PERMISSION_ACTIONS.map(a => (
                                                            <td key={a.id} style={{ padding: '10px 8px', textAlign: 'center', borderBottom: `1px solid ${theme.border}` }}>
                                                                <input type="checkbox" checked={perms[a.id] || false} onChange={() => toggleModulePermission(mod.id, a.id)} style={{ width: '18px', height: '18px', cursor: 'pointer', accentColor: '#8b5cf6' }} />
                                                            </td>
                                                        ))}
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>

                                <div style={{ display: 'flex', gap: '12px', marginTop: '24px' }}>
                                    <button type="button" onClick={() => setUserStep(1)} style={{ padding: '14px 24px', border: `1px solid ${theme.border}`, background: 'transparent', color: theme.text, cursor: 'pointer', fontWeight: '500' }}>‚Üê Back</button>
                                    <div style={{ flex: 1 }}></div>
                                    <button type="button" onClick={() => { setShowAddUserModal(false); setUserStep(1); }} style={{ padding: '14px 24px', border: `1px solid ${theme.border}`, background: 'transparent', color: theme.text, cursor: 'pointer', fontWeight: '500' }}>Cancel</button>
                                    <button type="button" onClick={handleAddUser} disabled={actionLoading} style={{ padding: '14px 32px', border: 'none', background: '#8b5cf6', color: 'white', fontWeight: '600', cursor: actionLoading ? 'wait' : 'pointer' }}>{actionLoading ? 'Creating User...' : '‚úì Create User'}</button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            )}

            {/* Edit User Modal */}
            {showEditUserModal && selectedUser && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.6)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 }} onClick={() => setShowEditUserModal(false)}>
                    <div style={{ background: theme.bg, width: '100%', maxWidth: '900px', maxHeight: '90vh', overflow: 'auto', margin: '20px', boxShadow: '0 25px 50px -12px rgba(0,0,0,0.25)' }} onClick={e => e.stopPropagation()}>
                        <div style={{ padding: '20px 24px', borderBottom: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <div>
                                <h2 style={{ margin: 0, color: theme.text, fontSize: '20px' }}>Edit User: {selectedUser.displayName || selectedUser.email}</h2>
                                <p style={{ margin: '4px 0 0', color: theme.textSecondary, fontSize: '13px' }}>Manage user details and module permissions</p>
                            </div>
                            <button onClick={() => setShowEditUserModal(false)} style={{ background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer', color: theme.textSecondary }}>√ó</button>
                        </div>

                        <div style={{ padding: '24px' }}>
                            {/* User Details Section */}
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '16px', marginBottom: '24px' }}>
                                <div>
                                    <label style={labelStyle}>Display Name</label>
                                    <input type="text" value={editUserForm.displayName} onChange={e => setEditUserForm({...editUserForm, displayName: e.target.value})} style={{...inputStyle, borderRadius: '8px'}} placeholder="Full name" />
                                </div>
                                <div>
                                    <label style={labelStyle}>Phone Number</label>
                                    <input type="tel" value={editUserForm.phone} onChange={e => setEditUserForm({...editUserForm, phone: e.target.value})} style={{...inputStyle, borderRadius: '8px'}} placeholder="+1234567890" />
                                </div>
                                <div>
                                    <label style={labelStyle}>Role Preset</label>
                                    <select value={editUserForm.role} onChange={e => applyEditRolePreset(e.target.value)} style={{...inputStyle, borderRadius: '8px'}}>
                                        {USER_ROLES.map(r => <option key={r.id} value={r.id}>{r.label} - {r.desc}</option>)}
                                    </select>
                                </div>
                            </div>

                            {/* Permissions Section */}
                            <div style={{ marginBottom: '20px', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                <div>
                                    <h3 style={{ margin: 0, color: theme.text, fontSize: '16px' }}>Module Permissions</h3>
                                    <p style={{ margin: '4px 0 0', color: theme.textSecondary, fontSize: '13px' }}>Configure which modules this user can access</p>
                                </div>
                                <div style={{ display: 'flex', gap: '8px' }}>
                                    <button type="button" onClick={() => { const perms = {}; ALL_MODULES.forEach(m => perms[m.id] = { view: true, create: true, edit: true, delete: true, 'change-status': true }); setEditUserForm(prev => ({ ...prev, permissions: perms })); }} style={{ padding: '8px 12px', fontSize: '12px', border: `1px solid ${theme.border}`, background: 'transparent', color: theme.text, cursor: 'pointer', borderRadius: '6px' }}>Select All</button>
                                    <button type="button" onClick={() => { const perms = {}; ALL_MODULES.forEach(m => perms[m.id] = { view: false, create: false, edit: false, delete: false, 'change-status': false }); setEditUserForm(prev => ({ ...prev, permissions: perms })); }} style={{ padding: '8px 12px', fontSize: '12px', border: `1px solid ${theme.border}`, background: 'transparent', color: theme.text, cursor: 'pointer', borderRadius: '6px' }}>Clear All</button>
                                </div>
                            </div>

                            <div style={{ maxHeight: '350px', overflow: 'auto', border: `1px solid ${theme.border}`, borderRadius: '10px' }}>
                                <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                                    <thead style={{ position: 'sticky', top: 0, background: theme.bgSecondary, zIndex: 1 }}>
                                        <tr>
                                            <th style={{ padding: '12px 16px', textAlign: 'left', fontWeight: '600', color: theme.text, borderBottom: `1px solid ${theme.border}`, width: '30%' }}>Module</th>
                                            <th style={{ padding: '12px 8px', textAlign: 'center', fontWeight: '600', color: theme.text, borderBottom: `1px solid ${theme.border}`, width: '10%' }}>All</th>
                                            {PERMISSION_ACTIONS.map(a => <th key={a.id} style={{ padding: '12px 8px', textAlign: 'center', fontWeight: '600', color: theme.text, borderBottom: `1px solid ${theme.border}`, width: '10%' }}><span title={a.label}>{a.icon} {a.label}</span></th>)}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {ALL_MODULES.map((mod, idx) => {
                                            const perms = editUserForm.permissions[mod.id] || {};
                                            const allChecked = perms.view && perms.create && perms.edit && perms.delete && perms['change-status'];
                                            const noneChecked = !perms.view && !perms.create && !perms.edit && !perms.delete && !perms['change-status'];
                                            return (
                                                <tr key={mod.id} style={{ background: idx % 2 === 0 ? 'transparent' : theme.bgSecondary }}>
                                                    <td style={{ padding: '10px 16px', borderBottom: `1px solid ${theme.border}` }}>
                                                        <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                                                            <span style={{ fontSize: '18px' }}>{mod.icon}</span>
                                                            <div>
                                                                <div style={{ fontWeight: '500', color: theme.text, fontSize: '13px' }}>{mod.label}</div>
                                                                <div style={{ fontSize: '11px', color: theme.textSecondary }}>{mod.category}</div>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td style={{ padding: '10px 8px', textAlign: 'center', borderBottom: `1px solid ${theme.border}` }}>
                                                        <input type="checkbox" checked={allChecked} onChange={() => toggleEditUserAllModulePermissions(mod.id, !allChecked)} style={{ width: '18px', height: '18px', cursor: 'pointer', accentColor: '#10b981' }} />
                                                    </td>
                                                    {PERMISSION_ACTIONS.map(a => (
                                                        <td key={a.id} style={{ padding: '10px 8px', textAlign: 'center', borderBottom: `1px solid ${theme.border}` }}>
                                                            <input type="checkbox" checked={perms[a.id] || false} onChange={() => toggleEditUserPermission(mod.id, a.id)} style={{ width: '18px', height: '18px', cursor: 'pointer', accentColor: '#8b5cf6' }} />
                                                        </td>
                                                    ))}
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>

                            <div style={{ display: 'flex', gap: '12px', marginTop: '24px' }}>
                                <button type="button" onClick={() => setShowEditUserModal(false)} style={{ flex: 1, padding: '14px', border: `1px solid ${theme.border}`, background: 'transparent', color: theme.text, cursor: 'pointer', borderRadius: '8px', fontWeight: '500' }}>Cancel</button>
                                <button type="button" onClick={handleSaveEditUser} disabled={actionLoading} style={{ flex: 1, padding: '14px', border: 'none', background: '#8b5cf6', color: 'white', fontWeight: '600', cursor: actionLoading ? 'wait' : 'pointer', borderRadius: '8px' }}>{actionLoading ? 'Saving...' : '‚úì Save Changes'}</button>
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* Delete User Confirmation Modal */}
            {showDeleteUserModal && userToDelete && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.6)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1100, backdropFilter: 'blur(4px)' }} onClick={() => { setShowDeleteUserModal(false); setUserToDelete(null); }}>
                    <div style={{ background: theme.bg, width: '100%', maxWidth: '420px', margin: '20px', borderRadius: '16px', boxShadow: '0 25px 50px -12px rgba(0,0,0,0.4)', overflow: 'hidden' }} onClick={e => e.stopPropagation()}>
                        <div style={{ padding: '24px', textAlign: 'center' }}>
                            <div style={{ width: '64px', height: '64px', borderRadius: '50%', background: '#fef2f2', display: 'flex', alignItems: 'center', justifyContent: 'center', margin: '0 auto 20px', fontSize: '32px' }}>üóëÔ∏è</div>
                            <h3 style={{ margin: '0 0 12px', fontSize: '20px', fontWeight: '700', color: theme.text }}>Delete User</h3>
                            <p style={{ margin: '0 0 8px', fontSize: '15px', color: theme.textSecondary, lineHeight: '1.6' }}>Are you sure you want to permanently delete</p>
                            <p style={{ margin: '0 0 8px', fontSize: '16px', fontWeight: '600', color: theme.text }}>"{userToDelete.displayName || userToDelete.email}"?</p>
                            <p style={{ margin: '0 0 24px', fontSize: '13px', color: '#ef4444', fontWeight: '500' }}>‚ö†Ô∏è This action cannot be undone.</p>
                            <div style={{ display: 'flex', gap: '12px' }}>
                                <button onClick={() => { setShowDeleteUserModal(false); setUserToDelete(null); }} style={{ flex: 1, padding: '12px 20px', background: 'transparent', color: theme.text, border: `1px solid ${theme.border}`, borderRadius: '8px', fontSize: '14px', fontWeight: '600', cursor: 'pointer' }}>Cancel</button>
                                <button onClick={handleConfirmDeleteUser} disabled={actionLoading} style={{ flex: 1, padding: '12px 20px', background: '#ef4444', color: 'white', border: 'none', borderRadius: '8px', fontSize: '14px', fontWeight: '600', cursor: actionLoading ? 'wait' : 'pointer' }}>{actionLoading ? 'Deleting...' : 'Delete User'}</button>
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {showEditModal && selectedItem && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 }} onClick={() => setShowEditModal(false)}>
                    <div style={{ background: theme.bg, width: '100%', maxWidth: '500px', maxHeight: '90vh', overflow: 'auto', margin: '20px', boxShadow: '0 25px 50px -12px rgba(0,0,0,0.25)' }} onClick={e => e.stopPropagation()}>
                        <div style={{ padding: '20px', borderBottom: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'space-between' }}><h2 style={{ margin: 0, color: theme.text }}>Edit Staff</h2><button onClick={() => setShowEditModal(false)} style={{ background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer', color: theme.textSecondary }}>√ó</button></div>
                        <form onSubmit={handleUpdateStaff} style={{ padding: '20px' }}>
                            <div style={{ display: 'grid', gap: '16px' }}>
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 2fr', gap: '12px' }}>
                                    <div><label style={labelStyle}>Staff ID</label><input type="text" value={staffForm.staffId || selectedItem.staffId || '-'} readOnly style={{...inputStyle, background: '#3b82f620', color: '#3b82f6', fontWeight: '600', fontFamily: 'monospace', cursor: 'not-allowed'}} /></div>
                                    <div><label style={labelStyle}>Name *</label><input type="text" value={staffForm.name} onChange={e => setStaffForm({...staffForm, name: e.target.value})} style={inputStyle} required /></div>
                                </div>
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' }}><div><label style={labelStyle}>Role</label><select value={staffForm.role} onChange={e => setStaffForm({...staffForm, role: e.target.value})} style={inputStyle}>{STAFF_ROLES.map(r => <option key={r} value={r}>{r}</option>)}</select></div><div><label style={labelStyle}>Department</label><select value={staffForm.department} onChange={e => setStaffForm({...staffForm, department: e.target.value})} style={inputStyle}>{DEPARTMENTS.map(d => <option key={d} value={d}>{d}</option>)}</select></div></div>
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' }}><div><label style={labelStyle}>Phone</label><input type="tel" value={staffForm.phone} onChange={e => setStaffForm({...staffForm, phone: e.target.value})} style={inputStyle} /></div><div><label style={labelStyle}>Email</label><input type="email" value={staffForm.email} onChange={e => setStaffForm({...staffForm, email: e.target.value})} style={inputStyle} /></div></div>
                            </div>
                            <div style={{ display: 'flex', gap: '12px', marginTop: '24px' }}><button type="button" onClick={() => setShowEditModal(false)} style={{ flex: 1, padding: '12px', border: `1px solid ${theme.border}`, background: 'transparent', color: theme.text, cursor: 'pointer' }}>Cancel</button><button type="submit" disabled={actionLoading} style={{ flex: 1, padding: '12px', border: 'none', background: '#3b82f6', color: 'white', fontWeight: '600', cursor: actionLoading ? 'wait' : 'pointer' }}>{actionLoading ? 'Saving...' : 'Save'}</button></div>
                        </form>
                    </div>
                </div>
            )}

            {showConfirmModal && confirmAction && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.6)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1100 }} onClick={() => { setShowConfirmModal(false); setConfirmAction(null); }}>
                    <div style={{ background: theme.bg, width: '100%', maxWidth: '400px', margin: '20px', boxShadow: '0 25px 50px -12px rgba(0,0,0,0.25)', overflow: 'hidden' }} onClick={e => e.stopPropagation()}>
                        <div style={{ padding: '24px 24px 0' }}>
                            <div style={{ width: '56px', height: '56px', borderRadius: '50%', background: confirmAction.type === 'delete' ? '#fef2f2' : '#fef3c7', display: 'flex', alignItems: 'center', justifyContent: 'center', margin: '0 auto 16px', fontSize: '24px' }}>{confirmAction.type === 'delete' ? 'üóëÔ∏è' : '‚ö†Ô∏è'}</div>
                            <h3 style={{ margin: '0 0 8px', textAlign: 'center', color: theme.text, fontSize: '18px', fontWeight: '600' }}>{confirmAction.title}</h3>
                            <p style={{ margin: 0, textAlign: 'center', color: theme.textSecondary, fontSize: '14px', lineHeight: '1.5' }}>{confirmAction.message}</p>
                        </div>
                        <div style={{ display: 'flex', gap: '12px', padding: '24px' }}>
                            <button onClick={() => { setShowConfirmModal(false); setConfirmAction(null); }} style={{ flex: 1, padding: '12px 16px', border: `1px solid ${theme.border}`, background: 'transparent', color: theme.text, cursor: 'pointer', borderRadius: '8px', fontWeight: '500', fontSize: '14px' }}>Cancel</button>
                            <button onClick={executeConfirmAction} disabled={actionLoading} style={{ flex: 1, padding: '12px 16px', border: 'none', background: confirmAction.confirmColor, color: 'white', fontWeight: '600', cursor: actionLoading ? 'wait' : 'pointer', borderRadius: '8px', fontSize: '14px' }}>{actionLoading ? 'Processing...' : confirmAction.confirmText}</button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}

// ==================== INVENTORY MODULE ====================
function InventoryModule() {
    const { canCreate, canEdit, canDelete } = usePermissions();
    const [items, setItems] = useState([]);
    const [loading, setLoading] = useState(true);
    const [search, setSearch] = useState('');
    const [filter, setFilter] = useState('all');
    const [showModal, setShowModal] = useState(false);
    const [editItem, setEditItem] = useState(null);
    const [viewItem, setViewItem] = useState(null);
    const [deleteConfirm, setDeleteConfirm] = useState(null);
    const [usageModal, setUsageModal] = useState(null);
    const [usageAmount, setUsageAmount] = useState('');
    const [usageNotes, setUsageNotes] = useState('');
    const [message, setMessage] = useState({ type: '', text: '' });
    const [formData, setFormData] = useState({ name: '', category: '', quantity: '', minStock: '', unit: '', cost: '', usageAlertDays: '7' });
    const [showExportMenu, setShowExportMenu] = useState(false);
    const [usageHistoryModal, setUsageHistoryModal] = useState(null);
    const exportMenuRef = React.useRef(null);
    
    // Dark theme support
    const [isDark, setIsDark] = useState(document.documentElement.getAttribute('data-theme') === 'dark');
    
    useEffect(() => {
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.attributeName === 'data-theme') {
                    setIsDark(document.documentElement.getAttribute('data-theme') === 'dark');
                }
            });
        });
        observer.observe(document.documentElement, { attributes: true });
        return () => observer.disconnect();
    }, []);

    const theme = {
        bg: isDark ? '#1e293b' : '#fff',
        bgSecondary: isDark ? '#0f172a' : '#f9fafb',
        bgHover: isDark ? '#334155' : '#f3f4f6',
        text: isDark ? '#f1f5f9' : '#1f2937',
        textSecondary: isDark ? '#94a3b8' : '#6b7280',
        textMuted: isDark ? '#64748b' : '#9ca3af',
        border: isDark ? '#334155' : '#e5e7eb',
        borderLight: isDark ? '#475569' : '#f3f4f6',
        inputBg: isDark ? '#0f172a' : '#fff',
        cardBg: isDark ? '#1e293b' : '#fff',
        modalBg: isDark ? '#1e293b' : '#fff',
    };

    const { inventoryService } = window.FirebaseServices;

    // Load items
    useEffect(() => {
        loadItems();
    }, []);

    // Close export menu when clicking outside
    useEffect(() => {
        const handleClickOutside = (event) => {
            if (exportMenuRef.current && !exportMenuRef.current.contains(event.target)) {
                setShowExportMenu(false);
            }
        };
        document.addEventListener('mousedown', handleClickOutside);
        return () => document.removeEventListener('mousedown', handleClickOutside);
    }, []);

    const loadItems = async () => {
        setLoading(true);
        const result = await inventoryService.getAll();
        if (result.success) setItems(result.data);
        setLoading(false);
    };

    // Filter & search
    const filteredItems = items.filter(item => {
        const status = inventoryService.getStockStatus(item.quantity, item.minStock);
        const matchFilter = filter === 'all' || status === filter;
        const matchSearch = item.name?.toLowerCase().includes(search.toLowerCase()) || 
                           item.category?.toLowerCase().includes(search.toLowerCase());
        return matchFilter && matchSearch;
    });

    // Stats
    const stats = {
        total: items.length,
        inStock: items.filter(i => inventoryService.getStockStatus(i.quantity, i.minStock) === 'in-stock').length,
        lowStock: items.filter(i => inventoryService.getStockStatus(i.quantity, i.minStock) === 'low-stock').length,
        outOfStock: items.filter(i => inventoryService.getStockStatus(i.quantity, i.minStock) === 'out-of-stock').length
    };

    const showMessage = (type, text) => {
        setMessage({ type, text });
        setTimeout(() => setMessage({ type: '', text: '' }), 3000);
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        const data = { 
            ...formData, 
            quantity: Number(formData.quantity), 
            minStock: Number(formData.minStock), 
            cost: Number(formData.cost) || 0,
            usageAlertDays: Number(formData.usageAlertDays) || 7
        };
        
        let result;
        if (editItem) {
            result = await inventoryService.update(editItem.id, data);
        } else {
            result = await inventoryService.add(data);
        }

        if (result.success) {
            showMessage('success', editItem ? 'Item updated!' : 'Item added!');
            loadItems();
            closeModal();
        } else {
            showMessage('error', result.error);
        }
    };

    const handleDelete = async (id) => {
        const result = await inventoryService.delete(id);
        if (result.success) {
            showMessage('success', 'Item deleted');
            loadItems();
        }
        setDeleteConfirm(null);
    };

    const handleEdit = (item) => {
        setEditItem(item);
        setFormData({ 
            name: item.name, 
            category: item.category, 
            quantity: item.quantity, 
            minStock: item.minStock, 
            unit: item.unit || '', 
            cost: item.cost || '', 
            usageAlertDays: item.usageAlertDays || '7' 
        });
        setShowModal(true);
    };

    const closeModal = () => {
        setShowModal(false);
        setEditItem(null);
        setFormData({ name: '', category: '', quantity: '', minStock: '', unit: '', cost: '', usageAlertDays: '7' });
    };

    const handleRecordUsage = async () => {
        if (!usageAmount || Number(usageAmount) <= 0) {
            showMessage('error', 'Please enter a valid usage amount');
            return;
        }
        const currentUser = window.currentUserProfile;
        const releasedBy = currentUser ? { name: currentUser.name || currentUser.displayName || currentUser.email?.split('@')[0] || 'Unknown', id: currentUser.id || currentUser.uid } : { name: 'Unknown', id: null };
        const result = await inventoryService.recordUsage(usageModal.id, Number(usageAmount), usageNotes, releasedBy);
        if (result.success) {
            showMessage('success', `Recorded usage of ${usageAmount} ${usageModal.unit || 'units'}`);
            loadItems();
            setUsageModal(null);
            setUsageAmount('');
            setUsageNotes('');
        } else {
            showMessage('error', result.error);
        }
    };

    const getUsageAlertStyle = (alert) => {
        if (!alert) return null;
        const styles = {
            'critical': { bg: '#fee2e2', color: '#dc2626', icon: 'üî¥' },
            'warning': { bg: '#fef3c7', color: '#92400e', icon: 'üü°' },
            'ok': { bg: '#dcfce7', color: '#166534', icon: 'üü¢' }
        };
        return styles[alert.level];
    };

    const exportExcel = () => {
        let html = '<html><head><meta charset="UTF-8"></head><body>';
        html += `<table border="1"><tr><th>Item Name</th><th>Category</th><th>Quantity</th><th>Min Stock</th><th>Unit</th><th>Cost (${getBrandingForReceipts().currencySymbol || 'KES'})</th><th>Total Value</th><th>Usage/Day</th><th>Days Left</th><th>Status</th></tr>`;
        filteredItems.forEach(item => {
            const status = inventoryService.getStockStatus(item.quantity, item.minStock);
            const cost = item.cost || 0;
            const totalValue = cost * item.quantity;
            const usageRate = item.dailyUsageRate || 0;
            const daysLeft = usageRate > 0 ? Math.floor(item.quantity / usageRate) : '-';
            html += `<tr><td>${item.name}</td><td>${item.category}</td><td>${item.quantity}</td><td>${item.minStock}</td><td>${item.unit || ''}</td><td>${cost.toLocaleString()}</td><td>${totalValue.toLocaleString()}</td><td>${usageRate || '-'}</td><td>${daysLeft}</td><td>${status}</td></tr>`;
        });
        html += '</table></body></html>';
        const blob = new Blob([html], { type: 'application/vnd.ms-excel' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'inventory.xls';
        a.click();
        setShowExportMenu(false);
    };

    const exportPDF = () => {
        const printWindow = window.open('', '_blank');
        const totalInventoryValue = filteredItems.reduce((sum, item) => sum + ((item.cost || 0) * item.quantity), 0);
        let html = `<!DOCTYPE html><html><head><title>Inventory Report</title><style>
            body { font-family: Arial, sans-serif; padding: 20px; }
            h1 { color: #1f2937; margin-bottom: 20px; }
            table { width: 100%; border-collapse: collapse; font-size: 12px; }
            th, td { border: 1px solid #e5e7eb; padding: 8px; text-align: left; }
            th { background: #f3f4f6; font-weight: 600; }
            .in-stock { color: #166534; background: #dcfce7; }
            .low-stock { color: #92400e; background: #fef3c7; }
            .out-of-stock { color: #dc2626; background: #fee2e2; }
            .critical { color: #dc2626; font-weight: bold; }
            .warning { color: #f59e0b; }
            .stats { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
            .stat-box { padding: 15px; border: 1px solid #e5e7eb; }
            .cost-col { text-align: right; }
            .center { text-align: center; }
            .total-row { font-weight: bold; background: #f9fafb; }
        </style></head><body>`;
        html += `<h1>Inventory Report</h1><p>Generated: ${new Date().toLocaleDateString()}</p>`;
        html += `<div class="stats"><div class="stat-box"><strong>Total Items:</strong> ${stats.total}</div><div class="stat-box"><strong>In Stock:</strong> ${stats.inStock}</div><div class="stat-box"><strong>Low Stock:</strong> ${stats.lowStock}</div><div class="stat-box"><strong>Out of Stock:</strong> ${stats.outOfStock}</div><div class="stat-box"><strong>Total Value:</strong> ${getBrandingForReceipts().currencySymbol || 'KES'} ${totalInventoryValue.toLocaleString()}</div></div>`;
        html += '<table><tr><th>Item Name</th><th>Category</th><th class="center">Qty</th><th class="center">Min</th><th>Unit</th><th class="cost-col">Cost</th><th class="cost-col">Value</th><th class="center">Usage/Day</th><th class="center">Days Left</th><th>Status</th></tr>';
        filteredItems.forEach(item => {
            const status = inventoryService.getStockStatus(item.quantity, item.minStock);
            const cost = item.cost || 0;
            const totalValue = cost * item.quantity;
            const usageRate = item.dailyUsageRate || 0;
            const daysLeft = usageRate > 0 ? Math.floor(item.quantity / usageRate) : '-';
            const daysClass = daysLeft !== '-' && daysLeft <= 3 ? 'critical' : (daysLeft !== '-' && daysLeft <= 7 ? 'warning' : '');
            html += `<tr><td>${item.name}</td><td>${item.category}</td><td class="center">${item.quantity}</td><td class="center">${item.minStock}</td><td>${item.unit || ''}</td><td class="cost-col">${cost.toLocaleString()}</td><td class="cost-col">${totalValue.toLocaleString()}</td><td class="center">${usageRate || '-'}</td><td class="center ${daysClass}">${daysLeft}</td><td class="${status}">${status.replace('-', ' ')}</td></tr>`;
        });
        html += `<tr class="total-row"><td colspan="6" style="text-align: right;">Grand Total:</td><td class="cost-col">${getBrandingForReceipts().currencySymbol || 'KES'} ${totalInventoryValue.toLocaleString()}</td><td colspan="3"></td></tr>`;
        html += '</table></body></html>';
        printWindow.document.write(html);
        printWindow.document.close();
        printWindow.onload = () => { printWindow.print(); };
        setShowExportMenu(false);
    };

    const getStatusStyle = (status) => {
        const styles = {
            'in-stock': { bg: '#dcfce7', color: '#166534', label: 'In Stock' },
            'low-stock': { bg: '#fef3c7', color: '#92400e', label: 'Low Stock' },
            'out-of-stock': { bg: '#fee2e2', color: '#dc2626', label: 'Out of Stock' }
        };
        return styles[status] || styles['in-stock'];
    };

    const inputStyle = { width: '100%', padding: '10px 12px', border: `1px solid ${theme.border}`, borderRadius: '0', fontSize: '14px', outline: 'none', background: theme.inputBg, color: theme.text };
    const btnPrimary = { padding: '10px 20px', background: '#3b82f6', color: '#fff', border: 'none', borderRadius: '0', cursor: 'pointer', fontWeight: '600', fontSize: '14px' };
    const btnSecondary = { padding: '10px 20px', background: theme.bgHover, color: theme.text, border: `1px solid ${theme.border}`, borderRadius: '0', cursor: 'pointer', fontWeight: '500', fontSize: '14px' };

    return (
        <div style={{ padding: '0' }}>
            {/* Success/Error Toast Popup */}
            {message.text && (
                <div style={{ 
                    position: 'fixed', 
                    top: '24px', 
                    right: '24px', 
                    zIndex: 9999,
                    padding: '16px 24px', 
                    background: theme.cardBg,
                    borderLeft: `4px solid ${message.type === 'success' ? '#22c55e' : '#ef4444'}`,
                    boxShadow: '0 4px 20px rgba(0,0,0,0.15)',
                    display: 'flex', 
                    alignItems: 'center', 
                    gap: '12px',
                    minWidth: '280px',
                    animation: 'slideIn 0.3s ease'
                }}>
                    <div style={{ 
                        width: '32px', 
                        height: '32px', 
                        borderRadius: '50%', 
                        background: message.type === 'success' ? '#dcfce7' : '#fee2e2',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        fontSize: '16px'
                    }}>
                        {message.type === 'success' ? '‚úì' : '‚úï'}
                    </div>
                    <div>
                        <div style={{ fontWeight: '600', fontSize: '14px', color: theme.text }}>
                            {message.type === 'success' ? 'Success' : 'Error'}
                        </div>
                        <div style={{ fontSize: '13px', color: theme.textSecondary, marginTop: '2px' }}>{message.text}</div>
                    </div>
                    <button 
                        onClick={() => setMessage({ type: '', text: '' })} 
                        style={{ marginLeft: 'auto', background: 'none', border: 'none', cursor: 'pointer', color: theme.textMuted, fontSize: '18px', padding: '0' }}
                    >√ó</button>
                </div>
            )}

            {/* Stats Cards */}
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '16px', marginBottom: '24px' }}>
                {[
                    { label: 'Total Items', value: stats.total, icon: 'üì¶', color: '#3b82f6' },
                    { label: 'In Stock', value: stats.inStock, icon: '‚úì', color: '#22c55e' },
                    { label: 'Low Stock', value: stats.lowStock, icon: '‚ö†', color: '#f59e0b' },
                    { label: 'Out of Stock', value: stats.outOfStock, icon: '‚úï', color: '#ef4444' }
                ].map((stat, i) => (
                    <div key={i} style={{ background: theme.cardBg, padding: '20px', border: `1px solid ${theme.border}`, borderRadius: '0' }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <div>
                                <p style={{ margin: '0 0 4px', color: theme.textSecondary, fontSize: '13px' }}>{stat.label}</p>
                                <p style={{ margin: '0', fontSize: '28px', fontWeight: '700', color: stat.color }}>{stat.value}</p>
                            </div>
                            <span style={{ fontSize: '24px', opacity: 0.8 }}>{stat.icon}</span>
                        </div>
                    </div>
                ))}
            </div>

            {/* Toolbar */}
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px', gap: '16px' }}>
                <div style={{ display: 'flex', gap: '12px', flex: 1 }}>
                    <input
                        type="text"
                        placeholder="Search items..."
                        value={search}
                        onChange={(e) => setSearch(e.target.value)}
                        style={{ ...inputStyle, maxWidth: '280px' }}
                    />
                    <select value={filter} onChange={(e) => setFilter(e.target.value)} style={{ ...inputStyle, maxWidth: '160px' }}>
                        <option value="all">All Status</option>
                        <option value="in-stock">In Stock</option>
                        <option value="low-stock">Low Stock</option>
                        <option value="out-of-stock">Out of Stock</option>
                    </select>
                </div>
                <div style={{ display: 'flex', gap: '10px' }}>
                    <div style={{ position: 'relative' }} ref={exportMenuRef}>
                        <button onClick={() => setShowExportMenu(!showExportMenu)} style={btnSecondary}>üì• Export ‚ñæ</button>
                        {showExportMenu && (
                            <div style={{ position: 'absolute', top: '100%', right: 0, marginTop: '4px', background: theme.cardBg, border: `1px solid ${theme.border}`, borderRadius: '0', boxShadow: '0 4px 12px rgba(0,0,0,0.15)', zIndex: 100, minWidth: '140px' }}>
                                <button onClick={exportExcel} style={{ display: 'block', width: '100%', padding: '10px 16px', border: 'none', background: 'none', textAlign: 'left', cursor: 'pointer', fontSize: '14px', color: theme.text }} onMouseOver={(e) => e.target.style.background=theme.bgHover} onMouseOut={(e) => e.target.style.background='none'}>üìä Export Excel</button>
                                <button onClick={exportPDF} style={{ display: 'block', width: '100%', padding: '10px 16px', border: 'none', background: 'none', textAlign: 'left', cursor: 'pointer', fontSize: '14px', color: theme.text }} onMouseOver={(e) => e.target.style.background=theme.bgHover} onMouseOut={(e) => e.target.style.background='none'}>üìÑ Export PDF</button>
                            </div>
                        )}
                    </div>
                    {canCreate('inventory') && <button onClick={() => setShowModal(true)} style={btnPrimary}>+ Add Item</button>}
                </div>
            </div>

            {/* Table */}
            <div style={{ background: theme.cardBg, border: `1px solid ${theme.border}`, borderRadius: '0', overflow: 'hidden' }}>
                <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                    <thead>
                        <tr style={{ background: theme.bgSecondary }}>
                            <th style={{ padding: '14px 16px', textAlign: 'left', fontWeight: '600', fontSize: '13px', color: theme.textSecondary, borderBottom: `1px solid ${theme.border}` }}>Item Name</th>
                            <th style={{ padding: '14px 16px', textAlign: 'left', fontWeight: '600', fontSize: '13px', color: theme.textSecondary, borderBottom: `1px solid ${theme.border}` }}>Category</th>
                            <th style={{ padding: '14px 16px', textAlign: 'center', fontWeight: '600', fontSize: '13px', color: theme.textSecondary, borderBottom: `1px solid ${theme.border}` }}>Quantity</th>
                            <th style={{ padding: '14px 16px', textAlign: 'center', fontWeight: '600', fontSize: '13px', color: theme.textSecondary, borderBottom: `1px solid ${theme.border}` }}>Usage/Day</th>
                            <th style={{ padding: '14px 16px', textAlign: 'right', fontWeight: '600', fontSize: '13px', color: theme.textSecondary, borderBottom: `1px solid ${theme.border}` }}>Cost</th>
                            <th style={{ padding: '14px 16px', textAlign: 'center', fontWeight: '600', fontSize: '13px', color: theme.textSecondary, borderBottom: `1px solid ${theme.border}` }}>Status</th>
                            <th style={{ padding: '14px 16px', textAlign: 'center', fontWeight: '600', fontSize: '13px', color: theme.textSecondary, borderBottom: `1px solid ${theme.border}` }}>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {loading ? (
                            <tr><td colSpan="7" style={{ padding: '40px', textAlign: 'center', color: theme.textSecondary }}>Loading...</td></tr>
                        ) : filteredItems.length === 0 ? (
                            <tr><td colSpan="7" style={{ padding: '40px', textAlign: 'center', color: theme.textSecondary }}>No items found</td></tr>
                        ) : (
                            filteredItems.map(item => {
                                const status = inventoryService.getStockStatus(item.quantity, item.minStock);
                                const statusStyle = getStatusStyle(status);
                                const usageAlert = inventoryService.getUsageAlert(item);
                                const alertStyle = getUsageAlertStyle(usageAlert);
                                return (
                                    <tr key={item.id} style={{ borderBottom: `1px solid ${theme.borderLight}` }}>
                                        <td style={{ padding: '14px 16px', fontSize: '14px', fontWeight: '500', color: theme.text }}>
                                            {item.name}
                                            {usageAlert && usageAlert.level !== 'ok' && (
                                                <span style={{ marginLeft: '8px', padding: '2px 6px', background: alertStyle.bg, color: alertStyle.color, fontSize: '10px', fontWeight: '600' }}>
                                                    {usageAlert.days}d left
                                                </span>
                                            )}
                                        </td>
                                        <td style={{ padding: '14px 16px', fontSize: '14px', color: theme.textSecondary }}>{item.category}</td>
                                        <td style={{ padding: '14px 16px', fontSize: '14px', textAlign: 'center', fontWeight: '600', color: theme.text }}>{item.quantity} {item.unit}</td>
                                        <td style={{ padding: '14px 16px', fontSize: '14px', textAlign: 'center' }}>
                                            {item.dailyUsageRate ? (
                                                <span style={{ padding: '4px 8px', background: alertStyle?.bg || theme.bgHover, color: alertStyle?.color || theme.textSecondary, fontSize: '12px', fontWeight: '500' }}>
                                                    {item.dailyUsageRate} {item.unit || 'units'}
                                                </span>
                                            ) : (
                                                <span style={{ color: theme.textMuted, fontSize: '12px' }}>No data</span>
                                            )}
                                        </td>
                                        <td style={{ padding: '14px 16px', fontSize: '14px', textAlign: 'right', fontWeight: '600', color: '#059669' }}>{getBrandingForReceipts().currencySymbol || 'KES'} {(item.cost || 0).toLocaleString()}</td>
                                        <td style={{ padding: '14px 16px', textAlign: 'center' }}>
                                            <span style={{ padding: '4px 12px', background: statusStyle.bg, color: statusStyle.color, fontSize: '12px', fontWeight: '600', borderRadius: '0' }}>
                                                {statusStyle.label}
                                            </span>
                                        </td>
                                        <td style={{ padding: '14px 16px', textAlign: 'center' }}>
                                            <div style={{ display: 'flex', gap: '4px', justifyContent: 'center', flexWrap: 'wrap' }}>
                                                {canEdit('inventory') && <button onClick={() => setUsageModal(item)} style={{ padding: '6px 10px', background: '#fef3c7', border: '1px solid #fcd34d', borderRadius: '0', cursor: 'pointer', fontSize: '11px', color: '#92400e', fontWeight: '600' }}>Use</button>}
                                                <button onClick={() => setUsageHistoryModal(item)} style={{ padding: '6px 10px', background: '#f0fdf4', border: '1px solid #86efac', borderRadius: '0', cursor: 'pointer', fontSize: '11px', color: '#166534', fontWeight: '600' }}>History</button>
                                                <button onClick={() => setViewItem(item)} style={{ padding: '6px 10px', background: '#eff6ff', border: '1px solid #bfdbfe', borderRadius: '0', cursor: 'pointer', fontSize: '11px', color: '#2563eb' }}>View</button>
                                                {canEdit('inventory') && <button onClick={() => handleEdit(item)} style={{ padding: '6px 10px', background: theme.bgHover, border: `1px solid ${theme.border}`, borderRadius: '0', cursor: 'pointer', fontSize: '11px', color: theme.text }}>Edit</button>}
                                                {canDelete('inventory') && <button onClick={() => setDeleteConfirm(item)} style={{ padding: '6px 10px', background: '#fee2e2', border: '1px solid #fecaca', borderRadius: '0', cursor: 'pointer', color: '#dc2626', fontSize: '11px' }}>Del</button>}
                                            </div>
                                        </td>
                                    </tr>
                                );
                            })
                        )}
                    </tbody>
                </table>
            </div>

            {/* Modal */}
            {showModal && (
                <div style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 }}>
                    <div style={{ background: theme.modalBg, width: '100%', maxWidth: '440px', borderRadius: '0', overflow: 'hidden' }}>
                        <div style={{ padding: '20px 24px', borderBottom: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <h3 style={{ margin: 0, fontSize: '18px', fontWeight: '600', color: theme.text }}>{editItem ? 'Edit Item' : 'Add New Item'}</h3>
                            <button onClick={closeModal} style={{ background: 'none', border: 'none', fontSize: '20px', cursor: 'pointer', color: theme.textSecondary }}>√ó</button>
                        </div>
                        <form onSubmit={handleSubmit} style={{ padding: '24px' }}>
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                                <div>
                                    <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: theme.textSecondary }}>Item Name *</label>
                                    <input type="text" value={formData.name} onChange={(e) => setFormData({ ...formData, name: e.target.value })} style={inputStyle} required />
                                </div>
                                <div>
                                    <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: theme.textSecondary }}>Category *</label>
                                    <select value={formData.category} onChange={(e) => setFormData({ ...formData, category: e.target.value })} style={inputStyle} required>
                                        <option value="">Select category</option>
                                        <option value="Cleaning Supplies">Cleaning Supplies</option>
                                        <option value="Chemicals">Chemicals</option>
                                        <option value="Tools">Tools</option>
                                        <option value="Equipment">Equipment</option>
                                        <option value="Consumables">Consumables</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' }}>
                                    <div>
                                        <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: theme.textSecondary }}>Quantity *</label>
                                        <input type="number" min="0" value={formData.quantity} onChange={(e) => setFormData({ ...formData, quantity: e.target.value })} style={inputStyle} required />
                                    </div>
                                    <div>
                                        <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: theme.textSecondary }}>Min Stock *</label>
                                        <input type="number" min="0" value={formData.minStock} onChange={(e) => setFormData({ ...formData, minStock: e.target.value })} style={inputStyle} required />
                                    </div>
                                </div>
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' }}>
                                    <div>
                                        <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: theme.textSecondary }}>Unit (optional)</label>
                                        <input type="text" placeholder="e.g., pcs, liters, kg" value={formData.unit} onChange={(e) => setFormData({ ...formData, unit: e.target.value })} style={inputStyle} />
                                    </div>
                                    <div>
                                        <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: theme.textSecondary }}>Cost per Unit ({getBrandingForReceipts().currencySymbol || 'KES'})</label>
                                        <input type="number" min="0" step="0.01" placeholder="0.00" value={formData.cost} onChange={(e) => setFormData({ ...formData, cost: e.target.value })} style={inputStyle} />
                                    </div>
                                </div>
                                <div>
                                    <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: theme.textSecondary }}>Usage Alert (days)</label>
                                    <input type="number" min="1" placeholder="Alert when supply drops below X days" value={formData.usageAlertDays} onChange={(e) => setFormData({ ...formData, usageAlertDays: e.target.value })} style={inputStyle} />
                                    <p style={{ margin: '4px 0 0', fontSize: '11px', color: theme.textMuted }}>Alert when remaining supply falls below this many days</p>
                                </div>
                            </div>
                            <div style={{ display: 'flex', gap: '12px', marginTop: '24px' }}>
                                <button type="button" onClick={closeModal} style={{ ...btnSecondary, flex: 1 }}>Cancel</button>
                                <button type="submit" style={{ ...btnPrimary, flex: 1 }}>{editItem ? 'Update' : 'Add Item'}</button>
                            </div>
                        </form>
                    </div>
                </div>
            )}

            {/* View Item Modal */}
            {viewItem && (
                <div style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 }}>
                    <div style={{ background: theme.modalBg, width: '100%', maxWidth: '400px', borderRadius: '0', overflow: 'hidden' }}>
                        <div style={{ padding: '20px 24px', borderBottom: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <h3 style={{ margin: 0, fontSize: '18px', fontWeight: '600', color: theme.text }}>Item Details</h3>
                            <button onClick={() => setViewItem(null)} style={{ background: 'none', border: 'none', fontSize: '20px', cursor: 'pointer', color: theme.textSecondary }}>√ó</button>
                        </div>
                        <div style={{ padding: '24px' }}>
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', padding: '12px', background: theme.bgSecondary }}>
                                    <span style={{ color: theme.textSecondary, fontSize: '14px' }}>Item Name</span>
                                    <span style={{ fontWeight: '600', fontSize: '14px', color: theme.text }}>{viewItem.name}</span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', padding: '12px' }}>
                                    <span style={{ color: theme.textSecondary, fontSize: '14px' }}>Category</span>
                                    <span style={{ fontWeight: '500', fontSize: '14px', color: theme.text }}>{viewItem.category}</span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', padding: '12px', background: theme.bgSecondary }}>
                                    <span style={{ color: theme.textSecondary, fontSize: '14px' }}>Quantity</span>
                                    <span style={{ fontWeight: '600', fontSize: '14px', color: theme.text }}>{viewItem.quantity} {viewItem.unit}</span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', padding: '12px' }}>
                                    <span style={{ color: theme.textSecondary, fontSize: '14px' }}>Min Stock Level</span>
                                    <span style={{ fontWeight: '500', fontSize: '14px', color: theme.text }}>{viewItem.minStock}</span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', padding: '12px', background: theme.bgSecondary }}>
                                    <span style={{ color: theme.textSecondary, fontSize: '14px' }}>Cost per Unit</span>
                                    <span style={{ fontWeight: '600', fontSize: '14px', color: '#059669' }}>{getBrandingForReceipts().currencySymbol || 'KES'} {(viewItem.cost || 0).toLocaleString()}</span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', padding: '12px' }}>
                                    <span style={{ color: theme.textSecondary, fontSize: '14px' }}>Total Value</span>
                                    <span style={{ fontWeight: '700', fontSize: '14px', color: '#059669' }}>{getBrandingForReceipts().currencySymbol || 'KES'} {((viewItem.cost || 0) * viewItem.quantity).toLocaleString()}</span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', padding: '12px', background: theme.bgSecondary }}>
                                    <span style={{ color: theme.textSecondary, fontSize: '14px' }}>Status</span>
                                    <span style={{ padding: '4px 12px', background: getStatusStyle(inventoryService.getStockStatus(viewItem.quantity, viewItem.minStock)).bg, color: getStatusStyle(inventoryService.getStockStatus(viewItem.quantity, viewItem.minStock)).color, fontSize: '12px', fontWeight: '600', borderRadius: '0' }}>
                                        {getStatusStyle(inventoryService.getStockStatus(viewItem.quantity, viewItem.minStock)).label}
                                    </span>
                                </div>
                                {viewItem.dailyUsageRate > 0 && (
                                    <>
                                        <div style={{ display: 'flex', justifyContent: 'space-between', padding: '12px' }}>
                                            <span style={{ color: theme.textSecondary, fontSize: '14px' }}>Daily Usage Rate</span>
                                            <span style={{ fontWeight: '600', fontSize: '14px', color: theme.text }}>{viewItem.dailyUsageRate} {viewItem.unit}/day</span>
                                        </div>
                                        <div style={{ display: 'flex', justifyContent: 'space-between', padding: '12px', background: theme.bgSecondary }}>
                                            <span style={{ color: theme.textSecondary, fontSize: '14px' }}>Days of Supply Left</span>
                                            <span style={{ fontWeight: '600', fontSize: '14px', color: inventoryService.getUsageAlert(viewItem)?.level === 'critical' ? '#dc2626' : inventoryService.getUsageAlert(viewItem)?.level === 'warning' ? '#f59e0b' : '#22c55e' }}>
                                                {Math.floor(viewItem.quantity / viewItem.dailyUsageRate)} days
                                            </span>
                                        </div>
                                    </>
                                )}
                                {viewItem.lastUsage && (
                                    <div style={{ display: 'flex', justifyContent: 'space-between', padding: '12px' }}>
                                        <span style={{ color: theme.textSecondary, fontSize: '14px' }}>Last Usage</span>
                                        <span style={{ fontWeight: '500', fontSize: '14px', color: theme.text }}>{viewItem.lastUsage.amount} {viewItem.unit} - {new Date(viewItem.lastUsage.date).toLocaleDateString()}</span>
                                    </div>
                                )}
                            </div>
                            <div style={{ marginTop: '24px', display: 'flex', gap: '12px' }}>
                                <button onClick={() => setViewItem(null)} style={{ ...btnSecondary, flex: 1 }}>Close</button>
                                <button onClick={() => {
                                    const status = inventoryService.getStockStatus(viewItem.quantity, viewItem.minStock);
                                    const usageAlert = inventoryService.getUsageAlert(viewItem);
                                    const daysLeft = viewItem.dailyUsageRate > 0 ? Math.floor(viewItem.quantity / viewItem.dailyUsageRate) : null;
                                    const printWindow = window.open('', '_blank');
                                    let html = `<!DOCTYPE html><html><head><title>Item Receipt - ${viewItem.name}</title><style>
                                        body { font-family: Arial, sans-serif; padding: 30px; max-width: 400px; margin: 0 auto; }
                                        .header { text-align: center; border-bottom: 2px solid #1f2937; padding-bottom: 15px; margin-bottom: 20px; }
                                        .header h2 { margin: 0 0 5px; color: #1f2937; }
                                        .header p { margin: 0; color: #6b7280; font-size: 12px; }
                                        .row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px dashed #e5e7eb; }
                                        .label { color: #6b7280; }
                                        .value { font-weight: 600; text-align: right; }
                                        .status { padding: 4px 12px; font-size: 12px; font-weight: 600; }
                                        .in-stock { background: #dcfce7; color: #166534; }
                                        .low-stock { background: #fef3c7; color: #92400e; }
                                        .out-of-stock { background: #fee2e2; color: #dc2626; }
                                        .footer { text-align: center; margin-top: 25px; padding-top: 15px; border-top: 2px solid #1f2937; font-size: 11px; color: #9ca3af; }
                                        .total { font-size: 18px; color: #059669; }
                                    </style></head><body>
                                    <div class="header">
                                        <h2>üöó ${getBrandingForReceipts().companyName }</h2>
                                        <p>Inventory Item Receipt</p>
                                    </div>
                                    <div class="row"><span class="label">Item Name</span><span class="value">${viewItem.name}</span></div>
                                    <div class="row"><span class="label">Category</span><span class="value">${viewItem.category}</span></div>
                                    <div class="row"><span class="label">Quantity</span><span class="value">${viewItem.quantity} ${viewItem.unit || ''}</span></div>
                                    <div class="row"><span class="label">Min Stock Level</span><span class="value">${viewItem.minStock}</span></div>
                                    <div class="row"><span class="label">Cost per Unit</span><span class="value">${getBrandingForReceipts().currencySymbol || 'KES'} ${(viewItem.cost || 0).toLocaleString()}</span></div>
                                    <div class="row"><span class="label">Total Value</span><span class="value total">${getBrandingForReceipts().currencySymbol || 'KES'} ${((viewItem.cost || 0) * viewItem.quantity).toLocaleString()}</span></div>
                                    <div class="row"><span class="label">Status</span><span class="value"><span class="status ${status}">${status.replace('-', ' ')}</span></span></div>
                                    ${viewItem.dailyUsageRate ? `<div class="row"><span class="label">Daily Usage Rate</span><span class="value">${viewItem.dailyUsageRate} ${viewItem.unit || 'units'}/day</span></div>` : ''}
                                    ${daysLeft !== null ? `<div class="row"><span class="label">Days of Supply</span><span class="value" style="color: ${daysLeft <= 3 ? '#dc2626' : daysLeft <= 7 ? '#f59e0b' : '#22c55e'}">${daysLeft} days</span></div>` : ''}
                                    ${viewItem.lastUsage ? `<div class="row"><span class="label">Last Usage</span><span class="value">${viewItem.lastUsage.amount} ${viewItem.unit || ''} on ${new Date(viewItem.lastUsage.date).toLocaleDateString()}</span></div>` : ''}
                                    <div class="footer">
                                        <p>Generated: ${new Date().toLocaleString()}</p>
                                        <p>${getBrandingForReceipts().companyName } Car Wash Management System</p>
                                    </div>
                                    </body></html>`;
                                    printWindow.document.write(html);
                                    printWindow.document.close();
                                    printWindow.onload = () => { printWindow.print(); };
                                }} style={{ ...btnPrimary, flex: 1, display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '6px' }}>
                                    üñ®Ô∏è Print
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* Record Usage Modal */}
            {usageModal && (
                <div style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 }}>
                    <div style={{ background: theme.modalBg, width: '100%', maxWidth: '380px', borderRadius: '0', overflow: 'hidden' }}>
                        <div style={{ padding: '20px 24px', borderBottom: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <h3 style={{ margin: 0, fontSize: '18px', fontWeight: '600', color: theme.text }}>Record Usage</h3>
                            <button onClick={() => { setUsageModal(null); setUsageAmount(''); setUsageNotes(''); }} style={{ background: 'none', border: 'none', fontSize: '20px', cursor: 'pointer', color: theme.textSecondary }}>√ó</button>
                        </div>
                        <div style={{ padding: '24px' }}>
                            <div style={{ background: theme.bgSecondary, padding: '16px', marginBottom: '20px' }}>
                                <p style={{ margin: '0 0 4px', fontWeight: '600', fontSize: '15px', color: theme.text }}>{usageModal.name}</p>
                                <p style={{ margin: 0, color: theme.textSecondary, fontSize: '13px' }}>Available: <strong>{usageModal.quantity} {usageModal.unit}</strong></p>
                            </div>
                            <div style={{ marginBottom: '16px' }}>
                                <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: theme.textSecondary }}>Amount Used *</label>
                                <input 
                                    type="number" 
                                    min="1" 
                                    max={usageModal.quantity}
                                    value={usageAmount} 
                                    onChange={(e) => setUsageAmount(e.target.value)} 
                                    placeholder={`Max: ${usageModal.quantity}`}
                                    style={inputStyle} 
                                />
                            </div>
                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: theme.textSecondary }}>Notes (optional)</label>
                                <input 
                                    type="text" 
                                    value={usageNotes} 
                                    onChange={(e) => setUsageNotes(e.target.value)} 
                                    placeholder="e.g., Used for vehicle wash"
                                    style={inputStyle} 
                                />
                            </div>
                            <div style={{ display: 'flex', gap: '12px' }}>
                                <button onClick={() => { setUsageModal(null); setUsageAmount(''); setUsageNotes(''); }} style={{ ...btnSecondary, flex: 1 }}>Cancel</button>
                                <button onClick={handleRecordUsage} style={{ flex: 1, padding: '10px 20px', background: '#f59e0b', color: '#fff', border: 'none', borderRadius: '0', cursor: 'pointer', fontWeight: '600', fontSize: '14px' }}>Record Usage</button>
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* Delete Confirmation Modal */}
            {deleteConfirm && (
                <div style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 }}>
                    <div style={{ background: theme.modalBg, width: '100%', maxWidth: '380px', borderRadius: '0', overflow: 'hidden' }}>
                        <div style={{ padding: '24px', textAlign: 'center' }}>
                            <div style={{ width: '56px', height: '56px', background: '#fee2e2', borderRadius: '50%', display: 'flex', alignItems: 'center', justifyContent: 'center', margin: '0 auto 16px', fontSize: '24px' }}>üóëÔ∏è</div>
                            <h3 style={{ margin: '0 0 8px', fontSize: '18px', fontWeight: '600', color: theme.text }}>Delete Item</h3>
                            <p style={{ margin: '0 0 24px', color: theme.textSecondary, fontSize: '14px' }}>Are you sure you want to delete <strong>"{deleteConfirm.name}"</strong>? This action cannot be undone.</p>
                            <div style={{ display: 'flex', gap: '12px' }}>
                                <button onClick={() => setDeleteConfirm(null)} style={{ ...btnSecondary, flex: 1 }}>Cancel</button>
                                <button onClick={() => handleDelete(deleteConfirm.id)} style={{ flex: 1, padding: '10px 20px', background: '#dc2626', color: '#fff', border: 'none', borderRadius: '0', cursor: 'pointer', fontWeight: '600', fontSize: '14px' }}>Delete</button>
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* Usage History Modal with Predictive Analysis */}
            {usageHistoryModal && (() => {
                const item = usageHistoryModal;
                const usageHistory = item.usageHistory || [];
                
                // Calculate predictive analysis
                const calculatePredictiveAnalysis = () => {
                    if (usageHistory.length === 0) {
                        return { dailyAvg: 0, monthlyAvg: 0, weeklyAvg: 0, daysUntilEmpty: null, reorderDate: null, trend: 'stable' };
                    }
                    
                    const sortedHistory = [...usageHistory].sort((a, b) => new Date(b.date) - new Date(a.date));
                    const dates = sortedHistory.map(u => new Date(u.date));
                    const oldestDate = new Date(Math.min(...dates));
                    const newestDate = new Date(Math.max(...dates));
                    const daysDiff = Math.max(1, Math.ceil((newestDate - oldestDate) / (1000 * 60 * 60 * 24)));
                    const totalUsage = usageHistory.reduce((sum, u) => sum + (u.amount || 0), 0);
                    const dailyAvg = totalUsage / daysDiff;
                    const weeklyAvg = dailyAvg * 7;
                    const monthlyAvg = dailyAvg * 30;
                    const daysUntilEmpty = dailyAvg > 0 ? Math.floor(item.quantity / dailyAvg) : null;
                    const daysUntilMinStock = dailyAvg > 0 ? Math.floor((item.quantity - item.minStock) / dailyAvg) : null;
                    const reorderDate = daysUntilMinStock !== null && daysUntilMinStock > 0 
                        ? new Date(Date.now() + daysUntilMinStock * 24 * 60 * 60 * 1000).toLocaleDateString()
                        : (item.quantity <= item.minStock ? 'Reorder Now' : null);
                    
                    const now = new Date();
                    const last7Days = usageHistory.filter(u => (now - new Date(u.date)) / (1000 * 60 * 60 * 24) <= 7).reduce((sum, u) => sum + (u.amount || 0), 0);
                    const prev7Days = usageHistory.filter(u => { const d = (now - new Date(u.date)) / (1000 * 60 * 60 * 24); return d > 7 && d <= 14; }).reduce((sum, u) => sum + (u.amount || 0), 0);
                    let trend = 'stable';
                    if (prev7Days > 0) {
                        const change = ((last7Days - prev7Days) / prev7Days) * 100;
                        if (change > 15) trend = 'increasing';
                        else if (change < -15) trend = 'decreasing';
                    }
                    
                    const monthlyUsage = {};
                    usageHistory.forEach(u => {
                        const date = new Date(u.date);
                        const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                        monthlyUsage[monthKey] = (monthlyUsage[monthKey] || 0) + (u.amount || 0);
                    });
                    
                    return { dailyAvg, weeklyAvg, monthlyAvg, daysUntilEmpty, reorderDate, trend, monthlyUsage, totalUsage };
                };
                
                const analysis = calculatePredictiveAnalysis();
                
                return (
                    <div style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.4)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000, padding: '20px' }}>
                        <div style={{ background: '#fff', width: '100%', maxWidth: '600px', maxHeight: '85vh', display: 'flex', flexDirection: 'column', boxShadow: '0 4px 24px rgba(0,0,0,0.12)' }}>
                            {/* Header */}
                            <div style={{ padding: '20px 24px', borderBottom: '1px solid #e5e7eb', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                <div>
                                    <h3 style={{ margin: 0, fontSize: '16px', fontWeight: '600', color: '#1f2937' }}>Usage History</h3>
                                    <p style={{ margin: '2px 0 0', fontSize: '13px', color: '#6b7280' }}>{item.name} ‚Ä¢ {item.quantity} {item.unit} in stock</p>
                                </div>
                                <button onClick={() => setUsageHistoryModal(null)} style={{ background: 'none', border: 'none', fontSize: '20px', cursor: 'pointer', color: '#9ca3af', padding: '4px' }}>√ó</button>
                            </div>
                            
                            <div style={{ padding: '20px 24px', overflowY: 'auto', flex: 1 }}>
                                {/* Prediction Summary */}
                                <div style={{ marginBottom: '24px' }}>
                                    <p style={{ margin: '0 0 12px', fontSize: '12px', fontWeight: '600', color: '#6b7280', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Predictive Analysis</p>
                                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '1px', background: '#e5e7eb', border: '1px solid #e5e7eb' }}>
                                        <div style={{ padding: '14px 12px', background: '#fff', textAlign: 'center' }}>
                                            <p style={{ margin: 0, fontSize: '18px', fontWeight: '600', color: '#1f2937' }}>{analysis.dailyAvg.toFixed(1)}</p>
                                            <p style={{ margin: '4px 0 0', fontSize: '11px', color: '#6b7280' }}>Daily Avg</p>
                                        </div>
                                        <div style={{ padding: '14px 12px', background: '#fff', textAlign: 'center' }}>
                                            <p style={{ margin: 0, fontSize: '18px', fontWeight: '600', color: '#1f2937' }}>{analysis.monthlyAvg.toFixed(1)}</p>
                                            <p style={{ margin: '4px 0 0', fontSize: '11px', color: '#6b7280' }}>Monthly Avg</p>
                                        </div>
                                        <div style={{ padding: '14px 12px', background: '#fff', textAlign: 'center' }}>
                                            <p style={{ margin: 0, fontSize: '18px', fontWeight: '600', color: analysis.daysUntilEmpty && analysis.daysUntilEmpty <= 7 ? '#b91c1c' : '#1f2937' }}>{analysis.daysUntilEmpty ?? '‚Äî'}</p>
                                            <p style={{ margin: '4px 0 0', fontSize: '11px', color: '#6b7280' }}>Days Left</p>
                                        </div>
                                        <div style={{ padding: '14px 12px', background: '#fff', textAlign: 'center' }}>
                                            <p style={{ margin: 0, fontSize: '18px', fontWeight: '600', color: '#1f2937', textTransform: 'capitalize' }}>{analysis.trend}</p>
                                            <p style={{ margin: '4px 0 0', fontSize: '11px', color: '#6b7280' }}>Trend</p>
                                        </div>
                                    </div>
                                    {analysis.reorderDate && (
                                        <p style={{ margin: '10px 0 0', fontSize: '12px', color: analysis.reorderDate === 'Reorder Now' ? '#b91c1c' : '#6b7280' }}>
                                            {analysis.reorderDate === 'Reorder Now' ? '‚ö† Stock at or below minimum level' : `Reorder by ${analysis.reorderDate}`}
                                        </p>
                                    )}
                                </div>

                                {/* Monthly Breakdown */}
                                {analysis.monthlyUsage && Object.keys(analysis.monthlyUsage).length > 0 && (
                                    <div style={{ marginBottom: '24px' }}>
                                        <p style={{ margin: '0 0 12px', fontSize: '12px', fontWeight: '600', color: '#6b7280', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Monthly Breakdown</p>
                                        <div style={{ display: 'flex', gap: '8px', overflowX: 'auto', paddingBottom: '4px' }}>
                                            {Object.entries(analysis.monthlyUsage).sort((a, b) => b[0].localeCompare(a[0])).slice(0, 6).map(([month, amount]) => (
                                                <div key={month} style={{ padding: '10px 14px', background: '#f9fafb', border: '1px solid #e5e7eb', minWidth: '80px', textAlign: 'center', flexShrink: 0 }}>
                                                    <p style={{ margin: 0, fontSize: '15px', fontWeight: '600', color: '#1f2937' }}>{amount}</p>
                                                    <p style={{ margin: '2px 0 0', fontSize: '10px', color: '#9ca3af' }}>{new Date(month + '-01').toLocaleDateString('en', { month: 'short' })}</p>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                {/* Usage History Table */}
                                <div>
                                    <p style={{ margin: '0 0 12px', fontSize: '12px', fontWeight: '600', color: '#6b7280', textTransform: 'uppercase', letterSpacing: '0.5px' }}>History ({usageHistory.length})</p>
                                    {usageHistory.length === 0 ? (
                                        <div style={{ padding: '32px 20px', textAlign: 'center', background: '#f9fafb', border: '1px solid #e5e7eb' }}>
                                            <p style={{ margin: 0, color: '#6b7280', fontSize: '13px' }}>No usage recorded yet</p>
                                        </div>
                                    ) : (
                                        <div style={{ border: '1px solid #e5e7eb', maxHeight: '200px', overflowY: 'auto' }}>
                                            <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '13px' }}>
                                                <thead>
                                                    <tr style={{ background: '#f9fafb' }}>
                                                        <th style={{ padding: '10px 12px', textAlign: 'left', fontWeight: '500', color: '#6b7280', borderBottom: '1px solid #e5e7eb' }}>Date</th>
                                                        <th style={{ padding: '10px 12px', textAlign: 'left', fontWeight: '500', color: '#6b7280', borderBottom: '1px solid #e5e7eb' }}>Released By</th>
                                                        <th style={{ padding: '10px 12px', textAlign: 'right', fontWeight: '500', color: '#6b7280', borderBottom: '1px solid #e5e7eb' }}>Used</th>
                                                        <th style={{ padding: '10px 12px', textAlign: 'right', fontWeight: '500', color: '#6b7280', borderBottom: '1px solid #e5e7eb' }}>Remaining</th>
                                                        <th style={{ padding: '10px 12px', textAlign: 'left', fontWeight: '500', color: '#6b7280', borderBottom: '1px solid #e5e7eb' }}>Notes</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {[...usageHistory].sort((a, b) => new Date(b.date) - new Date(a.date)).map((usage, idx) => (
                                                        <tr key={idx} style={{ borderBottom: '1px solid #f3f4f6' }}>
                                                            <td style={{ padding: '10px 12px', color: '#374151' }}>{new Date(usage.date).toLocaleDateString()}</td>
                                                            <td style={{ padding: '10px 12px', color: '#374151', fontWeight: '500' }}>{usage.releasedBy?.name || '‚Äî'}</td>
                                                            <td style={{ padding: '10px 12px', textAlign: 'right', fontWeight: '500', color: '#374151' }}>-{usage.amount}</td>
                                                            <td style={{ padding: '10px 12px', textAlign: 'right', color: '#6b7280' }}>{usage.remainingQty ?? '‚Äî'}</td>
                                                            <td style={{ padding: '10px 12px', color: '#9ca3af', maxWidth: '120px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>{usage.notes || '‚Äî'}</td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    )}
                                </div>
                            </div>
                            
                            {/* Footer */}
                            <div style={{ padding: '16px 24px', borderTop: '1px solid #e5e7eb', display: 'flex', gap: '12px' }}>
                                <button onClick={() => setUsageHistoryModal(null)} style={{ ...btnSecondary, flex: 1 }}>Close</button>
                                <button onClick={() => {
                                    const printWindow = window.open('', '_blank');
                                    let html = `<!DOCTYPE html><html><head><title>Usage Report - ${item.name}</title><style>
                                        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; padding: 40px; max-width: 700px; margin: 0 auto; color: #1f2937; }
                                        h1 { font-size: 20px; font-weight: 600; margin: 0 0 4px; }
                                        .subtitle { color: #6b7280; font-size: 13px; margin-bottom: 30px; }
                                        .section-title { font-size: 11px; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; margin: 0 0 10px; }
                                        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1px; background: #e5e7eb; border: 1px solid #e5e7eb; margin-bottom: 30px; }
                                        .stat { padding: 16px; background: #fff; text-align: center; }
                                        .stat-value { font-size: 20px; font-weight: 600; }
                                        .stat-label { font-size: 11px; color: #6b7280; margin-top: 4px; }
                                        table { width: 100%; border-collapse: collapse; font-size: 12px; }
                                        th, td { padding: 10px 12px; text-align: left; border-bottom: 1px solid #e5e7eb; }
                                        th { background: #f9fafb; font-weight: 500; color: #6b7280; }
                                        .right { text-align: right; }
                                        .footer { text-align: center; margin-top: 40px; font-size: 11px; color: #9ca3af; }
                                    </style></head><body>
                                    <h1>Usage Report</h1>
                                    <p class="subtitle">${item.name} ‚Ä¢ ${item.category}</p>
                                    <p class="section-title">Summary</p>
                                    <div class="stats">
                                        <div class="stat"><div class="stat-value">${item.quantity}</div><div class="stat-label">Current Stock</div></div>
                                        <div class="stat"><div class="stat-value">${analysis.dailyAvg.toFixed(1)}</div><div class="stat-label">Daily Avg</div></div>
                                        <div class="stat"><div class="stat-value">${analysis.monthlyAvg.toFixed(1)}</div><div class="stat-label">Monthly Avg</div></div>
                                        <div class="stat"><div class="stat-value">${analysis.daysUntilEmpty ?? '‚Äî'}</div><div class="stat-label">Days Left</div></div>
                                    </div>
                                    <p class="section-title">History</p>
                                    <table><tr><th>Date</th><th>Released By</th><th class="right">Used</th><th class="right">Remaining</th><th>Notes</th></tr>
                                    ${[...usageHistory].sort((a, b) => new Date(b.date) - new Date(a.date)).map(u => 
                                        `<tr><td>${new Date(u.date).toLocaleDateString()}</td><td>${u.releasedBy?.name || '‚Äî'}</td><td class="right">-${u.amount}</td><td class="right">${u.remainingQty ?? '‚Äî'}</td><td>${u.notes || '‚Äî'}</td></tr>`
                                    ).join('')}
                                    </table>
                                    <div class="footer">Generated ${new Date().toLocaleDateString()} ‚Ä¢ ${getBrandingForReceipts().companyName }</div>
                                    </body></html>`;
                                    printWindow.document.write(html);
                                    printWindow.document.close();
                                    printWindow.onload = () => printWindow.print();
                                }} style={{ ...btnPrimary, flex: 1 }}>Print Report</button>
                            </div>
                        </div>
                    </div>
                );
            })()}
        </div>
    );
}

// ==================== EXPENSES MODULE ====================
function ExpensesModule() {
    const { canCreate, canEdit, canDelete } = usePermissions();
    const [expenses, setExpenses] = useState([]);
    const [loading, setLoading] = useState(true);
    const [search, setSearch] = useState('');
    const [categoryFilter, setCategoryFilter] = useState('all');
    const [dateFilter, setDateFilter] = useState('all');
    const [showModal, setShowModal] = useState(false);
    const [editItem, setEditItem] = useState(null);
    const [deleteConfirm, setDeleteConfirm] = useState(null);
    const [message, setMessage] = useState({ type: '', text: '' });
    const [formData, setFormData] = useState({ 
        title: '', 
        category: '', 
        amount: '', 
        date: new Date().toISOString().split('T')[0], 
        description: '',
        paymentMethod: 'cash'
    });

    // Dark theme support
    const [isDark, setIsDark] = useState(document.documentElement.getAttribute('data-theme') === 'dark');
    
    useEffect(() => {
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.attributeName === 'data-theme') {
                    setIsDark(document.documentElement.getAttribute('data-theme') === 'dark');
                }
            });
        });
        observer.observe(document.documentElement, { attributes: true });
        return () => observer.disconnect();
    }, []);

    const theme = {
        bg: isDark ? '#1e293b' : '#fff',
        bgSecondary: isDark ? '#0f172a' : '#f9fafb',
        bgHover: isDark ? '#334155' : '#f3f4f6',
        text: isDark ? '#f1f5f9' : '#1f2937',
        textSecondary: isDark ? '#94a3b8' : '#6b7280',
        textMuted: isDark ? '#64748b' : '#9ca3af',
        border: isDark ? '#334155' : '#e5e7eb',
        borderLight: isDark ? '#475569' : '#f3f4f6',
        inputBg: isDark ? '#0f172a' : '#fff',
        cardBg: isDark ? '#1e293b' : '#fff',
        modalBg: isDark ? '#1e293b' : '#fff',
    };

    const { expensesService } = window.FirebaseServices;

    const categories = ['Utilities', 'Supplies', 'Maintenance', 'Salaries', 'Transport', 'Marketing', 'Equipment', 'Other'];

    // Realtime subscription
    useEffect(() => {
        const unsubscribe = expensesService.subscribeToExpenses((data) => {
            setExpenses(data);
            setLoading(false);
        });
        return () => unsubscribe();
    }, []);

    // Filter expenses
    const filteredExpenses = expenses.filter(expense => {
        const matchSearch = expense.title?.toLowerCase().includes(search.toLowerCase()) || 
                           expense.description?.toLowerCase().includes(search.toLowerCase());
        const matchCategory = categoryFilter === 'all' || expense.category === categoryFilter;
        
        let matchDate = true;
        if (dateFilter === 'today') {
            matchDate = expense.date === new Date().toISOString().split('T')[0];
        } else if (dateFilter === 'week') {
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            matchDate = new Date(expense.date) >= weekAgo;
        } else if (dateFilter === 'month') {
            const thisMonth = new Date().toISOString().slice(0, 7);
            matchDate = expense.date?.startsWith(thisMonth);
        }
        
        return matchSearch && matchCategory && matchDate;
    });

    const stats = expensesService.getSummary(expenses);

    const showMessage = (type, text) => {
        setMessage({ type, text });
        setTimeout(() => setMessage({ type: '', text: '' }), 3000);
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        let result;
        if (editItem) {
            result = await expensesService.update(editItem.id, formData);
        } else {
            result = await expensesService.add(formData);
        }
        if (result.success) {
            showMessage('success', editItem ? 'Expense updated!' : 'Expense added!');
            closeModal();
        } else {
            showMessage('error', result.error);
        }
    };

    const handleDelete = async (id) => {
        const result = await expensesService.delete(id);
        if (result.success) {
            showMessage('success', 'Expense deleted');
        }
        setDeleteConfirm(null);
    };

    const handleEdit = (expense) => {
        setEditItem(expense);
        setFormData({
            title: expense.title,
            category: expense.category,
            amount: expense.amount,
            date: expense.date,
            description: expense.description || '',
            paymentMethod: expense.paymentMethod || 'cash'
        });
        setShowModal(true);
    };

    const closeModal = () => {
        setShowModal(false);
        setEditItem(null);
        setFormData({ title: '', category: '', amount: '', date: new Date().toISOString().split('T')[0], description: '', paymentMethod: 'cash' });
    };

    const exportExpenses = () => {
        const printWindow = window.open('', '_blank');
        let html = `<!DOCTYPE html><html><head><title>Expenses Report</title><style>
            body { font-family: Arial, sans-serif; padding: 20px; }
            h1 { color: #1f2937; }
            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
            th, td { border: 1px solid #e5e7eb; padding: 10px; text-align: left; font-size: 13px; }
            th { background: #f3f4f6; }
            .stats { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
            .stat-box { padding: 15px 20px; border: 1px solid #e5e7eb; }
            .amount { text-align: right; font-weight: 600; }
            .total { font-weight: bold; background: #f9fafb; }
        </style></head><body>`;
        html += `<h1>Expenses Report</h1><p>Generated: ${new Date().toLocaleDateString()}</p>`;
        html += `<div class="stats"><div class="stat-box"><strong>Total:</strong> ${getBrandingForReceipts().currencySymbol || 'KES'} ${stats.total.toLocaleString()}</div><div class="stat-box"><strong>This Month:</strong> ${getBrandingForReceipts().currencySymbol || 'KES'} ${stats.thisMonth.toLocaleString()}</div><div class="stat-box"><strong>This Week:</strong> ${getBrandingForReceipts().currencySymbol || 'KES'} ${stats.thisWeek.toLocaleString()}</div><div class="stat-box"><strong>Today:</strong> ${getBrandingForReceipts().currencySymbol || 'KES'} ${stats.today.toLocaleString()}</div></div>`;
        html += `<table><tr><th>Date</th><th>Title</th><th>Category</th><th>Payment</th><th class="amount">Amount (${getBrandingForReceipts().currencySymbol || 'KES'})</th></tr>`;
        const total = filteredExpenses.reduce((sum, e) => sum + (e.amount || 0), 0);
        filteredExpenses.forEach(e => {
            html += `<tr><td>${e.date}</td><td>${e.title}</td><td>${e.category}</td><td>${e.paymentMethod || '-'}</td><td class="amount">${(e.amount || 0).toLocaleString()}</td></tr>`;
        });
        html += `<tr class="total"><td colspan="4" style="text-align:right;">Total:</td><td class="amount">${getBrandingForReceipts().currencySymbol || 'KES'} ${total.toLocaleString()}</td></tr>`;
        html += '</table></body></html>';
        printWindow.document.write(html);
        printWindow.document.close();
        printWindow.onload = () => printWindow.print();
    };

    const inputStyle = { width: '100%', padding: '10px 12px', border: `1px solid ${theme.border}`, borderRadius: '0', fontSize: '14px', outline: 'none', background: theme.inputBg, color: theme.text };
    const btnPrimary = { padding: '10px 20px', background: '#3b82f6', color: '#fff', border: 'none', borderRadius: '0', cursor: 'pointer', fontWeight: '600', fontSize: '14px' };
    const btnSecondary = { padding: '10px 20px', background: theme.bgHover, color: theme.text, border: `1px solid ${theme.border}`, borderRadius: '0', cursor: 'pointer', fontWeight: '500', fontSize: '14px' };

    return (
        <div style={{ padding: '0' }}>
            {/* Toast */}
            {message.text && (
                <div style={{ position: 'fixed', top: '24px', right: '24px', zIndex: 9999, padding: '16px 24px', background: theme.cardBg, borderLeft: `4px solid ${message.type === 'success' ? '#22c55e' : '#ef4444'}`, boxShadow: '0 4px 20px rgba(0,0,0,0.15)', display: 'flex', alignItems: 'center', gap: '12px', minWidth: '280px' }}>
                    <div style={{ width: '32px', height: '32px', borderRadius: '50%', background: message.type === 'success' ? '#dcfce7' : '#fee2e2', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '16px' }}>
                        {message.type === 'success' ? '‚úì' : '‚úï'}
                    </div>
                    <div>
                        <div style={{ fontWeight: '600', fontSize: '14px', color: theme.text }}>{message.type === 'success' ? 'Success' : 'Error'}</div>
                        <div style={{ fontSize: '13px', color: theme.textSecondary, marginTop: '2px' }}>{message.text}</div>
                    </div>
                    <button onClick={() => setMessage({ type: '', text: '' })} style={{ marginLeft: 'auto', background: 'none', border: 'none', cursor: 'pointer', color: theme.textMuted, fontSize: '18px' }}>√ó</button>
                </div>
            )}

            {/* Stats Cards */}
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '16px', marginBottom: '24px' }}>
                {[
                    { label: 'Total Expenses', value: `${getBrandingForReceipts().currencySymbol || 'KES'} ${stats.total.toLocaleString()}`, icon: 'üí∞', color: '#3b82f6' },
                    { label: 'This Month', value: `${getBrandingForReceipts().currencySymbol || 'KES'} ${stats.thisMonth.toLocaleString()}`, icon: 'üìÖ', color: '#8b5cf6' },
                    { label: 'This Week', value: `${getBrandingForReceipts().currencySymbol || 'KES'} ${stats.thisWeek.toLocaleString()}`, icon: 'üìä', color: '#f59e0b' },
                    { label: 'Today', value: `${getBrandingForReceipts().currencySymbol || 'KES'} ${stats.today.toLocaleString()}`, icon: 'üìå', color: '#22c55e' }
                ].map((stat, i) => (
                    <div key={i} style={{ background: theme.cardBg, padding: '20px', border: `1px solid ${theme.border}`, borderRadius: '0' }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <div>
                                <p style={{ margin: '0 0 4px', color: theme.textSecondary, fontSize: '13px' }}>{stat.label}</p>
                                <p style={{ margin: '0', fontSize: '22px', fontWeight: '700', color: stat.color }}>{stat.value}</p>
                            </div>
                            <span style={{ fontSize: '24px', opacity: 0.8 }}>{stat.icon}</span>
                        </div>
                    </div>
                ))}
            </div>

            {/* Toolbar */}
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px', gap: '12px', flexWrap: 'wrap' }}>
                <div style={{ display: 'flex', gap: '12px', flex: 1, flexWrap: 'wrap' }}>
                    <input type="text" placeholder="Search expenses..." value={search} onChange={(e) => setSearch(e.target.value)} style={{ ...inputStyle, maxWidth: '220px' }} />
                    <select value={categoryFilter} onChange={(e) => setCategoryFilter(e.target.value)} style={{ ...inputStyle, maxWidth: '150px' }}>
                        <option value="all">All Categories</option>
                        {categories.map(c => <option key={c} value={c}>{c}</option>)}
                    </select>
                    <select value={dateFilter} onChange={(e) => setDateFilter(e.target.value)} style={{ ...inputStyle, maxWidth: '130px' }}>
                        <option value="all">All Time</option>
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                    </select>
                </div>
                <div style={{ display: 'flex', gap: '10px' }}>
                    <button onClick={exportExpenses} style={btnSecondary}>üìÑ Export</button>
                    {canCreate('expenses') && <button onClick={() => setShowModal(true)} style={btnPrimary}>+ Add Expense</button>}
                </div>
            </div>

            {/* Table */}
            <div style={{ background: theme.cardBg, border: `1px solid ${theme.border}`, borderRadius: '0', overflow: 'hidden' }}>
                <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                    <thead>
                        <tr style={{ background: theme.bgSecondary }}>
                            <th style={{ padding: '14px 16px', textAlign: 'left', fontWeight: '600', fontSize: '13px', color: theme.textSecondary, borderBottom: `1px solid ${theme.border}` }}>Date</th>
                            <th style={{ padding: '14px 16px', textAlign: 'left', fontWeight: '600', fontSize: '13px', color: theme.textSecondary, borderBottom: `1px solid ${theme.border}` }}>Title</th>
                            <th style={{ padding: '14px 16px', textAlign: 'left', fontWeight: '600', fontSize: '13px', color: theme.textSecondary, borderBottom: `1px solid ${theme.border}` }}>Category</th>
                            <th style={{ padding: '14px 16px', textAlign: 'center', fontWeight: '600', fontSize: '13px', color: theme.textSecondary, borderBottom: `1px solid ${theme.border}` }}>Payment</th>
                            <th style={{ padding: '14px 16px', textAlign: 'right', fontWeight: '600', fontSize: '13px', color: theme.textSecondary, borderBottom: `1px solid ${theme.border}` }}>Amount</th>
                            <th style={{ padding: '14px 16px', textAlign: 'center', fontWeight: '600', fontSize: '13px', color: theme.textSecondary, borderBottom: `1px solid ${theme.border}` }}>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {loading ? (
                            <tr><td colSpan="6" style={{ padding: '40px', textAlign: 'center', color: theme.textSecondary }}>Loading...</td></tr>
                        ) : filteredExpenses.length === 0 ? (
                            <tr><td colSpan="6" style={{ padding: '40px', textAlign: 'center', color: theme.textSecondary }}>No expenses found</td></tr>
                        ) : (
                            filteredExpenses.map(expense => (
                                <tr key={expense.id} style={{ borderBottom: `1px solid ${theme.borderLight}` }}>
                                    <td style={{ padding: '14px 16px', fontSize: '14px', color: theme.textSecondary }}>{expense.date}</td>
                                    <td style={{ padding: '14px 16px' }}>
                                        <div style={{ fontWeight: '500', fontSize: '14px', color: theme.text }}>{expense.title}</div>
                                        {expense.description && <div style={{ fontSize: '12px', color: theme.textMuted, marginTop: '2px' }}>{expense.description}</div>}
                                    </td>
                                    <td style={{ padding: '14px 16px' }}>
                                        <span style={{ padding: '4px 10px', background: theme.bgHover, fontSize: '12px', fontWeight: '500', color: theme.text }}>{expense.category}</span>
                                    </td>
                                    <td style={{ padding: '14px 16px', textAlign: 'center', fontSize: '13px', color: theme.textSecondary, textTransform: 'capitalize' }}>{expense.paymentMethod || '-'}</td>
                                    <td style={{ padding: '14px 16px', textAlign: 'right', fontWeight: '600', fontSize: '14px', color: '#dc2626' }}>{getBrandingForReceipts().currencySymbol || 'KES'} {(expense.amount || 0).toLocaleString()}</td>
                                    <td style={{ padding: '14px 16px', textAlign: 'center' }}>
                                        <div style={{ display: 'flex', gap: '6px', justifyContent: 'center' }}>
                                            {canEdit('expenses') && <button onClick={() => handleEdit(expense)} style={{ padding: '6px 12px', background: theme.bgHover, border: `1px solid ${theme.border}`, borderRadius: '0', cursor: 'pointer', fontSize: '12px', color: theme.text }}>Edit</button>}
                                            {canDelete('expenses') && <button onClick={() => setDeleteConfirm(expense)} style={{ padding: '6px 12px', background: '#fee2e2', border: '1px solid #fecaca', borderRadius: '0', cursor: 'pointer', color: '#dc2626', fontSize: '12px' }}>Delete</button>}
                                        </div>
                                    </td>
                                </tr>
                            ))
                        )}
                    </tbody>
                </table>
            </div>

            {/* Add/Edit Modal */}
            {showModal && (
                <div style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 }}>
                    <div style={{ background: theme.modalBg, width: '100%', maxWidth: '440px', borderRadius: '0', overflow: 'hidden' }}>
                        <div style={{ padding: '20px 24px', borderBottom: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <h3 style={{ margin: 0, fontSize: '18px', fontWeight: '600', color: theme.text }}>{editItem ? 'Edit Expense' : 'Add Expense'}</h3>
                            <button onClick={closeModal} style={{ background: 'none', border: 'none', fontSize: '20px', cursor: 'pointer', color: theme.textSecondary }}>√ó</button>
                        </div>
                        <form onSubmit={handleSubmit} style={{ padding: '24px' }}>
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                                <div>
                                    <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: theme.textSecondary }}>Title *</label>
                                    <input type="text" value={formData.title} onChange={(e) => setFormData({ ...formData, title: e.target.value })} placeholder="e.g., Electricity Bill" style={inputStyle} required />
                                </div>
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' }}>
                                    <div>
                                        <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: theme.textSecondary }}>Category *</label>
                                        <select value={formData.category} onChange={(e) => setFormData({ ...formData, category: e.target.value })} style={inputStyle} required>
                                            <option value="">Select</option>
                                            {categories.map(c => <option key={c} value={c}>{c}</option>)}
                                        </select>
                                    </div>
                                    <div>
                                        <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: theme.textSecondary }}>Amount ({getBrandingForReceipts().currencySymbol || 'KES'}) *</label>
                                        <input type="number" min="0" step="0.01" value={formData.amount} onChange={(e) => setFormData({ ...formData, amount: e.target.value })} placeholder="0.00" style={inputStyle} required />
                                    </div>
                                </div>
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' }}>
                                    <div>
                                        <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: theme.textSecondary }}>Date *</label>
                                        <input type="date" value={formData.date} onChange={(e) => setFormData({ ...formData, date: e.target.value })} style={inputStyle} required />
                                    </div>
                                    <div>
                                        <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: theme.textSecondary }}>Payment Method</label>
                                        <select value={formData.paymentMethod} onChange={(e) => setFormData({ ...formData, paymentMethod: e.target.value })} style={inputStyle}>
                                            <option value="cash">Cash</option>
                                            <option value="mpesa">M-Pesa</option>
                                            <option value="bank">Bank Transfer</option>
                                            <option value="card">Card</option>
                                            <option value="cheque">Cheque</option>
                                        </select>
                                    </div>
                                </div>
                                <div>
                                    <label style={{ display: 'block', marginBottom: '6px', fontSize: '13px', fontWeight: '500', color: theme.textSecondary }}>Description (optional)</label>
                                    <input type="text" value={formData.description} onChange={(e) => setFormData({ ...formData, description: e.target.value })} placeholder="Additional notes..." style={inputStyle} />
                                </div>
                            </div>
                            <div style={{ display: 'flex', gap: '12px', marginTop: '24px' }}>
                                <button type="button" onClick={closeModal} style={{ ...btnSecondary, flex: 1 }}>Cancel</button>
                                <button type="submit" style={{ ...btnPrimary, flex: 1 }}>{editItem ? 'Update' : 'Add Expense'}</button>
                            </div>
                        </form>
                    </div>
                </div>
            )}

            {/* Delete Confirmation */}
            {deleteConfirm && (
                <div style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 }}>
                    <div style={{ background: theme.modalBg, width: '100%', maxWidth: '380px', borderRadius: '0', overflow: 'hidden' }}>
                        <div style={{ padding: '24px', textAlign: 'center' }}>
                            <div style={{ width: '56px', height: '56px', background: '#fee2e2', borderRadius: '50%', display: 'flex', alignItems: 'center', justifyContent: 'center', margin: '0 auto 16px', fontSize: '24px' }}>üóëÔ∏è</div>
                            <h3 style={{ margin: '0 0 8px', fontSize: '18px', fontWeight: '600', color: theme.text }}>Delete Expense</h3>
                            <p style={{ margin: '0 0 24px', color: theme.textSecondary, fontSize: '14px' }}>Delete <strong>"{deleteConfirm.title}"</strong> ({getBrandingForReceipts().currencySymbol || 'KES'} {(deleteConfirm.amount || 0).toLocaleString()})?</p>
                            <div style={{ display: 'flex', gap: '12px' }}>
                                <button onClick={() => setDeleteConfirm(null)} style={{ ...btnSecondary, flex: 1 }}>Cancel</button>
                                <button onClick={() => handleDelete(deleteConfirm.id)} style={{ flex: 1, padding: '10px 20px', background: '#dc2626', color: '#fff', border: 'none', borderRadius: '0', cursor: 'pointer', fontWeight: '600', fontSize: '14px' }}>Delete</button>
                            </div>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}

// ==================== BRANDING SETTINGS COMPONENT ====================
function BrandingSettings({ theme, cardStyle, inputStyle, labelStyle }) {
    const { branding, refreshBranding } = useBranding();
    const [formData, setFormData] = useState(branding);
    const [saving, setSaving] = useState(false);
    const [successMessage, setSuccessMessage] = useState('');
    const [error, setError] = useState('');
    const [activeSection, setActiveSection] = useState('identity');
    const [previewMode, setPreviewMode] = useState(false);
    const logoInputRef = React.useRef(null);

    // Sync form data when branding context updates
    useEffect(() => {
        setFormData(branding);
    }, [branding]);

    // Auto-hide messages
    useEffect(() => {
        if (successMessage) {
            const timer = setTimeout(() => setSuccessMessage(''), 3000);
            return () => clearTimeout(timer);
        }
    }, [successMessage]);

    useEffect(() => {
        if (error) {
            const timer = setTimeout(() => setError(''), 5000);
            return () => clearTimeout(timer);
        }
    }, [error]);

    const handleInputChange = (field, value) => {
        setFormData(prev => ({ ...prev, [field]: value }));
    };

    const handleLogoUpload = async (e) => {
        const file = e.target.files?.[0];
        if (!file) return;

        if (!file.type.startsWith('image/')) {
            setError('Please select an image file');
            return;
        }

        if (file.size > 1024 * 1024) {
            setError('Logo image should be less than 1MB');
            return;
        }

        try {
            const services = window.FirebaseServices;
            if (services?.brandingService) {
                const result = await services.brandingService.uploadLogo(file);
                if (result.success) {
                    setFormData(prev => ({ ...prev, logoUrl: result.url, logoType: 'image' }));
                    setSuccessMessage('Logo uploaded successfully!');
                } else {
                    setError(result.error || 'Failed to upload logo');
                }
            }
        } catch (err) {
            setError(err.message || 'Failed to upload logo');
        }
    };

    const handleSave = async () => {
        setSaving(true);
        try {
            const services = window.FirebaseServices;
            if (services?.brandingService) {
                const result = await services.brandingService.saveBranding(formData);
                if (result.success) {
                    // Immediately cache ALL fields to localStorage for loading screen and receipts
                    try {
                        localStorage.setItem('ecospark_branding', JSON.stringify({
                            companyName: formData.companyName,
                            tagline: formData.tagline,
                            logoUrl: formData.logoUrl,
                            logoType: formData.logoType,
                            primaryColor: formData.primaryColor,
                            secondaryColor: formData.secondaryColor,
                            accentColor: formData.accentColor,
                            address: formData.address,
                            city: formData.city,
                            phone: formData.phone,
                            email: formData.email,
                            website: formData.website,
                            taxPin: formData.taxPin,
                            businessReg: formData.businessReg,
                            receiptHeader: formData.receiptHeader,
                            receiptFooter: formData.receiptFooter,
                            invoiceFooter: formData.invoiceFooter,
                            currency: formData.currency,
                            currencySymbol: formData.currencySymbol,
                            timezone: formData.timezone,
                            dateFormat: formData.dateFormat,
                            facebook: formData.facebook,
                            instagram: formData.instagram,
                            twitter: formData.twitter,
                            shortName: formData.shortName
                        }));
                        // Also update the global cached branding immediately
                        window._cachedBranding = formData;
                    } catch (e) { /* ignore */ }
                    
                    // Update document title immediately - use saved values
                    document.title = `${formData.companyName} - ${formData.tagline || 'Car Wash Management'}`;
                    
                    // Update CSS variables immediately
                    if (formData.primaryColor) {
                        document.documentElement.style.setProperty('--brand-primary', formData.primaryColor);
                    }
                    if (formData.secondaryColor) {
                        document.documentElement.style.setProperty('--brand-secondary', formData.secondaryColor);
                    }
                    
                    setSuccessMessage('Branding saved! Login page and system updated. Loading screen will reflect changes on next refresh.');
                    refreshBranding();
                } else {
                    setError(result.error || 'Failed to save branding');
                }
            }
        } catch (err) {
            setError(err.message || 'Failed to save branding');
        } finally {
            setSaving(false);
        }
    };

    const handleReset = () => {
        setFormData(branding);
        setSuccessMessage('Form reset to saved values');
    };

    const sections = [
        { id: 'identity', label: 'Company Identity', icon: 'üè¢' },
        { id: 'contact', label: 'Contact Info', icon: 'üìû' },
        { id: 'legal', label: 'Legal & Tax', icon: 'üìã' },
        { id: 'colors', label: 'Brand Colors', icon: 'üé®' },
        { id: 'receipts', label: 'Receipts & Invoices', icon: 'üßæ' },
        { id: 'social', label: 'Social Media', icon: 'üåê' },
        { id: 'regional', label: 'Regional Settings', icon: 'üåç' }
    ];

    const sectionButtonStyle = (isActive) => ({
        padding: '12px 16px',
        background: isActive ? theme.bgTertiary : 'transparent',
        border: `1px solid ${isActive ? theme.border : 'transparent'}`,
        borderRadius: '0',
        color: isActive ? theme.text : theme.textSecondary,
        fontWeight: isActive ? '600' : '500',
        fontSize: '13px',
        cursor: 'pointer',
        display: 'flex',
        alignItems: 'center',
        gap: '10px',
        width: '100%',
        textAlign: 'left',
        transition: 'all 0.2s'
    });

    const renderLogo = () => {
        if (formData.logoUrl && formData.logoType === 'image') {
            return (
                <img 
                    src={formData.logoUrl} 
                    alt="Logo" 
                    style={{ width: '100%', height: '100%', objectFit: 'contain' }}
                />
            );
        }
        return (
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" style={{ width: '60%', height: '60%' }}>
                <path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9L18 10l-1.6-3.2A2 2 0 0014.6 5H9.4a2 2 0 00-1.8 1.1L6 10l-2.5.8C2.7 11.3 2 12.1 2 13v3c0 .6.4 1 1 1h2"/>
                <circle cx="7" cy="17" r="2"/>
                <circle cx="17" cy="17" r="2"/>
                <path d="M9 17h6"/>
            </svg>
        );
    };

    return (
        <div>
            {successMessage && (
                <div style={{ padding: '14px 20px', background: '#dcfce7', border: '1px solid #86efac', color: '#166534', marginBottom: '24px', display: 'flex', alignItems: 'center', gap: '10px', fontWeight: '500' }}>
                    <span>‚úì</span> {successMessage}
                </div>
            )}
            {error && (
                <div style={{ padding: '14px 20px', background: '#fef2f2', border: '1px solid #fecaca', color: '#991b1b', marginBottom: '24px', display: 'flex', alignItems: 'center', gap: '10px', fontWeight: '500' }}>
                    <span>‚úï</span> {error}
                </div>
            )}

            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px', padding: '20px 24px', background: theme.bg, border: `1px solid ${theme.border}` }}>
                <div>
                    <h2 style={{ margin: 0, color: theme.text, fontSize: '20px', fontWeight: '700' }}>üé® Brand Customization</h2>
                    <p style={{ margin: '6px 0 0', color: theme.textSecondary, fontSize: '13px' }}>
                        Customize your system branding - changes apply across login, sidebar, receipts, invoices, and reports
                    </p>
                </div>
                <div style={{ display: 'flex', gap: '12px' }}>
                    <button onClick={() => setPreviewMode(!previewMode)} style={{ padding: '10px 20px', background: previewMode ? formData.primaryColor : 'transparent', color: previewMode ? 'white' : theme.text, border: `1px solid ${theme.border}`, borderRadius: '0', fontSize: '13px', fontWeight: '600', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '8px' }}>
                        üëÅÔ∏è {previewMode ? 'Hide Preview' : 'Preview'}
                    </button>
                    <button onClick={handleReset} style={{ padding: '10px 20px', background: 'transparent', color: theme.textSecondary, border: `1px solid ${theme.border}`, borderRadius: '0', fontSize: '13px', fontWeight: '600', cursor: 'pointer' }}>
                        Reset
                    </button>
                    <button onClick={handleSave} disabled={saving} style={{ padding: '10px 24px', background: saving ? '#93c5fd' : formData.primaryColor || '#3b82f6', color: 'white', border: 'none', borderRadius: '0', fontSize: '13px', fontWeight: '700', cursor: saving ? 'wait' : 'pointer', display: 'flex', alignItems: 'center', gap: '8px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>
                        {saving ? '‚è≥ Saving...' : 'üíæ Save Changes'}
                    </button>
                </div>
            </div>

            <div style={{ display: 'grid', gridTemplateColumns: previewMode ? '200px 1fr 350px' : '200px 1fr', gap: '24px' }}>
                <div style={{ ...cardStyle, padding: '16px', height: 'fit-content' }}>
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '4px' }}>
                        {sections.map(section => (
                            <button key={section.id} onClick={() => setActiveSection(section.id)} style={sectionButtonStyle(activeSection === section.id)}>
                                <span>{section.icon}</span>
                                <span>{section.label}</span>
                            </button>
                        ))}
                    </div>
                </div>

                <div style={cardStyle}>
                    {activeSection === 'identity' && (
                        <div>
                            <h3 style={{ margin: '0 0 24px', color: theme.text, fontSize: '16px', fontWeight: '700', textTransform: 'uppercase', letterSpacing: '0.5px', borderBottom: `1px solid ${theme.border}`, paddingBottom: '16px' }}>üè¢ Company Identity</h3>
                            <div style={{ marginBottom: '28px' }}>
                                <label style={labelStyle}>Company Logo</label>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '20px' }}>
                                    <div style={{ width: '100px', height: '100px', background: `linear-gradient(135deg, ${formData.primaryColor || '#3b82f6'} 0%, ${formData.secondaryColor || '#10b981'} 100%)`, borderRadius: '16px', display: 'flex', alignItems: 'center', justifyContent: 'center', color: 'white', boxShadow: '0 4px 12px rgba(0,0,0,0.15)' }}>
                                        {renderLogo()}
                                    </div>
                                    <div>
                                        <input type="file" ref={logoInputRef} onChange={handleLogoUpload} accept="image/*" style={{ display: 'none' }} />
                                        <button onClick={() => logoInputRef.current?.click()} style={{ padding: '10px 20px', background: theme.bgTertiary, color: theme.text, border: `1px solid ${theme.border}`, borderRadius: '0', fontSize: '13px', fontWeight: '600', cursor: 'pointer', marginBottom: '8px', display: 'block' }}>üì§ Upload Logo</button>
                                        {formData.logoUrl && <button onClick={() => setFormData(prev => ({ ...prev, logoUrl: '', logoType: 'icon' }))} style={{ padding: '8px 16px', background: 'transparent', color: '#ef4444', border: 'none', fontSize: '12px', cursor: 'pointer' }}>Remove Logo</button>}
                                        <p style={{ margin: '8px 0 0', fontSize: '12px', color: theme.textSecondary }}>Recommended: 200x200px, PNG or SVG, max 1MB</p>
                                    </div>
                                </div>
                            </div>
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px' }}>
                                <div><label style={labelStyle}>Company Name *</label><input type="text" value={formData.companyName || ''} onChange={(e) => handleInputChange('companyName', e.target.value)} placeholder="e.g., SparkleWash Kenya" style={inputStyle} /></div>
                                <div><label style={labelStyle}>Short Name / Initials</label><input type="text" value={formData.shortName || ''} onChange={(e) => handleInputChange('shortName', e.target.value)} placeholder="e.g., SWK" style={inputStyle} maxLength={5} /></div>
                            </div>
                            <div style={{ marginTop: '20px' }}>
                                <label style={labelStyle}>Tagline / Slogan</label>
                                <input type="text" value={formData.tagline || ''} onChange={(e) => handleInputChange('tagline', e.target.value)} placeholder="e.g., Premium Car Care Services" style={inputStyle} />
                                <p style={{ margin: '8px 0 0', fontSize: '12px', color: theme.textSecondary }}>Appears on login page and loading screen</p>
                            </div>
                        </div>
                    )}

                    {activeSection === 'contact' && (
                        <div>
                            <h3 style={{ margin: '0 0 24px', color: theme.text, fontSize: '16px', fontWeight: '700', textTransform: 'uppercase', letterSpacing: '0.5px', borderBottom: `1px solid ${theme.border}`, paddingBottom: '16px' }}>üìû Contact Information</h3>
                            <p style={{ color: theme.textSecondary, fontSize: '13px', marginBottom: '24px' }}>This information appears on receipts, invoices, and customer-facing documents.</p>
                            <div style={{ marginBottom: '20px' }}><label style={labelStyle}>Business Address</label><input type="text" value={formData.address || ''} onChange={(e) => handleInputChange('address', e.target.value)} placeholder="e.g., 123 Kenyatta Avenue, CBD" style={inputStyle} /></div>
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px', marginBottom: '20px' }}>
                                <div><label style={labelStyle}>City / Town</label><input type="text" value={formData.city || ''} onChange={(e) => handleInputChange('city', e.target.value)} placeholder="e.g., Nairobi" style={inputStyle} /></div>
                                <div><label style={labelStyle}>Phone Number</label><input type="tel" value={formData.phone || ''} onChange={(e) => handleInputChange('phone', e.target.value)} placeholder="e.g., +254 712 345 678" style={inputStyle} /></div>
                            </div>
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px' }}>
                                <div><label style={labelStyle}>Email Address</label><input type="email" value={formData.email || ''} onChange={(e) => handleInputChange('email', e.target.value)} placeholder="e.g., info@sparklewash.co.ke" style={inputStyle} /></div>
                                <div><label style={labelStyle}>Website</label><input type="url" value={formData.website || ''} onChange={(e) => handleInputChange('website', e.target.value)} placeholder="e.g., www.sparklewash.co.ke" style={inputStyle} /></div>
                            </div>
                        </div>
                    )}

                    {activeSection === 'legal' && (
                        <div>
                            <h3 style={{ margin: '0 0 24px', color: theme.text, fontSize: '16px', fontWeight: '700', textTransform: 'uppercase', letterSpacing: '0.5px', borderBottom: `1px solid ${theme.border}`, paddingBottom: '16px' }}>üìã Legal & Tax Information</h3>
                            <p style={{ color: theme.textSecondary, fontSize: '13px', marginBottom: '24px' }}>These details appear on official invoices and tax documents.</p>
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px' }}>
                                <div><label style={labelStyle}>Tax PIN / VAT Number</label><input type="text" value={formData.taxPin || ''} onChange={(e) => handleInputChange('taxPin', e.target.value)} placeholder="e.g., P051234567X" style={inputStyle} /></div>
                                <div><label style={labelStyle}>Business Registration No.</label><input type="text" value={formData.businessReg || ''} onChange={(e) => handleInputChange('businessReg', e.target.value)} placeholder="e.g., PVT-2024-12345" style={inputStyle} /></div>
                            </div>
                            <div style={{ marginTop: '20px' }}>
                                <label style={labelStyle}>Terms & Conditions</label>
                                <textarea value={formData.termsAndConditions || ''} onChange={(e) => handleInputChange('termsAndConditions', e.target.value)} placeholder="Enter your business terms and conditions..." style={{ ...inputStyle, minHeight: '120px', resize: 'vertical' }} />
                                <p style={{ margin: '8px 0 0', fontSize: '12px', color: theme.textSecondary }}>Optional: Appears at the bottom of invoices</p>
                            </div>
                        </div>
                    )}

                    {activeSection === 'colors' && (
                        <div>
                            <h3 style={{ margin: '0 0 24px', color: theme.text, fontSize: '16px', fontWeight: '700', textTransform: 'uppercase', letterSpacing: '0.5px', borderBottom: `1px solid ${theme.border}`, paddingBottom: '16px' }}>üé® Brand Colors</h3>
                            <p style={{ color: theme.textSecondary, fontSize: '13px', marginBottom: '24px' }}>These colors are applied to buttons, accents, headers, and branding elements throughout the system.</p>
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '24px' }}>
                                <div>
                                    <label style={labelStyle}>Primary Color</label>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                                        <input type="color" value={formData.primaryColor || '#3b82f6'} onChange={(e) => handleInputChange('primaryColor', e.target.value)} style={{ width: '60px', height: '40px', border: 'none', cursor: 'pointer', borderRadius: '4px' }} />
                                        <input type="text" value={formData.primaryColor || '#3b82f6'} onChange={(e) => handleInputChange('primaryColor', e.target.value)} style={{ ...inputStyle, flex: 1, fontFamily: 'monospace' }} />
                                    </div>
                                    <p style={{ margin: '8px 0 0', fontSize: '11px', color: theme.textSecondary }}>Main buttons, links, active states</p>
                                </div>
                                <div>
                                    <label style={labelStyle}>Secondary Color</label>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                                        <input type="color" value={formData.secondaryColor || '#10b981'} onChange={(e) => handleInputChange('secondaryColor', e.target.value)} style={{ width: '60px', height: '40px', border: 'none', cursor: 'pointer', borderRadius: '4px' }} />
                                        <input type="text" value={formData.secondaryColor || '#10b981'} onChange={(e) => handleInputChange('secondaryColor', e.target.value)} style={{ ...inputStyle, flex: 1, fontFamily: 'monospace' }} />
                                    </div>
                                    <p style={{ margin: '8px 0 0', fontSize: '11px', color: theme.textSecondary }}>Success states, secondary buttons</p>
                                </div>
                                <div>
                                    <label style={labelStyle}>Accent Color</label>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                                        <input type="color" value={formData.accentColor || '#f59e0b'} onChange={(e) => handleInputChange('accentColor', e.target.value)} style={{ width: '60px', height: '40px', border: 'none', cursor: 'pointer', borderRadius: '4px' }} />
                                        <input type="text" value={formData.accentColor || '#f59e0b'} onChange={(e) => handleInputChange('accentColor', e.target.value)} style={{ ...inputStyle, flex: 1, fontFamily: 'monospace' }} />
                                    </div>
                                    <p style={{ margin: '8px 0 0', fontSize: '11px', color: theme.textSecondary }}>Highlights, warnings, badges</p>
                                </div>
                            </div>
                            <div style={{ marginTop: '32px', padding: '24px', background: theme.bgSecondary, border: `1px solid ${theme.border}` }}>
                                <div style={{ fontSize: '13px', fontWeight: '600', color: theme.text, marginBottom: '16px' }}>Color Preview</div>
                                <div style={{ display: 'flex', gap: '16px', flexWrap: 'wrap' }}>
                                    <button style={{ padding: '10px 24px', background: formData.primaryColor, color: 'white', border: 'none', fontSize: '13px', fontWeight: '600' }}>Primary Button</button>
                                    <button style={{ padding: '10px 24px', background: formData.secondaryColor, color: 'white', border: 'none', fontSize: '13px', fontWeight: '600' }}>Success Button</button>
                                    <button style={{ padding: '10px 24px', background: formData.accentColor, color: 'white', border: 'none', fontSize: '13px', fontWeight: '600' }}>Accent Button</button>
                                    <span style={{ padding: '6px 12px', background: formData.primaryColor + '20', color: formData.primaryColor, fontSize: '12px', fontWeight: '600' }}>Badge</span>
                                </div>
                            </div>
                        </div>
                    )}

                    {activeSection === 'receipts' && (
                        <div>
                            <h3 style={{ margin: '0 0 24px', color: theme.text, fontSize: '16px', fontWeight: '700', textTransform: 'uppercase', letterSpacing: '0.5px', borderBottom: `1px solid ${theme.border}`, paddingBottom: '16px' }}>üßæ Receipts & Invoices</h3>
                            <p style={{ color: theme.textSecondary, fontSize: '13px', marginBottom: '24px' }}>Customize the text that appears on printed receipts and invoices.</p>
                            <div style={{ marginBottom: '20px' }}>
                                <label style={labelStyle}>Receipt Header Text</label>
                                <input type="text" value={formData.receiptHeader || ''} onChange={(e) => handleInputChange('receiptHeader', e.target.value)} placeholder="e.g., OFFICIAL RECEIPT" style={inputStyle} />
                                <p style={{ margin: '8px 0 0', fontSize: '12px', color: theme.textSecondary }}>Appears at the top of receipts after company name</p>
                            </div>
                            <div style={{ marginBottom: '20px' }}>
                                <label style={labelStyle}>Receipt Footer / Thank You Message</label>
                                <input type="text" value={formData.receiptFooter || ''} onChange={(e) => handleInputChange('receiptFooter', e.target.value)} placeholder="e.g., Thank you for choosing SparkleWash!" style={inputStyle} />
                            </div>
                            <div>
                                <label style={labelStyle}>Invoice Footer / Payment Terms</label>
                                <textarea value={formData.invoiceFooter || ''} onChange={(e) => handleInputChange('invoiceFooter', e.target.value)} placeholder="e.g., Payment due within 30 days. Late payments subject to 2% monthly interest." style={{ ...inputStyle, minHeight: '80px', resize: 'vertical' }} />
                            </div>
                        </div>
                    )}

                    {activeSection === 'social' && (
                        <div>
                            <h3 style={{ margin: '0 0 24px', color: theme.text, fontSize: '16px', fontWeight: '700', textTransform: 'uppercase', letterSpacing: '0.5px', borderBottom: `1px solid ${theme.border}`, paddingBottom: '16px' }}>üåê Social Media Links</h3>
                            <p style={{ color: theme.textSecondary, fontSize: '13px', marginBottom: '24px' }}>Optional: Add social media links to display on receipts and invoices.</p>
                            <div style={{ display: 'grid', gap: '20px' }}>
                                <div><label style={labelStyle}>üìò Facebook</label><input type="url" value={formData.facebook || ''} onChange={(e) => handleInputChange('facebook', e.target.value)} placeholder="e.g., https://facebook.com/sparklewash" style={inputStyle} /></div>
                                <div><label style={labelStyle}>üì∏ Instagram</label><input type="url" value={formData.instagram || ''} onChange={(e) => handleInputChange('instagram', e.target.value)} placeholder="e.g., https://instagram.com/sparklewash" style={inputStyle} /></div>
                                <div><label style={labelStyle}>üê¶ Twitter / X</label><input type="url" value={formData.twitter || ''} onChange={(e) => handleInputChange('twitter', e.target.value)} placeholder="e.g., https://twitter.com/sparklewash" style={inputStyle} /></div>
                            </div>
                        </div>
                    )}

                    {activeSection === 'regional' && (
                        <div>
                            <h3 style={{ margin: '0 0 24px', color: theme.text, fontSize: '16px', fontWeight: '700', textTransform: 'uppercase', letterSpacing: '0.5px', borderBottom: `1px solid ${theme.border}`, paddingBottom: '16px' }}>üåç Regional Settings</h3>
                            <p style={{ color: theme.textSecondary, fontSize: '13px', marginBottom: '24px' }}>Configure currency and localization settings.</p>
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px' }}>
                                <div>
                                    <label style={labelStyle}>Currency Code</label>
                                    <select value={formData.currency || 'KES'} onChange={(e) => handleInputChange('currency', e.target.value)} style={inputStyle}>
                                        <option value="KES">KES - Kenyan Shilling</option>
                                        <option value="USD">USD - US Dollar</option>
                                        <option value="EUR">EUR - Euro</option>
                                        <option value="GBP">GBP - British Pound</option>
                                        <option value="TZS">TZS - Tanzanian Shilling</option>
                                        <option value="UGX">UGX - Ugandan Shilling</option>
                                        <option value="ZAR">ZAR - South African Rand</option>
                                        <option value="NGN">NGN - Nigerian Naira</option>
                                    </select>
                                </div>
                                <div><label style={labelStyle}>Currency Symbol</label><input type="text" value={formData.currencySymbol || 'KSh'} onChange={(e) => handleInputChange('currencySymbol', e.target.value)} placeholder="e.g., KSh, $, ‚Ç¨" style={inputStyle} maxLength={5} /></div>
                            </div>
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px', marginTop: '20px' }}>
                                <div>
                                    <label style={labelStyle}>Timezone</label>
                                    <select value={formData.timezone || 'Africa/Nairobi'} onChange={(e) => handleInputChange('timezone', e.target.value)} style={inputStyle}>
                                        <option value="Africa/Nairobi">Africa/Nairobi (EAT)</option>
                                        <option value="Africa/Lagos">Africa/Lagos (WAT)</option>
                                        <option value="Africa/Johannesburg">Africa/Johannesburg (SAST)</option>
                                        <option value="UTC">UTC</option>
                                        <option value="Europe/London">Europe/London</option>
                                        <option value="America/New_York">America/New_York</option>
                                    </select>
                                </div>
                                <div>
                                    <label style={labelStyle}>Date Format</label>
                                    <select value={formData.dateFormat || 'DD/MM/YYYY'} onChange={(e) => handleInputChange('dateFormat', e.target.value)} style={inputStyle}>
                                        <option value="DD/MM/YYYY">DD/MM/YYYY (31/12/2026)</option>
                                        <option value="MM/DD/YYYY">MM/DD/YYYY (12/31/2026)</option>
                                        <option value="YYYY-MM-DD">YYYY-MM-DD (2026-12-31)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    )}
                </div>

                {previewMode && (
                    <div style={{ ...cardStyle, padding: '0', overflow: 'hidden' }}>
                        <div style={{ padding: '16px 20px', background: theme.bgTertiary, borderBottom: `1px solid ${theme.border}` }}>
                            <div style={{ fontSize: '13px', fontWeight: '700', color: theme.text }}>üì± Live Preview</div>
                        </div>
                        <div style={{ padding: '20px', background: '#1e3a5f', minHeight: '200px' }}>
                            <div style={{ textAlign: 'center' }}>
                                <div style={{ width: '64px', height: '64px', background: `linear-gradient(135deg, ${formData.primaryColor || '#3b82f6'} 0%, ${formData.secondaryColor || '#10b981'} 100%)`, borderRadius: '16px', display: 'flex', alignItems: 'center', justifyContent: 'center', margin: '0 auto 12px', color: 'white', fontSize: '24px' }}>
                                    {formData.logoUrl ? <img src={formData.logoUrl} alt="Logo" style={{ width: '80%', height: '80%', objectFit: 'contain' }} /> : <span>{formData.shortName || 'üöó'}</span>}
                                </div>
                                <div style={{ color: 'white', fontSize: '18px', fontWeight: '700', marginBottom: '4px' }}>{formData.companyName || 'Company Name'}</div>
                                <div style={{ color: '#94a3b8', fontSize: '11px' }}>{formData.tagline || 'Your tagline here'}</div>
                            </div>
                        </div>
                        <div style={{ padding: '20px', background: 'white' }}>
                            <div style={{ border: '1px dashed #ccc', padding: '16px', fontFamily: 'monospace', fontSize: '11px', color: '#333' }}>
                                <div style={{ textAlign: 'center', marginBottom: '12px' }}>
                                    <div style={{ fontWeight: 'bold', fontSize: '14px' }}>{formData.companyName || 'COMPANY NAME'}</div>
                                    <div style={{ fontSize: '10px', color: '#666' }}>{formData.address || 'Address'}{formData.city ? `, ${formData.city}` : ''}</div>
                                    <div style={{ fontSize: '10px', color: '#666' }}>{formData.phone || 'Phone'}</div>
                                    {formData.taxPin && <div style={{ fontSize: '10px' }}>PIN: {formData.taxPin}</div>}
                                </div>
                                <div style={{ borderTop: '1px dashed #ccc', borderBottom: '1px dashed #ccc', padding: '8px 0', margin: '8px 0', textAlign: 'center', fontWeight: 'bold' }}>{formData.receiptHeader || 'RECEIPT'}</div>
                                <div style={{ color: '#666', fontSize: '10px' }}>
                                    <div>Item 1............{formData.currencySymbol || 'KSh'} 500</div>
                                    <div>Item 2............{formData.currencySymbol || 'KSh'} 300</div>
                                    <div style={{ borderTop: '1px dashed #ccc', marginTop: '8px', paddingTop: '8px', fontWeight: 'bold' }}>TOTAL..........{formData.currencySymbol || 'KSh'} 800</div>
                                </div>
                                <div style={{ textAlign: 'center', marginTop: '12px', fontSize: '10px', color: '#666' }}>{formData.receiptFooter || 'Thank you!'}</div>
                            </div>
                        </div>
                    </div>
                )}
            </div>
        </div>
    );
}

// ==================== SYSTEM SETTINGS MODULE ====================
function SystemSettings({ initialTab = 'profile' }) {
    const [activeTab, setActiveTab] = useState(initialTab);
    const [loading, setLoading] = useState(false);
    const [successMessage, setSuccessMessage] = useState('');
    const [error, setError] = useState('');
    const { currentUser, userProfile } = useContext(AuthContext);
    
    // Profile form state
    const [profileData, setProfileData] = useState({
        displayName: userProfile?.displayName || '',
        phone: userProfile?.phone || '',
        address: userProfile?.address || ''
    });
    
    // Password change state
    const [passwordData, setPasswordData] = useState({
        currentPassword: '',
        newPassword: '',
        confirmPassword: ''
    });
    
    // Support contacts state
    const [supportContacts, setSupportContacts] = useState({
        email: '',
        phone: '',
        whatsapp: ''
    });
    const [savingContacts, setSavingContacts] = useState(false);
    const [editingContacts, setEditingContacts] = useState(false);
    
    // Complaints state
    const [complaints, setComplaints] = useState([]);
    const [showAddComplaint, setShowAddComplaint] = useState(false);
    const [newComplaint, setNewComplaint] = useState({ subject: '', description: '', priority: 'medium' });
    const [savingComplaint, setSavingComplaint] = useState(false);
    const [showComplaintNotes, setShowComplaintNotes] = useState(null);
    const [complaintNote, setComplaintNote] = useState('');
    const [viewingComplaintResponse, setViewingComplaintResponse] = useState(null);
    
    // Profile image state - sync with userProfile
    const [profileImage, setProfileImage] = useState(userProfile?.photoURL || null);
    const [uploadingImage, setUploadingImage] = useState(false);
    const fileInputRef = React.useRef(null);
    
    // Sync profile image when userProfile changes
    useEffect(() => {
        if (userProfile?.photoURL) {
            setProfileImage(userProfile.photoURL);
        }
    }, [userProfile?.photoURL]);
    
    // Theme detection
    const [isDark, setIsDark] = useState(document.documentElement.getAttribute('data-theme') === 'dark');
    
    // Load support contacts from Firebase
    useEffect(() => {
        const loadContacts = async () => {
            const services = window.FirebaseServices;
            if (services?.settingsService?.getSupportContacts) {
                const result = await services.settingsService.getSupportContacts();
                if (result.success && result.data) {
                    setSupportContacts({
                        email: result.data.email || '',
                        phone: result.data.phone || '',
                        whatsapp: result.data.whatsapp || ''
                    });
                }
            }
        };
        loadContacts();
    }, []);
    
    // Save support contacts
    const handleSaveSupportContacts = async () => {
        setSavingContacts(true);
        try {
            const services = window.FirebaseServices;
            if (services?.settingsService?.saveSupportContacts) {
                const result = await services.settingsService.saveSupportContacts(supportContacts);
                if (result.success) {
                    setSuccessMessage('Support contacts saved successfully!');
                    setEditingContacts(false);
                } else {
                    setError(result.error || 'Failed to save contacts');
                }
            }
        } catch (err) {
            setError(err.message || 'Failed to save contacts');
        } finally {
            setSavingContacts(false);
        }
    };
    
    // Load complaints from Firebase
    useEffect(() => {
        const services = window.FirebaseServices;
        if (services?.complaintsService?.subscribeToComplaints) {
            const unsubscribe = services.complaintsService.subscribeToComplaints((data) => {
                setComplaints(data);
            });
            return () => unsubscribe && unsubscribe();
        }
    }, []);
    
    // Add new complaint
    const handleAddComplaint = async () => {
        if (!newComplaint.subject.trim() || !newComplaint.description.trim()) {
            setError('Please fill in subject and description');
            return;
        }
        setSavingComplaint(true);
        try {
            const services = window.FirebaseServices;
            const complaintData = {
                ...newComplaint,
                status: 'awaiting',
                createdAt: new Date().toISOString(),
                createdBy: currentUser?.email || 'Unknown',
                notes: []
            };
            if (services?.complaintsService?.addComplaint) {
                const result = await services.complaintsService.addComplaint(complaintData);
                if (result.success) {
                    setSuccessMessage('Complaint submitted successfully!');
                    setNewComplaint({ subject: '', description: '', priority: 'medium' });
                    setShowAddComplaint(false);
                } else {
                    setError(result.error || 'Failed to submit complaint');
                }
            }
        } catch (err) {
            setError(err.message || 'Failed to submit complaint');
        } finally {
            setSavingComplaint(false);
        }
    };
    
    // Mark complaint as completed with response
    const handleMarkCompleted = async (complaintId, response = '') => {
        try {
            const services = window.FirebaseServices;
            const complaint = complaints.find(c => c.id === complaintId);
            if (services?.complaintsService?.updateComplaint) {
                const updateData = { 
                    status: 'completed',
                    completedAt: new Date().toISOString(),
                    response: response || complaint?.response || 'Your complaint has been resolved.'
                };
                const result = await services.complaintsService.updateComplaint(complaintId, updateData);
                if (result.success) {
                    setSuccessMessage('Complaint marked as completed!');
                    // Add notification for resolved complaint
                    if (services?.activityService?.logActivity) {
                        await services.activityService.logActivity({
                            type: 'complaint_resolved',
                            title: `Complaint Resolved: #${complaint?.complaintNumber || complaint?.id?.slice(0,8) || 'N/A'}`,
                            description: `Complaint #${complaint?.complaintNumber || 'N/A'} for ${complaint?.customerName || 'Customer'} has been resolved.`,
                            timestamp: new Date().toISOString(),
                            complaintId: complaintId,
                            module: 'customers'
                        });
                    }
                } else {
                    setError(result.error || 'Failed to update complaint');
                }
            }
        } catch (err) {
            setError(err.message || 'Failed to update complaint');
        }
    };
    
    // Add note to complaint
    const handleAddNote = async (complaintId) => {
        if (!complaintNote.trim()) return;
        try {
            const services = window.FirebaseServices;
            const complaint = complaints.find(c => c.id === complaintId);
            const newNote = {
                text: complaintNote,
                addedAt: new Date().toISOString(),
                addedBy: currentUser?.email || 'Unknown'
            };
            const updatedNotes = [...(complaint?.notes || []), newNote];
            if (services?.complaintsService?.updateComplaint) {
                // Update complaint with note as response and send notification
                const result = await services.complaintsService.updateComplaint(complaintId, { 
                    notes: updatedNotes,
                    response: complaintNote,
                    respondedAt: new Date().toISOString(),
                    respondedBy: currentUser?.email || 'Support Team'
                });
                if (result.success) {
                    setSuccessMessage('Response added successfully!');
                    // Log activity for notification
                    if (services?.activityService?.logActivity) {
                        await services.activityService.logActivity({
                            type: 'complaint_response',
                            title: `Response Added: ${complaint?.subject || 'Complaint'}`,
                            description: `A response has been added to your complaint "${complaint?.subject}".`,
                            timestamp: new Date().toISOString(),
                            complaintId: complaintId,
                            module: 'support'
                        });
                    }
                    setComplaintNote('');
                    setShowComplaintNotes(null);
                } else {
                    setError(result.error || 'Failed to add response');
                }
            }
        } catch (err) {
            setError(err.message || 'Failed to add response');
        }
    };
    
    // Toggle theme function
    const toggleTheme = () => {
        const newTheme = isDark ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', newTheme);
        setIsDark(!isDark);
    };
    
    // Handle image upload - Clean implementation with global sync
    const handleImageUpload = async (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        
        // Reset input so same file can be selected again
        e.target.value = '';
        
        // Validate file type
        const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
        if (!validTypes.includes(file.type)) {
            setError('Please select a valid image file (JPG, PNG, GIF, or WEBP)');
            return;
        }
        
        // Validate file size (max 2MB)
        if (file.size > 2 * 1024 * 1024) {
            setError('Image size should be less than 2MB');
            return;
        }
        
        setUploadingImage(true);
        setError('');
        
        try {
            const services = window.FirebaseServices;
            
            if (!services?.storageService || !currentUser) {
                throw new Error('Storage service not available');
            }
            
            // Upload to Firebase Storage
            const result = await services.storageService.uploadProfileImage(currentUser.uid, file);
            
            if (!result.success) {
                throw new Error(result.error || 'Upload failed');
            }
            
            const photoURL = result.url;
            
            // Update user profile in Firestore
            const updateResult = await services.userService.updateUserProfile(currentUser.uid, { photoURL });
            
            if (!updateResult.success) {
                throw new Error(updateResult.error || 'Failed to save photo URL');
            }
            
            // Update local state
            setProfileImage(photoURL);
            
            // Update global userProfile for TopBar sync
            if (window.currentUserProfile) {
                window.currentUserProfile = { ...window.currentUserProfile, photoURL };
            }
            
            // Dispatch custom event to notify TopBar of profile update
            window.dispatchEvent(new CustomEvent('userProfilePhotoUpdated', { detail: { photoURL } }));
            
            setSuccessMessage('Profile photo updated successfully!');
            
        } catch (err) {
            console.error('Photo upload error:', err);
            setError(err.message || 'Failed to upload photo. Please try again.');
        } finally {
            setUploadingImage(false);
        }
    };

    useEffect(() => {
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.attributeName === 'data-theme') {
                    setIsDark(document.documentElement.getAttribute('data-theme') === 'dark');
                }
            });
        });
        observer.observe(document.documentElement, { attributes: true });
        return () => observer.disconnect();
    }, []);

    const theme = {
        bg: isDark ? '#1e293b' : 'white',
        bgSecondary: isDark ? '#0f172a' : '#f8fafc',
        bgTertiary: isDark ? '#334155' : '#f1f5f9',
        text: isDark ? '#f1f5f9' : '#1e293b',
        textSecondary: isDark ? '#94a3b8' : '#64748b',
        border: isDark ? '#334155' : '#e2e8f0',
        inputBg: isDark ? '#1e293b' : 'white',
        cardShadow: isDark ? '0 2px 8px rgba(0,0,0,0.3)' : '0 2px 8px rgba(0,0,0,0.08)',
    };

    // Auto-hide messages
    useEffect(() => {
        if (successMessage) {
            const timer = setTimeout(() => setSuccessMessage(''), 3000);
            return () => clearTimeout(timer);
        }
    }, [successMessage]);

    useEffect(() => {
        if (error) {
            const timer = setTimeout(() => setError(''), 5000);
            return () => clearTimeout(timer);
        }
    }, [error]);

    // Update profile data when userProfile changes
    useEffect(() => {
        if (userProfile) {
            setProfileData({
                displayName: userProfile.displayName || '',
                phone: userProfile.phone || '',
                address: userProfile.address || ''
            });
        }
    }, [userProfile]);

    const handleProfileUpdate = async () => {
        if (!profileData.displayName.trim()) {
            setError('Display name is required');
            return;
        }
        
        setLoading(true);
        try {
            const services = window.FirebaseServices;
            if (services?.userService && currentUser) {
                const result = await services.userService.updateUserProfile(currentUser.uid, {
                    displayName: profileData.displayName.trim(),
                    phone: profileData.phone.trim(),
                    address: profileData.address.trim()
                });
                
                if (result.success) {
                    setSuccessMessage('Profile updated successfully!');
                } else {
                    setError(result.error || 'Failed to update profile');
                }
            }
        } catch (err) {
            setError(err.message || 'Failed to update profile');
        } finally {
            setLoading(false);
        }
    };

    const handlePasswordChange = async () => {
        if (!passwordData.newPassword || !passwordData.confirmPassword) {
            setError('Please fill in all password fields');
            return;
        }
        if (passwordData.newPassword !== passwordData.confirmPassword) {
            setError('New passwords do not match');
            return;
        }
        if (passwordData.newPassword.length < 6) {
            setError('Password must be at least 6 characters');
            return;
        }
        
        setLoading(true);
        try {
            const services = window.FirebaseServices;
            if (services?.authService) {
                const result = await services.authService.updatePassword(passwordData.newPassword);
                if (result.success) {
                    setSuccessMessage('Password changed successfully!');
                    setPasswordData({ currentPassword: '', newPassword: '', confirmPassword: '' });
                } else {
                    setError(result.error || 'Failed to change password');
                }
            }
        } catch (err) {
            setError(err.message || 'Failed to change password');
        } finally {
            setLoading(false);
        }
    };

    const tabs = [
        { id: 'profile', label: 'My Profile', icon: 'üë§' },
        { id: 'account', label: 'Account Settings', icon: '‚öôÔ∏è' },
        { id: 'branding', label: 'Branding', icon: 'üé®' },
        { id: 'support', label: 'Help & Support', icon: '‚ùì' }
    ];

    const inputStyle = {
        width: '100%',
        padding: '12px 14px',
        border: `1px solid ${theme.border}`,
        borderRadius: '0',
        fontSize: '14px',
        backgroundColor: theme.inputBg,
        color: theme.text,
        outline: 'none',
        transition: 'border-color 0.2s',
        boxSizing: 'border-box'
    };

    const labelStyle = {
        display: 'block',
        marginBottom: '8px',
        fontSize: '13px',
        fontWeight: '600',
        color: theme.text,
        textTransform: 'uppercase',
        letterSpacing: '0.5px'
    };

    const cardStyle = {
        background: theme.bg,
        border: `1px solid ${theme.border}`,
        borderRadius: '0',
        padding: '28px',
        marginBottom: '24px',
        boxShadow: theme.cardShadow
    };

    return (
        <div style={{ padding: '0', maxWidth: '100%' }}>
            {/* Messages */}
            {successMessage && (
                <div style={{ 
                    padding: '14px 20px', 
                    background: '#dcfce7', 
                    border: '1px solid #86efac', 
                    borderRadius: '0', 
                    color: '#166534', 
                    marginBottom: '24px',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '10px',
                    fontWeight: '500'
                }}>
                    <span>‚úì</span> {successMessage}
                </div>
            )}
            {error && (
                <div style={{ 
                    padding: '14px 20px', 
                    background: '#fef2f2', 
                    border: '1px solid #fecaca', 
                    borderRadius: '0', 
                    color: '#dc2626', 
                    marginBottom: '24px',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '10px',
                    fontWeight: '500'
                }}>
                    <span>‚úï</span> {error}
                </div>
            )}

            {/* Tabs */}
            <div style={{ 
                display: 'flex', 
                gap: '0', 
                marginBottom: '32px',
                background: 'transparent',
                borderBottom: `2px solid ${theme.border}`
            }}>
                {tabs.map(tab => (
                    <button
                        key={tab.id}
                        onClick={() => setActiveTab(tab.id)}
                        style={{
                            padding: '14px 28px',
                            border: 'none',
                            borderBottom: activeTab === tab.id ? '2px solid #3b82f6' : '2px solid transparent',
                            marginBottom: '-2px',
                            borderRadius: '0',
                            background: 'transparent',
                            color: activeTab === tab.id ? '#3b82f6' : theme.textSecondary,
                            fontWeight: activeTab === tab.id ? '600' : '500',
                            fontSize: '14px',
                            cursor: 'pointer',
                            transition: 'all 0.2s',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '10px'
                        }}
                    >
                        <span style={{ fontSize: '16px' }}>{tab.icon}</span>
                        {tab.label}
                    </button>
                ))}
            </div>

            {/* Profile Tab */}
            {activeTab === 'profile' && (
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '24px' }}>
                    {/* Left Column - Profile Card */}
                    <div style={cardStyle}>
                        <h3 style={{ margin: '0 0 24px', color: theme.text, fontSize: '16px', fontWeight: '700', textTransform: 'uppercase', letterSpacing: '0.5px', borderBottom: `1px solid ${theme.border}`, paddingBottom: '16px' }}>
                            Profile Information
                        </h3>
                        
                        {/* Profile Photo Section - Clean Design */}
                        <div style={{ 
                            display: 'flex', 
                            flexDirection: 'column',
                            alignItems: 'center', 
                            marginBottom: '32px',
                            padding: '32px 24px',
                            background: theme.bgSecondary,
                            border: `1px solid ${theme.border}`,
                            borderRadius: '8px'
                        }}>
                            {/* Hidden file input */}
                            <input
                                type="file"
                                ref={fileInputRef}
                                onChange={handleImageUpload}
                                accept="image/jpeg,image/png,image/gif,image/webp"
                                style={{ display: 'none' }}
                            />
                            
                            {/* Profile Photo */}
                            <div style={{ position: 'relative', marginBottom: '20px' }}>
                                {profileImage ? (
                                    <img 
                                        src={profileImage} 
                                        alt="Profile" 
                                        style={{
                                            width: '120px',
                                            height: '120px',
                                            borderRadius: '50%',
                                            objectFit: 'cover',
                                            border: `4px solid ${isDark ? '#3b82f6' : '#dbeafe'}`,
                                            boxShadow: '0 4px 12px rgba(0,0,0,0.15)'
                                        }}
                                    />
                                ) : (
                                    <div style={{
                                        width: '120px',
                                        height: '120px',
                                        borderRadius: '50%',
                                        background: 'linear-gradient(135deg, #3b82f6 0%, #1e40af 100%)',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        color: 'white',
                                        fontSize: '48px',
                                        fontWeight: '700',
                                        border: `4px solid ${isDark ? '#1e40af' : '#dbeafe'}`,
                                        boxShadow: '0 4px 12px rgba(59,130,246,0.3)'
                                    }}>
                                        {(userProfile?.displayName || userProfile?.email || 'U').charAt(0).toUpperCase()}
                                    </div>
                                )}
                                
                                {/* Upload indicator overlay */}
                                {uploadingImage && (
                                    <div style={{
                                        position: 'absolute',
                                        top: 0,
                                        left: 0,
                                        right: 0,
                                        bottom: 0,
                                        borderRadius: '50%',
                                        background: 'rgba(0,0,0,0.6)',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        color: 'white',
                                        fontSize: '14px',
                                        fontWeight: '600'
                                    }}>
                                        Uploading...
                                    </div>
                                )}
                            </div>
                            
                            {/* User Info */}
                            <div style={{ textAlign: 'center', marginBottom: '20px' }}>
                                {userProfile?.userId && (
                                    <div style={{ marginBottom: '8px' }}>
                                        <span style={{ fontFamily: 'monospace', fontWeight: '700', padding: '6px 14px', background: '#8b5cf620', color: '#8b5cf6', borderRadius: '6px', fontSize: '14px', letterSpacing: '1px' }}>
                                            ID: {userProfile.userId}
                                        </span>
                                    </div>
                                )}
                                <div style={{ fontSize: '20px', fontWeight: '700', color: theme.text, marginBottom: '4px' }}>
                                    {userProfile?.displayName || userProfile?.email?.split('@')[0] || 'User'}
                                </div>
                                <div style={{ fontSize: '14px', color: theme.textSecondary, marginBottom: '12px' }}>
                                    {userProfile?.email}
                                </div>
                                <div style={{ 
                                    display: 'inline-block',
                                    padding: '6px 16px',
                                    background: '#3b82f6',
                                    color: 'white',
                                    fontSize: '11px',
                                    fontWeight: '600',
                                    textTransform: 'uppercase',
                                    letterSpacing: '0.5px',
                                    borderRadius: '20px'
                                }}>
                                    {userProfile?.role || 'User'}
                                </div>
                            </div>
                            
                            {/* Upload Button */}
                            <button
                                onClick={() => fileInputRef.current?.click()}
                                disabled={uploadingImage}
                                style={{
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '8px',
                                    padding: '10px 20px',
                                    background: uploadingImage ? theme.bgTertiary : (isDark ? '#334155' : '#f1f5f9'),
                                    color: uploadingImage ? theme.textSecondary : theme.text,
                                    border: `1px solid ${theme.border}`,
                                    borderRadius: '8px',
                                    fontSize: '13px',
                                    fontWeight: '500',
                                    cursor: uploadingImage ? 'wait' : 'pointer',
                                    transition: 'all 0.2s'
                                }}
                                onMouseEnter={(e) => {
                                    if (!uploadingImage) {
                                        e.currentTarget.style.background = isDark ? '#475569' : '#e2e8f0';
                                    }
                                }}
                                onMouseLeave={(e) => {
                                    if (!uploadingImage) {
                                        e.currentTarget.style.background = isDark ? '#334155' : '#f1f5f9';
                                    }
                                }}
                            >
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                    <polyline points="17 8 12 3 7 8"/>
                                    <line x1="12" y1="3" x2="12" y2="15"/>
                                </svg>
                                {uploadingImage ? 'Uploading...' : (profileImage ? 'Change Photo' : 'Upload Photo')}
                            </button>
                            
                            {/* Helper text */}
                            <div style={{ marginTop: '12px', fontSize: '11px', color: theme.textSecondary, textAlign: 'center' }}>
                                JPG, PNG, GIF or WEBP ‚Ä¢ Max 2MB
                            </div>
                        </div>

                        {/* Profile Form */}
                        <div style={{ display: 'grid', gap: '20px' }}>
                            <div>
                                <label style={labelStyle}>Display Name</label>
                                <input
                                    type="text"
                                    value={profileData.displayName}
                                    onChange={(e) => setProfileData(prev => ({ ...prev, displayName: e.target.value }))}
                                    placeholder="Enter your name"
                                    style={inputStyle}
                                />
                            </div>
                            <div>
                                <label style={labelStyle}>Phone Number</label>
                                <input
                                    type="tel"
                                    value={profileData.phone}
                                    onChange={(e) => setProfileData(prev => ({ ...prev, phone: e.target.value }))}
                                    placeholder="Enter phone number"
                                    style={inputStyle}
                                />
                            </div>
                            <div>
                                <label style={labelStyle}>Address</label>
                                <input
                                    type="text"
                                    value={profileData.address}
                                    onChange={(e) => setProfileData(prev => ({ ...prev, address: e.target.value }))}
                                    placeholder="Enter your address"
                                    style={inputStyle}
                                />
                            </div>
                        </div>

                        <div style={{ marginTop: '28px', display: 'flex', justifyContent: 'flex-end' }}>
                            <button
                                onClick={handleProfileUpdate}
                                disabled={loading}
                                style={{
                                    padding: '12px 32px',
                                    background: loading ? '#93c5fd' : '#3b82f6',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '0',
                                    fontSize: '13px',
                                    fontWeight: '600',
                                    cursor: loading ? 'wait' : 'pointer',
                                    textTransform: 'uppercase',
                                    letterSpacing: '0.5px'
                                }}
                            >
                                {loading ? 'Saving...' : 'Save Changes'}
                            </button>
                        </div>
                    </div>

                    {/* Right Column - Account Info */}
                    <div>
                        <div style={cardStyle}>
                            <h3 style={{ margin: '0 0 24px', color: theme.text, fontSize: '16px', fontWeight: '700', textTransform: 'uppercase', letterSpacing: '0.5px', borderBottom: `1px solid ${theme.border}`, paddingBottom: '16px' }}>
                                Account Details
                            </h3>
                            <div style={{ display: 'grid', gap: '16px' }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', padding: '14px 16px', background: theme.bgSecondary, border: `1px solid ${theme.border}` }}>
                                    <span style={{ color: theme.textSecondary, fontWeight: '500' }}>Email Address</span>
                                    <span style={{ color: theme.text, fontWeight: '600' }}>{userProfile?.email || '-'}</span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', padding: '14px 16px', background: theme.bgSecondary, border: `1px solid ${theme.border}` }}>
                                    <span style={{ color: theme.textSecondary, fontWeight: '500' }}>Role</span>
                                    <span style={{ color: theme.text, fontWeight: '600', textTransform: 'capitalize' }}>{userProfile?.role || 'User'}</span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', padding: '14px 16px', background: theme.bgSecondary, border: `1px solid ${theme.border}` }}>
                                    <span style={{ color: theme.textSecondary, fontWeight: '500' }}>Status</span>
                                    <span style={{ color: '#22c55e', fontWeight: '600' }}>‚óè Active</span>
                                </div>
                            </div>
                        </div>

                        <div style={cardStyle}>
                            <h3 style={{ margin: '0 0 24px', color: theme.text, fontSize: '16px', fontWeight: '700', textTransform: 'uppercase', letterSpacing: '0.5px', borderBottom: `1px solid ${theme.border}`, paddingBottom: '16px' }}>
                                Session Info
                            </h3>
                            <div style={{ display: 'grid', gap: '16px' }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', padding: '14px 16px', background: theme.bgSecondary, border: `1px solid ${theme.border}` }}>
                                    <span style={{ color: theme.textSecondary, fontWeight: '500' }}>Last Login</span>
                                    <span style={{ color: theme.text, fontSize: '13px' }}>{currentUser?.metadata?.lastSignInTime ? new Date(currentUser.metadata.lastSignInTime).toLocaleDateString() : '-'}</span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', padding: '14px 16px', background: theme.bgSecondary, border: `1px solid ${theme.border}` }}>
                                    <span style={{ color: theme.textSecondary, fontWeight: '500' }}>Member Since</span>
                                    <span style={{ color: theme.text, fontSize: '13px' }}>{currentUser?.metadata?.creationTime ? new Date(currentUser.metadata.creationTime).toLocaleDateString() : '-'}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* Account Settings Tab */}
            {activeTab === 'account' && (
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '24px' }}>
                    {/* Left Column */}
                    <div>
                        {/* Change Password */}
                        <div style={cardStyle}>
                            <h3 style={{ margin: '0 0 24px', color: theme.text, fontSize: '16px', fontWeight: '700', textTransform: 'uppercase', letterSpacing: '0.5px', borderBottom: `1px solid ${theme.border}`, paddingBottom: '16px' }}>
                                üîê Change Password
                            </h3>
                            <div style={{ display: 'grid', gap: '20px' }}>
                                <div>
                                    <label style={labelStyle}>New Password</label>
                                    <input
                                        type="password"
                                        value={passwordData.newPassword}
                                        onChange={(e) => setPasswordData(prev => ({ ...prev, newPassword: e.target.value }))}
                                        placeholder="Enter new password"
                                        style={inputStyle}
                                    />
                                </div>
                                <div>
                                    <label style={labelStyle}>Confirm New Password</label>
                                    <input
                                        type="password"
                                        value={passwordData.confirmPassword}
                                        onChange={(e) => setPasswordData(prev => ({ ...prev, confirmPassword: e.target.value }))}
                                        placeholder="Confirm new password"
                                        style={inputStyle}
                                    />
                                </div>
                                <button
                                    onClick={handlePasswordChange}
                                    disabled={loading}
                                    style={{
                                        padding: '12px 32px',
                                        background: loading ? '#fca5a5' : '#ef4444',
                                        color: 'white',
                                        border: 'none',
                                        borderRadius: '0',
                                        fontSize: '13px',
                                        fontWeight: '600',
                                        cursor: loading ? 'wait' : 'pointer',
                                        width: 'fit-content',
                                        textTransform: 'uppercase',
                                        letterSpacing: '0.5px'
                                    }}
                                >
                                    {loading ? 'Changing...' : 'Change Password'}
                                </button>
                            </div>
                        </div>

                        {/* Preferences */}
                        <div style={cardStyle}>
                            <h3 style={{ margin: '0 0 24px', color: theme.text, fontSize: '16px', fontWeight: '700', textTransform: 'uppercase', letterSpacing: '0.5px', borderBottom: `1px solid ${theme.border}`, paddingBottom: '16px' }}>
                                üé® Preferences
                            </h3>
                            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', padding: '16px', background: theme.bgSecondary, border: `1px solid ${theme.border}` }}>
                                <div>
                                    <div style={{ color: theme.text, fontWeight: '600' }}>Dark Mode</div>
                                    <div style={{ color: theme.textSecondary, fontSize: '13px', marginTop: '4px' }}>Toggle dark/light theme</div>
                                </div>
                                <button
                                    onClick={toggleTheme}
                                    style={{ 
                                        padding: '10px 20px', 
                                        background: isDark ? '#3b82f6' : '#e2e8f0', 
                                        color: isDark ? 'white' : '#64748b',
                                        fontSize: '12px',
                                        fontWeight: '600',
                                        textTransform: 'uppercase',
                                        letterSpacing: '0.5px',
                                        border: 'none',
                                        cursor: 'pointer',
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '8px',
                                        transition: 'all 0.2s'
                                    }}
                                >
                                    {isDark ? 'üåô' : '‚òÄÔ∏è'} {isDark ? 'Dark' : 'Light'}
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* Right Column */}
                    <div>
                        {/* Session Info */}
                        <div style={cardStyle}>
                            <h3 style={{ margin: '0 0 24px', color: theme.text, fontSize: '16px', fontWeight: '700', textTransform: 'uppercase', letterSpacing: '0.5px', borderBottom: `1px solid ${theme.border}`, paddingBottom: '16px' }}>
                                üì± Session Information
                            </h3>
                            <div style={{ display: 'grid', gap: '16px' }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', padding: '14px 16px', background: theme.bgSecondary, border: `1px solid ${theme.border}` }}>
                                    <span style={{ color: theme.textSecondary, fontWeight: '500' }}>User ID</span>
                                    <span style={{ color: theme.text, fontFamily: 'monospace', fontSize: '11px' }}>{currentUser?.uid ? currentUser.uid.substring(0, 16) + '...' : '-'}</span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', padding: '14px 16px', background: theme.bgSecondary, border: `1px solid ${theme.border}` }}>
                                    <span style={{ color: theme.textSecondary, fontWeight: '500' }}>Last Sign In</span>
                                    <span style={{ color: theme.text, fontSize: '13px' }}>{currentUser?.metadata?.lastSignInTime ? new Date(currentUser.metadata.lastSignInTime).toLocaleString() : '-'}</span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', padding: '14px 16px', background: theme.bgSecondary, border: `1px solid ${theme.border}` }}>
                                    <span style={{ color: theme.textSecondary, fontWeight: '500' }}>Account Created</span>
                                    <span style={{ color: theme.text, fontSize: '13px' }}>{currentUser?.metadata?.creationTime ? new Date(currentUser.metadata.creationTime).toLocaleString() : '-'}</span>
                                </div>
                            </div>
                        </div>

                        {/* Security Status */}
                        <div style={cardStyle}>
                            <h3 style={{ margin: '0 0 24px', color: theme.text, fontSize: '16px', fontWeight: '700', textTransform: 'uppercase', letterSpacing: '0.5px', borderBottom: `1px solid ${theme.border}`, paddingBottom: '16px' }}>
                                üîí Security Status
                            </h3>
                            <div style={{ display: 'grid', gap: '16px' }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '14px 16px', background: theme.bgSecondary, border: `1px solid ${theme.border}` }}>
                                    <span style={{ color: theme.textSecondary, fontWeight: '500' }}>Email Verified</span>
                                    <span style={{ color: currentUser?.emailVerified ? '#22c55e' : '#f59e0b', fontWeight: '600' }}>
                                        {currentUser?.emailVerified ? '‚óè Verified' : '‚óã Pending'}
                                    </span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '14px 16px', background: theme.bgSecondary, border: `1px solid ${theme.border}` }}>
                                    <span style={{ color: theme.textSecondary, fontWeight: '500' }}>Account Status</span>
                                    <span style={{ color: '#22c55e', fontWeight: '600' }}>‚óè Active</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* Branding Tab */}
            {activeTab === 'branding' && (
                <BrandingSettings theme={theme} cardStyle={cardStyle} inputStyle={inputStyle} labelStyle={labelStyle} />
            )}

            {/* Help & Support Tab */}
            {activeTab === 'support' && (
                <div>
                    {/* Quick Help */}
                    <div style={cardStyle}>
                        <h3 style={{ margin: '0 0 24px', color: theme.text, fontSize: '16px', fontWeight: '700', textTransform: 'uppercase', letterSpacing: '0.5px', borderBottom: `1px solid ${theme.border}`, paddingBottom: '16px' }}>
                            üìö Quick Help
                        </h3>
                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '20px' }}>
                            {[
                                { icon: 'üöó', title: 'Vehicle Intake', desc: 'Register vehicles and manage queue' },
                                { icon: 'üí≥', title: 'Billing & Payments', desc: 'Process payments and invoices' },
                                { icon: 'üë•', title: 'Customer Management', desc: 'Manage customers and loyalty' },
                                { icon: 'üìä', title: 'Reports', desc: 'Analytics and performance' }
                            ].map((item, idx) => (
                                <div key={idx} style={{ 
                                    padding: '20px', 
                                    background: theme.bgSecondary, 
                                    border: `1px solid ${theme.border}`,
                                    cursor: 'pointer',
                                    transition: 'all 0.2s',
                                    textAlign: 'center'
                                }}>
                                    <div style={{ fontSize: '32px', marginBottom: '12px' }}>{item.icon}</div>
                                    <div style={{ fontWeight: '600', color: theme.text, marginBottom: '6px', fontSize: '14px' }}>{item.title}</div>
                                    <div style={{ fontSize: '12px', color: theme.textSecondary }}>{item.desc}</div>
                                </div>
                            ))}
                        </div>
                    </div>

                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '24px' }}>
                        {/* Contact Support - Editable */}
                        <div style={cardStyle}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', margin: '0 0 24px', borderBottom: `1px solid ${theme.border}`, paddingBottom: '16px' }}>
                                <h3 style={{ margin: 0, color: theme.text, fontSize: '16px', fontWeight: '700', textTransform: 'uppercase', letterSpacing: '0.5px' }}>
                                    üìû Contact Support
                                </h3>
                                {!editingContacts ? (
                                    <button
                                        onClick={() => setEditingContacts(true)}
                                        style={{
                                            background: 'transparent',
                                            border: `1px solid ${theme.border}`,
                                            color: theme.text,
                                            padding: '6px 12px',
                                            borderRadius: '6px',
                                            fontSize: '12px',
                                            fontWeight: '500',
                                            cursor: 'pointer',
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '6px'
                                        }}
                                    >
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                        </svg>
                                        Edit
                                    </button>
                                ) : (
                                    <div style={{ display: 'flex', gap: '8px' }}>
                                        <button
                                            onClick={() => setEditingContacts(false)}
                                            style={{
                                                background: 'transparent',
                                                border: `1px solid ${theme.border}`,
                                                color: theme.textSecondary,
                                                padding: '6px 12px',
                                                borderRadius: '6px',
                                                fontSize: '12px',
                                                fontWeight: '500',
                                                cursor: 'pointer'
                                            }}
                                        >
                                            Cancel
                                        </button>
                                        <button
                                            onClick={handleSaveSupportContacts}
                                            disabled={savingContacts}
                                            style={{
                                                background: '#3b82f6',
                                                border: 'none',
                                                color: 'white',
                                                padding: '6px 12px',
                                                borderRadius: '6px',
                                                fontSize: '12px',
                                                fontWeight: '600',
                                                cursor: savingContacts ? 'not-allowed' : 'pointer',
                                                display: 'flex',
                                                alignItems: 'center',
                                                gap: '6px'
                                            }}
                                        >
                                            {savingContacts ? 'Saving...' : 'Save'}
                                        </button>
                                    </div>
                                )}
                            </div>
                            <div style={{ display: 'grid', gap: '16px' }}>
                                {/* Email Support */}
                                <div style={{ display: 'flex', alignItems: 'center', gap: '16px', padding: '18px', background: theme.bgSecondary, border: `1px solid ${theme.border}` }}>
                                    <div style={{ width: '44px', height: '44px', background: '#3b82f6', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '20px', color: 'white', flexShrink: 0 }}>üìß</div>
                                    <div style={{ flex: 1 }}>
                                        <div style={{ fontWeight: '600', color: theme.text, fontSize: '14px', marginBottom: editingContacts ? '8px' : '2px' }}>Email Support</div>
                                        {editingContacts ? (
                                            <input
                                                type="email"
                                                value={supportContacts.email}
                                                onChange={(e) => setSupportContacts(prev => ({ ...prev, email: e.target.value }))}
                                                placeholder="Enter support email..."
                                                style={{
                                                    width: '100%',
                                                    padding: '8px 12px',
                                                    border: `1px solid ${theme.border}`,
                                                    borderRadius: '6px',
                                                    fontSize: '13px',
                                                    background: theme.inputBg,
                                                    color: theme.text,
                                                    outline: 'none'
                                                }}
                                            />
                                        ) : (
                                            <div style={{ fontSize: '13px', color: supportContacts.email ? theme.textSecondary : '#94a3b8', marginTop: '2px' }}>
                                                {supportContacts.email || 'Not set - Click Edit to add'}
                                            </div>
                                        )}
                                    </div>
                                </div>
                                {/* Phone Support */}
                                <div style={{ display: 'flex', alignItems: 'center', gap: '16px', padding: '18px', background: theme.bgSecondary, border: `1px solid ${theme.border}` }}>
                                    <div style={{ width: '44px', height: '44px', background: '#22c55e', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '20px', color: 'white', flexShrink: 0 }}>üì±</div>
                                    <div style={{ flex: 1 }}>
                                        <div style={{ fontWeight: '600', color: theme.text, fontSize: '14px', marginBottom: editingContacts ? '8px' : '2px' }}>Phone Support</div>
                                        {editingContacts ? (
                                            <input
                                                type="tel"
                                                value={supportContacts.phone}
                                                onChange={(e) => setSupportContacts(prev => ({ ...prev, phone: e.target.value }))}
                                                placeholder="Enter phone number..."
                                                style={{
                                                    width: '100%',
                                                    padding: '8px 12px',
                                                    border: `1px solid ${theme.border}`,
                                                    borderRadius: '6px',
                                                    fontSize: '13px',
                                                    background: theme.inputBg,
                                                    color: theme.text,
                                                    outline: 'none'
                                                }}
                                            />
                                        ) : (
                                            <div style={{ fontSize: '13px', color: supportContacts.phone ? theme.textSecondary : '#94a3b8', marginTop: '2px' }}>
                                                {supportContacts.phone || 'Not set - Click Edit to add'}
                                            </div>
                                        )}
                                    </div>
                                </div>
                                {/* WhatsApp */}
                                <div style={{ display: 'flex', alignItems: 'center', gap: '16px', padding: '18px', background: theme.bgSecondary, border: `1px solid ${theme.border}` }}>
                                    <div style={{ width: '44px', height: '44px', background: '#22c55e', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '20px', color: 'white', flexShrink: 0 }}>üí¨</div>
                                    <div style={{ flex: 1 }}>
                                        <div style={{ fontWeight: '600', color: theme.text, fontSize: '14px', marginBottom: editingContacts ? '8px' : '2px' }}>WhatsApp</div>
                                        {editingContacts ? (
                                            <input
                                                type="tel"
                                                value={supportContacts.whatsapp}
                                                onChange={(e) => setSupportContacts(prev => ({ ...prev, whatsapp: e.target.value }))}
                                                placeholder="Enter WhatsApp number..."
                                                style={{
                                                    width: '100%',
                                                    padding: '8px 12px',
                                                    border: `1px solid ${theme.border}`,
                                                    borderRadius: '6px',
                                                    fontSize: '13px',
                                                    background: theme.inputBg,
                                                    color: theme.text,
                                                    outline: 'none'
                                                }}
                                            />
                                        ) : (
                                            <div style={{ fontSize: '13px', color: supportContacts.whatsapp ? theme.textSecondary : '#94a3b8', marginTop: '2px' }}>
                                                {supportContacts.whatsapp || 'Not set - Click Edit to add'}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* System Info */}
                        <div style={cardStyle}>
                            <h3 style={{ margin: '0 0 24px', color: theme.text, fontSize: '16px', fontWeight: '700', textTransform: 'uppercase', letterSpacing: '0.5px', borderBottom: `1px solid ${theme.border}`, paddingBottom: '16px' }}>
                                ‚ÑπÔ∏è System Information
                            </h3>
                            <div style={{ display: 'grid', gap: '0' }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', padding: '14px 0', borderBottom: `1px solid ${theme.border}` }}>
                                    <span style={{ color: theme.textSecondary, fontWeight: '500' }}>Application</span>
                                    <span style={{ color: theme.text, fontWeight: '600' }}>EcoSpark</span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', padding: '14px 0', borderBottom: `1px solid ${theme.border}` }}>
                                    <span style={{ color: theme.textSecondary, fontWeight: '500' }}>Version</span>
                                    <span style={{ color: theme.text }}>1.0.0</span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', padding: '14px 0' }}>
                                    <span style={{ color: theme.textSecondary, fontWeight: '500' }}>Last Updated</span>
                                    <span style={{ color: theme.text }}>January 2026</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Complaints Section */}
                    <div style={cardStyle}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', margin: '0 0 24px', borderBottom: `1px solid ${theme.border}`, paddingBottom: '16px' }}>
                            <h3 style={{ margin: 0, color: theme.text, fontSize: '16px', fontWeight: '700', textTransform: 'uppercase', letterSpacing: '0.5px' }}>
                                üìã Complaints
                            </h3>
                            <button
                                onClick={() => setShowAddComplaint(true)}
                                style={{
                                    background: '#3b82f6',
                                    border: 'none',
                                    color: 'white',
                                    padding: '8px 16px',
                                    fontSize: '13px',
                                    fontWeight: '600',
                                    cursor: 'pointer',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '8px'
                                }}
                            >
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                    <line x1="12" y1="5" x2="12" y2="19"/>
                                    <line x1="5" y1="12" x2="19" y2="12"/>
                                </svg>
                                Add Complaint
                            </button>
                        </div>

                        {/* Add Complaint Modal */}
                        {showAddComplaint && (
                            <div style={{
                                position: 'fixed',
                                top: 0,
                                left: 0,
                                right: 0,
                                bottom: 0,
                                background: 'rgba(0,0,0,0.5)',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                zIndex: 9999
                            }}>
                                <div style={{
                                    background: theme.bg,
                                    width: '500px',
                                    maxWidth: '90%',
                                    border: `1px solid ${theme.border}`
                                }}>
                                    <div style={{ padding: '20px', borderBottom: `1px solid ${theme.border}` }}>
                                        <h3 style={{ margin: 0, color: theme.text, fontSize: '16px', fontWeight: '700' }}>Submit New Complaint</h3>
                                    </div>
                                    <div style={{ padding: '20px', display: 'grid', gap: '16px' }}>
                                        <div>
                                            <label style={{ display: 'block', marginBottom: '8px', fontWeight: '600', fontSize: '13px', color: theme.text }}>Subject *</label>
                                            <input
                                                type="text"
                                                value={newComplaint.subject}
                                                onChange={(e) => setNewComplaint(prev => ({ ...prev, subject: e.target.value }))}
                                                placeholder="Brief subject of your complaint..."
                                                style={{
                                                    width: '100%',
                                                    padding: '10px 14px',
                                                    border: `1px solid ${theme.border}`,
                                                    fontSize: '14px',
                                                    background: theme.inputBg,
                                                    color: theme.text,
                                                    outline: 'none'
                                                }}
                                            />
                                        </div>
                                        <div>
                                            <label style={{ display: 'block', marginBottom: '8px', fontWeight: '600', fontSize: '13px', color: theme.text }}>Priority</label>
                                            <select
                                                value={newComplaint.priority}
                                                onChange={(e) => setNewComplaint(prev => ({ ...prev, priority: e.target.value }))}
                                                style={{
                                                    width: '100%',
                                                    padding: '10px 14px',
                                                    border: `1px solid ${theme.border}`,
                                                    fontSize: '14px',
                                                    background: theme.inputBg,
                                                    color: theme.text,
                                                    outline: 'none'
                                                }}
                                            >
                                                <option value="low">Low</option>
                                                <option value="medium">Medium</option>
                                                <option value="high">High</option>
                                                <option value="urgent">Urgent</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label style={{ display: 'block', marginBottom: '8px', fontWeight: '600', fontSize: '13px', color: theme.text }}>Description *</label>
                                            <textarea
                                                value={newComplaint.description}
                                                onChange={(e) => setNewComplaint(prev => ({ ...prev, description: e.target.value }))}
                                                placeholder="Describe your complaint in detail..."
                                                rows={4}
                                                style={{
                                                    width: '100%',
                                                    padding: '10px 14px',
                                                    border: `1px solid ${theme.border}`,
                                                    fontSize: '14px',
                                                    background: theme.inputBg,
                                                    color: theme.text,
                                                    outline: 'none',
                                                    resize: 'vertical',
                                                    fontFamily: 'inherit'
                                                }}
                                            />
                                        </div>
                                    </div>
                                    <div style={{ padding: '16px 20px', borderTop: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'flex-end', gap: '12px' }}>
                                        <button
                                            onClick={() => { setShowAddComplaint(false); setNewComplaint({ subject: '', description: '', priority: 'medium' }); }}
                                            style={{
                                                background: 'transparent',
                                                border: `1px solid ${theme.border}`,
                                                color: theme.text,
                                                padding: '10px 20px',
                                                fontSize: '13px',
                                                fontWeight: '600',
                                                cursor: 'pointer'
                                            }}
                                        >
                                            Cancel
                                        </button>
                                        <button
                                            onClick={handleAddComplaint}
                                            disabled={savingComplaint}
                                            style={{
                                                background: '#3b82f6',
                                                border: 'none',
                                                color: 'white',
                                                padding: '10px 20px',
                                                fontSize: '13px',
                                                fontWeight: '600',
                                                cursor: savingComplaint ? 'not-allowed' : 'pointer',
                                                opacity: savingComplaint ? 0.7 : 1
                                            }}
                                        >
                                            {savingComplaint ? 'Submitting...' : 'Submit Complaint'}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Add Note Modal */}
                        {showComplaintNotes && (
                            <div style={{
                                position: 'fixed',
                                top: 0,
                                left: 0,
                                right: 0,
                                bottom: 0,
                                background: 'rgba(0,0,0,0.5)',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                zIndex: 9999
                            }}>
                                <div style={{
                                    background: theme.bg,
                                    width: '500px',
                                    maxWidth: '90%',
                                    border: `1px solid ${theme.border}`
                                }}>
                                    <div style={{ padding: '20px', borderBottom: `1px solid ${theme.border}` }}>
                                        <h3 style={{ margin: 0, color: theme.text, fontSize: '16px', fontWeight: '700' }}>Add Note</h3>
                                    </div>
                                    <div style={{ padding: '20px' }}>
                                        {/* Existing Notes */}
                                        {complaints.find(c => c.id === showComplaintNotes)?.notes?.length > 0 && (
                                            <div style={{ marginBottom: '16px' }}>
                                                <label style={{ display: 'block', marginBottom: '8px', fontWeight: '600', fontSize: '13px', color: theme.textSecondary }}>Previous Notes</label>
                                                <div style={{ maxHeight: '150px', overflowY: 'auto', background: theme.bgSecondary, border: `1px solid ${theme.border}`, padding: '12px' }}>
                                                    {complaints.find(c => c.id === showComplaintNotes)?.notes.map((note, idx) => (
                                                        <div key={idx} style={{ marginBottom: idx < complaints.find(c => c.id === showComplaintNotes).notes.length - 1 ? '12px' : 0, paddingBottom: idx < complaints.find(c => c.id === showComplaintNotes).notes.length - 1 ? '12px' : 0, borderBottom: idx < complaints.find(c => c.id === showComplaintNotes).notes.length - 1 ? `1px solid ${theme.border}` : 'none' }}>
                                                            <div style={{ fontSize: '13px', color: theme.text, marginBottom: '4px' }}>{note.text}</div>
                                                            <div style={{ fontSize: '11px', color: theme.textSecondary }}>{note.addedBy} ‚Ä¢ {new Date(note.addedAt).toLocaleString()}</div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                        <div>
                                            <label style={{ display: 'block', marginBottom: '8px', fontWeight: '600', fontSize: '13px', color: theme.text }}>New Note</label>
                                            <textarea
                                                value={complaintNote}
                                                onChange={(e) => setComplaintNote(e.target.value)}
                                                placeholder="Add your note here..."
                                                rows={3}
                                                style={{
                                                    width: '100%',
                                                    padding: '10px 14px',
                                                    border: `1px solid ${theme.border}`,
                                                    fontSize: '14px',
                                                    background: theme.inputBg,
                                                    color: theme.text,
                                                    outline: 'none',
                                                    resize: 'vertical',
                                                    fontFamily: 'inherit'
                                                }}
                                            />
                                        </div>
                                    </div>
                                    <div style={{ padding: '16px 20px', borderTop: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'flex-end', gap: '12px' }}>
                                        <button
                                            onClick={() => { setShowComplaintNotes(null); setComplaintNote(''); }}
                                            style={{
                                                background: 'transparent',
                                                border: `1px solid ${theme.border}`,
                                                color: theme.text,
                                                padding: '10px 20px',
                                                fontSize: '13px',
                                                fontWeight: '600',
                                                cursor: 'pointer'
                                            }}
                                        >
                                            Cancel
                                        </button>
                                        <button
                                            onClick={() => handleAddNote(showComplaintNotes)}
                                            style={{
                                                background: '#3b82f6',
                                                border: 'none',
                                                color: 'white',
                                                padding: '10px 20px',
                                                fontSize: '13px',
                                                fontWeight: '600',
                                                cursor: 'pointer'
                                            }}
                                        >
                                            Add Note
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Complaints Table */}
                        <div style={{ overflowX: 'auto' }}>
                            <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '13px' }}>
                                <thead>
                                    <tr style={{ background: theme.bgSecondary }}>
                                        <th style={{ padding: '12px 16px', textAlign: 'left', fontWeight: '600', color: theme.text, borderBottom: `1px solid ${theme.border}` }}>#</th>
                                        <th style={{ padding: '12px 16px', textAlign: 'left', fontWeight: '600', color: theme.text, borderBottom: `1px solid ${theme.border}` }}>Subject</th>
                                        <th style={{ padding: '12px 16px', textAlign: 'left', fontWeight: '600', color: theme.text, borderBottom: `1px solid ${theme.border}` }}>Priority</th>
                                        <th style={{ padding: '12px 16px', textAlign: 'left', fontWeight: '600', color: theme.text, borderBottom: `1px solid ${theme.border}` }}>Date</th>
                                        <th style={{ padding: '12px 16px', textAlign: 'left', fontWeight: '600', color: theme.text, borderBottom: `1px solid ${theme.border}` }}>Status</th>
                                        <th style={{ padding: '12px 16px', textAlign: 'left', fontWeight: '600', color: theme.text, borderBottom: `1px solid ${theme.border}` }}>Notes</th>
                                        <th style={{ padding: '12px 16px', textAlign: 'center', fontWeight: '600', color: theme.text, borderBottom: `1px solid ${theme.border}` }}>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {complaints.length === 0 ? (
                                        <tr>
                                            <td colSpan="7" style={{ padding: '40px', textAlign: 'center', color: theme.textSecondary }}>
                                                <div style={{ fontSize: '32px', marginBottom: '12px' }}>üì≠</div>
                                                <div>No complaints submitted yet</div>
                                            </td>
                                        </tr>
                                    ) : (
                                        complaints.map((complaint, index) => (
                                            <tr key={complaint.id} style={{ borderBottom: `1px solid ${theme.border}` }}>
                                                <td style={{ padding: '14px 16px', color: theme.textSecondary }}>{index + 1}</td>
                                                <td style={{ padding: '14px 16px' }}>
                                                    <div style={{ fontWeight: '600', color: theme.text, marginBottom: '4px' }}>{complaint.subject}</div>
                                                    <div style={{ fontSize: '12px', color: theme.textSecondary, maxWidth: '300px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>{complaint.description}</div>
                                                </td>
                                                <td style={{ padding: '14px 16px' }}>
                                                    <span style={{
                                                        display: 'inline-block',
                                                        padding: '4px 10px',
                                                        fontSize: '11px',
                                                        fontWeight: '600',
                                                        textTransform: 'uppercase',
                                                        background: complaint.priority === 'urgent' ? '#fef2f2' : complaint.priority === 'high' ? '#fff7ed' : complaint.priority === 'medium' ? '#fefce8' : '#f0fdf4',
                                                        color: complaint.priority === 'urgent' ? '#ef4444' : complaint.priority === 'high' ? '#f97316' : complaint.priority === 'medium' ? '#eab308' : '#22c55e'
                                                    }}>
                                                        {complaint.priority}
                                                    </span>
                                                </td>
                                                <td style={{ padding: '14px 16px', color: theme.textSecondary, fontSize: '12px' }}>
                                                    {new Date(complaint.createdAt).toLocaleDateString()}
                                                </td>
                                                <td style={{ padding: '14px 16px' }}>
                                                    <span style={{
                                                        display: 'inline-block',
                                                        padding: '4px 10px',
                                                        fontSize: '11px',
                                                        fontWeight: '600',
                                                        textTransform: 'uppercase',
                                                        background: complaint.status === 'completed' ? '#f0fdf4' : '#fef3c7',
                                                        color: complaint.status === 'completed' ? '#22c55e' : '#f59e0b'
                                                    }}>
                                                        {complaint.status === 'completed' ? 'Completed' : 'Awaiting'}
                                                    </span>
                                                </td>
                                                <td style={{ padding: '14px 16px', color: theme.textSecondary, fontSize: '12px' }}>
                                                    {complaint.notes?.length || 0} note{(complaint.notes?.length || 0) !== 1 ? 's' : ''}
                                                </td>
                                                <td style={{ padding: '14px 16px' }}>
                                                    <div style={{ display: 'flex', justifyContent: 'center', gap: '8px' }}>
                                                        <button
                                                            onClick={() => setShowComplaintNotes(complaint.id)}
                                                            title="Add Note"
                                                            style={{
                                                                background: theme.bgSecondary,
                                                                border: `1px solid ${theme.border}`,
                                                                color: theme.text,
                                                                padding: '6px 10px',
                                                                fontSize: '12px',
                                                                cursor: 'pointer',
                                                                display: 'flex',
                                                                alignItems: 'center',
                                                                gap: '4px'
                                                            }}
                                                        >
                                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                                            </svg>
                                                            Note
                                                        </button>
                                                        {complaint.response && (
                                                            <button
                                                                onClick={() => setViewingComplaintResponse(complaint)}
                                                                title="View Response"
                                                                style={{
                                                                    background: '#3b82f6',
                                                                    border: 'none',
                                                                    color: 'white',
                                                                    padding: '6px 10px',
                                                                    fontSize: '12px',
                                                                    cursor: 'pointer',
                                                                    display: 'flex',
                                                                    alignItems: 'center',
                                                                    gap: '4px'
                                                                }}
                                                            >
                                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                                                    <circle cx="12" cy="12" r="3"/>
                                                                </svg>
                                                                View
                                                            </button>
                                                        )}
                                                        {complaint.status !== 'completed' && (
                                                            <button
                                                                onClick={() => handleMarkCompleted(complaint.id)}
                                                                title="Mark as Completed"
                                                                style={{
                                                                    background: '#22c55e',
                                                                    border: 'none',
                                                                    color: 'white',
                                                                    padding: '6px 10px',
                                                                    fontSize: '12px',
                                                                    cursor: 'pointer',
                                                                    display: 'flex',
                                                                    alignItems: 'center',
                                                                    gap: '4px'
                                                                }}
                                                            >
                                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                                                    <polyline points="20 6 9 17 4 12"/>
                                                                </svg>
                                                                Complete
                                                            </button>
                                                        )}
                                                    </div>
                                                </td>
                                            </tr>
                                        ))
                                    )}
                                </tbody>
                            </table>
                        </div>

                        {/* View Response Modal */}
                        {viewingComplaintResponse && (
                            <div style={{
                                position: 'fixed',
                                top: 0,
                                left: 0,
                                right: 0,
                                bottom: 0,
                                background: 'rgba(0,0,0,0.5)',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                zIndex: 9999
                            }}>
                                <div style={{
                                    background: theme.bg,
                                    width: '550px',
                                    maxWidth: '90%',
                                    maxHeight: '80vh',
                                    overflow: 'auto',
                                    border: `1px solid ${theme.border}`
                                }}>
                                    <div style={{ padding: '20px', borderBottom: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                        <h3 style={{ margin: 0, color: theme.text, fontSize: '16px', fontWeight: '700' }}>Complaint Response</h3>
                                        <button
                                            onClick={() => setViewingComplaintResponse(null)}
                                            style={{ background: 'none', border: 'none', cursor: 'pointer', padding: '4px', color: theme.textSecondary }}
                                        >
                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                                <line x1="18" y1="6" x2="6" y2="18"/>
                                                <line x1="6" y1="6" x2="18" y2="18"/>
                                            </svg>
                                        </button>
                                    </div>
                                    <div style={{ padding: '20px' }}>
                                        {/* Complaint Info */}
                                        <div style={{ marginBottom: '20px', padding: '16px', background: theme.bgSecondary, border: `1px solid ${theme.border}` }}>
                                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '12px' }}>
                                                <div>
                                                    <div style={{ fontWeight: '700', color: theme.text, fontSize: '15px', marginBottom: '4px' }}>{viewingComplaintResponse.subject}</div>
                                                    <div style={{ fontSize: '12px', color: theme.textSecondary }}>Submitted on {new Date(viewingComplaintResponse.createdAt).toLocaleDateString()}</div>
                                                </div>
                                                <span style={{
                                                    padding: '4px 10px',
                                                    fontSize: '11px',
                                                    fontWeight: '600',
                                                    textTransform: 'uppercase',
                                                    background: viewingComplaintResponse.status === 'completed' ? '#f0fdf4' : '#fef3c7',
                                                    color: viewingComplaintResponse.status === 'completed' ? '#22c55e' : '#f59e0b'
                                                }}>
                                                    {viewingComplaintResponse.status === 'completed' ? 'Resolved' : 'Pending'}
                                                </span>
                                            </div>
                                            <div style={{ fontSize: '13px', color: theme.textSecondary }}>{viewingComplaintResponse.description}</div>
                                        </div>

                                        {/* Response Section */}
                                        <div style={{ marginBottom: '16px' }}>
                                            <label style={{ display: 'block', marginBottom: '8px', fontWeight: '600', fontSize: '13px', color: theme.text }}>
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#22c55e" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" style={{ marginRight: '8px', verticalAlign: 'middle' }}>
                                                    <polyline points="20 6 9 17 4 12"/>
                                                </svg>
                                                Response from Support
                                            </label>
                                            <div style={{ 
                                                padding: '16px', 
                                                background: '#f0fdf4', 
                                                border: '1px solid #bbf7d0', 
                                                fontSize: '14px', 
                                                color: '#166534',
                                                lineHeight: '1.6'
                                            }}>
                                                {viewingComplaintResponse.response}
                                            </div>
                                            {viewingComplaintResponse.respondedAt && (
                                                <div style={{ fontSize: '11px', color: theme.textSecondary, marginTop: '8px' }}>
                                                    Responded by {viewingComplaintResponse.respondedBy || 'Support Team'} on {new Date(viewingComplaintResponse.respondedAt).toLocaleString()}
                                                </div>
                                            )}
                                        </div>

                                        {/* Notes History */}
                                        {viewingComplaintResponse.notes?.length > 0 && (
                                            <div>
                                                <label style={{ display: 'block', marginBottom: '8px', fontWeight: '600', fontSize: '13px', color: theme.text }}>Response History</label>
                                                <div style={{ maxHeight: '200px', overflowY: 'auto', background: theme.bgSecondary, border: `1px solid ${theme.border}`, padding: '12px' }}>
                                                    {viewingComplaintResponse.notes.map((note, idx) => (
                                                        <div key={idx} style={{ marginBottom: idx < viewingComplaintResponse.notes.length - 1 ? '12px' : 0, paddingBottom: idx < viewingComplaintResponse.notes.length - 1 ? '12px' : 0, borderBottom: idx < viewingComplaintResponse.notes.length - 1 ? `1px solid ${theme.border}` : 'none' }}>
                                                            <div style={{ fontSize: '13px', color: theme.text, marginBottom: '4px' }}>{note.text}</div>
                                                            <div style={{ fontSize: '11px', color: theme.textSecondary }}>{note.addedBy} ‚Ä¢ {new Date(note.addedAt).toLocaleString()}</div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                    <div style={{ padding: '16px 20px', borderTop: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'flex-end' }}>
                                        <button
                                            onClick={() => setViewingComplaintResponse(null)}
                                            style={{
                                                background: '#3b82f6',
                                                border: 'none',
                                                color: 'white',
                                                padding: '10px 24px',
                                                fontSize: '13px',
                                                fontWeight: '600',
                                                cursor: 'pointer'
                                            }}
                                        >
                                            Close
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            )}
        </div>
    );
}

// Reports & Analytics Component
function ReportsAnalytics() {
    const [loading, setLoading] = useState(true);
    const [activeTab, setActiveTab] = useState('overview');
    const [dateRange, setDateRange] = useState('month');
    const [reportType, setReportType] = useState('summary');
    const [showPreview, setShowPreview] = useState(false);
    const [previewContent, setPreviewContent] = useState('');
    const [data, setData] = useState({
        billing: [], expenses: [], inventory: [], fleet: [], customers: [], staff: [], vehicles: []
    });
    const [isDark, setIsDark] = useState(document.documentElement.getAttribute('data-theme') === 'dark');

    useEffect(() => {
        const observer = new MutationObserver(() => setIsDark(document.documentElement.getAttribute('data-theme') === 'dark'));
        observer.observe(document.documentElement, { attributes: true });
        return () => observer.disconnect();
    }, []);

    const theme = {
        bg: isDark ? '#1e293b' : 'white',
        bgSecondary: isDark ? '#0f172a' : '#f8fafc',
        bgTertiary: isDark ? '#334155' : '#f1f5f9',
        text: isDark ? '#f1f5f9' : '#1e293b',
        textSecondary: isDark ? '#94a3b8' : '#64748b',
        border: isDark ? '#334155' : '#e2e8f0',
        inputBg: isDark ? '#1e293b' : 'white'
    };

    const formatCurrency = (amt) => `${getBrandingForReceipts().currencySymbol || 'KES'} ${(amt || 0).toLocaleString()}`;

    // Load all data
    useEffect(() => {
        const unsubs = [];
        const init = async () => {
            let services = window.FirebaseServices;
            let attempts = 0;
            while (!services && attempts < 50) {
                await new Promise(r => setTimeout(r, 100));
                services = window.FirebaseServices;
                attempts++;
            }
            if (!services) { setLoading(false); return; }

            // Subscribe to billing/invoices (real-time revenue data)
            if (services.billingService?.subscribeToInvoices) {
                unsubs.push(services.billingService.subscribeToInvoices((invoices) => {
                    setData(prev => ({ ...prev, billing: invoices }));
                }));
            }
            // Subscribe to expenses
            if (services.expensesService?.subscribeToExpenses) {
                unsubs.push(services.expensesService.subscribeToExpenses((records) => {
                    setData(prev => ({ ...prev, expenses: records }));
                }));
            }
            // Subscribe to inventory
            if (services.inventoryService?.subscribeToItems) {
                unsubs.push(services.inventoryService.subscribeToItems((items) => {
                    setData(prev => ({ ...prev, inventory: items }));
                }));
            }
            // Subscribe to fleet
            if (services.fleetService?.subscribeToAccounts) {
                unsubs.push(services.fleetService.subscribeToAccounts((accounts) => {
                    setData(prev => ({ ...prev, fleet: accounts }));
                }));
            }
            // Subscribe to customers
            if (services.customerService?.subscribeToCustomers) {
                unsubs.push(services.customerService.subscribeToCustomers((customers) => {
                    setData(prev => ({ ...prev, customers: customers }));
                }));
            }
            // Subscribe to staff
            if (services.staffService?.subscribeToStaff) {
                unsubs.push(services.staffService.subscribeToStaff((staff) => {
                    setData(prev => ({ ...prev, staff: staff }));
                }));
            }
            // Subscribe to vehicles/intake
            if (services.intakeRecordsService?.subscribeToRecords) {
                unsubs.push(services.intakeRecordsService.subscribeToRecords((vehicles) => {
                    setData(prev => ({ ...prev, vehicles: vehicles }));
                }));
            }
            setLoading(false);
        };
        init();
        return () => unsubs.forEach(u => u && u());
    }, []);

    // Calculate analytics
    const now = new Date();
    const getDateFilter = () => {
        if (dateRange === 'today') return new Date(now.getFullYear(), now.getMonth(), now.getDate());
        if (dateRange === 'week') { const d = new Date(now); d.setDate(d.getDate() - 7); return d; }
        if (dateRange === 'month') return new Date(now.getFullYear(), now.getMonth(), 1);
        if (dateRange === 'year') return new Date(now.getFullYear(), 0, 1);
        return new Date(0);
    };
    const filterDate = getDateFilter();

    const filterByDate = (items, dateField = 'createdAt') => {
        return items.filter(item => {
            const d = item[dateField] || item.date || item.createdAt;
            return d && new Date(d) >= filterDate;
        });
    };

    const filteredBilling = filterByDate(data.billing);
    const filteredExpenses = filterByDate(data.expenses, 'date');
    const filteredVehicles = filterByDate(data.vehicles);

    // Key Metrics - using totalAmount from invoices, with fallbacks
    const totalRevenue = filteredBilling.reduce((s, b) => s + (b.totalAmount || b.total || b.amount || 0), 0);
    const totalExpenses = filteredExpenses.reduce((s, e) => s + (e.amount || 0), 0);
    const netProfit = totalRevenue - totalExpenses;
    const totalServices = filteredBilling.length;
    const avgTicket = totalServices > 0 ? totalRevenue / totalServices : 0;

    // Count paid vs unpaid
    const paidInvoices = filteredBilling.filter(b => b.paymentStatus === 'paid');
    const unpaidInvoices = filteredBilling.filter(b => b.paymentStatus !== 'paid');
    const paidRevenue = paidInvoices.reduce((s, b) => s + (b.totalAmount || b.total || b.amount || 0), 0);
    const unpaidRevenue = unpaidInvoices.reduce((s, b) => s + (b.totalAmount || b.total || b.amount || 0), 0);

    // Inventory stats
    const inventoryValue = data.inventory.reduce((s, i) => s + ((i.quantity || 0) * (i.unitCost || i.cost || 0)), 0);
    const outOfStockItems = data.inventory.filter(i => (i.quantity || 0) === 0).length;
    const lowStockItems = data.inventory.filter(i => (i.quantity || 0) > 0 && (i.quantity || 0) <= (i.minStock || i.reorderLevel || 5)).length;

    // Fleet stats
    const fleetBalance = data.fleet.reduce((s, f) => s + (f.balance || 0), 0);
    const fleetSpent = data.fleet.reduce((s, f) => s + (f.totalSpent || 0), 0);
    const fleetVehicles = data.fleet.reduce((s, f) => s + (f.vehicles?.length || 0), 0);

    // Customer stats
    const totalCustomers = data.customers.length;
    const loyaltyPoints = data.customers.reduce((s, c) => s + (c.loyaltyPoints || 0), 0);

    // Revenue by service type/source
    const revenueByService = {};
    filteredBilling.forEach(b => {
        // Try to get service name from services array, or use source
        let svc = 'Other';
        if (b.services && b.services.length > 0) {
            svc = b.services[0].name || b.source || 'Other';
        } else {
            svc = b.source === 'wash' ? 'Car Wash' : b.source === 'garage' ? 'Garage Service' : (b.service || b.packageName || 'Other');
        }
        revenueByService[svc] = (revenueByService[svc] || 0) + (b.totalAmount || b.total || b.amount || 0);
    });
    const topServices = Object.entries(revenueByService).sort((a, b) => b[1] - a[1]).slice(0, 5);

    // Expenses by category
    const expensesByCategory = {};
    filteredExpenses.forEach(e => {
        const cat = e.category || 'Other';
        expensesByCategory[cat] = (expensesByCategory[cat] || 0) + (e.amount || 0);
    });
    const topExpenseCategories = Object.entries(expensesByCategory).sort((a, b) => b[1] - a[1]).slice(0, 5);

    // Daily revenue for chart (last 7 days)
    const dailyRevenue = [];
    for (let i = 6; i >= 0; i--) {
        const d = new Date(now);
        d.setDate(d.getDate() - i);
        const dateStr = d.toISOString().split('T')[0];
        const dayRevenue = data.billing.filter(b => (b.createdAt || b.date || '').startsWith(dateStr)).reduce((s, b) => s + (b.totalAmount || b.total || b.amount || 0), 0);
        dailyRevenue.push({ day: d.toLocaleDateString('en', { weekday: 'short' }), date: dateStr, amount: dayRevenue });
    }
    const maxDailyRevenue = Math.max(...dailyRevenue.map(d => d.amount), 1);

    // Print report
    const printReport = () => {
        const branding = getBrandingForReceipts();
        const content = `
<!DOCTYPE html><html><head><title>${branding.companyName } Analytics Report</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}body{font-family:'Segoe UI',Arial,sans-serif;padding:30px;color:#1e293b}
.header{text-align:center;margin-bottom:30px;padding-bottom:20px;border-bottom:2px solid #1e293b}
.logo{font-size:28px;font-weight:800;color:#10b981}.logo span{color:#1e293b}
.subtitle{color:#64748b;margin-top:8px}
.section{margin-bottom:24px}.section-title{font-size:16px;font-weight:700;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid #e2e8f0}
.grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px}
.card{background:#f8fafc;border:1px solid #e2e8f0;padding:16px;text-align:center}
.card .value{font-size:24px;font-weight:800}.card .label{font-size:11px;color:#64748b;text-transform:uppercase;margin-top:4px}
.green{color:#10b981}.red{color:#ef4444}.blue{color:#3b82f6}.purple{color:#8b5cf6}
table{width:100%;border-collapse:collapse}th{background:#1e293b;color:white;padding:10px;text-align:left;font-size:11px;text-transform:uppercase}
td{padding:10px;border-bottom:1px solid #e2e8f0}tr:nth-child(even){background:#f8fafc}
.footer{margin-top:30px;text-align:center;color:#64748b;font-size:12px;padding-top:20px;border-top:1px solid #e2e8f0}
@media print{body{padding:20px}}
</style></head><body>
<div class="header"><div class="logo">${branding.companyName }</div><div class="subtitle">Analytics Report - ${new Date().toLocaleDateString()}</div></div>

<div class="section"><div class="section-title">Key Performance Metrics (${dateRange === 'today' ? 'Today' : dateRange === 'week' ? 'Last 7 Days' : dateRange === 'month' ? 'This Month' : 'This Year'})</div>
<div class="grid">
<div class="card"><div class="value green">${branding.currencySymbol || 'KES'} ${totalRevenue.toLocaleString()}</div><div class="label">Total Revenue</div></div>
<div class="card"><div class="value red">${branding.currencySymbol || 'KES'} ${totalExpenses.toLocaleString()}</div><div class="label">Total Expenses</div></div>
<div class="card"><div class="value ${netProfit >= 0 ? 'green' : 'red'}">${branding.currencySymbol || 'KES'} ${netProfit.toLocaleString()}</div><div class="label">Net Profit</div></div>
<div class="card"><div class="value blue">${totalServices}</div><div class="label">Services Completed</div></div>
</div></div>

<div class="section"><div class="section-title">Business Summary</div>
<div class="grid">
<div class="card"><div class="value blue">${branding.currencySymbol || 'KES'} ${avgTicket.toLocaleString()}</div><div class="label">Avg Ticket</div></div>
<div class="card"><div class="value purple">${totalCustomers}</div><div class="label">Total Customers</div></div>
<div class="card"><div class="value green">${branding.currencySymbol || 'KES'} ${inventoryValue.toLocaleString()}</div><div class="label">Inventory Value</div></div>
<div class="card"><div class="value blue">${fleetVehicles}</div><div class="label">Fleet Vehicles</div></div>
</div></div>

${topServices.length > 0 ? `<div class="section"><div class="section-title">Top Services by Revenue</div>
<table><thead><tr><th>Service</th><th style="text-align:right">Revenue</th><th style="text-align:right">% of Total</th></tr></thead>
<tbody>${topServices.map(([svc, amt]) => `<tr><td>${svc}</td><td style="text-align:right">${branding.currencySymbol || 'KES'} ${amt.toLocaleString()}</td><td style="text-align:right">${totalRevenue > 0 ? ((amt / totalRevenue) * 100).toFixed(1) : 0}%</td></tr>`).join('')}</tbody></table></div>` : ''}

${topExpenseCategories.length > 0 ? `<div class="section"><div class="section-title">Expenses by Category</div>
<table><thead><tr><th>Category</th><th style="text-align:right">Amount</th><th style="text-align:right">% of Total</th></tr></thead>
<tbody>${topExpenseCategories.map(([cat, amt]) => `<tr><td>${cat}</td><td style="text-align:right">${branding.currencySymbol || 'KES'} ${amt.toLocaleString()}</td><td style="text-align:right">${totalExpenses > 0 ? ((amt / totalExpenses) * 100).toFixed(1) : 0}%</td></tr>`).join('')}</tbody></table></div>` : ''}

<div class="footer">Generated on ${new Date().toLocaleString()} | ${branding.companyName } Car Wash Management System</div>
</body></html>`;
        const w = window.open('', '_blank');
        w.document.write(content);
        w.document.close();
        w.onload = () => w.print();
    };

    const tabStyle = (active) => ({
        padding: '12px 24px', background: active ? '#3b82f6' : 'transparent', color: active ? 'white' : theme.textSecondary,
        border: 'none', cursor: 'pointer', fontWeight: '600', fontSize: '13px', borderBottom: active ? 'none' : `1px solid ${theme.border}`
    });
    const cardStyle = { background: theme.bg, border: `1px solid ${theme.border}`, padding: '20px' };
    const metricCard = (value, label, color = theme.text) => (
        <div style={{ ...cardStyle, textAlign: 'center' }}>
            <div style={{ fontSize: '28px', fontWeight: '800', color }}>{value}</div>
            <div style={{ fontSize: '11px', color: theme.textSecondary, textTransform: 'uppercase', marginTop: '6px', fontWeight: '600' }}>{label}</div>
        </div>
    );

    if (loading) {
        return <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', height: '400px', color: theme.textSecondary }}>Loading analytics...</div>;
    }

    return (
        <div style={{ padding: 0, width: '100%' }}>
            {/* Header */}
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '16px 20px', background: theme.bg, borderBottom: `1px solid ${theme.border}` }}>
                <div style={{ display: 'flex', gap: '0' }}>
                    <button onClick={() => setActiveTab('overview')} style={tabStyle(activeTab === 'overview')}>Overview</button>
                    <button onClick={() => setActiveTab('expenses')} style={tabStyle(activeTab === 'expenses')}>Expenses</button>
                    <button onClick={() => setActiveTab('operations')} style={tabStyle(activeTab === 'operations')}>Operations</button>
                    <button onClick={() => setActiveTab('generate')} style={tabStyle(activeTab === 'generate')}>Generate Reports</button>
                </div>
                <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '6px', padding: '8px 12px', background: '#10b981', color: 'white', fontSize: '12px', fontWeight: '600' }}>
                        <span style={{ width: '8px', height: '8px', background: '#fff', borderRadius: '50%', animation: 'pulse 1.5s infinite' }}></span>
                        LIVE
                    </div>
                    <select value={dateRange} onChange={(e) => setDateRange(e.target.value)} style={{ padding: '10px 14px', border: `1px solid ${theme.border}`, background: theme.inputBg, color: theme.text, fontSize: '13px' }}>
                        <option value="today">Today</option>
                        <option value="week">Last 7 Days</option>
                        <option value="month">This Month</option>
                        <option value="year">This Year</option>
                        <option value="all">All Time</option>
                    </select>
                    <button onClick={printReport} style={{ padding: '10px 20px', background: '#1e293b', color: 'white', border: 'none', fontWeight: '600', cursor: 'pointer' }}>Print Report</button>
                </div>
            </div>

            {/* Overview Tab */}
            {activeTab === 'overview' && (
                <div style={{ padding: '20px' }}>
                    {/* Key Metrics */}
                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(5, 1fr)', gap: '16px', marginBottom: '24px' }}>
                        {metricCard(formatCurrency(totalRevenue), 'Total Revenue', '#10b981')}
                        {metricCard(formatCurrency(totalExpenses), 'Total Expenses', '#ef4444')}
                        {metricCard(formatCurrency(netProfit), 'Net Profit', netProfit >= 0 ? '#10b981' : '#ef4444')}
                        {metricCard(totalServices.toString(), 'Services', '#3b82f6')}
                        {metricCard(formatCurrency(avgTicket), 'Avg Ticket', '#8b5cf6')}
                    </div>

                    {/* Charts Row */}
                    <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr', gap: '20px', marginBottom: '24px' }}>
                        {/* Revenue Chart */}
                        <div style={cardStyle}>
                            <h4 style={{ margin: '0 0 16px', color: theme.text, fontWeight: '700' }}>Daily Revenue (Last 7 Days)</h4>
                            <div style={{ display: 'flex', alignItems: 'flex-end', gap: '8px', height: '180px' }}>
                                {dailyRevenue.map((d, i) => (
                                    <div key={i} style={{ flex: 1, display: 'flex', flexDirection: 'column', alignItems: 'center', height: '100%', justifyContent: 'flex-end' }}>
                                        <div style={{ fontSize: '10px', color: '#10b981', fontWeight: '600', marginBottom: '4px' }}>{d.amount > 0 ? `${(d.amount / 1000).toFixed(0)}K` : ''}</div>
                                        <div style={{ width: '100%', background: '#10b981', height: `${(d.amount / maxDailyRevenue) * 140}px`, minHeight: d.amount > 0 ? '4px' : '0' }}></div>
                                        <div style={{ fontSize: '11px', color: theme.textSecondary, marginTop: '8px', fontWeight: '600' }}>{d.day}</div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* Quick Stats */}
                        <div style={cardStyle}>
                            <h4 style={{ margin: '0 0 16px', color: theme.text, fontWeight: '700' }}>Quick Stats</h4>
                            <div style={{ display: 'grid', gap: '12px' }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', padding: '12px', background: theme.bgSecondary }}>
                                    <span style={{ color: theme.textSecondary }}>Customers</span>
                                    <span style={{ fontWeight: '700', color: theme.text }}>{totalCustomers}</span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', padding: '12px', background: theme.bgSecondary }}>
                                    <span style={{ color: theme.textSecondary }}>Fleet Accounts</span>
                                    <span style={{ fontWeight: '700', color: theme.text }}>{data.fleet.length}</span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', padding: '12px', background: theme.bgSecondary }}>
                                    <span style={{ color: theme.textSecondary }}>Fleet Vehicles</span>
                                    <span style={{ fontWeight: '700', color: theme.text }}>{fleetVehicles}</span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', padding: '12px', background: theme.bgSecondary }}>
                                    <span style={{ color: theme.textSecondary }}>Staff Members</span>
                                    <span style={{ fontWeight: '700', color: theme.text }}>{data.staff.length}</span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', padding: '12px', background: theme.bgSecondary }}>
                                    <span style={{ color: theme.textSecondary }}>Inventory Items</span>
                                    <span style={{ fontWeight: '700', color: theme.text }}>{data.inventory.length}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Bottom Row */}
                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '20px' }}>
                        {/* Top Services */}
                        <div style={cardStyle}>
                            <h4 style={{ margin: '0 0 16px', color: theme.text, fontWeight: '700' }}>Top Services</h4>
                            {topServices.length > 0 ? topServices.map(([svc, amt], i) => (
                                <div key={i} style={{ display: 'flex', justifyContent: 'space-between', padding: '10px 0', borderBottom: `1px solid ${theme.border}` }}>
                                    <span style={{ color: theme.text }}>{svc}</span>
                                    <span style={{ fontWeight: '700', color: '#10b981' }}>{formatCurrency(amt)}</span>
                                </div>
                            )) : <div style={{ color: theme.textSecondary, textAlign: 'center', padding: '20px' }}>No data</div>}
                        </div>

                        {/* Expense Categories */}
                        <div style={cardStyle}>
                            <h4 style={{ margin: '0 0 16px', color: theme.text, fontWeight: '700' }}>Top Expense Categories</h4>
                            {topExpenseCategories.length > 0 ? topExpenseCategories.map(([cat, amt], i) => (
                                <div key={i} style={{ display: 'flex', justifyContent: 'space-between', padding: '10px 0', borderBottom: `1px solid ${theme.border}` }}>
                                    <span style={{ color: theme.text }}>{cat}</span>
                                    <span style={{ fontWeight: '700', color: '#ef4444' }}>{formatCurrency(amt)}</span>
                                </div>
                            )) : <div style={{ color: theme.textSecondary, textAlign: 'center', padding: '20px' }}>No data</div>}
                        </div>

                        {/* Inventory & Fleet */}
                        <div style={cardStyle}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
                                <h4 style={{ margin: 0, color: theme.text, fontWeight: '700' }}>Assets Overview</h4>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '6px', padding: '4px 8px', background: '#10b981', color: 'white', fontSize: '10px', fontWeight: '600' }}>
                                    <span style={{ width: '6px', height: '6px', background: '#fff', borderRadius: '50%', animation: 'pulse 1.5s infinite' }}></span>
                                    LIVE
                                </div>
                            </div>
                            <div style={{ display: 'flex', justifyContent: 'space-between', padding: '10px 0', borderBottom: `1px solid ${theme.border}` }}>
                                <span style={{ color: theme.textSecondary }}>Inventory Value</span>
                                <span style={{ fontWeight: '700', color: '#3b82f6' }}>{formatCurrency(inventoryValue)}</span>
                            </div>
                            <div style={{ display: 'flex', justifyContent: 'space-between', padding: '10px 0', borderBottom: `1px solid ${theme.border}` }}>
                                <span style={{ color: theme.textSecondary }}>Low Stock Items</span>
                                <span style={{ fontWeight: '700', color: lowStockItems > 0 ? '#f59e0b' : '#10b981' }}>{lowStockItems}</span>
                            </div>
                            <div style={{ display: 'flex', justifyContent: 'space-between', padding: '10px 0', borderBottom: `1px solid ${theme.border}` }}>
                                <span style={{ color: theme.textSecondary }}>Out of Stock Items</span>
                                <span style={{ fontWeight: '700', color: outOfStockItems > 0 ? '#ef4444' : '#10b981' }}>{outOfStockItems}</span>
                            </div>
                            <div style={{ display: 'flex', justifyContent: 'space-between', padding: '10px 0', borderBottom: `1px solid ${theme.border}` }}>
                                <span style={{ color: theme.textSecondary }}>Fleet Balance</span>
                                <span style={{ fontWeight: '700', color: '#10b981' }}>{formatCurrency(fleetBalance)}</span>
                            </div>
                            <div style={{ display: 'flex', justifyContent: 'space-between', padding: '10px 0' }}>
                                <span style={{ color: theme.textSecondary }}>Fleet Revenue</span>
                                <span style={{ fontWeight: '700', color: '#8b5cf6' }}>{formatCurrency(fleetSpent)}</span>
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* Expenses Tab */}
            {activeTab === 'expenses' && (
                <div style={{ padding: '20px' }}>
                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '16px', marginBottom: '24px' }}>
                        {metricCard(formatCurrency(totalExpenses), 'Total Expenses', '#ef4444')}
                        {metricCard(filteredExpenses.length.toString(), 'Expense Count', '#3b82f6')}
                        {metricCard(formatCurrency(filteredExpenses.length > 0 ? totalExpenses / filteredExpenses.length : 0), 'Avg Expense', '#8b5cf6')}
                        {metricCard(formatCurrency(totalRevenue - totalExpenses), 'Net Profit', netProfit >= 0 ? '#10b981' : '#ef4444')}
                    </div>
                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 2fr', gap: '20px' }}>
                        <div style={cardStyle}>
                            <h4 style={{ margin: '0 0 16px', color: theme.text, fontWeight: '700' }}>By Category</h4>
                            {topExpenseCategories.length > 0 ? topExpenseCategories.map(([cat, amt], i) => (
                                <div key={i} style={{ marginBottom: '12px' }}>
                                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '4px' }}>
                                        <span style={{ color: theme.text, fontSize: '13px' }}>{cat}</span>
                                        <span style={{ color: '#ef4444', fontWeight: '600', fontSize: '13px' }}>{formatCurrency(amt)}</span>
                                    </div>
                                    <div style={{ height: '8px', background: theme.bgTertiary }}>
                                        <div style={{ height: '100%', background: '#ef4444', width: `${totalExpenses > 0 ? (amt / totalExpenses) * 100 : 0}%` }}></div>
                                    </div>
                                </div>
                            )) : <div style={{ color: theme.textSecondary, padding: '20px', textAlign: 'center' }}>No expenses</div>}
                        </div>
                        <div style={cardStyle}>
                            <h4 style={{ margin: '0 0 16px', color: theme.text, fontWeight: '700' }}>Recent Expenses</h4>
                            <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                                <thead>
                                    <tr style={{ background: theme.bgTertiary }}>
                                        <th style={{ padding: '12px', textAlign: 'left', fontSize: '11px', color: theme.textSecondary, fontWeight: '700', textTransform: 'uppercase' }}>Date</th>
                                        <th style={{ padding: '12px', textAlign: 'left', fontSize: '11px', color: theme.textSecondary, fontWeight: '700', textTransform: 'uppercase' }}>Description</th>
                                        <th style={{ padding: '12px', textAlign: 'left', fontSize: '11px', color: theme.textSecondary, fontWeight: '700', textTransform: 'uppercase' }}>Category</th>
                                        <th style={{ padding: '12px', textAlign: 'right', fontSize: '11px', color: theme.textSecondary, fontWeight: '700', textTransform: 'uppercase' }}>Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {filteredExpenses.slice(0, 10).map((e, i) => (
                                        <tr key={i} style={{ borderBottom: `1px solid ${theme.border}` }}>
                                            <td style={{ padding: '12px', color: theme.textSecondary, fontSize: '13px' }}>{new Date(e.date).toLocaleDateString()}</td>
                                            <td style={{ padding: '12px', color: theme.text, fontWeight: '500' }}>{e.description || '-'}</td>
                                            <td style={{ padding: '12px', color: theme.textSecondary }}>{e.category || '-'}</td>
                                            <td style={{ padding: '12px', textAlign: 'right', fontWeight: '700', color: '#ef4444' }}>{formatCurrency(e.amount)}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            )}

            {/* Operations Tab */}
            {activeTab === 'operations' && (
                <div style={{ padding: '20px' }}>
                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(5, 1fr)', gap: '16px', marginBottom: '24px' }}>
                        {metricCard(totalCustomers.toString(), 'Customers', '#3b82f6')}
                        {metricCard(data.fleet.length.toString(), 'Fleet Accounts', '#8b5cf6')}
                        {metricCard(fleetVehicles.toString(), 'Fleet Vehicles', '#f59e0b')}
                        {metricCard(data.staff.length.toString(), 'Staff', '#10b981')}
                        {metricCard(data.inventory.length.toString(), 'Inventory Items', '#ef4444')}
                    </div>
                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '20px', marginBottom: '20px' }}>
                        <div style={cardStyle}>
                            <h4 style={{ margin: '0 0 16px', color: theme.text, fontWeight: '700' }}>Fleet Accounts</h4>
                            {data.fleet.slice(0, 8).map((f, i) => (
                                <div key={i} style={{ display: 'flex', justifyContent: 'space-between', padding: '10px 0', borderBottom: `1px solid ${theme.border}` }}>
                                    <div>
                                        <div style={{ color: theme.text, fontWeight: '600' }}>{f.companyName}</div>
                                        <div style={{ fontSize: '11px', color: theme.textSecondary }}>{f.vehicles?.length || 0} vehicles</div>
                                    </div>
                                    <div style={{ textAlign: 'right' }}>
                                        <div style={{ fontWeight: '700', color: f.balance >= 0 ? '#10b981' : '#ef4444' }}>{formatCurrency(f.balance)}</div>
                                        <div style={{ fontSize: '11px', color: theme.textSecondary }}>Spent: {formatCurrency(f.totalSpent)}</div>
                                    </div>
                                </div>
                            ))}
                            {data.fleet.length === 0 && <div style={{ color: theme.textSecondary, textAlign: 'center', padding: '20px' }}>No fleet accounts</div>}
                        </div>
                        <div style={cardStyle}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
                                <h4 style={{ margin: 0, color: theme.text, fontWeight: '700' }}>Stock Alerts</h4>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '6px', padding: '4px 8px', background: '#10b981', color: 'white', fontSize: '10px', fontWeight: '600' }}>
                                    <span style={{ width: '6px', height: '6px', background: '#fff', borderRadius: '50%', animation: 'pulse 1.5s infinite' }}></span>
                                    LIVE
                                </div>
                            </div>
                            {/* Out of Stock Items */}
                            {data.inventory.filter(i => (i.quantity || 0) === 0).map((item, i) => (
                                <div key={`oos-${i}`} style={{ display: 'flex', justifyContent: 'space-between', padding: '10px 0', borderBottom: `1px solid ${theme.border}` }}>
                                    <div>
                                        <div style={{ color: theme.text, fontWeight: '600' }}>{item.name}</div>
                                        <div style={{ fontSize: '11px', color: theme.textSecondary }}>{item.category || 'Uncategorized'}</div>
                                    </div>
                                    <div style={{ textAlign: 'right' }}>
                                        <span style={{ padding: '3px 8px', fontSize: '10px', fontWeight: '700', background: '#fef2f2', color: '#dc2626' }}>OUT OF STOCK</span>
                                    </div>
                                </div>
                            ))}
                            {/* Low Stock Items */}
                            {data.inventory.filter(i => (i.quantity || 0) > 0 && (i.quantity || 0) <= (i.minStock || i.reorderLevel || 5)).slice(0, 6).map((item, i) => (
                                <div key={`low-${i}`} style={{ display: 'flex', justifyContent: 'space-between', padding: '10px 0', borderBottom: `1px solid ${theme.border}` }}>
                                    <div>
                                        <div style={{ color: theme.text, fontWeight: '600' }}>{item.name}</div>
                                        <div style={{ fontSize: '11px', color: theme.textSecondary }}>{item.category || 'Uncategorized'}</div>
                                    </div>
                                    <div style={{ textAlign: 'right' }}>
                                        <div style={{ fontWeight: '700', color: '#f59e0b' }}>{item.quantity || 0} {item.unit || 'pcs'}</div>
                                        <div style={{ fontSize: '11px', color: theme.textSecondary }}>Min: {item.minStock || item.reorderLevel || 5}</div>
                                    </div>
                                </div>
                            ))}
                            {(lowStockItems === 0 && outOfStockItems === 0) && <div style={{ color: theme.textSecondary, textAlign: 'center', padding: '20px' }}>All items well stocked ‚úì</div>}
                        </div>
                    </div>

                    {/* Full Inventory Table */}
                    <div style={cardStyle}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
                            <h4 style={{ margin: 0, color: theme.text, fontWeight: '700' }}>Inventory Items (Real-time)</h4>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                                <div style={{ fontSize: '13px', color: theme.textSecondary }}>
                                    Total Value: <span style={{ fontWeight: '700', color: '#3b82f6' }}>{formatCurrency(inventoryValue)}</span>
                                </div>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '6px', padding: '6px 10px', background: '#10b981', color: 'white', fontSize: '11px', fontWeight: '600' }}>
                                    <span style={{ width: '6px', height: '6px', background: '#fff', borderRadius: '50%' }}></span>
                                    LIVE
                                </div>
                            </div>
                        </div>
                        <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                            <thead>
                                <tr style={{ background: theme.bgTertiary }}>
                                    <th style={{ padding: '12px', textAlign: 'left', fontSize: '11px', color: theme.textSecondary, fontWeight: '700', textTransform: 'uppercase' }}>Item Name</th>
                                    <th style={{ padding: '12px', textAlign: 'left', fontSize: '11px', color: theme.textSecondary, fontWeight: '700', textTransform: 'uppercase' }}>Category</th>
                                    <th style={{ padding: '12px', textAlign: 'center', fontSize: '11px', color: theme.textSecondary, fontWeight: '700', textTransform: 'uppercase' }}>Quantity</th>
                                    <th style={{ padding: '12px', textAlign: 'center', fontSize: '11px', color: theme.textSecondary, fontWeight: '700', textTransform: 'uppercase' }}>Unit</th>
                                    <th style={{ padding: '12px', textAlign: 'right', fontSize: '11px', color: theme.textSecondary, fontWeight: '700', textTransform: 'uppercase' }}>Unit Cost</th>
                                    <th style={{ padding: '12px', textAlign: 'right', fontSize: '11px', color: theme.textSecondary, fontWeight: '700', textTransform: 'uppercase' }}>Total Value</th>
                                    <th style={{ padding: '12px', textAlign: 'center', fontSize: '11px', color: theme.textSecondary, fontWeight: '700', textTransform: 'uppercase' }}>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {data.inventory.map((item, i) => {
                                    const isOutOfStock = (item.quantity || 0) === 0;
                                    const isLow = !isOutOfStock && (item.quantity || 0) <= (item.minStock || item.reorderLevel || 5);
                                    const itemValue = (item.quantity || 0) * (item.unitCost || item.cost || 0);
                                    const statusStyle = isOutOfStock 
                                        ? { background: '#fef2f2', color: '#dc2626' }
                                        : isLow 
                                        ? { background: '#fef9c3', color: '#92400e' }
                                        : { background: '#dcfce7', color: '#166534' };
                                    const statusText = isOutOfStock ? 'Out of Stock' : isLow ? 'Low Stock' : 'In Stock';
                                    return (
                                        <tr key={i} style={{ borderBottom: `1px solid ${theme.border}` }}>
                                            <td style={{ padding: '12px', color: theme.text, fontWeight: '600' }}>{item.name}</td>
                                            <td style={{ padding: '12px', color: theme.textSecondary }}>{item.category || 'Uncategorized'}</td>
                                            <td style={{ padding: '12px', textAlign: 'center', fontWeight: '700', color: isOutOfStock ? '#ef4444' : isLow ? '#f59e0b' : theme.text }}>{item.quantity || 0}</td>
                                            <td style={{ padding: '12px', textAlign: 'center', color: theme.textSecondary }}>{item.unit || 'pcs'}</td>
                                            <td style={{ padding: '12px', textAlign: 'right', color: theme.text }}>{formatCurrency(item.unitCost || item.cost || 0)}</td>
                                            <td style={{ padding: '12px', textAlign: 'right', fontWeight: '700', color: '#3b82f6' }}>{formatCurrency(itemValue)}</td>
                                            <td style={{ padding: '12px', textAlign: 'center' }}>
                                                <span style={{ padding: '4px 10px', fontSize: '10px', fontWeight: '700', textTransform: 'uppercase', ...statusStyle }}>
                                                    {statusText}
                                                </span>
                                            </td>
                                        </tr>
                                    );
                                })}
                                {data.inventory.length === 0 && (
                                    <tr><td colSpan="7" style={{ padding: '40px', textAlign: 'center', color: theme.textSecondary }}>No inventory items found</td></tr>
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>
            )}

            {/* Generate Reports Tab */}
            {activeTab === 'generate' && (
                <div style={{ padding: '20px' }}>
                    <div style={{ display: 'grid', gridTemplateColumns: '350px 1fr', gap: '20px' }}>
                        {/* Report Options */}
                        <div style={cardStyle}>
                            <h4 style={{ margin: '0 0 20px', color: theme.text, fontWeight: '700' }}>Report Generator</h4>
                            
                            <div style={{ marginBottom: '16px' }}>
                                <label style={{ display: 'block', fontSize: '11px', color: theme.textSecondary, textTransform: 'uppercase', fontWeight: '600', marginBottom: '6px' }}>Report Type</label>
                                <select value={reportType} onChange={(e) => setReportType(e.target.value)} style={{ width: '100%', padding: '12px', border: `1px solid ${theme.border}`, background: theme.inputBg, color: theme.text, fontSize: '14px' }}>
                                    <option value="summary">Executive Summary</option>
                                    <option value="revenue">Revenue Report</option>
                                    <option value="expenses">Expenses Report</option>
                                    <option value="fleet">Fleet Account Report</option>
                                    <option value="inventory">Inventory Report</option>
                                    <option value="customers">Customer Report</option>
                                    <option value="staff">Staff Report</option>
                                    <option value="profit">Profit & Loss Statement</option>
                                </select>
                            </div>

                            <div style={{ marginBottom: '16px' }}>
                                <label style={{ display: 'block', fontSize: '11px', color: theme.textSecondary, textTransform: 'uppercase', fontWeight: '600', marginBottom: '6px' }}>Date Range</label>
                                <select value={dateRange} onChange={(e) => setDateRange(e.target.value)} style={{ width: '100%', padding: '12px', border: `1px solid ${theme.border}`, background: theme.inputBg, color: theme.text, fontSize: '14px' }}>
                                    <option value="today">Today</option>
                                    <option value="week">Last 7 Days</option>
                                    <option value="month">This Month</option>
                                    <option value="year">This Year</option>
                                    <option value="all">All Time</option>
                                </select>
                            </div>

                            <div style={{ background: theme.bgSecondary, padding: '16px', marginBottom: '20px', border: `1px solid ${theme.border}` }}>
                                <div style={{ fontSize: '12px', color: theme.textSecondary, marginBottom: '8px' }}>Report Summary</div>
                                <div style={{ fontSize: '14px', color: theme.text }}>
                                    {reportType === 'summary' && 'Complete overview with key metrics, revenue breakdown, and expenses.'}
                                    {reportType === 'revenue' && `${filteredBilling.length} transactions totaling ${formatCurrency(totalRevenue)}`}
                                    {reportType === 'expenses' && `${filteredExpenses.length} expenses totaling ${formatCurrency(totalExpenses)}`}
                                    {reportType === 'fleet' && `${data.fleet.length} fleet accounts with ${fleetVehicles} vehicles`}
                                    {reportType === 'inventory' && `${data.inventory.length} items valued at ${formatCurrency(inventoryValue)}`}
                                    {reportType === 'customers' && `${totalCustomers} registered customers`}
                                    {reportType === 'staff' && `${data.staff.length} staff members`}
                                    {reportType === 'profit' && `Net Profit: ${formatCurrency(netProfit)}`}
                                </div>
                            </div>

                            <div style={{ display: 'grid', gap: '10px' }}>
                                <button onClick={() => generateReport('preview')} style={{ padding: '14px 20px', background: '#3b82f6', color: 'white', border: 'none', fontWeight: '600', cursor: 'pointer', fontSize: '14px' }}>Preview Report</button>
                                <button onClick={() => generateReport('print')} style={{ padding: '14px 20px', background: '#1e293b', color: 'white', border: 'none', fontWeight: '600', cursor: 'pointer', fontSize: '14px' }}>Print Report</button>
                                <button onClick={() => generateReport('pdf')} style={{ padding: '14px 20px', background: 'none', border: `1px solid ${theme.border}`, color: theme.text, fontWeight: '600', cursor: 'pointer', fontSize: '14px' }}>Download PDF</button>
                            </div>
                        </div>

                        {/* Available Reports */}
                        <div>
                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '16px' }}>
                                {[
                                    { type: 'summary', title: 'Executive Summary', desc: 'Complete business overview', icon: 'üìä', color: '#3b82f6' },
                                    { type: 'revenue', title: 'Revenue Report', desc: 'All transactions and income', icon: 'üí∞', color: '#10b981' },
                                    { type: 'expenses', title: 'Expenses Report', desc: 'All expenses by category', icon: 'üìâ', color: '#ef4444' },
                                    { type: 'profit', title: 'Profit & Loss', desc: 'Income vs expenses analysis', icon: 'üìà', color: '#8b5cf6' },
                                    { type: 'fleet', title: 'Fleet Accounts', desc: 'All fleet account details', icon: 'üöõ', color: '#f59e0b' },
                                    { type: 'inventory', title: 'Inventory Report', desc: 'Stock levels and values', icon: 'üì¶', color: '#06b6d4' },
                                    { type: 'customers', title: 'Customer Report', desc: 'Customer database summary', icon: 'üë•', color: '#ec4899' },
                                    { type: 'staff', title: 'Staff Report', desc: 'Staff roster and details', icon: 'üëî', color: '#84cc16' },
                                ].map((r, i) => (
                                    <div key={i} onClick={() => setReportType(r.type)} style={{ ...cardStyle, cursor: 'pointer', border: reportType === r.type ? `2px solid ${r.color}` : `1px solid ${theme.border}`, transition: 'all 0.2s' }}>
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                                            <div style={{ fontSize: '32px' }}>{r.icon}</div>
                                            <div>
                                                <div style={{ fontWeight: '700', color: theme.text }}>{r.title}</div>
                                                <div style={{ fontSize: '12px', color: theme.textSecondary }}>{r.desc}</div>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>

                            {/* Quick Stats for Selected Report */}
                            <div style={{ ...cardStyle, marginTop: '20px' }}>
                                <h4 style={{ margin: '0 0 16px', color: theme.text, fontWeight: '700' }}>
                                    {reportType === 'summary' && 'Executive Summary Preview'}
                                    {reportType === 'revenue' && 'Revenue Preview'}
                                    {reportType === 'expenses' && 'Expenses Preview'}
                                    {reportType === 'profit' && 'Profit & Loss Preview'}
                                    {reportType === 'fleet' && 'Fleet Preview'}
                                    {reportType === 'inventory' && 'Inventory Preview'}
                                    {reportType === 'customers' && 'Customer Preview'}
                                    {reportType === 'staff' && 'Staff Preview'}
                                </h4>
                                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '12px' }}>
                                    {reportType === 'summary' && <>
                                        <div style={{ background: theme.bgSecondary, padding: '16px', textAlign: 'center' }}>
                                            <div style={{ fontSize: '20px', fontWeight: '800', color: '#10b981' }}>{formatCurrency(totalRevenue)}</div>
                                            <div style={{ fontSize: '10px', color: theme.textSecondary, textTransform: 'uppercase' }}>Revenue</div>
                                        </div>
                                        <div style={{ background: theme.bgSecondary, padding: '16px', textAlign: 'center' }}>
                                            <div style={{ fontSize: '20px', fontWeight: '800', color: '#ef4444' }}>{formatCurrency(totalExpenses)}</div>
                                            <div style={{ fontSize: '10px', color: theme.textSecondary, textTransform: 'uppercase' }}>Expenses</div>
                                        </div>
                                        <div style={{ background: theme.bgSecondary, padding: '16px', textAlign: 'center' }}>
                                            <div style={{ fontSize: '20px', fontWeight: '800', color: netProfit >= 0 ? '#10b981' : '#ef4444' }}>{formatCurrency(netProfit)}</div>
                                            <div style={{ fontSize: '10px', color: theme.textSecondary, textTransform: 'uppercase' }}>Net Profit</div>
                                        </div>
                                        <div style={{ background: theme.bgSecondary, padding: '16px', textAlign: 'center' }}>
                                            <div style={{ fontSize: '20px', fontWeight: '800', color: '#3b82f6' }}>{totalServices}</div>
                                            <div style={{ fontSize: '10px', color: theme.textSecondary, textTransform: 'uppercase' }}>Services</div>
                                        </div>
                                    </>}
                                    {reportType === 'revenue' && filteredBilling.slice(0, 4).map((b, i) => (
                                        <div key={i} style={{ background: theme.bgSecondary, padding: '12px' }}>
                                            <div style={{ fontSize: '11px', color: theme.textSecondary }}>{new Date(b.createdAt || b.date).toLocaleDateString()}</div>
                                            <div style={{ fontWeight: '600', color: theme.text, fontSize: '13px' }}>{b.service || b.packageName || 'Service'}</div>
                                            <div style={{ fontWeight: '700', color: '#10b981' }}>{formatCurrency(b.total || b.amount)}</div>
                                        </div>
                                    ))}
                                    {reportType === 'expenses' && filteredExpenses.slice(0, 4).map((e, i) => (
                                        <div key={i} style={{ background: theme.bgSecondary, padding: '12px' }}>
                                            <div style={{ fontSize: '11px', color: theme.textSecondary }}>{e.category || 'Other'}</div>
                                            <div style={{ fontWeight: '600', color: theme.text, fontSize: '13px' }}>{e.description || 'Expense'}</div>
                                            <div style={{ fontWeight: '700', color: '#ef4444' }}>{formatCurrency(e.amount)}</div>
                                        </div>
                                    ))}
                                    {reportType === 'fleet' && data.fleet.slice(0, 4).map((f, i) => (
                                        <div key={i} style={{ background: theme.bgSecondary, padding: '12px' }}>
                                            <div style={{ fontWeight: '600', color: theme.text, fontSize: '13px' }}>{f.companyName}</div>
                                            <div style={{ fontSize: '11px', color: theme.textSecondary }}>{f.vehicles?.length || 0} vehicles</div>
                                            <div style={{ fontWeight: '700', color: f.balance >= 0 ? '#10b981' : '#ef4444' }}>{formatCurrency(f.balance)}</div>
                                        </div>
                                    ))}
                                    {reportType === 'inventory' && data.inventory.slice(0, 4).map((item, i) => (
                                        <div key={i} style={{ background: theme.bgSecondary, padding: '12px' }}>
                                            <div style={{ fontWeight: '600', color: theme.text, fontSize: '13px' }}>{item.name}</div>
                                            <div style={{ fontSize: '11px', color: theme.textSecondary }}>{item.quantity || 0} {item.unit || 'pcs'}</div>
                                            <div style={{ fontWeight: '700', color: '#3b82f6' }}>{formatCurrency((item.quantity || 0) * (item.unitCost || 0))}</div>
                                        </div>
                                    ))}
                                    {reportType === 'customers' && <>
                                        <div style={{ background: theme.bgSecondary, padding: '16px', textAlign: 'center' }}>
                                            <div style={{ fontSize: '20px', fontWeight: '800', color: '#3b82f6' }}>{totalCustomers}</div>
                                            <div style={{ fontSize: '10px', color: theme.textSecondary, textTransform: 'uppercase' }}>Total</div>
                                        </div>
                                        <div style={{ background: theme.bgSecondary, padding: '16px', textAlign: 'center' }}>
                                            <div style={{ fontSize: '20px', fontWeight: '800', color: '#10b981' }}>{loyaltyPoints.toLocaleString()}</div>
                                            <div style={{ fontSize: '10px', color: theme.textSecondary, textTransform: 'uppercase' }}>Loyalty Pts</div>
                                        </div>
                                    </>}
                                    {reportType === 'staff' && <>
                                        <div style={{ background: theme.bgSecondary, padding: '16px', textAlign: 'center' }}>
                                            <div style={{ fontSize: '20px', fontWeight: '800', color: '#3b82f6' }}>{data.staff.length}</div>
                                            <div style={{ fontSize: '10px', color: theme.textSecondary, textTransform: 'uppercase' }}>Total Staff</div>
                                        </div>
                                        <div style={{ background: theme.bgSecondary, padding: '16px', textAlign: 'center' }}>
                                            <div style={{ fontSize: '20px', fontWeight: '800', color: '#10b981' }}>{data.staff.filter(s => s.status === 'active').length}</div>
                                            <div style={{ fontSize: '10px', color: theme.textSecondary, textTransform: 'uppercase' }}>Active</div>
                                        </div>
                                    </>}
                                    {reportType === 'profit' && <>
                                        <div style={{ background: theme.bgSecondary, padding: '16px', textAlign: 'center' }}>
                                            <div style={{ fontSize: '20px', fontWeight: '800', color: '#10b981' }}>{formatCurrency(totalRevenue)}</div>
                                            <div style={{ fontSize: '10px', color: theme.textSecondary, textTransform: 'uppercase' }}>Income</div>
                                        </div>
                                        <div style={{ background: theme.bgSecondary, padding: '16px', textAlign: 'center' }}>
                                            <div style={{ fontSize: '20px', fontWeight: '800', color: '#ef4444' }}>{formatCurrency(totalExpenses)}</div>
                                            <div style={{ fontSize: '10px', color: theme.textSecondary, textTransform: 'uppercase' }}>Expenses</div>
                                        </div>
                                        <div style={{ background: theme.bgSecondary, padding: '16px', textAlign: 'center' }}>
                                            <div style={{ fontSize: '20px', fontWeight: '800', color: netProfit >= 0 ? '#10b981' : '#ef4444' }}>{formatCurrency(netProfit)}</div>
                                            <div style={{ fontSize: '10px', color: theme.textSecondary, textTransform: 'uppercase' }}>Net Profit</div>
                                        </div>
                                        <div style={{ background: theme.bgSecondary, padding: '16px', textAlign: 'center' }}>
                                            <div style={{ fontSize: '20px', fontWeight: '800', color: '#8b5cf6' }}>{totalRevenue > 0 ? ((netProfit / totalRevenue) * 100).toFixed(1) : 0}%</div>
                                            <div style={{ fontSize: '10px', color: theme.textSecondary, textTransform: 'uppercase' }}>Margin</div>
                                        </div>
                                    </>}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* Report Preview Modal */}
            {showPreview && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.7)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 }} onClick={() => setShowPreview(false)}>
                    <div style={{ background: 'white', width: '900px', maxWidth: '95vw', maxHeight: '90vh', overflow: 'auto', border: '1px solid #e2e8f0' }} onClick={(e) => e.stopPropagation()}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '16px 20px', background: '#1e293b', color: 'white' }}>
                            <h3 style={{ margin: 0, fontWeight: '700' }}>Report Preview</h3>
                            <div style={{ display: 'flex', gap: '8px' }}>
                                <button onClick={() => { generateReport('print'); setShowPreview(false); }} style={{ padding: '8px 16px', background: '#10b981', border: 'none', color: 'white', fontWeight: '600', cursor: 'pointer' }}>Print</button>
                                <button onClick={() => setShowPreview(false)} style={{ padding: '8px 16px', background: 'none', border: '1px solid white', color: 'white', fontWeight: '600', cursor: 'pointer' }}>Close</button>
                            </div>
                        </div>
                        <div dangerouslySetInnerHTML={{ __html: previewContent }} style={{ padding: '20px' }}></div>
                    </div>
                </div>
            )}
        </div>
    );

    function generateReport(action) {
        const periodLabel = dateRange === 'today' ? 'Today' : dateRange === 'week' ? 'Last 7 Days' : dateRange === 'month' ? 'This Month' : dateRange === 'year' ? 'This Year' : 'All Time';
        const branding = getBrandingForReceipts();
        
        let reportTitle = '';
        let reportBody = '';

        if (reportType === 'summary' || reportType === 'profit') {
            reportTitle = reportType === 'summary' ? 'Executive Summary Report' : 'Profit & Loss Statement';
            reportBody = `
                <div class="section"><div class="section-title">Key Performance Metrics</div>
                <div class="grid">
                    <div class="card"><div class="value green">${branding.currencySymbol || 'KES'} ${totalRevenue.toLocaleString()}</div><div class="label">Total Revenue</div></div>
                    <div class="card"><div class="value red">${branding.currencySymbol || 'KES'} ${totalExpenses.toLocaleString()}</div><div class="label">Total Expenses</div></div>
                    <div class="card"><div class="value ${netProfit >= 0 ? 'green' : 'red'}">${branding.currencySymbol || 'KES'} ${netProfit.toLocaleString()}</div><div class="label">Net Profit</div></div>
                    <div class="card"><div class="value blue">${totalServices}</div><div class="label">Services</div></div>
                </div></div>
                ${topServices.length > 0 ? `<div class="section"><div class="section-title">Revenue by Service</div>
                <table><thead><tr><th>Service</th><th style="text-align:right">Revenue</th><th style="text-align:right">%</th></tr></thead>
                <tbody>${topServices.map(([svc, amt]) => `<tr><td>${svc}</td><td style="text-align:right">${branding.currencySymbol || 'KES'} ${amt.toLocaleString()}</td><td style="text-align:right">${((amt/totalRevenue)*100).toFixed(1)}%</td></tr>`).join('')}</tbody></table></div>` : ''}
                ${topExpenseCategories.length > 0 ? `<div class="section"><div class="section-title">Expenses by Category</div>
                <table><thead><tr><th>Category</th><th style="text-align:right">Amount</th><th style="text-align:right">%</th></tr></thead>
                <tbody>${topExpenseCategories.map(([cat, amt]) => `<tr><td>${cat}</td><td style="text-align:right">${branding.currencySymbol || 'KES'} ${amt.toLocaleString()}</td><td style="text-align:right">${((amt/totalExpenses)*100).toFixed(1)}%</td></tr>`).join('')}</tbody></table></div>` : ''}`;
        } else if (reportType === 'revenue') {
            reportTitle = 'Revenue Report';
            reportBody = `
                <div class="section"><div class="section-title">Revenue Summary</div>
                <div class="grid">
                    <div class="card"><div class="value green">${branding.currencySymbol || 'KES'} ${totalRevenue.toLocaleString()}</div><div class="label">Total Revenue</div></div>
                    <div class="card"><div class="value blue">${filteredBilling.length}</div><div class="label">Transactions</div></div>
                    <div class="card"><div class="value purple">${branding.currencySymbol || 'KES'} ${avgTicket.toLocaleString()}</div><div class="label">Avg Ticket</div></div>
                </div></div>
                <div class="section"><div class="section-title">Transactions</div>
                <table><thead><tr><th>Date</th><th>Service</th><th>Customer</th><th style="text-align:right">Amount</th></tr></thead>
                <tbody>${filteredBilling.slice(0, 50).map(b => `<tr><td>${new Date(b.createdAt || b.date).toLocaleDateString()}</td><td>${b.service || b.packageName || '-'}</td><td>${b.customerName || '-'}</td><td style="text-align:right" class="green">${branding.currencySymbol || 'KES'} ${(b.total || b.amount || 0).toLocaleString()}</td></tr>`).join('')}</tbody></table></div>`;
        } else if (reportType === 'expenses') {
            reportTitle = 'Expenses Report';
            reportBody = `
                <div class="section"><div class="section-title">Expenses Summary</div>
                <div class="grid">
                    <div class="card"><div class="value red">${branding.currencySymbol || 'KES'} ${totalExpenses.toLocaleString()}</div><div class="label">Total Expenses</div></div>
                    <div class="card"><div class="value blue">${filteredExpenses.length}</div><div class="label">Count</div></div>
                </div></div>
                <div class="section"><div class="section-title">Expense List</div>
                <table><thead><tr><th>Date</th><th>Description</th><th>Category</th><th style="text-align:right">Amount</th></tr></thead>
                <tbody>${filteredExpenses.slice(0, 50).map(e => `<tr><td>${new Date(e.date).toLocaleDateString()}</td><td>${e.description || '-'}</td><td>${e.category || '-'}</td><td style="text-align:right" class="red">${branding.currencySymbol || 'KES'} ${(e.amount || 0).toLocaleString()}</td></tr>`).join('')}</tbody></table></div>`;
        } else if (reportType === 'fleet') {
            reportTitle = 'Fleet Account Report';
            reportBody = `
                <div class="section"><div class="section-title">Fleet Summary</div>
                <div class="grid">
                    <div class="card"><div class="value blue">${data.fleet.length}</div><div class="label">Accounts</div></div>
                    <div class="card"><div class="value purple">${fleetVehicles}</div><div class="label">Vehicles</div></div>
                    <div class="card"><div class="value green">${branding.currencySymbol || 'KES'} ${fleetBalance.toLocaleString()}</div><div class="label">Total Balance</div></div>
                    <div class="card"><div class="value orange">${branding.currencySymbol || 'KES'} ${fleetSpent.toLocaleString()}</div><div class="label">Total Spent</div></div>
                </div></div>
                <div class="section"><div class="section-title">Fleet Accounts</div>
                <table><thead><tr><th>Company</th><th>Contact</th><th style="text-align:center">Vehicles</th><th style="text-align:right">Balance</th><th style="text-align:right">Spent</th></tr></thead>
                <tbody>${data.fleet.map(f => `<tr><td>${f.companyName}</td><td>${f.contactPerson || '-'}</td><td style="text-align:center">${f.vehicles?.length || 0}</td><td style="text-align:right" class="${f.balance >= 0 ? 'green' : 'red'}">${branding.currencySymbol || 'KES'} ${(f.balance || 0).toLocaleString()}</td><td style="text-align:right">${branding.currencySymbol || 'KES'} ${(f.totalSpent || 0).toLocaleString()}</td></tr>`).join('')}</tbody></table></div>`;
        } else if (reportType === 'inventory') {
            reportTitle = 'Inventory Report';
            reportBody = `
                <div class="section"><div class="section-title">Inventory Summary</div>
                <div class="grid">
                    <div class="card"><div class="value blue">${data.inventory.length}</div><div class="label">Total Items</div></div>
                    <div class="card"><div class="value green">${branding.currencySymbol || 'KES'} ${inventoryValue.toLocaleString()}</div><div class="label">Total Value</div></div>
                    <div class="card"><div class="value red">${lowStockItems}</div><div class="label">Low Stock</div></div>
                </div></div>
                <div class="section"><div class="section-title">Inventory Items</div>
                <table><thead><tr><th>Item</th><th>Category</th><th style="text-align:center">Qty</th><th style="text-align:right">Unit Cost</th><th style="text-align:right">Value</th></tr></thead>
                <tbody>${data.inventory.map(i => `<tr><td>${i.name}</td><td>${i.category || '-'}</td><td style="text-align:center">${i.quantity || 0} ${i.unit || ''}</td><td style="text-align:right">${branding.currencySymbol || 'KES'} ${(i.unitCost || 0).toLocaleString()}</td><td style="text-align:right" class="green">${branding.currencySymbol || 'KES'} ${((i.quantity || 0) * (i.unitCost || 0)).toLocaleString()}</td></tr>`).join('')}</tbody></table></div>`;
        } else if (reportType === 'customers') {
            reportTitle = 'Customer Report';
            reportBody = `
                <div class="section"><div class="section-title">Customer Summary</div>
                <div class="grid">
                    <div class="card"><div class="value blue">${totalCustomers}</div><div class="label">Total Customers</div></div>
                    <div class="card"><div class="value purple">${loyaltyPoints.toLocaleString()}</div><div class="label">Loyalty Points</div></div>
                </div></div>
                <div class="section"><div class="section-title">Customer List</div>
                <table><thead><tr><th>Name</th><th>Phone</th><th>Email</th><th style="text-align:right">Loyalty Points</th></tr></thead>
                <tbody>${data.customers.slice(0, 50).map(c => `<tr><td>${c.name}</td><td>${c.phone || '-'}</td><td>${c.email || '-'}</td><td style="text-align:right">${(c.loyaltyPoints || 0).toLocaleString()}</td></tr>`).join('')}</tbody></table></div>`;
        } else if (reportType === 'staff') {
            reportTitle = 'Staff Report';
            reportBody = `
                <div class="section"><div class="section-title">Staff Summary</div>
                <div class="grid">
                    <div class="card"><div class="value blue">${data.staff.length}</div><div class="label">Total Staff</div></div>
                    <div class="card"><div class="value green">${data.staff.filter(s => s.status === 'active').length}</div><div class="label">Active</div></div>
                </div></div>
                <div class="section"><div class="section-title">Staff List</div>
                <table><thead><tr><th>Name</th><th>Role</th><th>Phone</th><th>Status</th></tr></thead>
                <tbody>${data.staff.map(s => `<tr><td>${s.name}</td><td>${s.role || '-'}</td><td>${s.phone || '-'}</td><td class="${s.status === 'active' ? 'green' : 'red'}">${s.status || 'Unknown'}</td></tr>`).join('')}</tbody></table></div>`;
        }

        const content = `
<!DOCTYPE html><html><head><title>${branding.companyName } - ${reportTitle}</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}body{font-family:'Segoe UI',Arial,sans-serif;padding:30px;color:#1e293b;font-size:12px}
.header{text-align:center;margin-bottom:30px;padding-bottom:20px;border-bottom:2px solid #1e293b}
.logo{font-size:28px;font-weight:800;color:#10b981}.logo span{color:#1e293b}
.subtitle{color:#64748b;margin-top:8px}
.section{margin-bottom:24px}.section-title{font-size:14px;font-weight:700;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid #e2e8f0}
.grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px}
.card{background:#f8fafc;border:1px solid #e2e8f0;padding:14px;text-align:center}
.card .value{font-size:20px;font-weight:800}.card .label{font-size:10px;color:#64748b;text-transform:uppercase;margin-top:4px}
.green{color:#10b981}.red{color:#ef4444}.blue{color:#3b82f6}.purple{color:#8b5cf6}.orange{color:#f59e0b}
table{width:100%;border-collapse:collapse}th{background:#1e293b;color:white;padding:8px 10px;text-align:left;font-size:10px;text-transform:uppercase}
td{padding:8px 10px;border-bottom:1px solid #e2e8f0;font-size:11px}tr:nth-child(even){background:#f8fafc}
.footer{margin-top:30px;text-align:center;color:#64748b;font-size:11px;padding-top:20px;border-top:1px solid #e2e8f0}
@media print{body{padding:15px}.grid{grid-template-columns:repeat(4,1fr)}}
</style></head><body>
<div class="header"><div class="logo">${branding.companyName }</div><div class="subtitle">${reportTitle} - ${periodLabel}</div></div>
${reportBody}
<div class="footer">Generated on ${new Date().toLocaleString()} | ${branding.companyName } Car Wash Management System</div>
</body></html>`;

        if (action === 'preview') {
            setPreviewContent(reportBody);
            setShowPreview(true);
        } else if (action === 'print' || action === 'pdf') {
            const w = window.open('', '_blank');
            w.document.write(content);
            w.document.close();
            w.onload = () => w.print();
        }
    }
}

// ==================== MARKETING CRM MODULE ====================
function MarketingCRM() {
    const [customers, setCustomers] = useState([]);
    const [campaigns, setCampaigns] = useState([]);
    const [messages, setMessages] = useState([]);
    const [loading, setLoading] = useState(true);
    const [activeTab, setActiveTab] = useState('customers'); // 'customers', 'campaigns', 'messages', 'templates'
    const [searchQuery, setSearchQuery] = useState('');
    const [selectedCustomers, setSelectedCustomers] = useState([]);
    const [showComposeModal, setShowComposeModal] = useState(false);
    const [showCampaignModal, setShowCampaignModal] = useState(false);
    const [showTemplateModal, setShowTemplateModal] = useState(false);
    const [actionLoading, setActionLoading] = useState(false);
    const [error, setError] = useState(null);
    const [successMessage, setSuccessMessage] = useState(null);
    const [customerFilter, setCustomerFilter] = useState('all'); // 'all', 'active', 'inactive', 'loyal', 'new'
    const [isDark, setIsDark] = useState(document.documentElement.getAttribute('data-theme') === 'dark');

    // Message templates
    const [templates, setTemplates] = useState([
        { id: 1, name: 'Welcome Message', content: 'Welcome to EcoSpark Car Wash! Thank you for choosing us. Enjoy 10% off your next visit with code: WELCOME10', category: 'welcome' },
        { id: 2, name: 'Service Reminder', content: 'Hi {name}, your vehicle is due for a wash! Book now and get priority service. Visit us today at EcoSpark.', category: 'reminder' },
        { id: 3, name: 'Loyalty Reward', content: 'Congratulations {name}! You\'ve earned {points} loyalty points. Redeem them on your next visit for discounts!', category: 'loyalty' },
        { id: 4, name: 'Special Offer', content: 'üéâ Special Offer! Get 20% off all premium washes this weekend only. Don\'t miss out! - EcoSpark', category: 'promo' },
        { id: 5, name: 'Birthday Wish', content: 'Happy Birthday {name}! üéÇ Enjoy a FREE basic wash on us. Valid this week only. - EcoSpark Team', category: 'birthday' }
    ]);

    const [composeForm, setComposeForm] = useState({
        subject: '',
        message: '',
        sendVia: 'sms', // 'sms', 'email', 'both'
        scheduleTime: '',
        isScheduled: false
    });

    const [campaignForm, setCampaignForm] = useState({
        name: '',
        description: '',
        targetAudience: 'all',
        messageTemplate: '',
        startDate: '',
        endDate: '',
        status: 'draft'
    });

    const [templateForm, setTemplateForm] = useState({
        name: '',
        content: '',
        category: 'general'
    });

    // Listen for theme changes
    useEffect(() => {
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.attributeName === 'data-theme') {
                    setIsDark(document.documentElement.getAttribute('data-theme') === 'dark');
                }
            });
        });
        observer.observe(document.documentElement, { attributes: true });
        return () => observer.disconnect();
    }, []);

    // Theme colors
    const theme = {
        bg: isDark ? '#1e293b' : 'white',
        bgSecondary: isDark ? '#0f172a' : '#f8fafc',
        bgTertiary: isDark ? '#334155' : '#f1f5f9',
        text: isDark ? '#f1f5f9' : '#1e293b',
        textSecondary: isDark ? '#94a3b8' : '#64748b',
        border: isDark ? '#334155' : '#e2e8f0',
        inputBg: isDark ? '#1e293b' : 'white',
        cardBg: isDark ? '#1e293b' : 'white',
        hoverBg: isDark ? '#334155' : '#f1f5f9'
    };

    // Fetch customers from customer service
    useEffect(() => {
        const services = window.FirebaseServices;
        if (!services?.customerService) {
            setLoading(false);
            return;
        }
        const unsubscribe = services.customerService.subscribeToCustomers(
            (data) => {
                setCustomers(data);
                setLoading(false);
            },
            (err) => {
                setError('Failed to load customers');
                setLoading(false);
            }
        );
        return () => unsubscribe && unsubscribe();
    }, []);

    // Clear success message
    useEffect(() => {
        if (successMessage) {
            const timer = setTimeout(() => setSuccessMessage(null), 3000);
            return () => clearTimeout(timer);
        }
    }, [successMessage]);

    // Filter customers
    const filteredCustomers = customers.filter(customer => {
        const matchesSearch = customer.name?.toLowerCase().includes(searchQuery.toLowerCase()) ||
            customer.phone?.includes(searchQuery) ||
            customer.email?.toLowerCase().includes(searchQuery.toLowerCase());
        
        if (customerFilter === 'all') return matchesSearch;
        if (customerFilter === 'loyal') return matchesSearch && (customer.loyaltyPoints || 0) >= 100;
        if (customerFilter === 'new') {
            const createdAt = new Date(customer.createdAt);
            const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
            return matchesSearch && createdAt > thirtyDaysAgo;
        }
        return matchesSearch;
    });

    // Toggle customer selection
    const toggleCustomerSelection = (customerId) => {
        setSelectedCustomers(prev => 
            prev.includes(customerId) 
                ? prev.filter(id => id !== customerId)
                : [...prev, customerId]
        );
    };

    // Select all filtered customers
    const selectAllCustomers = () => {
        if (selectedCustomers.length === filteredCustomers.length) {
            setSelectedCustomers([]);
        } else {
            setSelectedCustomers(filteredCustomers.map(c => c.id));
        }
    };

    // Send message to selected customers
    const handleSendMessage = async () => {
        if (selectedCustomers.length === 0) {
            setError('Please select at least one customer');
            return;
        }
        if (!composeForm.message.trim()) {
            setError('Please enter a message');
            return;
        }

        setActionLoading(true);
        setError(null);

        try {
            const selectedCustomerData = customers.filter(c => selectedCustomers.includes(c.id));
            
            // Create message record
            const newMessage = {
                id: Date.now(),
                subject: composeForm.subject || 'No Subject',
                content: composeForm.message,
                recipients: selectedCustomerData.map(c => ({ id: c.id, name: c.name, phone: c.phone, email: c.email })),
                recipientCount: selectedCustomers.length,
                sendVia: composeForm.sendVia,
                status: composeForm.isScheduled ? 'scheduled' : 'sent',
                scheduledTime: composeForm.isScheduled ? composeForm.scheduleTime : null,
                sentAt: composeForm.isScheduled ? null : new Date().toISOString(),
                createdAt: new Date().toISOString()
            };

            setMessages(prev => [newMessage, ...prev]);
            setSuccessMessage(`Message ${composeForm.isScheduled ? 'scheduled' : 'sent'} to ${selectedCustomers.length} customer(s)`);
            setShowComposeModal(false);
            setSelectedCustomers([]);
            setComposeForm({ subject: '', message: '', sendVia: 'sms', scheduleTime: '', isScheduled: false });

            // Log activity
            if (window.FirebaseServices?.activityService) {
                await window.FirebaseServices.activityService.logActivity({
                    type: 'marketing',
                    action: 'message_sent',
                    details: `Sent ${composeForm.sendVia} to ${selectedCustomers.length} customers`,
                    metadata: { recipientCount: selectedCustomers.length, sendVia: composeForm.sendVia }
                });
            }
        } catch (err) {
            setError(err.message);
        } finally {
            setActionLoading(false);
        }
    };

    // Create campaign
    const handleCreateCampaign = async () => {
        if (!campaignForm.name.trim()) {
            setError('Please enter campaign name');
            return;
        }

        setActionLoading(true);
        setError(null);

        try {
            const newCampaign = {
                id: Date.now(),
                ...campaignForm,
                createdAt: new Date().toISOString(),
                stats: { sent: 0, opened: 0, clicked: 0 }
            };

            setCampaigns(prev => [newCampaign, ...prev]);
            setSuccessMessage('Campaign created successfully');
            setShowCampaignModal(false);
            setCampaignForm({ name: '', description: '', targetAudience: 'all', messageTemplate: '', startDate: '', endDate: '', status: 'draft' });
        } catch (err) {
            setError(err.message);
        } finally {
            setActionLoading(false);
        }
    };

    // Save template
    const handleSaveTemplate = () => {
        if (!templateForm.name.trim() || !templateForm.content.trim()) {
            setError('Please fill in template name and content');
            return;
        }

        const newTemplate = {
            id: Date.now(),
            ...templateForm
        };

        setTemplates(prev => [...prev, newTemplate]);
        setSuccessMessage('Template saved successfully');
        setShowTemplateModal(false);
        setTemplateForm({ name: '', content: '', category: 'general' });
    };

    // Use template
    const useTemplate = (template) => {
        setComposeForm(prev => ({ ...prev, message: template.content }));
        setShowComposeModal(true);
    };

    // Stats
    const stats = {
        totalCustomers: customers.length,
        selectedCount: selectedCustomers.length,
        messagesSent: messages.filter(m => m.status === 'sent').length,
        activeCampaigns: campaigns.filter(c => c.status === 'active').length,
        loyalCustomers: customers.filter(c => (c.loyaltyPoints || 0) >= 100).length
    };

    const inputStyle = {
        width: '100%',
        padding: '12px 16px',
        border: `1px solid ${theme.border}`,
        borderRadius: '4px',
        fontSize: '14px',
        background: theme.inputBg,
        color: theme.text,
        outline: 'none'
    };

    const labelStyle = {
        display: 'block',
        marginBottom: '8px',
        fontSize: '13px',
        fontWeight: '600',
        color: theme.textSecondary,
        textTransform: 'uppercase',
        letterSpacing: '0.5px'
    };

    const tabStyle = (isActive) => ({
        padding: '14px 28px',
        background: isActive ? '#3b82f6' : 'transparent',
        color: isActive ? 'white' : theme.textSecondary,
        border: isActive ? 'none' : `1px solid ${theme.border}`,
        cursor: 'pointer',
        fontSize: '14px',
        fontWeight: '600',
        borderRadius: '4px',
        transition: 'all 0.2s'
    });

    if (loading) {
        return (
            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', height: '400px' }}>
                <div style={{ textAlign: 'center' }}>
                    <div style={{ fontSize: '40px', marginBottom: '16px' }}>üì£</div>
                    <div style={{ color: theme.textSecondary }}>Loading Marketing CRM...</div>
                </div>
            </div>
        );
    }

    return (
        <div style={{ padding: '32px', maxWidth: '1600px', margin: '0 auto' }}>
            {/* Header with Stats */}
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '24px', marginBottom: '32px' }}>
                <div style={{ background: theme.cardBg, padding: '24px', borderRadius: '4px', border: `1px solid ${theme.border}` }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
                        <div style={{ width: '56px', height: '56px', borderRadius: '4px', background: '#dbeafe', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '28px' }}>üë•</div>
                        <div>
                            <div style={{ fontSize: '32px', fontWeight: '700', color: theme.text, lineHeight: '1' }}>{stats.totalCustomers}</div>
                            <div style={{ fontSize: '13px', color: theme.textSecondary, marginTop: '4px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Total Customers</div>
                        </div>
                    </div>
                </div>
                <div style={{ background: theme.cardBg, padding: '24px', borderRadius: '4px', border: `1px solid ${theme.border}` }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
                        <div style={{ width: '56px', height: '56px', borderRadius: '4px', background: '#d1fae5', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '28px' }}>‚≠ê</div>
                        <div>
                            <div style={{ fontSize: '32px', fontWeight: '700', color: theme.text, lineHeight: '1' }}>{stats.loyalCustomers}</div>
                            <div style={{ fontSize: '13px', color: theme.textSecondary, marginTop: '4px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Loyal Customers</div>
                        </div>
                    </div>
                </div>
                <div style={{ background: theme.cardBg, padding: '24px', borderRadius: '4px', border: `1px solid ${theme.border}` }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
                        <div style={{ width: '56px', height: '56px', borderRadius: '4px', background: '#fef3c7', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '28px' }}>‚úâÔ∏è</div>
                        <div>
                            <div style={{ fontSize: '32px', fontWeight: '700', color: theme.text, lineHeight: '1' }}>{stats.messagesSent}</div>
                            <div style={{ fontSize: '13px', color: theme.textSecondary, marginTop: '4px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Messages Sent</div>
                        </div>
                    </div>
                </div>
                <div style={{ background: theme.cardBg, padding: '24px', borderRadius: '4px', border: `1px solid ${theme.border}` }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
                        <div style={{ width: '56px', height: '56px', borderRadius: '4px', background: '#f3e8ff', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '28px' }}>üì¢</div>
                        <div>
                            <div style={{ fontSize: '32px', fontWeight: '700', color: theme.text, lineHeight: '1' }}>{stats.activeCampaigns}</div>
                            <div style={{ fontSize: '13px', color: theme.textSecondary, marginTop: '4px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Active Campaigns</div>
                        </div>
                    </div>
                </div>
            </div>

            {/* Success/Error Messages */}
            {successMessage && (
                <div style={{ padding: '16px 20px', background: '#d1fae5', color: '#065f46', borderRadius: '4px', marginBottom: '24px', display: 'flex', alignItems: 'center', gap: '12px', fontWeight: '500' }}>
                    ‚úÖ {successMessage}
                </div>
            )}
            {error && (
                <div style={{ padding: '16px 20px', background: '#fee2e2', color: '#991b1b', borderRadius: '4px', marginBottom: '24px', display: 'flex', alignItems: 'center', justifyContent: 'space-between', fontWeight: '500' }}>
                    <span>‚ùå {error}</span>
                    <button onClick={() => setError(null)} style={{ background: 'none', border: 'none', cursor: 'pointer', fontSize: '20px', color: '#991b1b' }}>√ó</button>
                </div>
            )}

            {/* Tabs */}
            <div style={{ display: 'flex', gap: '12px', marginBottom: '32px', borderBottom: `2px solid ${theme.border}`, paddingBottom: '16px' }}>
                <button onClick={() => setActiveTab('customers')} style={tabStyle(activeTab === 'customers')}>üë• Customers</button>
                <button onClick={() => setActiveTab('campaigns')} style={tabStyle(activeTab === 'campaigns')}>üì¢ Campaigns</button>
                <button onClick={() => setActiveTab('messages')} style={tabStyle(activeTab === 'messages')}>‚úâÔ∏è Message History</button>
                <button onClick={() => setActiveTab('templates')} style={tabStyle(activeTab === 'templates')}>üìù Templates</button>
            </div>

            {/* Customers Tab */}
            {activeTab === 'customers' && (
                <div style={{ background: theme.cardBg, borderRadius: '4px', border: `1px solid ${theme.border}`, overflow: 'hidden' }}>
                    <div style={{ padding: '20px 24px', borderBottom: `1px solid ${theme.border}`, display: 'flex', gap: '16px', flexWrap: 'wrap', alignItems: 'center', justifyContent: 'space-between', background: theme.bgSecondary }}>
                        <div style={{ display: 'flex', gap: '16px', flexWrap: 'wrap', alignItems: 'center' }}>
                            <input
                                type="text"
                                placeholder="Search customers..."
                                value={searchQuery}
                                onChange={(e) => setSearchQuery(e.target.value)}
                                style={{ ...inputStyle, width: '300px' }}
                            />
                            <select value={customerFilter} onChange={(e) => setCustomerFilter(e.target.value)} style={{ ...inputStyle, width: '180px' }}>
                                <option value="all">All Customers</option>
                                <option value="loyal">Loyal (100+ pts)</option>
                                <option value="new">New (30 days)</option>
                            </select>
                        </div>
                        <div style={{ display: 'flex', gap: '16px' }}>
                            {selectedCustomers.length > 0 && (
                                <button
                                    onClick={() => setShowComposeModal(true)}
                                    style={{ padding: '12px 24px', background: '#3b82f6', color: 'white', border: 'none', borderRadius: '4px', fontWeight: '600', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '10px' }}
                                >
                                    ‚úâÔ∏è Send Message ({selectedCustomers.length})
                                </button>
                            )}
                            <button
                                onClick={selectAllCustomers}
                                style={{ padding: '12px 24px', background: theme.bgTertiary, color: theme.text, border: `1px solid ${theme.border}`, borderRadius: '4px', fontWeight: '600', cursor: 'pointer' }}
                            >
                                {selectedCustomers.length === filteredCustomers.length ? 'Deselect All' : 'Select All'}
                            </button>
                        </div>
                    </div>
                    <div style={{ maxHeight: '600px', overflowY: 'auto' }}>
                        <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                            <thead>
                                <tr style={{ background: theme.bgTertiary }}>
                                    <th style={{ padding: '16px 20px', textAlign: 'left', fontWeight: '700', color: theme.text, borderBottom: `2px solid ${theme.border}`, width: '50px', textTransform: 'uppercase', fontSize: '12px', letterSpacing: '0.5px' }}>
                                        <input
                                            type="checkbox"
                                            checked={selectedCustomers.length === filteredCustomers.length && filteredCustomers.length > 0}
                                            onChange={selectAllCustomers}
                                            style={{ width: '18px', height: '18px', cursor: 'pointer' }}
                                        />
                                    </th>
                                    <th style={{ padding: '16px 20px', textAlign: 'left', fontWeight: '700', color: theme.text, borderBottom: `2px solid ${theme.border}`, textTransform: 'uppercase', fontSize: '12px', letterSpacing: '0.5px' }}>Customer</th>
                                    <th style={{ padding: '16px 20px', textAlign: 'left', fontWeight: '700', color: theme.text, borderBottom: `2px solid ${theme.border}`, textTransform: 'uppercase', fontSize: '12px', letterSpacing: '0.5px' }}>Contact</th>
                                    <th style={{ padding: '16px 20px', textAlign: 'center', fontWeight: '700', color: theme.text, borderBottom: `2px solid ${theme.border}`, textTransform: 'uppercase', fontSize: '12px', letterSpacing: '0.5px' }}>Loyalty</th>
                                    <th style={{ padding: '16px 20px', textAlign: 'center', fontWeight: '700', color: theme.text, borderBottom: `2px solid ${theme.border}`, textTransform: 'uppercase', fontSize: '12px', letterSpacing: '0.5px' }}>Visits</th>
                                    <th style={{ padding: '16px 20px', textAlign: 'center', fontWeight: '700', color: theme.text, borderBottom: `2px solid ${theme.border}`, textTransform: 'uppercase', fontSize: '12px', letterSpacing: '0.5px' }}>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {filteredCustomers.length === 0 ? (
                                    <tr><td colSpan="6" style={{ padding: '60px', textAlign: 'center', color: theme.textSecondary, fontSize: '15px' }}>No customers found</td></tr>
                                ) : (
                                    filteredCustomers.map(customer => (
                                        <tr key={customer.id} style={{ borderBottom: `1px solid ${theme.border}`, background: selectedCustomers.includes(customer.id) ? (isDark ? '#1e3a5f' : '#eff6ff') : 'transparent', transition: 'background 0.15s' }}>
                                            <td style={{ padding: '16px 20px' }}>
                                                <input
                                                    type="checkbox"
                                                    checked={selectedCustomers.includes(customer.id)}
                                                    onChange={() => toggleCustomerSelection(customer.id)}
                                                    style={{ width: '18px', height: '18px', cursor: 'pointer' }}
                                                />
                                            </td>
                                            <td style={{ padding: '16px 20px' }}>
                                                <div style={{ fontWeight: '600', color: theme.text, fontSize: '15px' }}>{customer.name}</div>
                                                <div style={{ fontSize: '12px', color: theme.textSecondary, marginTop: '4px' }}>Since {new Date(customer.createdAt).toLocaleDateString()}</div>
                                            </td>
                                            <td style={{ padding: '16px 20px' }}>
                                                <div style={{ color: theme.text, fontSize: '14px' }}>{customer.phone || '-'}</div>
                                                <div style={{ fontSize: '12px', color: theme.textSecondary, marginTop: '4px' }}>{customer.email || '-'}</div>
                                            </td>
                                            <td style={{ padding: '16px 20px', textAlign: 'center' }}>
                                                <span style={{ padding: '6px 14px', background: (customer.loyaltyPoints || 0) >= 100 ? '#d1fae5' : '#f3f4f6', color: (customer.loyaltyPoints || 0) >= 100 ? '#059669' : '#6b7280', borderRadius: '4px', fontWeight: '700', fontSize: '13px', display: 'inline-block' }}>
                                                    ‚≠ê {customer.loyaltyPoints || 0}
                                                </span>
                                            </td>
                                            <td style={{ padding: '16px 20px', textAlign: 'center', color: theme.text, fontWeight: '700', fontSize: '15px' }}>
                                                {customer.visitCount || 0}
                                            </td>
                                            <td style={{ padding: '16px 20px', textAlign: 'center' }}>
                                                <button
                                                    onClick={() => { setSelectedCustomers([customer.id]); setShowComposeModal(true); }}
                                                    style={{ padding: '8px 16px', background: '#3b82f6', color: 'white', border: 'none', borderRadius: '4px', cursor: 'pointer', fontSize: '13px', fontWeight: '600' }}
                                                >
                                                    ‚úâÔ∏è Message
                                                </button>
                                            </td>
                                        </tr>
                                    ))
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>
            )}

            {/* Campaigns Tab */}
            {activeTab === 'campaigns' && (
                <div style={{ background: theme.cardBg, borderRadius: '4px', border: `1px solid ${theme.border}`, overflow: 'hidden' }}>
                    <div style={{ padding: '20px 24px', borderBottom: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'space-between', alignItems: 'center', background: theme.bgSecondary }}>
                        <h3 style={{ margin: 0, color: theme.text, fontSize: '18px', fontWeight: '700' }}>Marketing Campaigns</h3>
                        <button
                            onClick={() => setShowCampaignModal(true)}
                            style={{ padding: '12px 24px', background: '#3b82f6', color: 'white', border: 'none', borderRadius: '4px', fontWeight: '600', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '10px' }}
                        >
                            ‚ûï New Campaign
                        </button>
                    </div>
                    <div style={{ padding: '24px' }}>
                        {campaigns.length === 0 ? (
                            <div style={{ textAlign: 'center', padding: '80px 20px', color: theme.textSecondary }}>
                                <div style={{ fontSize: '56px', marginBottom: '20px' }}>üì¢</div>
                                <div style={{ fontSize: '18px', marginBottom: '8px', fontWeight: '600', color: theme.text }}>No campaigns yet</div>
                                <div style={{ fontSize: '14px' }}>Create your first marketing campaign to engage customers</div>
                            </div>
                        ) : (
                            <div style={{ display: 'grid', gap: '20px' }}>
                                {campaigns.map(campaign => (
                                    <div key={campaign.id} style={{ padding: '24px', border: `1px solid ${theme.border}`, borderRadius: '4px', background: theme.bg }}>
                                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '16px' }}>
                                            <div>
                                                <h4 style={{ margin: '0 0 6px', color: theme.text, fontSize: '18px', fontWeight: '700' }}>{campaign.name}</h4>
                                                <p style={{ margin: 0, color: theme.textSecondary, fontSize: '14px' }}>{campaign.description || 'No description'}</p>
                                            </div>
                                            <span style={{ padding: '6px 14px', borderRadius: '4px', fontSize: '12px', fontWeight: '700', textTransform: 'uppercase', letterSpacing: '0.5px', background: campaign.status === 'active' ? '#d1fae5' : campaign.status === 'draft' ? '#fef3c7' : '#f3f4f6', color: campaign.status === 'active' ? '#059669' : campaign.status === 'draft' ? '#d97706' : '#6b7280' }}>
                                                {campaign.status}
                                            </span>
                                        </div>
                                        <div style={{ display: 'flex', gap: '32px', fontSize: '13px', color: theme.textSecondary }}>
                                            <span>üìÖ {campaign.startDate || 'Not scheduled'}</span>
                                            <span>üéØ {campaign.targetAudience === 'all' ? 'All Customers' : campaign.targetAudience}</span>
                                            <span>üìä Sent: {campaign.stats?.sent || 0}</span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            )}

            {/* Messages Tab */}
            {activeTab === 'messages' && (
                <div style={{ background: theme.cardBg, borderRadius: '4px', border: `1px solid ${theme.border}`, overflow: 'hidden' }}>
                    <div style={{ padding: '20px 24px', borderBottom: `1px solid ${theme.border}`, background: theme.bgSecondary }}>
                        <h3 style={{ margin: 0, color: theme.text, fontSize: '18px', fontWeight: '700' }}>Message History</h3>
                    </div>
                    <div style={{ padding: '24px' }}>
                        {messages.length === 0 ? (
                            <div style={{ textAlign: 'center', padding: '80px 20px', color: theme.textSecondary }}>
                                <div style={{ fontSize: '56px', marginBottom: '20px' }}>‚úâÔ∏è</div>
                                <div style={{ fontSize: '18px', marginBottom: '8px', fontWeight: '600', color: theme.text }}>No messages sent yet</div>
                                <div style={{ fontSize: '14px' }}>Select customers and send them a message</div>
                            </div>
                        ) : (
                            <div style={{ display: 'grid', gap: '16px' }}>
                                {messages.map(message => (
                                    <div key={message.id} style={{ padding: '20px', border: `1px solid ${theme.border}`, borderRadius: '4px', background: theme.bg }}>
                                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '12px' }}>
                                            <div style={{ fontWeight: '700', color: theme.text, fontSize: '16px' }}>{message.subject}</div>
                                            <span style={{ padding: '6px 12px', borderRadius: '4px', fontSize: '11px', fontWeight: '700', textTransform: 'uppercase', letterSpacing: '0.5px', background: message.status === 'sent' ? '#d1fae5' : '#fef3c7', color: message.status === 'sent' ? '#059669' : '#d97706' }}>
                                                {message.status === 'sent' ? '‚úì Sent' : '‚è± Scheduled'}
                                            </span>
                                        </div>
                                        <p style={{ margin: '0 0 16px', color: theme.textSecondary, fontSize: '14px', lineHeight: '1.6' }}>{message.content}</p>
                                        <div style={{ display: 'flex', gap: '24px', fontSize: '13px', color: theme.textSecondary, paddingTop: '12px', borderTop: `1px solid ${theme.border}` }}>
                                            <span>üë• {message.recipientCount} recipients</span>
                                            <span>üì± {message.sendVia.toUpperCase()}</span>
                                            <span>üìÖ {new Date(message.sentAt || message.scheduledTime).toLocaleString()}</span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            )}

            {/* Templates Tab */}
            {activeTab === 'templates' && (
                <div style={{ background: theme.cardBg, borderRadius: '4px', border: `1px solid ${theme.border}`, overflow: 'hidden' }}>
                    <div style={{ padding: '20px 24px', borderBottom: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'space-between', alignItems: 'center', background: theme.bgSecondary }}>
                        <h3 style={{ margin: 0, color: theme.text, fontSize: '18px', fontWeight: '700' }}>Message Templates</h3>
                        <button
                            onClick={() => setShowTemplateModal(true)}
                            style={{ padding: '12px 24px', background: '#3b82f6', color: 'white', border: 'none', borderRadius: '4px', fontWeight: '600', cursor: 'pointer' }}
                        >
                            ‚ûï New Template
                        </button>
                    </div>
                    <div style={{ padding: '24px', display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(350px, 1fr))', gap: '20px' }}>
                        {templates.map(template => (
                            <div key={template.id} style={{ padding: '20px', border: `1px solid ${theme.border}`, borderRadius: '4px', background: theme.bg }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '12px' }}>
                                    <div style={{ fontWeight: '700', color: theme.text, fontSize: '16px' }}>{template.name}</div>
                                    <span style={{ padding: '4px 10px', borderRadius: '4px', fontSize: '11px', fontWeight: '600', textTransform: 'uppercase', letterSpacing: '0.5px', background: theme.bgTertiary, color: theme.textSecondary }}>
                                        {template.category}
                                    </span>
                                </div>
                                <p style={{ margin: '0 0 16px', color: theme.textSecondary, fontSize: '14px', lineHeight: '1.6' }}>{template.content}</p>
                                <button
                                    onClick={() => useTemplate(template)}
                                    style={{ padding: '10px 18px', background: '#10b981', color: 'white', border: 'none', borderRadius: '4px', cursor: 'pointer', fontSize: '13px', fontWeight: '600' }}
                                >
                                    Use Template
                                </button>
                            </div>
                        ))}
                    </div>
                </div>
            )}

            {/* Compose Message Modal */}
            {showComposeModal && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.6)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 }} onClick={() => setShowComposeModal(false)}>
                    <div style={{ background: theme.bg, width: '100%', maxWidth: '600px', maxHeight: '90vh', overflow: 'auto', margin: '20px', borderRadius: '4px', boxShadow: '0 25px 50px -12px rgba(0,0,0,0.4)' }} onClick={e => e.stopPropagation()}>
                        <div style={{ padding: '24px', borderBottom: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'space-between', alignItems: 'center', background: theme.bgSecondary }}>
                            <h2 style={{ margin: 0, color: theme.text, fontSize: '20px', fontWeight: '700' }}>‚úâÔ∏è Compose Message</h2>
                            <button onClick={() => setShowComposeModal(false)} style={{ background: 'none', border: 'none', fontSize: '28px', cursor: 'pointer', color: theme.textSecondary, lineHeight: '1' }}>√ó</button>
                        </div>
                        <div style={{ padding: '24px' }}>
                            <div style={{ marginBottom: '20px', padding: '16px', background: theme.bgTertiary, borderRadius: '4px' }}>
                                <div style={{ fontSize: '12px', color: theme.textSecondary, marginBottom: '4px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Sending to:</div>
                                <div style={{ fontWeight: '700', color: theme.text, fontSize: '16px' }}>{selectedCustomers.length} customer(s) selected</div>
                            </div>
                            <div style={{ marginBottom: '20px' }}>
                                <label style={labelStyle}>Subject (optional)</label>
                                <input
                                    type="text"
                                    value={composeForm.subject}
                                    onChange={(e) => setComposeForm({ ...composeForm, subject: e.target.value })}
                                    placeholder="Enter subject..."
                                    style={inputStyle}
                                />
                            </div>
                            <div style={{ marginBottom: '20px' }}>
                                <label style={labelStyle}>Message *</label>
                                <textarea
                                    value={composeForm.message}
                                    onChange={(e) => setComposeForm({ ...composeForm, message: e.target.value })}
                                    placeholder="Type your message here... Use {name} for customer name"
                                    style={{ ...inputStyle, minHeight: '140px', resize: 'vertical' }}
                                />
                            </div>
                            <div style={{ marginBottom: '20px' }}>
                                <label style={labelStyle}>Send Via</label>
                                <div style={{ display: 'flex', gap: '16px' }}>
                                    {['sms', 'email', 'both'].map(type => (
                                        <button
                                            key={type}
                                            onClick={() => setComposeForm({ ...composeForm, sendVia: type })}
                                            style={{ flex: 1, padding: '14px', border: `2px solid ${composeForm.sendVia === type ? '#3b82f6' : theme.border}`, background: composeForm.sendVia === type ? '#eff6ff' : 'transparent', color: composeForm.sendVia === type ? '#3b82f6' : theme.text, borderRadius: '4px', cursor: 'pointer', fontWeight: '700', fontSize: '14px' }}
                                        >
                                            {type === 'sms' ? 'üì± SMS' : type === 'email' ? 'üìß Email' : 'üì® Both'}
                                        </button>
                                    ))}
                                </div>
                            </div>
                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ display: 'flex', alignItems: 'center', gap: '10px', cursor: 'pointer' }}>
                                    <input
                                        type="checkbox"
                                        checked={composeForm.isScheduled}
                                        onChange={(e) => setComposeForm({ ...composeForm, isScheduled: e.target.checked })}
                                        style={{ width: '18px', height: '18px' }}
                                    />
                                    <span style={{ fontSize: '14px', color: theme.text }}>Schedule for later</span>
                                </label>
                                {composeForm.isScheduled && (
                                    <input
                                        type="datetime-local"
                                        value={composeForm.scheduleTime}
                                        onChange={(e) => setComposeForm({ ...composeForm, scheduleTime: e.target.value })}
                                        style={{ ...inputStyle, marginTop: '12px' }}
                                    />
                                )}
                            </div>
                            <div style={{ display: 'flex', gap: '16px', marginTop: '28px' }}>
                                <button onClick={() => setShowComposeModal(false)} style={{ flex: 1, padding: '16px', border: `1px solid ${theme.border}`, background: 'transparent', color: theme.text, borderRadius: '4px', cursor: 'pointer', fontWeight: '600', fontSize: '14px' }}>Cancel</button>
                                <button onClick={handleSendMessage} disabled={actionLoading} style={{ flex: 1, padding: '16px', border: 'none', background: '#3b82f6', color: 'white', borderRadius: '4px', cursor: actionLoading ? 'wait' : 'pointer', fontWeight: '700', fontSize: '14px' }}>
                                    {actionLoading ? 'Sending...' : composeForm.isScheduled ? '‚è± Schedule' : '‚úàÔ∏è Send Now'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* Campaign Modal */}
            {showCampaignModal && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.6)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 }} onClick={() => setShowCampaignModal(false)}>
                    <div style={{ background: theme.bg, width: '100%', maxWidth: '600px', maxHeight: '90vh', overflow: 'auto', margin: '20px', borderRadius: '4px', boxShadow: '0 25px 50px -12px rgba(0,0,0,0.4)' }} onClick={e => e.stopPropagation()}>
                        <div style={{ padding: '24px', borderBottom: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'space-between', alignItems: 'center', background: theme.bgSecondary }}>
                            <h2 style={{ margin: 0, color: theme.text, fontSize: '20px', fontWeight: '700' }}>üì¢ Create Campaign</h2>
                            <button onClick={() => setShowCampaignModal(false)} style={{ background: 'none', border: 'none', fontSize: '28px', cursor: 'pointer', color: theme.textSecondary, lineHeight: '1' }}>√ó</button>
                        </div>
                        <div style={{ padding: '24px' }}>
                            <div style={{ marginBottom: '20px' }}>
                                <label style={labelStyle}>Campaign Name *</label>
                                <input type="text" value={campaignForm.name} onChange={(e) => setCampaignForm({ ...campaignForm, name: e.target.value })} placeholder="e.g., Summer Promotion" style={inputStyle} />
                            </div>
                            <div style={{ marginBottom: '20px' }}>
                                <label style={labelStyle}>Description</label>
                                <textarea value={campaignForm.description} onChange={(e) => setCampaignForm({ ...campaignForm, description: e.target.value })} placeholder="Describe your campaign..." style={{ ...inputStyle, minHeight: '100px', resize: 'vertical' }} />
                            </div>
                            <div style={{ marginBottom: '20px' }}>
                                <label style={labelStyle}>Target Audience</label>
                                <select value={campaignForm.targetAudience} onChange={(e) => setCampaignForm({ ...campaignForm, targetAudience: e.target.value })} style={inputStyle}>
                                    <option value="all">All Customers</option>
                                    <option value="loyal">Loyal Customers (100+ points)</option>
                                    <option value="new">New Customers (30 days)</option>
                                    <option value="inactive">Inactive Customers</option>
                                </select>
                            </div>
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px', marginBottom: '20px' }}>
                                <div>
                                    <label style={labelStyle}>Start Date</label>
                                    <input type="date" value={campaignForm.startDate} onChange={(e) => setCampaignForm({ ...campaignForm, startDate: e.target.value })} style={inputStyle} />
                                </div>
                                <div>
                                    <label style={labelStyle}>End Date</label>
                                    <input type="date" value={campaignForm.endDate} onChange={(e) => setCampaignForm({ ...campaignForm, endDate: e.target.value })} style={inputStyle} />
                                </div>
                            </div>
                            <div style={{ display: 'flex', gap: '16px', marginTop: '28px' }}>
                                <button onClick={() => setShowCampaignModal(false)} style={{ flex: 1, padding: '16px', border: `1px solid ${theme.border}`, background: 'transparent', color: theme.text, borderRadius: '4px', cursor: 'pointer', fontWeight: '600', fontSize: '14px' }}>Cancel</button>
                                <button onClick={handleCreateCampaign} disabled={actionLoading} style={{ flex: 1, padding: '16px', border: 'none', background: '#3b82f6', color: 'white', borderRadius: '4px', cursor: actionLoading ? 'wait' : 'pointer', fontWeight: '700', fontSize: '14px' }}>
                                    {actionLoading ? 'Creating...' : '‚úì Create Campaign'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* Template Modal */}
            {showTemplateModal && (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.6)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 }} onClick={() => setShowTemplateModal(false)}>
                    <div style={{ background: theme.bg, width: '100%', maxWidth: '550px', maxHeight: '90vh', overflow: 'auto', margin: '20px', borderRadius: '4px', boxShadow: '0 25px 50px -12px rgba(0,0,0,0.4)' }} onClick={e => e.stopPropagation()}>
                        <div style={{ padding: '24px', borderBottom: `1px solid ${theme.border}`, display: 'flex', justifyContent: 'space-between', alignItems: 'center', background: theme.bgSecondary }}>
                            <h2 style={{ margin: 0, color: theme.text, fontSize: '20px', fontWeight: '700' }}>üìù New Template</h2>
                            <button onClick={() => setShowTemplateModal(false)} style={{ background: 'none', border: 'none', fontSize: '28px', cursor: 'pointer', color: theme.textSecondary, lineHeight: '1' }}>√ó</button>
                        </div>
                        <div style={{ padding: '24px' }}>
                            <div style={{ marginBottom: '20px' }}>
                                <label style={labelStyle}>Template Name *</label>
                                <input type="text" value={templateForm.name} onChange={(e) => setTemplateForm({ ...templateForm, name: e.target.value })} placeholder="e.g., Weekly Reminder" style={inputStyle} />
                            </div>
                            <div style={{ marginBottom: '20px' }}>
                                <label style={labelStyle}>Category</label>
                                <select value={templateForm.category} onChange={(e) => setTemplateForm({ ...templateForm, category: e.target.value })} style={inputStyle}>
                                    <option value="general">General</option>
                                    <option value="welcome">Welcome</option>
                                    <option value="reminder">Reminder</option>
                                    <option value="promo">Promotion</option>
                                    <option value="loyalty">Loyalty</option>
                                    <option value="birthday">Birthday</option>
                                </select>
                            </div>
                            <div style={{ marginBottom: '20px' }}>
                                <label style={labelStyle}>Message Content *</label>
                                <textarea value={templateForm.content} onChange={(e) => setTemplateForm({ ...templateForm, content: e.target.value })} placeholder="Enter template message... Use {name} for customer name, {points} for loyalty points" style={{ ...inputStyle, minHeight: '120px', resize: 'vertical' }} />
                            </div>
                            <div style={{ display: 'flex', gap: '16px', marginTop: '28px' }}>
                                <button onClick={() => setShowTemplateModal(false)} style={{ flex: 1, padding: '16px', border: `1px solid ${theme.border}`, background: 'transparent', color: theme.text, borderRadius: '4px', cursor: 'pointer', fontWeight: '600', fontSize: '14px' }}>Cancel</button>
                                <button onClick={handleSaveTemplate} style={{ flex: 1, padding: '16px', border: 'none', background: '#3b82f6', color: 'white', borderRadius: '4px', cursor: 'pointer', fontWeight: '700', fontSize: '14px' }}>‚úì Save Template</button>
                            </div>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}

// ==================== ACTIVITIES MODULE ====================
function ActivitiesModule() {
    const [activities, setActivities] = useState([]);
    const [loading, setLoading] = useState(true);
    const [searchQuery, setSearchQuery] = useState('');
    const [dateFilter, setDateFilter] = useState('all');
    const [typeFilter, setTypeFilter] = useState('all');
    const [isDark, setIsDark] = useState(document.documentElement.getAttribute('data-theme') === 'dark');

    // Theme detection
    useEffect(() => {
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.attributeName === 'data-theme') {
                    setIsDark(document.documentElement.getAttribute('data-theme') === 'dark');
                }
            });
        });
        observer.observe(document.documentElement, { attributes: true });
        return () => observer.disconnect();
    }, []);

    const theme = {
        bg: isDark ? '#1e293b' : 'white',
        bgSecondary: isDark ? '#0f172a' : '#f8fafc',
        text: isDark ? '#f1f5f9' : '#1e293b',
        textSecondary: isDark ? '#94a3b8' : '#64748b',
        border: isDark ? '#334155' : '#e2e8f0',
        cardShadow: isDark ? '0 2px 8px rgba(0,0,0,0.3)' : '0 2px 8px rgba(0,0,0,0.08)',
        inputBg: isDark ? '#1e293b' : 'white',
    };

    // Subscribe to activities
    useEffect(() => {
        const services = window.FirebaseServices;
        if (!services?.activityService?.subscribeToActivities) {
            setLoading(false);
            return;
        }

        const unsub = services.activityService.subscribeToActivities(
            (data) => {
                setActivities(data);
                setLoading(false);
            },
            500 // Get lots of activities for filtering
        );

        return () => {
            if (unsub) unsub();
        };
    }, []);

    // Date filter logic
    const getFilteredActivities = () => {
        let filtered = activities;
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);
        const weekStart = new Date(today);
        weekStart.setDate(weekStart.getDate() - 7);
        const monthStart = new Date(today);
        monthStart.setDate(monthStart.getDate() - 30);

        // Date filter
        if (dateFilter !== 'all') {
            filtered = filtered.filter(a => {
                const aDate = new Date(a.timestamp);
                aDate.setHours(0, 0, 0, 0);
                switch (dateFilter) {
                    case 'today':
                        return aDate.getTime() === today.getTime();
                    case 'yesterday':
                        return aDate.getTime() === yesterday.getTime();
                    case 'week':
                        return aDate >= weekStart;
                    case 'month':
                        return aDate >= monthStart;
                    default:
                        return true;
                }
            });
        }

        // Type filter
        if (typeFilter !== 'all') {
            filtered = filtered.filter(a => a.type === typeFilter);
        }

        // Search filter
        if (searchQuery.trim()) {
            const query = searchQuery.toLowerCase();
            filtered = filtered.filter(a =>
                a.action?.toLowerCase().includes(query) ||
                a.description?.toLowerCase().includes(query) ||
                a.details?.toLowerCase().includes(query) ||
                a.user?.toLowerCase().includes(query) ||
                a.type?.toLowerCase().includes(query) ||
                a.loggedBy?.toLowerCase().includes(query) ||
                a.loggedByRole?.toLowerCase().includes(query)
            );
        }

        return filtered;
    };

    const filteredActivities = getFilteredActivities();

    const dateFilters = [
        { id: 'all', label: 'All Time' },
        { id: 'today', label: 'Today' },
        { id: 'yesterday', label: 'Yesterday' },
        { id: 'week', label: 'This Week' },
        { id: 'month', label: 'This Month' }
    ];

    const typeFilters = [
        { id: 'all', label: 'All Types' },
        { id: 'intake', label: 'Intake' },
        { id: 'wash', label: 'Wash' },
        { id: 'billing', label: 'Billing' },
        { id: 'garage', label: 'Garage' },
        { id: 'inventory', label: 'Inventory' },
        { id: 'staff', label: 'Staff' },
        { id: 'system', label: 'System' }
    ];

    const getTypeIcon = (type) => {
        switch(type) {
            case 'intake': return 'üöó';
            case 'billing': return 'üí≥';
            case 'wash': return 'üöø';
            case 'garage': return 'üîß';
            case 'inventory': return 'üì¶';
            case 'staff': return 'üë§';
            case 'system': return '‚öôÔ∏è';
            default: return 'üìã';
        }
    };

    const getTypeColor = (type) => {
        switch(type) {
            case 'intake': return '#3b82f6';
            case 'billing': return '#10b981';
            case 'wash': return '#6366f1';
            case 'garage': return '#f59e0b';
            case 'inventory': return '#8b5cf6';
            case 'staff': return '#ec4899';
            case 'system': return '#64748b';
            default: return '#94a3b8';
        }
    };

    if (loading) {
        return (
            <div style={{ padding: '40px', textAlign: 'center', color: theme.textSecondary }}>
                Loading activities...
            </div>
        );
    }

    return (
        <div style={{ padding: '24px', maxWidth: '1400px', margin: '0 auto' }}>
            {/* Header */}
            <div style={{ marginBottom: '24px' }}>
                <h2 style={{ margin: 0, color: theme.text, fontSize: '24px', fontWeight: '600' }}>
                    Activity Log
                </h2>
                <p style={{ margin: '8px 0 0', color: theme.textSecondary, fontSize: '14px' }}>
                    View all system activities and events
                </p>
            </div>

            {/* Stats Row */}
            <div style={{ 
                display: 'grid', 
                gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))', 
                gap: '16px', 
                marginBottom: '24px' 
            }}>
                {[
                    { label: 'Total', value: activities.length, color: '#64748b' },
                    { label: 'Today', value: activities.filter(a => {
                        const aDate = new Date(a.timestamp);
                        const today = new Date();
                        return aDate.toDateString() === today.toDateString();
                    }).length, color: '#3b82f6' },
                    { label: 'This Week', value: activities.filter(a => {
                        const aDate = new Date(a.timestamp);
                        const weekAgo = new Date();
                        weekAgo.setDate(weekAgo.getDate() - 7);
                        return aDate >= weekAgo;
                    }).length, color: '#10b981' },
                    { label: 'Filtered', value: filteredActivities.length, color: '#8b5cf6' }
                ].map((stat, idx) => (
                    <div key={idx} style={{
                        padding: '20px 24px',
                        background: theme.bg,
                        borderRadius: '0',
                        border: `1px solid ${theme.border}`,
                        boxShadow: theme.cardShadow
                    }}>
                        <div style={{ fontSize: '12px', color: theme.textSecondary, marginBottom: '6px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>{stat.label}</div>
                        <div style={{ fontSize: '28px', fontWeight: '700', color: stat.color }}>{stat.value}</div>
                    </div>
                ))}
            </div>

            {/* Filters Row */}
            <div style={{ 
                display: 'flex', 
                gap: '16px', 
                marginBottom: '20px', 
                flexWrap: 'wrap',
                alignItems: 'center'
            }}>
                {/* Search */}
                <div style={{ flex: '1', minWidth: '200px', maxWidth: '350px' }}>
                    <input
                        type="text"
                        placeholder="Search activities..."
                        value={searchQuery}
                        onChange={e => setSearchQuery(e.target.value)}
                        style={{
                            width: '100%',
                            padding: '12px 16px',
                            borderRadius: '0',
                            border: `1px solid ${theme.border}`,
                            background: theme.inputBg,
                            color: theme.text,
                            fontSize: '14px'
                        }}
                    />
                </div>

                {/* Date Filter */}
                <div style={{ display: 'flex', gap: '2px', background: theme.bgSecondary, borderRadius: '0', padding: '4px' }}>
                    {dateFilters.map(f => (
                        <button
                            key={f.id}
                            onClick={() => setDateFilter(f.id)}
                            style={{
                                padding: '10px 16px',
                                border: 'none',
                                borderRadius: '0',
                                background: dateFilter === f.id ? theme.bg : 'transparent',
                                color: dateFilter === f.id ? theme.text : theme.textSecondary,
                                fontSize: '13px',
                                fontWeight: dateFilter === f.id ? '600' : '400',
                                cursor: 'pointer',
                                boxShadow: dateFilter === f.id ? '0 1px 3px rgba(0,0,0,0.1)' : 'none'
                            }}
                        >
                            {f.label}
                        </button>
                    ))}
                </div>

                {/* Type Filter */}
                <select
                    value={typeFilter}
                    onChange={e => setTypeFilter(e.target.value)}
                    style={{
                        padding: '12px 16px',
                        borderRadius: '0',
                        border: `1px solid ${theme.border}`,
                        background: theme.inputBg,
                        color: theme.text,
                        fontSize: '14px',
                        cursor: 'pointer',
                        minWidth: '140px'
                    }}
                >
                    {typeFilters.map(f => (
                        <option key={f.id} value={f.id}>{f.label}</option>
                    ))}
                </select>
            </div>

            {/* Activities List */}
            <div style={{
                background: theme.bg,
                borderRadius: '0',
                border: `1px solid ${theme.border}`,
                boxShadow: theme.cardShadow,
                overflow: 'hidden'
            }}>
                {filteredActivities.length === 0 ? (
                    <div style={{ padding: '60px 20px', textAlign: 'center', color: theme.textSecondary }}>
                        <div style={{ fontSize: '48px', marginBottom: '16px' }}>üìã</div>
                        <div style={{ fontSize: '16px', fontWeight: '500' }}>No activities found</div>
                        <div style={{ fontSize: '14px', marginTop: '8px' }}>
                            {searchQuery || dateFilter !== 'all' || typeFilter !== 'all' 
                                ? 'Try adjusting your filters' 
                                : 'Activities will appear here as they occur'}
                        </div>
                    </div>
                ) : (
                    <div style={{ maxHeight: '600px', overflowY: 'auto' }}>
                        {filteredActivities.map((activity, idx) => (
                            <div 
                                key={activity.id || idx}
                                style={{
                                    display: 'flex',
                                    alignItems: 'flex-start',
                                    gap: '16px',
                                    padding: '16px 20px',
                                    borderBottom: idx < filteredActivities.length - 1 ? `1px solid ${theme.border}` : 'none',
                                    transition: 'background 0.15s'
                                }}
                            >
                                {/* Icon */}
                                <div style={{
                                    width: '44px',
                                    height: '44px',
                                    borderRadius: '0',
                                    background: `${getTypeColor(activity.type)}15`,
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    fontSize: '18px',
                                    flexShrink: 0
                                }}>
                                    {getTypeIcon(activity.type)}
                                </div>

                                {/* Content */}
                                <div style={{ flex: 1, minWidth: 0 }}>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '4px' }}>
                                        <span style={{ 
                                            fontWeight: '600', 
                                            color: theme.text, 
                                            fontSize: '14px' 
                                        }}>
                                            {activity.action || activity.description || 'Activity'}
                                        </span>
                                        <span style={{
                                            padding: '2px 8px',
                                            borderRadius: '4px',
                                            fontSize: '11px',
                                            fontWeight: '600',
                                            textTransform: 'uppercase',
                                            background: `${getTypeColor(activity.type)}20`,
                                            color: getTypeColor(activity.type)
                                        }}>
                                            {activity.type || 'general'}
                                        </span>
                                    </div>
                                    <div style={{ fontSize: '13px', color: theme.textSecondary }}>
                                        {activity.details || activity.user || '-'}
                                    </div>
                                </div>

                                {/* Logged By Column */}
                                <div style={{ 
                                    minWidth: '140px', 
                                    flexShrink: 0,
                                    padding: '0 12px',
                                    borderLeft: `1px solid ${theme.border}`,
                                    borderRight: `1px solid ${theme.border}`
                                }}>
                                    <div style={{ fontSize: '11px', color: theme.textSecondary, marginBottom: '4px', textTransform: 'uppercase' }}>
                                        Logged By
                                    </div>
                                    <div style={{ 
                                        fontSize: '13px', 
                                        fontWeight: '500', 
                                        color: theme.text,
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '6px'
                                    }}>
                                        <span style={{
                                            width: '24px',
                                            height: '24px',
                                            borderRadius: '0',
                                            background: '#3b82f6',
                                            color: 'white',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            fontSize: '11px',
                                            fontWeight: '600'
                                        }}>
                                            {(activity.loggedBy || 'S').charAt(0).toUpperCase()}
                                        </span>
                                        <div>
                                            <div style={{ fontSize: '13px' }}>{activity.loggedBy || 'System'}</div>
                                            {activity.loggedByRole && (
                                                <div style={{ 
                                                    fontSize: '10px', 
                                                    color: theme.textSecondary,
                                                    textTransform: 'capitalize'
                                                }}>
                                                    {activity.loggedByRole}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>

                                {/* Time & Status */}
                                <div style={{ textAlign: 'right', flexShrink: 0, minWidth: '90px' }}>
                                    <div style={{ fontSize: '12px', color: theme.textSecondary }}>
                                        {new Date(activity.timestamp).toLocaleDateString('en-US', {
                                            month: 'short',
                                            day: 'numeric'
                                        })}
                                    </div>
                                    <div style={{ fontSize: '12px', color: theme.textSecondary }}>
                                        {new Date(activity.timestamp).toLocaleTimeString('en-US', {
                                            hour: '2-digit',
                                            minute: '2-digit'
                                        })}
                                    </div>
                                    {activity.status && (
                                        <div style={{
                                            marginTop: '4px',
                                            padding: '2px 8px',
                                            borderRadius: '4px',
                                            fontSize: '10px',
                                            fontWeight: '600',
                                            textTransform: 'uppercase',
                                            background: activity.status === 'success' ? '#d1fae5' :
                                                       activity.status === 'pending' ? '#fef3c7' :
                                                       activity.status === 'error' ? '#fee2e2' :
                                                       theme.bgSecondary,
                                            color: activity.status === 'success' ? '#059669' :
                                                   activity.status === 'pending' ? '#d97706' :
                                                   activity.status === 'error' ? '#dc2626' :
                                                   theme.textSecondary
                                        }}>
                                            {activity.status}
                                        </div>
                                    )}
                                </div>
                            </div>
                        ))}
                    </div>
                )}
            </div>
        </div>
    );
}

// Content Area Component
function ContentArea({ activeModule, onModuleClick, settingsTab }) {
    const currentModule = menuItems.find(item => item.id === activeModule);
    
    return (
        <div className="content-area">
            <div className="module-header">
                <div className="module-header-icon">{currentModule?.icon}</div>
                <h1 className="module-header-title">{currentModule?.label}</h1>
            </div>
            <div className="content-placeholder">
                {activeModule === 'dashboard' && <Dashboard onModuleClick={onModuleClick} />}
                {activeModule === 'vehicle-intake' && <VehicleIntake />}
                {activeModule === 'vehicle-intake-all' && <VehicleIntakeAll onBackClick={() => onModuleClick('vehicle-intake')} />}
                {activeModule === 'service-packages' && <ServicePackages />}
                {activeModule === 'equipment' && <EquipmentManagement />}
                {activeModule === 'parking' && <ParkingManagement />}
                {activeModule === 'customers' && <CustomerManagement />}
                {activeModule === 'fleet' && <FleetAccounts />}
                {activeModule === 'garage-management' && <GarageManagement />}
                {activeModule === 'wash-bays' && <WashBays />}
                {activeModule === 'staff' && <StaffManagement />}
                {activeModule === 'hr' && <HRModule />}
                {activeModule === 'billing' && <BillingModule />}
                {activeModule === 'inventory' && <InventoryModule />}
                {activeModule === 'expenses' && <ExpensesModule />}
                {activeModule === 'reports' && <ReportsAnalytics />}
                {activeModule === 'marketing' && <MarketingCRM />}
                {activeModule === 'activities' && <ActivitiesModule />}
                {activeModule === 'settings' && <SystemSettings initialTab={settingsTab} />}
            </div>
        </div>
    );
}

// Main App Component with Authentication
function App() {
    const [isSidebarCollapsed, setIsSidebarCollapsed] = useState(false);
    const [isDarkMode, setIsDarkMode] = useState(false);
    const [activeModule, setActiveModule] = useState('dashboard');
    const [settingsTab, setSettingsTab] = useState('profile');
    
    // Authentication state
    const [isAuthenticated, setIsAuthenticated] = useState(false);
    const [currentUser, setCurrentUser] = useState(null);
    const [userProfile, setUserProfile] = useState(null);
    const [authLoading, setAuthLoading] = useState(true);
    
    // Permission denied modal state
    const [showPermissionModal, setShowPermissionModal] = useState(false);
    const [deniedModule, setDeniedModule] = useState('');

    // Check authentication state on mount
    useEffect(() => {
        let unsubscribe = null;
        
        const checkAuth = async () => {
            // Wait for Firebase services (up to ~5s)
            let services = window.FirebaseServices;
            let attempts = 0;
            while (!services && attempts < 100) {
                await new Promise(resolve => setTimeout(resolve, 50));
                services = window.FirebaseServices;
                attempts++;
            }
            
            if (!services || !services.authService) {
                console.error('Auth service not available after', attempts, 'attempts');
                setAuthLoading(false);
                return;
            }

            // Listen to auth state changes
            unsubscribe = services.authService.onAuthStateChanged(async (user) => {
                if (user) {
                    // User is signed in
                    const profileResult = await services.userService.getUserProfile(user.uid);
                    if (profileResult.success && profileResult.data) {
                        if (profileResult.data.isActive) {
                            setCurrentUser(user);
                            setUserProfile(profileResult.data);
                            setIsAuthenticated(true);
                            // Store globally for activity logging
                            window.currentUserProfile = profileResult.data;
                            
                            // Redirect to first accessible module
                            const profile = profileResult.data;
                            const allModuleIds = menuItems.map(m => m.id);
                            let firstModule = 'dashboard';
                            for (const moduleId of allModuleIds) {
                                if (profile.permissions && profile.permissions[moduleId]?.view) {
                                    firstModule = moduleId;
                                    break;
                                }
                                if (services.userService.hasModuleAccess(profile.role, moduleId, profile.permissions)) {
                                    firstModule = moduleId;
                                    break;
                                }
                            }
                            setActiveModule(firstModule);
                            
                            // Subscribe to user profile changes for real-time permission updates
                            if (services.userService.subscribeToUserProfile) {
                                services.userService.subscribeToUserProfile(user.uid, (updatedProfile) => {
                                    if (updatedProfile) {
                                        setUserProfile(updatedProfile);
                                        window.currentUserProfile = updatedProfile;
                                        // If user is deactivated, sign them out
                                        if (!updatedProfile.isActive) {
                                            services.authService.signOut();
                                        }
                                    }
                                });
                            }
                        } else {
                            // User is deactivated
                            await services.authService.signOut();
                            setIsAuthenticated(false);
                        }
                    } else {
                        // No profile, sign out
                        setIsAuthenticated(false);
                    }
                } else {
                    // User is signed out
                    setCurrentUser(null);
                    setUserProfile(null);
                    setIsAuthenticated(false);
                }
                setAuthLoading(false);
            });
        };

        checkAuth();

        return () => {
            if (unsubscribe) unsubscribe();
        };
    }, []);

    const handleLoginSuccess = (user, profile) => {
        setCurrentUser(user);
        setUserProfile(profile);
        setIsAuthenticated(true);
        // Store globally for activity logging
        window.currentUserProfile = profile;
        
        // Redirect to first accessible module
        const getFirstAccessibleModule = () => {
            const allModuleIds = menuItems.map(m => m.id);
            for (const moduleId of allModuleIds) {
                // Check if user has access via permissions or role
                if (profile.permissions && profile.permissions[moduleId]?.view) {
                    return moduleId;
                }
                // Fall back to role-based check
                if (window.FirebaseServices?.userService?.hasModuleAccess(profile.role, moduleId, profile.permissions)) {
                    return moduleId;
                }
            }
            return 'dashboard'; // fallback
        };
        setActiveModule(getFirstAccessibleModule());
    };

    const handleLogout = async () => {
        const services = window.FirebaseServices;
        if (services && services.authService) {
            // Log logout and end session before signing out
            await services.auditService?.logLogout(currentUser);
            await services.auditService?.endSession(currentUser?.uid);
            await services.authService.signOut();
        }
        setCurrentUser(null);
        setUserProfile(null);
        setIsAuthenticated(false);
        setActiveModule('dashboard');
        // Clear global user
        window.currentUserProfile = null;
    };

    const toggleSidebar = () => {
        setIsSidebarCollapsed(!isSidebarCollapsed);
    };

    const toggleTheme = () => {
        setIsDarkMode(!isDarkMode);
        document.documentElement.setAttribute('data-theme', !isDarkMode ? 'dark' : 'light');
    };

    // Permission helper functions - defined BEFORE handleModuleClick
    const hasModuleAccess = (moduleId) => {
        if (!userProfile) return false;
        if (!window.FirebaseServices?.userService) return true;
        
        // Sub-modules inherit parent module permissions
        // vehicle-intake-all inherits from vehicle-intake
        const parentModuleMap = {
            'vehicle-intake-all': 'vehicle-intake'
        };
        const effectiveModuleId = parentModuleMap[moduleId] || moduleId;
        
        // Pass email for super admin check
        return window.FirebaseServices.userService.hasModuleAccess(userProfile.role, effectiveModuleId, userProfile.permissions, userProfile.email);
    };

    const handleModuleClick = (moduleId, tab = null) => {
        // Check if user has access to this module using our helper
        if (!hasModuleAccess(moduleId)) {
            const moduleName = menuItems.find(m => m.id === moduleId)?.label || moduleId;
            setDeniedModule(moduleName);
            setShowPermissionModal(true);
            return;
        }
        setActiveModule(moduleId);
        // Handle settings tab
        if (moduleId === 'settings' && tab) {
            setSettingsTab(tab);
        }
    };

    const hasPermission = (moduleId, action = 'view') => {
        if (!userProfile) return false;
        if (!window.FirebaseServices?.userService) return true;
        // Pass email for super admin check
        return window.FirebaseServices.userService.hasPermission(userProfile.role, moduleId, action, userProfile.permissions, userProfile.email);
    };

    // Check if current user is super admin
    const isSuperAdmin = window.FirebaseServices?.userService?.isSuperAdmin(userProfile?.email) || false;

    // Show login page if loading or not authenticated
    if (authLoading || !isAuthenticated) {
        return <LoginPage onLoginSuccess={handleLoginSuccess} />;
    }

    // Permission context value
    const permissionValue = {
        hasModuleAccess,
        hasPermission,
        userRole: userProfile?.role || 'receptionist',
        userProfile,
        currentUser,
        isSuperAdmin
    };

    return (
        <PermissionContext.Provider value={permissionValue}>
            <AuthContext.Provider value={{ currentUser, userProfile, logout: handleLogout }}>
                <div className="app-container">
                    <Sidebar 
                        isCollapsed={isSidebarCollapsed} 
                        activeModule={activeModule}
                        onModuleClick={handleModuleClick}
                        userProfile={userProfile}
                        hasModuleAccess={hasModuleAccess}
                    />
                    <div className="main-content">
                        <TopBar 
                            onToggleSidebar={toggleSidebar} 
                            onToggleTheme={toggleTheme}
                            isDarkMode={isDarkMode}
                            userProfile={userProfile}
                            onLogout={handleLogout}
                            onModuleClick={handleModuleClick}
                        />
                        <ContentArea activeModule={activeModule} onModuleClick={handleModuleClick} settingsTab={settingsTab} />
                    </div>
                    
                    {/* Permission Denied Modal */}
                    {showPermissionModal && (
                        <div 
                            style={{
                                position: 'fixed',
                                top: 0,
                                left: 0,
                                right: 0,
                                bottom: 0,
                                background: 'rgba(0, 0, 0, 0.5)',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                zIndex: 9999,
                                backdropFilter: 'blur(4px)'
                            }}
                            onClick={() => setShowPermissionModal(false)}
                        >
                            <div 
                                style={{
                                    background: isDarkMode ? '#1e293b' : 'white',
                                    borderRadius: '16px',
                                    padding: '32px',
                                    maxWidth: '400px',
                                    width: '90%',
                                    textAlign: 'center',
                                    boxShadow: '0 20px 60px rgba(0, 0, 0, 0.3)',
                                    animation: 'slideIn 0.2s ease-out'
                                }}
                                onClick={e => e.stopPropagation()}
                            >
                                <div style={{
                                    width: '64px',
                                    height: '64px',
                                    borderRadius: '50%',
                                    background: '#fef2f2',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    margin: '0 auto 20px',
                                    fontSize: '32px'
                                }}>
                                    üîí
                                </div>
                                <h3 style={{
                                    margin: '0 0 12px',
                                    fontSize: '20px',
                                    fontWeight: '700',
                                    color: isDarkMode ? '#f1f5f9' : '#1e293b'
                                }}>
                                    Access Denied
                                </h3>
                                <p style={{
                                    margin: '0 0 8px',
                                    fontSize: '15px',
                                    color: isDarkMode ? '#94a3b8' : '#64748b',
                                    lineHeight: '1.6'
                                }}>
                                    You don't have permission to access
                                </p>
                                <p style={{
                                    margin: '0 0 20px',
                                    fontSize: '16px',
                                    fontWeight: '600',
                                    color: isDarkMode ? '#f1f5f9' : '#1e293b'
                                }}>
                                    "{deniedModule}"
                                </p>
                                <p style={{
                                    margin: '0 0 24px',
                                    fontSize: '13px',
                                    color: isDarkMode ? '#64748b' : '#94a3b8'
                                }}>
                                    Please contact your administrator to request access.
                                </p>
                                <button
                                    onClick={() => setShowPermissionModal(false)}
                                    style={{
                                        padding: '12px 32px',
                                        background: '#3b82f6',
                                        color: 'white',
                                        border: 'none',
                                        borderRadius: '8px',
                                        fontSize: '14px',
                                        fontWeight: '600',
                                        cursor: 'pointer',
                                        transition: 'all 0.2s'
                                    }}
                                    onMouseOver={e => e.target.style.background = '#2563eb'}
                                    onMouseOut={e => e.target.style.background = '#3b82f6'}
                                >
                                    OK, Got it
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            </AuthContext.Provider>
        </PermissionContext.Provider>
    );
}

// Error Boundary to catch React crashes
class ErrorBoundary extends React.Component {
    constructor(props) {
        super(props);
        this.state = { hasError: false, error: null, errorInfo: null };
    }
    
    static getDerivedStateFromError(error) {
        return { hasError: true, error };
    }
    
    componentDidCatch(error, errorInfo) {
        console.error('React Error:', error, errorInfo);
        this.setState({ errorInfo });
    }
    
    render() {
        if (this.state.hasError) {
            return (
                <div style={{ padding: '40px', textAlign: 'center', fontFamily: 'system-ui, sans-serif' }}>
                    <h2 style={{ color: '#dc2626', marginBottom: '16px' }}>Something went wrong</h2>
                    <pre style={{ 
                        background: '#f5f5f5', 
                        padding: '16px', 
                        borderRadius: '8px', 
                        textAlign: 'left', 
                        overflow: 'auto', 
                        maxWidth: '800px', 
                        margin: '0 auto 20px',
                        fontSize: '12px',
                        color: '#333'
                    }}>
                        {this.state.error?.toString()}
                        {this.state.errorInfo?.componentStack}
                    </pre>
                    <button 
                        onClick={() => window.location.reload()}
                        style={{ 
                            padding: '12px 24px', 
                            background: '#3b82f6', 
                            color: 'white', 
                            border: 'none', 
                            borderRadius: '8px', 
                            cursor: 'pointer',
                            fontSize: '14px'
                        }}
                    >
                        Reload Page
                    </button>
                </div>
            );
        }
        return this.props.children;
    }
}

// Render the app with Error Boundary and Branding Provider
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(
    <ErrorBoundary>
        <BrandingProvider>
            <App />
        </BrandingProvider>
    </ErrorBoundary>
);
